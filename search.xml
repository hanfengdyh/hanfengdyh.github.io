<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>cané€šä¿¡åè®®</title>
      <link href="/2023/08/07/2023-8-7-can%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
      <url>/2023/08/07/2023-8-7-can%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h2 id="CANé€šä¿¡åè®®"><a href="#CANé€šä¿¡åè®®" class="headerlink" title="CANé€šä¿¡åè®®"></a>CANé€šä¿¡åè®®</h2><p>CAN çš„ç‰¹ç‚¹ä¸»è¦æœ‰ä¸€ä¸‹å‡ ç‚¹ï¼š<br>â‘ ã€å¤šä¸»æ§åˆ¶<br>â‘¡ã€ç³»ç»Ÿçš„æŸ”è½¯æ€§<br>â‘¢ã€é€šä¿¡é€Ÿåº¦å¿«ï¼Œè·ç¦»è¿œ<br>â‘£ã€å…·æœ‰é”™è¯¯æ£€æµ‹ã€é”™è¯¯é€šçŸ¥å’Œé”™è¯¯æ¢å¤åŠŸèƒ½<br>â‘¤ã€æ•…éšœå°é—­åŠŸèƒ½<br>â‘¥ã€è¿æ¥èŠ‚ç‚¹å¤š</p><h3 id="CAN-ç”µæ°”å±æ€§"><a href="#CAN-ç”µæ°”å±æ€§" class="headerlink" title="CAN ç”µæ°”å±æ€§"></a>CAN ç”µæ°”å±æ€§</h3><p>CAN æ€»çº¿ä½¿ç”¨ä¸¤æ ¹çº¿æ¥è¿æ¥å„ä¸ªå•å…ƒï¼šCAN_H å’Œ CAN_Lï¼Œ CAN æ§åˆ¶å™¨é€šè¿‡åˆ¤æ–­è¿™ä¸¤æ ¹çº¿ä¸Šçš„ç”µä½å·®æ¥å¾—åˆ°æ€»çº¿ç”µå¹³ï¼Œ CAN æ€»çº¿ç”µå¹³åˆ†ä¸ºæ˜¾æ€§ç”µå¹³å’Œéšæ€§ç”µå¹³ä¸¤ç§ã€‚æ˜¾æ€§ç”µå¹³è¡¨ç¤ºé€»è¾‘â€œ0â€ï¼Œæ­¤æ—¶ CAN_H ç”µå¹³æ¯” CAN_L é«˜ï¼Œåˆ†åˆ«ä¸º 3.5V å’Œ 1.5Vï¼Œç”µä½å·®ä¸º 2Vã€‚éšå½¢ç”µå¹³è¡¨ç¤ºé€»è¾‘â€œ1â€ï¼Œæ­¤æ—¶ CAN_H å’Œ CAN_L ç”µå‹éƒ½ä¸º 2.5V å·¦å³ï¼Œç”µä½å·®ä¸º 0Vã€‚ CAN æ€»çº¿å°±é€šè¿‡æ˜¾æ€§å’Œéšå½¢ç”µå¹³çš„å˜åŒ–æ¥å°†å…·ä½“çš„æ•°æ®å‘é€å‡ºå» ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-07%20185240.png"></p><p>CAN æ€»çº¿ä¸Šæ²¡æœ‰èŠ‚ç‚¹ä¼ è¾“æ•°æ®çš„æ—¶å€™ä¸€ç›´å¤„äºéšæ€§çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æ€»çº¿ç©ºé—²çŠ¶æ€çš„æ—¶å€™ä¸€ç›´å¤„äºéšæ€§ã€‚ </p><h3 id="CANåè®®å¸§"><a href="#CANåè®®å¸§" class="headerlink" title="CANåè®®å¸§"></a>CANåè®®å¸§</h3><p>CAN åè®®æä¾›äº† 5 ç§å¸§æ ¼å¼æ¥ä¼ è¾“æ•°æ®ï¼šæ•°æ®å¸§ã€é¥æ§å¸§ã€é”™è¯¯å¸§ã€è¿‡è½½å¸§å’Œå¸§é—´éš”ã€‚å…¶ä¸­æ•°æ®å¸§å’Œé¥æ§å¸§æœ‰æ ‡å‡†æ ¼å¼å’Œæ‰©å±•æ ¼å¼ä¸¤ç§ï¼Œæ ‡å‡†æ ¼å¼æœ‰ 11 ä½æ ‡è¯†ç¬¦(ID)ï¼Œæ‰©å±•æ ¼å¼æœ‰ 29 ä¸ªæ ‡è¯†ç¬¦(ID)ã€‚ </p><table><thead><tr><th align="center">å¸§ç±»å‹</th><th align="center">å¸§ç”¨é€”</th></tr></thead><tbody><tr><td align="center">æ•°æ®å¸§</td><td align="center">ç”¨äº CAN èŠ‚ç‚¹å•å…ƒä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“çš„å¸§</td></tr><tr><td align="center">é¥æ§å¸§</td><td align="center">ç”¨äºæ¥æ”¶å•å…ƒå‘å…·æœ‰ç›¸åŒ ID çš„å‘é€å•å…ƒè¯·æ±‚æ•°æ®çš„å¸§</td></tr><tr><td align="center">é”™è¯¯å¸§</td><td align="center">ç”¨äºå½“æ£€æµ‹å‡ºé”™è¯¯æ—¶å‘å…¶å®ƒå•å…ƒé€šçŸ¥é”™è¯¯çš„å¸§</td></tr><tr><td align="center">è¿‡è½½å¸§</td><td align="center">ç”¨äºæ¥æ”¶å•å…ƒé€šçŸ¥å…¶å°šæœªåšå¥½æ¥æ”¶å‡†å¤‡çš„å¸§</td></tr><tr><td align="center">é—´éš”å¸§</td><td align="center">ç”¨äºå°†æ•°æ®å¸§åŠé¥æ§å¸§ä¸å‰é¢çš„å¸§åˆ†ç¦»å¼€æ¥çš„å¸§</td></tr></tbody></table><p>Dä¸ºæ˜¾æ€§0ï¼ŒRä¸ºéšå½¢1ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/can%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE_202308071734_13201%203.jpg"></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/can%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE_202308071734_11851%201.jpg"></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/can%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE_202308071734_14251%204.jpg"></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/can%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE_202308071734_15346%205.jpg"></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/can%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE_202308071734_12590%202.jpg"></p><h3 id="CANé€Ÿç‡"><a href="#CANé€Ÿç‡" class="headerlink" title="CANé€Ÿç‡"></a>CANé€Ÿç‡</h3><p>CAN æ€»çº¿ä»¥å¸§çš„å½¢å¼å‘é€æ•°æ®ï¼Œä½†æ˜¯æœ€ç»ˆåˆ°æ€»çº¿ä¸Šçš„å°±æ˜¯â€œ0â€å’Œâ€œ1â€è¿™æ ·çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°äº†é€šä¿¡é€Ÿç‡ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’é’Ÿå‘é€å¤šå°‘ä½æ•°æ®ï¼Œ CAN2.0 æœ€é«˜é€Ÿåº¦ä¸º1Mbps&#x2F;Sã€‚å¯¹äº CAN æ€»çº¿ï¼Œä¸€ä¸ªä½åˆ†ä¸º 4 æ®µï¼š<br>â‘ ã€åŒæ­¥æ®µ(SS)<br>â‘¡ã€ä¼ æ’­æ—¶é—´æ®µ(PTS)<br>â‘¢ã€ç›¸ä½ç¼“å†²æ®µ 1(PBS1)<br>â‘£ã€ç›¸ä½ç¼“å†²æ®µ 2(PBS2)<br>è¿™äº›æ®µç”± Tq(Time Quantum)ç»„æˆï¼Œ <strong>Tq æ˜¯ CAN æ€»çº¿çš„æœ€å°æ—¶é—´å•ä½ã€‚å¸§ç”±ä½æ„æˆï¼Œä¸€ä¸ªä½ç”± 4 ä¸ªæ®µæ„æˆï¼Œæ¯ä¸ªæ®µåˆç”±è‹¥å¹²ä¸ª Tq ç»„æˆï¼Œè¿™ä¸ªå°±æ˜¯ä½æ—¶åºã€‚</strong> 1 ä½ç”±å¤šå°‘ä¸ª Tq æ„æˆã€æ¯ä¸ªæ®µåˆç”±å¤šå°‘ä¸ª Tq æ„æˆç­‰ï¼Œå¯ä»¥ä»»æ„è®¾å®šä½æ—¶åºã€‚é€šè¿‡è®¾å®šä½æ—¶åºï¼Œå¤šä¸ªå•å…ƒå¯åŒæ—¶é‡‡æ ·ï¼Œä¹Ÿå¯ä»»æ„è®¾å®šé‡‡æ ·ç‚¹ã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-07%20191029.png"></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-07%20191432.png"></p><h3 id="canä¼ è¾“ä»²è£"><a href="#canä¼ è¾“ä»²è£" class="headerlink" title="canä¼ è¾“ä»²è£"></a>canä¼ è¾“ä»²è£</h3><p>åœ¨æ€»çº¿ç©ºé—²æ€ï¼Œæœ€å…ˆå¼€å§‹å‘é€æ¶ˆæ¯çš„å•å…ƒè·å¾—å‘é€æƒã€‚å½“å¤šä¸ªå•å…ƒåŒæ—¶å¼€å§‹å‘é€æ—¶ï¼Œå„å‘é€å•å…ƒä»ä»²è£æ®µçš„ç¬¬ä¸€ä½å¼€å§‹è¿›è¡Œä»²è£ã€‚è¿ç»­è¾“å‡ºæ˜¾æ€§ç”µå¹³æœ€å¤šçš„å•å…ƒå¯ç»§ç»­å‘é€ã€‚ </p><p><img src="C:\Users\hanfeng\AppData\Roaming\Typora\typora-user-images\1691407245638.png" alt="1691407245638"></p><p>å•å…ƒ 1 å’Œå•å…ƒ 2 åŒæ—¶å¼€å§‹å‘æ€»çº¿å‘é€æ•°æ®ï¼Œå¼€å§‹éƒ¨åˆ†ä»–ä»¬çš„æ•°æ®æ ¼å¼æ˜¯ä¸€æ ·çš„ï¼Œæ•…æ— æ³•åŒºåˆ†ä¼˜å…ˆçº§ï¼Œç›´åˆ° T æ—¶åˆ»ï¼Œå•å…ƒ 1 è¾“å‡ºéšæ€§ç”µå¹³ï¼Œè€Œå•å…ƒ 2 è¾“å‡ºæ˜¾æ€§ç”µå¹³ï¼Œæ­¤æ—¶å•å…ƒ 1 ä»²è£å¤±åˆ©ï¼Œç«‹åˆ»è½¬å…¥æ¥æ”¶çŠ¶æ€å·¥ä½œï¼Œä¸å†ä¸å•å…ƒ 2 ç«äº‰ï¼Œè€Œå•å…ƒ 2 åˆ™é¡ºåˆ©è·å¾—æ€»çº¿ä½¿ç”¨æƒï¼Œç»§ç»­å‘é€è‡ªå·±çš„æ•°æ®ã€‚è¿™å°±å®ç°äº†ä»²è£ï¼Œè®©è¿ç»­å‘é€æ˜¾æ€§ç”µå¹³å¤šçš„å•å…ƒè·å¾—æ€»çº¿ä½¿ç”¨æƒã€‚ </p><p><a href="https://gitee.com/hanfengdyh/code/blob/master/CAN%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B.pdf">CANå…¥é—¨æ•™ç¨‹.pdf Â· ç äº‘ </a></p><h3 id="FlexCANï¼ˆCANå¤–è®¾ï¼‰"><a href="#FlexCANï¼ˆCANå¤–è®¾ï¼‰" class="headerlink" title="FlexCANï¼ˆCANå¤–è®¾ï¼‰"></a>FlexCANï¼ˆCANå¤–è®¾ï¼‰</h3><p> FlexCAN ç¬¦åˆ CAN2.0B åè®®ã€‚ FlexCANå®Œå…¨ç¬¦åˆCANåè®®ï¼Œæ”¯æŒæ ‡å‡†æ ¼å¼å’Œæ‰©å±•æ ¼å¼ï¼Œæ”¯æŒ 64ä¸ªæ¶ˆæ¯ç¼“å†²ã€‚I.MX6ULLè‡ªå¸¦çš„FlexCANæ¨¡å—ç‰¹æ€§å¦‚ä¸‹ï¼š<br>â‘ ã€æ”¯æŒ CAN2.0B åè®®ï¼Œæ•°æ®å¸§å’Œé¥æ§å¸§æ”¯æŒæ ‡å‡†å’Œæ‰©å±•ä¸¤ç§æ ¼å¼ï¼Œæ•°æ®é•¿åº¦æ”¯æŒ 0~8 å­—<br>èŠ‚ï¼Œå¯ç¼–ç¨‹é€Ÿåº¦ï¼Œæœ€é«˜ 1Mbit&#x2F;Sã€‚<br>â‘¡ã€çµæ´»çš„æ¶ˆæ¯é‚®ç®±ï¼Œæœ€é«˜æ”¯æŒ 8 ä¸ªå­—èŠ‚ã€‚<br>â‘¢ã€æ¯ä¸ªæ¶ˆæ¯é‚®ç®±å¯ä»¥é…ç½®ä¸ºæ¥æ”¶æˆ–å‘é€ï¼Œéƒ½æ”¯æŒæ ‡å‡†å’Œæ‰©å±•è¿™ä¸¤ç§æ ¼å¼çš„æ¶ˆæ¯ã€‚<br>â‘£ã€æ¯ä¸ªæ¶ˆæ¯é‚®ç®±éƒ½æœ‰ç‹¬ç«‹çš„æ¥æ”¶æ©ç å¯„å­˜å™¨ã€‚<br>â‘¤ã€å¼ºå¤§çš„æ¥æ”¶ FIFO ID è¿‡æ»¤ã€‚<br>â‘¥ã€æœªä½¿ç”¨çš„ç©ºé—´å¯ä»¥ç”¨ä½œé€šç”¨ RAMã€‚<br>â‘¦ã€å¯ç¼–ç¨‹çš„å›æµ‹æ¨¡å¼ï¼Œç”¨äºè¿›è¡Œè‡ªæµ‹ã€‚<br>â‘§ã€å¯ç¼–ç¨‹çš„ä¼˜å…ˆçº§ç»„åˆã€‚</p><p>FlexCAN æ”¯æŒå››ç§æ¨¡å¼ï¼šæ­£å¸¸æ¨¡å¼(Normal)ã€å†»ç»“æ¨¡å¼(Freeze)ã€ä»…ç›‘å¬æ¨¡å¼(Listen-Only)å’Œå›ç¯æ¨¡å¼(Loop-Back)ï¼Œå¦å¤–è¿˜æœ‰ä¸¤ç§ä½åŠŸè€—æ¨¡å¼ï¼šç¦æ­¢æ¨¡å¼(Disable)å’Œåœæ­¢æ¨¡å¼(Stop)ã€‚<br>â‘ ã€æ­£å¸¸æ¨¡å¼(Normal)<br>åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œ FlexCAN æ­£å¸¸æ¥æ”¶æˆ–å‘é€æ¶ˆæ¯å¸§ï¼Œæ‰€æœ‰çš„ CAN åè®®åŠŸèƒ½éƒ½ä½¿èƒ½ã€‚<br>â‘¡ã€å†»ç»“æ¨¡å¼(Freeze)<br>å½“ MCR å¯„å­˜å™¨çš„ FRZ ä½ç½® 1 çš„æ—¶å€™ä½¿èƒ½æ­¤æ¨¡å¼ï¼Œåœ¨æ­¤æ¨¡å¼ä¸‹æ— æ³•è¿›è¡Œå¸§çš„å‘é€æˆ–æ¥æ”¶ï¼ŒCAN æ€»çº¿åŒæ­¥ä¸¢å¤±ã€‚<br>â‘¢ã€ä»…ç›‘å¬æ¨¡å¼(Listen-Onley)<br>å½“ CTRL å¯„å­˜å™¨çš„ LOM ä½ç½® 1 çš„æ—¶å€™ä½¿èƒ½æ­¤æ¨¡å¼ï¼Œåœ¨æ­¤æ¨¡å¼ä¸‹å¸§å‘é€è¢«ç¦æ­¢ï¼Œæ‰€æœ‰é”™è¯¯è®¡æ•°å™¨è¢«å†»ç»“ï¼Œ CAN æ§åˆ¶å™¨å·¥ä½œåœ¨è¢«åŠ¨é”™è¯¯æ¨¡å¼ï¼Œæ­¤æ—¶åªä¼šæ¥æ”¶å…¶ä»– CAN å•å…ƒå‘å‡ºçš„ ACK æ¶ˆæ¯ã€‚<br>â‘£ã€ å›ç¯æ¨¡å¼(Loop-Back)<br>å½“ CTRL å¯„å­˜å™¨çš„ LPB ä½ç½® 1 çš„æ—¶å€™è¿›å…¥æ­¤æ¨¡å¼ï¼Œæ­¤æ¨¡å¼ä¸‹ FlexCAN å·¥ä½œåœ¨å†…éƒ¨å›ç¯æ¨¡å¼ï¼Œä¸€èˆ¬ç”¨æ¥è¿›è¡Œè‡ªæµ‹ã€‚ä»æ¨¡å¼ä¸‹å‘é€å‡ºæ¥çš„æ•°æ®æµç›´æ¥åé¦ˆç»™å†…éƒ¨æ¥æ”¶å•å…ƒã€‚ </p><p>æ§åˆ¶å¯„å­˜å™¨ CTRL ç”¨äºè®¾ç½®è¿™äº›ä½æ—¶åºï¼Œ CTRL å¯„å­˜å™¨ä¸­çš„ PRESDIVã€ PROPSEGã€ PSEG1ã€PSEG2 å’Œ RJW è¿™ 5 ä¸ªä½åŸŸç”¨äºè®¾ç½® CAN ä½æ—¶åºã€‚<br>PRESDIV ä¸º CAN åˆ†é¢‘å€¼ï¼Œä¹Ÿå³æ˜¯è®¾ç½® CAN åè®®ä¸­çš„ Tq å€¼ï¼Œå…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>ğ‘“_{ğ‘‡ğ‘} &#x3D;ğ‘“_{ğ¶ğ´ğ‘ğ¶ğ¿ğ¾}&#x2F;PRESDIV + 1<br>$$<br><strong>fCANCLKä¸º FlexCAN æ¨¡å—æ—¶é’Ÿï¼Œè¿™ä¸ªæ ¹æ®æ—¶é’Ÿç« èŠ‚è®¾ç½®å³å¯ï¼Œè®¾ç½®å¥½ä»¥åå°±æ˜¯ä¸€ä¸ªå®šå€¼ï¼Œå› æ­¤åªéœ€è¦ä¿®æ”¹ PRESDIV å³å¯ä¿®æ”¹ FlexCAN çš„ Tq é¢‘ç‡å€¼ã€‚</strong><br>Tq å®šäº†ä»¥åæˆ‘ä»¬ç»“åˆå„ä¸ªæ®µæ¥çœ‹ä¸€ä¸‹å¦‚ä½•è®¾ç½® FlexCAN çš„é€Ÿç‡ï¼š</p><p>SSï¼š åŒæ­¥æ®µ(Synchronization Segment)ï¼Œåœ¨ I.MX6ULL å‚è€ƒæ‰‹å†Œä¸­å«åš SYNC_SEGï¼Œæ­¤æ®µå›ºå®šä¸º 1 ä¸ª Tq é•¿åº¦ï¼Œå› æ­¤ä¸éœ€è¦å»è®¾ç½®ã€‚<br>PTSï¼š ä¼ æ’­æ—¶é—´æ®µ(Propagatin Segment)ï¼Œ FlexCAN çš„ CTRL å¯„å­˜å™¨ä¸­çš„ PROPSEG ä½åŸŸè®¾ç½®æ­¤æ®µï¼Œå¯ä»¥è®¾ç½®ä¸º 0<del>7ï¼Œå¯¹åº” 1</del>8 ä¸ª Tqã€‚<br>PBS1ï¼š ç›¸ä½ç¼“å†²æ®µ 1(Phase Buffer Segment 1)ï¼Œ FlexCAN çš„ CRTL å¯„å­˜å™¨ä¸­çš„ PSEG1 ä½åŸŸè®¾ç½®æ­¤æ®µï¼Œå¯ä»¥è®¾ç½®ä¸º 0<del>7ï¼Œå¯¹åº” 1</del>8 ä¸ª Tqã€‚<br>PBS2ï¼šç›¸ä½ç¼“å†²æ®µ 2(Phase Buffer Segment 2)ï¼Œ FlexCAN çš„ CRTL å¯„å­˜å™¨ä¸­çš„ PSEG2 ä½åŸŸè®¾ç½®æ­¤æ®µï¼Œå¯ä»¥è®¾ç½®ä¸º 1<del>7ï¼Œå¯¹åº” 2</del>8 ä¸ª Tqã€‚<br>SJWï¼š å†åŒæ­¥è¡¥å¿å®½åº¦(reSynchronization Jump Width)ï¼Œ FlexCAN çš„ CRTL å¯„å­˜å™¨ä¸­çš„ RJWä½åŸŸè®¾ç½®æ­¤æ®µï¼Œå¯ä»¥è®¾ç½® 0<del>3ï¼Œå¯¹åº” 1</del>4 ä¸ª Tqã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-07%20195038.png"></p><p>SYNC+SEG+(PROP_SEG+PSEG1+2)+(PSEG2+1)å°±æ˜¯æ€»çš„ Tqï¼Œå› æ­¤FlexCAN çš„æ³¢ç‰¹ç‡å°±æ˜¯ï¼š<br>$$<br>ğ¶ğ´ğ‘æ³¢ç‰¹ç‡ &#x3D; ğ‘“_{ğ‘‡ğ‘}&#x2F;æ€»Tq<br>$$</p>]]></content>
      
      
      
        <tags>
            
            <tag> é€šä¿¡åè®® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å—è®¾å¤‡é©±åŠ¨å¼€å‘</title>
      <link href="/2023/08/07/2023-8-8-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
      <url>/2023/08/07/2023-8-8-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h3 id="å—è®¾å¤‡ä»‹ç»"><a href="#å—è®¾å¤‡ä»‹ç»" class="headerlink" title="å—è®¾å¤‡ä»‹ç»"></a>å—è®¾å¤‡ä»‹ç»</h3><p>å—è®¾å¤‡æ˜¯é’ˆå¯¹å­˜å‚¨è®¾å¤‡çš„ï¼Œæ¯”å¦‚ SD å¡ã€ EMMCã€ NAND Flashã€ Nor Flashã€ SPI Flashã€æœºæ¢°ç¡¬ç›˜ã€å›ºæ€ç¡¬ç›˜ç­‰ã€‚å› æ­¤å—è®¾å¤‡é©±åŠ¨å…¶å®å°±æ˜¯è¿™äº›å­˜å‚¨è®¾å¤‡é©±åŠ¨ï¼Œå—è®¾å¤‡é©±åŠ¨ç›¸æ¯”å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„ä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š<br>â‘ ã€å—è®¾å¤‡åªèƒ½ä»¥å—ä¸ºå•ä½è¿›è¡Œè¯»å†™è®¿é—®ï¼Œå—æ˜¯ linux è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ(VFS)åŸºæœ¬çš„æ•°æ®ä¼ è¾“å•ä½ã€‚å­—ç¬¦è®¾å¤‡æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½è¿›è¡Œæ•°æ®ä¼ è¾“çš„ï¼Œä¸éœ€è¦ç¼“å†²ã€‚<br>â‘¡ã€å—è®¾å¤‡åœ¨ç»“æ„ä¸Šæ˜¯å¯ä»¥è¿›è¡Œéšæœºè®¿é—®çš„ï¼Œå¯¹äºè¿™äº›è®¾å¤‡çš„è¯»å†™éƒ½æ˜¯æŒ‰å—è¿›è¡Œçš„ï¼Œå—è®¾å¤‡ä½¿ç”¨ç¼“å†²åŒºæ¥æš‚æ—¶å­˜æ”¾æ•°æ®ï¼Œç­‰åˆ°æ¡ä»¶æˆç†Ÿä»¥åå†ä¸€æ¬¡æ€§å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥å—è®¾å¤‡ä¸­ã€‚ </p><p>linux å†… æ ¸ ä½¿ ç”¨ block_device è¡¨ ç¤º å— è®¾ å¤‡ ï¼Œ block_device ä¸º ä¸€ ä¸ª ç»“ æ„ ä½“ ï¼Œ å®š ä¹‰ åœ¨include&#x2F;linux&#x2F;fs.h æ–‡ä»¶ä¸­ï¼Œç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> &#123;</span></span><br><span class="line"><span class="number">2</span> <span class="type">dev_t</span> bd_dev; <span class="comment">/* not a kdev_t - it&#x27;s a search key */</span></span><br><span class="line"><span class="number">3</span> <span class="type">int</span> bd_openers;</span><br><span class="line"><span class="number">4</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">bd_inode</span>;</span> <span class="comment">/* will die */</span></span><br><span class="line"><span class="number">5</span> <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">bd_super</span>;</span></span><br><span class="line"><span class="number">6</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">bd_mutex</span>;</span> <span class="comment">/* open/close mutex */</span></span><br><span class="line"><span class="number">7</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bd_inodes</span>;</span></span><br><span class="line"><span class="number">8</span><span class="type">void</span> * bd_claiming;</span><br><span class="line"><span class="number">9</span> <span class="type">void</span> * bd_holder;</span><br><span class="line"><span class="number">10</span> <span class="type">int</span> bd_holders;</span><br><span class="line"><span class="number">11</span> <span class="type">bool</span> bd_write_holder;</span><br><span class="line"><span class="number">12</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line"><span class="number">13</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bd_holder_disks</span>;</span></span><br><span class="line"><span class="number">14</span><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">15</span> <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">bd_contains</span>;</span></span><br><span class="line"><span class="number">16</span> <span class="type">unsigned</span> bd_block_size;</span><br><span class="line"><span class="number">17</span> <span class="class"><span class="keyword">struct</span> <span class="title">hd_struct</span> *<span class="title">bd_part</span>;</span></span><br><span class="line"><span class="number">18</span> <span class="comment">/*number of times partitions within this device have been opened.*/</span></span><br><span class="line"><span class="number">19</span> <span class="type">unsigned</span> bd_part_count;</span><br><span class="line"><span class="number">20</span> <span class="type">int</span> bd_invalidated;</span><br><span class="line"><span class="number">21</span> <span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> *<span class="title">bd_disk</span>;</span></span><br><span class="line"><span class="number">22</span> <span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> *<span class="title">bd_queue</span>;</span></span><br><span class="line"><span class="number">23</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bd_list</span>;</span></span><br><span class="line"><span class="number">24</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">25 * Private data. You must have bd_claim&#x27;ed the block_device</span></span><br><span class="line"><span class="comment">26 * to use this. <span class="doctag">NOTE:</span> bd_claim allows an owner to claim</span></span><br><span class="line"><span class="comment">27 * the same device multiple times, the owner must take special</span></span><br><span class="line"><span class="comment">28 * care to not mess up bd_private for that case.</span></span><br><span class="line"><span class="comment">29 */</span></span><br><span class="line"><span class="number">30</span> <span class="type">unsigned</span> <span class="type">long</span> bd_private;</span><br><span class="line"><span class="number">31</span></span><br><span class="line"><span class="number">32</span> <span class="comment">/* The counter of freeze processes */</span></span><br><span class="line"><span class="number">33</span> <span class="type">int</span> bd_fsfreeze_count;</span><br><span class="line"><span class="number">34</span> <span class="comment">/* Mutex for freeze */</span></span><br><span class="line"><span class="number">35</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">bd_fsfreeze_mutex</span>;</span></span><br><span class="line"><span class="number">36</span> &#125;;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œå—è®¾å¤‡å’Œæ³¨é”€å—è®¾å¤‡<br>å’Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å‘å†…æ ¸æ³¨å†Œæ–°çš„å—è®¾å¤‡ã€ç”³è¯·è®¾å¤‡å·ï¼Œå—è®¾å¤‡æ³¨å†Œå‡½æ•°ä¸ºregister_blkdevï¼Œå¦‚æœä¸ä½¿ç”¨æŸä¸ªå—è®¾å¤‡äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦æ³¨é”€æ‰ï¼Œå‡½æ•°ä¸ºunregister_blkdevï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">register_blkdev</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> major, <span class="type">const</span> <span class="type">char</span> *name)</span><span class="comment">/*å¦‚æœå‚æ•° major åœ¨ 1~255 ä¹‹é—´çš„è¯è¡¨ç¤ºè‡ªå®šä¹‰ä¸»è®¾å¤‡å·ï¼Œé‚£ä¹ˆè¿”å› 0 è¡¨ç¤ºæ³¨å†ŒæˆåŠŸï¼Œå¦‚æœè¿”å›è´Ÿå€¼çš„è¯è¡¨ç¤ºæ³¨å†Œå¤±è´¥ã€‚å¦‚æœ major ä¸º 0 çš„è¯è¡¨ç¤ºç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸»è®¾å¤‡å·ï¼Œé‚£ä¹ˆè¿”å›å€¼å°±æ˜¯ç³»ç»Ÿåˆ†é…çš„ä¸»è®¾å¤‡å·(1~255)ï¼Œå¦‚æœè¿”å›è´Ÿå€¼é‚£å°±è¡¨ç¤ºæ³¨å†Œå¤±è´¥ã€‚*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">unregister_blkdev</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> major, <span class="type">const</span> <span class="type">char</span> *name)</span><span class="comment">//æ— è¿”å›å€¼</span></span><br><span class="line"><span class="comment">//majorï¼š ä¸»è®¾å¤‡å·ï¼Œnameï¼š å—è®¾å¤‡åå­—ã€‚</span></span><br></pre></td></tr></table></figure><p><strong>linux å†…æ ¸ä½¿ç”¨ gendisk æ¥æè¿°ä¸€ä¸ªç£ç›˜è®¾å¤‡</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰åœ¨ include&#x2F;linux&#x2F;genhd.hä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> &#123;</span></span><br><span class="line"><span class="number">2</span> <span class="comment">/* major, first_minor and minors are input parameters only,</span></span><br><span class="line"><span class="comment">3 * don&#x27;t use directly. Use disk_devt() and disk_max_parts().</span></span><br><span class="line"><span class="comment">4 */</span></span><br><span class="line"><span class="number">5</span> <span class="type">int</span> major; <span class="comment">/* major number of driver */</span></span><br><span class="line"><span class="number">6</span> <span class="type">int</span> first_minor;</span><br><span class="line"><span class="number">7</span> <span class="type">int</span> minors; <span class="comment">/* maximum number of minors, =1 for</span></span><br><span class="line"><span class="comment">8 * disks that can&#x27;t be partitioned. */</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span> <span class="type">char</span> disk_name[DISK_NAME_LEN]; <span class="comment">/* name of major driver */</span></span><br><span class="line"><span class="number">11</span> <span class="type">char</span> *(*devnode)(<span class="keyword">struct</span> gendisk *gd, <span class="type">umode_t</span> *mode);</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span> <span class="type">unsigned</span> <span class="type">int</span> events; <span class="comment">/* supported events */</span></span><br><span class="line"><span class="number">14</span> <span class="type">unsigned</span> <span class="type">int</span> async_events; <span class="comment">/* async events, subset of all */</span></span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> <span class="comment">/* Array of pointers to partitions indexed by partno.</span></span><br><span class="line"><span class="comment">17 * Protected with matching bdev lock but stat and other</span></span><br><span class="line"><span class="comment">18 * non-critical accesses use RCU. Always access through</span></span><br><span class="line"><span class="comment">19 * helpers.</span></span><br><span class="line"><span class="comment">20 */</span></span><br><span class="line"><span class="number">21</span> <span class="class"><span class="keyword">struct</span> <span class="title">disk_part_tbl</span> __<span class="title">rcu</span> *<span class="title">part_tbl</span>;</span><span class="comment">//ç£ç›˜å¯¹åº”çš„åˆ†åŒºè¡¨</span></span><br><span class="line"><span class="number">22</span> <span class="class"><span class="keyword">struct</span> <span class="title">hd_struct</span> <span class="title">part0</span>;</span></span><br><span class="line"><span class="number">23</span></span><br><span class="line"><span class="number">24</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">block_device_operations</span> *<span class="title">fops</span>;</span></span><br><span class="line"><span class="number">25</span> <span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> *<span class="title">queue</span>;</span><span class="comment">//ä¸ºç£ç›˜å¯¹åº”çš„è¯·æ±‚é˜Ÿåˆ—</span></span><br><span class="line"><span class="number">26</span> <span class="type">void</span> *private_data;</span><br><span class="line"><span class="number">27</span></span><br><span class="line"><span class="number">28</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="number">29</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">driverfs_dev</span>;</span> <span class="comment">// <span class="doctag">FIXME:</span> remove</span></span><br><span class="line"><span class="number">30</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">slave_dir</span>;</span></span><br><span class="line"><span class="number">31</span></span><br><span class="line"><span class="number">32</span> <span class="class"><span class="keyword">struct</span> <span class="title">timer_rand_state</span> *<span class="title">random</span>;</span></span><br><span class="line"><span class="number">33</span> <span class="type">atomic_t</span> sync_io; <span class="comment">/* RAID */</span></span><br><span class="line"><span class="number">34</span> <span class="class"><span class="keyword">struct</span> <span class="title">disk_events</span> *<span class="title">ev</span>;</span></span><br><span class="line"><span class="number">35</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_BLK_DEV_INTEGRITY</span></span><br><span class="line"><span class="number">36</span> <span class="class"><span class="keyword">struct</span> <span class="title">blk_integrity</span> *<span class="title">integrity</span>;</span></span><br><span class="line"><span class="number">37</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">38</span> <span class="type">int</span> node_id;</span><br><span class="line"><span class="number">39</span> &#125;;</span><br></pre></td></tr></table></figure><p>å…³äºç¼–å†™å—çš„è®¾å¤‡é©±åŠ¨çš„æ—¶å€™éœ€è¦åˆ†é…å¹¶åˆå§‹åŒ–ä¸€ä¸ª gendiskï¼Œä½¿ç”¨çš„ API å‡½æ•°ã€‚ </p><p>1ã€ ç”³è¯· gendisk<br>ä½¿ç”¨ gendisk ä¹‹å‰è¦å…ˆç”³è¯·ï¼Œ allo_disk å‡½æ•°ç”¨äºç”³è¯·ä¸€ä¸ª gendiskï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> gendisk *<span class="title function_">alloc_disk</span><span class="params">(<span class="type">int</span> minors)</span></span><br><span class="line"><span class="comment">//minorsï¼š æ¬¡è®¾å¤‡å·æ•°é‡ï¼Œ ä¹Ÿå°±æ˜¯ gendisk å¯¹åº”çš„åˆ†åŒºæ•°é‡ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š æˆåŠŸï¼šè¿”å›ç”³è¯·åˆ°çš„ gendiskï¼Œå¤±è´¥ï¼š NULLã€‚</span></span><br></pre></td></tr></table></figure><p>2ã€åˆ é™¤ gendisk<br>å¦‚æœè¦åˆ é™¤ gendisk çš„è¯å¯ä»¥ä½¿ç”¨å‡½æ•° del_gendiskï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">del_gendisk</span><span class="params">(<span class="keyword">struct</span> gendisk *gp)</span></span><br><span class="line"><span class="comment">//gpï¼š è¦åˆ é™¤çš„ gendiskã€‚æ— è¿”å›å€¼</span></span><br></pre></td></tr></table></figure><p>3ã€å°† gendisk æ·»åŠ åˆ°å†…æ ¸<br>ä½¿ç”¨ alloc_disk ç”³è¯·åˆ° gendisk ä»¥åç³»ç»Ÿè¿˜ä¸èƒ½ä½¿ç”¨ï¼Œå¿…é¡»ä½¿ç”¨ add_disk å‡½æ•°å°†ç”³è¯·åˆ°çš„gendisk æ·»åŠ åˆ°å†…æ ¸ä¸­ï¼Œ add_disk å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">add_disk</span><span class="params">(<span class="keyword">struct</span> gendisk *disk)</span></span><br><span class="line"><span class="comment">//diskï¼š è¦æ·»åŠ åˆ°å†…æ ¸çš„ gendiskã€‚è¿”å›å€¼ï¼š æ— ã€‚</span></span><br></pre></td></tr></table></figure><p>4ã€è®¾ç½® gendisk å®¹é‡<br>æ¯ä¸€ä¸ªç£ç›˜éƒ½æœ‰å®¹é‡ï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ– gendisk çš„æ—¶å€™ä¹Ÿéœ€è¦è®¾ç½®å…¶å®¹é‡ï¼Œä½¿ç”¨å‡½æ•°set_capacityï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">set_capacity</span><span class="params">(<span class="keyword">struct</span> gendisk *disk, <span class="type">sector_t</span> size)</span></span><br><span class="line"><span class="comment">/*diskï¼š è¦è®¾ç½®å®¹é‡çš„ gendiskã€‚</span></span><br><span class="line"><span class="comment">sizeï¼š ç£ç›˜å®¹é‡å¤§å°ï¼Œæ³¨æ„è¿™é‡Œæ˜¯æ‰‡åŒºæ•°é‡ã€‚å—è®¾å¤‡ä¸­æœ€å°çš„å¯å¯»å€å•å…ƒæ˜¯æ‰‡åŒºï¼Œä¸€ä¸ªæ‰‡åŒº</span></span><br><span class="line"><span class="comment">ä¸€èˆ¬æ˜¯ 512 å­—èŠ‚ï¼Œæœ‰äº›è®¾å¤‡çš„ç‰©ç†æ‰‡åŒºå¯èƒ½ä¸æ˜¯ 512 å­—èŠ‚ã€‚ä¸ç®¡ç‰©ç†æ‰‡åŒºæ˜¯å¤šå°‘ï¼Œå†…æ ¸å’Œå—è®¾</span></span><br><span class="line"><span class="comment">å¤‡é©±åŠ¨ä¹‹é—´çš„æ‰‡åŒºéƒ½æ˜¯ 512 å­—èŠ‚ã€‚æ‰€ä»¥ set_capacity å‡½æ•°è®¾ç½®çš„å¤§å°å°±æ˜¯å—è®¾å¤‡å®é™…å®¹é‡é™¤ä»¥</span></span><br><span class="line"><span class="comment">512 å­—èŠ‚å¾—åˆ°çš„æ‰‡åŒºæ•°é‡ã€‚æ¯”å¦‚ä¸€ä¸ª 2MB çš„ç£ç›˜ï¼Œå…¶æ‰‡åŒºæ•°é‡å°±æ˜¯(2*1024*1024)/512=4096ã€‚</span></span><br><span class="line"><span class="comment">è¿”å›å€¼ï¼š æ— ã€‚*/</span></span><br></pre></td></tr></table></figure><p>5ã€è°ƒæ•´ gendisk å¼•ç”¨è®¡æ•°<br>å†…æ ¸ä¼šé€šè¿‡ get_disk å’Œ put_disk è¿™ä¸¤ä¸ªå‡½æ•°æ¥è°ƒæ•´ gendisk çš„å¼•ç”¨è®¡æ•°ï¼Œ get_disk æ˜¯å¢åŠ  gendisk çš„å¼•ç”¨è®¡æ•°ï¼Œ put_disk æ˜¯å‡å°‘ gendisk çš„å¼•ç”¨è®¡æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> kobject *<span class="title function_">get_disk</span><span class="params">(<span class="keyword">struct</span> gendisk *disk)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">put_disk</span><span class="params">(<span class="keyword">struct</span> gendisk *disk)</span></span><br></pre></td></tr></table></figure><p>å—è®¾å¤‡ä¹Ÿæœ‰æ“ä½œé›†ï¼Œä¸ºç»“æ„ä½“ block_device_operationsï¼Œæ­¤ç»“æ„ä½“å®šä¹‰åœ¨ include&#x2F;linux&#x2F;blkdev.h ä¸­ï¼Œç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="class"><span class="keyword">struct</span> <span class="title">block_device_operations</span> &#123;</span></span><br><span class="line"><span class="number">2</span> <span class="type">int</span> (*open) (<span class="keyword">struct</span> block_device *, <span class="type">fmode_t</span>);</span><br><span class="line"><span class="number">3</span> <span class="type">void</span> (*release) (<span class="keyword">struct</span> gendisk *, <span class="type">fmode_t</span>);</span><br><span class="line"><span class="number">4</span> <span class="type">int</span> (*rw_page)(<span class="keyword">struct</span> block_device *, <span class="type">sector_t</span>, <span class="keyword">struct</span> page *,<span class="type">int</span> rw);<span class="comment">//è¯»å†™æŒ‡å®šçš„é¡µ</span></span><br><span class="line"><span class="number">5</span> <span class="type">int</span> (*ioctl) (<span class="keyword">struct</span> block_device *, <span class="type">fmode_t</span>, <span class="type">unsigned</span>,<span class="type">unsigned</span> <span class="type">long</span>);<span class="comment">//ç”¨äºå—è®¾å¤‡çš„ I/O æ§åˆ¶ï¼Œåœ¨32ä½ç³»ç»Ÿ</span></span><br><span class="line"><span class="number">6</span> <span class="type">int</span> (*compat_ioctl) (<span class="keyword">struct</span> block_device *, <span class="type">fmode_t</span>, <span class="type">unsigned</span>,<span class="type">unsigned</span> <span class="type">long</span>);<span class="comment">//ç”¨äºå—è®¾å¤‡çš„ I/O æ§åˆ¶ï¼Œ64ä½</span></span><br><span class="line"><span class="number">7</span> <span class="type">long</span> (*direct_access)(<span class="keyword">struct</span> block_device *, <span class="type">sector_t</span>,</span><br><span class="line"><span class="number">8</span> <span class="type">void</span> **, <span class="type">unsigned</span> <span class="type">long</span> *pfn, <span class="type">long</span> size);</span><br><span class="line"><span class="number">9</span> <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*check_events)</span> <span class="params">(<span class="keyword">struct</span> gendisk *disk,</span></span><br><span class="line"><span class="params"><span class="number">10</span> <span class="type">unsigned</span> <span class="type">int</span> clearing)</span>;</span><br><span class="line"><span class="number">11</span> <span class="comment">/* -&gt;media_changed() is DEPRECATED, use -&gt;check_events() instead */</span></span><br><span class="line"><span class="number">12</span> <span class="type">int</span> (*media_changed) (<span class="keyword">struct</span> gendisk *);</span><br><span class="line"><span class="number">13</span> <span class="type">void</span> (*unlock_native_capacity) (<span class="keyword">struct</span> gendisk *);</span><br><span class="line"><span class="number">14</span> <span class="type">int</span> (*revalidate_disk) (<span class="keyword">struct</span> gendisk *);</span><br><span class="line"><span class="number">15</span> <span class="type">int</span> (*getgeo)(<span class="keyword">struct</span> block_device *, <span class="keyword">struct</span> hd_geometry *);<span class="comment">//ç”¨äºè·å–ç£ç›˜ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç£å¤´ã€æŸ±é¢å’Œæ‰‡åŒºç­‰ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="number">16</span> <span class="comment">/* this callback is with swap_lock and sometimes page table lockheld */</span></span><br><span class="line"><span class="number">17</span> <span class="type">void</span> (*swap_slot_free_notify) (<span class="keyword">struct</span> block_device *,<span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="number">18</span> <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span><span class="comment">//è¡¨ç¤ºæ­¤ç»“æ„ä½“å±äºå“ªä¸ªæ¨¡å—ï¼Œä¸€èˆ¬ç›´æ¥è®¾ç½®ä¸º THIS_MODULEã€‚</span></span><br><span class="line"><span class="number">19</span> &#125;;</span><br></pre></td></tr></table></figure><h3 id="å—è®¾å¤‡-I-x2F-O-è¯·æ±‚è¿‡ç¨‹"><a href="#å—è®¾å¤‡-I-x2F-O-è¯·æ±‚è¿‡ç¨‹" class="headerlink" title="å—è®¾å¤‡ I&#x2F;O è¯·æ±‚è¿‡ç¨‹"></a>å—è®¾å¤‡ I&#x2F;O è¯·æ±‚è¿‡ç¨‹</h3><p>åœ¨ç¼–å†™å—è®¾å¤‡é©±åŠ¨çš„æ—¶å€™ï¼Œæ¯ä¸ªç£ç›˜(gendisk)éƒ½è¦åˆ†é…ä¸€ä¸ª request_queue ï¼Œå†…æ ¸å°†å¯¹å—è®¾å¤‡çš„è¯»å†™éƒ½å‘é€åˆ°è¯·æ±‚é˜Ÿåˆ— request_queue ä¸­ï¼Œ request_queue ä¸­æ˜¯å¤§é‡çš„request(è¯·æ±‚ç»“æ„ä½“)ï¼Œè€Œ request åˆåŒ…å«äº† bioï¼Œ bio ä¿å­˜äº†è¯»å†™ç›¸å…³æ•°æ®ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-09%20143303.png"></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-09%20141959.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxå¼€å‘æ¿å®‰è£…ç¬¬ä¸‰æ–¹åº“</title>
      <link href="/2023/08/06/2023-8-6-%E5%AE%89%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/"/>
      <url>/2023/08/06/2023-8-6-%E5%AE%89%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¬¬ä¸‰æ–¹åº“çš„å®‰è£…é…ç½®"><a href="#ç¬¬ä¸‰æ–¹åº“çš„å®‰è£…é…ç½®" class="headerlink" title="ç¬¬ä¸‰æ–¹åº“çš„å®‰è£…é…ç½®"></a>ç¬¬ä¸‰æ–¹åº“çš„å®‰è£…é…ç½®</h2><h3 id="ä¸²å£ï¼ˆminicomå’Œncurseï¼‰"><a href="#ä¸²å£ï¼ˆminicomå’Œncurseï¼‰" class="headerlink" title="ä¸²å£ï¼ˆminicomå’Œncurseï¼‰"></a>ä¸²å£ï¼ˆminicomå’Œncurseï¼‰</h3><p>ncurses (new curses)åº“æ˜¯System V Release 4.0åŠcursesæ›´é«˜ç‰ˆæœ¬ä¸­çš„å…è´¹è½¯ä»¶ä»¿çœŸåº“ã€‚å®ƒä½¿ç”¨terminfoæ ¼å¼ï¼Œæ”¯æŒpadså’Œcolor ï¼Œå¤šç§é«˜äº®æ˜¾ç¤ºï¼Œå¤šå½¢å¼å­—ç¬¦å’ŒåŠŸèƒ½é”®æ˜ å°„ï¼Œè¯¥åº“å¾ˆå®¹æ˜“ç§»æ¤åˆ°ä»»ä½•ç¬¦åˆANSI&#x2F; posixçš„ç±»unixç³»ç»Ÿä¸­è¿è¡Œã€‚</p><p>ä¸‹è½½åœ°å€<a href="https://directory.fsf.org/wiki/Ncurses">Ncurses - Free Software </a></p><p>å…·ä½“ç¼–è¯‘æ„å»ºæ­¥éª¤å¦‚ä¸‹ï¼š</p><h5 id="1ã€æ„å»ºé…ç½®"><a href="#1ã€æ„å»ºé…ç½®" class="headerlink" title="1ã€æ„å»ºé…ç½®"></a>1ã€æ„å»ºé…ç½®</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/home/moss/linux/tool/ncurse --host=arm-linux-gnueabihf --target=arm-linux-gnueabihf --with-shared --without-profile --disable-stripping --without-progs --with-manpages --without-tests</span><br></pre></td></tr></table></figure><ul><li>configure ï¼šé…ç½®è„šæœ¬ã€‚ï¼ˆåœ¨å‘½ä»¤è¡Œç»ˆç«¯ä¸‹è¿è¡Œï¼‰</li><li>â€“prefixï¼š ç”¨äºæŒ‡å®šç¼–è¯‘ç»“æœçš„ä¿å­˜ç›®å½•ã€‚</li><li>â€“hostï¼š ç”¨äºæŒ‡å®šç¼–è¯‘å™¨å‰ç¼€ï¼Œè¿™é‡Œè®¾ç½®ä¸º â€œarm-linux-gnueabihfâ€ã€‚</li><li>â€“target ï¼šç”¨äºæŒ‡å®šç›®æ ‡ï¼Œè¿™é‡Œè®¾ç½®ä¸ºâ€œarm-linux-gnueabihfâ€ã€‚</li></ul><p>é…ç½®ç»“æœï¼š<img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20124119.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make#makeè¿›è¡Œç¼–è¯‘</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20124530.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install#è¿›è¡Œå®‰è£…</span><br></pre></td></tr></table></figure><p>å¯èƒ½ä¼šæœ‰æŠ¥é”™ï¼Œå¯èƒ½æ˜¯æ‰¾ä¸åˆ°äº¤å‰ç¼–è¯‘ä½ç½®ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤è½¬åˆ°rootçš„æ¨¡å¼ä¸‹è¿›è¡Œå®‰è£…ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -s //åˆ‡æ¢åˆ° root </span><br><span class="line">source /etc/profile //æ‰§è¡Œ/etc/profile</span><br><span class="line">make install //å®‰è£…ï¼Œæ­¤æ—¶å·²ç»å·¥ä½œåœ¨ root ä¸‹ï¼Œå› æ­¤ä¸éœ€è¦åŠ â€œsudoâ€</span><br><span class="line">su moss //ç¼–è¯‘å®Œæˆä»¥åå›åŸæ¥çš„ç”¨æˆ·</span><br></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸä»¥åæŸ¥çœ‹ä¸€ä¸‹å‰é¢åˆ›å»ºçš„â€œncursesâ€æ–‡ä»¶å¤¹ï¼Œä¼šå‘ç°é‡Œé¢å¤šäº†ä¸€äº›ä¸œè¥¿ï¼Œ</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20125053.png"></p><p>æˆ‘ä»¬éœ€è¦å°† includeã€ lib å’Œ share è¿™ä¸‰ä¸ªç›®å½•ä¸­å­˜æ”¾çš„æ–‡ä»¶åˆ†åˆ«æ‹·è´åˆ°å¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„&#x2F;usr&#x2F;includeã€ &#x2F;usr&#x2F;lib å’Œ&#x2F;usr&#x2F;share è¿™ä¸‰ä¸ªç›®å½•ä¸­ï¼Œå¦‚æœå“ªä¸ªç›®å½•ä¸å­˜åœ¨çš„è¯è¯·è‡ªè¡Œåˆ›å»ºï¼ï¼æ‹·è´å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cp lib/* /home/moss/linux/nfs/rootfs/usr/lib/ -rfa</span><br><span class="line">sudo cp share/* /home/moss/linux/nfs/rootfs/usr/share/ -rfa</span><br><span class="line">sudo cp include/* /home/moss/linux/nfs/rootfs/usr/include/ -rfa</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å¼€å‘æ¿æ ¹ç›®å½•çš„&#x2F;etc&#x2F;profile(æ²¡æœ‰çš„è¯è‡ªå·±åˆ›å»ºä¸€ä¸ª)æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹æ‰€ç¤ºå†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">LD_LIBRARY_PATH=/lib:/usr/lib:$LD_LIBRARY_PATH</span><br><span class="line">export LD_LIBRARY_PATH</span><br><span class="line">export TERM=vt100</span><br><span class="line">export TERMINFO=/usr/share/terminfo </span><br></pre></td></tr></table></figure><p>minicomæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œç»ˆç«¯ä¸­ç”±èœå•é©±åŠ¨çš„ä¸²è¡Œé€šä¿¡è°ƒè¯•ç¨‹åºã€‚</p><p>ä¸‹è½½åœ°å€<a href="https://fossies.org/linux/misc/minicom-2.8.tar.bz2/">minicom 2.8 - Download| Fossies Archive</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure CC=arm-linux-gnueabihf-gcc --prefix=/home/moss/linux/tool/minicom --host=arm-linux-gnueabihf CPPFLAGS=-I/home/moss/linux/tool/ncurses/include LDFLAGS=-L/home/moss/linux/tool/ncurses/lib -enable-cfg-dir=/etc/minicom              </span><br></pre></td></tr></table></figure><p> CC è¡¨ç¤ºè¦ä½¿ç”¨çš„ gcc äº¤å‰ç¼–è¯‘å™¨ï¼Œ â€“prefix æŒ‡å®šç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œè‚¯å®šè¦å­˜æ”¾å‰é¢åˆ›å»ºçš„ minicom ç›®å½•ä¸­ã€‚ â€“host æŒ‡å®šäº¤å‰ç¼–è¯‘å™¨å‰ç¼€ï¼Œ CPPFLAGS æŒ‡å®š ncurses çš„å¤´æ–‡ä»¶è·¯å¾„ï¼ŒLDFLAGS æŒ‡å®šncursesçš„åº“è·¯å¾„ã€‚é…ç½®æˆåŠŸå</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20130403.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20130558.png"></p><p>è£…å®Œåæ–‡ä»¶ç”Ÿæˆå¦‚å›¾ã€‚å°† minicom ç›®å½•ä¸­ bin å­ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°å¼€å‘æ¿æ ¹ç›®å½•ä¸­çš„&#x2F;usr&#x2F;bin ç›®å½•ä¸‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp bin/* /home/moss/linux/nfs/rootfs/usr/bin/ </span><br></pre></td></tr></table></figure><p>ä¹‹åæ‰“å¼€å¼€å‘æ¿çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œæ–°å»º&#x2F;etc&#x2F;passwd æ–‡ä»¶ï¼Œç„¶ååœ¨ passwd æ–‡ä»¶é‡Œé¢è¾“å…¥å¦‚ä¸‹æ‰€ç¤ºå†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/sh</span><br></pre></td></tr></table></figure><h3 id="éŸ³é¢‘å£°å¡"><a href="#éŸ³é¢‘å£°å¡" class="headerlink" title="éŸ³é¢‘å£°å¡"></a>éŸ³é¢‘å£°å¡</h3><p>alsa-lib å’Œ alsa-utils æº ç  ï¼Œ ä¸‹ è½½ åœ° å€ ä¸º ï¼š <a href="http://www.alsa-project.org/main/index.php/Main_Page">Advanced Linux Sound Architecture</a></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20131711.png"></p><p><strong>alsa-lib ç§»æ¤</strong><br>æ³¨æ„ alsa-lib ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šç”Ÿæˆä¸€äº›é…ç½®æ–‡ä»¶ï¼Œè€Œè¿™äº›é…ç½®ä¿¡æ¯çš„è·¯å¾„éƒ½æ˜¯ç»å¯¹è·¯å¾„ï¼Œå› æ­¤ä¸ºäº†ä¿è¯ ubuntu å’Œå¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ä¸€è‡´ï¼åœ¨ ubuntu å’Œå¼€å‘æ¿ä¸­å„åˆ›å»ºä¸€ä¸ªè·¯å¾„å’Œåå­—å®Œå…¨ä¸€æ ·çš„ç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬éƒ½åˆ›å»ºä¸€ä¸ª&#x2F;usr&#x2F;share&#x2F;arm-alsa ç›®å½•ï¼Œ ubuntu ä¸­åˆ›å»ºå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share </span><br><span class="line">sudo mkdir arm-alsa </span><br></pre></td></tr></table></figure><p>æœ€ååœ¨å¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­ä¹Ÿåˆ›å»ºä¸€ä¸ª&#x2F;usr&#x2F;share&#x2F;arm-alsa ç›®å½•ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/share/arm-alsa -p </span><br></pre></td></tr></table></figure><p>è¿™æ · ubuntu å’Œå¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰ä¸€ä¸ªâ€œ&#x2F;usr&#x2F;share&#x2F;arm-alsaâ€ç›®å½•ï¼Œäº¤å‰ç¼–è¯‘çš„æ—¶å€™å°±ä¸æ€•å­˜åœ¨å¼•ç”¨ç»å¯¹è·¯å¾„äº†ï¼Œå› ä¸º ubuntu å’Œå¼€å‘æ¿ä¸­çš„é…ç½®æ–‡ä»¶è·¯å¾„éƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚ç”±äº alsa-utils è¦ç”¨åˆ° alsa-lib åº“ï¼Œå› æ­¤è¦å…ˆç¼–è¯‘ alsa-lib åº“ã€‚ alsa-lib å°±æ˜¯ ALSA ç›¸å…³åº“æ–‡ä»¶ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡è°ƒç”¨ ALSA åº“æ¥å¯¹ ALSA æ¡†æ¶ä¸‹çš„å£°å¡è¿›è¡Œæ“ä½œã€‚å…ˆåˆ›å»ºä¸€ä¸ªåä¸ºâ€œalsa-libâ€çš„ç›®å½•ç”¨æ¥ä¿å­˜ alsa-lib çš„ç¼–è¯‘ç»“æœï¼Œç„¶åå°† alsa-lib-1.2.2.tar.bz2 æ‹·è´åˆ° ubuntu ä¸­å¹¶è§£å‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -vxjf alsa-lib-1.2.9.tar.bz2 </span><br></pre></td></tr></table></figure><p>è§£å‹å®Œæˆä»¥åå°±ä¼šå¾—åˆ°ä¸€ä¸ªåä¸ºâ€œalsa-lib-1.2.9â€çš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªå°±æ˜¯ alsa-lib çš„æºç ã€‚è¿›å…¥alsa-lib-1.2.9 ç›®å½•ï¼Œç„¶åé…ç½®å¹¶ç¼–è¯‘ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --host=arm-linux-gnueabihf --prefix=/home/moss/linux/tool/alsalib --with-configdir=/usr/share/arm-alsa </span><br></pre></td></tr></table></figure><p>&#x2F;&#x2F;é…ç½®æ³¨æ„ï¼Œ â€œâ€“with-configdirâ€ç”¨äºè®¾ç½® alsa-lib ç¼–è¯‘å‡ºæ¥çš„é…ç½®æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼Œè¿™é‡Œè®¾ç½®ä¸ºå‰é¢åˆ›å»ºçš„â€œ&#x2F;usr&#x2F;share&#x2F;arm-alsaâ€ç›®å½•ã€‚<br>é…ç½®å®Œæˆä»¥åå°±å¯ä»¥ç¼–è¯‘äº†ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make </span><br><span class="line">sudo make install </span><br></pre></td></tr></table></figure><p>å¯èƒ½ä¼šå‡ºç°é”™è¯¯æç¤ºï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20132326.png"><br> libatopology.la ç¼–è¯‘å¤±è´¥ï¼Œ è¿™æ˜¯å› ä¸º sudo ä¼šåˆ‡æ¢åˆ° root ç”¨æˆ·ä¸‹ï¼Œä½†æ˜¯æ­¤æ—¶ root ç”¨æˆ·ä¸‹çš„ç¯å¢ƒå˜é‡ä¸­æ²¡æœ‰äº¤å‰ç¼–è¯‘å™¨è·¯å¾„ï¼Œå› æ­¤ä¼šæç¤ºæ‰¾ä¸åˆ°â€œarm-linux-gnueabihf-gccâ€ï¼Œä»è€Œå¯¼è‡´ libatopology.la ç¼–è¯‘å¤±è´¥ã€‚è§£å†³æ–¹æ³•å°±æ˜¯å…ˆåˆ‡æ¢åˆ° root ç”¨æˆ·ï¼Œé‡æ–°æ‰§è¡Œä¸€ä¸‹&#x2F;etc&#x2F;profile<br>æ–‡ä»¶ï¼Œç„¶åç›´æ¥ make install å³å¯ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -s </span><br><span class="line">source /etc/profile </span><br><span class="line">make install </span><br><span class="line">su moss</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆä»¥åå‰é¢åˆ›å»ºçš„â€œalsa-libâ€ç›®å½•å°±ä¼šä¿å­˜ç›¸åº”çš„ç¼–è¯‘ç»“æœï¼Œå¦‚å›¾ 65.4.1.2 æ‰€ç¤ºï¼š<br>å›¾ 65.4.1.2 alsa-lib ç¼–è¯‘ç»“æœ<br>ubuntu ä¸­&#x2F;usr&#x2F;share&#x2F;arm-alsa ç›®å½•ä¸‹çš„å†…å®¹å¦‚å›¾ 65.4.1.3 æ‰€ç¤ºï¼š<br>å›¾ 65.4.1.3 ç¼–è¯‘å‡ºæ¥çš„é…ç½®æ–‡ä»¶ã€‚<br>å°†å›¾ 65.4.1.2 ä¸­ lib ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°å¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿçš„&#x2F;usr&#x2F;lib ç›®å½•ä¸‹ï¼Œå°†å›¾<br>65.4.1.3 ä¸­&#x2F;usr&#x2F;share&#x2F;arm-alsa ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°å¼€å‘æ¿çš„&#x2F;usr&#x2F;share&#x2F;arm-alsa ç›®å½•ä¸‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd alsa-lib //è¿›å…¥ alsa-lib</span><br><span class="line">sudo cp lib/* /home/moss/linux/nfs/rootfs/lib/ -af</span><br><span class="line">cd /usr/share/arm-alsa //è¿›å…¥ arm-alsa ç›®å½•ï¼Œæ‹·è´é…ç½®æ–‡ä»¶</span><br><span class="line">sudo cp * /home/moss/linux/nfs/rootfs/usr/share/arm-alsa/ -raf</span><br></pre></td></tr></table></figure><p><strong>alsa-utils ç§»æ¤</strong><br>alsa-utils æ˜¯ ALSA çš„ä¸€äº›å°å·¥å…·é›†åˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›å°å·¥å…·è¿˜æµ‹è¯•æˆ‘ä»¬çš„å£°å¡ã€‚å°† alsautils-1.2.2.tar.bz2 å¤åˆ¶åˆ° ubuntu ä¸­å¹¶è§£å‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -vxjf alsa-utils-1.2.9.tar.bz2 </span><br></pre></td></tr></table></figure><p>è§£å‹æˆåŠŸä»¥åä¼šå¾—åˆ°ä¸€ä¸ªåä¸ºâ€œalsa-utils-1.2.9â€çš„æ–‡ä»¶å¤¹ï¼Œæ­¤æ–‡ä»¶å¤¹å°±æ˜¯ alsa-utils æºç ã€‚<br>é‡æ–°åˆ›å»ºä¸€ä¸ªåä¸ºâ€œalsa-utilsâ€çš„ç›®å½•ç”¨äºå­˜æ”¾ alsa-utils-1.2.9 çš„ç¼–è¯‘ç»“æœã€‚æŒ‰ç…§å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘alsa-utilsï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --host=arm-linux-gnueabihf --prefix=/home/moss/linux/tool/alsautils --with-alsa-inc-prefix=/home/moss/linux/tool/alsa-lib/include/ --with-alsaprefix=/home/moss/linux/tool/alsa-lib/lib/ --disable-alsamixer --disable-xmlto</span><br><span class="line">make </span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆä»¥åå°±ä¼šåœ¨å‰é¢åˆ›å»ºçš„â€œalsa-utilsâ€ç›®å½•ä¸‹ç”Ÿæˆ binã€ sbin å’Œ share ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼Œå¦‚<br><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20144427.png"><br><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-06%20144522.png"><br>å°†å›¾ ä¸­ binã€ sbin å’Œ share è¿™ä¸‰ä¸ªç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶åˆ†åˆ«æ‹·è´åˆ°å¼€å‘æ¿æ ¹ç›®å½•ä¸‹çš„<br>&#x2F;binã€ &#x2F;sbin å’Œ&#x2F;usr&#x2F;share&#x2F;alsa ç›®å½•ä¸‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd alsa-utils</span><br><span class="line">sudo cp bin/* /home/zuozhongkai/linux/nfs/rootfs/bin/ -rfa</span><br><span class="line">sudo cp sbin/* /home/zuozhongkai/linux/nfs/rootfs/sbin/ -rfa</span><br><span class="line">sudo cp share/* /home/zuozhongkai/linux/nfs/rootfs/usr/share/ -rfa</span><br></pre></td></tr></table></figure><p>æ‰“å¼€å¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„&#x2F;etc&#x2F;profile æ–‡ä»¶ï¼Œåœ¨é‡Œé¢åŠ å…¥å¦‚ä¸‹æ‰€ç¤ºå†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ALSA_CONFIG_PATH=/usr/share/arm-alsa/alsa.conf</span><br></pre></td></tr></table></figure><p>ALSA_CONFIG_PATH ç”¨äºæŒ‡å®š alsa çš„é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶æ˜¯ alsa-lib ç¼–è¯‘å‡ºæ¥çš„ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>éŸ³é¢‘é©±åŠ¨å¼€å‘</title>
      <link href="/2023/08/05/2023-8-5-%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/08/05/2023-8-5-%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="éŸ³é¢‘è§£ç "><a href="#éŸ³é¢‘è§£ç " class="headerlink" title="éŸ³é¢‘è§£ç "></a>éŸ³é¢‘è§£ç </h2><p>å¤„ç†å™¨æ¥æ”¶éŸ³é¢‘éœ€è¦å°†å£°éŸ³é€šè¿‡ADCé‡‡é›†ï¼Œå°†æ¨¡æ‹Ÿä¿¡å·è½¬æ¢æˆä¸ºæ•°å­—ä¿¡å·ï¼Œç›¸åæ’­æ”¾å£°éŸ³å°±éœ€è¦å°†æ•°å­—ä¿¡å·è½¬æ¢æˆä¸ºæ¨¡æ‹Ÿä¿¡å·ä½¿ç”¨DACèŠ¯ç‰‡ã€‚éŸ³é¢‘ç¼–è§£ç èŠ¯ç‰‡ï¼Œè‹±æ–‡åå­—å°±æ˜¯ Audio CODEC ã€‚</p><p>æ—¢ç„¶éŸ³é¢‘ CODEC çš„æœ¬è´¨æ˜¯ ADC å’Œ DACï¼Œé‚£ä¹ˆé‡‡æ ·ç‡å’Œé‡‡æ ·ä½æ•°å°±æ˜¯è¡¡é‡ä¸€æ¬¾éŸ³é¢‘<br>CODEC æœ€é‡è¦çš„æŒ‡æ ‡ã€‚æ¯”å¦‚å¸¸è§éŸ³é¢‘é‡‡æ ·ç‡æœ‰ 8Kã€ 44.1Kã€ 48Kã€ 192K ç”šè‡³ 384K å’Œ 768Kï¼Œé‡‡æ ·ä½æ•°å¸¸è§çš„æœ‰ 8 ä½ã€ 16 ä½ã€ 24 ä½ã€ 32 ä½ã€‚é‡‡æ ·ç‡å’Œé‡‡æ ·ä½æ•°è¶Šé«˜ï¼Œé‚£ä¹ˆéŸ³é¢‘ CODEC è¶Šèƒ½çœŸå®çš„è¿˜åŸå£°éŸ³ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶è¯´çš„ HIFIã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-05%20140803.png"></p><p>â‘ ã€æ­¤éƒ¨åˆ†æ˜¯ WM8960 æä¾›çš„è¾“å…¥æ¥å£ï¼Œä½œä¸ºç«‹ä½“å£°éŸ³é¢‘è¾“å…¥æºï¼Œä¸€å…±æä¾›äº†ä¸‰è·¯ï¼Œåˆ†åˆ«ä¸º LINPUT1&#x2F;RINPUT1ã€ LINPUT2&#x2F;RINPUT2ã€ LINPUT3&#x2F;RINPUT3ã€‚éº¦å…‹é£æˆ–çº¿è·¯è¾“å…¥å°±è¿æ¥åˆ°æ­¤æ¥å£ä¸Šã€‚<br>â‘¡ã€æ­¤éƒ¨åˆ†æ˜¯ WM8960 çš„è¾“å‡ºæ¥å£ï¼Œæ¯”å¦‚è¾“å‡ºç»™è€³æœºæˆ–å–‡å­ï¼Œ SPK_LP&#x2F;SPK_LN ç”¨äºè¿æ¥å·¦å£°é“çš„å–‡å­ï¼Œæ”¯æŒ 1W çš„ 8Î©å–‡å­ã€‚  </p><p>â‘¢ã€æ­¤éƒ¨åˆ†æ˜¯æ•°å­—éŸ³é¢‘æ¥å£ï¼Œç”¨äºå’Œä¸»æ§åˆ¶å™¨è¿æ¥ï¼Œæœ‰ 5 æ ¹çº¿ï¼Œç”¨äºä¸»æ§åˆ¶å™¨å’Œ WM8960ä¹‹é—´è¿›è¡Œæ•°æ®â€œæ²Ÿé€šâ€ã€‚ä¸»æ§åˆ¶å™¨å‘ WM8960 çš„ DAC å‘é€çš„æ•°æ®ï¼ŒWM8960 çš„ ADC å‘ä¸»æ§åˆ¶ä¼ é€’çš„æ•°æ®éƒ½æ˜¯é€šè¿‡æ­¤éŸ³é¢‘æ¥å£æ¥å®Œæˆçš„ã€‚ </p><p>æ­¤æ¥å£æ”¯æŒ I2S æ ¼å¼ã€‚æ­¤æ¥å£ 5 æ ¹çº¿çš„ä½œç”¨å¦‚ä¸‹ï¼š<br>ADCDATï¼š ADC æ•°æ®è¾“å‡ºå¼•è„šï¼Œé‡‡é›†åˆ°çš„éŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºæ•°å­—ä¿¡å·ä»¥åé€šè¿‡æ­¤å¼•è„šä¼ è¾“ç»™ä¸»æ§åˆ¶å™¨ã€‚<br>ADCLRCï¼š ADC æ•°æ®å¯¹é½æ—¶é’Ÿï¼Œä¹Ÿå°±æ˜¯å¸§æ—¶é’Ÿ(LRCK)ï¼Œç”¨äºåˆ‡æ¢å·¦å³å£°é“æ•°æ®ï¼Œ æ­¤ä¿¡å·çš„é¢‘ç‡å°±æ˜¯é‡‡æ ·ç‡ã€‚æ­¤å¼•è„šå¯ä»¥é…ç½®ä¸º GPIO åŠŸèƒ½ï¼Œé…ç½®ä¸º GPIO ä»¥å ADC å°±ä¼šä½¿ç”¨ DACLRCå¼•è„šä½œä¸ºå¸§æ—¶é’Ÿã€‚<br>DACDATï¼š DAC æ•°æ®è¾“å…¥å¼•è„šï¼Œä¸»æ§å™¨é€šè¿‡æ­¤å¼•è„šå°†æ•°å­—ä¿¡å·è¾“å…¥ç»™ WM8960 çš„ DACã€‚<br>DACLRCï¼š DAC æ•°æ®å¯¹é½æ—¶é’Ÿï¼ŒåŠŸèƒ½å’Œ ADCLRC ä¸€æ ·ï¼Œéƒ½æ˜¯å¸§æ—¶é’Ÿ(LRCK)ï¼Œç”¨äºåˆ‡æ¢å·¦å³å£°é“æ•°æ®ï¼Œæ­¤ä¿¡å·çš„é¢‘ç‡ç­‰äºé‡‡æ ·ç‡ã€‚<br>BCLKï¼š ä½æ—¶é’Ÿï¼Œç”¨äºåŒæ­¥ã€‚<br>MCLKï¼š ä¸»æ—¶é’Ÿï¼Œ WM8960 å·¥ä½œçš„æ—¶å€™è¿˜éœ€è¦ä¸€è·¯ä¸»æ—¶é’Ÿï¼Œæ­¤æ—¶é’Ÿç”± I.MX6ULL æä¾›ï¼ŒMCLK é¢‘ç‡ç­‰äºé‡‡æ ·ç‡çš„ 256 æˆ– 384 å€ã€‚</p><p>â‘£ã€æ­¤éƒ¨åˆ†ä¸ºæ§åˆ¶æ¥å£ï¼Œæ˜¯ä¸€ä¸ªæ ‡å‡†çš„ I2C æ¥å£ï¼Œ WM8960 è¦æƒ³å·¥ä½œå¿…é¡»å¯¹å…¶è¿›è¡Œé…ç½®ï¼Œè¿™ä¸ª I2C æ¥å£å°±æ˜¯ç”¨äºé…ç½® WM8960 çš„ã€‚ </p><h3 id="I2Sæ€»çº¿"><a href="#I2Sæ€»çº¿" class="headerlink" title="I2Sæ€»çº¿"></a>I2Sæ€»çº¿</h3><p>I2S æ˜¯é£åˆ©æµ¦å…¬å¸æå‡ºçš„ä¸€ç§ç”¨äºæ•°å­—éŸ³é¢‘è®¾å¤‡ä¹‹é—´è¿›è¡ŒéŸ³é¢‘æ•°æ®ä¼ è¾“çš„æ€»çº¿ã€‚I2S æ€»çº¿ç”¨äºä¸»æ§åˆ¶å™¨å’ŒéŸ³é¢‘ CODEC èŠ¯ç‰‡ä¹‹é—´ä¼ è¾“éŸ³é¢‘æ•°æ®ã€‚å› æ­¤ï¼Œè¦æƒ³ä½¿ç”¨ I2S åè®®ï¼Œ ä¸»æ§åˆ¶å™¨å’ŒéŸ³é¢‘ CODEC éƒ½å¾—æ”¯æŒ I2S åè®®  ã€‚</p><p><strong>SCK</strong>ï¼š ä¸²è¡Œæ—¶é’Ÿä¿¡å·ï¼Œä¹Ÿå«åšä½æ—¶é’Ÿ(BCLK)ï¼Œ<strong>éŸ³é¢‘æ•°æ®çš„æ¯ä¸€ä½æ•°æ®éƒ½å¯¹åº”ä¸€ä¸ª SCK</strong>ï¼Œç«‹ä½“å£°éƒ½æ˜¯åŒå£°é“çš„ï¼Œå› æ­¤ <strong>SCK&#x3D;2Ã—é‡‡æ ·ç‡Ã—é‡‡æ ·ä½æ•°</strong>ã€‚æ¯”å¦‚é‡‡æ ·ç‡ä¸º 44.1KHzã€ 16 ä½çš„ç«‹ä½“å£°éŸ³é¢‘ï¼Œé‚£ä¹ˆ SCK&#x3D;2Ã— 44100Ã—16&#x3D;1411200Hz&#x3D;1.4112MHzã€‚<br><strong>WS</strong>ï¼š å­—æ®µ(å£°é“)é€‰æ‹©ä¿¡å·ï¼Œä¹Ÿå«åš LRCKï¼Œä¹Ÿå«åšå¸§æ—¶é’Ÿï¼Œç”¨äºåˆ‡æ¢å·¦å³å£°é“æ•°æ®ï¼Œ WS ä¸ºâ€œ1â€è¡¨ç¤ºæ­£åœ¨ä¼ è¾“å·¦å£°é“çš„æ•°æ®ï¼Œ WS ä¸ºâ€œ0â€è¡¨ç¤ºæ­£åœ¨ä¼ è¾“å³å£°é“çš„æ•°æ®ã€‚ WS çš„é¢‘ç‡ç­‰äºé‡‡æ ·ç‡ï¼Œæ¯”å¦‚é‡‡æ ·ç‡ä¸º 44.1KHz çš„éŸ³é¢‘ï¼Œ WS&#x3D;44.1KHzã€‚<br><strong>SD</strong>ï¼š ä¸²è¡Œæ•°æ®ä¿¡å·ï¼Œ<strong>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å®é™…çš„éŸ³é¢‘æ•°æ®</strong>ï¼Œå¦‚æœè¦åŒæ—¶å®ç°æ”¾éŸ³å’Œå½•éŸ³ï¼Œé‚£ä¹ˆå°±éœ€è¦ 2 æ ¹æ•°æ®çº¿ï¼Œæ¯”å¦‚ WM8960 çš„ ADCDAT å’Œ DACDATï¼Œå°±æ˜¯åˆ†åˆ«ç”¨äºå½•éŸ³å’Œæ”¾éŸ³ã€‚ä¸ç®¡éŸ³é¢‘æ•°æ®æ˜¯å¤šå°‘ä½çš„ï¼Œæ•°æ®çš„æœ€é«˜ä½éƒ½æ˜¯æœ€å…ˆä¼ è¾“çš„ã€‚æ•°æ®çš„æœ€é«˜ä½æ€»æ˜¯å‡ºç°åœ¨ä¸€å¸§å¼€å§‹å(LRCKå˜åŒ–)çš„ç¬¬ 2 ä¸ª SCK è„‰å†²å¤„ã€‚<br>å¦å¤–ï¼Œæœ‰æ—¶å€™ä¸ºäº†ä½¿éŸ³é¢‘ CODEC èŠ¯ç‰‡ä¸ä¸»æ§åˆ¶å™¨ä¹‹é—´èƒ½å¤Ÿæ›´å¥½çš„åŒæ­¥ï¼Œä¼šå¼•å…¥å¦å¤–ä¸€ä¸ªå«åš MCLK çš„ä¿¡å·ï¼Œä¹Ÿå«åšä¸»æ—¶é’Ÿæˆ–ç³»ç»Ÿæ—¶é’Ÿï¼Œä¸€èˆ¬æ˜¯é‡‡æ ·ç‡çš„ 256 å€æˆ– 384 å€ã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-05%20143955.png"></p><p>â€‹ä¸€å¸§ç«‹ä½“å£°æ—¶åºå›¾</p><p>SAIæ¥å£ï¼Œå…¨ç§°ä¸º Synchronous Audio Interface ï¼ˆåŒæ­¥éŸ³é¢‘æ¥å£ï¼‰</p><p>SAIçš„ä¸»è¦ç‰¹æ€§æ˜¯ï¼š</p><p>â‘ ã€å¸§æœ€å¤§ä¸º32å­—</p><p>â‘¡ã€å­—æœ€å¤§å¯é€‰æ‹©8bitå’Œ32bit</p><p>â‘¢ã€æ¯ä¸ªæ¥æ”¶å’Œå‘é€é€šé“æ‹¥æœ‰32x32bitçš„FIFO</p><p>â‘£ã€FIFOé”™è¯¯ä»¥åæ”¯æŒå¹³æ»‘é‡å¯ ã€‚     <a href="https://blog.csdn.net/qq_46015011/article/details/107086812">FIFOæ˜¯ä»€ä¹ˆæ„æ€_é£é¸Ÿ211çš„åšå®¢</a>)</p><p>ä½¿ç”¨éŸ³é¢‘èŠ¯ç‰‡ä¸ºwm8960èŠ¯ç‰‡ï¼Œåœ¨imx6ullä¸Šçš„ç¡¬ä»¶æ¡†å›¾ä¸º</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-05%20190900.png"></p><h3 id="éŸ³é¢‘é©±åŠ¨ä½¿èƒ½"><a href="#éŸ³é¢‘é©±åŠ¨ä½¿èƒ½" class="headerlink" title="éŸ³é¢‘é©±åŠ¨ä½¿èƒ½"></a>éŸ³é¢‘é©±åŠ¨ä½¿èƒ½</h3><p>nxpçš„å®˜æ–¹å†™å¥½äº†wm8960é©±åŠ¨ï¼Œå› æ­¤é…ç½®å†…æ ¸ä½¿èƒ½å°±è¡Œã€‚</p><p>é¦–å…ˆæ˜¯æ·»åŠ è®¾å¤‡æ ‘çš„èŠ‚ç‚¹ï¼ŒæŸ¥çœ‹è®¾å¤‡æ ‘å…³äºæ­¤èŠ¯ç‰‡çš„é©±åŠ¨æ‰‹å†Œï¼Œä½ç½®åœ¨Documentation&#x2F;devicetree&#x2F;bindings&#x2F;sound&#x2F;wm8960.txt</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-05%20190436.png"></p><p>å¯ä»¥çœ‹åˆ°éœ€è¦ä¸¤ä¸ªå¿…å¤‡ç‰¹æ€§ï¼Œcompatitbleå’Œregï¼Œè¿˜æœ‰ä¸¤ä¸ªå¯é€‰ç‰¹æ€§ï¼Œwlf,shared-lrclkå’Œwlf,caplessã€‚</p><p>ç”±äºç¡¬ä»¶çº¿è·¯å°†é…ç½®æ¥å£æ¥åœ¨äº†i2c2ä¸Šï¼Œæ‰€ä»¥åœ¨i2c2ä¸Šæ·»åŠ è®¾å¤‡æ ‘çš„èŠ‚ç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">codec: wm8960@<span class="number">1</span>a &#123;</span><br><span class="line">compatible = <span class="string">&quot;wlf,wm8960&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">0x1a</span>&gt;;</span><br><span class="line">clocks = &lt;&amp;clks IMX6UL_CLK_SAI2&gt;;<span class="comment">//æ—¶é’ŸæºSAI2</span></span><br><span class="line">clock-names = <span class="string">&quot;mclk&quot;</span>;<span class="comment">//æ—¶é’Ÿåå­—ï¼Œä¸ºäº†åŒæ­¥ä¸€èˆ¬æä¾›mclkçš„æ—¶é’Ÿ</span></span><br><span class="line">wlf,shared-lrclk;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¹‹åæ˜¯SAIçš„çš„èŠ‚ç‚¹ä»£ç ï¼Œsoundæ˜¯åœ¨æ ¹èŠ‚ç‚¹ä¸‹çš„ä¸€ä¸ªä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">sound &#123;</span><br><span class="line">compatible = <span class="string">&quot;fsl,imx6ul-evk-wm8960&quot;</span>,</span><br><span class="line">   <span class="string">&quot;fsl,imx-audio-wm8960&quot;</span>;<span class="comment">//ç”¨äºåŒ¹é…é©±åŠ¨æ—¶ä½¿ç”¨</span></span><br><span class="line">model = <span class="string">&quot;wm8960-audio&quot;</span>;<span class="comment">//å£°å¡çš„åå­—ï¼Œç›¸å½“äºè®¾å¤‡åå­—</span></span><br><span class="line">cpu-dai = &lt;&amp;sai2&gt;;<span class="comment">//CPU DAIï¼ˆDigtial Audio Interfaceï¼‰å¥æŸ„</span></span><br><span class="line">audio-codec = &lt;&amp;codec&gt;;<span class="comment">//éŸ³é¢‘è§£ç èŠ¯ç‰‡å¥æŸ„</span></span><br><span class="line">asrc-controller = &lt;&amp;asrc&gt;;<span class="comment">//asrcæ§åˆ¶å™¨</span></span><br><span class="line">codec-master;</span><br><span class="line">gpr = &lt;&amp;gpr <span class="number">4</span> <span class="number">0x100000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * hp-det = &lt;hp-det-pin hp-det-polarity&gt;;</span></span><br><span class="line"><span class="comment"> * hp-det-pin: JD1 JD2  or JD3</span></span><br><span class="line"><span class="comment"> * hp-det-polarity = 0: hp detect high for headphone</span></span><br><span class="line"><span class="comment"> * hp-det-polarity = 1: hp detect high for speaker</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">hp-det = &lt;<span class="number">3</span> <span class="number">0</span>&gt;;<span class="comment">//è€³æœºæ’å…¥æ£€æµ‹</span></span><br><span class="line"><span class="comment">/*hp-det-gpios = &lt;&amp;gpio5 4 0&gt;;</span></span><br><span class="line"><span class="comment">mic-det-gpios = &lt;&amp;gpio5 4 0&gt;;*/</span></span><br><span class="line">audio-routing =<span class="comment">//éŸ³é¢‘å™¨ä»¶ä¸€ç³»åˆ—çš„è¿æ¥è®¾ç½®</span></span><br><span class="line"><span class="string">&quot;Headphone Jack&quot;</span>, <span class="string">&quot;HP_L&quot;</span>,</span><br><span class="line"><span class="string">&quot;Headphone Jack&quot;</span>, <span class="string">&quot;HP_R&quot;</span>,</span><br><span class="line"><span class="string">&quot;Ext Spk&quot;</span>, <span class="string">&quot;SPK_LP&quot;</span>,</span><br><span class="line"><span class="string">&quot;Ext Spk&quot;</span>, <span class="string">&quot;SPK_LN&quot;</span>,</span><br><span class="line"><span class="string">&quot;Ext Spk&quot;</span>, <span class="string">&quot;SPK_RP&quot;</span>,</span><br><span class="line"><span class="string">&quot;Ext Spk&quot;</span>, <span class="string">&quot;SPK_RN&quot;</span>,</span><br><span class="line"><span class="string">&quot;LINPUT2&quot;</span>, <span class="string">&quot;Mic Jack&quot;</span>,</span><br><span class="line"><span class="string">&quot;LINPUT3&quot;</span>, <span class="string">&quot;Mic Jack&quot;</span>,</span><br><span class="line"><span class="string">&quot;RINPUT1&quot;</span>, <span class="string">&quot;Main MIC&quot;</span>,</span><br><span class="line"><span class="string">&quot;RINPUT2&quot;</span>, <span class="string">&quot;Main MIC&quot;</span>,</span><br><span class="line"><span class="string">&quot;Mic Jack&quot;</span>, <span class="string">&quot;MICB&quot;</span>,</span><br><span class="line"><span class="string">&quot;Main MIC&quot;</span>, <span class="string">&quot;MICB&quot;</span>,</span><br><span class="line"><span class="string">&quot;CPU-Playback&quot;</span>, <span class="string">&quot;ASRC-Playback&quot;</span>,</span><br><span class="line"><span class="string">&quot;Playback&quot;</span>, <span class="string">&quot;CPU-Playback&quot;</span>,</span><br><span class="line"><span class="string">&quot;ASRC-Capture&quot;</span>, <span class="string">&quot;CPU-Capture&quot;</span>,</span><br><span class="line"><span class="string">&quot;CPU-Capture&quot;</span>, <span class="string">&quot;Capture&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœæŸ¥çœ‹ä½¿ç”¨SAIå¼•è„šçš„è®¾ç½®ï¼ŒæŸ¥çœ‹sai2çš„èŠ‚ç‚¹ï¼Œé¦–å…ˆçœ‹imx6ull.dtsiçš„è®¾å¤‡èŠ‚ç‚¹ï¼Œä¹‹åå¯¹è‡ªå·±çš„è®¾å¤‡æ ‘æ–‡ä»¶è¿›è¡Œè¿½åŠ ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> &amp;sai2 &#123;</span><br><span class="line"><span class="number">2</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">3</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_sai2</span><br><span class="line"><span class="number">4</span>                &amp;pinctrl_sai2_hp_det_b&gt;;</span><br><span class="line"><span class="number">5</span>assigned-clocks = &lt;&amp;clks IMX6UL_CLK_SAI2_SEL&gt;,</span><br><span class="line"><span class="number">6</span>                   &lt;&amp;clks IMX6UL_CLK_SAI2&gt;;</span><br><span class="line"><span class="number">7</span> assigned-clock-parents = &lt;&amp;clks IMX6UL_CLK_PLL4_AUDIO_DIV&gt;;</span><br><span class="line"><span class="number">8</span> assigned-clock-rates = &lt;<span class="number">0</span>&gt;, &lt;<span class="number">12288000</span>&gt;;</span><br><span class="line"><span class="number">9</span> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">10</span> &#125;;</span><br></pre></td></tr></table></figure><p>ä» pinctrl-0 å±æ€§å¯ä»¥çœ‹å‡ºè¿™é‡Œä¸€å…±æœ‰ä¸¤ç»„ IOï¼š pinctrl_sai2 å’Œ pinctrl_sai2_hp_det_bï¼Œçœ‹è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸­å¼•è„šæ˜¯å¦æ­£ç¡®ã€‚ </p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é©±åŠ¨ç¨‹åºç¼–è¯‘è¿›å…¥å†…æ ¸</title>
      <link href="/2023/08/04/2023-8-4-%E9%A9%B1%E5%8A%A8%E7%BC%96%E8%AF%91%E8%BF%9B%E5%85%A5%E5%86%85%E6%A0%B8/"/>
      <url>/2023/08/04/2023-8-4-%E9%A9%B1%E5%8A%A8%E7%BC%96%E8%AF%91%E8%BF%9B%E5%85%A5%E5%86%85%E6%A0%B8/</url>
      
        <content type="html"><![CDATA[<p>é€šå¸¸éƒ½æ˜¯å°†é©±åŠ¨æºç ç¼–è¯‘ä¸º.okæ–‡ä»¶ï¼Œç„¶åé€šè¿‡insmod æˆ–è€…modprobeåŠ è½½è¿›ç³»ç»Ÿä¸­ï¼Œè€Œåœ¨è„±ç¦»ç½‘ç»œçš„è®¾å¤‡ä¸­å°±éœ€è¦å°†é©±åŠ¨ç¼–è¯‘è¿›å…¥å†…æ ¸ã€‚</p><h3 id="å·²çŸ¥é©±åŠ¨ç±»å‹æ“ä½œæ­¥éª¤ï¼š"><a href="#å·²çŸ¥é©±åŠ¨ç±»å‹æ“ä½œæ­¥éª¤ï¼š" class="headerlink" title="å·²çŸ¥é©±åŠ¨ç±»å‹æ“ä½œæ­¥éª¤ï¼š"></a>å·²çŸ¥é©±åŠ¨ç±»å‹æ“ä½œæ­¥éª¤ï¼š</h3><ol><li><p>æŸ¥çœ‹è‡ªå·±ç¼–å†™é©±åŠ¨çš„æ‰€å±ç±»å‹ï¼Œä¾‹å¦‚ç¼–å†™ä¸€ä¸ªledçš„é©±åŠ¨ï¼Œé‚£ä¹ˆå¯»æ‰¾å†…æ ¸driversç›®å½•ä¸­çš„ledé©±åŠ¨ç›®å½•</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-04%20154249.png"></p></li><li><p>é¦–å…ˆæ‰“å¼€ç¼–å†™Kconfigæ–‡ä»¶</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-04%20154652.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tristate &quot;å†…å®¹&quot;</span><br></pre></td></tr></table></figure><p>è¿™è¡Œçš„å†…å®¹æ˜¯æ˜¾ç¤ºåœ¨menuconfigçš„ç›®å½•ä¸­ï¼Œç›¸å½“äºè¿™ä¸ªé©±åŠ¨çš„è¯´æ˜ã€‚</p></li><li><p>ä¹‹åä¿®æ”¹ledsè¿™ä¸ªç›®å½•çš„Makefile</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-04%20150403.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">obj-$</span><span class="language-bash">(CONFIG_GPIOLED)+= gpioled.o</span></span><br></pre></td></tr></table></figure><p>$()çš„å†…å®¹æ˜¯CONFIG_åé¢åŠ ä¸ŠKconfigé‡Œæ·»åŠ çš„å†…å®¹ï¼Œ+&#x3D;åé¢åŠ ä¸Šæ–‡ä»¶.oçš„åå­—</p></li><li><p>æœ€ååœ¨å†…æ ¸ä¸­ç¼–è¯‘make menuconfig,å¯ä»¥åœ¨è®¾å¤‡é©±åŠ¨çš„ledé©±åŠ¨é‡Œé¢çœ‹åˆ°è‡ªå·±å†™çš„é©±åŠ¨ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-04%20153656.png"></p></li></ol><h3 id="æœªçŸ¥é©±åŠ¨ç±»å‹æ“ä½œæ­¥éª¤ï¼š"><a href="#æœªçŸ¥é©±åŠ¨ç±»å‹æ“ä½œæ­¥éª¤ï¼š" class="headerlink" title="æœªçŸ¥é©±åŠ¨ç±»å‹æ“ä½œæ­¥éª¤ï¼š"></a>æœªçŸ¥é©±åŠ¨ç±»å‹æ“ä½œæ­¥éª¤ï¼š</h3><ol><li><p>åœ¨driversçš„ç›®å½•ä¸‹è‡ªè¡Œåˆ›å»ºä¸€ä¸ªç›®å½•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir nxpops</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ­¤ç›®å½•ä¸‹åˆ›å»ºKconfigæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nxpops</span><br><span class="line">vi Kconfig</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">menuconfigNXPOPS</span><br><span class="line">bool &quot;nxpops driver&quot;</span><br><span class="line">help </span><br><span class="line">Put the driver the operation in nxp</span><br><span class="line">configMULTITOUCH</span><br><span class="line">tristate &quot;multitouch&quot;</span><br><span class="line">depends on NXPOPS</span><br><span class="line">help</span><br><span class="line">nxp multitouch</span><br></pre></td></tr></table></figure></li><li><p>ç¼–å†™Makefile</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-<span class="variable">$(CONFIG_BEEP)</span>+= beep.o</span><br></pre></td></tr></table></figure></li><li><p>ä¹‹åä¿®æ”¹driversç›®å½•ä¸­çš„Kconfigå’ŒMakefileæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &quot;drivers/nxpops/Kconfig&quot;</span><br></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-y+= nxpops/</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è§¦æ‘¸å±é©±åŠ¨</title>
      <link href="/2023/07/23/2023-7-23-%E8%A7%A6%E6%91%B8%E5%B1%8F/"/>
      <url>/2023/07/23/2023-7-23-%E8%A7%A6%E6%91%B8%E5%B1%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="è§¦å±éœ€è¦çš„çŸ¥è¯†ç‚¹"><a href="#è§¦å±éœ€è¦çš„çŸ¥è¯†ç‚¹" class="headerlink" title="è§¦å±éœ€è¦çš„çŸ¥è¯†ç‚¹"></a>è§¦å±éœ€è¦çš„çŸ¥è¯†ç‚¹</h2><p>é¦–å…ˆè§¦æ‘¸å±çš„é©±åŠ¨ï¼Œä¹Ÿæ˜¯ä½¿ç”¨ä¹‹å‰ä½¿ç”¨inputçš„çŸ¥è¯†ç‚¹ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-22%20150749.png"></p><p>é€šè¿‡æ³¨å†Œå‡½æ•°æ³¨å†Œåˆ°å†…æ ¸ï¼Œ<img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-22%20150847.png"></p><p>è§¦æ§å±å¹•ï¼Œç”µå®¹å±å¹•æ˜¯æ§åˆ¶ IC ï¼Œæ‰€ä»¥è¦ä½¿ç”¨åˆ°IICçš„é©±åŠ¨ï¼Œå› ä¸ºè§¦æ‘¸ IC æä¾›äº†ä¸­æ–­ä¿¡å·å¼•è„š(INT)ï¼Œå¯ä»¥é€šè¿‡ä¸­æ–­æ¥è·å–è§¦æ‘¸ä¿¡æ¯ ï¼Œä¸ŠæŠ¥å±å¹•åæ ‡ç­‰ä¿¡æ¯éœ€è¦ä½¿ç”¨inputçš„ç³»ç»Ÿä¸ŠæŠ¥ã€‚</p><p>å¤šç‚¹ç”µå®¹è§¦æ‘¸çš„(Multi-touchï¼Œç®€ç§° MT)ï¼Œ MT åè®®è¢«åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œ TypeA å’Œ TypeBï¼Œè¿™ä¸¤ç§ç±»å‹çš„åŒºåˆ«å¦‚ä¸‹ï¼š<br>Type Aï¼šé€‚ç”¨äºè§¦æ‘¸ç‚¹ä¸èƒ½è¢«åŒºåˆ†æˆ–è€…è¿½è¸ªï¼Œæ­¤ç±»å‹çš„è®¾å¤‡ä¸ŠæŠ¥åŸå§‹æ•°æ®(æ­¤ç±»å‹åœ¨å®é™…ä½¿ç”¨ä¸­éå¸¸å°‘ï¼ )ã€‚<br>Type Bï¼šé€‚ç”¨äºæœ‰ç¡¬ä»¶è¿½è¸ªå¹¶èƒ½åŒºåˆ†è§¦æ‘¸ç‚¹çš„è§¦æ‘¸è®¾å¤‡ï¼Œæ­¤ç±»å‹è®¾å¤‡é€šè¿‡ slot æ›´æ–°æŸä¸€ä¸ªè§¦æ‘¸ç‚¹çš„ä¿¡æ¯ï¼Œ FT5426 å°±å±äºæ­¤ç±»å‹ï¼Œä¸€èˆ¬çš„å¤šç‚¹ç”µå®¹è§¦æ‘¸å± IC éƒ½æœ‰æ­¤èƒ½åŠ›ã€‚ </p><p>è§¦æ‘¸ç‚¹çš„ä¿¡æ¯é€šè¿‡ä¸€ç³»åˆ—çš„ ABS_MT äº‹ä»¶(æœ‰çš„èµ„æ–™ä¹Ÿå«æ¶ˆæ¯)ä¸ŠæŠ¥ç»™ linux å†…æ ¸ ï¼ŒABS_MT äº‹ä»¶å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;uapi&#x2F;linux&#x2F;input.hä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_mt_sync</span><span class="params">(<span class="keyword">struct</span> input_dev *dev)</span><span class="comment">//Aå‹éš”ç¦»è§¦æ‘¸ç‚¹çš„æ•°æ®</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_mt_slot</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">int</span> slot)</span><span class="comment">//Bå‹åŒºåˆ†è§¦æ‘¸ç‚¹æ•°æ®</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*å¯¹äº Type A ç±»å‹çš„è®¾å¤‡ï¼Œå‘é€è§¦æ‘¸ç‚¹ä¿¡æ¯çš„æ—¶åº*/</span></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">0</span>]<span class="comment">//é€šè¿‡ ABS_MT_POSITION_X äº‹ä»¶ä¸ŠæŠ¥ç¬¬ä¸€ä¸ªè§¦æ‘¸ç‚¹çš„ X åæ ‡æ•°æ®</span></span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">0</span>]<span class="comment">//é€šè¿‡ ABS_MT_POSITION_Y äº‹ä»¶ä¸ŠæŠ¥ç¬¬ä¸€ä¸ªè§¦æ‘¸ç‚¹çš„ Y åæ ‡æ•°æ®ã€‚</span></span><br><span class="line">SYN_MT_REPORT<span class="comment">//ä¸ŠæŠ¥ SYN_MT_REPORT äº‹ä»¶ï¼Œé€šè¿‡è°ƒç”¨ input_mt_sync å‡½æ•°æ¥å®ç°ã€‚</span></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">1</span>]<span class="comment">//é€šè¿‡ ABS_MT_POSITION_X äº‹ä»¶ä¸ŠæŠ¥ç¬¬äºŒä¸ªè§¦æ‘¸ç‚¹çš„ X åæ ‡æ•°æ®ã€‚</span></span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">1</span>]<span class="comment">//é€šè¿‡ ABS_MT_POSITION_Y äº‹ä»¶ä¸ŠæŠ¥ç¬¬äºŒä¸ªè§¦æ‘¸ç‚¹çš„ Y åæ ‡æ•°æ®ã€‚</span></span><br><span class="line">SYN_MT_REPORT<span class="comment">//ä¸ŠæŠ¥ SYN_MT_REPORT äº‹ä»¶ï¼Œé€šè¿‡è°ƒç”¨ input_mt_sync å‡½æ•°æ¥å®ç°ã€‚</span></span><br><span class="line">SYN_REPORT<span class="comment">//ä¸ŠæŠ¥ SYN_REPORT äº‹ä»¶ï¼Œé€šè¿‡è°ƒç”¨ input_sync å‡½æ•°å®ç°ã€‚</span></span><br><span class="line">    <span class="comment">/*å¯¹äº Type B ç±»å‹çš„è®¾å¤‡ï¼Œå‘é€è§¦æ‘¸ç‚¹ä¿¡æ¯çš„æ—¶åº*/</span></span><br><span class="line">ABS_MT_SLOT <span class="number">0</span><span class="comment">//ä¸ŠæŠ¥ ABS_MT_SLOT äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯è§¦æ‘¸ç‚¹å¯¹åº”çš„ SLOTã€‚</span></span><br><span class="line">ABS_MT_TRACKING_ID <span class="number">45</span><span class="comment">/*æ ¹æ® Type B çš„è¦æ±‚ï¼Œæ¯ä¸ª SLOT å¿…é¡»å…³è”ä¸€ä¸ª ABS_MT_TRACKING_IDï¼Œé€šè¿‡ä¿®æ”¹ SLOT å…³è”çš„ ABS_MT_TRACKING_ID æ¥å®Œæˆå¯¹è§¦æ‘¸ç‚¹çš„æ·»åŠ ã€æ›¿æ¢æˆ–åˆ é™¤ã€‚*/</span></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">0</span>]<span class="comment">//ä¸ŠæŠ¥è§¦æ‘¸ç‚¹ 0 çš„ X è½´åæ ‡ï¼Œä½¿ç”¨å‡½æ•° input_report_abs æ¥å®Œæˆ</span></span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">0</span>]<span class="comment">//ä¸ŠæŠ¥è§¦æ‘¸ç‚¹ 0 çš„ Y è½´åæ ‡</span></span><br><span class="line">ABS_MT_SLOT <span class="number">1</span></span><br><span class="line">ABS_MT_TRACKING_ID <span class="number">46</span></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">1</span>]</span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">1</span>]</span><br><span class="line">SYN_REPORT<span class="comment">//å½“æ‰€æœ‰çš„è§¦æ‘¸ç‚¹åæ ‡éƒ½ä¸Šä¼ å®Œæ¯•ä»¥åå°±å¾—å‘é€ SYN_REPORT äº‹ä»¶ï¼Œä½¿ç”¨ input_syncå‡½æ•°æ¥å®Œæˆã€‚</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯TypeAå’ŒB ç±»å‹çš„æ—¶åºï¼Œä½¿ç”¨å¤šç‚¹è§¦æ‘¸é©±åŠ¨çš„æ—¶å€™å°±éœ€è¦ä»¥ä¸Šçš„æ—¶åºä¸ŠæŠ¥åæ ‡ä¿¡æ¯ã€‚ </p><h3 id="å¤šç‚¹è§¦æ‘¸æ‰€ä½¿ç”¨åˆ°çš„-API-å‡½æ•°"><a href="#å¤šç‚¹è§¦æ‘¸æ‰€ä½¿ç”¨åˆ°çš„-API-å‡½æ•°" class="headerlink" title="å¤šç‚¹è§¦æ‘¸æ‰€ä½¿ç”¨åˆ°çš„ API å‡½æ•°"></a>å¤šç‚¹è§¦æ‘¸æ‰€ä½¿ç”¨åˆ°çš„ API å‡½æ•°</h3><ol><li><p>input_mt_init_slots å‡½æ•°ç”¨äºåˆå§‹åŒ– MT çš„è¾“å…¥ slotsï¼Œç¼–å†™ MT é©±åŠ¨çš„æ—¶å€™å¿…é¡»å…ˆè°ƒç”¨æ­¤å‡½æ•°åˆå§‹åŒ– slotsã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span><span class="title function_">input_mt_init_slots</span><span class="params">( <span class="keyword">struct</span> input_dev *dev,<span class="comment">//MT è®¾å¤‡å¯¹åº”çš„ input_devï¼Œå› ä¸º MT è®¾å¤‡éš¶å±äº input_devã€‚</span></span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> num_slots,<span class="comment">//è®¾å¤‡è¦ä½¿ç”¨çš„ SLOT æ•°é‡ï¼Œä¹Ÿå°±æ˜¯è§¦æ‘¸ç‚¹çš„æ•°é‡ã€‚</span></span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> flags)</span><span class="comment">//å…¶ä»–ä¸€äº› flags ä¿¡æ¯ï¼Œ</span></span><br></pre></td></tr></table></figure></li><li><p>input_mt_slot å‡½æ•° æ­¤å‡½æ•°ç”¨äº Type B ç±»å‹ï¼Œæ­¤å‡½æ•°ç”¨äºäº§ç”Ÿ ABS_MT_SLOT äº‹ä»¶ï¼Œå‘Šè¯‰å†…æ ¸å½“å‰ä¸ŠæŠ¥çš„æ˜¯å“ªä¸ªè§¦æ‘¸ç‚¹çš„åæ ‡æ•°æ® </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_mt_slot</span><span class="params">(<span class="keyword">struct</span> input_dev *dev,<span class="type">int</span> slot)</span></span><br></pre></td></tr></table></figure></li><li><p>input_mt_report_slot_state å‡½æ•°æ­¤å‡½æ•°ç”¨äº Type B ç±»å‹ï¼Œç”¨äºäº§ç”Ÿ ABS_MT_TRACKING_ID å’Œ ABS_MT_TOOL_TYPEäº‹ ä»¶ ï¼Œ ABS_MT_TRACKING_ID äº‹ ä»¶ ç»™ slot å…³ è” ä¸€ ä¸ª ABS_MT_TRACKING_ID ï¼ŒABS_MT_TOOL_TYPE äº‹ ä»¶ æŒ‡ å®š è§¦ æ‘¸ ç±» å‹ ï¼ˆ æ˜¯ ç¬” è¿˜ æ˜¯ æ‰‹ æŒ‡ ç­‰ ï¼‰ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_mt_report_slot_state</span><span class="params">( <span class="keyword">struct</span> input_dev *dev,<span class="type">unsigned</span> <span class="type">int</span> tool_type,<span class="type">bool</span> active)</span></span><br><span class="line"><span class="comment">/*devï¼š MT è®¾å¤‡å¯¹åº”çš„ input_devã€‚</span></span><br><span class="line"><span class="comment">tool_typeï¼šè§¦æ‘¸ç±»å‹ï¼Œå¯ä»¥é€‰æ‹© MT_TOOL_FINGER(æ‰‹æŒ‡)ã€ MT_TOOL_PEN(ç¬”)æˆ–</span></span><br><span class="line"><span class="comment">MT_TOOL_PALM(æ‰‹æŒ)ï¼Œå¯¹äºå¤šç‚¹ç”µå®¹è§¦æ‘¸å±æ¥è¯´ä¸€èˆ¬éƒ½æ˜¯æ‰‹æŒ‡ã€‚</span></span><br><span class="line"><span class="comment">activeï¼š trueï¼Œè¿ç»­è§¦æ‘¸ï¼Œ input å­ç³»ç»Ÿå†…æ ¸ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ª ABS_MT_TRACKING_ID ç»™ slotã€‚</span></span><br><span class="line"><span class="comment">falseï¼Œè§¦æ‘¸ç‚¹æŠ¬èµ·ï¼Œè¡¨ç¤ºæŸä¸ªè§¦æ‘¸ç‚¹æ— æ•ˆäº†ï¼Œ input å­ç³»ç»Ÿå†…æ ¸ä¼šåˆ†é…ä¸€ä¸ª-1 ç»™ slotï¼Œè¡¨ç¤ºè§¦æ‘¸</span></span><br><span class="line"><span class="comment">ç‚¹æº¢å‡ºã€‚*/</span></span><br></pre></td></tr></table></figure></li><li><p>input_report_abs å‡½æ•°Type A å’Œ Type B ç±»å‹éƒ½ä½¿ç”¨æ­¤å‡½æ•°ä¸ŠæŠ¥è§¦æ‘¸ç‚¹åæ ‡ä¿¡æ¯ï¼Œé€šè¿‡ ABS_MT_POSITION_X å’ŒABS_MT_POSITION_Y äº‹ ä»¶ å® ç° X å’Œ Y è½´ å æ ‡ ä¿¡ æ¯ ä¸Š æŠ¥ ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_report_abs</span><span class="params">( <span class="keyword">struct</span> input_dev *dev,<span class="type">unsigned</span> <span class="type">int</span> code,<span class="type">int</span> value)</span></span><br><span class="line"><span class="comment">/*devï¼š MT è®¾å¤‡å¯¹åº”çš„ input_devã€‚</span></span><br><span class="line"><span class="comment">codeï¼šè¦ä¸ŠæŠ¥çš„æ˜¯ä»€ä¹ˆæ•°æ®ï¼Œå¯ä»¥è®¾ç½®ä¸º ABS_MT_POSITION_X æˆ– ABS_MT_POSITION_Yï¼Œ</span></span><br><span class="line"><span class="comment">ä¹Ÿå°±æ˜¯ X è½´æˆ–è€… Y è½´åæ ‡æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">valueï¼š å…·ä½“çš„ X è½´æˆ– Y è½´åæ ‡æ•°æ®å€¼*/</span></span><br></pre></td></tr></table></figure></li><li><p>input_mt_report_pointer_emulation å¦‚æœè¿½è¸ªåˆ°çš„è§¦æ‘¸ç‚¹æ•°é‡å¤šäºå½“å‰ä¸ŠæŠ¥çš„æ•°é‡ï¼Œé©±åŠ¨ç¨‹åºä½¿ç”¨ BTN_TOOL_TAP äº‹ä»¶æ¥é€šçŸ¥ç”¨æˆ·ç©ºé—´å½“å‰è¿½è¸ªåˆ°çš„è§¦æ‘¸ç‚¹æ€»æ•°é‡ï¼Œç„¶åè°ƒç”¨ input_mt_report_pointer_emulation å‡½æ•°å°†use_count å‚æ•°è®¾ç½®ä¸º falseã€‚å¦åˆ™çš„è¯å°†use_count å‚æ•°è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºå½“å‰çš„è§¦æ‘¸ç‚¹æ•°é‡(å‡½æ•°ä¼šè·å–åˆ°å…·ä½“çš„è§¦æ‘¸ç‚¹æ•°é‡ï¼Œä¸éœ€è¦ç”¨æˆ·ç»™å‡º) </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_mt_report_pointer_emulation</span><span class="params">(<span class="keyword">struct</span> input_dev *dev,<span class="type">bool</span> use_count)</span></span><br><span class="line"><span class="comment">/*devï¼š MT è®¾å¤‡å¯¹åº”çš„ input_devã€‚</span></span><br><span class="line"><span class="comment">use_countï¼š trueï¼Œæœ‰æ•ˆçš„è§¦æ‘¸ç‚¹æ•°é‡ï¼› falseï¼Œè¿½è¸ªåˆ°çš„è§¦æ‘¸ç‚¹æ•°é‡å¤šäºå½“å‰ä¸ŠæŠ¥çš„æ•°é‡ã€‚*/</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="å¤šç‚¹ç”µå®¹è§¦æ‘¸é©±åŠ¨æ¡†æ¶"><a href="#å¤šç‚¹ç”µå®¹è§¦æ‘¸é©±åŠ¨æ¡†æ¶" class="headerlink" title="å¤šç‚¹ç”µå®¹è§¦æ‘¸é©±åŠ¨æ¡†æ¶"></a>å¤šç‚¹ç”µå®¹è§¦æ‘¸é©±åŠ¨æ¡†æ¶</h3><p>â‘ ã€å¤šç‚¹ç”µå®¹è§¦æ‘¸èŠ¯ç‰‡çš„æ¥å£ï¼Œä¸€èˆ¬éƒ½ä¸º I2C æ¥å£ï¼Œå› æ­¤é©±åŠ¨ä¸»æ¡†æ¶è‚¯å®šæ˜¯ I2Cã€‚<br>â‘¡ã€ linux é‡Œé¢ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ä¸­æ–­æ¥ä¸ŠæŠ¥è§¦æ‘¸ç‚¹åæ ‡ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦ç”¨åˆ°ä¸­æ–­æ¡†æ¶ã€‚<br>â‘¢ã€å¤šç‚¹ç”µå®¹è§¦æ‘¸å±äº input å­ç³»ç»Ÿï¼Œå› æ­¤è¿˜è¦ç”¨åˆ° input å­ç³»ç»Ÿæ¡†æ¶ã€‚<br>â‘£ã€åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­æŒ‰ç…§ linux çš„ MT åè®®ä¸ŠæŠ¥åæ ‡ä¿¡æ¯ã€‚ </p><h4 id="IICé©±åŠ¨æ¡†æ¶"><a href="#IICé©±åŠ¨æ¡†æ¶" class="headerlink" title="IICé©±åŠ¨æ¡†æ¶"></a>IICé©±åŠ¨æ¡†æ¶</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="comment">/* è®¾å¤‡æ ‘åŒ¹é…è¡¨ */</span></span><br><span class="line"><span class="number">2</span> <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">xxx_ts_id</span>[] =</span> &#123;</span><br><span class="line"><span class="number">3</span> &#123; <span class="string">&quot;xxx&quot;</span>, <span class="number">0</span>, &#125;,</span><br><span class="line"><span class="number">4</span> &#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line"><span class="number">5</span> &#125;;</span><br><span class="line"><span class="number">6</span> </span><br><span class="line"><span class="number">7</span><span class="comment">/* è®¾å¤‡æ ‘åŒ¹é…è¡¨ */</span></span><br><span class="line"><span class="number">8</span> <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">xxx_of_match</span>[] =</span> &#123;</span><br><span class="line"><span class="number">9</span> &#123; .compatible = <span class="string">&quot;xxx&quot;</span>, &#125;,</span><br><span class="line"><span class="number">10</span> &#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line"><span class="number">11</span> &#125;;</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span> <span class="comment">/* i2c é©±åŠ¨ç»“æ„ä½“ */</span></span><br><span class="line"><span class="number">14</span> <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">ft5x06_ts_driver</span> =</span> &#123;</span><br><span class="line"><span class="number">15</span> .driver = &#123;</span><br><span class="line"><span class="number">16</span> .owner = THIS_MODULE,</span><br><span class="line"><span class="number">17</span> .name = <span class="string">&quot;edt_ft5x06&quot;</span>,</span><br><span class="line"><span class="number">18</span> .of_match_table =of_match_ptr(xxx_of_match),</span><br><span class="line"><span class="number">19</span> &#125;,</span><br><span class="line"><span class="number">20</span> .id_table = xxx_ts_id,</span><br><span class="line"><span class="number">21</span> .probe = xxx_ts_probe,</span><br><span class="line"><span class="number">22</span> .remove = xxx_ts_remove,</span><br><span class="line"><span class="number">23</span> &#125;;</span><br><span class="line"><span class="number">24</span></span><br><span class="line"><span class="number">25</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">26 * @description : é©±åŠ¨å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="comment">27 * @param : æ— </span></span><br><span class="line"><span class="comment">28 * @return : æ— </span></span><br><span class="line"><span class="comment">29 */</span></span><br><span class="line"><span class="number">30</span> <span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">31 &#123;</span><br><span class="line"><span class="number">32</span> <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="number">33</span></span><br><span class="line"><span class="number">34</span> ret = i2c_add_driver(&amp;xxx_ts_driver);</span><br><span class="line"><span class="number">35</span></span><br><span class="line"><span class="number">36</span> <span class="keyword">return</span> ret;</span><br><span class="line"><span class="number">37</span> &#125;</span><br><span class="line"><span class="number">38</span></span><br><span class="line"><span class="number">39</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment">40 * @description : é©±åŠ¨å‡ºå£å‡½æ•°</span></span><br><span class="line"><span class="comment">41 * @param : æ— </span></span><br><span class="line"><span class="comment">42 * @return : æ— </span></span><br><span class="line"><span class="comment">43 */</span></span><br><span class="line"><span class="number">44</span> <span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">45 &#123;</span><br><span class="line"><span class="number">46</span> i2c_del_driver(&amp;ft5x06_ts_driver);</span><br><span class="line"><span class="number">47</span> &#125;</span><br><span class="line"><span class="number">48</span></span><br><span class="line"><span class="number">49</span> module_init(xxx_init);</span><br><span class="line"><span class="number">50</span> module_exit(xxx_exit);</span><br><span class="line"><span class="number">51</span> MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"><span class="number">52</span> MODULE_AUTHOR(<span class="string">&quot;zuozhongkai&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="åˆå§‹åŒ–è§¦æ‘¸-ICã€ä¸­æ–­å’Œ-input-å­ç³»ç»Ÿ"><a href="#åˆå§‹åŒ–è§¦æ‘¸-ICã€ä¸­æ–­å’Œ-input-å­ç³»ç»Ÿ" class="headerlink" title="åˆå§‹åŒ–è§¦æ‘¸ ICã€ä¸­æ–­å’Œ input å­ç³»ç»Ÿ"></a>åˆå§‹åŒ–è§¦æ‘¸ ICã€ä¸­æ–­å’Œ input å­ç³»ç»Ÿ</h4><p>åœ¨probeå‡½æ•°ä¸­å®Œæˆåˆå§‹åŒ–ä¸­æ–­ï¼Œinputç­‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_ts_probe</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">const</span> <span class="keyword">struct</span></span></span><br><span class="line"><span class="params">i2c_device_id *id)</span></span><br><span class="line">2 &#123;</span><br><span class="line"><span class="number">3</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">input</span>;</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span> <span class="comment">/* 1ã€åˆå§‹åŒ– I2C */</span></span><br><span class="line"><span class="number">6</span> ......</span><br><span class="line"><span class="number">7</span> <span class="number">8</span></span><br><span class="line"><span class="comment">/* 2ï¼Œç”³è¯·ä¸­æ–­ï¼Œ */</span></span><br><span class="line"><span class="number">9</span> devm_request_threaded_irq(&amp;client-&gt;dev, client-&gt;irq, <span class="literal">NULL</span>,</span><br><span class="line"><span class="number">10</span> xxx_handler, IRQF_TRIGGER_FALLING | IRQF_ONESHOT,</span><br><span class="line"><span class="number">11</span> client-&gt;name, &amp;xxx);</span><br><span class="line"><span class="number">12</span> ......</span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span> <span class="comment">/* 3ï¼Œ input è®¾å¤‡ç”³è¯·ä¸åˆå§‹åŒ– */</span></span><br><span class="line"><span class="number">15</span> input = devm_input_allocate_device(&amp;client-&gt;dev);</span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span> input-&gt;name = client-&gt;name;</span><br><span class="line"><span class="number">18</span> input-&gt;id.bustype = BUS_I2C;</span><br><span class="line"><span class="number">19</span> input-&gt;dev.parent = &amp;client-&gt;dev;</span><br><span class="line"><span class="number">20</span> ......</span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">22</span> <span class="comment">/* 4ï¼Œåˆå§‹åŒ– input å’Œ MT */</span></span><br><span class="line"><span class="number">23</span> __set_bit(EV_ABS, input-&gt;evbit);</span><br><span class="line"><span class="number">24</span> __set_bit(BTN_TOUCH, input-&gt;keybit);</span><br><span class="line"><span class="number">25</span></span><br><span class="line"><span class="number">26</span> input_set_abs_params(input, ABS_X, <span class="number">0</span>, width, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="number">27</span> input_set_abs_params(input, ABS_Y, <span class="number">0</span>, height, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="number">28</span> input_set_abs_params(input, ABS_MT_POSITION_X,<span class="number">0</span>, width, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="number">29</span> input_set_abs_params(input, ABS_MT_POSITION_Y,<span class="number">0</span>, height, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="number">30</span> input_mt_init_slots(input, MAX_SUPPORT_POINTS, <span class="number">0</span>);</span><br><span class="line"><span class="number">31</span> ......</span><br><span class="line"><span class="number">32</span></span><br><span class="line"><span class="number">33</span> <span class="comment">/* 5ï¼Œæ³¨å†Œ input_dev */</span></span><br><span class="line"><span class="number">34</span> input_register_device(input);</span><br><span class="line"><span class="number">35</span> ......</span><br><span class="line"><span class="number">36</span> &#125;</span><br></pre></td></tr></table></figure><h4 id="ä¸ŠæŠ¥åæ ‡ä¿¡æ¯"><a href="#ä¸ŠæŠ¥åæ ‡ä¿¡æ¯" class="headerlink" title="ä¸ŠæŠ¥åæ ‡ä¿¡æ¯"></a>ä¸ŠæŠ¥åæ ‡ä¿¡æ¯</h4><p>typeBæ—¶åºçš„è®¾å¤‡å¤šï¼ŒæŒ‰ç…§typeBçš„æ—¶åºæ¥è¿›è¡ŒæŠ’å†™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="type">static</span> <span class="type">irqreturn_t</span> <span class="title function_">xxx_handler</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span><br><span class="line">2 &#123;</span><br><span class="line"><span class="number">3</span> </span><br><span class="line"><span class="number">4</span> <span class="type">int</span> num; <span class="comment">/* è§¦æ‘¸ç‚¹æ•°é‡ */</span></span><br><span class="line"><span class="number">5</span> <span class="type">int</span> x[n], y[n]; <span class="comment">/* ä¿å­˜åæ ‡å€¼ */</span></span><br><span class="line"><span class="number">6</span> </span><br><span class="line"><span class="number">7</span><span class="comment">/* 1ã€ä»è§¦æ‘¸èŠ¯ç‰‡è·å–å„ä¸ªè§¦æ‘¸ç‚¹åæ ‡å€¼ */</span></span><br><span class="line"><span class="number">8</span> ......</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span> <span class="comment">/* 2ã€ä¸ŠæŠ¥æ¯ä¸€ä¸ªè§¦æ‘¸ç‚¹åæ ‡ */</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line"><span class="number">12</span> input_mt_slot(input, id);</span><br><span class="line"><span class="number">13</span> input_mt_report_slot_state(input, MT_TOOL_FINGER, <span class="literal">true</span>);</span><br><span class="line"><span class="number">14</span> input_report_abs(input, ABS_MT_POSITION_X, x[i]);</span><br><span class="line"><span class="number">15</span> input_report_abs(input, ABS_MT_POSITION_Y, y[i]);</span><br><span class="line"><span class="number">16</span> &#125;</span><br><span class="line"><span class="number">17</span> ......</span><br><span class="line"><span class="number">18</span></span><br><span class="line"><span class="number">19</span> input_sync(input);</span><br><span class="line"><span class="number">20</span> ......</span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">22</span> <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line"><span class="number">23</span> &#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/blogImg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-08-01%20203604.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸²å£é©±åŠ¨</title>
      <link href="/2023/07/20/2023-7-20-%E4%B8%B2%E5%8F%A3%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/20/2023-7-20-%E4%B8%B2%E5%8F%A3%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸²å£é©±åŠ¨ç¨‹åºå±‚æ¬¡ç»“æ„"><a href="#ä¸²å£é©±åŠ¨ç¨‹åºå±‚æ¬¡ç»“æ„" class="headerlink" title="ä¸²å£é©±åŠ¨ç¨‹åºå±‚æ¬¡ç»“æ„"></a>ä¸²å£é©±åŠ¨ç¨‹åºå±‚æ¬¡ç»“æ„</h2><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-20%20203055.png"></p><p>ä¸‹å±‚ä¸ºä¸²å£é©±åŠ¨å±‚ï¼Œå®ƒç›´æ¥ä¸ç¡¬ä»¶ç›¸æ¥è§¦ï¼Œéœ€è¦å¡«å……ä¸€ä¸ª struct uart_ops çš„ç»“æ„ä½“ã€‚ä¸Šå±‚ä¸ºttyå±‚ï¼ŒåŒ…æ‹¬ttyæ ¸å¿ƒå±‚åŠçº¿è·¯è§„ç¨‹ï¼Œå®ƒä»¬å„è‡ªéƒ½æœ‰ä¸€ä¸ª ops ç»“æ„ä½“ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡ttyæ³¨å†Œçš„å­—ç¬¦è®¾å¤‡èŠ‚ç‚¹æ¥è®¿é—®ä¸²å£è®¾å¤‡ã€‚æ¶‰åŠåˆ°äº†4ä¸ª ops ç»“æ„ä½“ï¼Œå±‚å±‚è¿›è¡Œè·³è½¬ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-20%20194425.png"></p><p>uart_driveråŒ…å«äº†ä¸²å£è®¾å¤‡åã€ä¸²å£é©±åŠ¨åã€ä¸»æ¬¡è®¾å¤‡å·ã€ä¸²å£æ§åˆ¶å°(å¯é€‰)ç­‰ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uart_driver</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">module</span>  *<span class="title">owner</span>;</span> <span class="comment">//æ‹¥æœ‰è¯¥uart_driverçš„æ¨¡å—,ä¸€èˆ¬ä¸ºTHIS_MODULE </span></span><br><span class="line">   constchar *driver_name; <span class="comment">// ä¸²å£é©±åŠ¨åï¼Œä¸²å£è®¾å¤‡æ–‡ä»¶åä»¥é©±åŠ¨åä¸ºåŸºç¡€ </span></span><br><span class="line">   constchar *dev_name; <span class="comment">// ä¸²å£è®¾å¤‡å </span></span><br><span class="line">   <span class="type">int</span> major; <span class="comment">//ä¸»è®¾å¤‡å· </span></span><br><span class="line">   <span class="type">int</span> minor; <span class="comment">//æ¬¡è®¾å¤‡å· </span></span><br><span class="line">   <span class="type">int</span> nr; <span class="comment">// è¯¥uart_driveræ”¯æŒçš„ä¸²å£ä¸ªæ•°(æœ€å¤§) </span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">console</span>  *<span class="title">cons</span>;</span><span class="comment">// å…¶å¯¹åº”çš„console.è‹¥è¯¥uart_driveræ”¯æŒserial console,å¦åˆ™ä¸ºNULL </span></span><br><span class="line">    .............................</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uart_state</span>  *<span class="title">state</span>;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>  *<span class="title">tty_driver</span>;</span>   <span class="comment">//uart_driverå°è£…äº†tty_driverï¼Œä½¿åº•å±‚uarté©±åŠ¨ä¸ç”¨å…³å¿ƒttr_driverã€‚</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>(1)ä¸€ä¸ªttyé©±åŠ¨ç¨‹åºå¿…é¡»æ³¨å†Œ&#x2F;æ³¨é”€tty_driverã€‚</p><p>(2)ä¸€ä¸ªuarté©±åŠ¨åˆ™å˜ä¸ºæ³¨å†Œ&#x2F;æ³¨é”€uart_driverã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">uart_register_driver</span><span class="params">(<span class="keyword">struct</span> uart_driver *drv)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_unregister_driver</span><span class="params">(<span class="keyword">struct</span> uart_driver *drv)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">tty_register_driver</span><span class="params">(<span class="keyword">struct</span> tty_driver *drv)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">tty_unregister_driver</span><span class="params">(<span class="keyword">struct</span> tty_driver *drv)</span>;</span><br></pre></td></tr></table></figure><p><em>uart_portç”¨äºæè¿°ä¸€ä¸ªUARTç«¯å£ï¼ˆç›´æ¥å¯¹åº”äºä¸€ä¸ªä¸²å£ï¼‰çš„I&#x2F;Oç«¯å£æˆ–I&#x2F;Oå†…å­˜åœ°å€ã€FIFOå¤§å°ã€ç«¯å£ç±»å‹ç­‰ä¿¡æ¯ã€‚</em></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uart_port</span> &#123;</span></span><br><span class="line"><span class="type">spinlock_t</span> lock;<span class="comment">/* ä¸²å£ç«¯å£é” */</span></span><br><span class="line">unsignedint iobase;<span class="comment">/* IOç«¯å£åŸºåœ°å€ */</span></span><br><span class="line">unsignedchar __iomem *membase;<span class="comment">/* IOå†…å­˜åŸºåœ°å€,ç»æ˜ å°„(å¦‚ioremap)åçš„IOå†…å­˜è™šæ‹ŸåŸºåœ°å€ */</span></span><br><span class="line">unsignedint irq;<span class="comment">/* ä¸­æ–­å· */</span></span><br><span class="line">unsignedint uartclk;<span class="comment">/* ä¸²å£æ—¶é’Ÿ */</span></span><br><span class="line">unsignedint fifosize;<span class="comment">/* ä¸²å£FIFOç¼“å†²å¤§å° */</span></span><br><span class="line">unsignedchar x_char;<span class="comment">/* xon/xoffå­—ç¬¦ */</span></span><br><span class="line">unsignedchar regshift;<span class="comment">/* å¯„å­˜å™¨ä½ç§» */</span></span><br><span class="line">unsignedchar iotype;<span class="comment">/* IOè®¿é—®æ–¹å¼ */</span></span><br><span class="line">unsignedchar unused1;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPIO_PORT (0)<span class="comment">/* IOç«¯å£ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPIO_HUB6 (1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPIO_MEM (2)<span class="comment">/* IOå†…å­˜ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPIO_MEM32 (3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPIO_AU (4)<span class="comment">/* Au1x00 type IO */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPIO_TSI (5)<span class="comment">/* Tsi108/109 type IO */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPIO_DWAPB (6)<span class="comment">/* DesignWare APB UART */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPIO_RM9000 (7)<span class="comment">/* RM9000 type IO */</span></span></span><br><span class="line"></span><br><span class="line">unsignedint read_status_mask;<span class="comment">/* å…³å¿ƒçš„Rx error status */</span></span><br><span class="line">unsignedint ignore_status_mask;<span class="comment">/* å¿½ç•¥çš„Rx error status */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uart_info</span> *<span class="title">info</span>;</span>        <span class="comment">//é‡è¦ï¼Œè§ä¸‹é¢</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uart_icount</span>  <span class="title">icount</span>;</span>   <span class="comment">/* è®¡æ•°å™¨ uart_icountä¸ºä¸²å£ä¿¡æ¯è®¡æ•°å™¨ï¼ŒåŒ…å«äº†å‘é€å­—ç¬¦è®¡æ•°ã€æ¥æ”¶å­—ç¬¦è®¡æ•°ç­‰ã€‚åœ¨ä¸²å£çš„å‘é€ä¸­æ–­å¤„ç†å‡½æ•°å’Œæ¥æ”¶ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç®¡ç†è¿™äº›è®¡æ•°ã€‚*/</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">console</span> *<span class="title">cons</span>;</span><span class="comment">/* consoleç»“æ„ä½“ */</span></span><br><span class="line">#ifdefCONFIG_SERIAL_CORE_CONSOLE</span><br><span class="line">unsignedlong sysrq;<span class="comment">/* sysrq timeout */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">upf_t</span> flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPF_FOURPORT ((__forceupf_t)(1 &lt;&lt; 1))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SAK ((__forceupf_t)(1 &lt;&lt; 2))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SPD_MASK ((__forceupf_t)(0x1030))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SPD_HI ((__forceupf_t)(0x0010))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SPD_VHI ((__forceupf_t)(0x0020))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SPD_CUST ((__forceupf_t)(0x0030))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SPD_SHI ((__forceupf_t)(0x1000))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SPD_WARP ((__forceupf_t)(0x1010))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SKIP_TEST ((__forceupf_t)(1 &lt;&lt; 6))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_AUTO_IRQ ((__forceupf_t)(1 &lt;&lt; 7))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_HARDPPS_CD ((__forceupf_t)(1 &lt;&lt; 11))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_LOW_LATENCY ((__forceupf_t)(1 &lt;&lt; 13))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_BUGGY_UART ((__forceupf_t)(1 &lt;&lt; 14))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_MAGIC_MULTIPLIER((__force upf_t)(1 &lt;&lt; 16))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_CONS_FLOW ((__forceupf_t)(1 &lt;&lt; 23))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_SHARE_IRQ ((__forceupf_t)(1 &lt;&lt; 24))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_BOOT_AUTOCONF ((__forceupf_t)(1 &lt;&lt; 28))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_FIXED_PORT ((__forceupf_t)(1 &lt;&lt; 29))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_DEAD ((__forceupf_t)(1 &lt;&lt; 30))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_IOREMAP ((__forceupf_t)(1 &lt;&lt; 31))</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_CHANGE_MASK ((__forceupf_t)(0x17fff))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> UPF_USR_MASK ((__forceupf_t)(UPF_SPD_MASK|UPF_LOW_LATENCY))</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> mctrl;<span class="comment">/* å½“å‰çš„modenè®¾ç½® */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> timeout;<span class="comment">/* character-based timeout */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> type;<span class="comment">/* ç«¯å£ç±»å‹ */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">uart_ops</span> *<span class="title">ops</span>;</span><span class="comment">/* ä¸²å£ç«¯å£æ“ä½œå‡½æ•°é›† */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> custom_divisor;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  line;<span class="comment">/* ç«¯å£ç´¢å¼• */</span></span><br><span class="line">    <span class="type">resource_size_t</span> mapbase;<span class="comment">/* IOå†…å­˜ç‰©ç†åŸºåœ°å€ï¼Œå¯ç”¨äºioremap */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span><span class="comment">/* çˆ¶è®¾å¤‡ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> hub6;<span class="comment">/* this should be in the 8250 driver */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> suspended;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> unused[<span class="number">2</span>];</span><br><span class="line">    <span class="type">void</span>*private_data;<span class="comment">/* ç«¯å£ç§æœ‰æ•°æ®,ä¸€èˆ¬ä¸ºplatformæ•°æ®æŒ‡é’ˆ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SPIé©±åŠ¨</title>
      <link href="/2023/07/18/2023-7-18-SPI%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/18/2023-7-18-SPI%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-18%20202734.png"></p><h3 id="SPI-æ§åˆ¶å™¨é©±åŠ¨ç¨‹åº"><a href="#SPI-æ§åˆ¶å™¨é©±åŠ¨ç¨‹åº" class="headerlink" title="SPI æ§åˆ¶å™¨é©±åŠ¨ç¨‹åº"></a><strong>SPI æ§åˆ¶å™¨é©±åŠ¨ç¨‹åº</strong></h3><p><strong>SPI ä¸»æœºé©±åŠ¨å°±æ˜¯ SOC çš„ SPI æ§åˆ¶å™¨é©±åŠ¨ï¼Œ</strong>SPI æ§åˆ¶å™¨ä¸ç”¨å…³å¿ƒè®¾å¤‡çš„å…·ä½“åŠŸèƒ½ï¼Œå®ƒåªè´Ÿè´£æŠŠä¸Šå±‚åè®®é©±åŠ¨å‡†å¤‡å¥½çš„æ•°æ®æŒ‰ SPI æ€»çº¿çš„æ—¶åºè¦æ±‚å‘é€ç»™ SPI è®¾å¤‡ï¼ŒåŒæ—¶æŠŠä»è®¾å¤‡æ”¶åˆ°çš„æ•°æ®è¿”å›ç»™ä¸Šå±‚çš„åè®®é©±åŠ¨ï¼Œå› æ­¤ï¼Œå†…æ ¸æŠŠ SPI æ§åˆ¶å™¨çš„é©±åŠ¨ç¨‹åºç‹¬ç«‹å‡ºæ¥ã€‚</p><p>SPI æ§åˆ¶å™¨é©±åŠ¨è´Ÿè´£æ§åˆ¶å…·ä½“çš„æ§åˆ¶å™¨ç¡¬ä»¶ï¼Œè¯¸å¦‚ DMA å’Œä¸­æ–­æ“ä½œç­‰ç­‰ï¼Œå› ä¸ºå¤šä¸ªä¸Šå±‚çš„åè®®é©±åŠ¨å¯èƒ½ä¼šé€šè¿‡æ§åˆ¶å™¨è¯·æ±‚æ•°æ®ä¼ è¾“æ“ä½œï¼Œæ‰€ä»¥ï¼ŒSPI æ§åˆ¶å™¨é©±åŠ¨åŒæ—¶ä¹Ÿè¦è´Ÿè´£å¯¹è¿™äº›è¯·æ±‚è¿›è¡Œé˜Ÿåˆ—ç®¡ç†ï¼Œä¿è¯å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™ã€‚</p><ol><li><p>ç”³è¯·å¿…è¦çš„ç¡¬ä»¶èµ„æºï¼Œæ¯”å¦‚ä¸­æ–­ã€DMA é€šé“ã€DMA å†…å­˜ç¼“å†²åŒºç­‰ç­‰</p></li><li><p>é…ç½® SPI æ§åˆ¶å™¨çš„å·¥ä½œæ¨¡å¼å’Œå‚æ•°ï¼Œä½¿ä¹‹å¯ä»¥å’Œç›¸åº”çš„è®¾å¤‡è¿›è¡Œæ­£ç¡®çš„æ•°æ®äº¤æ¢</p></li><li><p>å‘é€šç”¨æ¥å£å±‚æä¾›æ¥å£ï¼Œä½¿å¾—ä¸Šå±‚çš„åè®®é©±åŠ¨å¯ä»¥é€šè¿‡é€šç”¨æ¥å£å±‚è®¿é—®æ§åˆ¶å™¨é©±åŠ¨</p></li><li><p>é…åˆé€šç”¨æ¥å£å±‚ï¼Œå®Œæˆæ•°æ®æ¶ˆæ¯é˜Ÿåˆ—çš„æ’é˜Ÿå’Œå¤„ç†ï¼Œç›´åˆ°æ¶ˆæ¯é˜Ÿåˆ—å˜ç©ºä¸ºæ­¢</p></li></ol><p><strong>SPI ä¸»æœºé©±åŠ¨çš„æ ¸å¿ƒå°±æ˜¯ç”³è¯· spi_masterï¼Œç„¶ååˆå§‹åŒ– spi_masterï¼Œæœ€åå‘ Linux å†…æ ¸æ³¨å†Œspi_masterã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spi_alloc_master å‡½æ•°ï¼šç”³è¯· spi_masterã€‚</span><br><span class="line">spi_master_put å‡½æ•°ï¼šé‡Šæ”¾ spi_masterã€‚</span><br><span class="line"></span><br><span class="line">spi_register_masterå‡½æ•°ï¼šæ³¨å†Œ spi_masterã€‚</span><br><span class="line">spi_unregister_master å‡½æ•°ï¼šæ³¨é”€ spi_masterã€‚</span><br><span class="line"></span><br><span class="line">spi_bitbang_startå‡½æ•°ï¼šæ³¨å†Œ spi_masterã€‚</span><br><span class="line">spi_bitbang_stop å‡½æ•°ï¼šæ³¨é”€ spi_master</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-18%20201838.png"></p><h3 id="SPI-é€šç”¨æ¥å£å°è£…å±‚"><a href="#SPI-é€šç”¨æ¥å£å°è£…å±‚" class="headerlink" title="SPI é€šç”¨æ¥å£å°è£…å±‚"></a><strong>SPI é€šç”¨æ¥å£å°è£…å±‚</strong></h3><p>ä¸ºäº†ç®€åŒ– SPI é©±åŠ¨ç¨‹åºçš„ç¼–ç¨‹å·¥ä½œï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†é™ä½ã€åè®®é©±åŠ¨ç¨‹åºã€‘å’Œã€æ§åˆ¶å™¨é©±åŠ¨ç¨‹åºã€‘çš„è€¦åˆç¨‹åº¦ï¼Œå†…æ ¸æŠŠæ§åˆ¶å™¨é©±åŠ¨å’Œåè®®é©±åŠ¨çš„ä¸€äº›é€šç”¨æ“ä½œå°è£…æˆæ ‡å‡†çš„æ¥å£ï¼ŒåŠ ä¸Šä¸€äº›é€šç”¨çš„é€»è¾‘å¤„ç†æ“ä½œï¼Œç»„æˆäº† SPI é€šç”¨æ¥å£å°è£…å±‚ã€‚</p><p>è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå¯¹äºæ§åˆ¶å™¨é©±åŠ¨ç¨‹åºï¼Œåªè¦å®ç°æ ‡å‡†çš„æ¥å£å›è°ƒ APIï¼Œå¹¶æŠŠå®ƒæ³¨å†Œåˆ°é€šç”¨æ¥å£å±‚å³å¯ï¼Œæ— éœ€ç›´æ¥å’Œåè®®å±‚é©±åŠ¨ç¨‹åºè¿›è¡Œäº¤äº’ã€‚è€Œå¯¹äºåè®®å±‚é©±åŠ¨æ¥è¯´ï¼Œåªéœ€é€šè¿‡é€šç”¨æ¥å£å±‚æä¾›çš„ API å³å¯å®Œæˆè®¾å¤‡å’Œé©±åŠ¨çš„æ³¨å†Œï¼Œå¹¶é€šè¿‡é€šç”¨æ¥å£å±‚çš„ API å®Œæˆæ•°æ®çš„ä¼ è¾“ï¼Œæ— éœ€å…³æ³¨ SPI æ§åˆ¶å™¨é©±åŠ¨çš„å®ç°ç»†èŠ‚ã€‚</p><ol><li><p>SPI é€šç”¨æ¥å£å±‚æŠŠå…·ä½“çš„ SPI è®¾å¤‡çš„åè®®é©±åŠ¨å’Œ SPI æ§åˆ¶å™¨é©±åŠ¨è¿æ¥åœ¨ä¸€èµ·ã€‚</p></li><li><p>è´Ÿè´£ SPI ç³»ç»Ÿä¸ Linux è®¾å¤‡æ¨¡å‹ç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œã€‚</p></li><li><p>ä¸ºåè®®é©±åŠ¨å’Œæ§åˆ¶å™¨é©±åŠ¨æä¾›ä¸€ç³»åˆ—çš„æ ‡å‡†æ¥å£ API åŠå…¶æ•°æ®ç»“æ„ã€‚</p></li><li><p>SPI è®¾å¤‡ã€SPI åè®®é©±åŠ¨ã€SPI æ§åˆ¶å™¨çš„æ•°æ®æŠ½è±¡</p></li><li><p>ååŠ©æ•°æ®ä¼ è¾“è€Œå®šä¹‰çš„æ•°æ®ç»“æ„</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é‡è¦æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span>//æè¿°ä¸€ä¸ª <span class="title">spi</span> ä»æœºè®¾å¤‡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span>//æè¿°ä¸€ä¸ª <span class="title">spi</span> è®¾å¤‡é©±åŠ¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_board_info</span>//æè¿°ä¸€ä¸ª <span class="title">spi</span> ä»æœºè®¾å¤‡æ¿çº§ä¿¡æ¯ï¼Œæ— è®¾å¤‡æ ‘æ—¶ä½¿ç”¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_controller</span>/<span class="title">spi_master</span>//æè¿°ä¸€ä¸ª <span class="title">spi</span> ä¸»æœºè®¾å¤‡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span>//æè¿° <span class="title">spi</span> ä¼ è¾“çš„å…·ä½“æ•°æ®</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span>//æè¿°ä¸€æ¬¡ <span class="title">spi</span> ä¼ è¾“çš„ä¿¡æ¯ï¼Œæ˜¯ä¸€æ¬¡ <span class="title">SPI</span> æ•°æ®äº¤æ¢çš„åŸå­æ“ä½œ</span></span><br><span class="line"><span class="class">//é‡è¦<span class="title">API</span></span></span><br><span class="line"><span class="class"><span class="title">spi_message_init</span></span></span><br><span class="line"><span class="class"><span class="title">spi_message_add_tail</span></span></span><br><span class="line"><span class="class"><span class="title">spi_sync</span></span></span><br><span class="line"><span class="class"><span class="title">spi_async</span></span></span><br><span class="line"><span class="class"><span class="title">spi_write</span></span></span><br><span class="line"><span class="class"><span class="title">spi_read</span></span></span><br></pre></td></tr></table></figure><h3 id="SPI-åè®®é©±åŠ¨ç¨‹åº"><a href="#SPI-åè®®é©±åŠ¨ç¨‹åº" class="headerlink" title="SPI åè®®é©±åŠ¨ç¨‹åº"></a><strong>SPI åè®®é©±åŠ¨ç¨‹åº</strong></h3><p>SPI è®¾å¤‡çš„å…·ä½“åŠŸèƒ½æ˜¯ç”± SPI åè®®é©±åŠ¨ç¨‹åºå®Œæˆçš„ï¼ŒSPI åè®®é©±åŠ¨ç¨‹åºäº†è§£è®¾å¤‡çš„åŠŸèƒ½å’Œé€šä¿¡æ•°æ®çš„åè®®æ ¼å¼ã€‚å‘ä¸‹ï¼Œåè®®é©±åŠ¨é€šè¿‡é€šç”¨æ¥å£å±‚å’Œæ§åˆ¶å™¨äº¤æ¢æ•°æ®ï¼Œå‘ä¸Šï¼Œåè®®é©±åŠ¨é€šå¸¸ä¼šæ ¹æ®è®¾å¤‡å…·ä½“çš„åŠŸèƒ½å’Œå†…æ ¸çš„å…¶å®ƒå­ç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚</p><p>ä¾‹å¦‚ï¼Œå’Œ MTD å±‚äº¤äº’ä»¥ä¾¿æŠŠ SPI æ¥å£çš„å­˜å‚¨è®¾å¤‡å®ç°ä¸ºæŸä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå’Œ TTY å­ç³»ç»Ÿäº¤äº’æŠŠ SPI è®¾å¤‡å®ç°ä¸ºä¸€ä¸ª TTY è®¾å¤‡ï¼Œå’Œç½‘ç»œå­ç³»ç»Ÿäº¤äº’ä»¥ä¾¿æŠŠä¸€ä¸ª SPI è®¾å¤‡å®ç°ä¸ºä¸€ä¸ªç½‘ç»œè®¾å¤‡ã€‚å¦‚æœæ˜¯ä¸€ä¸ªä¸“æœ‰çš„ SPI è®¾å¤‡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰è®¾å¤‡çš„åè®®è¦æ±‚ï¼Œå®ç°è‡ªå·±çš„ä¸“æœ‰åè®®é©±åŠ¨ã€‚</p><h3 id="SPI-é€šç”¨è®¾å¤‡é©±åŠ¨ç¨‹åº"><a href="#SPI-é€šç”¨è®¾å¤‡é©±åŠ¨ç¨‹åº" class="headerlink" title="SPI é€šç”¨è®¾å¤‡é©±åŠ¨ç¨‹åº"></a><strong>SPI é€šç”¨è®¾å¤‡é©±åŠ¨ç¨‹åº</strong></h3><p>è€ƒè™‘åˆ°è¿æ¥åœ¨ SPI æ§åˆ¶å™¨ä¸Šçš„è®¾å¤‡çš„å¯å˜æ€§ï¼Œåœ¨å†…æ ¸æ²¡æœ‰é…å¤‡ç›¸åº”çš„åè®®é©±åŠ¨ç¨‹åºï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œå†…æ ¸ä¸ºæˆ‘ä»¬å‡†å¤‡äº†é€šç”¨çš„ SPI è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œè¯¥é€šç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºå‘ç”¨æˆ·ç©ºé—´æä¾›äº†æ§åˆ¶ SPI æ§åˆ¶çš„æ§åˆ¶æ¥å£ï¼Œå…·ä½“çš„åè®®æ§åˆ¶å’Œæ•°æ®ä¼ è¾“å·¥ä½œäº¤ç”±ç”¨æˆ·ç©ºé—´æ ¹æ®å…·ä½“çš„è®¾å¤‡æ¥å®Œæˆï¼Œåœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œåªèƒ½é‡‡ç”¨åŒæ­¥çš„æ–¹å¼å’Œ SPI è®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥é€šå¸¸ç”¨äºä¸€äº›æ•°æ®é‡è¾ƒå°‘çš„ç®€å• SPI è®¾å¤‡ã€‚</p><p>åœ¨Linuxå†…æ ¸ä¸­spiçš„å‡½æ•°å­˜æ”¾ä½ç½®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kernel<span class="number">-4.15</span>/drivers/spi/spi.c  Linux æä¾›çš„é€šç”¨æ¥å£å°è£…å±‚é©±åŠ¨</span><br><span class="line">kernel<span class="number">-4.15</span>/drivers/spi/spidev.c  linux æä¾›çš„ SPI é€šç”¨è®¾å¤‡é©±åŠ¨ç¨‹åº</span><br><span class="line">kernel<span class="number">-4.15</span>/include/linux/spi/spi.h  linux æä¾›çš„åŒ…å« SPI çš„ä¸»è¦æ•°æ®ç»“æ„å’Œå‡½æ•°</span><br></pre></td></tr></table></figure><p><strong>SPI æ•°æ®ä¼ è¾“å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼ï¼šåŒæ­¥æ–¹å¼å’Œå¼‚æ­¥æ–¹å¼ã€‚</strong></p><p>åŒæ­¥æ–¹å¼ï¼šæ•°æ®ä¼ è¾“çš„å‘èµ·è€…å¿…é¡»ç­‰å¾…æœ¬æ¬¡ä¼ è¾“çš„ç»“æŸï¼ŒæœŸé—´ä¸èƒ½åšå…¶å®ƒäº‹æƒ…ï¼Œç”¨ä»£ç æ¥è§£é‡Šå°±æ˜¯ï¼Œè°ƒç”¨ä¼ è¾“çš„å‡½æ•°åï¼Œç›´åˆ°æ•°æ®ä¼ è¾“å®Œæˆï¼Œå‡½æ•°æ‰ä¼šè¿”å›ã€‚</p><p>å¼‚æ­¥æ–¹å¼ï¼šæ•°æ®ä¼ è¾“çš„å‘èµ·è€…æ— éœ€ç­‰å¾…ä¼ è¾“çš„ç»“æŸï¼Œæ•°æ®ä¼ è¾“æœŸé—´è¿˜å¯ä»¥åšå…¶å®ƒäº‹æƒ…ï¼Œç”¨ä»£ç æ¥è§£é‡Šå°±æ˜¯ï¼Œè°ƒç”¨ä¼ è¾“çš„å‡½æ•°åï¼Œå‡½æ•°ä¼šç«‹åˆ»è¿”å›è€Œä¸ç”¨ç­‰å¾…æ•°æ®ä¼ è¾“å®Œæˆï¼Œæˆ‘ä»¬åªéœ€è®¾ç½®ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä¼ è¾“å®Œæˆåï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨ä»¥é€šçŸ¥å‘èµ·è€…æ•°æ®ä¼ é€å·²ç»å®Œæˆã€‚</p><p>spi_asyncå‡½æ•°æ˜¯å‘èµ·ä¸€ä¸ªå¼‚æ­¥ä¼ è¾“çš„APIï¼Œå®ƒä¼šæŠŠspi_messageç»“æ„æŒ‚åœ¨spi_masterçš„queueå­—æ®µä¸‹ï¼Œç„¶åå¯åŠ¨ä¸“é—¨ä¸ºspiä¼ è¾“å‡†å¤‡çš„å†…æ ¸å·¥ä½œçº¿ç¨‹ï¼Œç”±è¯¥å·¥ä½œçº¿ç¨‹æ¥å®é™…å¤„ç†messageçš„ä¼ è¾“å·¥ä½œï¼Œå› ä¸ºæ˜¯å¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥è¯¥å‡½æ•°ä¼šç«‹åˆ»è¿”å›ï¼Œä¸ä¼šç­‰å¾…ä¼ è¾“çš„å®Œæˆï¼Œè¿™æ—¶ï¼Œåè®®é©±åŠ¨ç¨‹åºï¼ˆå¯èƒ½æ˜¯å¦ä¸€ä¸ªåè®®é©±åŠ¨ç¨‹åºï¼‰å¯ä»¥å†æ¬¡è°ƒç”¨è¯¥APIï¼Œå‘èµ·å¦ä¸€ä¸ªmessageä¼ è¾“è¯·æ±‚ï¼Œç»“æœå°±æ˜¯ï¼Œå½“å·¥ä½œçº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œspi_masterä¸‹é¢å¯èƒ½å·²ç»æŒ‚äº†å¤šä¸ªå¾…å¤„ç†çš„spi_messageç»“æ„ï¼Œå·¥ä½œçº¿ç¨‹ä¼šæŒ‰å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™æ¥é€ä¸ªå¤„ç†è¿™äº›messageè¯·æ±‚ï¼Œæ¯ä¸ªmessageä¼ é€å®Œæˆåï¼Œå¯¹åº”spi_messageç»“æ„çš„completeå›è°ƒå‡½æ•°å°±ä¼šè¢«è°ƒç”¨ï¼Œä»¥é€šçŸ¥åè®®é©±åŠ¨ç¨‹åºå‡†å¤‡ä¸‹ä¸€å¸§æ•°æ®ã€‚è¿™å°±æ˜¯spi_messageçš„é˜Ÿåˆ—åŒ–ã€‚å·¥ä½œçº¿ç¨‹å”¤é†’æ—¶ï¼Œspi_masterã€spi_messageå’Œspi_transferä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾æ¥æè¿°ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-18%20200811.png"></p><h3 id="SPIé©±åŠ¨ç»“æ„"><a href="#SPIé©±åŠ¨ç»“æ„" class="headerlink" title="SPIé©±åŠ¨ç»“æ„"></a>SPIé©±åŠ¨ç»“æ„</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-18%20204137.png"></p><p>spi_driver æ³¨å†Œç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* probe å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* å…·ä½“å‡½æ•°å†…å®¹ */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* remove å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_remove</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* å…·ä½“å‡½æ•°å†…å®¹ */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ä¼ ç»ŸåŒ¹é…æ–¹å¼ ID åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device_id</span> <span class="title">xxx_id</span>[] =</span> &#123;</span><br><span class="line">&#123;<span class="string">&quot;xxx&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* è®¾å¤‡æ ‘åŒ¹é…åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">xxx_of_match</span>[] =</span> &#123;</span><br><span class="line">&#123; .compatible = <span class="string">&quot;xxx&quot;</span> &#125;,</span><br><span class="line">&#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* SPI é©±åŠ¨ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> <span class="title">xxx_driver</span> =</span> &#123;</span><br><span class="line">.probe = xxx_probe,</span><br><span class="line">.remove = xxx_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.name = <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">.of_match_table = xxx_of_match,</span><br><span class="line">&#125;,</span><br><span class="line">.id_table = xxx_id,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> spi_register_driver(&amp;xxx_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">spi_unregister_driver(&amp;xxx_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_init(xxx_init);</span><br><span class="line">module_exit(xxx_exit);</span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡é©±åŠ¨çš„ç¼–å†™æµç¨‹"><a href="#è®¾å¤‡é©±åŠ¨çš„ç¼–å†™æµç¨‹" class="headerlink" title="è®¾å¤‡é©±åŠ¨çš„ç¼–å†™æµç¨‹"></a>è®¾å¤‡é©±åŠ¨çš„ç¼–å†™æµç¨‹</h3><p>SPIä½¿ç”¨çš„APIå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">603</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> &#123;</span></span><br><span class="line"><span class="number">604</span> <span class="comment">/* it&#x27;s ok if tx_buf == rx_buf (right?)</span></span><br><span class="line"><span class="comment">605 * for MicroWire, one buffer must be null</span></span><br><span class="line"><span class="comment">606 * buffers must work with dma_*map_single() calls, unless</span></span><br><span class="line"><span class="comment">607 * spi_message.is_dma_mapped reports a pre-existing mapping</span></span><br><span class="line"><span class="comment">608 */</span></span><br><span class="line"><span class="number">609</span> <span class="type">const</span> <span class="type">void</span> *tx_buf;<span class="comment">//å‘é€æ•°æ®</span></span><br><span class="line"><span class="number">610</span> <span class="type">void</span> *rx_buf;<span class="comment">//æ¥æ”¶æ•°æ®</span></span><br><span class="line"><span class="number">611</span> <span class="type">unsigned</span> len;<span class="comment">//len æ˜¯è¦è¿›è¡Œä¼ è¾“çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="number">612</span></span><br><span class="line"><span class="number">613</span> <span class="type">dma_addr_t</span> tx_dma;</span><br><span class="line"><span class="number">614</span> <span class="type">dma_addr_t</span> rx_dma;</span><br><span class="line"><span class="number">615</span> <span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> <span class="title">tx_sg</span>;</span></span><br><span class="line"><span class="number">616</span> <span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> <span class="title">rx_sg</span>;</span></span><br><span class="line"><span class="number">617</span></span><br><span class="line"><span class="number">618</span> <span class="type">unsigned</span> cs_change:<span class="number">1</span>;</span><br><span class="line"><span class="number">619</span> <span class="type">unsigned</span> tx_nbits:<span class="number">3</span>;</span><br><span class="line"><span class="number">620</span> <span class="type">unsigned</span> rx_nbits:<span class="number">3</span>;</span><br><span class="line"><span class="number">621</span> <span class="meta">#<span class="keyword">define</span> SPI_NBITS_SINGLE 0x01 <span class="comment">/* 1bit transfer */</span></span></span><br><span class="line"><span class="number">622</span> <span class="meta">#<span class="keyword">define</span> SPI_NBITS_DUAL 0x02 <span class="comment">/* 2bits transfer */</span></span></span><br><span class="line"><span class="number">623</span> <span class="meta">#<span class="keyword">define</span> SPI_NBITS_QUAD 0x04 <span class="comment">/* 4bits transfer */</span></span></span><br><span class="line"><span class="number">624</span> u8 bits_per_word;</span><br><span class="line"><span class="number">625</span> u16 delay_usecs;</span><br><span class="line"><span class="number">626</span> u32 speed_hz;</span><br><span class="line"><span class="number">627</span></span><br><span class="line"><span class="number">628</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">transfer_list</span>;</span></span><br><span class="line"><span class="number">629</span> &#125;;</span><br></pre></td></tr></table></figure><p>spi_transfer éœ€è¦ç»„ç»‡æˆ spi_messageï¼Œ spi_message ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> &#123;</span></span><br><span class="line"><span class="number">661</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">transfers</span>;</span></span><br><span class="line"><span class="number">662</span></span><br><span class="line"><span class="number">663</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span>;</span></span><br><span class="line"><span class="number">664</span></span><br><span class="line"><span class="number">665</span> <span class="type">unsigned</span> is_dma_mapped:<span class="number">1</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">678</span> <span class="comment">/* completion is reported through a callback */</span></span><br><span class="line"><span class="number">679</span> <span class="type">void</span> (*complete)(<span class="type">void</span> *context);</span><br><span class="line"><span class="number">680</span> <span class="type">void</span> *context;</span><br><span class="line"><span class="number">681</span> <span class="type">unsigned</span> frame_length;</span><br><span class="line"><span class="number">682</span> <span class="type">unsigned</span> actual_length;</span><br><span class="line"><span class="number">683</span> <span class="type">int</span> status;</span><br><span class="line"><span class="number">684</span></span><br><span class="line"><span class="number">685</span> <span class="comment">/* for optional use by whatever driver currently owns the</span></span><br><span class="line"><span class="comment">686 * spi_message ... between calls to spi_async and then later</span></span><br><span class="line"><span class="comment">687 * complete(), that&#x27;s the spi_master controller driver.</span></span><br><span class="line"><span class="comment">688 */</span></span><br><span class="line"><span class="number">689</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">queue</span>;</span></span><br><span class="line"><span class="number">690</span> <span class="type">void</span> *state;</span><br><span class="line"><span class="number">691</span> &#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨spi_messageä¹‹å‰éœ€è¦å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œ spi_messageåˆå§‹åŒ–å‡½æ•°ä¸ºspi_message_initï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">spi_message_init</span><span class="params">(<span class="keyword">struct</span> spi_message *m)</span></span><br><span class="line"><span class="comment">/*mï¼š è¦åˆå§‹åŒ–çš„ spi_messageã€‚</span></span><br><span class="line"><span class="comment">è¿”å›å€¼ï¼š æ— ã€‚*/</span></span><br></pre></td></tr></table></figure><p>spi_message åˆå§‹åŒ–å®Œæˆä»¥åéœ€è¦å°† spi_transfer æ·»åŠ åˆ° spi_message é˜Ÿåˆ—ä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬è¦ç”¨åˆ° spi_message_add_tail å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">spi_message_add_tail</span><span class="params">(<span class="keyword">struct</span> spi_transfer *t, <span class="keyword">struct</span> spi_message *m)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">tï¼š è¦æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„ spi_transferã€‚</span></span><br><span class="line"><span class="comment">mï¼š spi_transfer è¦åŠ å…¥çš„ spi_messageã€‚</span></span><br><span class="line"><span class="comment">è¿”å›å€¼ï¼š æ— ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>spi_message å‡†å¤‡å¥½ä»¥åå°±å¯ä»¥è¿›è¡Œæ•°æ®ä¼ è¾“äº†ï¼Œæ•°æ®ä¼ è¾“åˆ†ä¸ºåŒæ­¥ä¼ è¾“å’Œå¼‚æ­¥ä¼ è¾“ï¼Œ<strong>åŒæ­¥ä¼ è¾“ä¼šé˜»å¡çš„ç­‰å¾… SPI æ•°æ®ä¼ è¾“å®Œæˆ</strong>ï¼ŒåŒæ­¥ä¼ è¾“å‡½æ•°ä¸º spi_syncï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">spi_sync</span><span class="params">(<span class="keyword">struct</span> spi_device *spi, <span class="keyword">struct</span> spi_message *message)</span></span><br><span class="line"><span class="comment">/*spiï¼š è¦è¿›è¡Œæ•°æ®ä¼ è¾“çš„ spi_deviceã€‚</span></span><br><span class="line"><span class="comment">messageï¼šè¦ä¼ è¾“çš„ spi_messageã€‚</span></span><br><span class="line"><span class="comment">è¿”å›å€¼ï¼š æ— ã€‚*/</span></span><br></pre></td></tr></table></figure><p><strong>å¼‚æ­¥ä¼ è¾“ä¸ä¼šé˜»å¡çš„ç­‰åˆ° SPI æ•°æ®ä¼ è¾“å®Œæˆ</strong>ï¼Œå¼‚æ­¥ä¼ è¾“éœ€è¦è®¾ç½® spi_message ä¸­çš„ completeæˆå‘˜å˜é‡ï¼Œ complete æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ SPI å¼‚æ­¥ä¼ è¾“å®Œæˆä»¥åæ­¤å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚ SPI å¼‚æ­¥ä¼ è¾“å‡½æ•°ä¸º spi_asyncã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">spi_async</span><span class="params">(<span class="keyword">struct</span> spi_device *spi, <span class="keyword">struct</span> spi_message *message)</span></span><br><span class="line"><span class="comment">/*spiï¼š è¦è¿›è¡Œæ•°æ®ä¼ è¾“çš„ spi_deviceã€‚</span></span><br><span class="line"><span class="comment">messageï¼šè¦ä¼ è¾“çš„ spi_messageã€‚</span></span><br><span class="line"><span class="comment">è¿”å›å€¼ï¼š æ— ã€‚ */</span></span><br></pre></td></tr></table></figure><p>åŒæ­¥ä¼ è¾“é€šè¿‡ SPI è¿›è¡Œ n ä¸ªå­—èŠ‚çš„æ•°æ®å‘é€å’Œæ¥æ”¶çš„ç¤ºä¾‹ä»£ç  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPI å¤šå­—èŠ‚å‘é€ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spi_send</span><span class="params">(<span class="keyword">struct</span> spi_device *spi, u8 *buf, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">m</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> <span class="title">t</span> =</span> &#123;</span><br><span class="line">.tx_buf = buf,</span><br><span class="line">.len = len,</span><br><span class="line">&#125;;</span><br><span class="line">spi_message_init(&amp;m); <span class="comment">/* åˆå§‹åŒ– spi_message */</span></span><br><span class="line">spi_message_add_tail(t, &amp;m);<span class="comment">/* å°† spi_transfer æ·»åŠ åˆ° spi_message é˜Ÿåˆ— */</span></span><br><span class="line">ret = spi_sync(spi, &amp;m); <span class="comment">/* åŒæ­¥ä¼ è¾“ */</span></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* SPI å¤šå­—èŠ‚æ¥æ”¶ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spi_receive</span><span class="params">(<span class="keyword">struct</span> spi_device *spi, u8 *buf, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">m</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> <span class="title">t</span> =</span> &#123;</span><br><span class="line">.rx_buf = buf,</span><br><span class="line">.len = len,</span><br><span class="line">&#125;;</span><br><span class="line">spi_message_init(&amp;m); <span class="comment">/* åˆå§‹åŒ– spi_message */</span></span><br><span class="line">spi_message_add_tail(t, &amp;m);<span class="comment">/* å°† spi_transfer æ·»åŠ åˆ° spi_message é˜Ÿåˆ— */</span></span><br><span class="line">ret = spi_sync(spi, &amp;m); <span class="comment">/* åŒæ­¥ä¼ è¾“ */</span></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxä¸‹çš„IIC</title>
      <link href="/2023/07/18/2023-7-18-linux%E4%B8%8B%E7%9A%84IIC/"/>
      <url>/2023/07/18/2023-7-18-linux%E4%B8%8B%E7%9A%84IIC/</url>
      
        <content type="html"><![CDATA[<h1 id="linuxçš„IICä½“ç³»ç»“æ„"><a href="#linuxçš„IICä½“ç³»ç»“æ„" class="headerlink" title="linuxçš„IICä½“ç³»ç»“æ„"></a>linuxçš„IICä½“ç³»ç»“æ„</h1><p>Linuxçš„IICä½“ç³»ç»“æ„åˆ†ä¸º3ä¸ªç»„æˆéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯IICæ ¸å¿ƒã€IICæ€»çº¿é©±åŠ¨å’ŒIICè®¾å¤‡é©±åŠ¨ï¼</p><p>ï¼ˆ1ï¼‰IICæ ¸å¿ƒ</p><p>æä¾›äº†IICæ€»çº¿é©±åŠ¨ä¸IICè®¾å¤‡é©±åŠ¨çš„æ³¨å†Œã€æ³¨é”€æ–¹æ³•å’Œä¸å…·ä½“IICæ§åˆ¶å™¨æ— å…³çš„ä»£ç ï¼Œè¯¥éƒ¨åˆ†ç”¨æ¥ç®¡ç†IICæ€»çº¿é©±åŠ¨ä¸IICè®¾å¤‡é©±åŠ¨ã€‚</p><p>ï¼ˆ2ï¼‰IICæ€»çº¿é©±åŠ¨</p><p>IICæ€»çº¿é©±åŠ¨æ˜¯é€‚é…å™¨ï¼ˆIICæ§åˆ¶å™¨ï¼‰çš„é©±åŠ¨ç¨‹åºï¼ŒåŒ…å«äº†é€‚é…å™¨ï¼ˆIICæ§åˆ¶å™¨ï¼‰çš„æ•°æ®æè¿°ç»“æ„i2c_adapterã€é€šä¿¡æ–¹æ³•æ•°æ®ç»“æ„i2c_algorithmã€æ§åˆ¶é€‚é…å™¨äº§ç”Ÿé€šä¿¡æ—¶åºçš„å‡½æ•°ã€‚</p><p>ï¼ˆ3ï¼‰IICè®¾å¤‡é©±åŠ¨</p><p>æ˜¯å…·ä½“IICè®¾å¤‡çš„é©±åŠ¨ï¼Œå› ä¸ºä¸åŒçš„IICè®¾å¤‡å¯èƒ½æœ‰ä¸åŒçš„è¯»å†™æ—¶åºè¦æ±‚ï¼Œæ¯”å¦‚at24cxxè¯»å†™éœ€è¦å‘é€16ä½åœ°å€ï¼Œè€Œtmp75åªéœ€è¦8ä½åœ°å€å³å¯ã€‚IICè®¾å¤‡é©±åŠ¨é€šè¿‡i2c_algorithmé€šä¿¡æ–¹æ³•é©±åŠ¨é€‚é…å™¨é©±åŠ¨ç¨‹åºå»è®¿é—®å…·ä½“çš„IICè®¾å¤‡ã€‚</p><p>ä½“ç³»ç»“æ„</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-19%20205901.png"></p><h2 id="æ¶æ„å±‚æ¬¡åˆ†ç±»"><a href="#æ¶æ„å±‚æ¬¡åˆ†ç±»" class="headerlink" title="æ¶æ„å±‚æ¬¡åˆ†ç±»"></a>æ¶æ„å±‚æ¬¡åˆ†ç±»</h2><p>ã€€ã€€<strong>ç¬¬ä¸€å±‚</strong>ï¼šæä¾›i2c adapterçš„ç¡¬ä»¶é©±åŠ¨ï¼Œæ¢æµ‹ã€åˆå§‹åŒ–i2c adapterï¼ˆå¦‚ç”³è¯·i2cçš„ioåœ°å€å’Œä¸­æ–­å·ï¼‰ï¼Œé©±åŠ¨socæ§åˆ¶çš„i2c adapteråœ¨ç¡¬ä»¶ä¸Šäº§ç”Ÿä¿¡å·ï¼ˆstartã€stopã€ackï¼‰ä»¥åŠå¤„ç†i2cä¸­æ–­ã€‚å›¾ä¸­çš„ç¡¬ä»¶å®ç°æ§åˆ¶å±‚ã€‚</p><p>ã€€ã€€<strong>ç¬¬äºŒå±‚ï¼š</strong>æä¾›i2c adapterçš„algorithmï¼Œç”¨å…·ä½“é€‚é…å™¨çš„xxx_xfer()å‡½æ•°æ¥å¡«å……i2c_algorithmçš„master_xferå‡½æ•°æŒ‡é’ˆï¼Œå¹¶æŠŠèµ‹å€¼åçš„i2c_algorithmå†èµ‹å€¼ç»™i2c_adapterçš„algoæŒ‡é’ˆã€‚å›¾ä¸­çš„è®¿é—®æŠ½è±¡å±‚ã€‚</p><p>ã€€ã€€<strong>ç¬¬ä¸‰å±‚ï¼š</strong>å®ç°i2cè®¾å¤‡é©±åŠ¨ä¸­çš„i2c_driveræ¥å£ï¼Œç”¨å…·ä½“çš„i2c deviceè®¾å¤‡çš„probe()ã€remove()æ–¹æ³•èµ‹å€¼ç»™i2c_driverçš„æˆå‘˜å‡½æ•°æŒ‡é’ˆã€‚å®ç°è®¾å¤‡deviceä¸æ€»çº¿ï¼ˆæˆ–è€…å«adapterï¼‰çš„åŒ¹é…æŒ‚æ¥ã€‚å›¾ä¸­çš„driveré©±åŠ¨å±‚ã€‚</p><p>ã€€ã€€<strong>ç¬¬å››å±‚ï¼š</strong>å®ç°i2cè®¾å¤‡æ‰€å¯¹åº”çš„å…·ä½“deviceçš„é©±åŠ¨ï¼Œi2c_driveråªæ˜¯å®ç°è®¾å¤‡ä¸æ€»çº¿çš„æŒ‚æ¥ï¼Œè€ŒæŒ‚æ¥åœ¨æ€»çº¿ä¸Šçš„è®¾å¤‡åˆ™æ˜¯åƒå·®ä¸‡åˆ«çš„ï¼Œæ‰€ä»¥è¦å®ç°å…·ä½“è®¾å¤‡deviceçš„write()ã€read()ã€ioctl()ç­‰æ–¹æ³•ï¼Œèµ‹å€¼ç»™file_operationsï¼Œç„¶åæ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼ˆå¤šæ•°æ˜¯å­—ç¬¦è®¾å¤‡ï¼‰ã€‚ä¹Ÿæ˜¯å›¾ä¸­çš„driveré©±åŠ¨å±‚ã€‚</p><p>â€‹       <strong>ç¬¬ä¸€å±‚å’Œç¬¬äºŒå±‚å±äºi2cæ€»çº¿é©±åŠ¨(bus)ï¼ˆèŠ¯ç‰‡å‚å•†å†™ï¼‰ï¼Œç¬¬ä¸‰ç¬¬å››å±äºi2cè®¾å¤‡é©±åŠ¨(device driver)ï¼ˆé©±åŠ¨å·¥ç¨‹å¸ˆæ¥å†™ï¼‰ã€‚</strong></p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IICé©±åŠ¨</title>
      <link href="/2023/07/14/2023-7-14-IIC%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/14/2023-7-14-IIC%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="IICé©±åŠ¨æ¡†æ¶"><a href="#IICé©±åŠ¨æ¡†æ¶" class="headerlink" title="IICé©±åŠ¨æ¡†æ¶"></a>IICé©±åŠ¨æ¡†æ¶</h3><p>Linuxå†…æ ¸å°† I2C é©±åŠ¨åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š<br>â‘ ã€ I2C æ€»çº¿é©±åŠ¨ï¼Œ I2C æ€»çº¿é©±åŠ¨å°±æ˜¯ SOC çš„ I2C æ§åˆ¶å™¨é©±åŠ¨ï¼Œä¹Ÿå«åš I2C é€‚é…å™¨é©±åŠ¨ã€‚<br>â‘¡ã€ I2C è®¾å¤‡é©±åŠ¨ï¼Œ I2C è®¾å¤‡é©±åŠ¨å°±æ˜¯é’ˆå¯¹å…·ä½“çš„ I2C è®¾å¤‡è€Œç¼–å†™çš„é©±åŠ¨ã€‚ </p><p>IICé©±åŠ¨ä¹Ÿæ˜¯å€Ÿç”¨platformæ€æƒ³ï¼Œå°†è®¾å¤‡å’Œæ€»çº¿è¿›è¡Œåˆ†ç¦»ï¼Œä½†æ˜¯IICæœ‰è‡ªå·±çš„æ€»çº¿ï¼Œæ‰€ä»¥å°±ä¸ç”¨ä½¿ç”¨è™šæ‹Ÿæ€»çº¿ã€‚</p><p>I2C æ€»çº¿é©±åŠ¨é‡ç‚¹æ˜¯ I2C é€‚é…å™¨(ä¹Ÿå°±æ˜¯ SOC çš„ I2C æ¥å£æ§åˆ¶å™¨)é©±åŠ¨ï¼Œè¿™é‡Œè¦ç”¨åˆ°ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ï¼š i2c_adapter å’Œ i2c_algorithmï¼Œ Linux å†…æ ¸å°† SOC çš„ I2C é€‚é…å™¨(æ§åˆ¶å™¨)æŠ½è±¡æˆ i2c_adapterï¼Œ i2c_adapter ç»“æ„ä½“å®šä¹‰åœ¨ include&#x2F;linux&#x2F;i2c.h æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">498</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter</span> &#123;</span></span><br><span class="line"><span class="number">499</span> <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="number">500</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="class"><span class="keyword">class</span>;</span> <span class="comment">/* classes to allow probing for */</span></span><br><span class="line"><span class="number">501</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_algorithm</span> *<span class="title">algo</span>;</span> <span class="comment">/* æ€»çº¿è®¿é—®ç®—æ³• */</span></span><br><span class="line"><span class="number">502</span> <span class="type">void</span> *algo_data;</span><br><span class="line"><span class="number">503</span></span><br><span class="line"><span class="number">504</span> <span class="comment">/* data fields that are valid for all devices */</span></span><br><span class="line"><span class="number">505</span> <span class="class"><span class="keyword">struct</span> <span class="title">rt_mutex</span> <span class="title">bus_lock</span>;</span></span><br><span class="line"><span class="number">506</span></span><br><span class="line"><span class="number">507</span> <span class="type">int</span> timeout; <span class="comment">/* in jiffies */</span></span><br><span class="line"><span class="number">508</span> <span class="type">int</span> retries;</span><br><span class="line"><span class="number">509</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span> <span class="comment">/* the adapter device */</span></span><br><span class="line"><span class="number">510</span></span><br><span class="line"><span class="number">511</span> <span class="type">int</span> nr;</span><br><span class="line"><span class="number">512</span> <span class="type">char</span> name[<span class="number">48</span>];</span><br><span class="line"><span class="number">513</span> <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> <span class="title">dev_released</span>;</span></span><br><span class="line"><span class="number">514</span></span><br><span class="line"><span class="number">515</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">userspace_clients_lock</span>;</span></span><br><span class="line"><span class="number">516</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">userspace_clients</span>;</span></span><br><span class="line"><span class="number">517</span></span><br><span class="line"><span class="number">518</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_bus_recovery_info</span> *<span class="title">bus_recovery_info</span>;</span></span><br><span class="line"><span class="number">519</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter_quirks</span> *<span class="title">quirks</span>;</span></span><br><span class="line"><span class="number">520</span> &#125;;</span><br></pre></td></tr></table></figure><p> i2c_algorithm å°±æ˜¯ I2C é€‚é…å™¨ä¸ IIC è®¾å¤‡è¿›è¡Œé€šä¿¡çš„æ–¹æ³•ã€‚i2c_algorithm ç»“æ„ä½“å®šä¹‰åœ¨ include&#x2F;linux&#x2F;i2c.h æ–‡ä»¶ä¸­ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">391</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_algorithm</span> &#123;</span></span><br><span class="line">......</span><br><span class="line"><span class="number">398</span> <span class="type">int</span> (*master_xfer)(<span class="keyword">struct</span> i2c_adapter *adap,<span class="keyword">struct</span> i2c_msg *msgs,<span class="type">int</span> num);</span><br><span class="line"><span class="number">399</span> <span class="comment">//master_xfer å°±æ˜¯ I2C é€‚é…å™¨çš„ä¼ è¾“å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡æ­¤å‡½æ•°æ¥å®Œæˆä¸ IIC è®¾å¤‡ä¹‹é—´çš„é€šä¿¡ã€‚</span></span><br><span class="line"><span class="number">400</span> <span class="type">int</span> (*smbus_xfer) (<span class="keyword">struct</span> i2c_adapter *adap, u16 addr,<span class="type">unsigned</span> <span class="type">short</span> flags, <span class="type">char</span> read_write,</span><br><span class="line"><span class="number">401</span> u8 command, <span class="type">int</span> size, <span class="keyword">union</span> i2c_smbus_data *data);</span><br><span class="line"><span class="number">402</span> <span class="comment">//smbus_xfer å°±æ˜¯ SMBUS æ€»çº¿çš„ä¼ è¾“å‡½æ•°</span></span><br><span class="line"><span class="number">403</span></span><br><span class="line"><span class="number">404</span> <span class="comment">/* To determine what the adapter supports */</span></span><br><span class="line"><span class="number">405</span> u32 (*functionality) (<span class="keyword">struct</span> i2c_adapter *);</span><br><span class="line">......</span><br><span class="line"><span class="number">411</span> &#125;;</span><br></pre></td></tr></table></figure><p><strong>I2C æ€»çº¿é©±åŠ¨ï¼Œæˆ–è€…è¯´ I2C é€‚é…å™¨é©±åŠ¨çš„ä¸»è¦å·¥ä½œå°±æ˜¯åˆå§‹åŒ– i2c_adapter ç»“æ„ä½“å˜é‡ï¼Œç„¶åè®¾ç½® i2c_algorithm ä¸­çš„ master_xfer å‡½æ•°ã€‚å®Œæˆä»¥åé€šè¿‡ i2c_add_numbered_adapteræˆ– i2c_add_adapter è¿™ä¸¤ä¸ªå‡½æ•°å‘ç³»ç»Ÿæ³¨å†Œè®¾ç½®å¥½çš„ i2c_adapter</strong>ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adapter)</span><span class="comment">//ä½¿ç”¨åŠ¨æ€çš„æ€»çº¿å·</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_numbered_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap)</span> <span class="comment">//ä½¿ç”¨é™æ€çš„æ€»çº¿å·</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">i2c_del_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter * adap)</span><span class="comment">//åˆ é™¤ I2C é€‚é…å™¨</span></span><br></pre></td></tr></table></figure><h3 id="I2C-è®¾å¤‡é©±åŠ¨"><a href="#I2C-è®¾å¤‡é©±åŠ¨" class="headerlink" title="I2C è®¾å¤‡é©±åŠ¨"></a>I2C è®¾å¤‡é©±åŠ¨</h3><p>I2C æå†™è®¾å¤‡é©±åŠ¨ï¼Œç±»ä¼¼platformï¼Œåˆ†ä¸ºæè¿°è®¾å¤‡çš„i2c_clientå’Œæè¿°é©±åŠ¨å†…å®¹çš„i2c_driver</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">217</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> &#123;</span></span><br><span class="line"><span class="number">218</span> <span class="type">unsigned</span> <span class="type">short</span> flags; <span class="comment">/* æ ‡å¿— */</span></span><br><span class="line"><span class="number">219</span> <span class="type">unsigned</span> <span class="type">short</span> addr; <span class="comment">/* èŠ¯ç‰‡åœ°å€ï¼Œ 7 ä½ï¼Œå­˜åœ¨ä½ 7 ä½*/</span></span><br><span class="line">......</span><br><span class="line"><span class="number">222</span> <span class="type">char</span> name[I2C_NAME_SIZE]; <span class="comment">/* åå­— */</span></span><br><span class="line"><span class="number">223</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter</span> *<span class="title">adapter</span>;</span> <span class="comment">/* å¯¹åº”çš„ I2C é€‚é…å™¨ */</span></span><br><span class="line"><span class="number">224</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span> <span class="comment">/* è®¾å¤‡ç»“æ„ä½“ */</span></span><br><span class="line"><span class="number">225</span> <span class="type">int</span> irq; <span class="comment">/* ä¸­æ–­ */</span></span><br><span class="line"><span class="number">226</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">detected</span>;</span></span><br><span class="line">......</span><br><span class="line"><span class="number">230</span> &#125;;</span><br><span class="line"><span class="comment">//ä¸€ä¸ªè®¾å¤‡å¯¹åº”ä¸€ä¸ª i2c_clientï¼Œæ¯æ£€æµ‹åˆ°ä¸€ä¸ª I2C è®¾å¤‡å°±ä¼šç»™è¿™ä¸ª I2C è®¾å¤‡åˆ†é…ä¸€ä¸ªi2c_clientã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="number">161</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> &#123;</span></span><br><span class="line"><span class="number">162</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="class"><span class="keyword">class</span>;</span></span><br><span class="line"><span class="number">163</span></span><br><span class="line"><span class="number">164</span> <span class="comment">/* Notifies the driver that a new bus has appeared. You should</span></span><br><span class="line"><span class="comment">165 * avoid using this, it will be removed in a near future.</span></span><br><span class="line"><span class="comment">166 */</span></span><br><span class="line"><span class="number">167</span> <span class="type">int</span> (*attach_adapter)(<span class="keyword">struct</span> i2c_adapter *) __deprecated;</span><br><span class="line"><span class="number">168</span></span><br><span class="line"><span class="number">169</span> <span class="comment">/* Standard driver model interfaces */</span></span><br><span class="line"><span class="number">170</span> <span class="type">int</span> (*probe)(<span class="keyword">struct</span> i2c_client *, <span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *);<span class="comment">//å½“ I2C è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…æˆåŠŸä»¥å probe å‡½æ•°å°±ä¼šæ‰§è¡Œ</span></span><br><span class="line"><span class="number">171</span> <span class="type">int</span> (*remove)(<span class="keyword">struct</span> i2c_client *);</span><br><span class="line"><span class="number">172</span></span><br><span class="line"><span class="number">173</span> <span class="comment">/* driver model interfaces that don&#x27;t relate to enumeration */</span></span><br><span class="line"><span class="number">174</span> <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> i2c_client *);</span><br><span class="line"><span class="number">175</span></span><br><span class="line"><span class="number">176</span> <span class="comment">/* Alert callback, for example for the SMBus alert protocol.</span></span><br><span class="line"><span class="comment">177 * The format and meaning of the data value depends on the</span></span><br><span class="line"><span class="comment">178 * protocol.For the SMBus alert protocol, there is a single bit</span></span><br><span class="line"><span class="comment">179 * of data passed as the alert response&#x27;s low bit (&quot;event</span></span><br><span class="line"><span class="comment">180 flag&quot;). */</span></span><br><span class="line"><span class="number">181</span> <span class="type">void</span> (*alert)(<span class="keyword">struct</span> i2c_client *, <span class="type">unsigned</span> <span class="type">int</span> data);</span><br><span class="line"><span class="number">182</span></span><br><span class="line"><span class="number">183</span> <span class="comment">/* a ioctl like command that can be used to perform specific</span></span><br><span class="line"><span class="comment">184 * functions with the device.</span></span><br><span class="line"><span class="comment">185 */</span></span><br><span class="line"><span class="number">186</span> <span class="type">int</span> (*command)(<span class="keyword">struct</span> i2c_client *client, <span class="type">unsigned</span> <span class="type">int</span> cmd,<span class="type">void</span> *arg);</span><br><span class="line"><span class="number">187</span></span><br><span class="line"><span class="number">188</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> <span class="title">driver</span>;</span><span class="comment">//ä½¿ç”¨è®¾å¤‡æ ‘éœ€è¦è®¾ç½® device_driver çš„of_match_table æˆå‘˜å˜é‡</span></span><br><span class="line"><span class="number">189</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> *<span class="title">id_table</span>;</span><span class="comment">//id_table æ˜¯ä¼ ç»Ÿçš„ã€æœªä½¿ç”¨è®¾å¤‡æ ‘çš„è®¾å¤‡åŒ¹é… ID è¡¨</span></span><br><span class="line"><span class="number">190</span></span><br><span class="line"><span class="number">191</span> <span class="comment">/* Device detection callback for automatic device creation */</span></span><br><span class="line"><span class="number">192</span> <span class="type">int</span> (*detect)(<span class="keyword">struct</span> i2c_client *, <span class="keyword">struct</span> i2c_board_info *);</span><br><span class="line"><span class="number">193</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> *address_list;</span><br><span class="line"><span class="number">194</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">clients</span>;</span></span><br><span class="line"><span class="number">195</span> &#125;;</span><br></pre></td></tr></table></figure><p>i2c_driver çš„æ³¨å†Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* i2c é©±åŠ¨çš„ probe å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_probe</span><span class="params">(<span class="keyword">struct</span> i2c_client *client,<span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* å‡½æ•°å…·ä½“ç¨‹åº */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* i2c é©±åŠ¨çš„ remove å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_remove</span><span class="params">(<span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* å‡½æ•°å…·ä½“ç¨‹åº */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä¼ ç»ŸåŒ¹é…æ–¹å¼ ID åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">xxx_id</span>[] =</span> &#123;</span><br><span class="line">&#123;<span class="string">&quot;xxx&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;&#125;<span class="comment">//ç©º</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾å¤‡æ ‘åŒ¹é…åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">xxx_of_match</span>[] =</span> &#123;</span><br><span class="line">&#123; .compatible = <span class="string">&quot;xxx&quot;</span> &#125;,</span><br><span class="line">&#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* i2c é©±åŠ¨ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">xxx_driver</span> =</span> &#123;</span><br><span class="line">.probe = xxx_probe,</span><br><span class="line">.remove = xxx_remove,</span><br><span class="line">.driver = &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.name = <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">.of_match_table = xxx_of_match,</span><br><span class="line">&#125;,</span><br><span class="line"> .id_table = xxx_id,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">ret = i2c_add_driver(&amp;xxx_driver);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">i2c_del_driver(&amp;xxx_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(xxx_init);</span><br><span class="line">module_exit(xxx_exit);</span><br></pre></td></tr></table></figure><h3 id="I2C-è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹"><a href="#I2C-è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹" class="headerlink" title="I2C è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹"></a>I2C è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹</h3><p>I2C è®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…è¿‡ç¨‹æ˜¯ç”± I2C æ ¸å¿ƒæ¥å®Œæˆçš„ï¼Œ drivers&#x2F;i2c&#x2F;i2c-core.c å°±æ˜¯ I2C çš„æ ¸å¿ƒ<br>éƒ¨åˆ†ï¼Œ I2C æ ¸å¿ƒæä¾›äº†ä¸€äº›ä¸å…·ä½“ç¡¬ä»¶æ— å…³çš„ API å‡½æ•°ï¼Œæ¯”å¦‚å‰é¢è®²è¿‡çš„ï¼š</p><p>i2c_adapter æ³¨å†Œ&#x2F;æ³¨é”€å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adapter)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_numbered_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">i2c_del_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter * adap)</span></span><br></pre></td></tr></table></figure><p>i2c_driver æ³¨å†Œ&#x2F;æ³¨é”€å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">i2c_register_driver</span><span class="params">(<span class="keyword">struct</span> module *owner, <span class="keyword">struct</span> i2c_driver *driver)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_driver</span> <span class="params">(<span class="keyword">struct</span> i2c_driver *driver)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">i2c_del_driver</span><span class="params">(<span class="keyword">struct</span> i2c_driver *driver)</span></span><br></pre></td></tr></table></figure><p>è®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…è¿‡ç¨‹ä¹Ÿæ˜¯ç”± I2C æ€»çº¿å®Œæˆçš„ï¼Œ </p><p>I2C æ€»çº¿çš„æ•°æ®ç»“æ„ä¸º i2c_bus_typeï¼Œå®šä¹‰åœ¨ drivers&#x2F;i2c&#x2F;i2c-core.c æ–‡ä»¶ï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> <span class="title">i2c_bus_type</span> =</span> &#123;</span><br><span class="line">.name = <span class="string">&quot;i2c&quot;</span>,</span><br><span class="line">.match = i2c_device_match,</span><br><span class="line">.probe = i2c_device_probe,</span><br><span class="line">.remove = i2c_device_remove,</span><br><span class="line">.shutdown = i2c_device_shutdown,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>I2C æ€»çº¿çš„è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…å‡½æ•°ï¼Œåœ¨è¿™é‡Œå°±æ˜¯ i2c_device_match è¿™ä¸ªå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">457</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_device_match</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</span></span><br><span class="line">458 &#123;</span><br><span class="line"><span class="number">459</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> i2c_verify_client(dev);</span><br><span class="line"><span class="number">460</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line"><span class="number">461</span></span><br><span class="line"><span class="number">462</span> <span class="keyword">if</span> (!client)</span><br><span class="line"><span class="number">463</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">464</span></span><br><span class="line"><span class="number">465</span> <span class="comment">/* Attempt an OF style match */</span></span><br><span class="line"><span class="number">466</span> <span class="keyword">if</span> (of_driver_match_device(dev, drv))</span><br><span class="line"><span class="number">467</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="number">468</span></span><br><span class="line"><span class="number">469</span> <span class="comment">/* Then ACPI style match */</span></span><br><span class="line"><span class="number">470</span> <span class="keyword">if</span> (acpi_driver_match_device(dev, drv))</span><br><span class="line"><span class="number">471</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="number">472</span></span><br><span class="line"><span class="number">473</span> driver = to_i2c_driver(drv);</span><br><span class="line"><span class="number">474</span> <span class="comment">/* match on an id table if there is one */</span></span><br><span class="line"><span class="number">475</span> <span class="keyword">if</span> (driver-&gt;id_table)</span><br><span class="line"><span class="number">476</span> <span class="keyword">return</span> i2c_match_id(driver-&gt;id_table, client) != <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">477</span></span><br><span class="line"><span class="number">478</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">479</span> &#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æé©±åŠ¨æµç¨‹"><a href="#åˆ†æé©±åŠ¨æµç¨‹" class="headerlink" title="åˆ†æé©±åŠ¨æµç¨‹"></a>åˆ†æé©±åŠ¨æµç¨‹</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-14%20191536.png"></p><p>å½“è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…æˆåŠŸä»¥å i2c_imx_probe å‡½æ•°å°±ä¼šæ‰§è¡Œ ï¼Œç”±æ­¤åˆ†æi2c_imx_probeçš„æ‰§è¡Œå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">971</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_imx_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">972 &#123;</span><br><span class="line"><span class="number">973</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">of_id</span> =</span></span><br><span class="line"><span class="number">974</span> of_match_device(i2c_imx_dt_ids, &amp;pdev-&gt;dev);</span><br><span class="line"><span class="number">975</span> <span class="class"><span class="keyword">struct</span> <span class="title">imx_i2c_struct</span> *<span class="title">i2c_imx</span>;</span></span><br><span class="line"><span class="number">976</span> <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span></span><br><span class="line"><span class="number">977</span> <span class="class"><span class="keyword">struct</span> <span class="title">imxi2c_platform_data</span> *<span class="title">pdata</span> =</span> dev_get_platdata(&amp;pdev-&gt;dev);<span class="comment">//è·å–æˆå‘˜å˜é‡</span></span><br><span class="line"><span class="number">978</span> <span class="type">void</span> __iomem *base;</span><br><span class="line"><span class="number">979</span> <span class="type">int</span> irq, ret;</span><br><span class="line"><span class="number">980</span> <span class="type">dma_addr_t</span> phy_addr;</span><br><span class="line"><span class="number">981</span></span><br><span class="line"><span class="number">982</span> dev_dbg(&amp;pdev-&gt;dev, <span class="string">&quot;&lt;%s&gt;\n&quot;</span>, __func__);</span><br><span class="line"><span class="number">983</span></span><br><span class="line"><span class="number">984</span> irq = platform_get_irq(pdev, <span class="number">0</span>);<span class="comment">//è·å–ä¸­æ–­å·</span></span><br><span class="line">......</span><br><span class="line"><span class="number">990</span> res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);<span class="comment">//ä»è®¾å¤‡æ ‘è·å–å¯„å­˜å™¨ç‰©ç†åŸºåœ°å€</span></span><br><span class="line"><span class="number">991</span> base = devm_ioremap_resource(&amp;pdev-&gt;dev, res);</span><br><span class="line"><span class="number">992</span> <span class="keyword">if</span> (IS_ERR(base))</span><br><span class="line"><span class="number">993</span> <span class="keyword">return</span> PTR_ERR(base);</span><br><span class="line"><span class="number">994</span></span><br><span class="line"><span class="number">995</span> phy_addr = (<span class="type">dma_addr_t</span>)res-&gt;start;</span><br><span class="line"><span class="number">996</span> i2c_imx = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*i2c_imx),GFP_KERNEL);<span class="comment">//ç”³è¯·å†…å­˜</span></span><br><span class="line"><span class="number">997</span> <span class="keyword">if</span> (!i2c_imx)</span><br><span class="line"><span class="number">998</span> <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="number">999</span></span><br><span class="line"><span class="number">1000</span> <span class="keyword">if</span> (of_id)</span><br><span class="line"><span class="number">1001</span> i2c_imx-&gt;hwdata = of_id-&gt;data;</span><br><span class="line"><span class="number">1002</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">1003</span> i2c_imx-&gt;hwdata = (<span class="keyword">struct</span> imx_i2c_hwdata *)platform_get_device_id(pdev)-&gt;driver_data;</span><br><span class="line"><span class="number">1004</span> </span><br><span class="line"><span class="number">1005</span></span><br><span class="line"><span class="number">1006</span> <span class="comment">/* Setup i2c_imx driver structure */</span></span><br><span class="line"><span class="number">1007</span> strlcpy(i2c_imx-&gt;adapter.name, pdev-&gt;name,<span class="keyword">sizeof</span>(i2c_imx-&gt;adapter.name));</span><br><span class="line"><span class="number">1008</span> i2c_imx-&gt;adapter.owner = THIS_MODULE;<span class="comment">//åˆå§‹åŒ–i2c_adapter</span></span><br><span class="line"><span class="number">1009</span> i2c_imx-&gt;adapter.algo = &amp;i2c_imx_algo;</span><br><span class="line"><span class="number">1010</span> i2c_imx-&gt;adapter.dev.parent = &amp;pdev-&gt;dev;</span><br><span class="line"><span class="number">1011</span> i2c_imx-&gt;adapter.nr = pdev-&gt;id;</span><br><span class="line"><span class="number">1012</span> i2c_imx-&gt;adapter.dev.of_node = pdev-&gt;dev.of_node;</span><br><span class="line"><span class="number">1013</span> i2c_imx-&gt;base = base;</span><br><span class="line"><span class="number">1014</span></span><br><span class="line"><span class="number">1015</span> <span class="comment">/* Get I2C clock */</span></span><br><span class="line"><span class="number">1016</span> i2c_imx-&gt;clk = devm_clk_get(&amp;pdev-&gt;dev, <span class="literal">NULL</span>);</span><br><span class="line">......</span><br><span class="line"><span class="number">1022</span> ret = clk_prepare_enable(i2c_imx-&gt;clk);</span><br><span class="line">......</span><br><span class="line"><span class="number">1027</span> <span class="comment">/* Request IRQ */</span></span><br><span class="line"><span class="number">1028</span> ret = devm_request_irq(&amp;pdev-&gt;dev, irq, i2c_imx_isr,IRQF_NO_SUSPEND, pdev-&gt;name, i2c_imx);<span class="comment">//æ³¨å†Œæ§åˆ¶å™¨ä¸­æ–­</span></span><br><span class="line"><span class="number">1029</span> </span><br><span class="line">......</span><br><span class="line"><span class="number">1035</span> <span class="comment">/* Init queue */</span></span><br><span class="line"><span class="number">1036</span> init_waitqueue_head(&amp;i2c_imx-&gt;<span class="built_in">queue</span>);</span><br><span class="line"><span class="number">1037</span></span><br><span class="line"><span class="number">1038</span> <span class="comment">/* Set up adapter data */</span></span><br><span class="line"><span class="number">1039</span> i2c_set_adapdata(&amp;i2c_imx-&gt;adapter, i2c_imx);</span><br><span class="line"><span class="number">1040</span></span><br><span class="line"><span class="number">1041</span> <span class="comment">/* Set up clock divider */</span></span><br><span class="line"><span class="number">1042</span> i2c_imx-&gt;bitrate = IMX_I2C_BIT_RATE;<span class="comment">//è®¾ç½®æ—¶é’Ÿé¢‘ç‡</span></span><br><span class="line"><span class="number">1043</span> ret = of_property_read_u32(pdev-&gt;dev.of_node,<span class="string">&quot;clock-frequency&quot;</span>, &amp;i2c_imx-&gt;bitrate);</span><br><span class="line"><span class="number">1044</span> </span><br><span class="line"><span class="number">1045</span> <span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; pdata &amp;&amp; pdata-&gt;bitrate)</span><br><span class="line"><span class="number">1046</span> i2c_imx-&gt;bitrate = pdata-&gt;bitrate;</span><br><span class="line"><span class="number">1047</span></span><br><span class="line"><span class="number">1048</span> <span class="comment">/* Set up chip registers to defaults */</span></span><br><span class="line"><span class="number">1049</span> imx_i2c_write_reg(i2c_imx-&gt;hwdata-&gt;i2cr_ien_opcode ^ I2CR_IEN,i2c_imx, IMX_I2C_I2CR);</span><br><span class="line"><span class="number">1050</span> </span><br><span class="line"><span class="number">1051</span> imx_i2c_write_reg(i2c_imx-&gt;hwdata-&gt;i2sr_clr_opcode, IMX_I2C_I2SR);</span><br><span class="line"><span class="number">1052</span><span class="comment">/*è®¾ç½®I2CRå’ŒSRå¯„å­˜å™¨*/</span></span><br><span class="line"><span class="number">1053</span> <span class="comment">/* Add I2C adapter */</span></span><br><span class="line"><span class="number">1054</span> ret = i2c_add_numbered_adapter(&amp;i2c_imx-&gt;adapter);<span class="comment">//å†…æ ¸æ³¨å†Œi2c_adapter</span></span><br><span class="line"><span class="number">1055</span> <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1056</span> dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;registration failed\n&quot;</span>);</span><br><span class="line"><span class="number">1057</span> <span class="keyword">goto</span> clk_disable;</span><br><span class="line"><span class="number">1058</span> &#125;</span><br><span class="line"><span class="number">1059</span></span><br><span class="line"><span class="number">1060</span> <span class="comment">/* Set up platform driver data */</span></span><br><span class="line"><span class="number">1061</span> platform_set_drvdata(pdev, i2c_imx);</span><br><span class="line"><span class="number">1062</span> clk_disable_unprepare(i2c_imx-&gt;clk);</span><br><span class="line">......</span><br><span class="line"><span class="number">1070</span> <span class="comment">/* Init DMA config if supported */</span></span><br><span class="line"><span class="number">1071</span> i2c_imx_dma_request(i2c_imx, phy_addr);<span class="comment">//è®¾ç½®äº†DMA</span></span><br><span class="line"><span class="number">1072</span></span><br><span class="line"><span class="number">1073</span> <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* Return OK */</span></span><br><span class="line"><span class="number">1074</span></span><br><span class="line"><span class="number">1075</span> clk_disable:</span><br><span class="line"><span class="number">1076</span> clk_disable_unprepare(i2c_imx-&gt;clk);</span><br><span class="line"><span class="number">1077</span> <span class="keyword">return</span> ret;</span><br><span class="line"><span class="number">1078</span> &#125;</span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡æ·»åŠ é©±åŠ¨"><a href="#è®¾å¤‡æ·»åŠ é©±åŠ¨" class="headerlink" title="è®¾å¤‡æ·»åŠ é©±åŠ¨"></a>è®¾å¤‡æ·»åŠ é©±åŠ¨</h3><p>ä»¥ap3216cè®¾å¤‡ä¸ºä¾‹å­</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-17%20204441.png"></p><p>åœ¨èŠ‚ç‚¹i2c1ä¸­æ·»åŠ è®¾å¤‡çš„èŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c1 &#123;</span><br><span class="line">clock-frequency = &lt;<span class="number">100000</span>&gt;;</span><br><span class="line">pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_i2c1&gt;;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">ap3216c@<span class="number">1</span>e&#123;<span class="comment">//ap3216èŠ¯ç‰‡è®¾å¤‡æ·»åŠ çš„èŠ‚ç‚¹</span></span><br><span class="line">compatible = <span class="string">&quot;alientek,ap3216c&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">0x1e</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç¼–å†™ap3216cçš„è®¾å¤‡é©±åŠ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ap3216creg.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_CNT 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_NAME    <span class="string">&quot;ap3216c&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ap3216c_dev</span>&#123;</span></span><br><span class="line">    <span class="type">dev_t</span> devid;</span><br><span class="line">    <span class="type">int</span> major;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">node</span>;</span></span><br><span class="line">    <span class="type">void</span> *private_data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> ir,als,ps;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ap3216c_dev</span> <span class="title">ap3216cdev</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_read_regs</span><span class="params">(<span class="keyword">struct</span> ap3216c_dev *dev, u8 reg, <span class="type">void</span> *val, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;private_data;</span><br><span class="line">    msg[<span class="number">0</span>].addr = client-&gt;addr; <span class="comment">//ap3216cåœ°å€</span></span><br><span class="line">    msg[<span class="number">0</span>].flags = <span class="number">0</span>;   <span class="comment">//æ ‡è®°ä¸ºå‘é€æ•°æ®</span></span><br><span class="line">    msg[<span class="number">0</span>].buf = &amp;reg; <span class="comment">//è¯»å–é¦–åœ°å€</span></span><br><span class="line">    msg[<span class="number">0</span>].len = <span class="number">1</span>;     <span class="comment">//æ•°æ®é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">    msg[<span class="number">1</span>].addr = client-&gt;addr;<span class="comment">/* ap3216cåœ°å€ */</span></span><br><span class="line">    msg[<span class="number">1</span>].flags = I2C_M_RD;<span class="comment">/* æ ‡è®°ä¸ºè¯»å–æ•°æ®*/</span></span><br><span class="line">    msg[<span class="number">1</span>].buf = val;<span class="comment">/* è¯»å–æ•°æ®ç¼“å†²åŒº */</span></span><br><span class="line">    msg[<span class="number">1</span>].len = len;<span class="comment">/* è¦è¯»å–çš„æ•°æ®é•¿åº¦*/</span>    </span><br><span class="line"></span><br><span class="line">    ret = i2c_transfer(client-&gt;adapter, msg, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        printk(<span class="string">&quot;i2c rd failed=%d reg = %06x led = %d\n&quot;</span>, ret, reg, len);</span><br><span class="line">        ret = -EREMOTEIO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> s32 <span class="title function_">ap3216c_write_regs</span><span class="params">(<span class="keyword">struct</span> ap3216c_dev *dev, u8 reg, u8 *buf, u8 len)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 b[<span class="number">256</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *) dev-&gt; private_data;</span><br><span class="line">    b[<span class="number">0</span>] = reg ;    <span class="comment">//å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;b[<span class="number">1</span>], buf, len);    <span class="comment">//å†™å…¥çš„æ•°æ®æ‹·è´è¿›å…¥æ•°ç»„bé‡Œ</span></span><br><span class="line">    msg.addr = client-&gt; addr;   <span class="comment">//ap3216cåœ°å€</span></span><br><span class="line">    msg.flags = <span class="number">0</span>;  <span class="comment">//  æ ‡è®°ä¸ºå†™æ•°æ®   </span></span><br><span class="line">    msg.len = len + <span class="number">1</span>; <span class="comment">//æ•°æ®é•¿åº¦</span></span><br><span class="line">    msg.buf = b;<span class="comment">//å†™å…¥æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i2c_transfer(client-&gt;adapter, &amp;msg, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ap3216c_read_reg</span><span class="params">(<span class="keyword">struct</span> ap3216c_dev *dev, u8 reg)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 data = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ap3216c_read_regs(dev, reg, &amp;data, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ap3216c_write_reg</span><span class="params">(<span class="keyword">struct</span> ap3216c_dev *dev, u8 reg, u8 data)</span></span><br><span class="line">&#123;</span><br><span class="line">    u8 buf = <span class="number">0</span>;</span><br><span class="line">    buf = data;</span><br><span class="line">    ap3216c_write_regs(dev, reg, &amp;buf,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ap3216c_readdata</span><span class="params">(<span class="keyword">struct</span> ap3216c_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> i =<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¾ªç¯è¯»å–æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ® */</span></span><br><span class="line">     <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        buf[i] = ap3216c_read_reg(dev, AP3216C_IRDATALOW + i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(buf[<span class="number">0</span>] &amp; <span class="number">0X80</span>) <span class="comment">/* IR_OF ä½ä¸º 1,åˆ™æ•°æ®æ— æ•ˆ */</span></span><br><span class="line">        dev-&gt;ir = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">/* è¯»å– IR ä¼ æ„Ÿå™¨çš„æ•°æ® */</span></span><br><span class="line">        dev-&gt;ir = ((<span class="type">unsigned</span> <span class="type">short</span>)buf[<span class="number">1</span>] &lt;&lt; <span class="number">2</span>) | (buf[<span class="number">0</span>] &amp; <span class="number">0X03</span>);</span><br><span class="line"></span><br><span class="line">    dev-&gt;als = ((<span class="type">unsigned</span> <span class="type">short</span>)buf[<span class="number">3</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">2</span>];<span class="comment">/* ALS æ•°æ® */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(buf[<span class="number">4</span>] &amp; <span class="number">0x40</span>) <span class="comment">/* IR_OF ä½ä¸º 1,åˆ™æ•°æ®æ— æ•ˆ */</span></span><br><span class="line">        dev-&gt;ps = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">/* è¯»å– PS ä¼ æ„Ÿå™¨çš„æ•°æ® */</span></span><br><span class="line">        dev-&gt;ps = ((<span class="type">unsigned</span> <span class="type">short</span>)(buf[<span class="number">5</span>] &amp; <span class="number">0X3F</span>) &lt;&lt; <span class="number">4</span>) | (buf[<span class="number">4</span>] &amp; <span class="number">0X0F</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    filp-&gt;private_data = &amp;ap3216cdev;</span><br><span class="line">    ap3216c_write_reg(&amp;ap3216cdev, AP3216C_SYSTEMCONG, <span class="number">0x04</span>);</span><br><span class="line">    mdelay(<span class="number">50</span>);</span><br><span class="line">    ap3216c_write_reg(&amp;ap3216cdev, AP3216C_SYSTEMCONG, <span class="number">0x03</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">ap3216c_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt,<span class="type">loff_t</span> *off)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">short</span> data[<span class="number">3</span>];</span><br><span class="line">    <span class="type">long</span> err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ap3216c_dev</span> *<span class="title">dev</span> =</span> (<span class="keyword">struct</span> ap3216c_dev *)filp-&gt;private_data;</span><br><span class="line">    ap3216c_readdata(dev);</span><br><span class="line"></span><br><span class="line">    data[<span class="number">0</span>] = dev-&gt;ir;</span><br><span class="line">    data[<span class="number">1</span>] = dev-&gt;als;</span><br><span class="line">    data[<span class="number">2</span>] = dev-&gt;ps;</span><br><span class="line">    err = copy_to_user(buf, data,<span class="keyword">sizeof</span>(data));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_release</span><span class="params">(<span class="keyword">struct</span> inode *inode,<span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">ap3216c_ops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .read = ap3216c_read,</span><br><span class="line">    .open = ap3216c_open,</span><br><span class="line">    .release = ap3216c_release,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_probe</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* 1ã€æ„å»ºè®¾å¤‡å· */</span></span><br><span class="line"><span class="keyword">if</span> (ap3216cdev.major) &#123;</span><br><span class="line">ap3216cdev.devid = MKDEV(ap3216cdev.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(ap3216cdev.devid, AP3216C_CNT, AP3216C_NAME);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">alloc_chrdev_region(&amp;ap3216cdev.devid, <span class="number">0</span>, AP3216C_CNT, AP3216C_NAME);</span><br><span class="line">ap3216cdev.major = MAJOR(ap3216cdev.devid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2ã€æ³¨å†Œè®¾å¤‡ */</span></span><br><span class="line">cdev_init(&amp;ap3216cdev.cdev, &amp;ap3216c_ops);</span><br><span class="line">cdev_add(&amp;ap3216cdev.cdev, ap3216cdev.devid, AP3216C_CNT);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3ã€åˆ›å»ºç±» */</span></span><br><span class="line">ap3216cdev.class = class_create(THIS_MODULE, AP3216C_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(ap3216cdev.class)) &#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(ap3216cdev.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4ã€åˆ›å»ºè®¾å¤‡ */</span></span><br><span class="line">ap3216cdev.device = device_create(ap3216cdev.class, <span class="literal">NULL</span>, ap3216cdev.devid, <span class="literal">NULL</span>, AP3216C_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(ap3216cdev.device)) &#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(ap3216cdev.device);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ap3216cdev.private_data = client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description     : i2cé©±åŠ¨çš„removeå‡½æ•°ï¼Œç§»é™¤i2cé©±åŠ¨çš„æ—¶å€™æ­¤å‡½æ•°ä¼šæ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> * @param - client : i2cè®¾å¤‡</span></span><br><span class="line"><span class="comment"> * @return          : 0ï¼ŒæˆåŠŸ;å…¶ä»–è´Ÿå€¼,å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_remove</span><span class="params">(<span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* åˆ é™¤è®¾å¤‡ */</span></span><br><span class="line">cdev_del(&amp;ap3216cdev.cdev);</span><br><span class="line">unregister_chrdev_region(ap3216cdev.devid, AP3216C_CNT);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ³¨é”€æ‰ç±»å’Œè®¾å¤‡ */</span></span><br><span class="line">device_destroy(ap3216cdev.class, ap3216cdev.devid);</span><br><span class="line">class_destroy(ap3216cdev.class);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä¼ ç»ŸåŒ¹é…æ–¹å¼IDåˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">ap3216c_id</span>[] =</span> &#123;</span><br><span class="line">&#123;<span class="string">&quot;alientek,ap3216c&quot;</span>, <span class="number">0</span>&#125;,  </span><br><span class="line">&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾å¤‡æ ‘åŒ¹é…åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">ap3216c_of_match</span>[] =</span> &#123;</span><br><span class="line">&#123; .compatible = <span class="string">&quot;alientek,ap3216c&quot;</span> &#125;,</span><br><span class="line">&#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* i2cé©±åŠ¨ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">ap3216c_driver</span> =</span> &#123;</span><br><span class="line">.probe = ap3216c_probe,</span><br><span class="line">.remove = ap3216c_remove,</span><br><span class="line">.driver = &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">   .name = <span class="string">&quot;ap3216c&quot;</span>,</span><br><span class="line">   .of_match_table = ap3216c_of_match, </span><br><span class="line">   &#125;,</span><br><span class="line">.id_table = ap3216c_id,</span><br><span class="line">&#125;;</span><br><span class="line">   </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: é©±åŠ¨å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param : æ— </span></span><br><span class="line"><span class="comment"> * @return : æ— </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ap3216c_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">ret = i2c_add_driver(&amp;ap3216c_driver);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: é©±åŠ¨å‡ºå£å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param : æ— </span></span><br><span class="line"><span class="comment"> * @return : æ— </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">ap3216c_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">i2c_del_driver(&amp;ap3216c_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* module_i2c_driver(ap3216c_driver) */</span></span><br><span class="line"></span><br><span class="line">module_init(ap3216c_init);</span><br><span class="line">module_exit(ap3216c_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RTCé©±åŠ¨</title>
      <link href="/2023/07/12/2023-7-12-RTC%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/12/2023-7-12-RTC%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux-å†…æ ¸ä¸­-RTC-é©±åŠ¨è°ƒç”¨æµç¨‹"><a href="#Linux-å†…æ ¸ä¸­-RTC-é©±åŠ¨è°ƒç”¨æµç¨‹" class="headerlink" title="Linux å†…æ ¸ä¸­ RTC é©±åŠ¨è°ƒç”¨æµç¨‹"></a>Linux å†…æ ¸ä¸­ RTC é©±åŠ¨è°ƒç”¨æµç¨‹</h2><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-12%20154142.png"></p><p>Linux å†…æ ¸å°† RTC è®¾å¤‡æŠ½è±¡ä¸º rtc_device ç»“æ„ä½“ï¼Œå› æ­¤ RTC è®¾å¤‡é©±åŠ¨å°±æ˜¯ç”³è¯·å¹¶åˆå§‹åŒ–rtc_deviceï¼Œæœ€åå°† rtc_device æ³¨å†Œåˆ° Linux å†…æ ¸é‡Œé¢ï¼Œè¿™æ · Linux å†…æ ¸å°±æœ‰ä¸€ä¸ª RTC è®¾å¤‡äº† ã€‚</p><p>å½“ rtc_class_ops å‡†å¤‡å¥½ä»¥åéœ€è¦å°†å…¶æ³¨å†Œåˆ° Linux å†…æ ¸ä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨rtc_device_registerå‡½æ•°å®Œæˆæ³¨å†Œå·¥ä½œã€‚æ­¤å‡½æ•°ä¼šç”³è¯·ä¸€ä¸ªrtc_deviceå¹¶ä¸”åˆå§‹åŒ–è¿™ä¸ªrtc_deviceï¼Œæœ€åå‘è°ƒç”¨è€…è¿”å›è¿™ä¸ª rtc_deviceï¼Œæ­¤å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> rtc_device *<span class="title function_">rtc_device_register</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name,<span class="comment">//è®¾å¤‡åå­—</span></span></span><br><span class="line"><span class="params">                                       <span class="keyword">struct</span> device *dev,<span class="comment">//è®¾å¤‡</span></span></span><br><span class="line"><span class="params">                                       <span class="type">const</span> <span class="keyword">struct</span> rtc_class_ops *ops,<span class="comment">//RTC åº•å±‚é©±åŠ¨å‡½æ•°é›†</span></span></span><br><span class="line"><span class="params">                                       <span class="keyword">struct</span> module *owner)</span><span class="comment">//é©±åŠ¨æ¨¡å—æ‹¥æœ‰è€…</span></span><br><span class="line"><span class="comment">//æ³¨å†ŒæˆåŠŸçš„è¯å°±è¿”å› rtc_deviceï¼Œé”™è¯¯çš„è¯ä¼šè¿”å›ä¸€ä¸ªè´Ÿå€¼ã€‚</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">rtc_device_unregister</span><span class="params">(<span class="keyword">struct</span> rtc_device *rtc)</span></span><br><span class="line"><span class="comment">//rtcï¼šè¦åˆ é™¤çš„ rtc_deviceã€‚è¿”å›å€¼ï¼š æ— ã€‚</span></span><br></pre></td></tr></table></figure><p>RTC è®¾å¤‡çš„æ“ä½œè‚¯å®šæ˜¯ç”¨ä¸€ä¸ªæ“ä½œé›†åˆ(ç»“æ„ä½“ )</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">104</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_device</span></span></span><br><span class="line"><span class="class">105 &#123;</span></span><br><span class="line"><span class="number">106</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span> <span class="comment">/* è®¾å¤‡ */</span></span><br><span class="line"><span class="number">107</span> <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="number">108</span></span><br><span class="line"><span class="number">109</span> <span class="type">int</span> id; <span class="comment">/* ID */</span></span><br><span class="line"><span class="number">110</span> <span class="type">char</span> name[RTC_DEVICE_NAME_SIZE]; <span class="comment">/* åå­— */</span></span><br><span class="line"><span class="number">111</span></span><br><span class="line"><span class="number">112</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_class_ops</span> *<span class="title">ops</span>;</span> <span class="comment">/* RTC è®¾å¤‡åº•å±‚æ“ä½œå‡½æ•° æ¯”è¾ƒé‡è¦*/</span></span><br><span class="line"><span class="number">113</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">ops_lock</span>;</span></span><br><span class="line"><span class="number">114</span></span><br><span class="line"><span class="number">115</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">char_dev</span>;</span> <span class="comment">/* å­—ç¬¦è®¾å¤‡ */</span></span><br><span class="line"><span class="number">116</span> <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"><span class="number">117</span></span><br><span class="line"><span class="number">118</span> <span class="type">unsigned</span> <span class="type">long</span> irq_data;</span><br><span class="line"><span class="number">119</span> <span class="type">spinlock_t</span> irq_lock;</span><br><span class="line"><span class="number">120</span> <span class="type">wait_queue_head_t</span> irq_queue;</span><br><span class="line"><span class="number">121</span> <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">async_queue</span>;</span></span><br><span class="line"><span class="number">122</span></span><br><span class="line"><span class="number">123</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_task</span> *<span class="title">irq_task</span>;</span></span><br><span class="line"><span class="number">124</span> <span class="type">spinlock_t</span> irq_task_lock;</span><br><span class="line"><span class="number">125</span> <span class="type">int</span> irq_freq;</span><br><span class="line"><span class="number">126</span> <span class="type">int</span> max_user_freq;</span><br><span class="line"><span class="number">127</span></span><br><span class="line"><span class="number">128</span> <span class="class"><span class="keyword">struct</span> <span class="title">timerqueue_head</span> <span class="title">timerqueue</span>;</span></span><br><span class="line"><span class="number">129</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_timer</span> <span class="title">aie_timer</span>;</span></span><br><span class="line"><span class="number">130</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_timer</span> <span class="title">uie_rtctimer</span>;</span></span><br><span class="line"><span class="number">131</span> <span class="class"><span class="keyword">struct</span> <span class="title">hrtimer</span> <span class="title">pie_timer</span>;</span> <span class="comment">/* sub second exp, so needs hrtimer */</span></span><br><span class="line"><span class="number">132</span> <span class="type">int</span> pie_enabled;</span><br><span class="line"><span class="number">133</span> <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">irqwork</span>;</span></span><br><span class="line"><span class="number">134</span> <span class="comment">/* Some hardware can&#x27;t support UIE mode */</span></span><br><span class="line"><span class="number">135</span> <span class="type">int</span> uie_unsupported;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹rtc_class_opsåº•å±‚æ“ä½œæ•°é›†åˆï¼Œè¿™ä¸ªé›†åˆæ˜¯æœ€åº•å±‚çš„ RTC è®¾å¤‡æ“ä½œå‡½æ•° </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">71</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_class_ops</span> &#123;</span></span><br><span class="line"><span class="number">72</span> <span class="type">int</span> (*open)(<span class="keyword">struct</span> device *);</span><br><span class="line"><span class="number">73</span> <span class="type">void</span> (*release)(<span class="keyword">struct</span> device *);</span><br><span class="line"><span class="number">74</span> <span class="type">int</span> (*ioctl)(<span class="keyword">struct</span> device *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="number">75</span> <span class="type">int</span> (*read_time)(<span class="keyword">struct</span> device *, <span class="keyword">struct</span> rtc_time *);</span><br><span class="line"><span class="number">76</span> <span class="type">int</span> (*set_time)(<span class="keyword">struct</span> device *, <span class="keyword">struct</span> rtc_time *);</span><br><span class="line"><span class="number">77</span> <span class="type">int</span> (*read_alarm)(<span class="keyword">struct</span> device *, <span class="keyword">struct</span> rtc_wkalrm *);</span><br><span class="line"><span class="number">78</span> <span class="type">int</span> (*set_alarm)(<span class="keyword">struct</span> device *, <span class="keyword">struct</span> rtc_wkalrm *);</span><br><span class="line"><span class="number">79</span> <span class="type">int</span> (*proc)(<span class="keyword">struct</span> device *, <span class="keyword">struct</span> seq_file *);</span><br><span class="line"><span class="number">80</span> <span class="type">int</span> (*set_mmss64)(<span class="keyword">struct</span> device *, <span class="type">time64_t</span> secs);</span><br><span class="line"><span class="number">81</span> <span class="type">int</span> (*set_mmss)(<span class="keyword">struct</span> device *, <span class="type">unsigned</span> <span class="type">long</span> secs);</span><br><span class="line"><span class="number">82</span> <span class="type">int</span> (*read_callback)(<span class="keyword">struct</span> device *, <span class="type">int</span> data);</span><br><span class="line"><span class="number">83</span> <span class="type">int</span> (*alarm_irq_enable)(<span class="keyword">struct</span> device *, <span class="type">unsigned</span> <span class="type">int</span> enabled);</span><br><span class="line"><span class="number">84</span> &#125;;</span><br></pre></td></tr></table></figure><p>RTC æ˜¯å­—ç¬¦è®¾å¤‡ï¼ˆå­˜åœ¨å­—ç¬¦è®¾å¤‡çš„ file_operations å‡½æ•°æ“ä½œé›†ï¼‰ï¼Œ Linux å†…æ ¸æä¾›äº†ä¸€ä¸ª RTC é€šç”¨å­—ç¬¦è®¾å¤‡é©±åŠ¨æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸º drivers&#x2F;rtc&#x2F;rtc-dev.cï¼Œ rtcdev.c æ–‡ä»¶æä¾›äº†æ‰€æœ‰ RTC è®¾å¤‡å…±ç”¨çš„ file_operations å‡½æ•°æ“ä½œé›† </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">448</span> <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">rtc_dev_fops</span> =</span> &#123;</span><br><span class="line"><span class="number">449</span> .owner = THIS_MODULE,</span><br><span class="line"><span class="number">450</span> .llseek = no_llseek,</span><br><span class="line"><span class="number">451</span> .read = rtc_dev_read,</span><br><span class="line"><span class="number">452</span> .poll = rtc_dev_poll,</span><br><span class="line"><span class="number">453</span> .unlocked_ioctl = rtc_dev_ioctl,<span class="comment">/* rtc_class_ops ä¸­çš„ read_timeã€ </span></span><br><span class="line"><span class="comment">set_time ç­‰å‡½æ•°æ¥å¯¹å…·ä½“ RTC è®¾å¤‡çš„è¯»å†™æ“ä½œã€‚*/</span></span><br><span class="line"><span class="number">454</span> .open = rtc_dev_open,</span><br><span class="line"><span class="number">455</span> .release = rtc_dev_release,</span><br><span class="line"><span class="number">456</span> .fasync = rtc_dev_fasync,</span><br><span class="line"><span class="number">457</span> &#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">218</span> <span class="type">static</span> <span class="type">long</span> <span class="title function_">rtc_dev_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file,</span></span><br><span class="line"><span class="params"><span class="number">219</span> <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">220 &#123;</span><br><span class="line"><span class="number">221</span> <span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line"><span class="number">222</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_device</span> *<span class="title">rtc</span> =</span> file-&gt;private_data;</span><br><span class="line"><span class="number">223</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_class_ops</span> *<span class="title">ops</span> =</span> rtc-&gt;ops;</span><br><span class="line"><span class="number">224</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_time</span> <span class="title">tm</span>;</span></span><br><span class="line"><span class="number">225</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtc_wkalrm</span> <span class="title">alarm</span>;</span></span><br><span class="line"><span class="number">226</span> <span class="type">void</span> __user *uarg = (<span class="type">void</span> __user *) arg;</span><br><span class="line"><span class="number">227</span></span><br><span class="line"><span class="number">228</span> err = mutex_lock_interruptible(&amp;rtc-&gt;ops_lock);</span><br><span class="line"><span class="number">229</span> <span class="keyword">if</span> (err)</span><br><span class="line"><span class="number">230</span> <span class="keyword">return</span> err;</span><br><span class="line">......</span><br><span class="line"><span class="number">269</span> <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">......</span><br><span class="line"><span class="number">333</span> <span class="keyword">case</span> RTC_RD_TIME: <span class="comment">/* è¯»å–æ—¶é—´ */</span></span><br><span class="line"><span class="number">334</span> mutex_unlock(&amp;rtc-&gt;ops_lock);</span><br><span class="line"><span class="number">335</span></span><br><span class="line"><span class="number">336</span> err = rtc_read_time(rtc, &amp;tm);</span><br><span class="line"><span class="number">337</span> <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">338</span> <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">339</span></span><br><span class="line"><span class="number">340</span> <span class="keyword">if</span> (copy_to_user(uarg, &amp;tm, <span class="keyword">sizeof</span>(tm)))</span><br><span class="line"><span class="number">341</span> err = -EFAULT;</span><br><span class="line"><span class="number">342</span><span class="keyword">return</span> err;</span><br><span class="line"><span class="number">343</span></span><br><span class="line"><span class="number">344</span> <span class="keyword">case</span> RTC_SET_TIME: <span class="comment">/* è®¾ç½®æ—¶é—´ */</span></span><br><span class="line"><span class="number">345</span> mutex_unlock(&amp;rtc-&gt;ops_lock);</span><br><span class="line"><span class="number">346</span></span><br><span class="line"><span class="number">347</span> <span class="keyword">if</span> (copy_from_user(&amp;tm, uarg, <span class="keyword">sizeof</span>(tm)))</span><br><span class="line"><span class="number">348</span> <span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="number">349</span></span><br><span class="line"><span class="number">350</span> <span class="keyword">return</span> rtc_set_time(rtc, &amp;tm);</span><br><span class="line">......</span><br><span class="line"><span class="number">401</span> <span class="keyword">default</span>:</span><br><span class="line"><span class="number">402</span> <span class="comment">/* Finally try the driver&#x27;s ioctl interface */</span></span><br><span class="line"><span class="number">403</span> <span class="keyword">if</span> (ops-&gt;ioctl) &#123;</span><br><span class="line"><span class="number">404</span> err = ops-&gt;ioctl(rtc-&gt;dev.parent, cmd, arg);</span><br><span class="line"><span class="number">405</span> <span class="keyword">if</span> (err == -ENOIOCTLCMD)</span><br><span class="line"><span class="number">406</span> err = -ENOTTY;</span><br><span class="line"><span class="number">407</span> &#125; <span class="keyword">else</span></span><br><span class="line"><span class="number">408</span> err = -ENOTTY;</span><br><span class="line"><span class="number">409</span> <span class="keyword">break</span>;</span><br><span class="line"><span class="number">410</span> &#125;</span><br><span class="line"><span class="number">411</span></span><br><span class="line"><span class="number">412</span> done:</span><br><span class="line"><span class="number">413</span> mutex_unlock(&amp;rtc-&gt;ops_lock);</span><br><span class="line"><span class="number">414</span> <span class="keyword">return</span> err;</span><br><span class="line"><span class="number">415</span> &#125;</span><br></pre></td></tr></table></figure><h4 id="1ã€æ—¶é—´-RTC-æŸ¥çœ‹"><a href="#1ã€æ—¶é—´-RTC-æŸ¥çœ‹" class="headerlink" title="1ã€æ—¶é—´ RTC æŸ¥çœ‹"></a>1ã€æ—¶é—´ RTC æŸ¥çœ‹</h4><p>å¦‚æœè¦æŸ¥çœ‹æ—¶é—´çš„è¯è¾“å…¥â€œdateâ€å‘½ä»¤å³å¯ ã€‚</p><h4 id="2ã€è®¾ç½®-RTC-æ—¶é—´"><a href="#2ã€è®¾ç½®-RTC-æ—¶é—´" class="headerlink" title="2ã€è®¾ç½® RTC æ—¶é—´"></a>2ã€è®¾ç½® RTC æ—¶é—´</h4><p>RTC æ—¶é—´è®¾ç½®ä¹Ÿæ˜¯ä½¿ç”¨çš„ date å‘½ä»¤ï¼Œè¾“å…¥â€œdate â€“helpâ€å‘½ä»¤å³å¯æŸ¥çœ‹ date å‘½ä»¤å¦‚ä½•è®¾ç½®ç³»ç»Ÿæ—¶é—´ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hwclock -w //å°†å½“å‰ç³»ç»Ÿæ—¶é—´å†™å…¥åˆ° RTC é‡Œé¢</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>lcdé©±åŠ¨</title>
      <link href="/2023/07/10/2023-7-10-lcd%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/10/2023-7-10-lcd%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="Framebuffer"><a href="#Framebuffer" class="headerlink" title="Framebuffer"></a>Framebuffer</h2><p>åœ¨ Linux ä¸­åº”ç”¨ç¨‹åºæœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡æ“ä½œ RGB LCD çš„æ˜¾å­˜æ¥å®ç°åœ¨ LCD ä¸Šæ˜¾ç¤ºå­—ç¬¦ã€å›¾ç‰‡ç­‰ä¿¡æ¯ã€‚ å› ä¸ºè™šæ‹Ÿå†…å­˜çš„å­˜åœ¨ï¼Œé©±åŠ¨ç¨‹åºè®¾ç½®çš„æ˜¾å­˜å’Œåº”ç”¨ç¨‹åºè®¿é—®çš„æ˜¾å­˜è¦æ˜¯åŒä¸€ç‰‡ç‰©ç†å†…å­˜ã€‚</p><p>Framebuffer è¯ç”Ÿäº†ï¼Œ Framebuffer ç¿»è¯‘è¿‡æ¥å°±æ˜¯å¸§ç¼“å†²ï¼Œç®€ç§° fb ã€‚fb æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå°†ç³»ç»Ÿä¸­æ‰€æœ‰è·Ÿæ˜¾ç¤ºæœ‰å…³çš„ç¡¬ä»¶ä»¥åŠè½¯ä»¶é›†åˆèµ·æ¥ï¼Œè™šæ‹Ÿå‡ºä¸€ä¸ª fb è®¾å¤‡ã€‚</p><p>fb çš„ file_operations æ“ä½œé›†å®šä¹‰åœ¨drivers&#x2F;video&#x2F;fbdev&#x2F;core&#x2F;fbmem.c æ–‡ä»¶ä¸­ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1495</span> <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fb_fops</span> =</span> &#123;</span><br><span class="line"><span class="number">1496</span> .owner = THIS_MODULE,</span><br><span class="line"><span class="number">1497</span> .read = fb_read,</span><br><span class="line"><span class="number">1498</span> .write = fb_write,</span><br><span class="line"><span class="number">1499</span> .unlocked_ioctl = fb_ioctl,</span><br><span class="line"><span class="number">1500</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line"><span class="number">1501</span> .compat_ioctl = fb_compat_ioctl,</span><br><span class="line"><span class="number">1502</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">1503</span> .mmap = fb_mmap,</span><br><span class="line"><span class="number">1504</span> .open = fb_open,</span><br><span class="line"><span class="number">1505</span> .release = fb_release,</span><br><span class="line"><span class="number">1506</span> <span class="meta">#<span class="keyword">ifdef</span> HAVE_ARCH_FB_UNMAPPED_AREA</span></span><br><span class="line"><span class="number">1507</span> .get_unmapped_area = get_fb_unmapped_area,</span><br><span class="line"><span class="number">1508</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">1509</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_FB_DEFERRED_IO</span></span><br><span class="line"><span class="number">1510</span> .fsync = fb_deferred_io_fsync,</span><br><span class="line"><span class="number">1511</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">1512</span> .llseek = default_llseek,</span><br><span class="line"><span class="number">1513</span> &#125;;</span><br></pre></td></tr></table></figure><h3 id="LCDè®¾å¤‡èŠ‚ç‚¹"><a href="#LCDè®¾å¤‡èŠ‚ç‚¹" class="headerlink" title="LCDè®¾å¤‡èŠ‚ç‚¹"></a>LCDè®¾å¤‡èŠ‚ç‚¹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*imx6ull.dtsi æ–‡ä»¶ä¸­ lcdif èŠ‚ç‚¹å†…å®¹*/</span></span><br><span class="line"><span class="number">1</span> lcdif: lcdif@<span class="number">021</span>c8000 &#123;</span><br><span class="line"><span class="number">2</span> compatible = <span class="string">&quot;fsl,imx6ul-lcdif&quot;</span>, <span class="string">&quot;fsl,imx28-lcdif&quot;</span>;</span><br><span class="line"><span class="number">3</span> reg = &lt;<span class="number">0x021c8000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line"><span class="number">4</span> interrupts = &lt;GIC_SPI <span class="number">5</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line"><span class="number">5</span> clocks = &lt;&amp;clks IMX6UL_CLK_LCDIF_PIX&gt;,</span><br><span class="line"><span class="number">6</span> &lt;&amp;clks IMX6UL_CLK_LCDIF_APB&gt;,</span><br><span class="line"><span class="number">7</span> &lt;&amp;clks IMX6UL_CLK_DUMMY&gt;;</span><br><span class="line"><span class="number">8</span> clock-names = <span class="string">&quot;pix&quot;</span>, <span class="string">&quot;axi&quot;</span>, <span class="string">&quot;disp_axi&quot;</span>;</span><br><span class="line"><span class="number">9</span> status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line"><span class="number">10</span> &#125;;</span><br></pre></td></tr></table></figure><p>ä¹‹åè¿˜è¦å‘ imx6ullalientek-emmc.dts ä¸­çš„ lcdif èŠ‚ç‚¹æ·»åŠ å…¶ä»–çš„å±æ€§ä¿¡æ¯ã€‚ </p><p>å±æ€§å€¼ä¸ºâ€œfsl,imx6ul-lcdifâ€å’Œâ€œfsl,imx28-lcdifâ€ï¼Œå› æ­¤åœ¨ Linux æºç ä¸­æœç´¢è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²å³å¯æ‰¾åˆ° I.MX6ULL çš„ LCD é©±åŠ¨æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸º drivers&#x2F;video&#x2F;fbdev&#x2F;mxsfb.cï¼Œmxsfb.cå°±æ˜¯ I.MX6ULL çš„ LCD é©±åŠ¨æ–‡ä»¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1362</span> <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">mxsfb_dt_ids</span>[] =</span> &#123;</span><br><span class="line"><span class="number">1363</span> &#123; .compatible = <span class="string">&quot;fsl,imx23-lcdif&quot;</span>, .data = &amp;mxsfb_devtype[<span class="number">0</span>], &#125;,</span><br><span class="line"><span class="number">1364</span> &#123; .compatible = <span class="string">&quot;fsl,imx28-lcdif&quot;</span>, .data = &amp;mxsfb_devtype[<span class="number">1</span>], &#125;,</span><br><span class="line"><span class="number">1365</span> &#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line"><span class="number">1366</span> &#125;;</span><br><span class="line">......</span><br><span class="line"><span class="number">1625</span> <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mxsfb_driver</span> =</span> &#123;</span><br><span class="line"><span class="number">1626</span> .probe = mxsfb_probe,</span><br><span class="line"><span class="number">1627</span> .remove = mxsfb_remove,</span><br><span class="line"><span class="number">1628</span> .shutdown = mxsfb_shutdown,</span><br><span class="line"><span class="number">1629</span> .id_table = mxsfb_devtype,</span><br><span class="line"><span class="number">1630</span> .driver = &#123;</span><br><span class="line"><span class="number">1631</span> .name = DRIVER_NAME,</span><br><span class="line"><span class="number">1632</span> .of_match_table = mxsfb_dt_ids,</span><br><span class="line"><span class="number">1633</span> .pm = &amp;mxsfb_pm_ops,</span><br><span class="line"><span class="number">1634</span> &#125;,</span><br><span class="line"><span class="number">1635</span> &#125;;</span><br><span class="line"><span class="number">1636</span></span><br><span class="line"><span class="number">1637</span> module_platform_driver(mxsfb_driver);</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ platform é©±åŠ¨ï¼Œå½“é©±åŠ¨å’Œè®¾å¤‡åŒ¹é…ä»¥åmxsfb_probe å‡½æ•°å°±ä¼šæ‰§è¡Œã€‚ <strong>LCD çš„é©±åŠ¨å°±æ˜¯æ„å»º fb_infoï¼Œå¹¶ä¸”å‘ç³»ç»Ÿæ³¨å†Œ fb_infoçš„è¿‡ç¨‹ã€‚</strong> </p><p>fb_info ç»“æ„ä½“å®šä¹‰åœ¨ include&#x2F;linux&#x2F;fb.h æ–‡ä»¶é‡Œé¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">448</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> &#123;</span></span><br><span class="line"><span class="number">449</span> <span class="type">atomic_t</span> count;</span><br><span class="line"><span class="number">450</span> <span class="type">int</span> node;</span><br><span class="line"><span class="number">451</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="number">452</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span> <span class="comment">/* äº’æ–¥é” */</span></span><br><span class="line"><span class="number">453</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mm_lock</span>;</span> <span class="comment">/* äº’æ–¥é”ï¼Œç”¨äº fb_mmap å’Œ smem_*åŸŸ*/</span></span><br><span class="line"><span class="number">454</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">var</span>;</span> <span class="comment">/* å½“å‰å¯å˜å‚æ•° */</span></span><br><span class="line"><span class="number">455</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">fix</span>;</span> <span class="comment">/* å½“å‰å›ºå®šå‚æ•° */</span></span><br><span class="line"><span class="number">456</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_monspecs</span> <span class="title">monspecs</span>;</span> <span class="comment">/* å½“å‰æ˜¾ç¤ºå™¨ç‰¹æ€§ */</span></span><br><span class="line"><span class="number">457</span> <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">queue</span>;</span> <span class="comment">/* å¸§ç¼“å†²äº‹ä»¶é˜Ÿåˆ— */</span></span><br><span class="line"><span class="number">458</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_pixmap</span> <span class="title">pixmap</span>;</span> <span class="comment">/* å›¾åƒç¡¬ä»¶æ˜ å°„ */</span></span><br><span class="line"><span class="number">459</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_pixmap</span> <span class="title">sprite</span>;</span> <span class="comment">/* å…‰æ ‡ç¡¬ä»¶æ˜ å°„ */</span></span><br><span class="line"><span class="number">460</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_cmap</span> <span class="title">cmap</span>;</span> <span class="comment">/* å½“å‰è°ƒè‰²æ¿ */</span></span><br><span class="line"><span class="number">461</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">modelist</span>;</span> <span class="comment">/* å½“å‰æ¨¡å¼åˆ—è¡¨ */</span></span><br><span class="line"><span class="number">462</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_videomode</span> *<span class="title">mode</span>;</span> <span class="comment">/* å½“å‰è§†é¢‘æ¨¡å¼ */</span></span><br><span class="line"><span class="number">463</span></span><br><span class="line"><span class="number">464</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_FB_BACKLIGHT <span class="comment">/* å¦‚æœ LCD æ”¯æŒèƒŒå…‰çš„è¯ */</span></span></span><br><span class="line"><span class="number">465</span> <span class="comment">/* assigned backlight device */</span></span><br><span class="line"><span class="number">466</span> <span class="comment">/* set before framebuffer registration,</span></span><br><span class="line"><span class="comment">467 remove after unregister */</span></span><br><span class="line"><span class="number">468</span> <span class="class"><span class="keyword">struct</span> <span class="title">backlight_device</span> *<span class="title">bl_dev</span>;</span> <span class="comment">/* èƒŒå…‰è®¾å¤‡ */</span></span><br><span class="line"><span class="number">469</span></span><br><span class="line"><span class="number">470</span> <span class="comment">/* Backlight level curve */</span></span><br><span class="line"><span class="number">471</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">bl_curve_mutex</span>;</span></span><br><span class="line"><span class="number">472</span> u8 bl_curve[FB_BACKLIGHT_LEVELS];åŸå­å“¥åœ¨çº¿æ•™å­¦:www.yuanzige.com è®ºå›:www.openedv.com</span><br><span class="line"><span class="number">1416</span></span><br><span class="line">I.MX6U åµŒå…¥å¼ Linux é©±åŠ¨å¼€å‘æŒ‡å—</span><br><span class="line"><span class="number">473</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">......</span><br><span class="line"><span class="number">479</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> *<span class="title">fbops</span>;</span> <span class="comment">/* å¸§ç¼“å†²æ“ä½œå‡½æ•°é›† */</span></span><br><span class="line"><span class="number">480</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span> <span class="comment">/* çˆ¶è®¾å¤‡ */</span></span><br><span class="line"><span class="number">481</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span> <span class="comment">/* å½“å‰ fb è®¾å¤‡ */</span></span><br><span class="line"><span class="number">482</span> <span class="type">int</span> class_flag; <span class="comment">/* ç§æœ‰ sysfs æ ‡å¿— */</span></span><br><span class="line">......</span><br><span class="line"><span class="number">486</span> <span class="type">char</span> __iomem *screen_base; <span class="comment">/* è™šæ‹Ÿå†…å­˜åŸºåœ°å€(å±å¹•æ˜¾å­˜) */</span></span><br><span class="line"><span class="number">487</span> <span class="type">unsigned</span> <span class="type">long</span> screen_size; <span class="comment">/* è™šæ‹Ÿå†…å­˜å¤§å°(å±å¹•æ˜¾å­˜å¤§å°) */</span></span><br><span class="line"><span class="number">488</span> <span class="type">void</span> *pseudo_palette; <span class="comment">/* ä¼ª 16 ä½è°ƒè‰²æ¿ */</span></span><br><span class="line">......</span><br><span class="line"><span class="number">507</span> &#125;;</span><br></pre></td></tr></table></figure><p><u><strong>mxsfb_probe å‡½æ•°çš„ä¸»è¦å·¥ä½œå†…å®¹ä¸º ï¼š</strong></u></p><p><strong>â‘ ã€ç”³è¯· fb_infoã€‚</strong><br><strong>â‘¡ã€åˆå§‹åŒ– fb_info ç»“æ„ä½“ä¸­çš„å„ä¸ªæˆå‘˜å˜é‡ã€‚</strong><br><strong>â‘¢ã€åˆå§‹åŒ– eLCDIF æ§åˆ¶å™¨ã€‚</strong><br><strong>â‘£ã€ä½¿ç”¨ register_framebuffer å‡½æ•°å‘ Linux å†…æ ¸æ³¨å†Œåˆå§‹åŒ–å¥½çš„ fb_infoã€‚</strong> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mxsfb_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">1370 &#123;</span><br><span class="line"><span class="number">1371</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">of_id</span> =</span></span><br><span class="line"><span class="number">1372</span> of_match_device(mxsfb_dt_ids, &amp;pdev-&gt;dev);</span><br><span class="line"><span class="number">1373</span> <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span></span><br><span class="line"><span class="number">1374</span> <span class="class"><span class="keyword">struct</span> <span class="title">mxsfb_info</span> *<span class="title">host</span>;</span><span class="comment">//IMX6uLLä¸»æ§æ¥å£ï¼Œmxsfb_infoä¸ºNXPå®šä¹‰çš„fbè®¾å¤‡ç»“æ„ä½“</span></span><br><span class="line"><span class="number">1375</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fb_info</span>;</span></span><br><span class="line"><span class="number">1376</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">pinctrl</span>;</span></span><br><span class="line"><span class="number">1377</span> <span class="type">int</span> irq = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line"><span class="number">1378</span> <span class="type">int</span> gpio, ret;</span><br><span class="line"><span class="number">1379</span></span><br><span class="line">......</span><br><span class="line"><span class="number">1394</span></span><br><span class="line"><span class="number">1395</span> res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);<span class="comment">//è·å–eLCDIFæ¥å£æ§åˆ¶å™¨çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="number">1396</span> <span class="keyword">if</span> (!res) &#123;</span><br><span class="line"><span class="number">1397</span> dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Cannot get memory IO resource\n&quot;</span>);</span><br><span class="line"><span class="number">1398</span> <span class="keyword">return</span> -ENODEV;</span><br><span class="line"><span class="number">1399</span> &#125;</span><br><span class="line"><span class="number">1400</span></span><br><span class="line"><span class="number">1401</span> host = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mxsfb_info),GFP_KERNEL);<span class="comment">//ç»™hostç”³è¯·å†…å­˜</span></span><br><span class="line"><span class="number">1402</span> <span class="keyword">if</span> (!host) &#123;</span><br><span class="line"><span class="number">1403</span> dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to allocate IO resource\n&quot;</span>);</span><br><span class="line"><span class="number">1404</span> <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="number">1405</span> &#125;</span><br><span class="line"><span class="number">1406</span></span><br><span class="line"><span class="number">1407</span> fb_info = framebuffer_alloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> fb_info), &amp;pdev-&gt;dev);<span class="comment">//ç»™fbç”³è¯·å†…å­˜</span></span><br><span class="line"><span class="number">1408</span> <span class="keyword">if</span> (!fb_info) &#123;</span><br><span class="line"><span class="number">1409</span> dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to allocate fbdev\n&quot;</span>);</span><br><span class="line"><span class="number">1410</span> devm_kfree(&amp;pdev-&gt;dev, host);</span><br><span class="line"><span class="number">1411</span> <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="number">1412</span> &#125;</span><br><span class="line"><span class="number">1413</span> host-&gt;fb_info = fb_info;</span><br><span class="line"><span class="number">1414</span> fb_info-&gt;par = host;<span class="comment">//å°†ç”³è¯·çš„hostå’Œfb_infoè”ç³»åˆ°ä¸€èµ·</span></span><br><span class="line"><span class="number">1415</span></span><br><span class="line"><span class="number">1416</span> ret = devm_request_irq(&amp;pdev-&gt;dev, irq, mxsfb_irq_handler, <span class="number">0</span>,dev_name(&amp;pdev-&gt;dev), host);</span><br><span class="line"><span class="number">1417</span> <span class="comment">//ç”³è¯·ä¸­æ–­</span></span><br><span class="line"><span class="number">1418</span> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"><span class="number">1419</span> dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;request_irq (%d) failed with</span></span><br><span class="line"><span class="string">1420 error %d\n&quot;</span>, irq, ret);</span><br><span class="line"><span class="number">1421</span> ret = -ENODEV;</span><br><span class="line"><span class="number">1422</span> <span class="keyword">goto</span> fb_release;</span><br><span class="line"><span class="number">1423</span> &#125;</span><br><span class="line"><span class="number">1424</span></span><br><span class="line"><span class="number">1425</span> host-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, res);<span class="comment">//å¯¹ä»è®¾å¤‡æ ‘ä¸­è·å–å¯„å­˜å™¨é¦–åœ°å€è¿›è¡Œå†…å­˜æ˜ å°„</span></span><br><span class="line">          <span class="comment">//   å¾—åˆ°è™šæ‹Ÿåœ°å€ä¿å­˜åˆ°hostå˜é‡ä¸­</span></span><br><span class="line"><span class="number">1426</span> <span class="keyword">if</span> (IS_ERR(host-&gt;base)) &#123;</span><br><span class="line"><span class="number">1427</span> dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;ioremap failed\n&quot;</span>);</span><br><span class="line"><span class="number">1428</span> ret = PTR_ERR(host-&gt;base);</span><br><span class="line"><span class="number">1429</span> <span class="keyword">goto</span> fb_release;</span><br><span class="line"><span class="number">1430</span> &#125;</span><br><span class="line">......</span><br><span class="line"><span class="number">1461</span></span><br><span class="line"><span class="number">1462</span> fb_info-&gt;pseudo_palette = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(u32) * <span class="number">16</span>, GFP_KERNEL);<span class="comment">//ç”³è¯·å†…å­˜</span></span><br><span class="line"><span class="number">1463</span> </span><br><span class="line"><span class="number">1464</span> <span class="keyword">if</span> (!fb_info-&gt;pseudo_palette) &#123;</span><br><span class="line"><span class="number">1465</span> ret = -ENOMEM;</span><br><span class="line"><span class="number">1466</span> <span class="keyword">goto</span> fb_release;</span><br><span class="line"><span class="number">1467</span> &#125;</span><br><span class="line"><span class="number">1468</span></span><br><span class="line"><span class="number">1469</span> INIT_LIST_HEAD(&amp;fb_info-&gt;modelist);</span><br><span class="line"><span class="number">1470</span></span><br><span class="line"><span class="number">1471</span> pm_runtime_enable(&amp;host-&gt;pdev-&gt;dev);</span><br><span class="line"><span class="number">1472</span></span><br><span class="line"><span class="number">1473</span> ret = mxsfb_init_fbinfo(host);<span class="comment">//åˆå§‹åŒ–fb_info</span></span><br><span class="line"><span class="number">1474</span> <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line"><span class="number">1475</span> <span class="keyword">goto</span> fb_pm_runtime_disable;</span><br><span class="line"><span class="number">1476</span></span><br><span class="line"><span class="number">1477</span> mxsfb_dispdrv_init(pdev, fb_info);</span><br><span class="line"><span class="number">1478</span></span><br><span class="line"><span class="number">1479</span> <span class="keyword">if</span> (!host-&gt;dispdrv) &#123;</span><br><span class="line"><span class="number">1480</span> pinctrl = devm_pinctrl_get_select_default(&amp;pdev-&gt;dev);</span><br><span class="line"><span class="number">1481</span> <span class="keyword">if</span> (IS_ERR(pinctrl)) &#123;</span><br><span class="line"><span class="number">1482</span> ret = PTR_ERR(pinctrl);</span><br><span class="line"><span class="number">1483</span> <span class="keyword">goto</span> fb_pm_runtime_disable;</span><br><span class="line"><span class="number">1484</span> &#125;</span><br><span class="line"><span class="number">1485</span> &#125;</span><br><span class="line"><span class="number">1486</span></span><br><span class="line"><span class="number">1487</span> <span class="keyword">if</span> (!host-&gt;enabled) &#123;</span><br><span class="line"><span class="number">1488</span> writel(<span class="number">0</span>, host-&gt;base + LCDC_CTRL);</span><br><span class="line"><span class="number">1489</span> mxsfb_set_par(fb_info);<span class="comment">//è®¾ç½®eLCDIFæ§åˆ¶å™¨ç›¸åº”çš„å¯„å­˜å™¨</span></span><br><span class="line"><span class="number">1490</span> mxsfb_enable_controller(fb_info);</span><br><span class="line"><span class="number">1491</span> pm_runtime_get_sync(&amp;host-&gt;pdev-&gt;dev);</span><br><span class="line"><span class="number">1492</span> &#125;</span><br><span class="line"><span class="number">1493</span></span><br><span class="line"><span class="number">1494</span> ret = register_framebuffer(fb_info);<span class="comment">//å†…æ ¸æ³¨å†Œfb_info</span></span><br><span class="line"><span class="number">1495</span> <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1496</span> dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Failed to register framebuffer\n&quot;</span>);</span><br><span class="line"><span class="number">1497</span> <span class="keyword">goto</span> fb_destroy;</span><br><span class="line"><span class="number">1498</span> &#125;</span><br><span class="line">......</span><br><span class="line"><span class="number">1525</span> <span class="keyword">return</span> ret;</span><br><span class="line"><span class="number">1526</span> &#125;</span><br></pre></td></tr></table></figure><p>NXP æä¾›çš„ fbops ä¸ºmxsfb_ops</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">987</span> <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> <span class="title">mxsfb_ops</span> =</span> &#123;</span><br><span class="line"><span class="number">988</span> .owner = THIS_MODULE,</span><br><span class="line"><span class="number">989</span> .fb_check_var = mxsfb_check_var,</span><br><span class="line"><span class="number">990</span> .fb_set_par = mxsfb_set_par,</span><br><span class="line"><span class="number">991</span> .fb_setcolreg = mxsfb_setcolreg,</span><br><span class="line"><span class="number">992</span> .fb_ioctl = mxsfb_ioctl,</span><br><span class="line"><span class="number">993</span> .fb_blank = mxsfb_blank,</span><br><span class="line"><span class="number">994</span> .fb_pan_display = mxsfb_pan_display,</span><br><span class="line"><span class="number">995</span> .fb_mmap = mxsfb_mmap,</span><br><span class="line"><span class="number">996</span> .fb_fillrect = cfb_fillrect,</span><br><span class="line"><span class="number">997</span> .fb_copyarea = cfb_copyarea,</span><br><span class="line"><span class="number">998</span> .fb_imageblit = cfb_imageblit,</span><br><span class="line"><span class="number">999</span> &#125;;</span><br></pre></td></tr></table></figure><p>mxsfb_init_fbinfo å‡½æ•°é€šè¿‡è°ƒç”¨ mxsfb_init_fbinfo_dt å‡½æ•°ä»è®¾å¤‡æ ‘ä¸­è·å–åˆ° LCD çš„å„ä¸ªå‚æ•°ä¿¡æ¯ã€‚æœ€åï¼Œ mxsfb_init_fbinfo<br>å‡½æ•°ä¼šè°ƒç”¨ mxsfb_map_videomem å‡½æ•°ç”³è¯· LCD çš„å¸§ç¼“å†²å†…å­˜(ä¹Ÿå°±æ˜¯æ˜¾å­˜)ã€‚ </p><h2 id="é©±åŠ¨ç¼–å†™"><a href="#é©±åŠ¨ç¼–å†™" class="headerlink" title="é©±åŠ¨ç¼–å†™"></a>é©±åŠ¨ç¼–å†™</h2><p>é‡ç‚¹è¦æ³¨æ„ä¸‰ä¸ªåœ°æ–¹ï¼š<br><strong>â‘ ã€ LCD æ‰€ä½¿ç”¨çš„ IO é…ç½®ã€‚</strong><br><strong>â‘¡ã€ LCD å±å¹•èŠ‚ç‚¹ä¿®æ”¹ï¼Œä¿®æ”¹ç›¸åº”çš„å±æ€§å€¼ï¼Œæ‰€ä½¿ç”¨çš„ LCD å±å¹•å‚æ•°ã€‚</strong><br><strong>â‘¢ã€ LCD èƒŒå…‰èŠ‚ç‚¹ä¿¡æ¯ä¿®æ”¹ï¼Œè¦æ ¹æ®å®é™…æ‰€ä½¿ç”¨çš„èƒŒå…‰ IO æ¥ä¿®æ”¹ç›¸åº”çš„è®¾å¤‡èŠ‚ç‚¹ä¿¡æ¯ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾å¤‡æ ‘ LCD IO é…ç½®</span></span><br><span class="line"><span class="number">1</span> pinctrl_lcdif_dat: lcdifdatgrp &#123;</span><br><span class="line"><span class="number">2</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">3</span> MX6UL_PAD_LCD_DATA00__LCDIF_DATA00 <span class="number">0x79</span></span><br><span class="line"><span class="number">4</span> MX6UL_PAD_LCD_DATA01__LCDIF_DATA01 <span class="number">0x79</span></span><br><span class="line"><span class="number">5</span> MX6UL_PAD_LCD_DATA02__LCDIF_DATA02 <span class="number">0x79</span></span><br><span class="line"><span class="number">6</span> MX6UL_PAD_LCD_DATA03__LCDIF_DATA03 <span class="number">0x79</span></span><br><span class="line"><span class="number">7</span> MX6UL_PAD_LCD_DATA04__LCDIF_DATA04 <span class="number">0x79</span></span><br><span class="line"><span class="number">8</span> MX6UL_PAD_LCD_DATA05__LCDIF_DATA05 <span class="number">0x79</span></span><br><span class="line"><span class="number">9</span> MX6UL_PAD_LCD_DATA06__LCDIF_DATA06 <span class="number">0x79</span></span><br><span class="line"><span class="number">10</span> MX6UL_PAD_LCD_DATA07__LCDIF_DATA07 <span class="number">0x79</span></span><br><span class="line"><span class="number">11</span> MX6UL_PAD_LCD_DATA08__LCDIF_DATA08 <span class="number">0x79</span></span><br><span class="line"><span class="number">12</span> MX6UL_PAD_LCD_DATA09__LCDIF_DATA09 <span class="number">0x79</span></span><br><span class="line"><span class="number">13</span> MX6UL_PAD_LCD_DATA10__LCDIF_DATA10 <span class="number">0x79</span></span><br><span class="line"><span class="number">14</span> MX6UL_PAD_LCD_DATA11__LCDIF_DATA11 <span class="number">0x79</span></span><br><span class="line"><span class="number">15</span> MX6UL_PAD_LCD_DATA12__LCDIF_DATA12 <span class="number">0x79</span></span><br><span class="line"><span class="number">16</span> MX6UL_PAD_LCD_DATA13__LCDIF_DATA13 <span class="number">0x79</span></span><br><span class="line"><span class="number">17</span> MX6UL_PAD_LCD_DATA14__LCDIF_DATA14 <span class="number">0x79</span></span><br><span class="line"><span class="number">18</span> MX6UL_PAD_LCD_DATA15__LCDIF_DATA15 <span class="number">0x79</span></span><br><span class="line"><span class="number">19</span> MX6UL_PAD_LCD_DATA16__LCDIF_DATA16 <span class="number">0x79</span></span><br><span class="line"><span class="number">20</span> MX6UL_PAD_LCD_DATA17__LCDIF_DATA17 <span class="number">0x79</span></span><br><span class="line"><span class="number">21</span> MX6UL_PAD_LCD_DATA18__LCDIF_DATA18 <span class="number">0x79</span></span><br><span class="line"><span class="number">22</span> MX6UL_PAD_LCD_DATA19__LCDIF_DATA19 <span class="number">0x79</span></span><br><span class="line"><span class="number">23</span> MX6UL_PAD_LCD_DATA20__LCDIF_DATA20 <span class="number">0x79</span></span><br><span class="line"><span class="number">24</span> MX6UL_PAD_LCD_DATA21__LCDIF_DATA21 <span class="number">0x79</span></span><br><span class="line"><span class="number">25</span> MX6UL_PAD_LCD_DATA22__LCDIF_DATA22 <span class="number">0x79</span></span><br><span class="line"><span class="number">26</span> MX6UL_PAD_LCD_DATA23__LCDIF_DATA23 <span class="number">0x79</span></span><br><span class="line"><span class="number">27</span> &gt;;<span class="comment">//ä¸ºRGBLCDçš„27æ ¹æ•°æ®çº¿é…ç½®é¡¹</span></span><br><span class="line"><span class="number">28</span> &#125;;</span><br><span class="line"><span class="number">29</span></span><br><span class="line"><span class="number">30</span> pinctrl_lcdif_ctrl: lcdifctrlgrp &#123;</span><br><span class="line"><span class="number">31</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">32</span> MX6UL_PAD_LCD_CLK__LCDIF_CLK <span class="number">0x79</span></span><br><span class="line"><span class="number">33</span> MX6UL_PAD_LCD_ENABLE__LCDIF_ENABLE <span class="number">0x79</span></span><br><span class="line"><span class="number">34</span> MX6UL_PAD_LCD_HSYNC__LCDIF_HSYNC <span class="number">0x79</span></span><br><span class="line"><span class="number">35</span> MX6UL_PAD_LCD_VSYNC__LCDIF_VSYNC <span class="number">0x79</span></span><br><span class="line"><span class="number">36</span> &gt;;<span class="comment">//RGB LCD çš„ 4 æ ¹æ§åˆ¶çº¿é…ç½®é¡¹ï¼ŒåŒ…æ‹¬ CLKã€ENABLEã€ VSYNC(åœºåŒæ­¥ä¿¡å·)å’Œ HSYNC(è¡ŒåŒæ­¥ä¿¡å·)ã€‚</span></span><br><span class="line"><span class="number">37</span> pinctrl_pwm1: pwm1grp &#123;</span><br><span class="line"><span class="number">38</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">39</span> MX6UL_PAD_GPIO1_IO08__PWM1_OUT <span class="number">0x110b0</span></span><br><span class="line"><span class="number">40</span> &gt;;<span class="comment">//LCD èƒŒå…‰ PWM å¼•è„šé…ç½®é¡¹ã€‚è¿™ä¸ªå¼•è„šè¦æ ¹æ®å®é™…æƒ…å†µè®¾ç½®ï¼Œ</span></span><br><span class="line"><span class="number">41</span> &#125;;</span><br></pre></td></tr></table></figure><p>ä¹‹åä¿®æ”¹lcdifèŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&amp;lcdif&#123;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_lcdif_dat</span><br><span class="line">    &amp;pinctrl_lcdif_ctrl</span><br><span class="line">    <span class="comment">/*&amp;pinctrl_lcdif_reset*/</span>&gt;;<span class="comment">//æœ¬æ˜¾ç¤ºlcdæ²¡æœ‰å¤ä½å¼•è„šæ‰€ä»¥åˆ æ‰</span></span><br><span class="line">    display = &lt;&amp;display0&gt;;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    display0: display &#123; <span class="comment">/* LCD å±æ€§ä¿¡æ¯ */</span></span><br><span class="line">bits-per-pixel = &lt;<span class="number">24</span>&gt;; <span class="comment">/* ä¸€ä¸ªåƒç´ å ç”¨å‡ ä¸ª bit ï¼ŒRGB888 8+8+8 =24bit*/</span></span><br><span class="line">bus-width = &lt;<span class="number">24</span>&gt;; <span class="comment">/* æ€»çº¿å®½åº¦ */</span></span><br><span class="line"></span><br><span class="line">        display-timings &#123;</span><br><span class="line">        native-mode = &lt;&amp;timing0&gt;; <span class="comment">/* æ—¶åºä¿¡æ¯ */</span></span><br><span class="line">        timing0: timing0 &#123;</span><br><span class="line">            clock-frequency = &lt;<span class="number">33300000</span>&gt;; <span class="comment">/* LCD åƒç´ æ—¶é’Ÿï¼Œå•ä½ Hz */</span></span><br><span class="line">            hactive = &lt;<span class="number">800</span>&gt;; <span class="comment">/* LCD X è½´åƒç´ ä¸ªæ•° */</span></span><br><span class="line">            vactive = &lt;<span class="number">480</span>&gt;; <span class="comment">/* LCD Y è½´åƒç´ ä¸ªæ•° */</span></span><br><span class="line">            hfront-porch = &lt;<span class="number">210</span>&gt;; <span class="comment">/* LCD hfp å‚æ•° */</span></span><br><span class="line">            hback-porch = &lt;<span class="number">46</span>&gt;; <span class="comment">/* LCD hbp å‚æ•° */</span></span><br><span class="line">            hsync-len = &lt;<span class="number">1</span>&gt;; <span class="comment">/* LCD hspw å‚æ•° */</span></span><br><span class="line">            vback-porch = &lt;<span class="number">23</span>&gt;; <span class="comment">/* LCD vbp å‚æ•° */</span></span><br><span class="line">            vfront-porch = &lt;<span class="number">22</span>&gt;; <span class="comment">/* LCD vfp å‚æ•° */</span></span><br><span class="line">            vsync-len = &lt;<span class="number">1</span>&gt;; <span class="comment">/* LCD vspw å‚æ•° */</span></span><br><span class="line"></span><br><span class="line">            hsync-active = &lt;<span class="number">0</span>&gt;; <span class="comment">/* hsync æ•°æ®çº¿ææ€§ */</span></span><br><span class="line">            vsync-active = &lt;<span class="number">0</span>&gt;; <span class="comment">/* vsync æ•°æ®çº¿ææ€§ */</span></span><br><span class="line">            de-active = &lt;<span class="number">1</span>&gt;; <span class="comment">/* de æ•°æ®çº¿ææ€§ */</span></span><br><span class="line">            pixelclk-active = &lt;<span class="number">0</span>&gt;; <span class="comment">/* clk æ•°æ®çº¿å…ˆææ€§ */</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>èƒŒå…‰èŠ‚ç‚¹ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> pinctrl_pwm1: pwm1grp &#123;</span><br><span class="line"><span class="number">2</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">3</span> MX6UL_PAD_GPIO1_IO08__PWM1_OUT <span class="number">0x110b0</span></span><br><span class="line"><span class="number">4</span> &gt;;</span><br><span class="line"><span class="number">5</span> &#125;;</span><br></pre></td></tr></table></figure><p>LCD èƒŒå…‰è¦ç”¨åˆ° PWM1ï¼Œå› æ­¤ä¹Ÿè¦è®¾ç½® PWM1 èŠ‚ç‚¹ï¼Œåœ¨ imx6ull.dtsi æ–‡ä»¶ä¸­æ‰¾åˆ°å¦‚ä¸‹å†…å®¹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> pwm1: pwm@<span class="number">02080000</span> &#123;</span><br><span class="line"><span class="number">2</span> compatible = <span class="string">&quot;fsl,imx6ul-pwm&quot;</span>, <span class="string">&quot;fsl,imx27-pwm&quot;</span>;</span><br><span class="line"><span class="number">3</span> reg = &lt;<span class="number">0x02080000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line"><span class="number">4</span> interrupts = &lt;GIC_SPI <span class="number">83</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line"><span class="number">5</span> clocks = &lt;&amp;clks IMX6UL_CLK_PWM1&gt;,</span><br><span class="line"><span class="number">6</span> &lt;&amp;clks IMX6UL_CLK_PWM1&gt;;</span><br><span class="line"><span class="number">7</span> clock-names = <span class="string">&quot;ipg&quot;</span>, <span class="string">&quot;per&quot;</span>;</span><br><span class="line"><span class="number">8</span> <span class="meta">#pwm-cells = <span class="string">&lt;2&gt;</span>;</span></span><br><span class="line"><span class="number">9</span> &#125;;</span><br></pre></td></tr></table></figure><p>åœ¨æ•´ä¸ª Linux æºç æ–‡ä»¶ä¸­æœç´¢ compatible å±æ€§çš„è¿™ä¸¤ä¸ªå€¼å³å¯æ‰¾åˆ° imx6ull çš„ pwm é©±åŠ¨æ–‡ä»¶ã€‚</p><p>ç»§ç»­åœ¨ imx6ull-alientek-emmc.dts æ–‡ä»¶ä¸­æ‰¾åˆ°å‘ pwm1è¿½åŠ çš„å†…å®¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> &amp;pwm1 &#123;</span><br><span class="line"><span class="number">2</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">3</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_pwm1&gt;;<span class="comment">//ä¹‹å‰å®šä¹‰çš„GPIO1_08</span></span><br><span class="line"><span class="number">4</span> status = <span class="string">&quot;okay&quot;</span>;<span class="comment">//è®¾ç½®okay</span></span><br><span class="line"><span class="number">5</span> &#125;;</span><br></pre></td></tr></table></figure><p>è¦è®©LinuxçŸ¥é“PWM1_OUTæ˜¯æ§åˆ¶èƒŒå…‰çš„ï¼Œéœ€è¦ä¸€ä¸ªèŠ‚ç‚¹æ¥å°† LCD èƒŒå…‰å’Œ PWM1_OUTè¿ æ¥ èµ· æ¥ ã€‚ è¿™ ä¸ª èŠ‚ ç‚¹ å°± æ˜¯ backlight ï¼Œ backlight èŠ‚ ç‚¹ æ è¿° å¯ ä»¥ å‚ è€ƒDocumentation&#x2F;devicetree&#x2F;indings&#x2F;video&#x2F;backlight&#x2F;pwm-backlight.txt è¿™ä¸ªæ–‡æ¡£ï¼Œæ­¤æ–‡æ¡£è¯¦ç»†è®²è§£äº†<br>backlight èŠ‚ç‚¹è¯¥å¦‚ä½•å»åˆ›å»ºï¼Œè¿™é‡Œå¤§æ¦‚æ€»ç»“ä¸€ä¸‹ï¼š </p><ol><li>èŠ‚ç‚¹åç§°è¦ä¸ºâ€œbacklightâ€ã€‚</li><li>èŠ‚ç‚¹çš„ compatible å±æ€§å€¼è¦ä¸ºâ€œpwm-backlightâ€ï¼Œå› æ­¤å¯ä»¥é€šè¿‡åœ¨ Linux å†…æ ¸ä¸­æœç´¢â€œ pwm-backlight â€ æ¥ æŸ¥ æ‰¾ PWM èƒŒ å…‰ æ§ åˆ¶ é©± åŠ¨ ç¨‹ åº ï¼Œ è¿™ ä¸ª é©± åŠ¨ ç¨‹ åº æ–‡ ä»¶ ä¸ºdrivers&#x2F;video&#x2F;backlight&#x2F;pwm_bl.cï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹ä¸€ä¸‹è¿™ä¸ªé©±åŠ¨ç¨‹åºã€‚</li><li>pwmså±æ€§ç”¨äºæè¿°èƒŒå…‰æ‰€ä½¿ç”¨çš„PWMä»¥åŠPWMé¢‘ç‡ï¼Œæ¯”å¦‚æœ¬ç« æˆ‘ä»¬è¦ä½¿ç”¨çš„pwm1ï¼Œpwm é¢‘ç‡è®¾ç½®ä¸º 200Hz(NXP å®˜æ–¹æ¨èè®¾ç½®)ã€‚</li><li>brightness-levels å±æ€§æè¿°äº®åº¦çº§åˆ«ï¼ŒèŒƒå›´ä¸º 0~255ï¼Œ 0 è¡¨ç¤º PWM å ç©ºæ¯”ä¸º 0%ï¼Œä¹Ÿå°±æ˜¯äº®åº¦æœ€ä½ï¼Œ 255 è¡¨ç¤º 100%å ç©ºæ¯”ï¼Œä¹Ÿå°±æ˜¯äº®åº¦æœ€é«˜ </li><li>default-brightness-level å±æ€§ä¸ºé»˜è®¤äº®åº¦çº§åˆ«ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">backlight &#123;</span><br><span class="line">compatible = <span class="string">&quot;pwm-backlight&quot;</span>;</span><br><span class="line">pwms = &lt;&amp;pwm1 <span class="number">0</span> <span class="number">5000000</span>&gt;;<span class="comment">//è®¾ç½®èƒŒå…‰ä½¿ç”¨ pwm1ï¼Œ PWM é¢‘ç‡ä¸º 200Hzã€‚</span></span><br><span class="line">brightness-levels = &lt;<span class="number">0</span> <span class="number">4</span> <span class="number">8</span> <span class="number">16</span> <span class="number">32</span> <span class="number">64</span> <span class="number">128</span> <span class="number">255</span>&gt;;<span class="comment">/*è®¾ç½®èƒŒ 8 çº§èƒŒå…‰(0~7)ï¼Œåˆ†åˆ«ä¸º 0ã€ 4ã€ 8ã€ 16ã€ 32ã€ 64ã€ 128ã€ 255ï¼Œå¯¹åº”å ç©ºæ¯”ä¸º0%ã€ 1.57%ã€ 3.13%ã€ 6.27%ã€ 12.55%ã€ 25.1%ã€ 50.19%ã€ 100%*/</span></span><br><span class="line"><span class="keyword">default</span>-brightness-level = &lt;<span class="number">6</span>&gt;;<span class="comment">//è®¾ç½®é»˜è®¤èƒŒå…‰ç­‰çº§ä¸º 6ï¼Œä¹Ÿå°±æ˜¯ 50.19%çš„äº®åº¦</span></span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œæµ‹è¯•"><a href="#è¿è¡Œæµ‹è¯•" class="headerlink" title="è¿è¡Œæµ‹è¯•"></a>è¿è¡Œæµ‹è¯•</h3><h4 id="è®¾ç½®"><a href="#è®¾ç½®" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make dtbs//ç¼–è¯‘è®¾å¤‡æ ‘</span><br></pre></td></tr></table></figure><p>ä½¿èƒ½ Linux logo æ˜¾ç¤º ï¼Œmake menuconfigæ‰“å¼€ Linuxå†…æ ¸å›¾å½¢åŒ–é…ç½®ç•Œé¢ï¼ŒæŒ‰ä¸‹è·¯å¾„æ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹ï¼š </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-10%20195842.png"></p><p>é‡æ–°ç¼–è¯‘ Linux å†…æ ¸ï¼Œç¼–è¯‘å®Œæˆä»¥åä½¿ç”¨æ–°ç¼–è¯‘å‡ºæ¥çš„ imx6ull-alientek-emmc.dtb å’Œ zImage é•œåƒå¯åŠ¨ç³»ç»Ÿ ï¼Œå¦‚æœæ˜¾ç¤ºæ­£å¸¸çš„è¯ï¼ŒLCDå·¦ä¸Šè§’ä¼šå‡ºç°ä¸€ä¸ªå½©è‰²çš„å°ä¼é¹…logo</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-10%20200126.png"></p><h4 id="è®¾ç½®-LCD-ä½œä¸ºç»ˆç«¯æ§åˆ¶å°"><a href="#è®¾ç½®-LCD-ä½œä¸ºç»ˆç«¯æ§åˆ¶å°" class="headerlink" title="è®¾ç½® LCD ä½œä¸ºç»ˆç«¯æ§åˆ¶å°"></a>è®¾ç½® LCD ä½œä¸ºç»ˆç«¯æ§åˆ¶å°</h4><ol><li><p><strong>è®¾ç½®ubootä¸­çš„bootargs</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;console=tty1 console=ttymxc0,115200 root=/dev/nfs rw nfsroot=192.168.1.250:</span><br><span class="line">/home/moss/linux/nfs/rootfs ip=192.168.0.128:192.168.1.250:192.168.0.1:255.255.255.0::eth0:off&#x27;</span><br></pre></td></tr></table></figure><p>è®¾ç½®äº†ä¸¤é consoleï¼Œç¬¬ä¸€æ¬¡è®¾ç½® console&#x3D;tty1ï¼Œä¹Ÿå°±æ˜¯è®¾ç½® LCD å±å¹•ä¸ºæ§åˆ¶å°ï¼Œç¬¬äºŒéåˆè®¾ç½® console&#x3D;ttymxc0,115200ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®ä¸²å£ä¹Ÿä½œä¸ºæ§åˆ¶å°ã€‚ç›¸å½“äºæˆ‘ä»¬æ‰“å¼€äº†ä¸¤ä¸ª consoleï¼Œä¸€ä¸ªæ˜¯ LCDï¼Œä¸€ä¸ªæ˜¯ä¸²å£ï¼Œå¤§å®¶é‡å¯å¼€å‘æ¿å°±ä¼šå‘ç° LCD å’Œä¸²å£éƒ½ä¼šæ˜¾ç¤º Linux å¯åŠ¨ log ä¿¡æ¯ã€‚ </p></li><li><p><strong>ä¿®æ”¹&#x2F;etc&#x2F;inittab æ–‡ä»¶</strong></p></li></ol><p>æ‰“å¼€å¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„&#x2F;etc&#x2F;inittab æ–‡ä»¶ï¼Œåœ¨é‡Œé¢åŠ å…¥ä¸‹é¢è¿™ä¸€è¡Œï¼š </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tty1::askfirst:-/bin/sh</span><br></pre></td></tr></table></figure><p>æ·»åŠ å®Œæˆä»¥åçš„&#x2F;etc&#x2F;inittab æ–‡ä»¶å†…å®¹å¦‚å›¾ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-10%20200633.png">Â·Â·Â·Â·Â·</p><p>ä¿®æ”¹å®Œæˆä»¥åä¿å­˜&#x2F;etc&#x2F;inittab å¹¶é€€å‡ºï¼Œç„¶åé‡å¯å¼€å‘æ¿ï¼Œé‡å¯ä»¥åå¼€å‘æ¿ LCD å±å¹•æœ€åä¸€è¡Œä¼šæ˜¾ç¤ºä¸‹é¢ä¸€è¡Œè¯­å¥ï¼š </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Please press Enter to activate this console.</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±æ‹¥æœ‰äº†ä¸¤å¥—ç»ˆç«¯ï¼Œä¸€ä¸ªæ˜¯åŸºäºä¸²å£çš„ SecureCRTï¼Œä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬å¼€å‘æ¿çš„ LCDå±å¹•ï¼Œä½†æ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘ä»¬ä»¥åè¿˜æ˜¯ä»¥ SecureCRT ä¸ºä¸»ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸€è¡Œå‘½ä»¤å‘LCD å±å¹•è¾“å‡ºâ€œhello linuxï¼â€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo hello linux &gt; /dev/tty1 </span><br></pre></td></tr></table></figure><p>é€šè¿‡è®¾ç½®èƒŒå…‰ç­‰çº§æ¥å®ç° LCD èƒŒå…‰äº®åº¦çš„è°ƒèŠ‚ï¼Œè¿›å…¥å¦‚ä¸‹ç›®å½•ï¼š&#x2F;sys&#x2F;devices&#x2F;platform&#x2F;backlight&#x2F;backlight&#x2F;backlight </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-10%20202557.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 7 &gt; brightness//è®¾ç½®èƒŒå…‰ç­‰çº§ä¸º7</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>inputé©±åŠ¨</title>
      <link href="/2023/07/09/2023-7-9-input%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/09/2023-7-9-input%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="Inputå­ç³»ç»Ÿ"><a href="#Inputå­ç³»ç»Ÿ" class="headerlink" title="Inputå­ç³»ç»Ÿ"></a>Inputå­ç³»ç»Ÿ</h2><p>input å°±æ˜¯è¾“å…¥çš„æ„æ€ï¼Œå› æ­¤ input å­ç³»ç»Ÿå°±æ˜¯ç®¡ç†è¾“å…¥çš„å­ç³»ç»Ÿï¼Œå’Œ pinctrlã€ gpio å­ç³»ç»Ÿä¸€æ ·ï¼Œéƒ½æ˜¯ Linux å†…æ ¸é’ˆå¯¹æŸä¸€ç±»è®¾å¤‡è€Œåˆ›å»ºçš„æ¡†æ¶ã€‚æ¯”å¦‚æŒ‰é”®è¾“å…¥ã€é”®ç›˜ã€é¼ æ ‡ã€è§¦æ‘¸å±ç­‰ç­‰è¿™äº›éƒ½å±äºè¾“å…¥è®¾å¤‡ï¼Œä¸ºæ­¤ input å­ç³»ç»Ÿåˆ†ä¸º input é©±åŠ¨å±‚ã€ input æ ¸å¿ƒå±‚ã€ input äº‹ä»¶å¤„ç†å±‚ï¼Œæœ€ç»ˆç»™ç”¨æˆ·ç©ºé—´æä¾›å¯è®¿é—®çš„è®¾å¤‡èŠ‚ç‚¹ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-08%20114135.png"></p><h3 id="é©±åŠ¨éƒ¨åˆ†åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šé©±åŠ¨å±‚ï¼Œæ ¸å¿ƒå±‚ï¼Œäº‹ä»¶å±‚"><a href="#é©±åŠ¨éƒ¨åˆ†åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šé©±åŠ¨å±‚ï¼Œæ ¸å¿ƒå±‚ï¼Œäº‹ä»¶å±‚" class="headerlink" title="é©±åŠ¨éƒ¨åˆ†åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šé©±åŠ¨å±‚ï¼Œæ ¸å¿ƒå±‚ï¼Œäº‹ä»¶å±‚"></a>é©±åŠ¨éƒ¨åˆ†åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šé©±åŠ¨å±‚ï¼Œæ ¸å¿ƒå±‚ï¼Œäº‹ä»¶å±‚</h3><p>é©±åŠ¨å±‚ï¼šè¾“å…¥è®¾å¤‡çš„å…·ä½“é©±åŠ¨ç¨‹åºï¼Œæ¯”å¦‚æŒ‰é”®é©±åŠ¨ç¨‹åºï¼Œå‘å†…æ ¸å±‚æŠ¥å‘Šè¾“å…¥å†…å®¹ã€‚<br>æ ¸å¿ƒå±‚ï¼šæ‰¿ä¸Šå¯ä¸‹ï¼Œä¸ºé©±åŠ¨å±‚æä¾›è¾“å…¥è®¾å¤‡æ³¨å†Œå’Œæ“ä½œæ¥å£ã€‚é€šçŸ¥äº‹ä»¶å±‚å¯¹è¾“å…¥äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚<br>äº‹ä»¶å±‚ï¼šä¸»è¦å’Œç”¨æˆ·ç©ºé—´è¿›è¡Œäº¤äº’ã€‚ </p><h3 id="æ³¨å†Œinput-dev"><a href="#æ³¨å†Œinput-dev" class="headerlink" title="æ³¨å†Œinput_dev"></a>æ³¨å†Œinput_dev</h3><p>åœ¨ä½¿ç”¨ input å­ç³»ç»Ÿçš„æ—¶å€™æˆ‘ä»¬åªéœ€è¦æ³¨å†Œä¸€ä¸ª input è®¾å¤‡å³å¯ï¼Œ input_dev ç»“æ„ä½“è¡¨ç¤º inputè®¾å¤‡ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">121</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> &#123;</span></span><br><span class="line"><span class="number">122</span> <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"><span class="number">123</span> <span class="type">const</span> <span class="type">char</span> *phys;</span><br><span class="line"><span class="number">124</span> <span class="type">const</span> <span class="type">char</span> *uniq;</span><br><span class="line"><span class="number">125</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_id</span> <span class="title">id</span>;</span></span><br><span class="line"><span class="number">126</span></span><br><span class="line"><span class="number">127</span> <span class="type">unsigned</span> <span class="type">long</span> propbit[BITS_TO_LONGS(INPUT_PROP_CNT)];</span><br><span class="line"><span class="number">128</span></span><br><span class="line"><span class="number">129</span> <span class="type">unsigned</span> <span class="type">long</span> evbit[BITS_TO_LONGS(EV_CNT)]; <span class="comment">/* äº‹ä»¶ç±»å‹çš„ä½å›¾ */</span></span><br><span class="line"><span class="number">130</span> <span class="type">unsigned</span> <span class="type">long</span> keybit[BITS_TO_LONGS(KEY_CNT)]; <span class="comment">/* æŒ‰é”®å€¼çš„ä½å›¾ */</span></span><br><span class="line"><span class="number">131</span> <span class="type">unsigned</span> <span class="type">long</span> relbit[BITS_TO_LONGS(REL_CNT)]; <span class="comment">/* ç›¸å¯¹åæ ‡çš„ä½å›¾ */</span></span><br><span class="line"><span class="number">132</span> <span class="type">unsigned</span> <span class="type">long</span> absbit[BITS_TO_LONGS(ABS_CNT)]; <span class="comment">/* ç»å¯¹åæ ‡çš„ä½å›¾ */</span></span><br><span class="line"><span class="number">133</span> <span class="type">unsigned</span> <span class="type">long</span> mscbit[BITS_TO_LONGS(MSC_CNT)]; <span class="comment">/* æ‚é¡¹äº‹ä»¶çš„ä½å›¾ */</span></span><br><span class="line"><span class="number">134</span> <span class="type">unsigned</span> <span class="type">long</span> ledbit[BITS_TO_LONGS(LED_CNT)]; <span class="comment">/*LED ç›¸å…³çš„ä½å›¾ */</span></span><br><span class="line"><span class="number">135</span> <span class="type">unsigned</span> <span class="type">long</span> sndbit[BITS_TO_LONGS(SND_CNT)];<span class="comment">/* sound æœ‰å…³çš„ä½å›¾ */</span></span><br><span class="line"><span class="number">136</span> <span class="type">unsigned</span> <span class="type">long</span> ffbit[BITS_TO_LONGS(FF_CNT)]; <span class="comment">/* å‹åŠ›åé¦ˆçš„ä½å›¾ */</span></span><br><span class="line"><span class="number">137</span> <span class="type">unsigned</span> <span class="type">long</span> swbit[BITS_TO_LONGS(SW_CNT)]; <span class="comment">/*å¼€å…³çŠ¶æ€çš„ä½å›¾ */</span></span><br><span class="line">......</span><br><span class="line"><span class="number">189</span> <span class="type">bool</span> devres_managed;</span><br><span class="line"><span class="number">190</span> &#125;;</span><br></pre></td></tr></table></figure><p>evbit è¡¨ç¤ºè¾“å…¥äº‹ä»¶ç±»å‹ï¼Œå¯é€‰çš„äº‹ä»¶ç±»å‹å®šä¹‰åœ¨ include&#x2F;uapi&#x2F;linux&#x2F;input.h æ–‡ä»¶ä¸­ï¼Œäº‹ä»¶ç±»å‹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EV_SYN 0x00 <span class="comment">/* åŒæ­¥äº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_KEY 0x01 <span class="comment">/* æŒ‰é”®äº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_REL 0x02 <span class="comment">/* ç›¸å¯¹åæ ‡äº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_ABS 0x03 <span class="comment">/* ç»å¯¹åæ ‡äº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_MSC 0x04 <span class="comment">/* æ‚é¡¹(å…¶ä»–)äº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_SW 0x05 <span class="comment">/* å¼€å…³äº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_LED 0x11 <span class="comment">/* LED */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_SND 0x12 <span class="comment">/* sound(å£°éŸ³) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_REP 0x14 <span class="comment">/* é‡å¤äº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_FF 0x15 <span class="comment">/* å‹åŠ›äº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_PWR 0x16 <span class="comment">/* ç”µæºäº‹ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_FF_STATUS 0x17 <span class="comment">/* å‹åŠ›çŠ¶æ€äº‹ä»¶ */</span></span></span><br></pre></td></tr></table></figure><p>Linux å†…æ ¸å®šä¹‰äº†å¾ˆå¤šæŒ‰é”®å€¼ï¼Œè¿™äº›æŒ‰é”®å€¼å®šä¹‰åœ¨ include&#x2F;uapi&#x2F;linux&#x2F;input.h æ–‡ä»¶ä¸­ï¼ŒæŒ‰é”®å€¼å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">215</span> <span class="meta">#<span class="keyword">define</span> KEY_RESERVED 0</span></span><br><span class="line"><span class="number">216</span> <span class="meta">#<span class="keyword">define</span> KEY_ESC 1</span></span><br><span class="line"><span class="number">217</span> <span class="meta">#<span class="keyword">define</span> KEY_1 2</span></span><br><span class="line"><span class="number">218</span> <span class="meta">#<span class="keyword">define</span> KEY_2 3</span></span><br><span class="line"><span class="number">219</span> <span class="meta">#<span class="keyword">define</span> KEY_3 4</span></span><br><span class="line"><span class="number">220</span> <span class="meta">#<span class="keyword">define</span> KEY_4 5</span></span><br><span class="line"><span class="number">221</span> <span class="meta">#<span class="keyword">define</span> KEY_5 6</span></span><br><span class="line"><span class="number">222</span> <span class="meta">#<span class="keyword">define</span> KEY_6 7</span></span><br><span class="line"><span class="number">223</span> <span class="meta">#<span class="keyword">define</span> KEY_7 8</span></span><br><span class="line"><span class="number">224</span> <span class="meta">#<span class="keyword">define</span> KEY_8 9</span></span><br><span class="line"><span class="number">225</span> <span class="meta">#<span class="keyword">define</span> KEY_9 10</span></span><br><span class="line"><span class="number">226</span> <span class="meta">#<span class="keyword">define</span> KEY_0 11</span></span><br><span class="line">......</span><br><span class="line"><span class="number">794</span> <span class="meta">#<span class="keyword">define</span> BTN_TRIGGER_HAPPY39 0x2e6</span></span><br><span class="line"><span class="number">795</span> <span class="meta">#<span class="keyword">define</span> BTN_TRIGGER_HAPPY40 0x2e7</span></span><br></pre></td></tr></table></figure><p>åœ¨ç¼–å†™ input è®¾å¤‡é©±åŠ¨çš„æ—¶å€™æˆ‘ä»¬éœ€è¦å…ˆç”³è¯·ä¸€ä¸ª input_dev ç»“æ„ä½“å˜é‡ï¼Œä½¿ç”¨input_allocate_device å‡½æ•°æ¥ç”³è¯·ä¸€ä¸ª input_devï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> input_dev *<span class="title function_">input_allocate_device</span><span class="params">(<span class="type">void</span>)</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¦æ³¨é”€çš„ input è®¾å¤‡çš„è¯éœ€è¦ä½¿ç”¨ input_free_device å‡½æ•°æ¥é‡Šæ”¾æ‰å‰é¢ç”³è¯·åˆ°çš„input_devï¼Œ i</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_free_device</span><span class="params">(<span class="keyword">struct</span> input_dev *dev)</span></span><br></pre></td></tr></table></figure><p>ç”³è¯·å¥½ä¸€ä¸ª input_dev ä»¥åå°±éœ€è¦åˆå§‹åŒ–è¿™ä¸ª input_devï¼Œéœ€è¦åˆå§‹åŒ–çš„å†…å®¹ä¸»è¦ä¸ºäº‹ä»¶ç±»å‹(evbit)å’Œäº‹ä»¶å€¼(keybit)è¿™ä¸¤ç§ã€‚ input_dev åˆå§‹åŒ–å®Œæˆä»¥åå°±éœ€è¦å‘ Linux å†…æ ¸æ³¨å†Œ input_deväº†ï¼Œéœ€è¦ç”¨åˆ° input_register_device å‡½æ•° </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">input_register_device</span><span class="params">(<span class="keyword">struct</span> input_dev *dev)</span></span><br></pre></td></tr></table></figure><h3 id="input-dev-æ³¨å†Œè¿‡ç¨‹å¦‚ä¸‹ï¼š"><a href="#input-dev-æ³¨å†Œè¿‡ç¨‹å¦‚ä¸‹ï¼š" class="headerlink" title="input_dev æ³¨å†Œè¿‡ç¨‹å¦‚ä¸‹ï¼š"></a>input_dev æ³¨å†Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</h3><p>â‘ ã€ä½¿ç”¨ input_allocate_device å‡½æ•°ç”³è¯·ä¸€ä¸ª input_devã€‚<br>â‘¡ã€åˆå§‹åŒ– input_dev çš„äº‹ä»¶ç±»å‹ä»¥åŠäº‹ä»¶å€¼ã€‚<br>â‘¢ã€ä½¿ç”¨ input_register_device å‡½æ•°å‘ Linux ç³»ç»Ÿæ³¨å†Œå‰é¢åˆå§‹åŒ–å¥½çš„ input_devã€‚<br>â‘£ã€å¸è½½inputé©±åŠ¨çš„æ—¶å€™éœ€è¦å…ˆä½¿ç”¨input_unregister_device å‡½æ•°æ³¨é”€æ‰æ³¨å†Œçš„input_devï¼Œç„¶åä½¿ç”¨ input_free_device å‡½æ•°é‡Šæ”¾æ‰å‰é¢ç”³è¯·çš„ input_devã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">inputdev</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    inputdev = input_allocate_device();<span class="comment">//ç”³è¯·input_dev</span></span><br><span class="line">    inputdev -&gt; name = <span class="string">&quot;test_inputdev&quot;</span>;<span class="comment">//è®¾ç½®åå­—</span></span><br><span class="line">    <span class="comment">//ç¬¬ä¸€ç§è®¾ç½®äº‹ä»¶å’Œé”®å€¼</span></span><br><span class="line">    __set_bit(EV_KEY, inputdev-&gt;evbit);<span class="comment">//è®¾ç½®äº§ç”ŸæŒ‰é”®äº‹ä»¶</span></span><br><span class="line">__set_bit(EV_REP, inputdev-&gt;evbit);<span class="comment">//é‡å¤äº‹ä»¶</span></span><br><span class="line">    __set_bit(KEY_0, inputdev-&gt;keyit);<span class="comment">//è®¾ç½®äº§ç”Ÿå“ªäº›æŒ‰é”®å€¼</span></span><br><span class="line"><span class="comment">//ç¬¬äºŒç§è®¾ç½®äº‹ä»¶å’Œé”®å€¼</span></span><br><span class="line">    keyinputdev.inputdev-&gt;evbit[<span class="number">0</span>] = BIT_MASK(EV_KEY)|BIT_MASK(EV_REP);</span><br><span class="line">    keyinputdev.inputdev-&gt;keyit[BIT_WORD(KEY_0)] |= BIT_MASK(KEY_0);</span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰ç§è®¾ç½®äº‹ä»¶å’Œé”®å€¼</span></span><br><span class="line">    keyinputdev.inputdev-&gt;evbit[<span class="number">0</span>] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);</span><br><span class="line">    input_set_capability(keyinputdev.inputdev, EV_KEY, KEY_0);</span><br><span class="line">    </span><br><span class="line">    input_register_device(inputdev);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    input_unregister_device(inputdev);</span><br><span class="line">    input_free_device(inputdev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸ŠæŠ¥è¾“å…¥äº‹ä»¶"><a href="#ä¸ŠæŠ¥è¾“å…¥äº‹ä»¶" class="headerlink" title="ä¸ŠæŠ¥è¾“å…¥äº‹ä»¶"></a>ä¸ŠæŠ¥è¾“å…¥äº‹ä»¶</h3><p> Linux å†…æ ¸æ³¨å†Œå¥½ input_dev ä¸èƒ½é¡ºåˆ©çš„ä½¿ç”¨inputè®¾å¤‡ï¼Œ input è®¾å¤‡éƒ½æ˜¯å…·æœ‰è¾“å…¥åŠŸèƒ½çš„ï¼Œä½†æ˜¯å…·ä½“æ˜¯ä»€ä¹ˆæ ·çš„è¾“å…¥å€¼ Linux å†…æ ¸æ˜¯ä¸çŸ¥é“çš„ï¼Œéœ€è¦è·å–åˆ°å…·ä½“çš„è¾“å…¥å€¼ï¼Œæˆ–è€…è¯´æ˜¯è¾“å…¥äº‹ä»¶ï¼Œç„¶åå°†è¾“å…¥äº‹ä»¶ä¸ŠæŠ¥ç»™ Linux å†…æ ¸ã€‚æ¯”å¦‚æŒ‰é”®ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æŒ‰é”®ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œæˆ–è€…æ¶ˆæŠ–å®šæ—¶å™¨ä¸­æ–­å‡½æ•°ä¸­å°†æŒ‰é”®å€¼ä¸ŠæŠ¥ç»™ Linux å†…æ ¸ï¼Œè¿™æ · Linux å†…æ ¸æ‰èƒ½è·å–åˆ°æ­£ç¡®çš„è¾“å…¥å€¼ã€‚ä¸åŒçš„äº‹ä»¶ï¼Œå…¶ä¸ŠæŠ¥äº‹ä»¶çš„ API å‡½æ•°ä¸åŒã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”¨äºä¸ŠæŠ¥æŒ‡å®šäº‹ä»¶ä»¥åŠå¯¹åº”çš„å€¼</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_event</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="comment">//devéœ€è¦ä¸ŠæŠ¥inputdev</span></span></span><br><span class="line"><span class="params">                 <span class="type">unsigned</span> <span class="type">int</span> type,<span class="comment">//ä¸ŠæŠ¥çš„äº‹ä»¶ç±»å‹å¦‚EV_KEY</span></span></span><br><span class="line"><span class="params">                 <span class="type">unsigned</span> <span class="type">int</span> code,<span class="comment">//äº‹ä»¶ç ä¹Ÿå°±æ˜¯æ³¨å†Œçš„é”®å€¼</span></span></span><br><span class="line"><span class="params">                 <span class="type">int</span> value)</span><span class="comment">//äº‹ä»¶å€¼</span></span><br></pre></td></tr></table></figure><p>nput_event å‡½æ•°å¯ä»¥ä¸ŠæŠ¥æ‰€æœ‰çš„äº‹ä»¶ç±»å‹å’Œäº‹ä»¶å€¼ï¼Œ Linux å†…æ ¸ä¹Ÿæä¾›äº†å…¶ä»–çš„é’ˆå¯¹å…·ä½“äº‹ä»¶çš„ä¸ŠæŠ¥å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å…¶å®éƒ½ç”¨åˆ°äº† input_event å‡½æ•°ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">input_report_key</span><span class="params">(<span class="keyword">struct</span> input_dev *dev,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">input_event(dev, EV_KEY, code, !!value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„è¿˜æœ‰ä¸€äº›å…¶ä»–çš„äº‹ä»¶ä¸ŠæŠ¥å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_report_rel</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_report_abs</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_report_ff_status</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_report_switch</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_mt_sync</span><span class="params">(<span class="keyword">struct</span> input_dev *dev)</span></span><br></pre></td></tr></table></figure><p>ä¸ŠæŠ¥äº‹ä»¶ä»¥åè¿˜éœ€è¦ä½¿ç”¨ input_sync å‡½æ•°æ¥å‘Šè¯‰ Linux å†…æ ¸ input å­ç³»ç»Ÿä¸ŠæŠ¥ç»“æŸï¼Œinput_sync å‡½æ•°æœ¬è´¨æ˜¯ä¸ŠæŠ¥ä¸€ä¸ªåŒæ­¥äº‹ä»¶ï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_sync</span><span class="params">(<span class="keyword">struct</span> input_dev *dev)</span><span class="comment">//devéœ€è¦ä¸ŠæŠ¥çš„åŒæ­¥äº‹ä»¶çš„input_dev</span></span><br></pre></td></tr></table></figure><p>egï¼šæŒ‰é”®çš„ä¸ŠæŠ¥äº‹ä»¶ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç”¨äºæŒ‰é”®æ¶ˆæŠ–çš„å®šæ—¶å™¨æœåŠ¡å‡½æ•° */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_function</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> value;</span><br><span class="line"> </span><br><span class="line">value = gpio_get_value(keydesc-&gt;gpio); <span class="comment">/* è¯»å– IO å€¼ */</span></span><br><span class="line"><span class="keyword">if</span>(value == <span class="number">0</span>)&#123; <span class="comment">/* æŒ‰ä¸‹æŒ‰é”® */</span></span><br><span class="line"><span class="comment">/* ä¸ŠæŠ¥æŒ‰é”®å€¼ */</span></span><br><span class="line">    input_report_key(inputdev, KEY_0, <span class="number">1</span>); <span class="comment">/* æœ€åä¸€ä¸ªå‚æ•° 1ï¼Œ æŒ‰ä¸‹ */</span></span><br><span class="line">        input_sync(inputdev); <span class="comment">/* åŒæ­¥äº‹ä»¶ */</span></span><br><span class="line"> &#125; <span class="keyword">else</span> &#123; <span class="comment">/* æŒ‰é”®æ¾å¼€ */</span></span><br><span class="line">input_report_key(inputdev, KEY_0, <span class="number">0</span>); <span class="comment">/* æœ€åä¸€ä¸ªå‚æ•° 0ï¼Œ æ¾å¼€ */</span></span><br><span class="line">input_sync(inputdev); <span class="comment">/* åŒæ­¥äº‹ä»¶ */</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Linux å†…æ ¸ä½¿ç”¨ input_event è¿™ä¸ªç»“æ„ä½“æ¥è¡¨ç¤ºæ‰€æœ‰çš„è¾“å…¥äº‹ä»¶ï¼Œ input_envent ç»“æ„ä½“å®šä¹‰åœ¨include&#x2F;uapi&#x2F;linux&#x2F;input.h æ–‡ä»¶ä¸­ï¼Œç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">time</span>;</span><span class="comment">//æ­¤äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´</span></span><br><span class="line">__u16 type;<span class="comment">//äº‹ä»¶ç±»å‹</span></span><br><span class="line">__u16 code;<span class="comment">//äº‹ä»¶ç </span></span><br><span class="line">__s32 value;<span class="comment">//æŒ‰é”®å€¼</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…³äºæ—¶é—´timevalçš„ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span><span class="type">long</span><span class="type">__kernel_long_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">__kernel_long_t</span><span class="type">__kernel_time_t</span>;</span><br><span class="line"><span class="keyword">typedef</span><span class="type">__kernel_long_t</span><span class="type">__kernel_suseconds_t</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span>&#123;</span></span><br><span class="line">  <span class="type">__kernel_time_t</span>tv_sec;<span class="comment">//ç§’  </span></span><br><span class="line"><span class="type">__kernel_suseconds_t</span>tv_usec;<span class="comment">//å¾®ç§’</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Linux-è‡ªå¸¦æŒ‰é”®é©±åŠ¨ç¨‹åºçš„ä½¿ç”¨"><a href="#Linux-è‡ªå¸¦æŒ‰é”®é©±åŠ¨ç¨‹åºçš„ä½¿ç”¨" class="headerlink" title="Linux è‡ªå¸¦æŒ‰é”®é©±åŠ¨ç¨‹åºçš„ä½¿ç”¨"></a>Linux è‡ªå¸¦æŒ‰é”®é©±åŠ¨ç¨‹åºçš„ä½¿ç”¨</h3><p>ç¼–è¯‘å†…æ ¸make menuconfig</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-08%20160716.png"></p><p>ä½¿ ç”¨ Linux å†… æ ¸ è‡ª å¸¦ çš„ æŒ‰ é”® é©± åŠ¨ ç¨‹ åº æ·»åŠ è®¾å¤‡èŠ‚ç‚¹ã€‚</p><p>â‘ ã€èŠ‚ç‚¹åå­—ä¸ºâ€œgpio-keysâ€ã€‚<br>â‘¡ã€ gpio-keys èŠ‚ç‚¹çš„ compatible å±æ€§å€¼ä¸€å®šè¦è®¾ç½®ä¸ºâ€œgpio-keysâ€ã€‚<br>â‘¢ã€æ‰€æœ‰çš„ KEY éƒ½æ˜¯ gpio-keys çš„å­èŠ‚ç‚¹ï¼Œæ¯ä¸ªå­èŠ‚ç‚¹å¯ä»¥ç”¨å¦‚ä¸‹å±æ€§æè¿°è‡ªå·±ï¼š<br>gpiosï¼š KEY æ‰€è¿æ¥çš„ GPIO ä¿¡æ¯ã€‚<br>interruptsï¼š KEY æ‰€ä½¿ç”¨ GPIO ä¸­æ–­ä¿¡æ¯ï¼Œä¸æ˜¯å¿…é¡»çš„ï¼Œå¯ä»¥ä¸å†™ã€‚<br>labelï¼š KEY åå­—<br>linux,codeï¼š KEY è¦æ¨¡æ‹Ÿçš„æŒ‰é”®ï¼Œä¹Ÿå°±æ˜¯ç¤ºä¾‹ä»£ç  58.1.2.4 ä¸­çš„è¿™äº›æŒ‰é”®ã€‚<br>â‘£ã€å¦‚æœæŒ‰é”®è¦æ”¯æŒè¿æŒ‰çš„è¯è¦åŠ å…¥ autorepeatã€‚<br> <strong>gpio-keys èŠ‚ç‚¹å†…å®¹</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gpio-keys &#123;</span><br><span class="line">compatible = <span class="string">&quot;gpio-keys&quot;</span>;</span><br><span class="line"><span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">autorepeat;</span><br><span class="line">key0 &#123;</span><br><span class="line">label = <span class="string">&quot;GPIO Key Enter&quot;</span>;</span><br><span class="line">linux,code = &lt;KEY_ENTER&gt;;</span><br><span class="line">gpios = &lt;&amp;gpio1 <span class="number">18</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MISCè®¾å¤‡é©±åŠ¨</title>
      <link href="/2023/07/07/2023-7-7-MISC%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/07/2023-7-7-MISC%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="MISCé©±åŠ¨"><a href="#MISCé©±åŠ¨" class="headerlink" title="MISCé©±åŠ¨"></a>MISCé©±åŠ¨</h2><p>æ‰€æœ‰çš„ MISC è®¾å¤‡é©±åŠ¨çš„ä¸»è®¾å¤‡å·éƒ½ä¸º 10ï¼Œä¸åŒçš„è®¾å¤‡ä½¿ç”¨ä¸åŒçš„ä»è®¾å¤‡å·ã€‚ MISC è®¾å¤‡ä¼šè‡ªåŠ¨åˆ›å»º cdevï¼Œä¸éœ€è¦åƒæ‰‹åŠ¨åˆ›å»ºï¼Œå› æ­¤é‡‡ç”¨ MISC è®¾å¤‡é©±åŠ¨å¯ä»¥ç®€åŒ–å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„ç¼–å†™ã€‚ éœ€è¦å‘ Linux æ³¨å†Œä¸€ä¸ª miscdevice è®¾å¤‡ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> &#123;</span></span><br><span class="line"><span class="type">int</span> minor; <span class="comment">/* å­è®¾å¤‡å· */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name; <span class="comment">/* è®¾å¤‡åå­— */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">fops</span>;</span> <span class="comment">/* è®¾å¤‡æ“ä½œé›† */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">parent</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">this_device</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *nodename;</span><br><span class="line"><span class="type">umode_t</span> mode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Linux ç³»ç»Ÿå·²ç»é¢„å®šä¹‰äº†ä¸€äº› MISC è®¾å¤‡çš„å­è®¾å¤‡å·ï¼Œè¿™äº›é¢„å®šä¹‰çš„å­è®¾å¤‡å·å®šä¹‰åœ¨include&#x2F;linux&#x2F;miscdevice.h æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span> <span class="meta">#<span class="keyword">define</span> PSMOUSE_MINOR 1</span></span><br><span class="line"><span class="number">14</span> <span class="meta">#<span class="keyword">define</span> MS_BUSMOUSE_MINOR 2 <span class="comment">/* unused */</span></span></span><br><span class="line"><span class="number">15</span> <span class="meta">#<span class="keyword">define</span> ATIXL_BUSMOUSE_MINOR 3 <span class="comment">/* unused */</span></span></span><br><span class="line"><span class="number">16</span> <span class="comment">/*#define AMIGAMOUSE_MINOR 4 FIXME OBSOLETE */</span></span><br><span class="line"><span class="number">17</span> <span class="meta">#<span class="keyword">define</span> ATARIMOUSE_MINOR 5 <span class="comment">/* unused */</span></span></span><br><span class="line"><span class="number">18</span> <span class="meta">#<span class="keyword">define</span> SUN_MOUSE_MINOR 6 <span class="comment">/* unused */</span></span></span><br><span class="line">......</span><br><span class="line"><span class="number">52</span> <span class="meta">#<span class="keyword">define</span> MISC_DYNAMIC_MINOR 255</span></span><br></pre></td></tr></table></figure><p>æ³¨å†Œå’Œåˆ é™¤è®¾å¤‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">misc_register</span><span class="params">(<span class="keyword">struct</span> miscdevice * misc)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">misc_deregister</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span></span><br></pre></td></tr></table></figure><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_address.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> misc_beepname <span class="string">&quot;miscbeep&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>beep_minor144</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>BEEPON1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>BEEPOFF0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscbeep_dev</span>&#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span></span><br><span class="line"><span class="type">int</span> beep_gpio;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscbeep_dev</span> <span class="title">miscbeep</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">misc_beep_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">filp -&gt; private_data = &amp;miscbeep;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">misc_beep_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt,<span class="type">loff_t</span> *offt )</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> retvalue;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">1</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> state;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscbeep_dev</span> *<span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line">retvalue = copy_from_user(databuf, buf, cnt);</span><br><span class="line"><span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;can&#x27;t find user&#x27;s data\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">&#125;</span><br><span class="line">state = databuf[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(state == BEEPON)</span><br><span class="line">&#123;</span><br><span class="line">gpio_set_value(dev-&gt;beep_gpio, <span class="number">0</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(state == BEEPOFF)</span><br><span class="line">&#123;</span><br><span class="line">gpio_set_value(dev-&gt;beep_gpio, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">misc_beep_fops</span> =</span> &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.open = misc_beep_open,</span><br><span class="line">.write = misc_beep_write,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">beep_miscdev</span> =</span> &#123;</span><br><span class="line">.minor = beep_minor,</span><br><span class="line">.name = misc_beepname,</span><br><span class="line">.fops = &amp;misc_beep_fops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">miscbeep_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">printk(<span class="string">&quot;beep driver and device have matched\r\n&quot;</span>);</span><br><span class="line">miscbeep.nd = of_find_node_by_path(<span class="string">&quot;/beep&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(miscbeep.nd == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;beep node can&#x27;t find\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">miscbeep.beep_gpio = of_get_named_gpio(miscbeep.nd, <span class="string">&quot;beep-gpio&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(miscbeep.beep_gpio &lt; <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;can&#x27;t get beep-gpio\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">ret = gpio_direction_output(miscbeep.beep_gpio, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;misc device register failed!\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">&#125;</span><br><span class="line">ret = misc_register(&amp;beep_miscdev);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;misc device register failed\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">miscbeep_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">gpio_set_value(miscbeep.beep_gpio, <span class="number">1</span>);</span><br><span class="line">gpio_free(miscbeep.beep_gpio);<span class="comment">//å°†ç¡¬ä»¶èµ„æºè¿˜ç»™linuxå†…æ ¸</span></span><br><span class="line">misc_deregister(&amp;beep_miscdev);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">beep_of_match</span>[] =</span> &#123;</span><br><span class="line">&#123;.compatible = <span class="string">&quot;atkalpha-beep&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="comment">/*empty*/</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">beep_driver</span> =</span> &#123;</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = <span class="string">&quot;imx6ul-beep&quot;</span>,</span><br><span class="line">.of_match_table = beep_of_match,</span><br><span class="line">&#125;,</span><br><span class="line">.probe = miscbeep_probe,</span><br><span class="line">.remove = miscbeep_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">miscbeep_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> platform_driver_register(&amp;beep_driver);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">miscbeep_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">platform_driver_unregister(&amp;beep_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(miscbeep_init);</span><br><span class="line">module_exit(miscbeep_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾å¤‡æ ‘ä¸‹çš„platformè®¾å¤‡é©±åŠ¨</title>
      <link href="/2023/07/06/2023-7-6-%E8%AE%BE%E5%A4%87%E6%A0%91%E4%B8%8B%E7%9A%84platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/06/2023-7-6-%E8%AE%BE%E5%A4%87%E6%A0%91%E4%B8%8B%E7%9A%84platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨"><a href="#è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨" class="headerlink" title="è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨"></a>è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨</h2><p>åœ¨ä½¿ç”¨è®¾å¤‡æ ‘çš„æ—¶å€™ï¼Œè®¾å¤‡çš„æè¿°è¢«æ”¾åˆ°äº†è®¾å¤‡æ ‘ä¸­ï¼Œå› æ­¤ platform_device å°±ä¸éœ€è¦æˆ‘ä»¬å»ç¼–å†™äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° platform_driver å³å¯ ã€‚</p><h3 id="1-åˆ›å»ºè®¾å¤‡æ ‘ä¸­è®¾å¤‡èŠ‚ç‚¹"><a href="#1-åˆ›å»ºè®¾å¤‡æ ‘ä¸­è®¾å¤‡èŠ‚ç‚¹" class="headerlink" title="1.åˆ›å»ºè®¾å¤‡æ ‘ä¸­è®¾å¤‡èŠ‚ç‚¹"></a>1.åˆ›å»ºè®¾å¤‡æ ‘ä¸­è®¾å¤‡èŠ‚ç‚¹</h3><p>platform æ€»çº¿éœ€è¦é€šè¿‡è®¾å¤‡èŠ‚ç‚¹çš„ compatible å±æ€§å€¼æ¥åŒ¹é…é©±åŠ¨ï¼ ä»¥ledè®¾å¤‡ä¸ºä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gpioled&#123;</span><br><span class="line">   <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">    <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">    compatible = <span class="string">&quot;atkalpha-gpioled&quot;</span>;<span class="comment">//åŒ¹é…çš„å±æ€§</span></span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_led&gt;;</span><br><span class="line">    led-gpio = &lt;&amp;gpio1 <span class="number">3</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;ï¼›</span><br></pre></td></tr></table></figure><h3 id="2-ç¼–å†™platformé©±åŠ¨æ—¶å€™è¦æ³¨æ„å…¼å®¹å±æ€§"><a href="#2-ç¼–å†™platformé©±åŠ¨æ—¶å€™è¦æ³¨æ„å…¼å®¹å±æ€§" class="headerlink" title="2.ç¼–å†™platformé©±åŠ¨æ—¶å€™è¦æ³¨æ„å…¼å®¹å±æ€§"></a>2.ç¼–å†™platformé©±åŠ¨æ—¶å€™è¦æ³¨æ„å…¼å®¹å±æ€§</h3><p>åœ¨ä½¿ç”¨è®¾å¤‡æ ‘çš„æ—¶å€™ platform é©±åŠ¨ä¼šé€šè¿‡ of_match_table æ¥ä¿å­˜å…¼å®¹æ€§å€¼ï¼Œä¹Ÿå°±æ˜¯è¡¨æ˜æ­¤é©±åŠ¨å…¼å®¹å“ªäº›è®¾å¤‡ã€‚æ‰€ä»¥ï¼Œ of_match_table å°†ä¼šå°¤ä¸ºé‡è¦ï¼Œæ¯”å¦‚æœ¬ä¾‹ç¨‹çš„ platform é©±åŠ¨ä¸­ platform_driver å°±å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ‰€ç¤ºè®¾ç½®ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">leds_of_match</span>[] =</span> &#123;</span><br><span class="line">&#123; .compatible = <span class="string">&quot;atkalpha-gpioled&quot;</span> &#125;, <span class="comment">/* å…¼å®¹å±æ€§ */</span></span><br><span class="line">&#123; <span class="comment">/* Sentinel */</span> &#125;<span class="comment">//åœ¨ç¼–å†™ of_device_id çš„æ—¶å€™æœ€åä¸€ä¸ªå…ƒç´ ä¸€å®šè¦ä¸ºç©ºï¼</span></span><br><span class="line">&#125;;<span class="comment">/*of_device_id è¡¨ï¼Œä¹Ÿå°±æ˜¯é©±åŠ¨çš„å…¼å®¹è¡¨ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ ä¸º of_device_idç±»å‹ã€‚æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå…¼å®¹å±æ€§ï¼Œè¡¨ç¤ºå…¼å®¹çš„è®¾å¤‡ï¼Œä¸€ä¸ªé©±åŠ¨å¯ä»¥è·Ÿå¤šä¸ªè®¾å¤‡åŒ¹é…ã€‚*/</span></span><br><span class="line">MODULE_DEVICE_TABLE(of, leds_of_match);<span class="comment">// å£°æ˜ä¸€ä¸‹ leds_of_match è¿™ä¸ªè®¾å¤‡åŒ¹é…è¡¨ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">leds_platform_driver</span> =</span> &#123;</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = <span class="string">&quot;imx6ul-led&quot;</span>,</span><br><span class="line">    .of_match_table = leds_of_match,<span class="comment">//è®¾ç½®ä¸ºä¸Šé¢çš„åŒ¹é…è¡¨</span></span><br><span class="line">&#125;,</span><br><span class="line">    .probe = leds_probe,</span><br><span class="line">.remove = leds_remove,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDDEV_CNT1<span class="comment">/* è®¾å¤‡å·é•¿åº¦ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDDEV_NAME<span class="string">&quot;dtsplatled&quot;</span><span class="comment">/* è®¾å¤‡åå­— */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDOFF 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDON 1</span></span><br><span class="line"><span class="comment">/* leddevè®¾å¤‡ç»“æ„ä½“ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">leddev_dev</span>&#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;<span class="comment">/* è®¾å¤‡å·*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span><span class="comment">/* cdev*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span><span class="comment">/* ç±» */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span><span class="comment">/* è®¾å¤‡*/</span></span><br><span class="line"><span class="type">int</span> major;<span class="comment">/* ä¸»è®¾å¤‡å·*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">node</span>;</span><span class="comment">/* LEDè®¾å¤‡èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="type">int</span> led0;<span class="comment">/* LEDç¯GPIOæ ‡å· */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">leddev_dev</span> <span class="title">leddev</span>;</span> <span class="comment">/* ledè®¾å¤‡ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: LEDæ‰“å¼€/å…³é—­</span></span><br><span class="line"><span class="comment"> * @param - sta : LEDON(0) æ‰“å¼€LEDï¼ŒLEDOFF(1) å…³é—­LED</span></span><br><span class="line"><span class="comment"> * @return : æ— </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">led0_switch</span><span class="params">(u8 sta)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (sta == LEDON )</span><br><span class="line">gpio_set_value(leddev.led0, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (sta == LEDOFF)</span><br><span class="line">gpio_set_value(leddev.led0, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: æ‰“å¼€è®¾å¤‡</span></span><br><span class="line"><span class="comment"> * @param - inode : ä¼ é€’ç»™é©±åŠ¨çš„inode</span></span><br><span class="line"><span class="comment"> * @param - filp : è®¾å¤‡æ–‡ä»¶ï¼Œfileç»“æ„ä½“æœ‰ä¸ªå«åšprivate_dataçš„æˆå‘˜å˜é‡</span></span><br><span class="line"><span class="comment"> *   ä¸€èˆ¬åœ¨opençš„æ—¶å€™å°†private_dataæŒ‡å‘è®¾å¤‡ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="comment"> * @return : 0 æˆåŠŸ;å…¶ä»– å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">filp-&gt;private_data = &amp;leddev; <span class="comment">/* è®¾ç½®ç§æœ‰æ•°æ®  */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: å‘è®¾å¤‡å†™æ•°æ® </span></span><br><span class="line"><span class="comment"> * @param - filp : è®¾å¤‡æ–‡ä»¶ï¼Œè¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment"> * @param - buf : è¦å†™ç»™è®¾å¤‡å†™å…¥çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> * @param - cnt : è¦å†™å…¥çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment"> * @param - offt : ç›¸å¯¹äºæ–‡ä»¶é¦–åœ°å€çš„åç§»</span></span><br><span class="line"><span class="comment"> * @return : å†™å…¥çš„å­—èŠ‚æ•°ï¼Œå¦‚æœä¸ºè´Ÿå€¼ï¼Œè¡¨ç¤ºå†™å…¥å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> retvalue;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">2</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> ledstat;</span><br><span class="line"></span><br><span class="line">retvalue = copy_from_user(databuf, buf, cnt);</span><br><span class="line"><span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;kernel write failed!\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ledstat = databuf[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (ledstat == LEDON) &#123;</span><br><span class="line">led0_switch(LEDON);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (ledstat == LEDOFF) &#123;</span><br><span class="line">led0_switch(LEDOFF);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾å¤‡æ“ä½œå‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">led_fops</span> =</span> &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.open = led_open,</span><br><span class="line">.write = led_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: flatformé©±åŠ¨çš„probeå‡½æ•°ï¼Œå½“é©±åŠ¨ä¸</span></span><br><span class="line"><span class="comment"> *   è®¾å¤‡åŒ¹é…ä»¥åæ­¤å‡½æ•°å°±ä¼šæ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> * @param - dev : platformè®¾å¤‡</span></span><br><span class="line"><span class="comment"> * @return : 0ï¼ŒæˆåŠŸ;å…¶ä»–è´Ÿå€¼,å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;led driver and device was matched!\r\n&quot;</span>);</span><br><span class="line"><span class="comment">/* 1ã€è®¾ç½®è®¾å¤‡å· */</span></span><br><span class="line"><span class="keyword">if</span> (leddev.major) &#123;</span><br><span class="line">leddev.devid = MKDEV(leddev.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(leddev.devid, LEDDEV_CNT, LEDDEV_NAME);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">alloc_chrdev_region(&amp;leddev.devid, <span class="number">0</span>, LEDDEV_CNT, LEDDEV_NAME);</span><br><span class="line">leddev.major = MAJOR(leddev.devid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2ã€æ³¨å†Œè®¾å¤‡      */</span></span><br><span class="line">cdev_init(&amp;leddev.cdev, &amp;led_fops);</span><br><span class="line">cdev_add(&amp;leddev.cdev, leddev.devid, LEDDEV_CNT);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3ã€åˆ›å»ºç±»      */</span></span><br><span class="line">leddev.class = class_create(THIS_MODULE, LEDDEV_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(leddev.class)) &#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(leddev.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4ã€åˆ›å»ºè®¾å¤‡ */</span></span><br><span class="line">leddev.device = device_create(leddev.class, <span class="literal">NULL</span>, leddev.devid, <span class="literal">NULL</span>, LEDDEV_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(leddev.device)) &#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(leddev.device);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5ã€åˆå§‹åŒ–IO */</span></span><br><span class="line">leddev.node = of_find_node_by_path(<span class="string">&quot;/gpioled&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (leddev.node == <span class="literal">NULL</span>)&#123;</span><br><span class="line">printk(<span class="string">&quot;gpioled node nost find!\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">leddev.led0 = of_get_named_gpio(leddev.node, <span class="string">&quot;led-gpio&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (leddev.led0 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">printk(<span class="string">&quot;can&#x27;t get led-gpio\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gpio_request(leddev.led0, <span class="string">&quot;led0&quot;</span>);</span><br><span class="line">gpio_direction_output(leddev.led0, <span class="number">1</span>); <span class="comment">/* led0 IOè®¾ç½®ä¸ºè¾“å‡ºï¼Œé»˜è®¤é«˜ç”µå¹³*/</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: platformé©±åŠ¨çš„removeå‡½æ•°ï¼Œç§»é™¤platformé©±åŠ¨çš„æ—¶å€™æ­¤å‡½æ•°ä¼šæ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> * @param - dev : platformè®¾å¤‡</span></span><br><span class="line"><span class="comment"> * @return : 0ï¼ŒæˆåŠŸ;å…¶ä»–è´Ÿå€¼,å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">gpio_set_value(leddev.led0, <span class="number">1</span>); <span class="comment">/* å¸è½½é©±åŠ¨çš„æ—¶å€™å…³é—­LED */</span></span><br><span class="line">gpio_free(leddev.led0);<span class="comment">/* é‡Šæ”¾IO */</span></span><br><span class="line"></span><br><span class="line">cdev_del(&amp;leddev.cdev);<span class="comment">/*  åˆ é™¤cdev */</span></span><br><span class="line">unregister_chrdev_region(leddev.devid, LEDDEV_CNT); <span class="comment">/* æ³¨é”€è®¾å¤‡å· */</span></span><br><span class="line">device_destroy(leddev.class, leddev.devid);</span><br><span class="line">class_destroy(leddev.class);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åŒ¹é…åˆ—è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">led_of_match</span>[] =</span> &#123;</span><br><span class="line">&#123; .compatible = <span class="string">&quot;atkalpha-gpioled&quot;</span> &#125;,</span><br><span class="line">&#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* platformé©±åŠ¨ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">led_driver</span> =</span> &#123;</span><br><span class="line">.driver= &#123;</span><br><span class="line">.name= <span class="string">&quot;imx6ul-led&quot;</span>,<span class="comment">/* é©±åŠ¨åå­—ï¼Œç”¨äºå’Œè®¾å¤‡åŒ¹é… */</span></span><br><span class="line">.of_match_table= led_of_match, <span class="comment">/* è®¾å¤‡æ ‘åŒ¹é…è¡¨  */</span></span><br><span class="line">&#125;,</span><br><span class="line">.probe= led_probe,</span><br><span class="line">.remove= led_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: é©±åŠ¨æ¨¡å—åŠ è½½å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param : æ— </span></span><br><span class="line"><span class="comment"> * @return : æ— </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">leddriver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> platform_driver_register(&amp;led_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: é©±åŠ¨æ¨¡å—å¸è½½å‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param : æ— </span></span><br><span class="line"><span class="comment"> * @return : æ— </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">leddriver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">platform_driver_unregister(&amp;led_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(leddriver_init);</span><br><span class="line">module_exit(leddriver_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;zuozhongkai&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>platformè®¾å¤‡é©±åŠ¨</title>
      <link href="/2023/07/03/2023-7-3-platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/07/03/2023-7-3-platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="é©±åŠ¨æ¡†æ¶"><a href="#é©±åŠ¨æ¡†æ¶" class="headerlink" title="é©±åŠ¨æ¡†æ¶"></a>é©±åŠ¨æ¡†æ¶</h2><h4 id="ä¼ ç»Ÿé©±åŠ¨æ¡†æ¶"><a href="#ä¼ ç»Ÿé©±åŠ¨æ¡†æ¶" class="headerlink" title="ä¼ ç»Ÿé©±åŠ¨æ¡†æ¶"></a>ä¼ ç»Ÿé©±åŠ¨æ¡†æ¶</h4><p>å‡å¦‚ç°åœ¨æœ‰ä¸‰ä¸ªå¹³å° Aã€ B å’Œ Cï¼Œè¿™ä¸‰ä¸ªå¹³å°(è¿™é‡Œçš„å¹³å°è¯´çš„æ˜¯ SOC)ä¸Šéƒ½æœ‰ MPU6050 è¿™ä¸ª I2Cæ¥å£çš„å…­è½´ä¼ æ„Ÿå™¨ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-03%20144925.png"></p><p>æ¯ç§å¹³å°ä¸‹éƒ½æœ‰ä¸€ä¸ªä¸»æœºé©±åŠ¨å’Œè®¾å¤‡é©±åŠ¨ï¼Œä¸»æœºé©±åŠ¨è‚¯å®šæ˜¯å¿…é¡»è¦çš„ï¼Œæ¯•ç«Ÿä¸åŒçš„å¹³å°å…¶ I2C æ§åˆ¶å™¨ä¸åŒã€‚ä½†æ˜¯å³ä¾§çš„è®¾å¤‡é©±åŠ¨å°±æ²¡å¿…è¦æ¯ä¸ªå¹³å°éƒ½å†™ä¸€ä¸ªï¼Œå› ä¸ºä¸ç®¡å¯¹äºé‚£ä¸ª SOC æ¥è¯´ï¼Œ MPU6050 éƒ½æ˜¯ä¸€æ ·ï¼Œé€šè¿‡ I2C æ¥å£è¯»å†™æ•°æ®å°±è¡Œäº†ï¼Œåªéœ€è¦ä¸€ä¸ª MPU6050 çš„é©±åŠ¨ç¨‹åºå³å¯ã€‚ </p><h3 id="åˆ†ç¦»åçš„é©±åŠ¨æ¡†æ¶"><a href="#åˆ†ç¦»åçš„é©±åŠ¨æ¡†æ¶" class="headerlink" title="åˆ†ç¦»åçš„é©±åŠ¨æ¡†æ¶"></a>åˆ†ç¦»åçš„é©±åŠ¨æ¡†æ¶</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-03%20145117.png"></p><p>ç›¸å½“äºå°†è®¾å¤‡ä¿¡æ¯ä»è®¾å¤‡é©±åŠ¨ä¸­å‰¥ç¦»å¼€æ¥ï¼Œé©±åŠ¨ä½¿ç”¨æ ‡å‡†æ–¹æ³•å»è·å–åˆ°è®¾å¤‡ä¿¡æ¯(æ¯”å¦‚ä»è®¾å¤‡æ ‘ä¸­è·å–åˆ°è®¾å¤‡ä¿¡æ¯)ï¼Œç„¶åæ ¹æ®è·å–åˆ°çš„è®¾å¤‡ä¿¡æ¯æ¥åˆå§‹åŒ–è®¾å¤‡ã€‚ è¿™æ ·å°±ç›¸å½“äºé©±åŠ¨åªè´Ÿè´£é©±åŠ¨ï¼Œè®¾å¤‡åªè´Ÿè´£è®¾å¤‡ï¼Œæƒ³åŠæ³•å°†ä¸¤è€…è¿›è¡ŒåŒ¹é…å³å¯ã€‚è¿™ä¸ªå°±æ˜¯ Linux ä¸­çš„æ€»çº¿(bus)ã€é©±åŠ¨(driver)å’Œè®¾å¤‡(device)æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„é©±åŠ¨åˆ†ç¦»ã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-07-03%20145316.png"></p><h2 id="platform"><a href="#platform" class="headerlink" title="platform"></a>platform</h2><h3 id="platformæ€»çº¿"><a href="#platformæ€»çº¿" class="headerlink" title="platformæ€»çº¿"></a>platformæ€»çº¿</h3><p>paltformæ˜¯ä¸€ç§è™šæ‹Ÿçš„æ€»çº¿ï¼Œç”¨äºç®¡ç†å¤–è®¾èµ„æº<a href="https://so.csdn.net/so/search?q=%E5%86%85%E5%AD%98&spm=1001.2101.3001.7020">å†…å­˜</a>èµ„æºä¸­æ–­èµ„æºã€‚åœ¨ç¡¬ä»¶ä¸Šæœ‰USB-BUSæ€»çº¿ï¼ŒPCI-BUSæ€»çº¿ï¼Œè¿™æ˜¯åœ¨ç‰©ç†è®¾å¤‡ä¸Šå®é™…å­˜åœ¨çš„æ€»çº¿ã€‚USB-BUSç®¡ç†USBè®¾å¤‡ï¼ŒPCIæ€»çº¿ç®¡ç†PCIè®¾å¤‡ã€‚ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œä¸€äº›è®¾å¤‡ä¸å±äºè¿™äº›æ€»çº¿ï¼Œä¸€äº›SOCä¸Šé¢çš„æ§åˆ¶å™¨æˆ–è€…è®¾å¤‡ã€‚ä½¿ç”¨platformç»Ÿä¸€ç®¡ç†è¿™äº›è®¾å¤‡ã€‚</p><p>Linuxç³»ç»Ÿå†…æ ¸ä½¿ç”¨bus_typeç»“æ„ä½“è¡¨ç¤ºæ€»çº¿</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> &#123;</span></span><br><span class="line"><span class="number">2</span> <span class="type">const</span> <span class="type">char</span> *name; <span class="comment">/* æ€»çº¿åå­— */</span></span><br><span class="line"><span class="number">3</span> <span class="type">const</span> <span class="type">char</span> *dev_name;</span><br><span class="line"><span class="number">4</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev_root</span>;</span></span><br><span class="line"><span class="number">5</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> *<span class="title">dev_attrs</span>;</span></span><br><span class="line"><span class="number">6</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">bus_groups</span>;</span> <span class="comment">/* æ€»çº¿å±æ€§ */</span></span><br><span class="line"><span class="number">7</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">dev_groups</span>;</span> <span class="comment">/* è®¾å¤‡å±æ€§ */</span></span><br><span class="line"><span class="number">8</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">drv_groups</span>;</span> <span class="comment">/* é©±åŠ¨å±æ€§ */</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span> <span class="type">int</span> (*match)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv);<span class="comment">//å®Œæˆè®¾å¤‡å’Œé©±åŠ¨ä¹‹é—´çš„åŒ¹é…</span></span><br><span class="line"><span class="number">11</span> <span class="type">int</span> (*uevent)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> kobj_uevent_env *env);</span><br><span class="line"><span class="number">12</span> <span class="type">int</span> (*probe)(<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="number">13</span> <span class="type">int</span> (*remove)(<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="number">14</span> <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> <span class="type">int</span> (*online)(<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="number">17</span> <span class="type">int</span> (*offline)(<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="number">18</span> <span class="type">int</span> (*suspend)(<span class="keyword">struct</span> device *dev, <span class="type">pm_message_t</span> state);</span><br><span class="line"><span class="number">19</span> <span class="type">int</span> (*resume)(<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="number">20</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span></span><br><span class="line"><span class="number">21</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iommu_ops</span> *<span class="title">iommu_ops</span>;</span></span><br><span class="line"><span class="number">22</span> <span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">p</span>;</span></span><br><span class="line"><span class="number">23</span> <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">lock_key</span>;</span></span><br><span class="line"><span class="number">24</span> &#125;;</span><br></pre></td></tr></table></figure><p>æ€»çº¿å°±æ˜¯ä½¿ç”¨ match å‡½æ•°æ¥æ ¹æ®æ³¨å†Œçš„è®¾å¤‡æ¥æŸ¥æ‰¾å¯¹åº”çš„é©±åŠ¨ï¼Œæˆ–è€…æ ¹æ®æ³¨å†Œçš„é©±åŠ¨æ¥æŸ¥æ‰¾ç›¸åº”çš„è®¾å¤‡ï¼Œå› æ­¤æ¯ä¸€æ¡æ€»çº¿éƒ½å¿…é¡»å®ç°æ­¤å‡½æ•°ã€‚ match å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼š dev å’Œ drvï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸º device å’Œ device_driver ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è®¾å¤‡å’Œé©±åŠ¨ã€‚ </p><p>platform æ€»çº¿ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> <span class="title">platform_bus_type</span> =</span> &#123;</span><br><span class="line"><span class="number">2</span> .name = <span class="string">&quot;platform&quot;</span>,</span><br><span class="line"><span class="number">3</span> .dev_groups = platform_dev_groups,</span><br><span class="line"><span class="number">4</span> .match = platform_match,</span><br><span class="line"><span class="number">5</span> .uevent = platform_uevent,</span><br><span class="line"><span class="number">6</span> .pm = &amp;platform_dev_pm_ops,</span><br><span class="line"><span class="number">7</span> &#125;;</span><br></pre></td></tr></table></figure><p>platform_bus_type å°±æ˜¯ platform å¹³å°æ€»çº¿ï¼Œå…¶ä¸­ platform_match å°±æ˜¯åŒ¹é…å‡½æ•°ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">platform_match</span><span class="params">(<span class="keyword">struct</span> device *dev,<span class="keyword">struct</span> device_driver *drv)</span></span><br><span class="line">2 &#123;</span><br><span class="line"><span class="number">3</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">pdev</span> =</span> to_platform_device(dev);</span><br><span class="line"><span class="number">4</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> *<span class="title">pdrv</span> =</span> to_platform_driver(drv);</span><br><span class="line"><span class="number">5</span> </span><br><span class="line"><span class="number">6</span><span class="comment">/*When driver_override is set,only bind to the matching driver*/</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">if</span> (pdev-&gt;driver_override)</span><br><span class="line"><span class="number">8</span> <span class="keyword">return</span> !<span class="built_in">strcmp</span>(pdev-&gt;driver_override, drv-&gt;name);</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span> <span class="comment">/* Attempt an OF style match first */</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">if</span> (of_driver_match_device(dev, drv))<span class="comment">//ofè®¾å¤‡æ ‘çš„åŒ¹é…æ¨¡å¼æ¯”è¾ƒæ¯ä¸ªè®¾å¤‡èŠ‚ç‚¹compatibleå±æ€§å’Œof_match_table</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span> <span class="comment">/* Then try ACPI style match */</span></span><br><span class="line"><span class="number">15</span> <span class="keyword">if</span> (acpi_driver_match_device(dev, drv))<span class="comment">//ACPIçš„åŒ¹é…æ¨¡å¼</span></span><br><span class="line"><span class="number">16</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="number">17</span></span><br><span class="line"><span class="number">18</span> <span class="comment">/* Then try to match against the id table */</span></span><br><span class="line"><span class="number">19</span> <span class="keyword">if</span> (pdrv-&gt;id_table)</span><br><span class="line"><span class="number">20</span> <span class="keyword">return</span> platform_match_id(pdrv-&gt;id_table, pdev) != <span class="literal">NULL</span>;<span class="comment">//id_tableåŒ¹é…</span></span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">22</span> <span class="comment">/* fall-back to driver name match */</span></span><br><span class="line"><span class="number">23</span> <span class="keyword">return</span> (<span class="built_in">strcmp</span>(pdev-&gt;name, drv-&gt;name) == <span class="number">0</span>);<span class="comment">//å¦‚æœidåŒ¹é…çš„ id_table ä¸å­˜åœ¨çš„è¯å°±æ¯”è¾ƒé©±åŠ¨å’Œè®¾å¤‡çš„ name å­—æ®µ</span></span><br><span class="line"><span class="number">24</span> &#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ”¯æŒè®¾å¤‡æ ‘çš„ Linux ç‰ˆæœ¬å·ï¼Œä¸€èˆ¬è®¾å¤‡é©±åŠ¨ä¸ºäº†å…¼å®¹æ€§éƒ½æ”¯æŒè®¾å¤‡æ ‘å’Œæ— è®¾å¤‡æ ‘ä¸¤ç§åŒ¹é…æ–¹å¼ã€‚<strong>ä¹Ÿå°±æ˜¯ç¬¬ä¸€ç§åŒ¹é…æ–¹å¼ä¸€èˆ¬éƒ½ä¼šå­˜åœ¨ï¼Œç¬¬ä¸‰ç§å’Œç¬¬å››ç§åªè¦å­˜åœ¨ä¸€ç§å°±å¯ä»¥</strong>ï¼Œä¸€èˆ¬ç”¨çš„æœ€å¤šçš„è¿˜æ˜¯ç¬¬å››ç§ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æ¯”è¾ƒé©±åŠ¨å’Œè®¾å¤‡çš„ name å­—æ®µï¼Œæ¯•ç«Ÿè¿™ç§æ–¹å¼æœ€ç®€å•äº†ã€‚ </p><p>platformé©±åŠ¨</p><p> platform_driver ç»“ æ„ ä½“ è¡¨ ç¤º platform  é©± åŠ¨ ï¼Œ æ­¤ ç»“ æ„ ä½“ å®š ä¹‰ åœ¨ æ–‡ ä»¶ include&#x2F;linux&#x2F;platform_device.h ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> &#123;</span></span><br><span class="line"><span class="number">2</span> <span class="type">int</span> (*probe)(<span class="keyword">struct</span> platform_device *);</span><br><span class="line"><span class="number">3</span> <span class="type">int</span> (*remove)(<span class="keyword">struct</span> platform_device *);</span><br><span class="line"><span class="number">4</span> <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> platform_device *);</span><br><span class="line"><span class="number">5</span> <span class="type">int</span> (*suspend)(<span class="keyword">struct</span> platform_device *, <span class="type">pm_message_t</span> state);</span><br><span class="line"><span class="number">6</span> <span class="type">int</span> (*resume)(<span class="keyword">struct</span> platform_device *);</span><br><span class="line"><span class="number">7</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> <span class="title">driver</span>;</span></span><br><span class="line"><span class="number">8</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device_id</span> *<span class="title">id_table</span>;</span></span><br><span class="line"><span class="number">9</span> <span class="type">bool</span> prevent_deferred_probe;</span><br><span class="line"><span class="number">10</span> &#125;;</span><br></pre></td></tr></table></figure><p>ç¬¬ 2 è¡Œï¼Œ probe å‡½æ•°ï¼Œå½“é©±åŠ¨ä¸è®¾å¤‡åŒ¹é…æˆåŠŸä»¥å probe å‡½æ•°å°±ä¼šæ‰§è¡Œï¼Œéå¸¸é‡è¦çš„å‡½æ•°ï¼ï¼<br>ä¸€èˆ¬é©±åŠ¨çš„æä¾›è€…ä¼šç¼–å†™ï¼Œå¦‚æœè‡ªå·±è¦ç¼–å†™ä¸€ä¸ªå…¨æ–°çš„é©±åŠ¨ï¼Œé‚£ä¹ˆ probe å°±éœ€è¦è‡ªè¡Œå®ç°ã€‚<br>ç¬¬ 7 è¡Œï¼Œ driver æˆå‘˜ï¼Œä¸º device_driver ç»“æ„ä½“å˜é‡ï¼Œ Linux å†…æ ¸é‡Œé¢å¤§é‡ä½¿ç”¨åˆ°äº†é¢å‘å¯¹è±¡çš„æ€ç»´ï¼Œ device_driver ç›¸å½“äºåŸºç±»ï¼Œæä¾›äº†æœ€åŸºç¡€çš„é©±åŠ¨æ¡†æ¶ã€‚ plaform_driver ç»§æ‰¿äº†è¿™ä¸ªåŸºç±»ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šåˆæ·»åŠ äº†ä¸€äº›ç‰¹æœ‰çš„æˆå‘˜å˜é‡ã€‚</p><p>ç¬¬ 8 è¡Œï¼Œ id_table è¡¨ï¼Œä¹Ÿå°±æ˜¯platform æ€»çº¿åŒ¹é…é©±åŠ¨å’Œè®¾å¤‡çš„æ—¶å€™é‡‡ç”¨çš„ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œ id_table æ˜¯ä¸ªè¡¨( ä¹Ÿå°±æ˜¯æ•°ç»„) ï¼Œæ¯ä¸ªå…ƒç´ çš„ç±»å‹ä¸º platform_device_idã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device_id</span> &#123;</span></span><br><span class="line"><span class="number">2</span> <span class="type">char</span> name[PLATFORM_NAME_SIZE];</span><br><span class="line"><span class="number">3</span> <span class="type">kernel_ulong_t</span> driver_data;</span><br><span class="line"><span class="number">4</span> &#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> *<span class="title">bus</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *mod_name; <span class="comment">/* used for built-in modules */</span></span><br><span class="line"><span class="type">bool</span> suppress_bind_attrs; <span class="comment">/* disables bind/unbind via sysfs */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">of_match_table</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">acpi_device_id</span> *<span class="title">acpi_match_table</span>;</span></span><br><span class="line">    <span class="type">int</span> (*probe) (<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="type">int</span> (*remove) (<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="type">void</span> (*shutdown) (<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="type">int</span> (*suspend) (<span class="keyword">struct</span> device *dev, <span class="type">pm_message_t</span> state);</span><br><span class="line"><span class="type">int</span> (*resume) (<span class="keyword">struct</span> device *dev);</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">driver_private</span> *<span class="title">p</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>of_match_table å°±æ˜¯é‡‡ç”¨è®¾å¤‡æ ‘çš„æ—¶å€™é©±åŠ¨ä½¿ç”¨çš„åŒ¹é…è¡¨ï¼ŒåŒæ ·æ˜¯æ•°ç»„ï¼Œæ¯ä¸ªåŒ¹é…é¡¹éƒ½ä¸º of_device_id ç»“æ„ä½“ç±»å‹ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">char</span> name[<span class="number">32</span>];</span><br><span class="line"><span class="type">char</span> type[<span class="number">32</span>];</span><br><span class="line"><span class="type">char</span> compatible[<span class="number">128</span>];</span><br><span class="line"><span class="type">const</span> <span class="type">void</span> *data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="platformè®¾å¤‡"><a href="#platformè®¾å¤‡" class="headerlink" title="platformè®¾å¤‡"></a>platformè®¾å¤‡</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;<span class="comment">//è®¾å¤‡åå­—</span></span><br><span class="line"><span class="type">int</span> id;</span><br><span class="line"><span class="type">bool</span> id_auto;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span></span><br><span class="line">u32 num_resources;<span class="comment">//èµ„æºæ•°é‡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">resource</span>;</span><span class="comment">//èµ„æºå¤§å°</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device_id</span> *<span class="title">id_entry</span>;</span></span><br><span class="line"><span class="type">char</span> *driver_override; <span class="comment">/* Driver name to force a match */</span></span><br><span class="line"><span class="comment">/* MFD cell pointer */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mfd_cell</span> *<span class="title">mfd_cell</span>;</span></span><br><span class="line"><span class="comment">/* arch specific additions */</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pdev_archdata</span> <span class="title">archdata</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">resource</span> &#123;</span></span><br><span class="line"><span class="type">resource_size_t</span> start;</span><br><span class="line"><span class="type">resource_size_t</span> end;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">parent</span>, *<span class="title">sibling</span>, *<span class="title">child</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>start å’Œ end åˆ†åˆ«è¡¨ç¤ºèµ„æºçš„èµ·å§‹å’Œç»ˆæ­¢ä¿¡æ¯ï¼Œå¯¹äºå†…å­˜ç±»çš„èµ„æºï¼Œå°±è¡¨ç¤ºå†…å­˜èµ·å§‹å’Œç»ˆæ­¢åœ°å€ï¼Œ name è¡¨ç¤ºèµ„æºåå­—ï¼Œ flags è¡¨ç¤ºèµ„æºç±»å‹ã€‚</p><h2 id="platformæ¡†æ¶"><a href="#platformæ¡†æ¶" class="headerlink" title="platformæ¡†æ¶"></a>platformæ¡†æ¶</h2><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/1688375549528.jpg"></p><h2 id="platformæ€»ç»“"><a href="#platformæ€»ç»“" class="headerlink" title="platformæ€»ç»“"></a>platformæ€»ç»“</h2><p>1ï¼‰å®šä¹‰ä¸€ä¸ª platform_driver ç»“æ„ä½“å˜é‡ã€‚</p><p>2ï¼‰å®ç°probeå‡½æ•°ã€‚</p><p>3ï¼‰å®ç°removeå‡½æ•°ã€‚</p><p>4ï¼‰å®ç°of_match_tableã€‚</p><p>5ï¼‰è°ƒç”¨platform_driver_register å‡½æ•°å‘ Linux å†…æ ¸æ³¨å†Œä¸€ä¸ª platform é©±åŠ¨ã€‚</p><p>6ï¼‰è°ƒç”¨platform_driver_unregister å‡½æ•°å¸è½½ platform é©±åŠ¨ã€‚</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç»å…¸æ»¤æ³¢ç®—æ³•</title>
      <link href="/2023/06/15/2023-6-15-%E7%BB%8F%E5%85%B8%E6%BB%A4%E6%B3%A2%E7%AE%97%E6%B3%95/"/>
      <url>/2023/06/15/2023-6-15-%E7%BB%8F%E5%85%B8%E6%BB%A4%E6%B3%A2%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="1-é™å¹…æ»¤æ³¢æ³•ï¼ˆç¨‹åºåˆ¤æ–­æ»¤æ³¢æ³•ï¼‰"><a href="#1-é™å¹…æ»¤æ³¢æ³•ï¼ˆç¨‹åºåˆ¤æ–­æ»¤æ³¢æ³•ï¼‰" class="headerlink" title="1.é™å¹…æ»¤æ³¢æ³•ï¼ˆç¨‹åºåˆ¤æ–­æ»¤æ³¢æ³•ï¼‰"></a>1.é™å¹…æ»¤æ³¢æ³•ï¼ˆç¨‹åºåˆ¤æ–­æ»¤æ³¢æ³•ï¼‰</h2><p>æ–¹æ³•ï¼šç¡®å®šä¸¤æ¬¡é‡‡æ ·å…è®¸çš„æœ€å¤§åå·®å€¼ï¼Œå¦‚æœæœ¬æ¬¡å€¼ä¸ä¸Šæ¬¡å€¼ä¹‹å·®&lt;&#x3D;A,åˆ™æœ¬æ¬¡æœ‰æ•ˆï¼Œåä¹‹&gt;A,åˆ™æœ¬æ¬¡å€¼æ— æ•ˆï¼Œæ”¾å¼ƒæœ¬æ¬¡å€¼ï¼Œä¸Šæ¬¡ä»£æ›¿æœ¬æ¬¡å€¼ã€‚</p><p>ä¼˜ç‚¹ï¼šå…‹æœå¶ç„¶è¯¯å·®é€ æˆçš„å¹²æ‰°</p><p>ç¼ºç‚¹ï¼šæ— æ³•æŠ‘åˆ¶å‘¨æœŸæ€§å¹²æ‰°ï¼Œå¹³æ»‘åº¦å·®</p><p>æ ¸å¿ƒå†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> A 10</span></span><br><span class="line"><span class="type">char</span> value;</span><br><span class="line"><span class="type">char</span> <span class="title function_">filter</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> new_value;</span><br><span class="line">new_value = get_ad();</span><br><span class="line"><span class="keyword">if</span> ( ( new_value - value &gt; A ) || ( value - new_value &gt; A )</span><br><span class="line"><span class="keyword">return</span> value;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">return</span> new_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>eg:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> A 4</span></span><br><span class="line"><span class="type">float</span> data_number[] = &#123;<span class="number">1.2</span> , <span class="number">1.3</span>, <span class="number">3.1</span>, <span class="number">2.1</span>, <span class="number">32</span>, <span class="number">2.4</span>, <span class="number">2.3</span>, <span class="number">4.1</span>&#125;;</span><br><span class="line"><span class="type">float</span> <span class="title function_">input</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">float</span> <span class="title function_">filter</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> n = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">float</span> sum[<span class="number">7</span>];</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">   sum[i] = filter();</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;%f\r\n&quot;</span>, sum[i]);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">float</span> <span class="title function_">input</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line"><span class="type">float</span> data1;</span><br><span class="line"></span><br><span class="line">j++;</span><br><span class="line">data1 = data_number[j];</span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> data1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">float</span> <span class="title function_">filter</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">float</span> new_value;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">value = data_number[<span class="number">0</span>];    </span><br><span class="line">n = <span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">value = new_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new_value = input();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;n=%f v=%f\r\n&quot;</span>,new_value, value);</span><br><span class="line"><span class="keyword">if</span>((new_value-value &gt; A))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> value;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">return</span> new_value;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-ä¸­ä½å€¼æ»¤æ³¢æ³•"><a href="#2-ä¸­ä½å€¼æ»¤æ³¢æ³•" class="headerlink" title="2.ä¸­ä½å€¼æ»¤æ³¢æ³•"></a>2.ä¸­ä½å€¼æ»¤æ³¢æ³•</h2><p>æ–¹æ³•ï¼šè¿ç»­é‡‡æ · N æ¬¡ï¼ˆ N å–å¥‡æ•°ï¼‰æŠŠ N æ¬¡é‡‡æ ·å€¼æŒ‰å¤§å°æ’åˆ—å–ä¸­é—´å€¼ä¸ºæœ¬æ¬¡æœ‰æ•ˆå€¼ã€‚<br>ä¼˜ç‚¹ï¼šèƒ½æœ‰æ•ˆå…‹æœå› å¶ç„¶å› ç´ å¼•èµ·çš„æ³¢åŠ¨å¹²æ‰°ï¼Œå¯¹æ¸©åº¦ã€æ¶²ä½çš„å˜åŒ–ç¼“æ…¢çš„è¢«æµ‹å‚æ•°æœ‰è‰¯å¥½çš„æ»¤æ³¢æ•ˆæœã€‚<br>ç¼ºç‚¹ï¼šå¯¹æµé‡ã€é€Ÿåº¦ç­‰å¿«é€Ÿå˜åŒ–çš„å‚æ•°ä¸å®œ ã€‚</p><p>ä¸€èˆ¬å¤„ç†æ¤’ç›å™ªå£°ï¼ˆè„‰å†²å™ªå£°ï¼‰ï¼Œå™ªå£°æ¥è‡ªäºADCé‡‡æ ·ï¼Œä¼ æ„Ÿå™¨ç­‰ã€‚</p><p>æ ¸å¿ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> N 11</span></span><br><span class="line"><span class="type">char</span> <span class="title function_">filter</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> value_buf[N];</span><br><span class="line"><span class="type">char</span> count,i,j,temp;</span><br><span class="line"><span class="keyword">for</span> ( count = <span class="number">0</span>;count &lt; N; count++ï¼‰ </span><br><span class="line">    &#123;</span><br><span class="line">value_buf[count] = get_ad();</span><br><span class="line">delay();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (j=<span class="number">0</span>;j&lt;N<span class="number">-1</span>;j++) <span class="comment">//å†’æ³¡æ³•</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;N<span class="number">-1</span>-j;i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ( value_buf[i]&gt;value_buf[i+<span class="number">1</span>] )</span><br><span class="line">&#123;</span><br><span class="line">temp = value_buf[i];</span><br><span class="line">value_buf [i]= value_buf[i+<span class="number">1</span>];</span><br><span class="line">value_buf[i+<span class="number">1</span>] = temp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> value_buf[(N<span class="number">-1</span>)/<span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>eg:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 5</span></span><br><span class="line"><span class="type">int</span> num[N] = &#123;<span class="number">1</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">12</span>,<span class="number">6</span>&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">filter</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">input</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> med;</span><br><span class="line">med = filter();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;med = %d&quot;</span>, med);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">input</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> j = <span class="number">0</span> ;</span><br><span class="line"><span class="type">int</span> data;</span><br><span class="line"></span><br><span class="line">data = num[j];</span><br><span class="line">j++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">filter</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> value_buf[N];</span><br><span class="line"><span class="type">int</span> count, i, j, temp;</span><br><span class="line">temp = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(count = <span class="number">0</span>; count &lt; N; count++)</span><br><span class="line">&#123;</span><br><span class="line">value_buf[count] = input();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; N<span class="number">-1</span> ; j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; N<span class="number">-1</span>-j; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(value_buf[i]&gt;value_buf[i+<span class="number">1</span>])</span><br><span class="line">&#123;</span><br><span class="line">temp = value_buf[i];</span><br><span class="line">value_buf[i] = value_buf[i+<span class="number">1</span>];</span><br><span class="line">value_buf[i+<span class="number">1</span>] = temp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> value_buf[(N<span class="number">-1</span>)/<span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠæ»¤æ³¢åŒºé—´çš„æ•°æ®ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œç„¶åå–ä¸­å€¼ï¼Œï¼ˆå¦‚æœæ˜¯å¥‡æ•°ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆä¸­å€¼å°±åªæœ‰ä¸€ä¸ªäº†ï¼Œå¦‚æœå¶æ•°ä¸ªæ•°æ®ï¼Œä¸­å€¼æœ‰ä¸¤ä¸ªï¼Œå¯ä»¥å¯¹ä¸¤ä¸ªæ•°æ®å†æ±‚å¹³å‡,</p><p><strong>æ˜¯æŠŠè¦å¤„ç†çš„æ•°æ®ç”¨ä¸­å€¼ä»£æ›¿ï¼Œä¸æ˜¯å…¨éƒ¨æ”¾æˆä¸­å€¼ã€‚</strong></p><h2 id="3-ç®—æœ¯å¹³å‡æ»¤æ³¢"><a href="#3-ç®—æœ¯å¹³å‡æ»¤æ³¢" class="headerlink" title="3.ç®—æœ¯å¹³å‡æ»¤æ³¢"></a>3.ç®—æœ¯å¹³å‡æ»¤æ³¢</h2><p>æ–¹æ³•ï¼šè¿ç»­å– N ä¸ªé‡‡æ ·å€¼è¿›è¡Œç®—æœ¯å¹³å‡è¿ç®—ï¼ŒN å€¼è¾ƒå¤§æ—¶ï¼šä¿¡å·å¹³æ»‘åº¦è¾ƒé«˜ï¼Œä½†çµæ•åº¦è¾ƒä½N å€¼è¾ƒå°æ—¶ï¼šä¿¡å·å¹³æ»‘åº¦è¾ƒä½ï¼Œä½†çµæ•åº¦è¾ƒé«˜ï¼ŒN å€¼çš„é€‰å–ï¼šä¸€èˆ¬æµé‡ï¼Œ N&#x3D;12ï¼›å‹åŠ›ï¼š N&#x3D;4ã€‚<br>ä¼˜ç‚¹ï¼š<br>é€‚ç”¨äºå¯¹ä¸€èˆ¬å…·æœ‰éšæœºå¹²æ‰°çš„ä¿¡å·è¿›è¡Œæ»¤æ³¢ï¼Œè¿™æ ·ä¿¡å·çš„ç‰¹ç‚¹æ˜¯æœ‰ä¸€ä¸ªå¹³å‡å€¼ï¼Œä¿¡å·åœ¨æŸä¸€æ•°å€¼èŒƒå›´é™„è¿‘ä¸Šä¸‹æ³¢åŠ¨ã€‚<br>ç¼ºç‚¹ï¼š<br>å¯¹äºæµ‹é‡é€Ÿåº¦è¾ƒæ…¢æˆ–è¦æ±‚æ•°æ®è®¡ç®—é€Ÿåº¦è¾ƒå¿«çš„å®æ—¶æ§åˆ¶ä¸é€‚ç”¨ï¼Œæ¯”è¾ƒæµªè´¹ RAM ã€‚</p><p>ä¸€èˆ¬å¤„ç†é«˜æ–¯å™ªå£°ï¼Œå™ªå£°æ¥æºäºçƒ­äº§ç”Ÿï¼Œæ˜¯éšæœºå™ªå£°ï¼Œæœä»é«˜æ–¯åˆ†å¸ƒã€‚</p><p>æ ¸å¿ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> N 12</span></span><br><span class="line"><span class="type">char</span> <span class="title function_">filter</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ( count=<span class="number">0</span>;count&lt;N;count++)</span><br><span class="line">&#123;</span><br><span class="line">sum + = get_ad();</span><br><span class="line">delay();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (<span class="type">char</span>)(sum/N);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç¼ºç‚¹æ˜æ˜¾ï¼Œä½†æ˜¯uä½äºå¶ç„¶å¼‚å¸¸ï¼Œå¯¹äºæŸæ¬¡çš„é‡‡æ ·æ˜æ˜¾åå¤§ï¼Œç»è¿‡å¹³å‡è®¡ç®—åå¯¼è‡´æœ€ç»ˆå€¼å­˜åœ¨è¾ƒå¤§åå·®ï¼Œé’ˆå¯¹è¿™ç§æå¤§å€¼æˆ–è€…æå°å€¼ï¼Œå¯ä»¥åœ¨ç®—æ•°å¹³å‡å‰è¿›è¡Œå‰”é™¤ã€‚</p><p>æ”¹è¿›çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">filter</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> min = <span class="number">0</span>, max = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; SAMPLE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(vBat[i] &lt; max)</span><br><span class="line">        &#123;</span><br><span class="line">            max = vBat[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(vBat[i] &lt; min)</span><br><span class="line">        &#123;</span><br><span class="line">            min = vBat[i];</span><br><span class="line">        &#125;</span><br><span class="line">        sum += vBat[i];</span><br><span class="line">    &#125;</span><br><span class="line">    sum = sum - min - max;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sum/SAMPL_NAM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4ã€é€’æ¨å¹³å‡æ»¤æ³¢æ³•ï¼ˆåˆç§°æ»‘åŠ¨å¹³å‡æ»¤æ³¢æ³•ï¼‰"><a href="#4ã€é€’æ¨å¹³å‡æ»¤æ³¢æ³•ï¼ˆåˆç§°æ»‘åŠ¨å¹³å‡æ»¤æ³¢æ³•ï¼‰" class="headerlink" title="4ã€é€’æ¨å¹³å‡æ»¤æ³¢æ³•ï¼ˆåˆç§°æ»‘åŠ¨å¹³å‡æ»¤æ³¢æ³•ï¼‰"></a>4ã€é€’æ¨å¹³å‡æ»¤æ³¢æ³•ï¼ˆåˆç§°æ»‘åŠ¨å¹³å‡æ»¤æ³¢æ³•ï¼‰</h2><p>æ–¹æ³•ï¼š<br>æŠŠè¿ç»­å– N ä¸ªé‡‡æ ·å€¼çœ‹æˆä¸€ä¸ªé˜Ÿåˆ—,é˜Ÿåˆ—çš„é•¿åº¦å›ºå®šä¸º N,æ¯æ¬¡é‡‡æ ·åˆ°ä¸€ä¸ªæ–°æ•°æ®æ”¾å…¥é˜Ÿå°¾,å¹¶æ‰”æ‰åŸæ¥é˜Ÿé¦–çš„ä¸€æ¬¡æ•°æ®.(å…ˆè¿›å…ˆå‡ºåŸåˆ™)<br>æŠŠé˜Ÿåˆ—ä¸­çš„ N ä¸ªæ•°æ®è¿›è¡Œç®—æœ¯å¹³å‡è¿ç®—,å°±å¯è·å¾—æ–°çš„æ»¤æ³¢ç»“æœ,N å€¼çš„é€‰å–ï¼šæµé‡ï¼Œ N&#x3D;12ï¼›å‹åŠ›ï¼š N&#x3D;4ï¼›æ¶²é¢ï¼Œ N&#x3D;4<del>12ï¼›æ¸©åº¦ï¼Œ N&#x3D;1</del>4<br>ä¼˜ç‚¹ï¼š<br>å¯¹å‘¨æœŸæ€§å¹²æ‰°æœ‰è‰¯å¥½çš„æŠ‘åˆ¶ä½œç”¨ï¼Œå¹³æ»‘åº¦é«˜,é€‚ç”¨äºé«˜é¢‘æŒ¯è¡çš„ç³»ç»Ÿ<br>ç¼ºç‚¹ï¼š<br>çµæ•åº¦ä½,å¯¹å¶ç„¶å‡ºç°çš„è„‰å†²æ€§å¹²æ‰°çš„æŠ‘åˆ¶ä½œç”¨è¾ƒå·®,ä¸æ˜“æ¶ˆé™¤ç”±äºè„‰å†²å¹²æ‰°æ‰€å¼•èµ·çš„é‡‡æ ·å€¼åå·®,ä¸é€‚ç”¨äºè„‰å†²å¹²æ‰°æ¯”è¾ƒä¸¥é‡çš„åœºåˆ,<br>æ¯”è¾ƒæµªè´¹ RAM </p><p>æ ¸å¿ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> N 12</span></span><br><span class="line"><span class="type">char</span> value_buf[N];</span><br><span class="line"><span class="type">char</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> <span class="title function_">filter</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> count;</span><br><span class="line"><span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line">value_buf[i++] = get_ad();</span><br><span class="line"><span class="keyword">if</span> ( i == N ) i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ( count=<span class="number">0</span>;count&lt;N;count++) sum = value_buf[count];</span><br><span class="line"><span class="keyword">return</span> (<span class="type">char</span>)(sum/N);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CçŸ¥è¯†ç‚¹</title>
      <link href="/2023/06/09/2023-06-09-%E4%BB%A3%E7%A0%81%E9%9D%A2%E8%AF%95/"/>
      <url>/2023/06/09/2023-06-09-%E4%BB%A3%E7%A0%81%E9%9D%A2%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h4 id="ä¸€-ç”¨é¢„å¤„ç†æŒ‡ä»¤-define-å£°æ˜ä¸€ä¸ªå¸¸æ•°ï¼Œç”¨ä»¥è¡¨æ˜1å¹´ä¸­æœ‰å¤šå°‘ç§’ï¼ˆå¿½ç•¥é—°å¹´é—®é¢˜ï¼‰"><a href="#ä¸€-ç”¨é¢„å¤„ç†æŒ‡ä»¤-define-å£°æ˜ä¸€ä¸ªå¸¸æ•°ï¼Œç”¨ä»¥è¡¨æ˜1å¹´ä¸­æœ‰å¤šå°‘ç§’ï¼ˆå¿½ç•¥é—°å¹´é—®é¢˜ï¼‰" class="headerlink" title="ä¸€. ç”¨é¢„å¤„ç†æŒ‡ä»¤#define å£°æ˜ä¸€ä¸ªå¸¸æ•°ï¼Œç”¨ä»¥è¡¨æ˜1å¹´ä¸­æœ‰å¤šå°‘ç§’ï¼ˆå¿½ç•¥é—°å¹´é—®é¢˜ï¼‰"></a>ä¸€. ç”¨é¢„å¤„ç†æŒ‡ä»¤#define å£°æ˜ä¸€ä¸ªå¸¸æ•°ï¼Œç”¨ä»¥è¡¨æ˜1å¹´ä¸­æœ‰å¤šå°‘ç§’ï¼ˆå¿½ç•¥é—°å¹´é—®é¢˜ï¼‰</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> a_year (365*24*60*60)UL</span></span><br><span class="line"><span class="comment">//ULæ— ç¬¦å·æ•´å½¢</span></span><br></pre></td></tr></table></figure><h4 id="äºŒ-å†™ä¸€ä¸ªâ€æ ‡å‡†â€å®MIN-ï¼Œè¿™ä¸ªå®è¾“å…¥ä¸¤ä¸ªå‚æ•°å¹¶è¿”å›è¾ƒå°çš„ä¸€ä¸ª"><a href="#äºŒ-å†™ä¸€ä¸ªâ€æ ‡å‡†â€å®MIN-ï¼Œè¿™ä¸ªå®è¾“å…¥ä¸¤ä¸ªå‚æ•°å¹¶è¿”å›è¾ƒå°çš„ä¸€ä¸ª" class="headerlink" title="äºŒ. å†™ä¸€ä¸ªâ€æ ‡å‡†â€å®MIN ï¼Œè¿™ä¸ªå®è¾“å…¥ä¸¤ä¸ªå‚æ•°å¹¶è¿”å›è¾ƒå°çš„ä¸€ä¸ª"></a>äºŒ. å†™ä¸€ä¸ªâ€æ ‡å‡†â€å®MIN ï¼Œè¿™ä¸ªå®è¾“å…¥ä¸¤ä¸ªå‚æ•°å¹¶è¿”å›è¾ƒå°çš„ä¸€ä¸ª</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>MIN( a, b)((a&lt;=b)?(a):(b))</span></span><br></pre></td></tr></table></figure><h4 id="ä¸‰-åµŒå…¥å¼ç³»ç»Ÿä¸­ç»å¸¸è¦ç”¨åˆ°æ— é™å¾ªç¯ï¼Œä½ æ€ä¹ˆæ ·ç”¨Cç¼–å†™æ­»å¾ªç¯å‘¢ï¼Ÿ"><a href="#ä¸‰-åµŒå…¥å¼ç³»ç»Ÿä¸­ç»å¸¸è¦ç”¨åˆ°æ— é™å¾ªç¯ï¼Œä½ æ€ä¹ˆæ ·ç”¨Cç¼–å†™æ­»å¾ªç¯å‘¢ï¼Ÿ" class="headerlink" title="ä¸‰. åµŒå…¥å¼ç³»ç»Ÿä¸­ç»å¸¸è¦ç”¨åˆ°æ— é™å¾ªç¯ï¼Œä½ æ€ä¹ˆæ ·ç”¨Cç¼–å†™æ­»å¾ªç¯å‘¢ï¼Ÿ"></a>ä¸‰. åµŒå…¥å¼ç³»ç»Ÿä¸­ç»å¸¸è¦ç”¨åˆ°æ— é™å¾ªç¯ï¼Œä½ æ€ä¹ˆæ ·ç”¨Cç¼–å†™æ­»å¾ªç¯å‘¢ï¼Ÿ</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="keyword">for</span>(;;)</span><br><span class="line">&#123;&#125;</span><br><span class="line">loop:...</span><br><span class="line"><span class="keyword">goto</span> loop;</span><br></pre></td></tr></table></figure><h4 id="å››-ç”¨å˜é‡aç»™å‡ºä¸‹é¢çš„å®šä¹‰"><a href="#å››-ç”¨å˜é‡aç»™å‡ºä¸‹é¢çš„å®šä¹‰" class="headerlink" title="å››. ç”¨å˜é‡aç»™å‡ºä¸‹é¢çš„å®šä¹‰"></a>å››. ç”¨å˜é‡aç»™å‡ºä¸‹é¢çš„å®šä¹‰</h4><ul><li>a) ä¸€ä¸ªæ•´å‹æ•°ï¼ˆAn integerï¼‰</li><li>b)ä¸€ä¸ªæŒ‡å‘æ•´å‹æ•°çš„æŒ‡é’ˆï¼ˆ A pointer to an integerï¼‰</li><li>c)ä¸€ä¸ªæŒ‡å‘æŒ‡é’ˆçš„çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘çš„æŒ‡é’ˆæ˜¯æŒ‡å‘ä¸€ä¸ªæ•´å‹æ•°ï¼ˆ A pointer to a pointer to an integeï¼‰</li><li>d)ä¸€ä¸ªæœ‰10ä¸ªæ•´å‹æ•°çš„æ•°ç»„ï¼ˆ An array of 10 integersï¼‰</li><li>e) ä¸€ä¸ªæœ‰10ä¸ªæŒ‡é’ˆçš„æ•°ç»„ï¼Œè¯¥æŒ‡é’ˆæ˜¯æŒ‡å‘ä¸€ä¸ªæ•´å‹æ•°çš„ã€‚ï¼ˆAn array of 10 pointers to integersï¼‰</li><li>f) ä¸€ä¸ªæŒ‡å‘æœ‰10ä¸ªæ•´å‹æ•°æ•°ç»„çš„æŒ‡é’ˆï¼ˆ A pointer to an array of 10 integersï¼‰</li><li>g) ä¸€ä¸ªæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æœ‰ä¸€ä¸ªæ•´å‹å‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ•´å‹æ•°ï¼ˆA pointer to a function that takes an integer as an argument and returns an integerï¼‰</li><li>h)  ä¸€ä¸ªæœ‰10ä¸ªæŒ‡é’ˆçš„æ•°ç»„ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æœ‰ä¸€ä¸ªæ•´å‹å‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ•´å‹æ•° ï¼ˆ An array of ten pointers to functions that take an integer argument and return an integer ï¼‰</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a;</span><br><span class="line"><span class="type">int</span> *p;</span><br><span class="line"><span class="type">int</span> **p;</span><br><span class="line"><span class="type">int</span> sum[<span class="number">10</span>];</span><br><span class="line"><span class="type">int</span> *sum[<span class="number">10</span>];</span><br><span class="line"><span class="type">int</span> (*sum)[<span class="number">10</span>];</span><br><span class="line"><span class="type">int</span> *<span class="title function_">prie</span><span class="params">(<span class="type">int</span> a)</span></span><br><span class="line"><span class="title function_">int</span> <span class="params">(*prie[<span class="number">10</span>](<span class="type">int</span>))</span></span><br></pre></td></tr></table></figure><h4 id="äº”-å…³é”®å­—staticçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#äº”-å…³é”®å­—staticçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="äº”. å…³é”®å­—staticçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>äº”. å…³é”®å­—staticçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>é¦–å…ˆï¼Œæ˜¯staticä¿®é¥°äº†å˜é‡ï¼Œå»¶é•¿äº†å˜é‡ç”Ÿå‘½å‘¨æœŸï¼Œç›´åˆ°ç¨‹åºè¿è¡Œç»“æŸåæ‰é‡Šæ”¾ã€‚</p><p>ä¹‹åæ˜¯staticä¿®é¥°ä¸€ä¸ªå‡½æ•°åˆ™è¿™ä¸ªå‡½æ•°<strong>åªèƒ½åœ¨æœ¬æ–‡ä»¶ä¸­è°ƒç”¨ï¼Œä¸èƒ½è¢«å…¶ä»–æ–‡ä»¶è°ƒç”¨</strong>ï¼ŒStaticä¿®é¥°çš„å±€éƒ¨å˜é‡å­˜æ”¾åœ¨å…¨å±€æ•°æ®åŒºçš„é™æ€å˜é‡åŒºã€‚åˆå§‹åŒ–çš„æ—¶å€™è‡ªåŠ¨åˆå§‹åŒ–ä¸º0ï¼›</p><p>staticä¿®é¥°å…¨å±€å˜é‡çš„æ—¶å€™ï¼Œè¿™ä¸ªå…¨å±€å˜é‡åªèƒ½åœ¨æœ¬æ–‡ä»¶ä¸­è®¿é—®ï¼Œä¸èƒ½åœ¨å…¶å®ƒæ–‡ä»¶ä¸­è®¿é—®ï¼Œå³ä¾¿æ˜¯externå¤–éƒ¨å£°æ˜ä¹Ÿä¸å¯ä»¥ã€‚</p><h4 id="å…­-å…³é”®å­—constæœ‰ä»€ä¹ˆå«æ„ï¼Ÿ"><a href="#å…­-å…³é”®å­—constæœ‰ä»€ä¹ˆå«æ„ï¼Ÿ" class="headerlink" title="å…­. å…³é”®å­—constæœ‰ä»€ä¹ˆå«æ„ï¼Ÿ"></a>å…­. å…³é”®å­—constæœ‰ä»€ä¹ˆå«æ„ï¼Ÿ</h4><p>è¦ä¸€ä¸ªå˜é‡å‰ç”¨constæ¥ä¿®é¥°ï¼Œå°±æ„å‘³ç€è¯¥å˜é‡é‡Œçš„æ•°æ®åªèƒ½è¢«è®¿é—®ï¼Œè€Œä¸èƒ½è¢«ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯æ„å‘³ç€constâ€œåªè¯»â€ï¼ˆreadonlyï¼‰ã€‚</p><h4 id="ä¸ƒ-å…³é”®å­—volatileæœ‰ä»€ä¹ˆå«æ„ï¼Ÿå¹¶ç»™å‡ºä¸‰ä¸ªä¸åŒçš„ä¾‹å­"><a href="#ä¸ƒ-å…³é”®å­—volatileæœ‰ä»€ä¹ˆå«æ„ï¼Ÿå¹¶ç»™å‡ºä¸‰ä¸ªä¸åŒçš„ä¾‹å­" class="headerlink" title="ä¸ƒ. å…³é”®å­—volatileæœ‰ä»€ä¹ˆå«æ„ï¼Ÿå¹¶ç»™å‡ºä¸‰ä¸ªä¸åŒçš„ä¾‹å­"></a>ä¸ƒ. å…³é”®å­—volatileæœ‰ä»€ä¹ˆå«æ„ï¼Ÿå¹¶ç»™å‡ºä¸‰ä¸ªä¸åŒçš„ä¾‹å­</h4><p>ä¸€ä¸ªå®šä¹‰ä¸ºvolatileçš„å˜é‡æ˜¯è¯´è¿™å˜é‡å¯èƒ½ä¼šè¢«æ„æƒ³ä¸åˆ°åœ°æ”¹å˜ï¼Œè¿™æ ·ï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šå»å‡è®¾è¿™ä¸ªå˜é‡çš„å€¼äº†ã€‚ç²¾ç¡®åœ°è¯´å°±æ˜¯ï¼Œä¼˜åŒ–å™¨åœ¨ç”¨åˆ°è¿™ä¸ªå˜é‡æ—¶å¿…é¡»æ¯æ¬¡éƒ½å°å¿ƒåœ°é‡æ–°è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¿å­˜åœ¨å¯„å­˜å™¨é‡Œçš„å¤‡ä»½ã€‚ä¸‹é¢æ˜¯volatileå˜é‡çš„å‡ ä¸ªä¾‹å­ï¼š</p><ul><li>å¹¶è¡Œè®¾å¤‡çš„ç¡¬ä»¶å¯„å­˜å™¨ï¼ˆå¦‚ï¼šçŠ¶æ€å¯„å­˜å™¨ï¼‰</li><li>ä¸€ä¸ªä¸­æ–­æœåŠ¡å­ç¨‹åºä¸­ä¼šè®¿é—®åˆ°çš„éè‡ªåŠ¨å˜é‡(Non-automatic variables)</li><li>å¤šçº¿ç¨‹åº”ç”¨ä¸­è¢«å‡ ä¸ªä»»åŠ¡å…±äº«çš„å˜é‡</li></ul><h4 id="å…«-åµŒå…¥å¼ç³»ç»Ÿæ€»æ˜¯è¦ç”¨æˆ·å¯¹å˜é‡æˆ–å¯„å­˜å™¨è¿›è¡Œä½æ“ä½œã€‚ç»™å®šä¸€ä¸ªæ•´å‹å˜é‡aï¼Œå†™ä¸¤æ®µä»£ç ï¼Œç¬¬ä¸€ä¸ªè®¾ç½®açš„bit-3ï¼Œç¬¬äºŒä¸ªæ¸…é™¤a-çš„bit-3ã€‚åœ¨ä»¥ä¸Šä¸¤ä¸ªæ“ä½œä¸­ï¼Œè¦ä¿æŒå…¶å®ƒä½ä¸å˜ã€‚"><a href="#å…«-åµŒå…¥å¼ç³»ç»Ÿæ€»æ˜¯è¦ç”¨æˆ·å¯¹å˜é‡æˆ–å¯„å­˜å™¨è¿›è¡Œä½æ“ä½œã€‚ç»™å®šä¸€ä¸ªæ•´å‹å˜é‡aï¼Œå†™ä¸¤æ®µä»£ç ï¼Œç¬¬ä¸€ä¸ªè®¾ç½®açš„bit-3ï¼Œç¬¬äºŒä¸ªæ¸…é™¤a-çš„bit-3ã€‚åœ¨ä»¥ä¸Šä¸¤ä¸ªæ“ä½œä¸­ï¼Œè¦ä¿æŒå…¶å®ƒä½ä¸å˜ã€‚" class="headerlink" title="å…«. åµŒå…¥å¼ç³»ç»Ÿæ€»æ˜¯è¦ç”¨æˆ·å¯¹å˜é‡æˆ–å¯„å­˜å™¨è¿›è¡Œä½æ“ä½œã€‚ç»™å®šä¸€ä¸ªæ•´å‹å˜é‡aï¼Œå†™ä¸¤æ®µä»£ç ï¼Œç¬¬ä¸€ä¸ªè®¾ç½®açš„bit 3ï¼Œç¬¬äºŒä¸ªæ¸…é™¤a çš„bit 3ã€‚åœ¨ä»¥ä¸Šä¸¤ä¸ªæ“ä½œä¸­ï¼Œè¦ä¿æŒå…¶å®ƒä½ä¸å˜ã€‚"></a>å…«. åµŒå…¥å¼ç³»ç»Ÿæ€»æ˜¯è¦ç”¨æˆ·å¯¹å˜é‡æˆ–å¯„å­˜å™¨è¿›è¡Œä½æ“ä½œã€‚ç»™å®šä¸€ä¸ªæ•´å‹å˜é‡aï¼Œå†™ä¸¤æ®µä»£ç ï¼Œç¬¬ä¸€ä¸ªè®¾ç½®açš„bit 3ï¼Œç¬¬äºŒä¸ªæ¸…é™¤a çš„bit 3ã€‚åœ¨ä»¥ä¸Šä¸¤ä¸ªæ“ä½œä¸­ï¼Œè¦ä¿æŒå…¶å®ƒä½ä¸å˜ã€‚</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    </span><br><span class="line">    a |= (a &lt;&lt; <span class="number">3</span>);</span><br><span class="line">    a &amp;= ~( a &lt;&lt; <span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¹-ä¸‹é¢çš„ä»£ç è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ"><a href="#ä¹-ä¸‹é¢çš„ä»£ç è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¹. ä¸‹é¢çš„ä»£ç è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ"></a>ä¹. ä¸‹é¢çš„ä»£ç è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> a = <span class="number">6</span>;</span><br><span class="line">    <span class="type">int</span> b = <span class="number">-20</span>;</span><br><span class="line">    (a+b &gt; <span class="number">6</span>) ? <span class="built_in">puts</span>(<span class="string">&quot;&gt;6&quot;</span>) : (<span class="string">&quot;&lt;=6&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ç®¡å¦‚ä½•ï¼Œè¿™æ— ç¬¦å·æ•´å‹é—®é¢˜çš„ç­”æ¡ˆæ˜¯è¾“å‡ºæ˜¯ â€œ&gt;6â€ã€‚åŸå›  æ˜¯å½“è¡¨è¾¾å¼ä¸­å­˜åœ¨æœ‰ç¬¦å·ç±»å‹å’Œæ— ç¬¦å·ç±»å‹æ—¶æ‰€æœ‰çš„æ“ä½œæ•°éƒ½è‡ªåŠ¨è½¬æ¢ä¸ºæ— ç¬¦å·ç±»å‹ã€‚</p><p>å› æ­¤-20å˜æˆäº†ä¸€ä¸ªéå¸¸å¤§çš„æ­£æ•´æ•°ï¼Œæ‰€ä»¥è¯¥è¡¨è¾¾å¼è®¡ç®—å‡ºçš„ç»“æœå¤§äº6ã€‚è¿™ä¸€ç‚¹å¯¹äºåº”å½“é¢‘ç¹ç”¨åˆ°æ— ç¬¦å·æ•°æ®ç±»å‹çš„åµŒå…¥å¼ç³»ç»Ÿæ¥è¯´æ˜¯ä¸°å¸¸é‡è¦çš„ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> å®æˆ˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç ”ç”µèµ›</title>
      <link href="/2023/05/31/2023-4-22-%E7%A0%94%E7%94%B5%E8%B5%9B/"/>
      <url>/2023/05/31/2023-4-22-%E7%A0%94%E7%94%B5%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h2 id="é¢˜ç›®ï¼šè¶…å£°æ¥è¿‘æ„ŸçŸ¥ç³»ç»Ÿ"><a href="#é¢˜ç›®ï¼šè¶…å£°æ¥è¿‘æ„ŸçŸ¥ç³»ç»Ÿ" class="headerlink" title="é¢˜ç›®ï¼šè¶…å£°æ¥è¿‘æ„ŸçŸ¥ç³»ç»Ÿ"></a>é¢˜ç›®ï¼šè¶…å£°æ¥è¿‘æ„ŸçŸ¥ç³»ç»Ÿ</h2><p>ï¼ˆ1ï¼‰èµ›é¢˜ä¸»è¦è€ƒå¯Ÿæ¥è¿‘æ„ŸçŸ¥ç³»ç»Ÿçš„å®ç°ï¼Œå¯ä½¿ç”¨æŒ‡ç¤ºç¯çš„äº®ç­æ¥è¡¨å¾æ¥è¿‘æ€å’Œè¿œç¦»æ€</p><p>ï¼ˆ2ï¼‰ä»¥è¶…å£°æ³¢æŠ€æœ¯ä¸ºåŸºç¡€å®ç°æ¥è¿‘æ„ŸçŸ¥ã€‚å¯è¾…åŠ©ä½¿ç”¨åŠ é€Ÿåº¦ã€é™€èºä»ªæˆ–ç­‰å…¶ä»–ä¼ æ„Ÿå™¨ï¼Œæ¥æé«˜å‡†ç¡®ç‡ï¼ˆå¦‚æå–æ¥å¬ç”µè¯åŠ¨ä½œä¸­çš„è·ç¦»ã€å§¿æ€ã€è¿åŠ¨è½¨è¿¹â€¦ç­‰ä¿¡æ¯çš„å˜åŒ–ï¼‰ã€‚</p><h4 id="è®¾è®¡stm32pcb"><a href="#è®¾è®¡stm32pcb" class="headerlink" title="è®¾è®¡stm32pcb"></a>è®¾è®¡stm32pcb</h4><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-05-31%20141653.png"></p><h4 id="è®¾è®¡å§¿æ€ä¼ æ„Ÿå™¨pcb"><a href="#è®¾è®¡å§¿æ€ä¼ æ„Ÿå™¨pcb" class="headerlink" title="è®¾è®¡å§¿æ€ä¼ æ„Ÿå™¨pcb"></a>è®¾è®¡å§¿æ€ä¼ æ„Ÿå™¨pcb</h4><p>ç”±ç£åŠ›è®¡IST8310å’Œé™€èºä»ªBMI088ç»„æˆã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-21%20214647.png"></p><p>ç”±äºå…ˆè®¾è®¡çš„ç¡¬ä»¶ï¼Œå¹¶æ²¡ç¡®å®šä½¿ç”¨çš„IOå£ï¼Œæ‰€ä»¥åˆ†ä¸ºäº†ä¸¤ä¸ªæ¿å­ï¼Œä¸ºäº†ç¬¦åˆé¢˜ç›®è¦æ±‚ï¼Œpcbä¸Šæ‰“ä¸Šé€šå­”ï¼Œä¾¿äºä½¿ç”¨èºä¸è¿æ¥ã€‚</p><p>ä½¿ç”¨MCUæ˜¯stm32f407VGT6çš„å‹å·ï¼Œåœ¨ä½¿ç”¨usartè¿›è¡Œä¸²å£é€šä¿¡çš„æ—¶å€™å‘ç°ä¼šå‡ºç°ï¼Œä¹±ç çš„é—®é¢˜ï¼Œæœ€åå‘ç°é—®é¢˜çš„åŸå› å‡ºåœ¨äº†ï¼Œæ™¶æŒ¯çš„é¢‘ç‡æºå¤´ä¸Šï¼Œ</p><p>#define HSE_VALUE 25000000 æŠŠ25æ”¹ä¸º8.</p><p>ä½¿ç”¨ä¸¤ä¸ªè¶…å£°æ³¢æ¨¡å—ï¼Œä½¿ç”¨spiå’Œiicé€šä¿¡æ¥è¯»å–å§¿æ€ä¼ æ„Ÿå™¨çš„æ•°æ®ã€‚</p><p>å…³äºSPIçš„é€šä¿¡ä½¿ç”¨ä¸ºäº†èŠ‚çœCPUçš„å æœ‰ç‡ï¼Œä½¿ç”¨äº†ä¸²å£DMAçš„é€šä¿¡æ–¹å¼ï¼ŒDMAä¼ è¾“å°†æ•°æ®ä»ä¸€ä¸ªåœ°å€ç©ºé—´å¤åˆ¶åˆ°å¦ä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œ æä¾›åœ¨å¤–è®¾å’Œå­˜å‚¨å™¨ä¹‹é—´æˆ–è€…å­˜å‚¨å™¨å’Œå­˜å‚¨å™¨ä¹‹é—´çš„é«˜é€Ÿæ•°æ®ä¼ è¾“ã€‚</p><p>å…³äºè¿™ç§pcbçš„è´´ç‰‡ç„Šæ¥ï¼Œæ˜¯å»ºè®®ç”¨<strong>å¼€ä¸€ä¸ªé’¢ç½‘ï¼Œä¹‹ååˆ·é”¡è†ï¼Œæ”¾å™¨ä»¶ï¼Œå›ç‚‰åŠ çƒ­</strong>å°±å¯ä»¥äº†ã€‚å¯¹äºèŠ¯ç‰‡æ¥è®²è¿˜æ˜¯è¦å¼€é’¢ç½‘çš„ï¼Œç”±äºæ­¤æ¬¡æ²¡å¼€é’¢ç½‘ï¼Œå¯¼è‡´æœ‰ä¸ªåˆ«çš„å¼•è„šç„Šæ¥åœ¨ä¸€èµ·ã€‚</p><p>å…³äºæ­¤æ¬¡çš„pcbè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¤–éƒ¨æ™¶æŒ¯åäº†ï¼Œæ‰€ä»¥å¯¼è‡´å®šæ—¶å™¨å·¥ä½œä¸ç¨³å®šï¼Œæ•°æ®å‡ºé—®é¢˜ï¼Œæ‰€ä»¥å½“ç¡®å®šç¨‹åºæ— è¯¯æ—¶å€™ï¼ŒæŸ¥ä¸€ä¸‹ç¡¬ä»¶ï¼Œæ¯•ç«Ÿæ˜¯è‡ªå·±åšçš„ï¼Œå¯èƒ½æ˜¯å‡ºç°äº†é—®é¢˜ï¼Œæ‰€ä»¥æ—¶é’Ÿæºä½¿ç”¨çš„æ˜¯RCçš„å†…éƒ¨éœ‡è¡ã€‚</p><p>ä¹‹åè¶…å£°æ³¢çš„ä½¿ç”¨æ˜¯ä½¿ç”¨å®šæ—¶å™¨æ¥è¿›è¡Œè¾“å…¥æ•è·ï¼Œæ¥å®ç°é«˜ç”µå¹³çš„è„‰å®½æ—¶é—´è¯»å–ï¼Œä¹‹åæ‰èƒ½è®¡ç®—è¶…å£°æ³¢çš„è·ç¦»ã€‚</p><p>ä¸ºäº†æ§åˆ¶é™€èºä»ªæ¸©åº¦ï¼Œæ§åˆ¶é›¶é£˜ï¼Œæ‰€ä»¥ä½¿ç”¨äº†pidæ¥æ§åˆ¶æ¸©åº¦ã€‚å¤ä¹ äº†ä¸€ä¸‹pidçš„çŸ¥è¯†ç‚¹</p><h4 id="PID"><a href="#PID" class="headerlink" title="PID"></a>PID</h4><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-05-31%20142627.png"></p><h4 id="å§¿æ€è§£ç®—ä»»åŠ¡"><a href="#å§¿æ€è§£ç®—ä»»åŠ¡" class="headerlink" title="å§¿æ€è§£ç®—ä»»åŠ¡"></a>å§¿æ€è§£ç®—ä»»åŠ¡</h4><p>å§¿æ€æ˜¯ååº”ç‰©ä½“ç›¸å¯¹äºå‚è€ƒåæ ‡ç³»çš„æŒ‡å‘ã€‚å¸¸ä½¿ç”¨æ¬§æ‹‰è§’ä»£è¡¨ç‰©ä½“çš„å§¿æ€ï¼Œæè¿°ç‰©ä½“å§¿æ€éœ€è¦ä¸‰ä¸ªè§’åº¦ï¼Œåˆ†åˆ«æ˜¯ yaw(åèˆªè§’), pitch(ä¿¯ä»°è§’),roll(æ¨ªæ»šè§’)ã€‚Yaw(åèˆªè§’)æ˜¯ç»• z è½´çš„è§’åº¦ï¼Œpitch æ˜¯ç»• y è½´çš„è§’åº¦ï¼Œroll æ˜¯ç»• x è½´çš„è§’åº¦ã€‚</p><p>mahony ç®—æ³•æ˜¯å¸¸è§çš„å§¿æ€èåˆç®—æ³•ï¼Œå°†åŠ é€Ÿåº¦è®¡ï¼Œç£åŠ›è®¡ï¼Œé™€èºä»ªå…±ä¹è½´æ•°æ®ï¼Œèåˆè§£ç®—å‡ºè½½ä½“å››å…ƒæ•°</p><p><a href="https://x-io.co.uk/open-source-imu-and-ahrs-algorithms/%E4%B8%8B%E8%BD%BD%E7%BD%91%E5%9D%80%E3%80%82%E6%94%BE%E5%88%B0%E5%B7%A5%E7%A8%8B%E9%87%8C%E8%BF%9B%E8%A1%8C%E7%A7%BB%E6%A4%8D%E3%80%82">https://x-io.co.uk/open-source-imu-and-ahrs-algorithms/ä¸‹è½½ç½‘å€ã€‚æ”¾åˆ°å·¥ç¨‹é‡Œè¿›è¡Œç§»æ¤ã€‚</a></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E7%BD%91%E9%A1%B5%E6%8D%95%E8%8E%B7_31-5-2023_143843_.jpeg"></p>]]></content>
      
      
      
        <tags>
            
            <tag> å®æˆ˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxå¼‚æ­¥é€šçŸ¥</title>
      <link href="/2023/05/18/2023-5-18-linux%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/"/>
      <url>/2023/05/18/2023-5-18-linux%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼‚æ­¥é€šçŸ¥"><a href="#å¼‚æ­¥é€šçŸ¥" class="headerlink" title="å¼‚æ­¥é€šçŸ¥"></a>å¼‚æ­¥é€šçŸ¥</h2><p><strong>å¼‚æ­¥é€šçŸ¥ï¼šä¸€æ—¦è®¾å¤‡å‡†å¤‡å°±ç»ªï¼Œåˆ™ä¸»åŠ¨é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œè¿™æ ·å¼•ç”¨ç¨‹åºæ ¹æœ¬ä¸éœ€è¦æŸ¥è¯¢è®¾å¤‡çŠ¶æ€</strong>ï¼Œç”±æ­¤å¼•å…¥äº†ä¿¡å·çš„æ¦‚å¿µï¼Œä¿¡å·æ˜¯åœ¨è½¯ä»¶å±‚æ¬¡ä¸Šçš„å¯¹ä¸­æ–­æœºåˆ¶çš„ä¸€ç§æ¨¡æ‹Ÿï¼Œé©±åŠ¨å¯ä»¥é€šè¿‡ä¸»åŠ¨å‘åº”ç”¨ç¨‹åºå‘é€ä¿¡å·çš„æ–¹å¼æ¥æŠ¥å‘Šè‡ªå·±å¯ä»¥è®¿é—®äº†ï¼Œåº”ç”¨ç¨‹åºè·å–åˆ°ä¿¡å·ä»¥åå°±å¯ä»¥ä»é©±åŠ¨è®¾å¤‡ä¸­è¯»å–æˆ–è€…å†™å…¥æ•°æ®äº†ã€‚æ•´ä¸ªè¿‡ç¨‹å°±ç›¸å½“äºåº”ç”¨ç¨‹åºæ”¶åˆ°äº†é©±åŠ¨å‘é€è¿‡æ¥äº†çš„ä¸€ä¸ªä¸­æ–­ï¼Œç„¶ååº”ç”¨ç¨‹åºå»å“åº”è¿™ä¸ªä¸­æ–­ï¼Œã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/eatfrqag.png"></p><h3 id="ä¿¡å·"><a href="#ä¿¡å·" class="headerlink" title="ä¿¡å·"></a>ä¿¡å·</h3><p>Linuxä¸­ç”¨å¼‚æ­¥ä¿¡å·æ¥å®ç°è¿›ç¨‹é€šä¿¡ï¼ˆIPCï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">34</span> <span class="meta">#<span class="keyword">define</span> SIGHUP 1 <span class="comment">/* ç»ˆç«¯æŒ‚èµ·æˆ–æ§åˆ¶è¿›ç¨‹ç»ˆæ­¢ */</span></span></span><br><span class="line"><span class="number">35</span> <span class="meta">#<span class="keyword">define</span> SIGINT 2 <span class="comment">/* ç»ˆç«¯ä¸­æ–­(Ctrl+C ç»„åˆé”®) */</span></span></span><br><span class="line"><span class="number">36</span> <span class="meta">#<span class="keyword">define</span> SIGQUIT 3 <span class="comment">/* ç»ˆç«¯é€€å‡º(Ctrl+\ç»„åˆé”®) */</span></span></span><br><span class="line"><span class="number">37</span> <span class="meta">#<span class="keyword">define</span> SIGILL 4 <span class="comment">/* éæ³•æŒ‡ä»¤ */</span></span></span><br><span class="line"><span class="number">38</span> <span class="meta">#<span class="keyword">define</span> SIGTRAP 5 <span class="comment">/* debug ä½¿ç”¨ï¼Œæœ‰æ–­ç‚¹æŒ‡ä»¤äº§ç”Ÿ */</span></span></span><br><span class="line"><span class="number">39</span> <span class="meta">#<span class="keyword">define</span> SIGABRT 6 <span class="comment">/* ç”± abort(3)å‘å‡ºçš„é€€å‡ºæŒ‡ä»¤ */</span></span></span><br><span class="line"><span class="number">40</span> <span class="meta">#<span class="keyword">define</span> SIGIOT 6 <span class="comment">/* IOT æŒ‡ä»¤ */</span></span></span><br><span class="line"><span class="number">41</span> <span class="meta">#<span class="keyword">define</span> SIGBUS 7 <span class="comment">/* æ€»çº¿é”™è¯¯ */</span></span></span><br><span class="line"><span class="number">42</span> <span class="meta">#<span class="keyword">define</span> SIGFPE 8 <span class="comment">/* æµ®ç‚¹è¿ç®—é”™è¯¯ */</span></span></span><br><span class="line"><span class="number">43</span> <span class="meta">#<span class="keyword">define</span> SIGKILL 9 <span class="comment">/* æ€æ­»ã€ç»ˆæ­¢è¿›ç¨‹ */</span></span></span><br><span class="line"><span class="number">44</span> <span class="meta">#<span class="keyword">define</span> SIGUSR1 10 <span class="comment">/* ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å· 1 */</span></span></span><br><span class="line"><span class="number">45</span> <span class="meta">#<span class="keyword">define</span> SIGSEGV 11 <span class="comment">/* æ®µè¿ä¾‹(æ— æ•ˆçš„å†…å­˜æ®µ) */</span></span></span><br><span class="line"><span class="number">46</span> <span class="meta">#<span class="keyword">define</span> SIGUSR2 12 <span class="comment">/* ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å· 2 */</span></span></span><br><span class="line"><span class="number">47</span> <span class="meta">#<span class="keyword">define</span> SIGPIPE 13 <span class="comment">/* å‘éè¯»ç®¡é“å†™å…¥æ•°æ® */</span></span></span><br><span class="line"><span class="number">48</span> <span class="meta">#<span class="keyword">define</span> SIGALRM 14 <span class="comment">/* é—¹é’Ÿ */</span></span></span><br><span class="line"><span class="number">49</span> <span class="meta">#<span class="keyword">define</span> SIGTERM 15 <span class="comment">/* è½¯ä»¶ç»ˆæ­¢ */</span></span></span><br><span class="line"><span class="number">50</span> <span class="meta">#<span class="keyword">define</span> SIGSTKFLT 16 <span class="comment">/* æ ˆå¼‚å¸¸ */</span></span></span><br><span class="line"><span class="number">51</span> <span class="meta">#<span class="keyword">define</span> SIGCHLD 17 <span class="comment">/* å­è¿›ç¨‹ç»“æŸ */</span></span></span><br><span class="line"><span class="number">52</span> <span class="meta">#<span class="keyword">define</span> SIGCONT 18 <span class="comment">/* è¿›ç¨‹ç»§ç»­ */</span></span></span><br><span class="line"><span class="number">53</span> <span class="meta">#<span class="keyword">define</span> SIGSTOP 19 <span class="comment">/* åœæ­¢è¿›ç¨‹çš„æ‰§è¡Œï¼Œåªæ˜¯æš‚åœ */</span></span></span><br><span class="line"><span class="number">54</span> <span class="meta">#<span class="keyword">define</span> SIGTSTP 20 <span class="comment">/* åœæ­¢è¿›ç¨‹çš„è¿è¡Œ(Ctrl+Z ç»„åˆé”®) */</span></span></span><br><span class="line"><span class="number">55</span> <span class="meta">#<span class="keyword">define</span> SIGTTIN 21 <span class="comment">/* åå°è¿›ç¨‹éœ€è¦ä»ç»ˆç«¯è¯»å–æ•°æ® */</span></span></span><br><span class="line"><span class="number">56</span> <span class="meta">#<span class="keyword">define</span> SIGTTOU 22 <span class="comment">/* åå°è¿›ç¨‹éœ€è¦å‘ç»ˆç«¯å†™æ•°æ® */</span></span></span><br><span class="line"><span class="number">57</span> <span class="meta">#<span class="keyword">define</span> SIGURG 23 <span class="comment">/* æœ‰&quot;ç´§æ€¥&quot;æ•°æ® */</span></span></span><br><span class="line"><span class="number">58</span> <span class="meta">#<span class="keyword">define</span> SIGXCPU 24 <span class="comment">/* è¶…è¿‡ CPU èµ„æºé™åˆ¶ */</span></span></span><br><span class="line"><span class="number">59</span> <span class="meta">#<span class="keyword">define</span> SIGXFSZ 25 <span class="comment">/* æ–‡ä»¶å¤§å°è¶…é¢ */</span></span></span><br><span class="line"><span class="number">60</span> <span class="meta">#<span class="keyword">define</span> SIGVTALRM 26 <span class="comment">/* è™šæ‹Ÿæ—¶é’Ÿä¿¡å· */</span></span></span><br><span class="line"><span class="number">61</span> <span class="meta">#<span class="keyword">define</span> SIGPROF 27 <span class="comment">/* æ—¶é’Ÿä¿¡å·æè¿° */</span></span></span><br><span class="line"><span class="number">62</span> <span class="meta">#<span class="keyword">define</span> SIGWINCH 28 <span class="comment">/* çª—å£å¤§å°æ”¹å˜ */</span></span></span><br><span class="line"><span class="number">63</span> <span class="meta">#<span class="keyword">define</span> SIGIO 29 <span class="comment">/* å¯ä»¥è¿›è¡Œè¾“å…¥/è¾“å‡ºæ“ä½œ */</span></span></span><br><span class="line"><span class="number">64</span> <span class="meta">#<span class="keyword">define</span> SIGPOLL SIGIO</span></span><br><span class="line"><span class="number">65</span> <span class="comment">/* #define SIGLOS 29 */</span></span><br><span class="line"><span class="number">66</span> <span class="meta">#<span class="keyword">define</span> SIGPWR 30 <span class="comment">/* æ–­ç‚¹é‡å¯ */</span></span></span><br><span class="line"><span class="number">67</span> <span class="meta">#<span class="keyword">define</span> SIGSYS 31 <span class="comment">/* éæ³•çš„ç³»ç»Ÿè°ƒç”¨ */</span></span></span><br><span class="line"><span class="number">68</span> <span class="meta">#<span class="keyword">define</span> SIGUNUSED 31 <span class="comment">/* æœªä½¿ç”¨ä¿¡å· */</span></span></span><br></pre></td></tr></table></figure><h4 id="ä¿¡å·çš„æ¥æ”¶"><a href="#ä¿¡å·çš„æ¥æ”¶" class="headerlink" title="ä¿¡å·çš„æ¥æ”¶"></a>ä¿¡å·çš„æ¥æ”¶</h4><p><strong>åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ signal å‡½æ•°æ¥è®¾ç½®æŒ‡å®šä¿¡å·çš„å¤„ç†å‡½æ•°</strong> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">sighandler_t</span> <span class="title function_">signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">sighandler_t</span> handler)</span></span><br><span class="line"><span class="comment">/*ç¬¬ä¸€ä¸ªå‚æ•°å¤„ç†çš„ä¿¡å·ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šæŒ‡é’ˆå¯¹å‰é¢ä¿¡å·å€¼çš„å¤„ç†å‡½æ•°ï¼Œè°ƒç”¨æˆåŠŸè¿”å›æœ€åä¸€æ¬¡ä¸ºä¿¡å·signumç»‘å®šhandlerå€¼ï¼Œå¤±è´¥è¿”å›SIG_ERR*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">sighandler_t</span>)</span><span class="params">(<span class="type">int</span>)</span></span><br></pre></td></tr></table></figure><p><strong>ä¸ºæ–‡ä»¶æè¿°ç¬¦çš„è®¾ç½®å±ä¸»</strong></p><p>é€šè¿‡ fcntl() çš„ F_SETOWN æ“ä½œæ¥å®Œæˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fcntl(fd, F_SETOWN, pid)</span><br></pre></td></tr></table></figure><p>å±ä¸»æ˜¯å½“æ–‡ä»¶æè¿°ç¬¦ä¸Šå¯æ‰§è¡Œ I&#x2F;O æ—¶ï¼Œä¼šæ¥æ”¶åˆ°é€šçŸ¥ä¿¡å·çš„è¿›ç¨‹æˆ–è¿›ç¨‹ç»„ã€‚</p><p>pid ä¸ºæ­£æ•´æ•°æ—¶ï¼Œä»£è¡¨äº†è¿›ç¨‹ ID å·ã€‚</p><p>pid ä¸ºè´Ÿæ•´æ•°æ—¶ï¼Œå®ƒçš„ç»å¯¹å€¼å°±ä»£è¡¨äº†è¿›ç¨‹ç»„ ID å·ã€‚</p><p><strong><u>ä½¿ç”¨ä¿¡å·å¼‚æ­¥é€šçŸ¥çš„åº”ç”¨ç¨‹åº</u></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_LEN 100</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_handler</span><span class="params">(<span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> data[MAX_LEN];</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    len = read(STDIN_FILENO, &amp;data, MAX_LEN)ï¼›</span><br><span class="line">    data[len] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input available :%s\n&quot;</span>, data);</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> oflags;</span><br><span class="line">    signal(SIGIO, input_handler);</span><br><span class="line">    fcntl(STDIN_FILENO, F_SETOWN, getpid());<span class="comment">//fcntlå‡½æ•°å¯¹æè¿°ç¬¦æä¾›æ§åˆ¶</span></span><br><span class="line">    oflags = fcntl(STDIN_FILENO,F_GETFL);</span><br><span class="line">    fcntl(STDIN_FILENO, F_SETFL, oflags|FASYNC);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);<span class="comment">//ä¸ºäº†ä¿è¯è¿›ç¨‹ä¸ç»ˆæ­¢ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†åœ¨ç”¨æˆ·ç©ºé—´ä¸­èƒ½å¤„ç†ä¸€ä¸ªè®¾å¤‡é‡Šæ”¾çš„ä¿¡å·ï¼Œå¿…é¡»å®Œæˆä¸‰é¡¹å·¥ä½œï¼š</p><ol><li>é€šè¿‡F_SETOWN IOæ§åˆ¶å‘½ä»¤è®¾ç½®è®¾å¤‡æ–‡ä»¶çš„æ‹¥æœ‰è€…ä¸ºæœ¬è¿›ç¨‹ï¼Œè¿™æ ·ä»è®¾å¤‡é©±åŠ¨å‘å‡ºçš„ä¿¡å·æ‰èƒ½è¢«æœ¬è¿›ç¨‹æ¥æ”¶åˆ°ï¼›</li><li>é€šè¿‡F_SETFL IOæ§åˆ¶å‘½ä»¤è®¾ç½®è®¾å¤‡æ–‡ä»¶æ”¯æŒFASYNCï¼Œå³å¼‚æ­¥é€šçŸ¥ï¼›</li><li>é€šè¿‡signalå‡½æ•°è¿ç»“ä¿¡å·å’Œä¿¡å·å¤„ç†å‡½æ•°ã€‚</li></ol><h4 id="ä¿¡å·çš„é‡Šæ”¾"><a href="#ä¿¡å·çš„é‡Šæ”¾" class="headerlink" title="ä¿¡å·çš„é‡Šæ”¾"></a>ä¿¡å·çš„é‡Šæ”¾</h4><p>åœ¨è®¾å¤‡é©±åŠ¨å’Œåº”ç”¨ç¨‹åºçš„å¼‚æ­¥é€šçŸ¥äº¤äº’ä¸­ï¼Œä»…ä»…åœ¨åº”ç”¨ç¨‹åºç«¯æ•è·ä¿¡å·æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºä¿¡å·æ²¡æœ‰çš„æºå¤´åœ¨è®¾å¤‡é©±åŠ¨ç«¯ï¼Œå› æ­¤ï¼Œåº”è¯¥åœ¨åˆé€‚çš„æ—¶æœºè®©è®¾å¤‡é©±åŠ¨é‡Šæ”¾ä¿¡å·ï¼Œ åœ¨è®¾å¤‡é©±åŠ¨ç¨‹åºä¸­åŠ ä¿¡å·é‡Šæ”¾çš„ä»£ç ã€‚</p><p>ä¸ºæ”¯æŒå¼‚æ­¥é€šçŸ¥æœºåˆ¶ï¼Œé©±åŠ¨ç¨‹åºä¸­æ¶‰åŠä»¥ä¸‹ä¸‰é¡¹å·¥ä½œã€‚</p><p>æ”¯æŒF_SETOWNå‘½ä»¤ã€‚èƒ½åœ¨è¿™ä¸ªæ§åˆ¶å‘½ä»¤å¤„ç†ä¸­è®¾ç½®filp-&gt;f_ownerä¸ºå¯¹åº”è¿›ç¨‹IDã€‚ä¸è¿‡æ­¤é¡¹å·¥ä½œå·²ç”±å†…æ ¸å®Œæˆï¼Œè®¾å¤‡é©±åŠ¨æ— éœ€å¤„ç†ã€‚</p><p>æ”¯æŒS_SETFLå‘½ä»¤å¤„ç†ï¼Œæ¯å½“FASYNCæ ‡å¿—æ”¹å˜æ—¶ï¼Œé©±åŠ¨ç¨‹åºä¸­çš„fasync()å‡½æ•°å°†æ‰§è¡Œã€‚</p><p>åœ¨è®¾å¤‡å¯è·å¾—æ—¶å€™ï¼Œè°ƒç”¨kill_fasync()å‡½æ•°æ¿€å‘ç›¸åº”çš„ä¿¡å·</p><p>å¼‚æ­¥é€šçŸ¥ä¸­ç”¨æˆ·ç©ºé—´å’Œè®¾å¤‡é©±åŠ¨ä¹‹é—´çš„äº¤äº’ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/Screenshot_20230518_204435.jpg"></p><p>è®¾å¤‡é©±åŠ¨ä¸­è¦ç”¨åˆ°ä¸€é¡¹æ•°æ®ç»“æ„å’Œä¸¤ä¸ªå‡½æ•°ï¼š</p><p>åœ¨é©±åŠ¨ç¨‹åºä¸­å®šä¹‰ä¸€ä¸ª fasync_struct ç»“æ„ä½“æŒ‡é’ˆå˜é‡ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> &#123;</span></span><br><span class="line"><span class="type">spinlock_t</span> fa_lock;</span><br><span class="line"><span class="type">int</span> magic;</span><br><span class="line"><span class="type">int</span> fa_fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fa_next</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">fa_file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">fa_rcu</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//ä¸€èˆ¬å°† fasync_struct ç»“æ„ä½“æŒ‡é’ˆå˜é‡å®šä¹‰åˆ°è®¾å¤‡ç»“æ„ä½“ä¸­</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx6uirq_dev</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">cls</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">......</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">async_queue</span>;</span> <span class="comment">/* å¼‚æ­¥ç›¸å…³ç»“æ„ä½“ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦ä½¿ç”¨å¼‚æ­¥é€šçŸ¥ï¼Œéœ€è¦åœ¨è®¾å¤‡é©±åŠ¨ä¸­å®ç° file_operations æ“ä½œé›†ä¸­çš„ fasync å‡½æ•° ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> (*fasync) (<span class="type">int</span> fd, <span class="keyword">struct</span> file *filp, <span class="type">int</span> on)</span><br></pre></td></tr></table></figure><p>fasync å‡½æ•°é‡Œé¢ä¸€èˆ¬é€šè¿‡è°ƒç”¨ fasync_helper å‡½æ•°æ¥åˆå§‹åŒ–å‰é¢å®šä¹‰çš„ fasync_struct ç»“æ„ä½“æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">fasync_helper</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> file * filp, <span class="type">int</span> on, <span class="keyword">struct</span> fasync_struct **fapp)</span></span><br></pre></td></tr></table></figure><p>  <strong>å½“åº”ç”¨ç¨‹åºé€šè¿‡â€œfcntl(fd, F_SETFL, flags | FASYNC)â€æ”¹å˜fasync æ ‡è®°çš„æ—¶å€™ï¼Œé©±åŠ¨ç¨‹åº file_operations æ“ä½œé›†ä¸­çš„ fasync å‡½æ•°å°±ä¼šæ‰§è¡Œã€‚</strong></p><p>é©±åŠ¨ä¸­fasyncå‚è€ƒå®ä¾‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev</span>&#123;</span></span><br><span class="line">  .......  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">async_queue</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_fasync</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> file *filp, <span class="type">int</span> on)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev</span> *<span class="title">dev</span> =</span> (xxx_dev *)filp -&gt; privata_data;</span><br><span class="line">    <span class="keyword">if</span>(fasync_helper(fd, filp, on ,&amp;dev-&gt;async_queue) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_release</span><span class="params">(<span class="keyword">struct</span> inode *inode ,<span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> xxx_fasync( <span class="number">-1</span>, filp, <span class="number">0</span>);<span class="comment">//è°ƒç”¨å‡½æ•°å®Œæˆfasync_struct çš„é‡Šæ”¾å·¥ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">xxx_ops</span> =</span> &#123;</span><br><span class="line">  ....</span><br><span class="line">  .fasync = xxx_fasync,</span><br><span class="line">  .release = xxx_release,</span><br><span class="line">  ....  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>kill_fasync å‡½æ•°</strong> </p><p>å½“è®¾å¤‡å¯ä»¥è®¿é—®çš„æ—¶å€™ï¼Œé©±åŠ¨ç¨‹åºéœ€è¦å‘åº”ç”¨ç¨‹åºå‘å‡ºä¿¡å·ï¼Œç›¸å½“äºäº§ç”Ÿâ€œä¸­æ–­â€ã€‚ kill_fasyncå‡½æ•°è´Ÿè´£å‘é€æŒ‡å®šçš„ä¿¡å·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kill_fasync</span><span class="params">(<span class="keyword">struct</span> fasync_struct **fp, <span class="type">int</span> sig, <span class="type">int</span> band)</span></span><br></pre></td></tr></table></figure><p>fpï¼šè¦æ“ä½œçš„ fasync_structã€‚<br>sigï¼š è¦å‘é€çš„ä¿¡å·ã€‚<br>bandï¼š å¯è¯»æ—¶è®¾ç½®ä¸º POLL_INï¼Œå¯å†™æ—¶è®¾ç½®ä¸º POLL_OUTã€‚<br>è¿”å›å€¼ï¼š æ— ã€‚ </p><h4 id="åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†"><a href="#åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†" class="headerlink" title="åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†"></a>åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†</h4><p>åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†åŒ…æ‹¬ä»¥ä¸‹ä¸‰æ­¥ï¼š</p><ol><li>æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ï¼ˆä½¿ç”¨signalå‡½æ•°ï¼‰</li><li>å°†æœ¬åº”ç”¨ç¨‹åºçš„è¿›ç¨‹å·å‘Šè¯‰ç»™å†…æ ¸ï¼ˆä½¿ç”¨ fcntl(fd, F_SETOWN, getpid())å°†æœ¬åº”ç”¨ç¨‹åºçš„è¿›ç¨‹å·å‘Šè¯‰ç»™å†…æ ¸ ï¼‰</li><li>å¼€å¯å¼‚æ­¥é€šçŸ¥</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flags = fcntl(fd, F_GETFL); <span class="comment">/* è·å–å½“å‰çš„è¿›ç¨‹çŠ¶æ€ */</span></span><br><span class="line">fcntl(fd, F_SETFL, flags | FASYNC); <span class="comment">/* å¼€å¯å½“å‰è¿›ç¨‹å¼‚æ­¥é€šçŸ¥åŠŸèƒ½ */</span></span><br></pre></td></tr></table></figure><h3 id="å¤‡æ³¨fcntlå‡½æ•°ç”¨æ³•"><a href="#å¤‡æ³¨fcntlå‡½æ•°ç”¨æ³•" class="headerlink" title="å¤‡æ³¨fcntlå‡½æ•°ç”¨æ³•"></a>å¤‡æ³¨fcntlå‡½æ•°ç”¨æ³•</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span>  </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd)</span>;  </span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">long</span> arg)</span>;  </span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd ,<span class="keyword">struct</span> flock* lock)</span>;  </span><br></pre></td></tr></table></figure><p>cmdçš„å€¼ä¸åŒæœ‰å¯¹åº”åŠŸèƒ½å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å‘½ä»¤å</th><th>æè¿°</th></tr></thead><tbody><tr><td>F_DUPFD</td><td>å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</td></tr><tr><td>F_GETFD</td><td>è·å–æ–‡ä»¶æè¿°ç¬¦æ ‡å¿—</td></tr><tr><td>F_SETFD</td><td>è®¾ç½®æ–‡ä»¶æè¿°ç¬¦æ ‡å¿—</td></tr><tr><td>F_GETFL</td><td>è·å–æ–‡ä»¶çŠ¶æ€æ ‡å¿—</td></tr><tr><td>F_SETFL</td><td>è®¾ç½®æ–‡ä»¶çŠ¶æ€æ ‡å¿—</td></tr><tr><td>F_GETLK</td><td>è·å–æ–‡ä»¶é”</td></tr><tr><td>F_SETLK</td><td>è®¾ç½®æ–‡ä»¶é”</td></tr><tr><td>F_SETOWN</td><td>è®¾ç½®å½“å‰æ¥æ”¶SIGIOå’ŒSIGURGä¿¡å·çš„è¿›ç¨‹IDå’Œè¿›ç¨‹ç»„ID</td></tr><tr><td>F_SETLKW</td><td>ç±»ä¼¼F_SETLK,ä½†ç­‰å¾…è¿”å›</td></tr><tr><td>F_GETOWN</td><td>è·å–å½“å‰æ¥æ”¶SIGIOå’ŒSIGURGä¿¡å·çš„è¿›ç¨‹IDå’Œè¿›ç¨‹ç»„ID</td></tr></tbody></table><h4 id="åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†-1"><a href="#åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†-1" class="headerlink" title="åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†"></a>åº”ç”¨ç¨‹åºå¯¹å¼‚æ­¥é€šçŸ¥çš„å¤„ç†</h4><p><strong>1ã€æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</strong><br>åº”ç”¨ç¨‹åºæ ¹æ®é©±åŠ¨ç¨‹åºæ‰€ä½¿ç”¨çš„ä¿¡å·æ¥è®¾ç½®ä¿¡å·çš„å¤„ç†å‡½æ•°ï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨ signal å‡½æ•°æ¥è®¾ç½®ä¿¡å·çš„å¤„ç†å‡½æ•°ã€‚<br><strong>2ã€å°†æœ¬åº”ç”¨ç¨‹åºçš„è¿›ç¨‹å·å‘Šè¯‰ç»™å†…æ ¸</strong><br>ä½¿ç”¨ fcntl(fd, F_SETOWN, getpid())å°†æœ¬åº”ç”¨ç¨‹åºçš„è¿›ç¨‹å·å‘Šè¯‰ç»™å†…æ ¸ã€‚<br><strong>3ã€å¼€å¯å¼‚æ­¥é€šçŸ¥</strong><br>ä½¿ç”¨å¦‚ä¸‹ä¸¤è¡Œç¨‹åºå¼€å¯å¼‚æ­¥é€šçŸ¥ï¼š<br>flags &#x3D; fcntl(fd, F_GETFL); &#x2F;* è·å–å½“å‰çš„è¿›ç¨‹çŠ¶æ€ <em>&#x2F;<br>fcntl(fd, F_SETFL, flags | FASYNC); &#x2F;</em> å¼€å¯å½“å‰è¿›ç¨‹å¼‚æ­¥é€šçŸ¥åŠŸèƒ½ *&#x2F;<br>é‡ç‚¹å°±æ˜¯é€šè¿‡ fcntl å‡½æ•°è®¾ç½®è¿›ç¨‹çŠ¶æ€ä¸º FASYNCï¼Œç»è¿‡è¿™ä¸€æ­¥ï¼Œé©±åŠ¨ç¨‹åºä¸­çš„ fasync å‡½æ•°å°±ä¼šæ‰§è¡Œ ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxé˜»å¡ä¸éé˜»å¡</title>
      <link href="/2023/05/10/2023-5-10-linux%E9%98%BB%E5%A1%9E%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9E/"/>
      <url>/2023/05/10/2023-5-10-linux%E9%98%BB%E5%A1%9E%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9E/</url>
      
        <content type="html"><![CDATA[<h2 id="é˜»å¡å’Œéé˜»å¡IO"><a href="#é˜»å¡å’Œéé˜»å¡IO" class="headerlink" title="é˜»å¡å’Œéé˜»å¡IO"></a>é˜»å¡å’Œéé˜»å¡IO</h2><p>é˜»å¡å¼</p><p>å½“åº”ç”¨ç¨‹åºå¯¹è®¾å¤‡é©±åŠ¨è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœä¸èƒ½è·å–åˆ°è®¾å¤‡èµ„æºï¼Œé‚£ä¹ˆé˜»å¡å¼ IO å°±ä¼šå°†åº”ç”¨ç¨‹åºå¯¹åº”çš„çº¿ç¨‹æŒ‚èµ·ï¼Œç›´åˆ°è®¾å¤‡èµ„æºå¯ä»¥è·å–ä¸ºæ­¢ã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-05-10%20115842.png"></p><p>éé˜»å¡å¼</p><p>å¯¹äºéé˜»å¡ IOï¼Œåº”ç”¨ç¨‹åºå¯¹åº”çš„çº¿ç¨‹ä¸ä¼šæŒ‚<br>èµ·ï¼Œå®ƒè¦ä¹ˆä¸€ç›´è½®è¯¢ç­‰å¾…ï¼Œç›´åˆ°è®¾å¤‡èµ„æºå¯ä»¥ä½¿ç”¨ï¼Œè¦ä¹ˆå°±ç›´æ¥æ”¾å¼ƒã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-05-10%20115857.png"></p><h2 id="ç­‰å¾…é˜Ÿåˆ—"><a href="#ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="ç­‰å¾…é˜Ÿåˆ—"></a>ç­‰å¾…é˜Ÿåˆ—</h2><h4 id="ç­‰å¾…é˜Ÿåˆ—å¤´"><a href="#ç­‰å¾…é˜Ÿåˆ—å¤´" class="headerlink" title="ç­‰å¾…é˜Ÿåˆ—å¤´"></a>ç­‰å¾…é˜Ÿåˆ—å¤´</h4><p>é˜»å¡å¼çš„å¥½å¤„å°±æ˜¯ï¼Œå½“æ— æ³•è·å–èµ„æºçš„æ—¶å€™è¿›ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè®©å‡ºcpuæ¥å¹²åˆ«çš„äº‹æƒ…ï¼Œå¯ä»¥æ“ä½œçš„æ—¶å€™å†è¿›è¡Œå”¤é†’ï¼ˆ<strong>ä¸€èˆ¬åœ¨ä¸­æ–­é‡Œå”¤é†’</strong>ï¼‰ã€‚</p><p>Linuxå†…æ ¸æä¾›äº†ç­‰å¾…é˜Ÿåˆ—æ¥å®ç°é˜»å¡è¿›ç¨‹çš„å”¤é†’å·¥ä½œï¼Œé¦–å…ˆè¦åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—å¤´ï¼Œç­‰å¾…é˜Ÿåˆ—å¤´ä½¿ç”¨ç»“æ„ä½“wait_queue_head_tè¡¨ç¤ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue_head</span>&#123;</span></span><br><span class="line">    <span class="type">spinlock_t</span> lock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">task_list</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue_head</span> <span class="title">wait_queue_head_t</span>;</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨init_waitqueue_headåˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—å¤´</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">init_waitqueue_head</span><span class="params">(<span class="type">wait_queue_head_t</span> *q)</span><span class="comment">//qä¸ºåˆå§‹åŒ–çš„ç­‰å¾…é˜Ÿåˆ—å¤´</span></span><br></pre></td></tr></table></figure><h4 id="ç­‰å¾…é˜Ÿåˆ—é¡¹"><a href="#ç­‰å¾…é˜Ÿåˆ—é¡¹" class="headerlink" title="ç­‰å¾…é˜Ÿåˆ—é¡¹"></a>ç­‰å¾…é˜Ÿåˆ—é¡¹</h4><p>æ¯ä¸ªè®¿é—®è®¾å¤‡çš„è¿›ç¨‹éƒ½æ˜¯ä¸€ä¸ªé˜Ÿåˆ—é¡¹ï¼Œå½“è®¾å¤‡ä¸å¯ç”¨çš„æ—¶å€™å°±è¦å°†è¿™äº›è¿›ç¨‹å¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—é¡¹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œé¢ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue</span>&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>flags;</span><br><span class="line">    <span class="type">void</span>*private;</span><br><span class="line">    <span class="type">wait_queue_func_t</span>func;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">task_list</span>;</span>  </span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue</span> <span class="title">wait_queue_t</span>;</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨å®DECLARE_WAITQUEUEå®šä¹‰åˆå§‹åŒ–ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é¡¹</span></span><br><span class="line">DECLARE_WAITQUEUE(name, tsk)<span class="comment">//nameç­‰å¾…é˜Ÿåˆ—é¡¹çš„åå­—ï¼Œtskè¡¨ç¤ºç­‰å¾…é˜Ÿåˆ—é¡¹å±äºå“ªä¸ªè¿›ç¨‹</span></span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ æˆ–ç§»é™¤ç­‰å¾…é˜Ÿåˆ—å¤´"><a href="#æ·»åŠ æˆ–ç§»é™¤ç­‰å¾…é˜Ÿåˆ—å¤´" class="headerlink" title="æ·»åŠ æˆ–ç§»é™¤ç­‰å¾…é˜Ÿåˆ—å¤´"></a>æ·»åŠ æˆ–ç§»é™¤ç­‰å¾…é˜Ÿåˆ—å¤´</h4><p>å½“è®¾å¤‡ä¸å¯è®¿é—®çš„æ—¶å€™å°±éœ€è¦å°†è¿›ç¨‹å¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—é¡¹æ·»åŠ åˆ°å‰é¢åˆ›å»ºçš„ç­‰å¾…é˜Ÿåˆ—å¤´ä¸­ï¼Œåªæœ‰æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—å¤´ä¸­ä»¥åè¿›ç¨‹æ‰èƒ½è¿›å…¥ä¼‘çœ æ€ã€‚å½“è®¾å¤‡å¯ä»¥è®¿é—®ä»¥åå†å°†è¿›ç¨‹å¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—é¡¹ä»ç­‰å¾…é˜Ÿåˆ—å¤´ä¸­ç§»é™¤å³å¯ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">add_wait_queue</span><span class="params">(<span class="type">wait_queue_head_t</span> *q, <span class="type">wait_queue_t</span>*wait)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">remove_wait_queue</span><span class="params">(<span class="type">wait_queue_head_t</span> *q, <span class="type">wait_queue_t</span> *wait)</span></span><br></pre></td></tr></table></figure><h4 id="ç­‰å¾…å”¤é†’"><a href="#ç­‰å¾…å”¤é†’" class="headerlink" title="ç­‰å¾…å”¤é†’"></a>ç­‰å¾…å”¤é†’</h4><p>å½“è®¾å¤‡å¯ä»¥ä½¿ç”¨çš„æ—¶å€™å°±è¦å”¤é†’è¿›å…¥ä¼‘çœ æ€çš„è¿›ç¨‹ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">wake_up</span><span class="params">(<span class="type">wait_queue_head_t</span> *q)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">wake_up_interruptible</span><span class="params">(<span class="type">wait_queue_head_t</span> *q)</span></span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªå‡½æ•°ä¼šå°†è¿™ä¸ªç­‰å¾…é˜Ÿåˆ—å¤´ä¸­çš„æ‰€æœ‰è¿›ç¨‹éƒ½å”¤é†’ã€‚wake_up å‡½æ•°å¯ä»¥å”¤é†’å¤„äº TASK_INTERRUPTIBLE å’Œ TASK_UNINTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹ï¼Œè€Œ wake_up_interruptible å‡½æ•°åªèƒ½å”¤é†’å¤„äº TASK_INTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹ã€‚ </p><h4 id="ç­‰å¾…äº‹ä»¶"><a href="#ç­‰å¾…äº‹ä»¶" class="headerlink" title="ç­‰å¾…äº‹ä»¶"></a>ç­‰å¾…äº‹ä»¶</h4><p>é™¤äº†ä¸»åŠ¨å”¤é†’ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ç­‰å¾…é˜Ÿåˆ—ç­‰å¾…æŸä¸ªäº‹ä»¶ï¼Œå½“è¿™ä¸ªäº‹ä»¶æ»¡è¶³ä»¥åå°±è‡ªåŠ¨å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹ </p><table><thead><tr><th>å‡½æ•°</th><th>æè¿°</th></tr></thead><tbody><tr><td>wait_event(wq, condition)</td><td>ç­‰å¾…ä»¥ wq ä¸ºç­‰å¾…é˜Ÿåˆ—å¤´çš„ç­‰å¾…é˜Ÿåˆ—è¢«å”¤é†’ï¼Œå‰ææ˜¯ condition æ¡ä»¶å¿…é¡»æ»¡è¶³(ä¸ºçœŸ)ï¼Œå¦åˆ™ä¸€ç›´é˜»å¡ æ­¤ å‡½ æ•° ä¼š å°† è¿› ç¨‹ è®¾ ç½® ä¸ºTASK_UNINTERRUPTIBLE çŠ¶æ€</td></tr><tr><td>wait_event_timeout(wq,condition,timeout)</td><td>åŠŸèƒ½å’Œ wait_event ç±»ä¼¼ï¼Œä½†æ˜¯æ­¤å‡½æ•°å¯ä»¥æ·»åŠ è¶…æ—¶æ—¶é—´ï¼Œä»¥ jiffies ä¸ºå•ä½ã€‚æ­¤å‡½æ•°æœ‰è¿”å›å€¼ï¼Œå¦‚æœè¿”å› 0 çš„è¯è¡¨ç¤ºè¶…æ—¶æ—¶é—´åˆ°ï¼Œè€Œä¸” conditionä¸ºå‡ã€‚ä¸º 1 çš„è¯è¡¨ç¤º condition ä¸ºçœŸï¼Œä¹Ÿå°±æ˜¯æ¡ä»¶æ»¡è¶³äº†ã€‚</td></tr><tr><td>wait_event_interruptible(wq, condition)</td><td>ä¸ wait_event å‡½æ•°ç±»ä¼¼ï¼Œä½†æ˜¯æ­¤å‡½æ•°å°†è¿›ç¨‹è®¾ç½®ä¸º TASK_INTERRUPTIBLEï¼Œå°±æ˜¯å¯ä»¥è¢«ä¿¡å·æ‰“æ–­ã€‚</td></tr><tr><td>wait_event_interruptible_timeout(wq,condition, timeout)</td><td>ä¸ wait_event_timeout å‡½æ•°ç±»ä¼¼ï¼Œæ­¤å‡½æ•°ä¹Ÿå°†è¿›ç¨‹è®¾ç½®ä¸º TASK_INTERRUPTIBLEï¼Œå¯ä»¥è¢«ä¿¡å·æ‰“æ–­</td></tr></tbody></table><p><img src="https://gitee.com/hanfengdyh/image/raw/master/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-05-19%20184010.png"></p><h3 id="è½®è¯¢"><a href="#è½®è¯¢" class="headerlink" title="è½®è¯¢"></a>è½®è¯¢</h3><p>å¦‚æœç”¨æˆ·åº”ç”¨ç¨‹åºä»¥éé˜»å¡çš„æ–¹å¼è®¿é—®è®¾å¤‡ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºå°±è¦æä¾›éé˜»å¡çš„å¤„ç†æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è½®è¯¢ã€‚ pollã€ epoll å’Œ select å¯ä»¥ç”¨äºå¤„ç†è½®è¯¢ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡ selectã€ epoll æˆ– poll å‡½æ•°æ¥æŸ¥è¯¢è®¾å¤‡æ˜¯å¦å¯ä»¥æ“ä½œï¼Œå¦‚æœå¯ä»¥æ“ä½œçš„è¯å°±ä»è®¾å¤‡è¯»å–æˆ–è€…å‘è®¾å¤‡å†™å…¥æ•°æ®ã€‚ </p><p><strong>selectå‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> nfds,</span></span><br><span class="line"><span class="params">           fd_set *readfds,</span></span><br><span class="line"><span class="params">           fd_set *writefds,</span></span><br><span class="line"><span class="params">           fd_set *exceptfds,</span></span><br><span class="line"><span class="params">           <span class="keyword">struct</span> timeval *timeout)</span></span><br></pre></td></tr></table></figure><p>nfds:æ‰€è¦ç›‘è§†çš„è¿™ä¸‰ç±»æ–‡ä»¶æè¿°é›†åˆä¸­ï¼Œ æœ€å¤§æ–‡ä»¶æè¿°ç¬¦åŠ  1ã€‚ </p><p>readfdsã€ writefds å’Œ exceptfds ï¼šreadfds ç”¨äºç›‘è§†æŒ‡å®šæè¿°ç¬¦é›†çš„è¯»å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ç›‘è§†è¿™äº›æ–‡ä»¶æ˜¯å¦å¯ä»¥è¯»å–ï¼Œåªè¦è¿™äº›é›†åˆé‡Œé¢æœ‰ä¸€ä¸ªæ–‡ä»¶å¯ä»¥è¯»å–é‚£ä¹ˆ seclect å°±ä¼šè¿”å›ä¸€ä¸ªå¤§äº 0 çš„å€¼è¡¨ç¤ºæ–‡ä»¶å¯ä»¥è¯»å–ã€‚å¦‚æœæ²¡æœ‰æ–‡ä»¶å¯ä»¥è¯»å–ï¼Œé‚£ä¹ˆå°±ä¼šæ ¹æ® timeout å‚æ•°æ¥åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚å¯ä»¥å°† readfsè®¾ç½®ä¸º NULLï¼Œè¡¨ç¤ºä¸å…³å¿ƒä»»ä½•æ–‡ä»¶çš„è¯»å˜åŒ–ã€‚ </p><p>exceptfds ç”¨äºç›‘è§†è¿™äº›æ–‡ä»¶çš„å¼‚å¸¸ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">FD_ZERO</span><span class="params">(fd_set *<span class="built_in">set</span>)</span><span class="comment">//æ‰€æœ‰ä½æ¸…é›¶</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set *<span class="built_in">set</span>)</span><span class="comment">//å°†æŸä¸ªä½ç½®1ï¼Œä¹Ÿå°±æ˜¯å‘ fd_set æ·»åŠ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set *<span class="built_in">set</span>)</span><span class="comment">//å°†æŸä¸ªä½æ¸…0ï¼Œä¹Ÿå°±æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä» fd_set ä¸­åˆ é™¤</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set *<span class="built_in">set</span>)</span><span class="comment">//ç”¨äºæµ‹è¯•ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦å±äºæŸä¸ªé›†åˆ</span></span><br></pre></td></tr></table></figure><p>timeout:è¶…æ—¶æ—¶é—´ï¼Œè°ƒç”¨selectç­‰å¾…æŸäº›æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span><span class="title">timeval</span>&#123;</span></span><br><span class="line">   <span class="type">long</span>tv_sec ;<span class="comment">//ç§’</span></span><br><span class="line">   <span class="type">long</span> tv_usec;<span class="comment">//å¾®ç§’</span></span><br><span class="line">&#125;ï¼›</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ï¼š 0ï¼Œè¡¨ç¤ºçš„è¯å°±è¡¨ç¤ºè¶…æ—¶å‘ç”Ÿï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¿›è¡Œæ“ä½œï¼› -1ï¼Œå‘ç”Ÿé”™è¯¯ï¼›å…¶ä»–å€¼ï¼Œå¯ä»¥è¿›è¡Œæ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚ </p><h4 id="selectç³»ç»Ÿé˜»å¡çŠ¶æ€åˆ¤æ–­"><a href="#selectç³»ç»Ÿé˜»å¡çŠ¶æ€åˆ¤æ–­" class="headerlink" title="selectç³»ç»Ÿé˜»å¡çŠ¶æ€åˆ¤æ–­"></a>selectç³»ç»Ÿé˜»å¡çŠ¶æ€åˆ¤æ–­</h4><p>1ã€timeoutä¼ å…¥NULLï¼Œåˆ™selectä¸ºé˜»å¡çŠ¶æ€ï¼Œå³éœ€è¦ç­‰åˆ°ç›‘è§†æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿå˜åŒ–æ‰ä¼šè¿”å›ï¼›ç›¸å½“äºæ— ç©·å¤§çš„æ—¶é—´ï¼Œä¸€ç›´ç­‰<br>2ã€timeoutç½®ä¸º0ç§’ã€0å¾®ç§’ï¼Œåˆ™selectä¸ºéé˜»å¡çŠ¶æ€ï¼Œä¸ç®¡æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æœ‰å˜åŒ–ï¼Œéƒ½ç«‹åˆ»è¿”å›ç»§ç»­æ‰§è¡Œï¼Œæ–‡ä»¶æ— å˜åŒ–è¿”å›0ï¼Œæœ‰å˜åŒ–è¿”å›ä¸€ä¸ªæ­£å€¼ï¼›<br>3ã€timeoutç½®ä¸ºå¤§äº0çš„å€¼ï¼Œå³ç­‰å¾…çš„è¶…æ—¶æ—¶é—´ï¼Œselectåœ¨timeoutæ—¶é—´å†…é˜»å¡ï¼Œè¶…æ—¶æ—¶é—´ä¹‹å†…æœ‰äº‹ä»¶åˆ°æ¥å°±è¿”å›ï¼Œå¦åˆ™åœ¨è¶…æ—¶åä¸ç®¡æ€æ ·ä¸€å®šè¿”å›ï¼Œè¿”å›å€¼åŒä¸Šè¿°ã€‚ </p><p><u>ä½¿ç”¨ select å‡½æ•°å¯¹æŸä¸ªè®¾å¤‡é©±åŠ¨æ–‡ä»¶è¿›è¡Œè¯»éé˜»å¡è®¿é—®çš„æ“ä½œ</u> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret,fd;</span><br><span class="line">    fd_set readfd;</span><br><span class="line">    </span><br><span class="line">    fd = open(<span class="string">&quot;dev_xx&quot;</span>, O_RDWR|)_NONBLOCK);<span class="comment">//éé˜»å¡æ‰“å¼€</span></span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open file\r\n&quot;</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">FD_ZERO(readfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Pollå‡½æ•°"><a href="#Pollå‡½æ•°" class="headerlink" title="Pollå‡½æ•°"></a>Pollå‡½æ•°</h4><p>åœ¨å•ä¸ªçº¿ç¨‹ä¸­ï¼Œselect å‡½æ•°èƒ½å¤Ÿç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡æœ‰æœ€å¤§çš„é™åˆ¶ï¼Œä¸€èˆ¬ä¸º 1024ï¼Œä½†æ˜¯ poll å‡½æ•°æ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds,</span></span><br><span class="line"><span class="params"><span class="type">nfds_t</span> nfds,</span></span><br><span class="line"><span class="params"><span class="type">int</span> timeout)</span></span><br></pre></td></tr></table></figure><p>fdsï¼š è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆä»¥åŠè¦ç›‘è§†çš„äº‹ä»¶,ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„å…ƒç´ éƒ½æ˜¯ç»“æ„ä½“ pollfdç±»å‹çš„ï¼Œ pollfd ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line"><span class="type">int</span> fd; <span class="comment">/* æ–‡ä»¶æè¿°ç¬¦ */</span></span><br><span class="line"><span class="type">short</span> events; <span class="comment">/* è¯·æ±‚çš„äº‹ä»¶ */</span></span><br><span class="line"><span class="type">short</span> revents; <span class="comment">/* è¿”å›çš„äº‹ä»¶ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>fd æ˜¯è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœ fd æ— æ•ˆçš„è¯é‚£ä¹ˆ events ç›‘è§†äº‹ä»¶ä¹Ÿå°±æ— æ•ˆï¼Œå¹¶ä¸” reventsè¿”å› 0ã€‚ events æ˜¯è¦ç›‘è§†çš„äº‹ä»¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¯ç›‘è§†äº‹ä»¶</span><br><span class="line">POLLIN æœ‰æ•°æ®å¯ä»¥è¯»å–ã€‚</span><br><span class="line">POLLPRI æœ‰ç´§æ€¥çš„æ•°æ®éœ€è¦è¯»å–ã€‚</span><br><span class="line">POLLOUT å¯ä»¥å†™æ•°æ®ã€‚</span><br><span class="line">POLLERR æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚</span><br><span class="line">POLLHUP æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æŒ‚èµ·ã€‚</span><br><span class="line">POLLNVAL æ— æ•ˆçš„è¯·æ±‚ã€‚</span><br><span class="line">POLLRDNORM ç­‰åŒäº POLLIN</span><br></pre></td></tr></table></figure><p>revents æ˜¯è¿”å›å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¿”å›çš„äº‹ä»¶ï¼Œ ç”± Linux å†…æ ¸è®¾ç½®å…·ä½“çš„è¿”å›äº‹ä»¶ </p><p>nfdsï¼š poll å‡½æ•°è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€‚<br>timeoutï¼š è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸º msã€‚ </p><p>è¿”å›å€¼ï¼šè¿”å› revents åŸŸä¸­ä¸ä¸º 0 çš„ pollfd ç»“æ„ä½“ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿäº‹ä»¶æˆ–é”™è¯¯çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ï¼› 0ï¼Œè¶…æ—¶ï¼› -1ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œå¹¶ä¸”è®¾ç½® errno ä¸ºé”™è¯¯ç±»å‹ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">int</span> fd; <span class="comment">/* è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>;</span></span><br><span class="line"></span><br><span class="line">fd = open(filename, O_RDWR | O_NONBLOCK); <span class="comment">/* éé˜»å¡å¼è®¿é—® */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ„é€ ç»“æ„ä½“ */</span></span><br><span class="line">fds.fd = fd;</span><br><span class="line">fds.events = POLLIN; <span class="comment">/* ç›‘è§†æ•°æ®æ˜¯å¦å¯ä»¥è¯»å– */</span></span><br><span class="line">ret = poll(&amp;fds, <span class="number">1</span>, <span class="number">500</span>); <span class="comment">/* è½®è¯¢æ–‡ä»¶æ˜¯å¦å¯æ“ä½œï¼Œè¶…æ—¶ 500ms */</span></span><br><span class="line"><span class="keyword">if</span> (ret) &#123; <span class="comment">/* æ•°æ®æœ‰æ•ˆ */</span></span><br><span class="line"> ......</span><br><span class="line"><span class="comment">/* è¯»å–æ•°æ® */</span></span><br><span class="line"> ......</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123; <span class="comment">/* è¶…æ—¶ */</span></span><br><span class="line"> ......</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123; <span class="comment">/* é”™è¯¯ */</span></span><br><span class="line"> ......</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="epollå‡½æ•°"><a href="#epollå‡½æ•°" class="headerlink" title="epollå‡½æ•°"></a>epollå‡½æ•°</h4><p>epoll å°±æ˜¯ä¸ºå¤„ç†å¤§å¹¶å‘è€Œå‡†å¤‡çš„ï¼Œä¸€èˆ¬å¸¸å¸¸åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ä½¿ç”¨ epoll å‡½æ•°ã€‚åº”ç”¨ç¨‹åºéœ€è¦å…ˆä½¿ç”¨ epoll_create å‡½æ•°åˆ›å»ºä¸€ä¸ª epoll å¥æŸ„ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span></span><br></pre></td></tr></table></figure><p>sizeï¼š ä» Linux2.6.8 å¼€å§‹æ­¤å‚æ•°å·²ç»æ²¡æœ‰æ„ä¹‰äº†ï¼Œéšä¾¿å¡«å†™ä¸€ä¸ªå¤§äº 0 çš„å€¼å°±å¯ä»¥ã€‚<br>è¿”å›å€¼ï¼š epoll å¥æŸ„ï¼Œå¦‚æœä¸º-1 çš„è¯è¡¨ç¤ºåˆ›å»ºå¤±è´¥ã€‚ </p><p>epoll å¥æŸ„åˆ›å»ºæˆåŠŸä»¥åä½¿ç”¨ epoll_ctl å‡½æ•°å‘å…¶ä¸­æ·»åŠ è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ä»¥åŠç›‘è§†çš„äº‹ä»¶ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd,</span></span><br><span class="line"><span class="params">              <span class="type">int</span> op,</span></span><br><span class="line"><span class="params">          <span class="type">int</span> fd,</span></span><br><span class="line"><span class="params">          <span class="keyword">struct</span> epoll_event *event)</span></span><br></pre></td></tr></table></figure><p>epfdï¼š è¦æ“ä½œçš„ epoll å¥æŸ„ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ epoll_create å‡½æ•°åˆ›å»ºçš„ epoll å¥æŸ„ã€‚<br>opï¼š è¡¨ç¤ºè¦å¯¹ epfd(epoll å¥æŸ„)è¿›è¡Œçš„æ“ä½œï¼Œå¯ä»¥è®¾ç½®ä¸ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EPOLL_CTL_ADD å‘ epfd æ·»åŠ æ–‡ä»¶å‚æ•° fd è¡¨ç¤ºçš„æè¿°ç¬¦ã€‚</span><br><span class="line">EPOLL_CTL_MOD ä¿®æ”¹å‚æ•° fd çš„ event äº‹ä»¶ã€‚</span><br><span class="line">EPOLL_CTL_DEL ä» epfd ä¸­åˆ é™¤ fd æè¿°ç¬¦ã€‚</span><br></pre></td></tr></table></figure><p>fdï¼šè¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ã€‚<br>eventï¼š è¦ç›‘è§†çš„äº‹ä»¶ç±»å‹ï¼Œä¸º epoll_event ç»“æ„ä½“ç±»å‹æŒ‡é’ˆ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line"><span class="type">uint32_t</span> events; <span class="comment">/* epoll äº‹ä»¶ */</span></span><br><span class="line"><span class="type">epoll_data_t</span> data; <span class="comment">/* ç”¨æˆ·æ•°æ® */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“ epoll_event çš„ events æˆå‘˜å˜é‡è¡¨ç¤ºè¦ç›‘è§†çš„äº‹ä»¶ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EPOLLIN æœ‰æ•°æ®å¯ä»¥è¯»å–ã€‚</span><br><span class="line">EPOLLOUT å¯ä»¥å†™æ•°æ®ã€‚</span><br><span class="line">EPOLLPRI æœ‰ç´§æ€¥çš„æ•°æ®éœ€è¦è¯»å–ã€‚</span><br><span class="line">EPOLLERR æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚</span><br><span class="line">EPOLLHUP æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æŒ‚èµ·ã€‚</span><br><span class="line">EPOLLET è®¾ç½® epoll ä¸ºè¾¹æ²¿è§¦å‘ï¼Œé»˜è®¤è§¦å‘æ¨¡å¼ä¸ºæ°´å¹³è§¦å‘ã€‚</span><br><span class="line">EPOLLONESHOT ä¸€æ¬¡æ€§çš„ç›‘è§†ï¼Œå½“ç›‘è§†å®Œæˆä»¥åè¿˜éœ€è¦å†æ¬¡ç›‘è§†æŸä¸ª fdï¼Œé‚£ä¹ˆå°±éœ€è¦å°†</span><br><span class="line">fd é‡æ–°æ·»åŠ åˆ° epoll é‡Œé¢ã€‚</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™äº›äº‹ä»¶å¯ä»¥è¿›è¡Œâ€œæˆ–â€æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è®¾ç½®ç›‘è§†å¤šä¸ªäº‹ä»¶ã€‚ </p><p>è¿”å›å€¼ï¼š 0ï¼ŒæˆåŠŸï¼› -1ï¼Œå¤±è´¥ï¼Œå¹¶ä¸”è®¾ç½® errno çš„å€¼ä¸ºç›¸åº”çš„é”™è¯¯ç ã€‚ </p><p>ä¸€åˆ‡éƒ½è®¾ç½®å¥½ä»¥ååº”ç”¨ç¨‹åºå°±å¯ä»¥é€šè¿‡ epoll_wait å‡½æ•°æ¥ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿï¼Œç±»ä¼¼ select å‡½æ•°ã€‚  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int epoll_wait(int epfd,</span><br><span class="line">   struct epoll_event *events,</span><br><span class="line">               int maxevents,</span><br><span class="line">               int timeout)</span><br></pre></td></tr></table></figure><p>epfdï¼š è¦ç­‰å¾…çš„ epollã€‚ </p><p>eventsï¼š æŒ‡å‘ epoll_event ç»“æ„ä½“çš„æ•°ç»„ï¼Œå½“æœ‰äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ Linux å†…æ ¸ä¼šå¡«å†™ eventsï¼Œè°ƒ<br>ç”¨è€…å¯ä»¥æ ¹æ® events åˆ¤æ–­å‘ç”Ÿäº†å“ªäº›äº‹ä»¶ã€‚<br>maxeventsï¼š events æ•°ç»„å¤§å°ï¼Œå¿…é¡»å¤§äº 0ã€‚<br>timeoutï¼š è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸º msã€‚<br>è¿”å›å€¼ï¼š 0ï¼Œè¶…æ—¶ï¼› -1ï¼Œé”™è¯¯ï¼›å…¶ä»–å€¼ï¼Œå‡†å¤‡å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€‚ </p><h4 id="Linux-é©±åŠ¨ä¸‹çš„-poll-æ“ä½œå‡½æ•°"><a href="#Linux-é©±åŠ¨ä¸‹çš„-poll-æ“ä½œå‡½æ•°" class="headerlink" title="Linux é©±åŠ¨ä¸‹çš„ poll æ“ä½œå‡½æ•°"></a>Linux é©±åŠ¨ä¸‹çš„ poll æ“ä½œå‡½æ•°</h4><p>å½“åº”ç”¨ç¨‹åºè°ƒç”¨ select æˆ– poll å‡½æ•°æ¥å¯¹é©±åŠ¨ç¨‹åºè¿›è¡Œéé˜»å¡è®¿é—®çš„æ—¶å€™ï¼Œé©±åŠ¨ç¨‹åºfile_operations æ“ä½œé›†ä¸­çš„ poll å‡½æ•°å°±ä¼šæ‰§è¡Œã€‚æ‰€ä»¥é©±åŠ¨ç¨‹åºçš„ç¼–å†™è€…éœ€è¦æä¾›å¯¹åº”çš„ poll å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pollå‡½æ•°åŸå‹</span></span><br><span class="line"><span class="type">unsigned</span><span class="title function_">int</span><span class="params">(*poll)</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> poll_table_struct *wait)</span></span><br><span class="line"><span class="comment">//filpè¦æ‰“å¼€çš„è®¾å¤‡æ–‡ä»¶</span></span><br><span class="line"><span class="comment">//waitç»“æ„ä½“ poll_table_struct ç±»å‹æŒ‡é’ˆï¼Œ ç”±åº”ç”¨ç¨‹åºä¼ é€’è¿›æ¥çš„ã€‚ä¸€èˆ¬å°†æ­¤å‚æ•°ä¼ é€’ç»™poll_wait å‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">poll_wait</span><span class="params">(<span class="keyword">struct</span> file * filp, <span class="type">wait_queue_head_t</span> * wait_address, poll_table *p)</span></span><br><span class="line"> <span class="comment">//poll_wait å‡½æ•°ä¸ä¼šå¼•èµ·é˜»å¡ï¼Œåªæ˜¯å°†åº”ç”¨ç¨‹åºæ·»åŠ åˆ° poll_table ä¸­</span></span><br><span class="line"> <span class="comment">//å‚æ•° wait_address æ˜¯è¦æ·»åŠ åˆ° poll_table ä¸­çš„ç­‰å¾…é˜Ÿåˆ—å¤´ï¼Œå‚æ•° p å°±æ˜¯ poll_table</span></span><br></pre></td></tr></table></figure><p>pollå‡½æ•°çš„è¿”å›å€¼ï¼šå‘åº”ç”¨ç¨‹åºè¿”å›è®¾å¤‡æˆ–è€…èµ„æºçŠ¶æ€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POLLIN æœ‰æ•°æ®å¯ä»¥è¯»å–ã€‚</span><br><span class="line">POLLPRI æœ‰ç´§æ€¥çš„æ•°æ®éœ€è¦è¯»å–ã€‚</span><br><span class="line">POLLOUT å¯ä»¥å†™æ•°æ®ã€‚</span><br><span class="line">POLLERR æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚</span><br><span class="line">POLLHUP æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æŒ‚èµ·ã€‚</span><br><span class="line">POLLNVAL æ— æ•ˆçš„è¯·æ±‚ã€‚</span><br><span class="line">POLLRDNORM ç­‰åŒäº POLLINï¼Œæ™®é€šæ•°æ®å¯è¯»</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxä¸­æ–­</title>
      <link href="/2023/05/04/2023-5-4-linux%E4%B8%AD%E6%96%AD/"/>
      <url>/2023/05/04/2023-5-4-linux%E4%B8%AD%E6%96%AD/</url>
      
        <content type="html"><![CDATA[<h2 id="linuxä¸­æ–­"><a href="#linuxä¸­æ–­" class="headerlink" title="linuxä¸­æ–­"></a>linuxä¸­æ–­</h2><p>ä¸­æ–­æ˜¯æŒ‡CPUåœ¨æ‰§è¡Œç¨‹åºæ‰§è¡Œä¸­ï¼Œå‡ºç°äº†çªå‘äº‹ä»¶ï¼ŒCPUå¿…é¡»æš‚åœå½“å‰ç¨‹åºçš„æ‰§è¡Œï¼Œå¤„ç†çªå‘äº‹ä»¶ï¼Œå¤„ç†å®Œååˆè¿”å›ç¨‹åºåˆ°ä¸­æ–­çš„ä½ç½®ç»§ç»­è¿›è¡Œã€‚</p><p>æ ¹æ®ä¸­æ–­å…¥å£è·³è½¬æ–¹æ³•ä¸åŒï¼Œåˆ†ä¸ºå‘é‡ä¸­æ–­å’Œéå‘é‡ä¸­æ–­ï¼Œé‡‡ç”¨å‘é‡ä¸­æ–­çš„CPUé€šå¸¸ä¸ºä¸åŒçš„ä¸­æ–­åˆ†é…ä¸åŒçš„ä¸­æ–­å·ï¼Œå½“æ£€æµ‹åˆ°æŸä¸­æ–­åˆ°æ¥åï¼Œè‡ªåŠ¨è·³è½¬åˆ°è¯¥ä¸­æ–­å·å¯¹åº”çš„åœ°å€æ‰§è¡Œã€‚ä¸åŒä¸­æ–­å·çš„ä¸­æ–­æœ‰ä¸åŒçš„å…¥å£åœ°å€ã€‚éå‘é‡ä¸­æ–­çš„å¤šä¸ªä¸­æ–­å…±äº«ä¸€ä¸ªå…¥å£åœ°å€ï¼Œè¿›å…¥è¯¥å…¥å£åœ°å€åï¼Œå†é€šè¿‡è½¯ä»¶åˆ¤æ–­ä¸­æ–­æ ‡å¿—æ¥æ ‡è¯†ï¼Œå…·ä½“å“ªä¸ªä¸­æ–­ã€‚</p><h4 id="ç”³è¯·å’Œé‡Šæ”¾ä¸­æ–­"><a href="#ç”³è¯·å’Œé‡Šæ”¾ä¸­æ–­" class="headerlink" title="ç”³è¯·å’Œé‡Šæ”¾ä¸­æ–­"></a>ç”³è¯·å’Œé‡Šæ”¾ä¸­æ–­</h4><p>request_irq å‡½æ•°ç”¨äºç”³è¯·ä¸­æ–­ï¼Œ request_irqå‡½æ•°å¯èƒ½ä¼šå¯¼è‡´ç¡çœ ï¼Œå› æ­¤ä¸èƒ½åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡æˆ–è€…å…¶ä»–ç¦æ­¢ç¡çœ çš„ä»£ç æ®µä¸­ä½¿ç”¨ request_irq å‡½æ•°ã€‚ request_irq å‡½æ•°ä¼šæ¿€æ´»(ä½¿èƒ½)ä¸­æ–­ï¼Œæ‰€ä»¥ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»ä½¿èƒ½ä¸­æ–­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">request_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq,</span></span><br><span class="line"><span class="params"><span class="type">irq_handler_t</span> handler,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">long</span> flags,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="type">void</span> *dev)</span></span><br></pre></td></tr></table></figure><p>irqï¼šè¦ç”³è¯·ä¸­æ–­çš„ä¸­æ–­å·ã€‚</p><p>æ¯ä¸ªä¸­æ–­éƒ½æœ‰ä¸€ä¸ªä¸­æ–­å·ï¼Œé€šè¿‡ä¸­æ–­å·å³å¯åŒºåˆ†ä¸åŒçš„ä¸­æ–­ ã€‚</p><p>handlerï¼šä¸­æ–­å¤„ç†å‡½æ•°ï¼Œå½“ä¸­æ–­å‘ç”Ÿä»¥åå°±ä¼šæ‰§è¡Œæ­¤ä¸­æ–­å¤„ç†å‡½æ•°ã€‚<br>flagsï¼šä¸­æ–­æ ‡å¿—ï¼Œå¯ä»¥åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;interrupt.h é‡Œé¢æŸ¥çœ‹æ‰€æœ‰çš„ä¸­æ–­æ ‡å¿— </p><p>nameï¼šä¸­æ–­åå­—ï¼Œè®¾ç½®ä»¥åå¯ä»¥åœ¨&#x2F;proc&#x2F;interrupts æ–‡ä»¶ä¸­çœ‹åˆ°å¯¹åº”çš„ä¸­æ–­åå­—ã€‚<br>devï¼š å¦‚æœå°† flags è®¾ç½®ä¸º IRQF_SHARED çš„è¯ï¼Œ dev ç”¨æ¥åŒºåˆ†ä¸åŒçš„ä¸­æ–­ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°†<br>dev è®¾ç½®ä¸ºè®¾å¤‡ç»“æ„ä½“ï¼Œ dev ä¼šä¼ é€’ç»™ä¸­æ–­å¤„ç†å‡½æ•° irq_handler_t çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚<br>è¿”å›å€¼ï¼š 0 ä¸­æ–­ç”³è¯·æˆåŠŸï¼Œå…¶ä»–è´Ÿå€¼ ä¸­æ–­ç”³è¯·å¤±è´¥ï¼Œå¦‚æœè¿”å›-EBUSY çš„è¯è¡¨ç¤ºä¸­æ–­å·²ç»è¢«ç”³è¯·äº†ã€‚ </p><table><thead><tr><th>æ ‡å¿—</th><th>æè¿°</th></tr></thead><tbody><tr><td>IRQF_SHARED</td><td>å¤šä¸ªè®¾å¤‡å…±äº«ä¸€ä¸ªä¸­æ–­çº¿ï¼Œå…±äº«çš„æ‰€æœ‰ä¸­æ–­éƒ½å¿…é¡»æŒ‡å®šæ­¤æ ‡å¿—ã€‚å¦‚æœä½¿ç”¨å…±äº«ä¸­æ–­çš„è¯ï¼Œ request_irq å‡½æ•°çš„ dev å‚æ•°å°±æ˜¯å”¯ä¸€åŒºåˆ†çš„æ ‡å¿—</td></tr><tr><td>IRQF_ONESHOT</td><td>å•æ¬¡ä¸­æ–­ï¼Œä¸­æ–­æ‰§è¡Œä¸€æ¬¡å°±ç»“æŸã€‚</td></tr><tr><td>IRQF_TRIGGER_NONE</td><td>æ— è§¦å‘</td></tr><tr><td>IRQF_TRIGGER_RISING</td><td>ä¸Šå‡æ²¿è§¦å‘</td></tr><tr><td>IRQF_TRIGGER_FALLING</td><td>ä¸‹é™æ²¿è§¦å‘</td></tr><tr><td>IRQF_TRIGGER_HIGH</td><td>é«˜ç”µå¹³è§¦å‘</td></tr><tr><td>IRQF_TRIGGER_LOW</td><td>ä½ç”µå¹³è§¦å‘</td></tr></tbody></table><h4 id="free-irq-å‡½æ•°"><a href="#free-irq-å‡½æ•°" class="headerlink" title="free_irq å‡½æ•°"></a>free_irq å‡½æ•°</h4><p>é€šè¿‡ free_irq å‡½æ•°é‡Šæ”¾æ‰ç›¸åº”çš„ä¸­æ–­ã€‚ å¦‚æœä¸­æ–­ä¸æ˜¯å…±äº«çš„ï¼Œé‚£ä¹ˆ free_irq ä¼šåˆ é™¤ä¸­æ–­å¤„ç†å‡½æ•°å¹¶ä¸”ç¦æ­¢ä¸­æ–­ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq, <span class="type">void</span> *dev)</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦ä¸­æ–­å¤„ç†å‡½æ•°è¦ç›¸åº”çš„ä¸­æ–­å·ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘ void çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ä¸ªé€šç”¨æŒ‡é’ˆï¼Œéœ€è¦ä¸ request_irq å‡½æ•°çš„ dev å‚æ•°ä¿æŒä¸€è‡´ã€‚ç”¨äºåŒºåˆ†å…±äº«ä¸­æ–­çš„ä¸åŒè®¾å¤‡ï¼Œdev ä¹Ÿå¯ä»¥æŒ‡å‘è®¾å¤‡æ•°æ®ç»“æ„ã€‚ </p><p>ä¸­æ–­å¤„ç†å‡½æ•°çš„è¿”å›å€¼ä¸º irqreturn_t ç±»å‹ï¼Œ irqreturn_t ç±»å‹å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">irqreturn</span> &#123;</span></span><br><span class="line">IRQ_NONE = (<span class="number">0</span> &lt;&lt; <span class="number">0</span>),</span><br><span class="line">IRQ_HANDLED = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>),</span><br><span class="line">IRQ_WAKE_THREAD = (<span class="number">1</span> &lt;&lt; <span class="number">1</span>),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">irqreturn</span> <span class="title">irqreturn_t</span>;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º irqreturn_t æ˜¯ä¸ªæšä¸¾ç±»å‹ï¼Œä¸€å…±æœ‰ä¸‰ç§è¿”å›å€¼ã€‚ä¸€èˆ¬ä¸­æ–­æœåŠ¡å‡½æ•°è¿”å›å€¼ä½¿ç”¨å¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> IRQ_RETVAL(IRQ_HANDLED) </span><br></pre></td></tr></table></figure><h4 id="ä¸­æ–­ä½¿èƒ½ä¸ç¦æ­¢å‡½æ•°"><a href="#ä¸­æ–­ä½¿èƒ½ä¸ç¦æ­¢å‡½æ•°" class="headerlink" title="ä¸­æ–­ä½¿èƒ½ä¸ç¦æ­¢å‡½æ•°"></a>ä¸­æ–­ä½¿èƒ½ä¸ç¦æ­¢å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">enable_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq)</span><span class="comment">//ä½¿èƒ½ä¸­æ–­irqä¸ºä¸­æ–­å·</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">disable_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq)</span><span class="comment">//ç¦æ­¢ä¸­æ–­</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">disable_irq_nosync</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq)</span><span class="comment">//éœ€è¦ä¿è¯ä¸ä¼šäº§ç”Ÿæ–°çš„ä¸­æ–­ï¼Œå¹¶ä¸”ç¡®ä¿æ‰€æœ‰å·²ç»å¼€å§‹æ‰§è¡Œçš„ä¸­æ–­å¤„ç†ç¨‹åºå·²ç»å…¨éƒ¨é€€å‡º,è°ƒç”¨ä»¥åç«‹å³è¿”å›ï¼Œä¸ä¼šç­‰å¾…å½“å‰ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œå®Œæ¯•</span></span><br><span class="line"><span class="title function_">local_irq_enable</span><span class="params">()</span><span class="comment">//ä½¿èƒ½å½“å‰å¤„ç†å™¨ä¸­æ–­ç³»ç»Ÿ</span></span><br><span class="line"><span class="title function_">local_irq_disable</span><span class="params">()</span><span class="comment">//ç¦æ­¢å½“å‰ä¸­æ–­ç³»ç»Ÿ</span></span><br><span class="line"><span class="title function_">local_irq_save</span><span class="params">(flags)</span><span class="comment">//ç”¨äºç¦æ­¢ä¸­æ–­ï¼Œå¹¶ä¸”å°†ä¸­æ–­çŠ¶æ€ä¿å­˜åœ¨ flags ä¸­</span></span><br><span class="line"><span class="title function_">local_irq_restore</span><span class="params">(flags)</span><span class="comment">//ç”¨äºæ¢å¤ä¸­æ–­ï¼Œå°†ä¸­æ–­åˆ° flags çŠ¶æ€</span></span><br></pre></td></tr></table></figure><h4 id="ä¸­æ–­ä¸Šä¸‹éƒ¨"><a href="#ä¸­æ–­ä¸Šä¸‹éƒ¨" class="headerlink" title="ä¸­æ–­ä¸Šä¸‹éƒ¨"></a>ä¸­æ–­ä¸Šä¸‹éƒ¨</h4><p>ä¸­æ–­å¤„ç†è¿‡ç¨‹å°±åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†ï¼š<br>ä¸ŠåŠéƒ¨ï¼šä¸ŠåŠéƒ¨å°±æ˜¯ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œé‚£äº›å¤„ç†è¿‡ç¨‹æ¯”è¾ƒå¿«ï¼Œä¸ä¼šå ç”¨å¾ˆé•¿æ—¶é—´çš„å¤„ç†å°±å¯ä»¥æ”¾åœ¨ä¸ŠåŠéƒ¨å®Œæˆã€‚<br>ä¸‹åŠéƒ¨ï¼šå¦‚æœä¸­æ–­å¤„ç†è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå°±å°†è¿™äº›æ¯”è¾ƒè€—æ—¶çš„ä»£ç æå‡ºæ¥ï¼Œäº¤ç»™ä¸‹åŠéƒ¨å»æ‰§è¡Œï¼Œè¿™æ ·ä¸­æ–­å¤„ç†å‡½æ•°å°±ä¼šå¿«è¿›å¿«å‡ºã€‚ </p><p>å¯¹äºç½‘å¡çš„ä¸­æ–­å¤„ç†ï¼Œä¸ŠåŠéƒ¨ä¼šæ‰§è¡Œé€šçŸ¥ç¡¬ä»¶ã€æ‹·è´ç½‘ç»œæ•°æ®æŠ¥åˆ°å†…å­˜å¹¶ç»§ç»­è¯»å–æ–°æ•°æ®åŒ…ï¼Œè¿™äº›é‡è¦ã€ç´§æ€¥ä¸”ä¸ç¡¬ä»¶ç›¸å…³çš„å·¥ä½œï¼Œå› ä¸ºç½‘å¡æ¥æ”¶çš„ç½‘ç»œæ•°æ®åŒ…çš„ç¼“å­˜å¤§å°é€šå¸¸æ˜¯å›ºå®šçš„ã€æœ‰é™çš„ï¼Œä¸€æ—¦è¢«å»¶è¿Ÿå¯èƒ½é€ æˆç¼“å­˜æº¢å‡ºã€‚è€Œæ•°æ®åŒ…çš„å¤„ç†ç­‰æ“ä½œï¼Œåˆ™ç”±ä¸‹åŠéƒ¨æ¥å®Œæˆã€‚</p><p>Linux å†…æ ¸å°†ä¸­æ–­åˆ†ä¸ºä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨çš„ä¸»è¦ç›®çš„å°±æ˜¯å®ç°ä¸­æ–­å¤„ç†å‡½æ•°çš„å¿«è¿›å¿«å‡ºï¼Œé‚£äº›å¯¹æ—¶é—´æ•æ„Ÿã€æ‰§è¡Œé€Ÿåº¦å¿«çš„æ“ä½œå¯ä»¥æ”¾åˆ°ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸ŠåŠéƒ¨ã€‚å‰©ä¸‹çš„æ‰€æœ‰å·¥ä½œéƒ½å¯ä»¥æ”¾åˆ°ä¸‹åŠéƒ¨å»æ‰§è¡Œï¼Œæ¯”å¦‚åœ¨ä¸ŠåŠéƒ¨å°†æ•°æ®æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œå…³äºæ•°æ®çš„å…·ä½“å¤„ç†å°±å¯ä»¥æ”¾åˆ°ä¸‹åŠéƒ¨å»æ‰§è¡Œã€‚è‡³äºå“ªäº›ä»£ç å±äºä¸ŠåŠéƒ¨ï¼Œå“ªäº›ä»£ç å±äºä¸‹åŠéƒ¨å¹¶æ²¡æœ‰æ˜ç¡®çš„è§„å®š ã€‚</p><ol><li>å¦‚æœè¦å¤„ç†çš„å†…å®¹ä¸å¸Œæœ›è¢«å…¶ä»–ä¸­æ–­æ‰“æ–­ï¼Œé‚£ä¹ˆå¯ä»¥æ”¾åˆ°ä¸ŠåŠéƒ¨ã€‚</li><li>å¦‚æœè¦å¤„ç†çš„ä»»åŠ¡å¯¹æ—¶é—´æ•æ„Ÿï¼Œå¯ä»¥æ”¾åˆ°ä¸ŠåŠéƒ¨ã€‚</li><li>å¦‚æœè¦å¤„ç†çš„ä»»åŠ¡ä¸ç¡¬ä»¶æœ‰å…³ï¼Œå¯ä»¥æ”¾åˆ°ä¸ŠåŠéƒ¨</li><li>é™¤äº†ä¸Šè¿°ä¸‰ç‚¹ä»¥å¤–çš„å…¶ä»–ä»»åŠ¡ï¼Œä¼˜å…ˆè€ƒè™‘æ”¾åˆ°ä¸‹åŠéƒ¨ã€‚</li></ol><h4 id="è½¯ä¸­æ–­"><a href="#è½¯ä¸­æ–­" class="headerlink" title="è½¯ä¸­æ–­"></a>è½¯ä¸­æ–­</h4><p>2.5ç‰ˆæœ¬ä»¥å‰ä½¿ç”¨BH(bottom half)å®ç°ä¸‹åŠéƒ¨åˆ†ï¼Œä¹‹åéƒ½æ˜¯ä½¿ç”¨è½¯ä¸­æ–­æ ¸taskletä»£æ›¿BHæœºåˆ¶ã€‚Linuxå†…æ ¸ä½¿ç”¨ç»“æ„ä½“softirq_actionè¡¨ç¤ºè½¯ä¸­æ–­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">softirq_action</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">void</span>(*action)(<span class="keyword">struct</span> softirq_action *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨kernel&#x2F;softirq.cæ–‡ä»¶ä¸­ä¸€å…±å®šä¹‰äº†10ä¸ªè½¯ä¸­æ–­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">softirq_action</span> <span class="title">softirq_vec</span>[<span class="title">NR_SOFTIRQS</span>];</span></span><br></pre></td></tr></table></figure><p>NR_SOFTIRQSæ˜¯æšä¸¾ç±»å‹ï¼Œå®šä¹‰åœ¨æ–‡ä»¶include&#x2F;linux&#x2F;interrupt.hä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">HI_SOFTIRQ=<span class="number">0</span>, <span class="comment">/* é«˜ä¼˜å…ˆçº§è½¯ä¸­æ–­ */</span></span><br><span class="line">TIMER_SOFTIRQ, <span class="comment">/* å®šæ—¶å™¨è½¯ä¸­æ–­ */</span></span><br><span class="line">NET_TX_SOFTIRQ, <span class="comment">/* ç½‘ç»œæ•°æ®å‘é€è½¯ä¸­æ–­ */</span></span><br><span class="line">NET_RX_SOFTIRQ, <span class="comment">/* ç½‘ç»œæ•°æ®æ¥æ”¶è½¯ä¸­æ–­ */</span></span><br><span class="line">BLOCK_SOFTIRQ,</span><br><span class="line">BLOCK_IOPOLL_SOFTIRQ,</span><br><span class="line">TASKLET_SOFTIRQ, <span class="comment">/* tasklet è½¯ä¸­æ–­ */</span></span><br><span class="line">SCHED_SOFTIRQ, <span class="comment">/* è°ƒåº¦è½¯ä¸­æ–­ */</span></span><br><span class="line">HRTIMER_SOFTIRQ, <span class="comment">/* é«˜ç²¾åº¦å®šæ—¶å™¨è½¯ä¸­æ–­ */</span></span><br><span class="line">RCU_SOFTIRQ, <span class="comment">/* RCU è½¯ä¸­æ–­ */</span></span><br><span class="line">NR_SOFTIRQS</span><br><span class="line">&#125;ï¼›</span><br></pre></td></tr></table></figure><p>softirq_action ç»“æ„ä½“ä¸­çš„ action æˆå‘˜å˜é‡å°±æ˜¯è½¯ä¸­æ–­çš„æœåŠ¡å‡½æ•°ï¼Œæ•°ç»„ softirq_vec æ˜¯ä¸ªå…¨å±€æ•°ç»„ï¼Œå› æ­¤æ‰€æœ‰çš„ CPU(å¯¹äº SMP ç³»ç»Ÿè€Œè¨€)éƒ½å¯ä»¥è®¿é—®åˆ°ï¼Œæ¯ä¸ª CPU éƒ½æœ‰è‡ªå·±çš„è§¦å‘å’Œæ§åˆ¶æœºåˆ¶ï¼Œå¹¶ä¸”åªæ‰§è¡Œè‡ªå·±æ‰€è§¦å‘çš„è½¯ä¸­æ–­ã€‚ä½†æ˜¯å„ä¸ª CPU æ‰€æ‰§è¡Œçš„è½¯ä¸­æ–­æœåŠ¡å‡½æ•°ç¡®æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯æ•°ç»„ softirq_vec ä¸­å®šä¹‰çš„ action å‡½æ•°ã€‚ </p><p>è¦ä½¿ç”¨è½¯ä¸­æ–­ï¼Œå¿…é¡»å…ˆä½¿ç”¨ open_softirq å‡½æ•°æ³¨å†Œå¯¹åº”çš„è½¯ä¸­æ–­å¤„ç†å‡½æ•° </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">open_softirq</span><span class="params">(<span class="type">int</span> nr, <span class="type">void</span> (*action)(<span class="keyword">struct</span> softirq_action *))</span></span><br><span class="line"><span class="comment">//nrï¼šè¦å¼€å¯çš„è½¯ä¸­æ–­ï¼Œ</span></span><br><span class="line"><span class="comment">//actionï¼šè½¯ä¸­æ–­å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š æ²¡æœ‰è¿”å›å€¼ã€‚</span></span><br></pre></td></tr></table></figure><p>æ³¨å†Œå¥½è½¯ä¸­æ–­ä»¥åéœ€è¦é€šè¿‡ raise_softirq å‡½æ•°è§¦å‘ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">raise_softirq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> nr)</span></span><br><span class="line"><span class="comment">//nrï¼šè¦è§¦å‘çš„è½¯ä¸­æ–­</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š æ²¡æœ‰è¿”å›å€¼ã€‚</span></span><br></pre></td></tr></table></figure><p>è½¯ä¸­æ–­å¿…é¡»åœ¨ç¼–è¯‘çš„æ—¶å€™é™æ€æ³¨å†Œï¼ Linux å†…æ ¸ä½¿ç”¨ softirq_init å‡½æ•°åˆå§‹åŒ–è½¯ä¸­æ–­ï¼Œsoftirq_init å‡½æ•°å®šä¹‰åœ¨ kernel&#x2F;softirq.c æ–‡ä»¶é‡Œé¢ï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init <span class="title function_">softirq_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> cpu;</span><br><span class="line"></span><br><span class="line">for_each_possible_cpu(cpu) &#123;</span><br><span class="line">per_cpu(tasklet_vec, cpu).tail =&amp;per_cpu(tasklet_vec, cpu).head;</span><br><span class="line">per_cpu(tasklet_hi_vec, cpu).tail =&amp;per_cpu(tasklet_hi_vec, cpu).head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">open_softirq(TASKLET_SOFTIRQ, tasklet_action);</span><br><span class="line">open_softirq(HI_SOFTIRQ, tasklet_hi_action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tasklet æ˜¯åˆ©ç”¨è½¯ä¸­æ–­æ¥å®ç°çš„å¦å¤–ä¸€ç§ä¸‹åŠéƒ¨æœºåˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span>//ç»“æ„ä½“</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">next</span>;</span> <span class="comment">/* ä¸‹ä¸€ä¸ª tasklet */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> state; <span class="comment">/* tasklet çŠ¶æ€ */</span></span><br><span class="line"><span class="type">atomic_t</span> count; <span class="comment">/* è®¡æ•°å™¨ï¼Œè®°å½•å¯¹ tasklet çš„å¼•ç”¨æ•° */</span></span><br><span class="line"><span class="type">void</span> (*func)(<span class="type">unsigned</span> <span class="type">long</span>); <span class="comment">/* tasklet æ‰§è¡Œçš„å‡½æ•° */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> data; <span class="comment">/* å‡½æ•° func çš„å‚æ•° */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">tasklet_init</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t, <span class="type">void</span> (*func)(<span class="type">unsigned</span> <span class="type">long</span>), <span class="type">unsigned</span> <span class="type">long</span> data)</span></span><br><span class="line"><span class="comment">//tï¼šè¦åˆå§‹åŒ–çš„ tasklet</span></span><br><span class="line"><span class="comment">//funcï¼š tasklet çš„å¤„ç†å‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">//dataï¼š è¦ä¼ é€’ç»™ func å‡½æ•°çš„å‚æ•°</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š æ²¡æœ‰è¿”å›å€¼ã€‚</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸ŠåŠéƒ¨ï¼Œä¹Ÿå°±æ˜¯ä¸­æ–­å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ tasklet_schedule å‡½æ•°å°±èƒ½ä½¿ tasklet åœ¨åˆé€‚çš„æ—¶é—´è¿è¡Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">tasklet_schedule</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></span><br><span class="line"><span class="comment">//tï¼šè¦è°ƒåº¦çš„ taskletï¼Œä¹Ÿå°±æ˜¯ DECLARE_TASKLET å®é‡Œé¢çš„ nameã€‚</span></span><br></pre></td></tr></table></figure><p>taskletçš„ä½¿ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®šä¹‰ taselet */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> <span class="title">testtasklet</span>;</span></span><br><span class="line"><span class="comment">/* tasklet å¤„ç†å‡½æ•° */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">testtasklet_func</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> data)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* tasklet å…·ä½“å¤„ç†å†…å®¹ */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ä¸­æ–­å¤„ç†å‡½æ•° */</span></span><br><span class="line"><span class="type">irqreturn_t</span> <span class="title function_">test_handler</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* è°ƒåº¦ tasklet */</span></span><br><span class="line">tasklet_schedule(&amp;testtasklet);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* åˆå§‹åŒ– tasklet */</span></span><br><span class="line">tasklet_init(&amp;testtasklet, testtasklet_func, data);</span><br><span class="line"><span class="comment">/* æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•° */</span></span><br><span class="line">request_irq(xxx_irq, test_handler, <span class="number">0</span>, <span class="string">&quot;xxx&quot;</span>, &amp;xxx_dev);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å·¥ä½œé˜Ÿåˆ—"><a href="#å·¥ä½œé˜Ÿåˆ—" class="headerlink" title="å·¥ä½œé˜Ÿåˆ—"></a>å·¥ä½œé˜Ÿåˆ—</h4><p>å·¥ä½œé˜Ÿåˆ—æ˜¯å¦å¤–ä¸€ç§ä¸‹åŠéƒ¨æ‰§è¡Œæ–¹å¼ï¼Œå·¥ä½œé˜Ÿåˆ—åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡æ‰§è¡Œï¼Œå·¥ä½œé˜Ÿåˆ—å°†è¦æ¨åçš„å·¥ä½œäº¤ç»™ä¸€ä¸ªå†…æ ¸çº¿ç¨‹å»æ‰§è¡Œï¼Œå› ä¸ºå·¥ä½œé˜Ÿåˆ—å·¥ä½œåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œå› æ­¤å·¥ä½œé˜Ÿåˆ—å…è®¸ç¡çœ æˆ–é‡æ–°è°ƒåº¦ã€‚å› æ­¤å¦‚æœä½ è¦æ¨åçš„å·¥ä½œå¯ä»¥ç¡çœ é‚£ä¹ˆå°±å¯ä»¥é€‰æ‹©å·¥ä½œé˜Ÿåˆ—ï¼Œå¦åˆ™çš„è¯å°±åªèƒ½é€‰æ‹©è½¯ä¸­æ–­æˆ– taskletã€‚ </p><p>å·¥ä½œé˜Ÿåˆ—ç»“æ„ä½“workqueue_structç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">pwqs</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line"><span class="type">int</span> work_color;</span><br><span class="line"><span class="type">int</span> flush_color;</span><br><span class="line"><span class="type">atomic_t</span> nr_pwqs_to_flush;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wq_flusher</span> *<span class="title">first_flusher</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">flusher_queue</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">flusher_overflow</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">maydays</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker</span> *<span class="title">rescuer</span>;</span></span><br><span class="line"><span class="type">int</span> nr_drainers;</span><br><span class="line"><span class="type">int</span> saved_max_active;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">workqueue_attrs</span> *<span class="title">unbound_attrs</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pool_workqueue</span> *<span class="title">dfl_pwq</span>;</span></span><br><span class="line"><span class="type">char</span> name[WQ_NAME_LEN];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags ____cacheline_aligned;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pool_workqueue</span> __<span class="title">percpu</span> *<span class="title">cpu_pwqs</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pool_workqueue</span> __<span class="title">rcu</span> *<span class="title">numa_pwq_tbl</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å†…æ ¸ä½¿ç”¨å·¥ä½œè€…çº¿ç¨‹(worker thread)æ¥å¤„ç†å·¥ä½œé˜Ÿåˆ—çš„å„ä¸ªå·¥ä½œï¼ŒLinuxä½¿ç”¨workerç»“æ„ä½“è¡¨ç¤ºå·¥ä½œè€…çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">hentry</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> *<span class="title">current_work</span>;</span></span><br><span class="line"><span class="type">work_func_t</span> current_func;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pool_workqueue</span> *<span class="title">current_pwq</span>;</span></span><br><span class="line"><span class="type">bool</span> desc_valid;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">scheduled</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">worker_pool</span> *<span class="title">pool</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> last_active;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="type">int</span> id;</span><br><span class="line"><span class="type">char</span> desc[WORKER_DESC_LEN];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> *<span class="title">rescue_wq</span>;</span><span class="comment">//å·¥ä½œé˜Ÿåˆ—</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ›å»ºå·¥ä½œå¾ˆç®€å•ï¼Œç›´æ¥å®šä¹‰ä¸€ä¸ª work_struct ç»“æ„ä½“å˜é‡å³å¯ï¼Œç„¶åä½¿ç”¨ INIT_WORK å®æ¥åˆå§‹åŒ–å·¥ä½œï¼Œ INIT_WORK å®å®šä¹‰å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_WORK(_work, _func)</span></span><br><span class="line"><span class="comment">//work è¡¨ç¤ºè¦åˆå§‹åŒ–çš„å·¥ä½œï¼Œ _func æ˜¯å·¥ä½œå¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ DECLARE_WORK å®ä¸€æ¬¡æ€§å®Œæˆå·¥ä½œçš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œå®å®šä¹‰å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_WORK(n, f)</span></span><br><span class="line"><span class="comment">//n è¡¨ç¤ºå®šä¹‰çš„å·¥ä½œ(work_struct)ï¼Œ f è¡¨ç¤ºå·¥ä½œå¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚</span></span><br></pre></td></tr></table></figure><p>å’Œ tasklet ä¸€æ ·ï¼Œå·¥ä½œä¹Ÿæ˜¯éœ€è¦è°ƒåº¦æ‰èƒ½è¿è¡Œçš„ï¼Œå·¥ä½œçš„è°ƒåº¦å‡½æ•°ä¸º schedule_workï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">schedule_work</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span></span><br><span class="line"><span class="comment">//workï¼š è¦è°ƒåº¦çš„å·¥ä½œã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0 æˆåŠŸï¼Œå…¶ä»–å€¼ å¤±è´¥ã€‚ </span></span><br></pre></td></tr></table></figure><p>å·¥ä½œé˜Ÿåˆ—çš„ä½¿ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®šä¹‰å·¥ä½œ(work) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">testwork</span>;</span></span><br><span class="line"><span class="comment">/* work å¤„ç†å‡½æ•° */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">testwork_func_t</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span>;</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* work å…·ä½“å¤„ç†å†…å®¹ */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ä¸­æ–­å¤„ç†å‡½æ•° */</span></span><br><span class="line"><span class="type">irqreturn_t</span> <span class="title function_">test_handler</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* è°ƒåº¦ work */</span></span><br><span class="line">schedule_work(&amp;testwork);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* åˆå§‹åŒ– work */</span></span><br><span class="line">INIT_WORK(&amp;testwork, <span class="type">testwork_func_t</span>);</span><br><span class="line"><span class="comment">/* æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•° */</span></span><br><span class="line">request_irq(xxx_irq, test_handler, <span class="number">0</span>, <span class="string">&quot;xxx&quot;</span>, &amp;xxx_dev);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-05-06%20143233.png"></p><h4 id="è¡¥å……æ‚é¡¹"><a href="#è¡¥å……æ‚é¡¹" class="headerlink" title="è¡¥å……æ‚é¡¹"></a>è¡¥å……æ‚é¡¹</h4><h5 id="volatileå…³é”®å­—"><a href="#volatileå…³é”®å­—" class="headerlink" title="volatileå…³é”®å­—"></a>volatileå…³é”®å­—</h5><p>Volatileæ„æ€æ˜¯â€œæ˜“å˜çš„â€ï¼Œ<strong>ç›´æ¥ä»å˜é‡åœ°å€ä¸­è¯»å–æ•°æ®</strong>ã€‚â€œæ˜“å˜â€æ˜¯å› ä¸ºå¤–åœ¨å› ç´ å¼•èµ·çš„ï¼Œåƒå¤šçº¿ç¨‹ï¼Œä¸­æ–­ç­‰ã€‚</p><p>volatileæé†’ç¼–è¯‘å™¨å®ƒåé¢æ‰€å®šä¹‰çš„å˜é‡éšæ—¶éƒ½æœ‰å¯èƒ½æ”¹å˜ï¼Œå› æ­¤ç¼–è¯‘åçš„ç¨‹åºæ¯æ¬¡éœ€è¦å­˜å‚¨æˆ–è¯»å–è¿™ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å¯¹è¯¥å˜é‡ä¸åšä¼˜åŒ–ï¼Œéƒ½ä¼šç›´æ¥ä»å˜é‡å†…å­˜åœ°å€ä¸­è¯»å–æ•°æ®ï¼Œä»è€Œå¯ä»¥æä¾›å¯¹ç‰¹æ®Šåœ°å€çš„ç¨³å®šè®¿é—®ã€‚</p><p>å¦‚æœæ²¡æœ‰volatileå…³é”®å­—ï¼Œåˆ™ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–è¯»å–å’Œå­˜å‚¨ï¼Œå¯èƒ½æš‚æ—¶ä½¿ç”¨å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œå¦‚æœè¿™ä¸ªå˜é‡ç”±åˆ«çš„ç¨‹åºæ›´æ–°äº†çš„è¯ï¼Œå°†å‡ºç°ä¸ä¸€è‡´çš„ç°è±¡ã€‚ï¼ˆç®€æ´çš„è¯´å°±æ˜¯ï¼švolatileå…³é”®è¯å½±å“ç¼–è¯‘å™¨ç¼–è¯‘çš„ç»“æœï¼Œç”¨volatileå£°æ˜çš„å˜é‡è¡¨ç¤ºè¯¥å˜é‡éšæ—¶å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œä¸è¯¥å˜é‡æœ‰å…³çš„è¿ç®—ï¼Œä¸è¦è¿›è¡Œç¼–è¯‘ä¼˜åŒ–ï¼Œä»¥å…å‡ºé”™ï¼‰</p><p><strong>ä½¿ç”¨åœºæ™¯</strong></p><ol><li>å¹¶è¡Œè®¾å¤‡çš„ç¡¬ä»¶å¯„å­˜å™¨ï¼ˆå¦‚ï¼šçŠ¶æ€å¯„å­˜å™¨ï¼‰ å­˜å‚¨å™¨æ˜ å°„çš„ç¡¬ä»¶å¯„å­˜å™¨é€šå¸¸ä¹Ÿè¦åŠ  voliateï¼Œå› ä¸ºæ¯æ¬¡å¯¹å®ƒçš„è¯»å†™éƒ½å¯èƒ½æœ‰ä¸åŒæ„ä¹‰ã€‚</li><li><strong>ä¸­æ–­æœåŠ¡ç¨‹åºä¸­ä¿®æ”¹çš„ä¾›å…¶å®ƒç¨‹åºæ£€æµ‹çš„å˜é‡ï¼Œéœ€è¦åŠ volatileï¼›</strong></li><li>å¤šä»»åŠ¡ç¯å¢ƒä¸‹å„ä¸ªä»»åŠ¡é—´çš„å…±äº«æ ‡å¿—ï¼Œåº”è¯¥åŠ volatile</li><li>å­˜å‚¨å™¨æ˜ å°„çš„ç¡¬ä»¶å¯„å­˜å™¨é€šå¸¸å¶å®¶volatileè¯´æ˜ï¼Œå› ä¸ºæ¯æ¬¡å¯¹å®ƒçš„è¯»å†™éƒ½å¯èƒ½æœ‰ä¸åŒçš„æ„ä¹‰ã€‚</li></ol><h5 id="volatile-é—®é¢˜å’Œæ€»ç»“"><a href="#volatile-é—®é¢˜å’Œæ€»ç»“" class="headerlink" title="volatile é—®é¢˜å’Œæ€»ç»“"></a>volatile é—®é¢˜å’Œæ€»ç»“</h5><ol><li><p>ä¸€ä¸ªå‚æ•°æ—¢å¯ä»¥æ˜¯constè¿˜å¯ä»¥æ˜¯volatileå—ï¼Ÿ</p><p>å¯ä»¥çš„ï¼Œä¾‹å¦‚åªè¯»çš„çŠ¶æ€å¯„å­˜å™¨ã€‚å®ƒæ˜¯volatileå› ä¸ºå®ƒå¯èƒ½è¢«æ„æƒ³ä¸åˆ°åœ°æ”¹å˜ã€‚å®ƒæ˜¯constå› ä¸ºç¨‹åºä¸åº”è¯¥è¯•å›¾å»ä¿®æ”¹å®ƒã€‚</p></li><li><p>ä¸€ä¸ªæŒ‡é’ˆå¯ä»¥æ˜¯volatileå—ï¼Ÿ</p><p>å¯ä»¥ï¼Œå½“ä¸€ä¸ªä¸­æœåŠ¡å­ç¨‹åºä¿®æ”¹ä¸€ä¸ªæŒ‡å‘bufferçš„æŒ‡é’ˆæ—¶ã€‚</p></li></ol><p>volatile longå¯ä»¥ä¿è¯å…¶å¯è§æ€§ã€‚ï¼ˆå¤šçº¿ç¨‹å®‰å…¨ä¸‰å¤§ç‰¹æ€§ï¼šå¯è§æ€§ï¼ŒåŸå­æ€§ï¼Œæœ‰åºæ€§ï¼‰</p><p>é€šå¸¸æ¥è¯´ï¼ŒVolatileè¿™ä¸ªå…³é”®å­—çš„ä½œç”¨ä»…ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œå¹¶ä¸ä¿è¯åŸå­æ€§ï¼Œè€Œå¯¹äºdoubleå’Œlongçš„è¯»å†™ï¼ŒVolatileè¿˜é¢å¤–ä¿è¯äº†è¯»å†™çš„åŸå­æ€§ã€‚Volatileå¯¹äºdoubleã€longçš„è¯»å†™åŸå­æ€§ä»…æŒ‡å•æ¬¡è¯»æˆ–å•æ¬¡å†™ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œåŒæ—¶å…·æœ‰è¯»å†™ã€‚</p><p><strong>åŸå­æ€§ï¼š</strong>æ“ä½œæ˜¯ä¸å¯åˆ†çš„ã€‚å…¶è¡¨ç°åœ¨äºå¯¹äºå…±äº«å˜é‡çš„æŸäº›æ“ä½œï¼Œåº”è¯¥æ˜¯ä¸å¯åˆ†çš„ï¼Œå¿…é¡»è¿ç»­å®Œæˆã€‚</p><p><strong>å¯è§æ€§ï¼š</strong>å¯è§æ€§æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°ï¼›</p><p><strong>æœ‰åºæ€§ï¼š</strong>æŒ‡ç¨‹åºåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œç¨‹åºçš„ä»£ç æ‰§è¡Œé¡ºåºå’Œè¯­å¥çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µå‘¢ï¼Ÿ<br>è¿™æ˜¯ç”±äºé‡æ’åºçš„ç¼˜æ•…ã€‚</p><p>åœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºï¼›é‡æ’åºä¸ä¼šå½±å“å•çº¿ç¨‹çš„æ‰§è¡Œç»“æœï¼Œä½†æ˜¯åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°è¯¡å¼‚çš„BUGã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxå†…æ ¸å®šæ—¶å™¨</title>
      <link href="/2023/04/25/2023-4-25-linux%E5%86%85%E6%A0%B8%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
      <url>/2023/04/25/2023-4-25-linux%E5%86%85%E6%A0%B8%E5%AE%9A%E6%97%B6%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="æ—¶é—´ç®¡ç†å’Œå†…æ ¸å®šæ—¶å™¨"><a href="#æ—¶é—´ç®¡ç†å’Œå†…æ ¸å®šæ—¶å™¨" class="headerlink" title="æ—¶é—´ç®¡ç†å’Œå†…æ ¸å®šæ—¶å™¨"></a>æ—¶é—´ç®¡ç†å’Œå†…æ ¸å®šæ—¶å™¨</h2><p>Linux å†…æ ¸ä¸­æœ‰å¤§é‡çš„å‡½æ•°éœ€è¦æ—¶é—´ç®¡ç†ï¼Œæ¯”å¦‚å‘¨æœŸæ€§çš„è°ƒåº¦ç¨‹åºã€å»¶æ—¶ç¨‹åºã€å¯¹äºæˆ‘ä»¬é©±åŠ¨ç¼–å†™è€…æ¥è¯´æœ€å¸¸ç”¨çš„å®šæ—¶å™¨ã€‚ç¡¬ä»¶å®šæ—¶å™¨æä¾›æ—¶é’Ÿæºï¼Œæ—¶é’Ÿæºçš„é¢‘ç‡å¯ä»¥è®¾ç½®ï¼Œ è®¾ç½®å¥½ä»¥åå°±å‘¨æœŸæ€§çš„äº§ç”Ÿå®šæ—¶ä¸­æ–­ï¼Œç³»ç»Ÿä½¿ç”¨å®šæ—¶ä¸­æ–­æ¥è®¡æ—¶ã€‚ä¸­æ–­å‘¨æœŸæ€§äº§ç”Ÿçš„é¢‘ç‡å°±æ˜¯ç³»ç»Ÿé¢‘ç‡ï¼Œä¹Ÿå«åšèŠ‚æ‹ç‡(tick rate)(æœ‰çš„èµ„æ–™ä¹Ÿå«ç³»ç»Ÿé¢‘ç‡)ã€‚</p><p>å¯ä»¥åœ¨ç¼–è¯‘ Linux å†…æ ¸çš„æ—¶å€™å¯ä»¥é€šè¿‡å›¾å½¢åŒ–ç•Œé¢è®¾ç½®ç³»ç»ŸèŠ‚æ‹ç‡ï¼Œ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt; Kernel Features</span><br><span class="line">-&gt; Timer frequency (&lt;choice&gt; [=y])</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-24%20205453.png"></p><p>é«˜èŠ‚æ‹ç‡å’Œä½èŠ‚æ‹ç‡çš„ä¼˜ç¼ºç‚¹ï¼š </p><p>â‘ ã€é«˜èŠ‚æ‹ç‡ä¼šæé«˜ç³»ç»Ÿæ—¶é—´ç²¾åº¦ï¼Œå¦‚æœé‡‡ç”¨ 100Hz çš„èŠ‚æ‹ç‡ï¼Œæ—¶é—´ç²¾åº¦å°±æ˜¯ 10msï¼Œé‡‡ç”¨1000Hz çš„è¯æ—¶é—´ç²¾åº¦å°±æ˜¯ 1msï¼Œç²¾åº¦æé«˜äº† 10 å€ã€‚é«˜ç²¾åº¦æ—¶é’Ÿçš„å¥½å¤„æœ‰å¾ˆå¤šï¼Œå¯¹äºé‚£äº›å¯¹æ—¶é—´è¦æ±‚ä¸¥æ ¼çš„å‡½æ•°æ¥è¯´ï¼Œèƒ½å¤Ÿä»¥æ›´é«˜çš„ç²¾åº¦è¿è¡Œï¼Œæ—¶é—´æµ‹é‡ä¹Ÿæ›´åŠ å‡†ç¡®ã€‚<br>â‘¡ã€é«˜èŠ‚æ‹ç‡ä¼šå¯¼è‡´ä¸­æ–­çš„äº§ç”Ÿæ›´åŠ é¢‘ç¹ï¼Œé¢‘ç¹çš„ä¸­æ–­ä¼šåŠ å‰§ç³»ç»Ÿçš„è´Ÿæ‹…ï¼Œ 1000Hz å’Œ 100Hzçš„ç³»ç»ŸèŠ‚æ‹ç‡ç›¸æ¯”ï¼Œç³»ç»Ÿè¦èŠ±è´¹ 10 å€çš„â€œç²¾åŠ›â€å»å¤„ç†ä¸­æ–­ã€‚ä¸­æ–­æœåŠ¡å‡½æ•°å ç”¨å¤„ç†å™¨çš„æ—¶é—´å¢åŠ ï¼Œä½†æ˜¯ç°åœ¨çš„å¤„ç†å™¨æ€§èƒ½éƒ½å¾ˆå¼ºå¤§ï¼Œæ‰€ä»¥é‡‡ç”¨ 1000Hz çš„ç³»ç»ŸèŠ‚æ‹ç‡å¹¶ä¸ä¼šå¢åŠ å¤ªå¤§çš„è´Ÿè½½å‹åŠ›ã€‚æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µï¼Œé€‰æ‹©åˆé€‚çš„ç³»ç»ŸèŠ‚æ‹ç‡ã€‚</p><p>Linux å†…æ ¸ä½¿ç”¨å…¨å±€å˜é‡ jiffies æ¥è®°å½•ç³»ç»Ÿä»å¯åŠ¨ä»¥æ¥çš„ç³»ç»ŸèŠ‚æ‹æ•°ï¼Œç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ä¼šå°† jiffies åˆå§‹åŒ–ä¸º 0ï¼Œ jiffies å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;jiffies.h ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> u64 __jiffy_data jiffies_64;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="keyword">volatile</span> __jiffy_data jiffies;</span><br></pre></td></tr></table></figure><p>jiffies_64 å’Œ jiffies å…¶å®æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œ jiffies_64 ç”¨äº 64 ä½ç³»ç»Ÿï¼Œè€Œ jiffies ç”¨äº 32 ä½ç³»ç»Ÿã€‚ä¸ºäº†å…¼å®¹ä¸åŒçš„ç¡¬ä»¶ï¼Œ jiffies å…¶å®å°±æ˜¯ jiffies_64 çš„ä½ 32 ä½ ã€‚</p><p>å½“æˆ‘ä»¬è®¿é—® jiffies çš„æ—¶å€™å…¶å®è®¿é—®çš„æ˜¯ jiffies_64 çš„ä½ 32 ä½ï¼Œä½¿ç”¨ get_jiffies_64 è¿™ä¸ªå‡½æ•°å¯ä»¥è·å– jiffies_64 çš„å€¼ã€‚åœ¨ 32 ä½çš„ç³»ç»Ÿä¸Šè¯»å– jiffies çš„å€¼ï¼Œåœ¨ 64 ä½çš„ç³»ç»Ÿä¸Š jiffes å’Œ jiffies_64è¡¨ç¤ºåŒä¸€ä¸ªå˜é‡ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç›´æ¥è¯»å– jiffies çš„å€¼ã€‚æ‰€ä»¥ä¸ç®¡æ˜¯ 32 ä½çš„ç³»ç»Ÿè¿˜æ˜¯ 64 ä½ç³»ç»Ÿï¼Œéƒ½å¯ä»¥ä½¿ç”¨ jiffiesã€‚ </p><p>HZ è¡¨ç¤ºæ¯ç§’çš„èŠ‚æ‹æ•° ï¼Œjiffies è¡¨ç¤ºç³»ç»Ÿè¿è¡Œçš„ jiffies èŠ‚æ‹æ•°ï¼Œæ‰€ä»¥ jiffies&#x2F;HZ å°±æ˜¯ç³»ç»Ÿè¿è¡Œæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚ </p><p>ä¸ç®¡æ˜¯ 32 ä½è¿˜æ˜¯ 64 ä½çš„ jiffiesï¼Œéƒ½æœ‰æº¢å‡ºçš„é£é™©ï¼Œæº¢å‡ºä»¥åä¼šé‡æ–°ä» 0 å¼€å§‹è®¡æ•°ï¼Œç›¸å½“äºç»•å›æ¥äº†ï¼Œå› æ­¤æœ‰äº›èµ„æ–™ä¹Ÿå°†è¿™ä¸ªç°è±¡ä¹Ÿå«åšç»•å›ã€‚ Linux å†…æ ¸æä¾›äº†å¦‚è¡¨æ‰€ç¤ºçš„å‡ ä¸ª API å‡½æ•°æ¥å¤„ç†ç»•å› </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-24%20210737.png"></p><p>Linux å†…æ ¸æä¾›äº†å‡ ä¸ª jiffies å’Œ msã€ usã€ ns ä¹‹é—´çš„è½¬æ¢å‡½æ•° </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-24%20211000.png"></p><h3 id="å†…æ ¸å®šæ—¶å™¨"><a href="#å†…æ ¸å®šæ—¶å™¨" class="headerlink" title="å†…æ ¸å®šæ—¶å™¨"></a>å†…æ ¸å®šæ—¶å™¨</h3><p>å®šæ—¶å™¨æ˜¯ä¸€ä¸ªå¾ˆå¸¸ç”¨çš„åŠŸèƒ½ï¼Œéœ€è¦å‘¨æœŸæ€§å¤„ç†çš„å·¥ä½œéƒ½è¦ç”¨åˆ°å®šæ—¶å™¨ã€‚ Linux å†…æ ¸å®šæ—¶å™¨é‡‡ç”¨ç³»ç»Ÿæ—¶é’Ÿæ¥å®ç°ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬åœ¨è£¸æœºç¯‡ä¸­è®²è§£çš„ PIT ç­‰ç¡¬ä»¶å®šæ—¶å™¨ã€‚ Linux å†…æ ¸å®šæ—¶å™¨ä½¿ç”¨å¾ˆç®€å•ï¼Œåªéœ€è¦æä¾›è¶…æ—¶æ—¶é—´(ç›¸å½“äºå®šæ—¶å€¼)å’Œå®šæ—¶å¤„ç†å‡½æ•°å³å¯ï¼Œå½“è¶…æ—¶æ—¶é—´åˆ°äº†ä»¥åè®¾ç½®çš„å®šæ—¶å¤„ç†å‡½æ•°å°±ä¼šæ‰§è¡Œï¼Œå’Œæˆ‘ä»¬ä½¿ç”¨ç¡¬ä»¶å®šæ—¶å™¨çš„å¥—è·¯ä¸€æ ·ï¼Œåªæ˜¯ä½¿ç”¨å†…æ ¸å®šæ—¶å™¨ä¸éœ€è¦åšä¸€å¤§å †çš„å¯„å­˜å™¨åˆå§‹åŒ–å·¥ä½œã€‚åœ¨ä½¿ç”¨å†…æ ¸å®šæ—¶å™¨çš„æ—¶å€™è¦æ³¨æ„ä¸€ç‚¹ï¼Œå†…æ ¸å®šæ—¶å™¨å¹¶ä¸æ˜¯å‘¨æœŸæ€§è¿è¡Œçš„ï¼Œè¶…æ—¶ä»¥åå°±ä¼šè‡ªåŠ¨å…³é—­ï¼Œå› æ­¤å¦‚æœæƒ³è¦å®ç°å‘¨æœŸæ€§å®šæ—¶ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨å®šæ—¶å¤„ç†å‡½æ•°ä¸­é‡æ–°å¼€å¯å®šæ—¶å™¨ã€‚ </p><p>Linux å†…æ ¸ä½¿ç”¨ timer_list ç»“æ„ä½“è¡¨ç¤ºå†…æ ¸å®šæ—¶å™¨ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> expires; <span class="comment">/* å®šæ—¶å™¨è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯èŠ‚æ‹æ•° */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tvec_base</span> *<span class="title">base</span>;</span></span><br><span class="line"><span class="type">void</span> (*function)(<span class="type">unsigned</span> <span class="type">long</span>); <span class="comment">/* å®šæ—¶å¤„ç†å‡½æ•° */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> data; <span class="comment">/* è¦ä¼ é€’ç»™ function å‡½æ•°çš„å‚æ•° */</span></span><br><span class="line"><span class="type">int</span> slack;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="å®šæ—¶å™¨APIå‡½æ•°"><a href="#å®šæ—¶å™¨APIå‡½æ•°" class="headerlink" title="å®šæ—¶å™¨APIå‡½æ•°"></a>å®šæ—¶å™¨APIå‡½æ•°</h4><p>init_timer å‡½æ•°è´Ÿè´£åˆå§‹åŒ– timer_list ç±»å‹å˜é‡ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">init_timer</span><span class="params">(<span class="keyword">struct</span> timer_list *timer)</span></span><br><span class="line"><span class="comment">//timerè¦åˆå§‹åŒ–å®šæ—¶å™¨ï¼Œæ²¡æœ‰è¿”å›å€¼</span></span><br></pre></td></tr></table></figure><p>add_timerå‡½æ•°ç”¨äºå‘linuxå†…æ ¸æ³¨å†Œå®šæ—¶å™¨ï¼Œä½¿ç”¨add_timerå‡½æ•°æ³¨å†Œå®šæ—¶å™¨ä»¥åï¼Œå®šæ—¶å™¨è¿è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">add_timer</span><span class="params">(<span class="keyword">struct</span> timer_list *timer)</span></span><br><span class="line"><span class="comment">//timer:è¦æ³¨å†Œçš„å®šæ—¶å™¨ï¼Œæ²¡æœ‰è¿”å›å€¼</span></span><br></pre></td></tr></table></figure><p>del_timerå‡½æ•°ç”¨äºåˆ é™¤ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä¸ç®¡å®šæ—¶å™¨æ˜¯å¦è¢«æ¿€æ´»ï¼Œéƒ½èƒ½åˆ é™¤ã€‚åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œå®šæ—¶å™¨å¯èƒ½ä¼šåœ¨å…¶ä»–çš„å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œå› æ­¤åœ¨è°ƒç”¨ del_timer å‡½æ•°åˆ é™¤å®šæ—¶å™¨ä¹‹å‰è¦å…ˆç­‰å¾…å…¶ä»–å¤„ç†å™¨çš„å®šæ—¶å¤„ç†å™¨å‡½æ•°é€€å‡ºã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">del_timer</span><span class="params">(<span class="keyword">struct</span> timer_list *timer)</span></span><br><span class="line"><span class="comment">//timer:è¦åˆ é™¤çš„å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼: 0 å®šæ—¶å™¨è¿˜æ²¡è¢«æ¿€æ´»ï¼Œ1å®šæ—¶å™¨å·²ç»æ¿€æ´»</span></span><br></pre></td></tr></table></figure><p>del_timer_sync å‡½æ•°æ˜¯ del_timer å‡½æ•°çš„åŒæ­¥ç‰ˆï¼Œä¼šç­‰å¾…å…¶ä»–å¤„ç†å™¨ä½¿ç”¨å®Œå®šæ—¶å™¨å†åˆ é™¤ï¼Œdel_timer_sync ä¸èƒ½ä½¿ç”¨åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­ã€‚  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">del_timer_sync</span><span class="params">(<span class="keyword">struct</span> timer_list *timer)</span></span><br><span class="line"><span class="comment">//timerï¼šè¦åˆ é™¤çš„å®šæ—¶å™¨ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0ï¼Œå®šæ—¶å™¨è¿˜æ²¡è¢«æ¿€æ´»ï¼› 1ï¼Œå®šæ—¶å™¨å·²ç»æ¿€æ´»ã€‚  </span></span><br></pre></td></tr></table></figure><p>mod_timer å‡½æ•°ç”¨äºä¿®æ”¹å®šæ—¶å€¼ï¼Œå¦‚æœå®šæ—¶å™¨è¿˜æ²¡æœ‰æ¿€æ´»çš„è¯ï¼Œ mod_timer å‡½æ•°ä¼šæ¿€æ´»å®šæ—¶å™¨ï¼ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">mod_timer</span><span class="params">(<span class="keyword">struct</span> timer_list *timer, <span class="type">unsigned</span> <span class="type">long</span> expires)</span></span><br><span class="line"><span class="comment">//timer:è¦ä¿®æ”¹è¶…æ—¶æ—¶é—´ï¼ˆå®šæ—¶å€¼ï¼‰çš„å®šæ—¶å™¨</span></span><br><span class="line"><span class="comment">//expires:ä¿®æ”¹åçš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0ï¼Œè°ƒç”¨ mod_timer å‡½æ•°å‰å®šæ—¶å™¨æœªè¢«æ¿€æ´»ï¼› 1ï¼Œè°ƒç”¨ mod_timer å‡½æ•°å‰å®šæ—¶å™¨å·²è¢«æ¿€æ´»ã€‚</span></span><br></pre></td></tr></table></figure><h4 id="ioctlå‡½æ•°ï¼ˆè®¾å¤‡æ§åˆ¶æ¥å£å‡½æ•°ï¼‰"><a href="#ioctlå‡½æ•°ï¼ˆè®¾å¤‡æ§åˆ¶æ¥å£å‡½æ•°ï¼‰" class="headerlink" title="ioctlå‡½æ•°ï¼ˆè®¾å¤‡æ§åˆ¶æ¥å£å‡½æ•°ï¼‰"></a>ioctlå‡½æ•°ï¼ˆè®¾å¤‡æ§åˆ¶æ¥å£å‡½æ•°ï¼‰</h4><p>octlæ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºä¸­å¯¹è®¾å¤‡çš„I&#x2F;Oé€šé“è¿›è¡Œç®¡ç†çš„å‡½æ•°ã€‚æ‰€è°“å¯¹I&#x2F;Oé€šé“è¿›è¡Œç®¡ç†ï¼Œå°±æ˜¯å¯¹è®¾å¤‡çš„ä¸€äº›ç‰¹æ€§è¿›è¡Œæ§åˆ¶ï¼Œä¾‹å¦‚ä¸²å£çš„ä¼ è¾“æ³¢ç‰¹ç‡ã€é©¬è¾¾çš„è½¬é€Ÿç­‰ç­‰ã€‚å®ƒçš„è°ƒç”¨ä¸ªæ•°å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int ioctl(int fd, ind cmd, â€¦)ï¼›</span><br></pre></td></tr></table></figure><p>å…¶ä¸­fdå°±æ˜¯ç”¨æˆ·ç¨‹åºæ‰“å¼€è®¾å¤‡æ—¶ä½¿ç”¨openå‡½æ•°è¿”å›çš„æ–‡ä»¶æ ‡ç¤ºç¬¦ï¼Œcmdå°±æ˜¯ç”¨æˆ·ç¨‹åºå¯¹è®¾å¤‡çš„æ§åˆ¶å‘½ä»¤ï¼Œè‡³äºåé¢çš„çœç•¥å·ï¼Œé‚£æ˜¯ä¸€äº›è¡¥å……å‚æ•°ï¼Œä¸€èˆ¬æœ€å¤šä¸€ä¸ªï¼Œæœ‰æˆ–æ²¡æœ‰æ˜¯å’Œcmdçš„æ„ä¹‰ç›¸å…³çš„ã€‚<br>ioctlå‡½æ•°æ˜¯æ–‡ä»¶ç»“æ„ä¸­çš„ä¸€ä¸ªå±æ€§åˆ†é‡ï¼Œå°±æ˜¯è¯´å¦‚æœä½ çš„é©±åŠ¨ç¨‹åºæä¾›äº†å¯¹ioctlçš„æ”¯æŒï¼Œç”¨æˆ·å°±å¯ä»¥åœ¨ç”¨æˆ·ç¨‹åºä¸­ä½¿ç”¨ioctlå‡½æ•°æ§åˆ¶è®¾å¤‡çš„I&#x2F;Oé€šé“ã€‚ </p><p><strong>åº”ç”¨ç¨‹åºè°ƒç”¨ ioctlå‡½æ•°å‘é©±åŠ¨å‘é€æ§åˆ¶ä¿¡æ¯ï¼Œæ­¤å‡½æ•°å“åº”å¹¶æ‰§è¡Œã€‚</strong> </p><h4 id="å†…æ ¸å®šæ—¶å™¨ä¸€èˆ¬çš„ä½¿ç”¨æµç¨‹"><a href="#å†…æ ¸å®šæ—¶å™¨ä¸€èˆ¬çš„ä½¿ç”¨æµç¨‹" class="headerlink" title="å†…æ ¸å®šæ—¶å™¨ä¸€èˆ¬çš„ä½¿ç”¨æµç¨‹"></a>å†…æ ¸å®šæ—¶å™¨ä¸€èˆ¬çš„ä½¿ç”¨æµç¨‹</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">timer</span>;</span> <span class="comment">/* å®šä¹‰å®šæ—¶å™¨ */</span></span><br><span class="line"><span class="comment">/* å®šæ—¶å™¨å›è°ƒå‡½æ•° */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">function</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å®šæ—¶å™¨å¤„ç†ä»£ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* å¦‚æœéœ€è¦å®šæ—¶å™¨å‘¨æœŸæ€§è¿è¡Œçš„è¯å°±ä½¿ç”¨ mod_timer</span></span><br><span class="line"><span class="comment"> * å‡½æ•°é‡æ–°è®¾ç½®è¶…æ—¶å€¼å¹¶ä¸”å¯åŠ¨å®šæ—¶å™¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">mod_timer(&amp;dev-&gt;timertest, jiffies + msecs_to_jiffies(<span class="number">2000</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–å‡½æ•° */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">init_timer(&amp;timer); <span class="comment">/* åˆå§‹åŒ–å®šæ—¶å™¨ */</span></span><br><span class="line">timer.function = function; <span class="comment">/* è®¾ç½®å®šæ—¶å¤„ç†å‡½æ•° */</span></span><br><span class="line">timer.expires=jffies + msecs_to_jiffies(<span class="number">2000</span>);<span class="comment">/* è¶…æ—¶æ—¶é—´ 2 ç§’ */</span></span><br><span class="line">timer.data = (<span class="type">unsigned</span> <span class="type">long</span>)&amp;dev; <span class="comment">/* å°†è®¾å¤‡ç»“æ„ä½“ä½œä¸ºå‚æ•° */</span></span><br><span class="line">add_timer(&amp;timer); <span class="comment">/* å¯åŠ¨å®šæ—¶å™¨ */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* é€€å‡ºå‡½æ•° */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">del_timer(&amp;timer); <span class="comment">/* åˆ é™¤å®šæ—¶å™¨ */</span></span><br><span class="line"> <span class="comment">/* æˆ–è€…ä½¿ç”¨ */</span></span><br><span class="line">del_timer_sync(&amp;timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-26%20110943.png"></p><h4 id="Linux-å†…æ ¸çŸ­å»¶æ—¶å‡½æ•°"><a href="#Linux-å†…æ ¸çŸ­å»¶æ—¶å‡½æ•°" class="headerlink" title="Linux å†…æ ¸çŸ­å»¶æ—¶å‡½æ•°"></a>Linux å†…æ ¸çŸ­å»¶æ—¶å‡½æ•°</h4><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-25%20205843.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>globalmemè®¾å¤‡é©±åŠ¨</title>
      <link href="/2023/04/23/2023-4-25-globalmem%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/"/>
      <url>/2023/04/23/2023-4-25-globalmem%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="globalmemé©±åŠ¨"><a href="#globalmemé©±åŠ¨" class="headerlink" title="globalmemé©±åŠ¨"></a>globalmemé©±åŠ¨</h2><p>globalmemä¸ºâ€œå…¨å±€å†…å­˜â€çš„æ„æ€ï¼Œåœ¨globalmemå­—ç¬¦è®¾å¤‡ä¸­ä¼šåˆ†é…ä¸€ç‰‡å¤§å°ä¸ºGLOBALMEM_SIZEçš„å†…å­˜ç©ºé—´ï¼Œå¹¶åœ¨é©±åŠ¨ä¸­æä¾›å¯¹è¿™ç‰‡å†…å­˜çš„è¯»å†™ã€æ§åˆ¶å’Œå®šä½å‡½æ•°ï¼Œä¾›ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹èƒ½é€šè¿‡Linuxç³»ç»Ÿè°ƒç”¨è·å–å’Œè®¾ç½®è¿™ç‰‡å†…å­˜ã€‚</p><h4 id="å¤´æ–‡ä»¶ã€å®å®šä¹‰ä»¥åŠç»“æ„ä½“"><a href="#å¤´æ–‡ä»¶ã€å®å®šä¹‰ä»¥åŠç»“æ„ä½“" class="headerlink" title="å¤´æ–‡ä»¶ã€å®å®šä¹‰ä»¥åŠç»“æ„ä½“"></a>å¤´æ–‡ä»¶ã€å®å®šä¹‰ä»¥åŠç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBALMEM_SIZE  0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEM_CLEAR  0x1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBALMEM_MAJOR  230</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> globalmem_major = GLOBALMEM_MAJOR;</span><br><span class="line">module_param(globalmem_major, <span class="type">int</span>, S_IRUGO);<span class="comment">//æ¨¡å—ä¼ é€’å‚æ•°ï¼Œåœ¨åŠ è½½æ¨¡å—çš„æ—¶å€™å¯ä»¥è‡ªå·±ä¼ é€’</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globalmem_dev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> mem[GLOBALMEM_SIZE];<span class="comment">//ä½¿ç”¨å†…å­˜</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globalmem_dev</span> *<span class="title">globalmem_devp</span>;</span></span><br></pre></td></tr></table></figure><h4 id="å†…æ ¸æ¨¡å—ä¼ å…¥å‚æ•°"><a href="#å†…æ ¸æ¨¡å—ä¼ å…¥å‚æ•°" class="headerlink" title="å†…æ ¸æ¨¡å—ä¼ å…¥å‚æ•°"></a>å†…æ ¸æ¨¡å—ä¼ å…¥å‚æ•°</h4><p>å†…æ ¸æ¨¡å—ä¸­æ²¡æœ‰mainå‡½æ•°ï¼Œæ‰€ä»¥å‘æ¨¡å—å†…éƒ¨ä¼ å…¥å‚æ•°å¯ä»¥é€šè¿‡module_paramè¿™ä¸ªå®å®šä¹‰æ¥å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> S_IRWXU 00700    <span class="comment">// ç”¨æˆ·è¯»å†™å¯æ‰§è¡Œæƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IRUSR 00400    <span class="comment">// ç”¨æˆ·è¯»æƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IWUSR 00200    <span class="comment">// ç”¨æˆ·å†™æƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IXUSR 00100    <span class="comment">// ç”¨æˆ·å¯æ‰§è¡Œæƒé™</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IRWXG 00070    <span class="comment">// ç”¨æˆ·ç»„è¯»å†™å¯æ‰§è¡Œæƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IRGRP 00040    <span class="comment">// ç”¨æˆ·ç»„è¯»æƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IWGRP 00020    <span class="comment">// ç”¨æˆ·ç»„å†™æƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IXGRP 00010    <span class="comment">// ç”¨æˆ·ç»„å¯æ‰§è¡Œæƒé™</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IRWXO 00007    <span class="comment">// å…¶ä»–äººå¯è¯»å†™æ‰§è¡Œæƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IROTH 00004    <span class="comment">// å…¶ä»–äººå¯è¯»æƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IWOTH 00002    <span class="comment">// å…¶ä»–äººå¯å†™æƒé™</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IXOTH 00001    <span class="comment">// å…¶ä»–äººå¯æ‰§è¡Œæƒé™</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="kzallocå‡½æ•°ä¸kfreeå‡½æ•°"><a href="#kzallocå‡½æ•°ä¸kfreeå‡½æ•°" class="headerlink" title="kzallocå‡½æ•°ä¸kfreeå‡½æ•°"></a>kzallocå‡½æ•°ä¸kfreeå‡½æ•°</h4><p>ç”¨kzallocç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œ æ•ˆæœç­‰åŒäºå…ˆæ˜¯ç”¨ <em>kmalloc()</em> ç”³è¯·ç©ºé—´ <em>,</em> ç„¶åç”¨ <em>memset()</em> æ¥åˆå§‹åŒ– *,*æ‰€æœ‰ç”³è¯·çš„å…ƒç´ éƒ½è¢«åˆå§‹åŒ–ä¸º <em>0.</em></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">kmalloc</span><span class="params">(<span class="type">size_t</span> size, <span class="type">int</span> flags)</span></span><br></pre></td></tr></table></figure><p>ç»™ kmalloc çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦åˆ†é…çš„å—çš„å¤§å°. ç¬¬ 2 ä¸ªå‚æ•°, åˆ†é…æ ‡å¿—, éå¸¸æœ‰è¶£, å› ä¸ºå®ƒä»¥å‡ ä¸ªæ–¹å¼æ§åˆ¶ kmalloc çš„è¡Œä¸º.</p><p>æœ€ä¸€èˆ¬ä½¿ç”¨çš„æ ‡å¿—, GFP_KERNEL, ä»£è¡¨è¿è¡Œåœ¨å†…æ ¸ç©ºé—´çš„è¿›ç¨‹è€Œè¿›è¡Œçš„. è¿™æ„å‘³ç€è°ƒç”¨å‡½æ•°æ˜¯ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œä¸€ä¸ªç³»ç»Ÿè°ƒç”¨. ä½¿ç”¨ GFP_KENRL æ„å‘³ç€ kmalloc èƒ½å¤Ÿä½¿å½“å‰è¿›ç¨‹åœ¨å°‘å†…å­˜çš„æƒ…å†µä¸‹ç¡çœ æ¥ç­‰å¾…ä¸€é¡µ. ä¸€ä¸ªä½¿ç”¨ GFP_KERNEL æ¥åˆ†é…å†…å­˜çš„å‡½æ•°å¿…é¡», å› æ­¤, æ˜¯å¯é‡å…¥çš„å¹¶ä¸”ä¸èƒ½åœ¨åŸå­ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ. å½“å½“å‰è¿›ç¨‹ç¡çœ , å†…æ ¸é‡‡å–æ­£ç¡®çš„åŠ¨ä½œæ¥å®šä½ä¸€äº›ç©ºé—²å†…å­˜, æˆ–è€…é€šè¿‡åˆ·æ–°ç¼“å­˜åˆ°ç£ç›˜æˆ–è€…äº¤æ¢å‡ºå»ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹çš„å†…å­˜ã€‚</p><p>GFP_KERNEL ä¸ä¸€ç›´æ˜¯ä½¿ç”¨çš„æ­£ç¡®åˆ†é…æ ‡å¿—; æœ‰æ—¶ kmalloc ä»ä¸€ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡çš„å¤–éƒ¨è°ƒç”¨. ä¾‹å¦‚, è¿™ç±»çš„è°ƒç”¨å¯èƒ½å‘ç”Ÿåœ¨ä¸­æ–­å¤„ç†, tasklet, å’Œå†…æ ¸å®šæ—¶å™¨ä¸­. åœ¨è¿™ä¸ªæƒ…å†µä¸‹, å½“å‰è¿›ç¨‹ä¸åº”å½“è¢«ç½®ä¸ºç¡çœ , å¹¶ä¸”é©±åŠ¨åº”å½“ä½¿ç”¨ä¸€ä¸ªGFP_ATOMIC æ ‡å¿—æ¥ä»£æ›¿. å†…æ ¸æ­£å¸¸åœ°è¯•å›¾ä¿æŒä¸€äº›ç©ºé—²é¡µä»¥ä¾¿æ¥æ»¡è¶³åŸå­çš„åˆ†é…. å½“ä½¿ç”¨ GFP_ATOMIC æ—¶,kmalloc èƒ½å¤Ÿä½¿ç”¨ç”šè‡³æœ€åä¸€ä¸ªç©ºé—²é¡µ. å¦‚æœè¿™æœ€åä¸€ä¸ªç©ºé—²é¡µä¸å­˜åœ¨, ä½†æ˜¯, åˆ†é…å¤±è´¥ã€‚</p><p>å…¶ä»–ç”¨æ¥ä»£æ›¿æˆ–è€…å¢æ·» GFP_KERNEL å’Œ GFP_ATOMIC çš„æ ‡å¿—, å°½ç®¡å®ƒä»¬ 2 ä¸ªæ¶µç›–å¤§éƒ¨åˆ†è®¾å¤‡é©±åŠ¨çš„éœ€è¦. æ‰€æœ‰çš„æ ‡å¿—å®šä¹‰åœ¨ &lt;linux&#x2F;gfp.h&gt;, å¹¶ä¸”æ¯ä¸ªæ ‡å¿—ç”¨ä¸€ä¸ªåŒä¸‹åˆ’çº¿åšå‰ç¼€, ä¾‹å¦‚ __GFP_DMA. å¦å¤–, æœ‰ç¬¦å·ä»£è¡¨å¸¸å¸¸ä½¿ç”¨çš„æ ‡å¿—ç»„åˆ; è¿™äº›ç¼ºä¹å‰ç¼€å¹¶ä¸”æœ‰æ—¶è¢«ç§°ä¸ºåˆ†é…ä¼˜å…ˆçº§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">kfree</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *objp)</span></span><br><span class="line"><span class="comment">//objpï¼šå†…å­˜åœ°å€ï¼Œé€šå¸¸æ˜¯kmalloc( )å‡½æ•°çš„è¿”å›å€¼ï¼Œå³æ˜¯æŒ‡å‘åˆ†é…çš„å†…å­˜å—èµ·å§‹åœ°å€çš„åœ°å€æŒ‡é’ˆã€‚</span></span><br></pre></td></tr></table></figure><h4 id="seekå‡½æ•°"><a href="#seekå‡½æ•°" class="headerlink" title="seekå‡½æ•°"></a>seekå‡½æ•°</h4><p>æ–‡ä»¶é‡å®šä½å‡½æ•°ï¼Œæ”¹å˜æ–‡ä»¶çš„è¯»å†™åç§»é‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">loff_t</span> <span class="title function_">globalmem_llseek</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">loff_t</span> offset, <span class="type">int</span> orig)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">loff_t</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (orig) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"><span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">int</span>)offset &gt; GLOBALMEM_SIZE) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">filp-&gt;f_pos = (<span class="type">unsigned</span> <span class="type">int</span>)offset;</span><br><span class="line">ret = filp-&gt;f_pos;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">if</span> ((filp-&gt;f_pos + offset) &gt; GLOBALMEM_SIZE) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((filp-&gt;f_pos + offset) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">filp-&gt;f_pos += offset;</span><br><span class="line">ret = filp-&gt;f_pos;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶é‡å®šä½çš„èµ·å§‹åœ°å€æœ‰ä¸‰ç§æƒ…å†µ:åŒæ—¶è¯¥å‡½æ•°å…·æœ‰æ£€æµ‹å®šä½çš„åˆæ³•æ€§<br>        â‘ 0:ä»æ–‡ä»¶å¼€å¤´è¿›è¡Œå®šä½<br>        â‘¡1:ä»æ–‡ä»¶å½“å‰ä½ç½®è¿›è¡Œå®šä½<br>        â‘¢2:å®šä½åˆ°æ–‡ä»¶æœ«å°¾</p><h4 id="ioctlå‡½æ•°"><a href="#ioctlå‡½æ•°" class="headerlink" title="ioctlå‡½æ•°"></a>ioctlå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">globalmem_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globalmem_dev</span> *<span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> MEM_CLEAR:</span><br><span class="line"><span class="built_in">memset</span>(dev-&gt;mem, <span class="number">0</span>, GLOBALMEM_SIZE);</span><br><span class="line">printk(KERN_INFO <span class="string">&quot;globalmem is set to zero\n&quot;</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ioctl()å‡½æ•°å¯ä»¥æ¥æ”¶ç”¨æˆ·ç©ºé—´çš„MEM_CLEARå‘½ä»¤å®ç°å¯¹å†…å­˜çš„æ•°æ®æ¸…0. </p><p>é©±åŠ¨ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linxu/init.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBALMEM_SIZE0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEM_CLEAR 0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBALMEM_MAJOR230</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globalmemdev</span>&#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line">  <span class="type">int</span> major;</span><br><span class="line">  <span class="type">int</span> minor;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> mem[GLOBALMEM_SIZE];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globalmemdev</span> *<span class="title">globalmem_devp</span>;</span></span><br><span class="line">module_param(globalmem_devp-&gt;major, <span class="type">int</span> , S_IRUGO);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">globalmem_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">filp-&gt;private_data = globalmem_devp;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">globalmem_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">globalmem_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globalmemdev</span> *<span class="title">dev</span> =</span> filp -&gt; private_data;</span><br><span class="line">  <span class="keyword">switch</span>(cmd)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> MEM_CLEAR:</span><br><span class="line">      <span class="built_in">memset</span>(dev-&gt;mem, <span class="number">0</span>, GLOBALMEM_SIZE);</span><br><span class="line">      printk(KERN_INFO <span class="string">&quot;globalmem is set to zero \n&quot;</span>);<span class="comment">//KERN_INFOæç¤ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">default</span> :</span><br><span class="line">      <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">globalmem_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> p = *offt;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> count = cnt;</span><br><span class="line">  <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">globalmemdev</span> *<span class="title">dev</span> =</span> filp -&gt; private_data;</span><br><span class="line">  <span class="keyword">if</span>(p &gt;= GLOBALMEM_SIZE)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(count &gt; GLOBALMEM_SIZE - p)</span><br><span class="line">    count = GLOBALMEM_SIZE-p;</span><br><span class="line">  <span class="keyword">if</span>(copy_to_user(buf, dev-&gt;mem + p, count))</span><br><span class="line">    ret = -EFAULTï¼›</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">  *ppos += count;</span><br><span class="line">    ret = count;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;read %u bytes(s) from %lu\n&quot;</span>, count , p);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">globalmem_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> p = *offt;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> count  = cnt ;</span><br><span class="line"><span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">globalmemdev</span> *<span class="title">dev</span> =</span> filp -&gt; private_data;</span><br><span class="line">  <span class="keyword">if</span>(p &gt;= GLOBALMEM_SIZE)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>(count &gt; GLOBALMEM_SIZE - p)</span><br><span class="line">    count = GLOBALMEM_SIZE - p;</span><br><span class="line">  <span class="keyword">if</span>(copy_from_user(dev-&gt;mem + p, buf, count))</span><br><span class="line">    ret = -EFAULT;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">  *offt += count;</span><br><span class="line">    ret = count;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;written %u bytes(s) from %lu\n&quot;</span>, count, p);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">loff_t</span> <span class="title function_">globalmem_llseek</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">loff_t</span> offset, <span class="type">int</span> orig)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">loff_t</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (orig) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"><span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">int</span>)offset &gt; GLOBALMEM_SIZE) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">filp-&gt;f_pos = (<span class="type">unsigned</span> <span class="type">int</span>)offset;</span><br><span class="line">ret = filp-&gt;f_pos;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">if</span> ((filp-&gt;f_pos + offset) &gt; GLOBALMEM_SIZE) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((filp-&gt;f_pos + offset) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">filp-&gt;f_pos += offset;</span><br><span class="line">ret = filp-&gt;f_pos;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">globalmem_ops</span> =</span> &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">  .llseek = globalmem_llseek,</span><br><span class="line">  .read = globalmem_read,</span><br><span class="line">  .write = globalmem_write,</span><br><span class="line">  .unlocked_ioctl = globalmem_ioctl,</span><br><span class="line">  .open = globalmem_open,</span><br><span class="line">  .release = globalmem_release,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">globalmem_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(globalmem_devp.major)</span><br><span class="line">  &#123;</span><br><span class="line">  globalmem_devp.devid = MKDEV(globalmem_devp.major, <span class="number">0</span>);</span><br><span class="line">    register_chrdev_region(globalmem_devp.devid, <span class="number">1</span>, <span class="string">&quot;globalmem&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  alloc_chrdev_region(&amp;globalmem_devp.devid, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;globalmem&quot;</span>);</span><br><span class="line">    globalmem_devp.major = MAJOR(globalmem_devp.devid);</span><br><span class="line">    globalmem_devp.minor = MINOR(globalmem_devp.devid);</span><br><span class="line">  &#125;</span><br><span class="line">  cdev_init(&amp;globalmem_devp.cdev, &amp;globalmem_ops);</span><br><span class="line">  dev-&gt;cdev.owner = THIS_MODULE;</span><br><span class="line">  cdev_add(&amp;globalmem_dep.cdev, globalmem_devp.devid, <span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">  globalmem_devp = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> globalmem_dev), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!globalmem_devp) &#123;</span><br><span class="line">ret = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> fail_malloc;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> fail_malloc:</span><br><span class="line">unregister_chrdev_region(devno, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">globalmem_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">cdev_del(&amp;globalmem_devp-&gt;cdev);</span><br><span class="line">  kfree(globalmem_devp)</span><br><span class="line">  unregister_chrdev_region(globalmem_devp.devid, <span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">module_init(globalmem_init);</span><br><span class="line">module_exit(globalmem_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxå¹¶å‘ä¸ç«äº‰</title>
      <link href="/2023/04/20/2023-4-21-linux%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89/"/>
      <url>/2023/04/20/2023-4-21-linux%E5%B9%B6%E5%8F%91%E4%B8%8E%E7%AB%9E%E4%BA%89/</url>
      
        <content type="html"><![CDATA[<h2 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h2><p>è‹¥æˆ‘ä»¬è°ˆåŠè®¡ç®—æœºç³»ç»Ÿä¸­çš„å¹¶å‘ï¼Œåˆ™æ˜¯æŒ‡åŒä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œå¤šä¸ªç‹¬ç«‹æ´»åŠ¨åŒæ—¶è¿›è¡Œï¼Œè€Œéä¾æ¬¡è¿›è¡Œã€‚èµ·åˆçš„è®¡ç®—æœºå¹¶å‘åªæ˜¯ä¸€ç§åˆ¶é€ å¹¶å‘çš„å‡è±¡ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå¤„ç†å™¨ï¼Œåœ¨åŒä¸€æ—¶åˆ»å®è´¨åªèƒ½å¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼Œä¸è¿‡æ˜¯ä¸€ç§’é’Ÿå†…è¿›è¡Œå¤šä¸ªä»»åŠ¡çš„åˆ‡æ¢ã€‚çœ‹èµ·æ¥æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œå› æ­¤å«åšä»»åŠ¡äº¤æ¢ã€‚</p><p>å¤šå¹´æ¥ï¼Œé…å¤‡äº†å¤šå¤„ç†å™¨çš„è®¡ç®—æœºä¸€ç›´è¢«ç”¨ä½œæœåŠ¡å™¨ï¼Œå®ƒè¦æ‰¿æ‹…é«˜æ€§èƒ½çš„è®¡ç®—ä»»åŠ¡ï¼›ç°ä»Šï¼ŒåŸºäºä¸€èŠ¯å¤šæ ¸å¤„ç†å™¨ï¼ˆç®€ç§°å¤šæ ¸å¤„ç†å™¨ï¼‰çš„è®¡ç®—æœºæ—¥æ¸æ™®åŠï¼Œå¤šæ ¸å¤„ç†å™¨ä¹Ÿç”¨åœ¨å°å¼è®¡ç®—æœºä¸Šã€‚</p><p>æ— è®ºæ˜¯è£…é…å¤šä¸ªå¤„ç†å™¨ï¼Œè¿˜æ˜¯å•ä¸ªå¤šæ ¸å¤„ç†å™¨ï¼Œæˆ–æ˜¯å¤šä¸ªå¤šæ ¸å¤„ç†å™¨ï¼Œè¿™äº›è®¡ç®—æœºéƒ½èƒ½çœŸæ­£å¹¶è¡Œè¿ä½œå¤šä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç¡¬ä»¶å¹¶å‘ï¼ˆhardware concurrencyï¼‰ã€‚</p><h3 id="å¹¶å‘æ–¹å¼"><a href="#å¹¶å‘æ–¹å¼" class="headerlink" title="å¹¶å‘æ–¹å¼"></a>å¹¶å‘æ–¹å¼</h3><h4 id="å¤šè¿›ç¨‹å¹¶å‘"><a href="#å¤šè¿›ç¨‹å¹¶å‘" class="headerlink" title="å¤šè¿›ç¨‹å¹¶å‘"></a>å¤šè¿›ç¨‹å¹¶å‘</h4><p>åœ¨åº”ç”¨è½¯ä»¶å†…éƒ¨ï¼Œä¸€ç§å¹¶å‘æ–¹å¼æ˜¯ï¼Œå°†ä¸€ä¸ªåº”ç”¨è½¯ä»¶æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹è¿›ç¨‹åŒæ—¶è¿è¡Œï¼Œå®ƒä»¬éƒ½åªå«å•ä¸€çº¿ç¨‹ï¼Œéå¸¸ç±»ä¼¼äºåŒæ—¶è¿è¡Œæµè§ˆå™¨å’Œæ–‡å­—å¤„ç†è½¯ä»¶ã€‚è¿™äº›ç‹¬ç«‹è¿›ç¨‹å¯ä»¥é€šè¿‡æ‰€æœ‰å¸¸è§„çš„è¿›ç¨‹é—´é€šä¿¡é€”å¾„ç›¸äº’ä¼ é€’ä¿¡æ¯ï¼ˆä¿¡å·ã€å¥—æ¥å­—ã€æ–‡ä»¶ã€ç®¡é“ç­‰ï¼‰ã€‚</p><h4 id="å¤šçº¿ç¨‹å¹¶å‘"><a href="#å¤šçº¿ç¨‹å¹¶å‘" class="headerlink" title="å¤šçº¿ç¨‹å¹¶å‘"></a>å¤šçº¿ç¨‹å¹¶å‘</h4><p>å¦ä¸€ç§å¹¶å‘æ–¹å¼æ˜¯åœ¨å•ä¸€è¿›ç¨‹å†…è¿è¡Œå¤šçº¿ç¨‹ã€‚çº¿ç¨‹éå¸¸åƒè½»é‡çº§è¿›ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ç‹¬ç«‹è¿è¡Œï¼Œå¹¶èƒ½å„è‡ªæ‰§è¡Œä¸åŒçš„æŒ‡ä»¤åºåˆ—ã€‚</p><p>ä¸è¿‡ï¼ŒåŒä¸€è¿›ç¨‹å†…çš„æ‰€æœ‰çº¿ç¨‹éƒ½å…±ç”¨ç›¸åŒçš„åœ°å€ç©ºé—´ï¼Œä¸”æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½ç›´æ¥è®¿é—®å¤§éƒ¨åˆ†æ•°æ®ã€‚å…¨å±€å˜é‡ä¾ç„¶å…¨å±€å¯è§ï¼ŒæŒ‡å‘å¯¹è±¡æˆ–æ•°æ®çš„æŒ‡é’ˆå’Œå¼•ç”¨èƒ½åœ¨çº¿ç¨‹é—´ä¼ é€’ã€‚</p><p>å°½ç®¡è¿›ç¨‹é—´å…±äº«å†…å­˜é€šå¸¸å¯è¡Œï¼Œä½†è¿™ç§åšæ³•è®¾ç½®å¤æ‚ï¼Œå¾€å¾€éš¾ä»¥é©¾é©­ï¼ŒåŸå› æ˜¯åŒä¸€æ•°æ®çš„åœ°å€åœ¨ä¸åŒè¿›ç¨‹ä¸­ä¸ä¸€å®šç›¸åŒã€‚</p><h3 id="å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«"><a href="#å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«" class="headerlink" title="å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«"></a>å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«</h3><ul><li>å¹¶å‘ï¼ˆconcurrencyï¼‰ï¼šæŠŠä»»åŠ¡åœ¨ä¸åŒçš„æ—¶é—´ç‚¹äº¤ç»™å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚åœ¨åŒä¸€æ—¶é—´ç‚¹ï¼Œä»»åŠ¡å¹¶ä¸ä¼šåŒæ—¶è¿è¡Œã€‚</li><li>å¹¶è¡Œï¼ˆparallelismï¼‰ï¼šæŠŠæ¯ä¸€ä¸ªä»»åŠ¡åˆ†é…ç»™æ¯ä¸€ä¸ªå¤„ç†å™¨ç‹¬ç«‹å®Œæˆã€‚åœ¨åŒä¸€æ—¶é—´ç‚¹ï¼Œä»»åŠ¡ä¸€å®šæ˜¯åŒæ—¶è¿è¡Œã€‚</li></ul><h3 id="å¹¶å‘äº§ç”Ÿçš„åŸå› "><a href="#å¹¶å‘äº§ç”Ÿçš„åŸå› " class="headerlink" title="å¹¶å‘äº§ç”Ÿçš„åŸå› "></a>å¹¶å‘äº§ç”Ÿçš„åŸå› </h3><p>ç°åœ¨çš„ Linux ç³»ç»Ÿå¹¶å‘äº§ç”Ÿçš„åŸå› å¾ˆå¤æ‚ï¼Œæ€»ç»“ä¸€ä¸‹æœ‰ä¸‹é¢å‡ ä¸ªä¸»è¦åŸ<br>å› ï¼š<br>â‘ ã€å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œ Linux æ˜¯å¤šä»»åŠ¡(çº¿ç¨‹)çš„ç³»ç»Ÿï¼Œæ‰€ä»¥å¤šçº¿ç¨‹è®¿é—®æ˜¯æœ€åŸºæœ¬çš„åŸå› ã€‚<br>â‘¡ã€æŠ¢å å¼å¹¶å‘è®¿é—®ï¼Œä» 2.6 ç‰ˆæœ¬å†…æ ¸å¼€å§‹ï¼Œ Linux å†…æ ¸æ”¯æŒæŠ¢å ï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒåº¦ç¨‹åºå¯ä»¥åœ¨ä»»æ„æ—¶åˆ»æŠ¢å æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œä»è€Œè¿è¡Œå…¶ä»–çš„çº¿ç¨‹ã€‚<br>â‘¢ã€ä¸­æ–­ç¨‹åºå¹¶å‘è®¿é—®ã€‚<br>â‘£ã€ SMP(å¤šæ ¸)æ ¸é—´å¹¶å‘è®¿é—®ï¼Œç°åœ¨ ARM æ¶æ„çš„å¤šæ ¸ SOC å¾ˆå¸¸è§ï¼Œå¤šæ ¸ CPU å­˜åœ¨æ ¸é—´å¹¶å‘è®¿é—® </p><p>å¹¶å‘è®¿é—®å¸¦æ¥çš„é—®é¢˜å°±æ˜¯ç«äº‰ï¼Œå¯¹äºä¸´ç•ŒåŒºå¿…é¡»ä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œä¹Ÿå°±æ˜¯è¦ä¿è¯ä¸´ç•ŒåŒºæ˜¯åŸå­è®¿é—®çš„ï¼ŒåŸå­è®¿é—®å°±è¡¨ç¤ºè¿™ä¸€ä¸ªè®¿é—®æ˜¯ä¸€ä¸ªæ­¥éª¤ï¼Œä¸èƒ½å†è¿›è¡Œæ‹†åˆ†ã€‚ </p><h4 id="ä¸´ç•Œèµ„æºå’Œä¸´ç•ŒåŒº"><a href="#ä¸´ç•Œèµ„æºå’Œä¸´ç•ŒåŒº" class="headerlink" title="ä¸´ç•Œèµ„æºå’Œä¸´ç•ŒåŒº"></a>ä¸´ç•Œèµ„æºå’Œä¸´ç•ŒåŒº</h4><p>1.ä¸´ç•Œèµ„æº<br>  ä¸´ç•Œèµ„æºæ˜¯ä¸€æ¬¡ä»…å…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„å…±äº«èµ„æºã€‚å„è¿›ç¨‹é‡‡å–äº’æ–¥çš„æ–¹å¼ï¼Œå®ç°å…±äº«çš„èµ„æºç§°ä½œä¸´ç•Œèµ„æºã€‚å±äºä¸´ç•Œèµ„æºçš„ç¡¬ä»¶æœ‰ï¼Œæ‰“å°æœºï¼Œç£å¸¦æœºç­‰ï¼›è½¯ä»¶æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå˜é‡ï¼Œæ•°ç»„ï¼Œç¼“å†²åŒºç­‰ã€‚è¯¸è¿›ç¨‹é—´é‡‡å–äº’æ–¥æ–¹å¼ï¼Œå®ç°å¯¹è¿™ç§èµ„æºçš„å…±äº«ã€‚</p><p>2.ä¸´ç•ŒåŒºï¼š<br>  æ¯ä¸ªè¿›ç¨‹ä¸­è®¿é—®ä¸´ç•Œèµ„æºçš„é‚£æ®µä»£ç ç§°ä¸ºä¸´ç•ŒåŒºï¼ˆcriticalsectionï¼‰ï¼Œæ¯æ¬¡åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œè¿›å…¥åï¼Œä¸å…è®¸å…¶ä»–è¿›ç¨‹è¿›å…¥ã€‚ä¸è®ºæ˜¯ç¡¬ä»¶ä¸´ç•Œèµ„æºè¿˜æ˜¯è½¯ä»¶ä¸´ç•Œèµ„æºï¼Œå¤šä¸ªè¿›ç¨‹å¿…é¡»äº’æ–¥çš„å¯¹å®ƒè¿›è¡Œè®¿é—®ã€‚å¤šä¸ªè¿›ç¨‹æ¶‰åŠåˆ°åŒä¸€ä¸ªä¸´ç•Œèµ„æºçš„çš„ä¸´ç•ŒåŒºç§°ä¸ºç›¸å…³ä¸´ç•ŒåŒºã€‚ä½¿ç”¨ä¸´ç•ŒåŒºæ—¶ï¼Œä¸€èˆ¬ä¸å…è®¸å…¶è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œåªè¦è¿è¡Œåœ¨ä¸´ç•ŒåŒºçš„çº¿ç¨‹è¿˜æ²¡æœ‰ç¦»å¼€ï¼Œå…¶ä»–æ‰€æœ‰è¿›å…¥æ­¤ä¸´ç•ŒåŒºçš„çº¿ç¨‹éƒ½ä¼šè¢«æŒ‚èµ·è€Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå¹¶åœ¨ä¸€å®šç¨‹åº¦ä¸Šå½±å“ç¨‹åºçš„è¿è¡Œæ€§èƒ½ã€‚</p><h3 id="åŸå­æ“ä½œ"><a href="#åŸå­æ“ä½œ" class="headerlink" title="åŸå­æ“ä½œ"></a>åŸå­æ“ä½œ</h3><h4 id="åŸå­æ•´å½¢æ“ä½œAPIå‡½æ•°"><a href="#åŸå­æ•´å½¢æ“ä½œAPIå‡½æ•°" class="headerlink" title="åŸå­æ•´å½¢æ“ä½œAPIå‡½æ•°"></a>åŸå­æ•´å½¢æ“ä½œAPIå‡½æ•°</h4><p>Linux å†…æ ¸å®šä¹‰äº†å«åš atomic_t çš„ç»“æ„ä½“æ¥å®Œæˆæ•´å½¢æ•°æ®çš„åŸå­æ“ä½œï¼Œåœ¨ä½¿ç”¨ä¸­ç”¨åŸå­å˜é‡æ¥ä»£æ›¿æ•´å½¢å˜é‡ï¼Œæ­¤ç»“æ„ä½“å®šä¹‰åœ¨ include&#x2F;linux&#x2F;types.h æ–‡ä»¶ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">175</span> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="number">176</span> <span class="type">int</span> counter;</span><br><span class="line"><span class="number">177</span> &#125; <span class="type">atomic_t</span>;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦ä½¿ç”¨åŸå­æ“ä½œ API å‡½æ•°ï¼Œé¦–å…ˆè¦å…ˆå®šä¹‰ä¸€ä¸ª atomic_t çš„å˜é‡ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">atomic_t</span> a;<span class="comment">//å®šä¹‰a</span></span><br><span class="line"><span class="type">atomic_t</span> b = ATOMIC_INIT(<span class="number">0</span>);<span class="comment">//å®šä¹‰åŸå­å˜é‡bå¹¶èµ‹å€¼0ï¼›ä½¿ç”¨çš„æ˜¯ATOMIC_INITå®</span></span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-19%20153803.png"></p><p>å¦‚æœä½¿ç”¨ 64 ä½çš„ SOC çš„è¯ï¼Œå°±è¦ç”¨åˆ° 64 ä½çš„åŸå­å˜é‡ï¼Œ Linux å†…æ ¸ä¹Ÿå®šä¹‰äº† 64 ä½åŸå­ç»“æ„ä½“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> counter;</span><br><span class="line">&#125; <span class="type">atomic64_t</span>;</span><br></pre></td></tr></table></figure><p>ç›¸åº”çš„ä¹Ÿæä¾›äº† 64 ä½åŸå­å˜é‡çš„æ“ä½œ API å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸è¯¦ç»†è®²è§£äº†ï¼Œå’Œè¡¨ 47.2.1.1ä¸­çš„ API å‡½æ•°æœ‰ç”¨æ³•ä¸€æ ·ï¼Œåªæ˜¯å°†â€œatomic_â€å‰ç¼€æ¢ä¸ºâ€œatomic64_â€ï¼Œå°† int æ¢ä¸º long longã€‚å¦‚æœä½¿ç”¨çš„æ˜¯ 64 ä½çš„ SOCï¼Œé‚£ä¹ˆå°±è¦ä½¿ç”¨ 64 ä½çš„åŸå­æ“ä½œå‡½æ•°ã€‚ </p><h4 id="åŸå­ä½æ“ä½œ-API-å‡½æ•°"><a href="#åŸå­ä½æ“ä½œ-API-å‡½æ•°" class="headerlink" title="åŸå­ä½æ“ä½œ API å‡½æ•°"></a>åŸå­ä½æ“ä½œ API å‡½æ•°</h4><p>Linux å†…æ ¸ä¹Ÿæä¾›äº†ä¸€ç³»åˆ—çš„åŸå­ä½æ“ä½œ API å‡½æ•°ï¼Œåªä¸è¿‡åŸå­ä½æ“ä½œä¸åƒåŸå­æ•´å½¢å˜é‡é‚£æ ·æœ‰ä¸ª atomic_t çš„æ•°æ®ç»“æ„ï¼ŒåŸå­ä½æ“ä½œæ˜¯ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œ .</p><table><thead><tr><th align="center">å‡½æ•°</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">void set_bit(int nr, void *p)</td><td align="center">å°† p åœ°å€çš„ç¬¬ nr ä½ç½® 1</td></tr><tr><td align="center">void clear_bit(int nr, void *p)</td><td align="center">å°† p åœ°å€çš„ç¬¬ nr ä½æ¸…é›¶ã€‚</td></tr><tr><td align="center">void change_bit(int nr, void *p)</td><td align="center">å°† p åœ°å€çš„ç¬¬ nr ä½è¿›è¡Œç¿»è½¬</td></tr><tr><td align="center">int test_bit(int nr, void *p)</td><td align="center">è·å– p åœ°å€çš„ç¬¬ nr ä½çš„å€¼ã€‚</td></tr><tr><td align="center">int test_and_set_bit(int nr, void *p)</td><td align="center">å°† p åœ°å€çš„ç¬¬ nr ä½ç½® 1ï¼Œå¹¶ä¸”è¿”å› nr ä½åŸæ¥çš„å€¼</td></tr><tr><td align="center">int test_and_clear_bit(int nr, void *p)</td><td align="center">å°† p åœ°å€çš„ç¬¬ nr ä½æ¸…é›¶ï¼Œå¹¶ä¸”è¿”å› nr ä½åŸæ¥çš„å€¼</td></tr><tr><td align="center">int test_and_change_bit(int nr, void *p)</td><td align="center">å°† p åœ°å€çš„ç¬¬ nr ä½ç¿»è½¬ï¼Œå¹¶ä¸”è¿”å› nr ä½åŸæ¥çš„å€¼</td></tr></tbody></table><h4 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h4><p>å½“ä¸€ä¸ªçº¿ç¨‹è¦è®¿é—®æŸä¸ªå…±äº«èµ„æºçš„æ—¶å€™é¦–å…ˆè¦å…ˆè·å–ç›¸åº”çš„é”ï¼Œ é”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåªè¦æ­¤çº¿ç¨‹ä¸é‡Šæ”¾æŒæœ‰çš„é”ï¼Œé‚£ä¹ˆå…¶ä»–çš„çº¿ç¨‹å°±ä¸èƒ½è·å–æ­¤é”ã€‚å¯¹äºè‡ªæ—‹é”è€Œè¨€ï¼Œå¦‚æœè‡ªæ—‹é”æ­£åœ¨è¢«çº¿ç¨‹ A æŒæœ‰ï¼Œçº¿ç¨‹ B æƒ³è¦è·å–è‡ªæ—‹é”ï¼Œé‚£ä¹ˆçº¿ç¨‹ B å°±ä¼šå¤„äºå¿™å¾ªç¯-æ—‹è½¬-ç­‰å¾…çŠ¶æ€ï¼Œçº¿ç¨‹ B ä¸ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€æˆ–è€…è¯´å»åšå…¶ä»–çš„å¤„ç†ï¼Œè€Œæ˜¯ä¼šä¸€ç›´å‚»å‚»çš„åœ¨é‚£é‡Œâ€œè½¬åœˆåœˆâ€çš„ç­‰å¾…é”å¯ç”¨ã€‚ </p><p>è‡ªæ—‹é”çš„ä¸€ä¸ªç¼ºç‚¹ï¼šé‚£å°±ç­‰å¾…è‡ªæ—‹é”çš„çº¿ç¨‹ä¼šä¸€ç›´å¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œè¿™æ ·ä¼šæµªè´¹å¤„ç†å™¨æ—¶é—´ï¼Œé™ä½ç³»ç»Ÿæ€§èƒ½ï¼Œæ‰€ä»¥è‡ªæ—‹é”çš„æŒæœ‰æ—¶é—´ä¸èƒ½å¤ªé•¿ã€‚æ‰€ä»¥è‡ªæ—‹é”é€‚ç”¨äºçŸ­æ—¶æœŸçš„è½»é‡çº§åŠ é”ï¼Œå¦‚æœé‡åˆ°éœ€è¦é•¿æ—¶é—´æŒæœ‰é”çš„åœºæ™¯é‚£å°±éœ€è¦æ¢å…¶ä»–çš„æ–¹æ³•äº†ï¼Œ </p><p>Linux å†…æ ¸ä½¿ç”¨ç»“æ„ä½“ spinlock_t è¡¨ç¤ºè‡ªæ—‹é” </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">64</span> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> &#123;</span></span><br><span class="line"><span class="number">65</span> <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="number">66</span> <span class="class"><span class="keyword">struct</span> <span class="title">raw_spinlock</span> <span class="title">rlock</span>;</span></span><br><span class="line"><span class="number">67</span></span><br><span class="line"><span class="number">68</span> <span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="number">69</span> <span class="meta"># <span class="keyword">define</span> LOCK_PADSIZE (offsetof(struct raw_spinlock, dep_map))</span></span><br><span class="line"><span class="number">70</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="number">71</span> u8 __padding[LOCK_PADSIZE];</span><br><span class="line"><span class="number">72</span> <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">dep_map</span>;</span></span><br><span class="line"><span class="number">73</span> &#125;;</span><br><span class="line"><span class="number">74</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">75</span> &#125;;</span><br><span class="line"><span class="number">76</span> &#125; <span class="type">spinlock_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">spinlock_t</span> lock;<span class="comment">//å®šä¹‰è‡ªæ—‹é”</span></span><br></pre></td></tr></table></figure><h3 id="è‡ªæ—‹é”APIå‡½æ•°"><a href="#è‡ªæ—‹é”APIå‡½æ•°" class="headerlink" title="è‡ªæ—‹é”APIå‡½æ•°"></a>è‡ªæ—‹é”APIå‡½æ•°</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-19%20162257.png"></p><p>è¡¨ä¸­çš„è‡ªæ—‹é”API å‡½æ•°é€‚ç”¨äºSMPæˆ–æ”¯æŒæŠ¢å çš„å•CPUä¸‹çº¿ç¨‹ä¹‹é—´çš„å¹¶å‘è®¿é—®ï¼Œä¹Ÿå°±æ˜¯ç”¨äºçº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´ï¼Œè¢«è‡ªæ—‹é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºä¸€å®šä¸èƒ½è°ƒç”¨ä»»ä½•èƒ½å¤Ÿå¼•èµ·ç¡çœ å’Œé˜»å¡çš„API å‡½æ•°ï¼Œå¦åˆ™çš„è¯ä¼šå¯èƒ½ä¼šå¯¼è‡´æ­»é”ç°è±¡çš„å‘ç”Ÿã€‚è‡ªæ—‹é”ä¼šè‡ªåŠ¨ç¦æ­¢æŠ¢å ï¼Œä¹Ÿå°±è¯´å½“çº¿ç¨‹ Aå¾—åˆ°é”ä»¥åä¼šæš‚æ—¶ç¦æ­¢å†…æ ¸æŠ¢å ã€‚å¦‚æœçº¿ç¨‹ A åœ¨æŒæœ‰é”æœŸé—´è¿›å…¥äº†ä¼‘çœ çŠ¶æ€ï¼Œé‚£ä¹ˆçº¿ç¨‹ A ä¼šè‡ªåŠ¨æ”¾å¼ƒ CPU ä½¿ç”¨æƒã€‚çº¿ç¨‹ B å¼€å§‹è¿è¡Œï¼Œçº¿ç¨‹ B ä¹Ÿæƒ³è¦è·å–é”ï¼Œä½†æ˜¯æ­¤æ—¶é”è¢« A çº¿ç¨‹æŒæœ‰ï¼Œè€Œ<br>ä¸”å†…æ ¸æŠ¢å è¿˜è¢«ç¦æ­¢äº†ï¼çº¿ç¨‹ B æ— æ³•è¢«è°ƒåº¦å‡ºå»ï¼Œé‚£ä¹ˆçº¿ç¨‹ A å°±æ— æ³•è¿è¡Œï¼Œé”ä¹Ÿå°±æ— æ³•é‡Šæ”¾ï¼Œå¥½äº†ï¼Œæ­»é”å‘ç”Ÿäº†ï¼ </p><p>è¡¨ ä¸­çš„ API å‡½æ•°ç”¨äºçº¿ç¨‹ä¹‹é—´çš„å¹¶å‘è®¿é—®ï¼Œå¦‚æœæ­¤æ—¶ä¸­æ–­ä¹Ÿè¦æ’ä¸€è„šï¼Œä¸­æ–­ä¹Ÿæƒ³è®¿é—®å…±äº«èµ„æºï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿé¦–å…ˆå¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œä¸­æ–­é‡Œé¢å¯ä»¥ä½¿ç”¨è‡ªæ—‹é”ï¼Œä½†æ˜¯åœ¨ä¸­æ–­é‡Œé¢ä½¿ç”¨è‡ªæ—‹é”çš„æ—¶å€™ï¼Œåœ¨è·å–é”ä¹‹å‰ä¸€å®šè¦å…ˆç¦æ­¢æœ¬åœ°ä¸­æ–­(ä¹Ÿå°±æ˜¯æœ¬ CPU ä¸­æ–­ï¼Œå¯¹äºå¤šæ ¸ SOCæ¥è¯´ä¼šæœ‰å¤šä¸ª CPU æ ¸)ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´é”æ­»ç°è±¡çš„å‘ç”Ÿã€‚</p><p>çº¿ç¨‹ A å…ˆè¿è¡Œï¼Œå¹¶ä¸”è·å–åˆ°äº† lock è¿™ä¸ªé”ï¼Œå½“çº¿ç¨‹ A è¿è¡Œ functionA å‡½æ•°çš„æ—¶å€™ä¸­æ–­å‘ç”Ÿäº†ï¼Œä¸­æ–­æŠ¢èµ°äº† CPU ä½¿ç”¨æƒã€‚å³è¾¹çš„ä¸­æ–­æœåŠ¡å‡½æ•°ä¹Ÿè¦è·å– lock è¿™ä¸ªé”ï¼Œä½†æ˜¯è¿™ä¸ªé”è¢«çº¿ç¨‹ A å æœ‰ç€ï¼Œä¸­æ–­å°±ä¼šä¸€ç›´è‡ªæ—‹ï¼Œç­‰å¾…é”æœ‰æ•ˆã€‚ä½†æ˜¯åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°æ‰§è¡Œå®Œä¹‹å‰ï¼Œçº¿ç¨‹ A æ˜¯ä¸å¯èƒ½æ‰§è¡Œçš„ï¼Œçº¿ç¨‹ A è¯´â€œä½ å…ˆæ”¾æ‰‹â€ï¼Œä¸­æ–­è¯´â€œä½ å…ˆæ”¾æ‰‹â€ï¼Œåœºé¢å°±è¿™ä¹ˆåƒµæŒç€ï¼Œæ­»é”å‘ç”Ÿï¼</p><p>æœ€å¥½çš„è§£å†³æ–¹æ³•å°±æ˜¯è·å–é”ä¹‹å‰å…³é—­æœ¬åœ°ä¸­æ–­ï¼Œ Linux å†…æ ¸æä¾›äº†ç›¸åº”çš„ API å‡½æ•° </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-20%20162230.png"></p><p>å»ºè®®ä½¿ç”¨ spin_lock_irqsave&#x2F; spin_unlock_irqrestoreï¼Œå› ä¸ºè¿™ä¸€ç»„å‡½<br>æ•°ä¼šä¿å­˜ä¸­æ–­çŠ¶æ€ï¼Œåœ¨é‡Šæ”¾é”çš„æ—¶å€™ä¼šæ¢å¤ä¸­æ–­çŠ¶æ€ã€‚ä¸€èˆ¬åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨ spin_lock_irqsave&#x2F;spin_unlock_irqrestoreï¼Œåœ¨ä¸­æ–­ä¸­ä½¿ç”¨spin_lock&#x2F;spin_unlockï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> DEFINE_SPINLOCK(lock) <span class="comment">/* å®šä¹‰å¹¶åˆå§‹åŒ–ä¸€ä¸ªé” */</span></span><br><span class="line"><span class="number">2</span> </span><br><span class="line"><span class="number">3</span><span class="comment">/* çº¿ç¨‹ A */</span></span><br><span class="line"><span class="number">4</span> <span class="type">void</span> <span class="title function_">functionA</span> <span class="params">()</span>&#123;</span><br><span class="line"><span class="number">5</span> <span class="type">unsigned</span> <span class="type">long</span> flags; <span class="comment">/* ä¸­æ–­çŠ¶æ€ */</span></span><br><span class="line"><span class="number">6</span> spin_lock_irqsave(&amp;lock, flags) <span class="comment">/* è·å–é” */</span></span><br><span class="line"><span class="number">7</span> <span class="comment">/* ä¸´ç•ŒåŒº */</span></span><br><span class="line"><span class="number">8</span> spin_unlock_irqrestore(&amp;lock, flags) <span class="comment">/* é‡Šæ”¾é” */</span></span><br><span class="line"><span class="number">9</span> &#125;</span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span> <span class="comment">/* ä¸­æ–­æœåŠ¡å‡½æ•° */</span></span><br><span class="line"><span class="number">12</span> <span class="type">void</span> <span class="title function_">irq</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="number">13</span> spin_lock(&amp;lock) <span class="comment">/* è·å–é” */</span></span><br><span class="line"><span class="number">14</span> <span class="comment">/* ä¸´ç•ŒåŒº */</span></span><br><span class="line"><span class="number">15</span> spin_unlock(&amp;lock) <span class="comment">/* é‡Šæ”¾é” */</span></span><br><span class="line"><span class="number">16</span> &#125;</span><br></pre></td></tr></table></figure><h4 id="è‡ªæ—‹é”ä½¿ç”¨æ³¨æ„äº‹é¡¹"><a href="#è‡ªæ—‹é”ä½¿ç”¨æ³¨æ„äº‹é¡¹" class="headerlink" title="è‡ªæ—‹é”ä½¿ç”¨æ³¨æ„äº‹é¡¹"></a>è‡ªæ—‹é”ä½¿ç”¨æ³¨æ„äº‹é¡¹</h4><p>â‘ ã€å› ä¸ºåœ¨ç­‰å¾…è‡ªæ—‹é”çš„æ—¶å€™å¤„äºâ€œè‡ªæ—‹â€çŠ¶æ€ï¼Œå› æ­¤é”çš„æŒæœ‰æ—¶é—´ä¸èƒ½å¤ªé•¿ï¼Œä¸€å®šè¦çŸ­ï¼Œå¦åˆ™çš„è¯ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚å¦‚æœä¸´ç•ŒåŒºæ¯”è¾ƒå¤§ï¼Œè¿è¡Œæ—¶é—´æ¯”è¾ƒé•¿çš„è¯è¦é€‰æ‹©å…¶ä»–çš„å¹¶å‘å¤„ç†æ–¹å¼ï¼Œæ¯”å¦‚ç¨åè¦è®²çš„ä¿¡å·é‡å’Œäº’æ–¥ä½“ã€‚<br>â‘¡ã€è‡ªæ—‹é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºå†…ä¸èƒ½è°ƒç”¨ä»»ä½•å¯èƒ½å¯¼è‡´çº¿ç¨‹ä¼‘çœ çš„ API å‡½æ•°ï¼Œå¦åˆ™çš„è¯å¯èƒ½å¯¼è‡´æ­»é”ã€‚<br>â‘¢ã€ä¸èƒ½é€’å½’ç”³è¯·è‡ªæ—‹é”ï¼Œå› ä¸ºä¸€æ—¦é€šè¿‡é€’å½’çš„æ–¹å¼ç”³è¯·ä¸€ä¸ªä½ æ­£åœ¨æŒæœ‰çš„é”ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»â€œè‡ªæ—‹â€ï¼Œç­‰å¾…é”è¢«é‡Šæ”¾ï¼Œç„¶è€Œä½ æ­£å¤„äºâ€œè‡ªæ—‹â€çŠ¶æ€ï¼Œæ ¹æœ¬æ²¡æ³•é‡Šæ”¾é”ã€‚ç»“æœå°±æ˜¯è‡ªå·±æŠŠè‡ªå·±é”æ­»äº†ï¼<br>â‘£ã€åœ¨ç¼–å†™é©±åŠ¨ç¨‹åºçš„æ—¶å€™æˆ‘ä»¬å¿…é¡»è€ƒè™‘åˆ°é©±åŠ¨çš„å¯ç§»æ¤æ€§ï¼Œå› æ­¤ä¸ç®¡ä½ ç”¨çš„æ˜¯å•æ ¸çš„è¿˜æ˜¯å¤šæ ¸çš„ SOCï¼Œéƒ½å°†å…¶å½“åšå¤šæ ¸ SOC æ¥ç¼–å†™é©±åŠ¨ç¨‹åºã€‚ </p><h4 id="ç¼–å†™ç¨‹åº"><a href="#ç¼–å†™ç¨‹åº" class="headerlink" title="ç¼–å†™ç¨‹åº"></a>ç¼–å†™ç¨‹åº</h4><p><u><strong>ä½¿ç”¨è‡ªæ—‹é”æ¥å®ç°å¯¹å®ç°è®¾å¤‡çš„äº’æ–¥è®¿é—® ï¼Œå…¶å®æ˜¯ä½¿ç”¨å®šä¹‰çš„è‡ªæ—‹é”æ¥ä¿æŠ¤è®¾å¤‡çŠ¶æ€çš„å˜é‡ï¼Œåœ¨æ”¹å˜è®¾å¤‡çŠ¶æ€çš„å˜é‡å‰åä½¿ç”¨ä¸Šé”å’Œè§£é”çš„æ“ä½œï¼Œä¸»è¦æ˜¯é€šè¿‡åˆ¤æ–­è‡ªæ—‹é”çš„è®¾å¤‡çŠ¶æ€å˜é‡å®ç°è®¾å¤‡çš„äº’æ–¥è®¿é—®ã€‚</strong></u></p><h3 id="ä¿¡å·é‡"><a href="#ä¿¡å·é‡" class="headerlink" title="ä¿¡å·é‡"></a>ä¿¡å·é‡</h3><p>ä¿¡å·é‡ï¼ˆ<a href="https://so.csdn.net/so/search?q=semaphore&spm=1001.2101.3001.7020">semaphore</a>ï¼‰æ˜¯æ“ä½œç³»ç»Ÿç”¨æ¥è§£å†³å¹¶å‘ä¸­çš„äº’æ–¥å’ŒåŒæ­¥é—®é¢˜çš„ä¸€ç§æ–¹æ³•ã€‚<br>ä¿¡å·é‡æ˜¯ä¸€ä¸ªä¸é˜Ÿåˆ—æœ‰å…³çš„æ•´å‹å˜é‡ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªæ•°åé¢æ‹–ç€ä¸€æ¡æ’é˜Ÿçš„é˜Ÿåˆ—ã€‚</p><p>é‚£ä¿¡å·é‡ä¸Šé¢å€¼nä»£è¡¨ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ<br>n&gt;0ï¼šå½“å‰æœ‰å¯ç”¨èµ„æºï¼Œå¯ç”¨èµ„æºæ•°é‡ä¸ºn<br>n&#x3D;0ï¼šèµ„æºéƒ½è¢«å ç”¨ï¼Œå¯ç”¨èµ„æºæ•°é‡ä¸º0<br>n&lt;0ï¼šèµ„æºéƒ½è¢«å ç”¨ï¼Œå¹¶ä¸”è¿˜æœ‰nä¸ªè¿›ç¨‹æ­£åœ¨æ’é˜Ÿ<br>é‚£ä¿¡å·é‡æ‹–ç€çš„é‚£ä¸ªé˜Ÿåˆ—å°±æ˜¯ç”¨æ¥æ”¾æ­£åœ¨æ’é˜Ÿæƒ³è¦ä½¿ç”¨è¿™ä¸€èµ„æºçš„è¿›ç¨‹ã€‚</p><p>ä¿¡å·é‡çš„ç‰¹ç‚¹ï¼š<br>â‘ ã€å› ä¸ºä¿¡å·é‡å¯ä»¥ä½¿ç­‰å¾…èµ„æºçº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå› æ­¤é€‚ç”¨äºé‚£äº›å ç”¨èµ„æºæ¯”è¾ƒä¹…çš„åœºåˆã€‚<br>â‘¡ã€å› æ­¤ä¿¡å·é‡ä¸èƒ½ç”¨äºä¸­æ–­ä¸­ï¼Œå› ä¸ºä¿¡å·é‡ä¼šå¼•èµ·ä¼‘çœ ï¼Œä¸­æ–­ä¸èƒ½ä¼‘çœ ã€‚<br>â‘¢ã€å¦‚æœå…±äº«èµ„æºçš„æŒæœ‰æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œé‚£å°±ä¸é€‚åˆä½¿ç”¨ä¿¡å·é‡äº†ï¼Œå› ä¸ºé¢‘ç¹çš„ä¼‘çœ ã€åˆ‡æ¢çº¿ç¨‹å¼•èµ·çš„å¼€é”€è¦è¿œå¤§äºä¿¡å·é‡å¸¦æ¥çš„é‚£ç‚¹ä¼˜åŠ¿ã€‚ </p><p>ä¿¡å·é‡APIå‡½æ•°</p><p>Linux å†…æ ¸ä½¿ç”¨ semaphore ç»“æ„ä½“è¡¨ç¤ºä¿¡å·é‡ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> &#123;</span></span><br><span class="line"><span class="type">raw_spinlock_t</span> lock;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">wait_list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-20%20185124.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> <span class="title">sem</span>;</span> <span class="comment">/* å®šä¹‰ä¿¡å·é‡ */</span></span><br><span class="line">sema_init(&amp;sem, <span class="number">1</span>); <span class="comment">/* åˆå§‹åŒ–ä¿¡å·é‡ */</span></span><br><span class="line">down(&amp;sem); <span class="comment">/* ç”³è¯·ä¿¡å·é‡ */</span></span><br><span class="line"><span class="comment">/* ä¸´ç•ŒåŒº */</span></span><br><span class="line">up(&amp;sem); <span class="comment">/* é‡Šæ”¾ä¿¡å·é‡ */</span></span><br></pre></td></tr></table></figure><h3 id="äº’æ–¥ä½“"><a href="#äº’æ–¥ä½“" class="headerlink" title="äº’æ–¥ä½“"></a>äº’æ–¥ä½“</h3><p>å°†ä¿¡å·é‡çš„å€¼è®¾ç½®ä¸º 1 å°±å¯ä»¥ä½¿ç”¨ä¿¡å·é‡è¿›è¡Œäº’æ–¥è®¿é—®äº†ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡ä¿¡å·é‡å®ç°äº’æ–¥ï¼Œä½†æ˜¯ Linux æä¾›äº†ä¸€ä¸ªæ¯”ä¿¡å·é‡æ›´ä¸“ä¸šçš„æœºåˆ¶æ¥è¿›è¡Œäº’æ–¥ï¼Œå®ƒå°±æ˜¯äº’æ–¥ä½“â€”mutexã€‚äº’æ–¥è®¿é—®è¡¨ç¤ºä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«èµ„æºï¼Œä¸èƒ½é€’å½’ç”³è¯·äº’æ–¥ä½“ã€‚åœ¨æˆ‘ä»¬ç¼–å†™ Linux é©±åŠ¨çš„æ—¶å€™é‡åˆ°éœ€è¦äº’æ–¥è®¿é—®çš„åœ°æ–¹å»ºè®®ä½¿ç”¨ mutexã€‚  </p><p>linuxå†…æ ¸ä½¿ç”¨mutexç»“æ„ä½“è¡¨ç¤ºäº’æ–¥ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> &#123;</span></span><br><span class="line"><span class="comment">/* 1: unlocked, 0: locked, negative: locked, possible waiters */</span></span><br><span class="line"><span class="type">atomic_t</span> count;</span><br><span class="line"><span class="type">spinlock_t</span> wait_lock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨ mutex ä¹‹å‰è¦å…ˆå®šä¹‰ä¸€ä¸ª mutex å˜é‡ã€‚åœ¨ä½¿ç”¨ mutex çš„æ—¶å€™è¦æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š<br>â‘ ã€ mutex å¯ä»¥å¯¼è‡´ä¼‘çœ ï¼Œå› æ­¤ä¸èƒ½åœ¨ä¸­æ–­ä¸­ä½¿ç”¨ mutexï¼Œä¸­æ–­ä¸­åªèƒ½ä½¿ç”¨è‡ªæ—‹é”ã€‚<br>â‘¡ã€å’Œä¿¡å·é‡ä¸€æ ·ï¼Œ mutex ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¯ä»¥è°ƒç”¨å¼•èµ·é˜»å¡çš„ API å‡½æ•°ã€‚<br>â‘¢ã€å› ä¸ºä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŒæœ‰ mutexï¼Œå› æ­¤ï¼Œå¿…é¡»ç”± mutex çš„æŒæœ‰è€…é‡Šæ”¾ mutexã€‚å¹¶ä¸” mutex ä¸èƒ½é€’å½’ä¸Šé”å’Œè§£é” </p><p><strong>APIå‡½æ•°</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-20%20190738.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span> <span class="comment">/* å®šä¹‰ä¸€ä¸ªäº’æ–¥ä½“ */</span></span><br><span class="line"><span class="number">2</span> mutex_init(&amp;lock); <span class="comment">/* åˆå§‹åŒ–äº’æ–¥ä½“ */</span></span><br><span class="line"><span class="number">3</span> </span><br><span class="line"><span class="number">4</span> mutex_lock(&amp;lock); <span class="comment">/* ä¸Šé” */</span></span><br><span class="line"><span class="number">5</span> <span class="comment">/* ä¸´ç•ŒåŒº */</span></span><br><span class="line"><span class="number">6</span> mutex_unlock(&amp;lock); <span class="comment">/* è§£é” */</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gpioå­ç³»ç»Ÿ</title>
      <link href="/2023/04/14/2023-4-14-pinctrl%E5%92%8Cgpio%E5%AD%90%E7%B3%BB%E7%BB%9F/"/>
      <url>/2023/04/14/2023-4-14-pinctrl%E5%92%8Cgpio%E5%AD%90%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<h3 id="GPIOå­ç³»ç»Ÿ"><a href="#GPIOå­ç³»ç»Ÿ" class="headerlink" title="GPIOå­ç³»ç»Ÿ"></a>GPIOå­ç³»ç»Ÿ</h3><h4 id="GPIOå­ç³»ç»ŸAPIå‡½æ•°"><a href="#GPIOå­ç³»ç»ŸAPIå‡½æ•°" class="headerlink" title="GPIOå­ç³»ç»ŸAPIå‡½æ•°"></a>GPIOå­ç³»ç»ŸAPIå‡½æ•°</h4><p>å¯¹äºé©±åŠ¨å¼€å‘äººå‘˜ï¼Œ<strong>è®¾ç½®å¥½è®¾å¤‡æ ‘ä»¥åå°±å¯ä»¥ä½¿ç”¨ gpio å­ç³»ç»Ÿæä¾›çš„ API å‡½æ•°æ¥æ“ä½œæŒ‡å®šçš„ GPIOï¼Œ gpio å­ç³»ç»Ÿå‘é©±åŠ¨å¼€å‘äººå‘˜å±è”½äº†å…·ä½“çš„è¯»å†™å¯„å­˜å™¨è¿‡ç¨‹ã€‚</strong>è¿™å°±æ˜¯é©±åŠ¨åˆ†å±‚ä¸åˆ†ç¦»çš„å¥½å¤„ï¼Œå¤§å®¶å„å¸å…¶èŒï¼Œåšå¥½è‡ªå·±çš„æœ¬èŒå·¥ä½œå³å¯ã€‚ gpio å­ç³»ç»Ÿæä¾›çš„å¸¸ç”¨çš„ API å‡½æ•°æœ‰ä¸‹é¢å‡ ä¸ªï¼š </p><ol><li><p>gpio_requestå‡½æ•°ï¼Œç”¨äºç”³è¯·ä¸€ä¸ª GPIO ç®¡è„š </p><p>åœ¨ä½¿ç”¨ä¸€ä¸ª GPIO ä¹‹å‰ä¸€å®šè¦ä½¿ç”¨ gpio_requestè¿›è¡Œç”³è¯· </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gpio_request</span><span class="params">(<span class="type">unsigned</span> gpio, <span class="type">const</span> <span class="type">char</span> *label)</span></span><br></pre></td></tr></table></figure><p>gpio:è¦ç”³è¯·çš„gpioå·ï¼Œä½¿ç”¨of_get_named_gpioå‡½æ•°ä»è®¾å¤‡æ ‘è·å–æŒ‡å®šgpioå±æ€§</p><p>label: gpioçš„åå­—</p><p>è¿”å›å€¼ï¼š0ç”³è¯·æˆåŠŸï¼Œå…¶ä»–å€¼å¤±è´¥</p></li><li><p>gpio_freeå‡½æ•°ï¼Œ é‡Šæ”¾gpio</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">gpio_free</span><span class="params">(<span class="type">unsigned</span> gpio)</span></span><br></pre></td></tr></table></figure><p>gpio: é‡Šæ”¾çš„gpio</p><p>è¿”å›å€¼æ— </p></li><li><p>gpio_direction_inputå‡½æ•° ï¼Œ è®¾ç½®gpioä¸ºè¾“å…¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">gpio_direction_input</span><span class="params">(<span class="type">unsigned</span> gpio)</span></span><br></pre></td></tr></table></figure><p>gpio:è¦è®¾ç½®çš„gpio</p><p>è¿”å›å€¼ï¼šè®¾ç½®æˆåŠŸï¼Œè´Ÿå€¼è®¾ç½®å¤±è´¥</p></li><li><p>gpio_direction_outputå‡½æ•° ï¼Œè®¾ç½®æŸä¸ª GPIO ä¸ºè¾“å‡º </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gpio_direction_output</span><span class="params">(<span class="type">unsigned</span> gpio, <span class="type">int</span> value)</span></span><br></pre></td></tr></table></figure><p>gpioï¼šè¦è®¾ç½®ä¸ºè¾“å‡ºçš„ GPIO æ ‡å·ã€‚<br>valueï¼š GPIO é»˜è®¤è¾“å‡ºå€¼ã€‚<br>è¿”å›å€¼ï¼š 0ï¼Œè®¾ç½®æˆåŠŸï¼›è´Ÿå€¼ï¼Œè®¾ç½®å¤±è´¥ã€‚ </p></li><li><p>gpio_get_valueå‡½æ•°ï¼Œ äºè·å–æŸä¸ª GPIO çš„å€¼ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> gpio_get_value __gpio_get_value</span></span><br><span class="line"><span class="type">int</span> __gpio_get_value(<span class="type">unsigned</span> gpio)</span><br></pre></td></tr></table></figure><p>gpioï¼šè¦è·å–çš„ GPIO æ ‡å·ã€‚<br>è¿”å›å€¼ï¼š éè´Ÿå€¼ï¼Œå¾—åˆ°çš„ GPIO å€¼ï¼›è´Ÿå€¼ï¼Œè·å–å¤±è´¥ã€‚ </p></li><li><p>gpio_set_valueå‡½æ•°ï¼Œ è®¾ç½®æŸä¸ª GPIO çš„å€¼</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> gpio_set_value __gpio_set_value</span></span><br><span class="line"><span class="type">void</span> __gpio_set_value(<span class="type">unsigned</span> gpio, <span class="type">int</span> value)</span><br></pre></td></tr></table></figure><p>â€‹gpioï¼šè¦è®¾ç½®çš„ GPIO æ ‡å·ã€‚<br>â€‹valueï¼š è¦è®¾ç½®çš„å€¼ã€‚<br>â€‹è¿”å›å€¼ï¼š æ—  </p><h3 id="è®¾å¤‡æ ‘ä¸­æ·»åŠ GPIOèŠ‚ç‚¹æ¨¡æ¿"><a href="#è®¾å¤‡æ ‘ä¸­æ·»åŠ GPIOèŠ‚ç‚¹æ¨¡æ¿" class="headerlink" title="è®¾å¤‡æ ‘ä¸­æ·»åŠ GPIOèŠ‚ç‚¹æ¨¡æ¿"></a>è®¾å¤‡æ ‘ä¸­æ·»åŠ GPIOèŠ‚ç‚¹æ¨¡æ¿</h3><ul><li>åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</li><li>æ·»åŠ pinctrlä¿¡æ¯</li><li>æ·»åŠ GPIOå±æ€§ä¿¡æ¯</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/&#123;</span><br><span class="line">gpio&#123;<span class="comment">/*æŠŠgpioèŠ‚ç‚¹æ·»åŠ åˆ°æ ¹èŠ‚ç‚¹ä¸‹*/</span></span><br><span class="line">pinctrl-names = <span class="string">&quot;default&quot;</span>;<span class="comment">/*æ·»åŠ  pinctrl-names å±æ€§*/</span></span><br><span class="line">pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_gpio&gt;;<span class="comment">/*æ·»åŠ  pinctrl-0 èŠ‚ç‚¹ï¼Œä½¿ç”¨çš„ PIN ä¿¡æ¯ä¿å­˜åœ¨ pinctrl_gpio èŠ‚ç‚¹ä¸­*/</span></span><br><span class="line">gpio = &lt;&amp;gpio1 <span class="number">0</span> GPIO_ACTIVE_LOW&gt;;<span class="comment">/*è®¾å¤‡ç”¨çš„gpio*/</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="gpio-ç›¸å…³çš„-OF-å‡½æ•°"><a href="#gpio-ç›¸å…³çš„-OF-å‡½æ•°" class="headerlink" title="gpio ç›¸å…³çš„ OF å‡½æ•°"></a>gpio ç›¸å…³çš„ OF å‡½æ•°</h4><p>åœ¨é©±åŠ¨ç¨‹åºä¸­éœ€è¦è¯»å– gpio å±æ€§å†…å®¹ï¼Œ Linux å†…æ ¸æä¾›äº†å‡ ä¸ªä¸ GPIO æœ‰å…³çš„ OF å‡½æ•°ï¼Œå¸¸ç”¨çš„å‡ ä¸ª OF å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_gpio_named_count</span><span class="params">(<span class="keyword">struct</span> device_node *np, <span class="type">const</span> <span class="type">char</span> *propname)</span><span class="comment">//è·å–è®¾å¤‡æ ‘æŸä¸ªå±æ€§å®šä¹‰äº†å‡ ä¸ªgpioä¿¡æ¯</span></span><br></pre></td></tr></table></figure><p>npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚<br>propnameï¼šè¦ç»Ÿè®¡çš„ GPIO å±æ€§ã€‚<br>è¿”å›å€¼ï¼š æ­£å€¼ï¼Œç»Ÿè®¡åˆ°çš„ GPIO æ•°é‡ï¼›è´Ÿå€¼ï¼Œå¤±è´¥ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_gpio_count</span><span class="params">(<span class="keyword">struct</span> device_node *np)</span><span class="comment">//ç»Ÿè®¡çš„æ˜¯â€œgpiosâ€è¿™ä¸ªå±æ€§çš„ GPIO æ•°é‡</span></span><br></pre></td></tr></table></figure><p>npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚<br>è¿”å›å€¼ï¼š æ­£å€¼ï¼Œç»Ÿè®¡åˆ°çš„ GPIO æ•°é‡ï¼›è´Ÿå€¼ï¼Œå¤±è´¥ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_get_named_gpio</span><span class="params">(<span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params"><span class="type">int</span> index)</span><span class="comment">//æ­¤å‡½æ•°ä¼šå°†è®¾å¤‡æ ‘ä¸­ç±»ä¼¼&lt;&amp;gpio5 7 GPIO_ACTIVE_LOW&gt;çš„å±æ€§ä¿¡æ¯è½¬æ¢ä¸ºå¯¹åº”çš„ GPIO ç¼–</span></span><br><span class="line">å·</span><br></pre></td></tr></table></figure><p>npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</p><p>propnameï¼šåŒ…å«è¦è·å– GPIO ä¿¡æ¯çš„å±æ€§åã€‚</p><p>indexï¼š GPIO ç´¢å¼•ï¼Œå› ä¸ºä¸€ä¸ªå±æ€§é‡Œé¢å¯èƒ½åŒ…å«å¤šä¸ª GPIOï¼Œæ­¤å‚æ•°æŒ‡å®šè¦è·å–å“ªä¸ª GPIOçš„ç¼–å·ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ª GPIO ä¿¡æ¯çš„è¯æ­¤å‚æ•°ä¸º 0ã€‚<br>è¿”å›å€¼ï¼š æ­£å€¼ï¼Œè·å–åˆ°çš„ GPIO ï¼›è´Ÿå€¼ï¼Œå¤±è´¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_address.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> off0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> on1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpioled_dev</span>&#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="type">int</span> major;</span><br><span class="line"><span class="type">int</span> minor;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span></span><br><span class="line"><span class="type">int</span> led_gpio;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpioled_dev</span> <span class="title">gpioled</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_open</span><span class="params">(<span class="keyword">struct</span> inode *inode ,<span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">filp-&gt;private_data = &amp;gpioled;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_release</span><span class="params">(<span class="keyword">struct</span> inode *inode , <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">gpio_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">gpio_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> val;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">1</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> state;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpioled_dev</span> *<span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line">val = copy_from_user(databuf, buf, cnt);</span><br><span class="line"><span class="keyword">if</span>(val &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kernl write failed \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">&#125;</span><br><span class="line">state = databuf[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(state == on)</span><br><span class="line">&#123;</span><br><span class="line">gpio_set_value(dev-&gt;led_gpio, <span class="number">0</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(state == off)</span><br><span class="line">&#123;</span><br><span class="line">gpio_set_value(dev-&gt;led_gpio, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">gpioled_ops</span> =</span>&#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.open = gpio_open,</span><br><span class="line">.read = gpio_read,</span><br><span class="line">.write = gpio_write,</span><br><span class="line">.release = gpio_release,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">gpio_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">gpioled.nd = of_find_node_by_path(<span class="string">&quot;/gpioled&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(gpioled.nd == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;gpioled node can not found\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">printk(<span class="string">&quot;gpioled node found\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">gpioled.led_gpio = of_get_named_gpio(gpioled.nd, <span class="string">&quot;led-gpio&quot;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(gpioled.led_gpio &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;can not led-gpio\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">ret = gpio_direction_output(gpioled.led_gpio, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;can&#x27;t see gpio\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(gpioled.major)</span><br><span class="line">&#123;</span><br><span class="line">gpioled.devid = MKDEV(gpioled.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(gpioled.devid, <span class="number">1</span>, <span class="string">&quot;led&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">alloc_chrdev_region(&amp;gpioled.devid, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;led&quot;</span>);</span><br><span class="line">gpioled.major = MAJOR(gpioled.devid);</span><br><span class="line">gpioled.minor = MINOR(gpioled.devid);</span><br><span class="line">&#125;</span><br><span class="line">gpioled.cdev.owner = THIS_MODULE;</span><br><span class="line">cdev_init(&amp;gpioled.cdev, &amp;gpioled_ops);</span><br><span class="line">cdev_add(&amp;gpioled.cdev, gpioled.devid, <span class="number">1</span>);</span><br><span class="line">gpioled.class = class_create(THIS_MODULE, <span class="string">&quot;led&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(IS_ERR(gpioled.class))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(gpioled.class);</span><br><span class="line">&#125;</span><br><span class="line">gpioled.device = device_create(gpioled.class, <span class="literal">NULL</span>,gpioled.devid, <span class="literal">NULL</span>,<span class="string">&quot;led&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(IS_ERR(gpioled.device))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(gpioled.device);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">gpio_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">cdev_del(&amp;gpioled.cdev);</span><br><span class="line">unregister_chrdev_region(gpioled.devid, <span class="number">1</span>);</span><br><span class="line">device_destroy(gpioled.class, gpioled.devid);</span><br><span class="line">class_destroy(gpioled.class);</span><br><span class="line">&#125;</span><br><span class="line">module_init(gpio_init);</span><br><span class="line">module_exit(gpio_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾å¤‡æ ‘ä¸Šçš„é©±åŠ¨å¼€å‘</title>
      <link href="/2023/04/11/2023-4-11-%E8%AE%BE%E5%A4%87%E6%A0%91%E4%B8%8A%E7%9A%84%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
      <url>/2023/04/11/2023-4-11-%E8%AE%BE%E5%A4%87%E6%A0%91%E4%B8%8A%E7%9A%84%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h3 id="è®¾å¤‡æ ‘é©±åŠ¨ç¼–å†™æ¡†æ¶"><a href="#è®¾å¤‡æ ‘é©±åŠ¨ç¼–å†™æ¡†æ¶" class="headerlink" title="è®¾å¤‡æ ‘é©±åŠ¨ç¼–å†™æ¡†æ¶"></a>è®¾å¤‡æ ‘é©±åŠ¨ç¼–å†™æ¡†æ¶</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-11%20180457.png"></p><h3 id="ç¼–å†™è®¾å¤‡æ ‘èŠ‚ç‚¹"><a href="#ç¼–å†™è®¾å¤‡æ ‘èŠ‚ç‚¹" class="headerlink" title="ç¼–å†™è®¾å¤‡æ ‘èŠ‚ç‚¹"></a>ç¼–å†™è®¾å¤‡æ ‘èŠ‚ç‚¹</h3><p>é¦–å…ˆæ˜¯å°†èŠ‚ç‚¹ç¼–å†™åœ¨ä½¿ç”¨çš„å¼€å‘æ¿çš„dtsæ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚ç¼–å†™ledçš„èŠ‚ç‚¹ã€‚é¦–å…ˆå°†èŠ‚ç‚¹ç¼–å†™åœ¨æ ¹èŠ‚ç‚¹ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">alphaled<span class="comment">//èŠ‚ç‚¹åå­—&#123;</span></span><br><span class="line"><span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">  <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">  compatible = <span class="string">&quot;atkalpha-led&quot;</span>;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">reg = &#123;</span><br><span class="line">  <span class="number">0X020C406C</span> <span class="number">0X04</span> <span class="comment">//CCM_CCGR1_BASE</span></span><br><span class="line">        <span class="number">0X020E0068</span> <span class="number">0X04</span> <span class="comment">//SW_MUX_GPIO103_BASE</span></span><br><span class="line">        <span class="number">0X020E02F4</span> <span class="number">0X04</span> <span class="comment">//SW_PAD_GPIO103_BASE</span></span><br><span class="line">        <span class="number">0X0209C000</span> <span class="number">0X04</span> <span class="comment">//GPIO1_DR_BASE</span></span><br><span class="line">  <span class="number">0X0209C004</span> <span class="number">0X04</span> <span class="comment">//GPIO1_GDIR_BASE      </span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨èŠ‚ç‚¹ä¸­å·²ç»å†™å…¥ç‰©ç†åœ°å€ï¼Œæ‰€ä»¥é©±åŠ¨ç¨‹åºè¿›è¡Œè·å–å°±è¡Œä¸ç”¨å†™äº†ï¼Œè®¾å¤‡æ ‘ä¿®æ”¹å®Œé‡æ–°ç¼–è¯‘</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make dtbs</span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™ç¨‹åº"><a href="#ç¼–å†™ç¨‹åº" class="headerlink" title="ç¼–å†™ç¨‹åº"></a>ç¼–å†™ç¨‹åº</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_address.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> on 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> off 0</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *CCM_CCGR1;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *SW_MUX_GPIO1_IO03;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *SW_PAD_GPIO1_IO03;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *GPIO1_DR;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *GPIO1_GDIR;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">led_switch</span><span class="params">(u8 state)</span></span><br><span class="line">&#123;</span><br><span class="line">u32 val;</span><br><span class="line">val = readl(GPIO1_DR);</span><br><span class="line"><span class="keyword">if</span>(state == on)</span><br><span class="line">&#123;</span><br><span class="line">val |= (<span class="number">0</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(state == off)</span><br><span class="line">&#123;</span><br><span class="line">val |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line">writel(val, GPIO1_DR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">devtree</span> &#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"><span class="type">int</span> major;</span><br><span class="line"><span class="type">int</span> minor;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">devtree</span> <span class="title">chrled</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_open</span><span class="params">(<span class="keyword">struct</span> inode *inode , <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">filp-&gt;private_data = &amp;chrled;<span class="comment">//è®¾ç½®ç§æœ‰æ•°æ®</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> val;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">1</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> state;</span><br><span class="line"></span><br><span class="line">val = copy_from_user(databuf, buf, cnt);</span><br><span class="line">state = databuf[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(state == on)</span><br><span class="line">&#123;</span><br><span class="line">led_switch(on);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(state == off)</span><br><span class="line">&#123;</span><br><span class="line">led_switch(off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">chrops</span> =</span> &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.open = led_open,</span><br><span class="line">.read = led_read,</span><br><span class="line">.write = led_write,</span><br><span class="line">.release = led_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">chrled_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> val;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">proper</span>;</span></span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *str;</span><br><span class="line">u32 regdata[<span class="number">14</span>];</span><br><span class="line"></span><br><span class="line">chrled.nd = of_find_node_by_path(<span class="string">&quot;/alphaled&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(chrled.nd == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;error: node don&#x27;t find \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">proper = of_find_property(chrled.nd, <span class="string">&quot;compatible&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span>(proper == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;compatible property find failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">ret = of_property_read_string(chrled.nd, <span class="string">&quot;status&quot;</span>, &amp;str);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;status read failed\r\n&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">printk(<span class="string">&quot;status = %s\r\n&quot;</span>,str);</span><br><span class="line">&#125;</span><br><span class="line">ret = of_property_read_u32_array(chrled.nd , <span class="string">&quot;reg&quot;</span>, regdata, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;reg property read failed!\r\n&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">u8 i = <span class="number">0</span>;</span><br><span class="line">printk(<span class="string">&quot;reg data: \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">10</span>; i++)</span><br><span class="line">printk(<span class="string">&quot;%#X &quot;</span>, regdata[i]);</span><br><span class="line">printk(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">CCM_CCGR1 = of_iomap(chrled.nd, <span class="number">0</span>);</span><br><span class="line">SW_MUX_GPIO1_IO03 = of_iomap(chrled.nd, <span class="number">1</span>);</span><br><span class="line">SW_PAD_GPIO1_IO03 = of_iomap(chrled.nd, <span class="number">2</span>);</span><br><span class="line">GPIO1_DR = of_iomap(chrled.nd, <span class="number">3</span>);</span><br><span class="line">GPIO1_GDIR = of_iomap(chrled.nd, <span class="number">4</span>);</span><br><span class="line"><span class="comment">/*è®¾å¤‡é©±åŠ¨*/</span></span><br><span class="line">val = readl(CCM_CCGR1);</span><br><span class="line">val &amp;= ~(<span class="number">3</span> &lt;&lt; <span class="number">26</span>);</span><br><span class="line">val |= (<span class="number">3</span>&lt;&lt;<span class="number">26</span>);</span><br><span class="line">writel(val, CCM_CCGR1);</span><br><span class="line">writel(<span class="number">5</span>, SW_MUX_GPIO1_IO03);</span><br><span class="line">writel(<span class="number">0x10B0</span>, SW_PAD_GPIO1_IO03);</span><br><span class="line">val = readl(GPIO1_GDIR);</span><br><span class="line">val &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">val |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">writel(val, GPIO1_GDIR);</span><br><span class="line">val = readl(GPIO1_DR);</span><br><span class="line">val |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">writel(val, GPIO1_DR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(chrled.major)</span><br><span class="line">&#123;</span><br><span class="line">chrled.devid = MKDEV(chrled.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(chrled.devid, <span class="number">1</span>, <span class="string">&quot;led&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">alloc_chrdev_region(&amp;chrled.devid, <span class="number">0</span>, <span class="number">1</span>,<span class="string">&quot;led&quot;</span>);</span><br><span class="line">chrled.major = MAJOR(chrled.devid);</span><br><span class="line">chrled.minor = MINOR(chrled.devid);</span><br><span class="line">&#125;</span><br><span class="line">cdev_init(&amp;chrled.cdev, &amp;chrops);</span><br><span class="line">chrled.cdev.owner = THIS_MODULE;</span><br><span class="line">cdev_add(&amp;chrled.cdev, chrled.devid, <span class="number">1</span>);</span><br><span class="line">chrled.class = class_create(THIS_MODULE, <span class="string">&quot;led&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(IS_ERR(chrled.class))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(chrled.class);</span><br><span class="line">&#125;</span><br><span class="line">chrled.device = device_create(chrled.class, <span class="literal">NULL</span>,chrled.devid, <span class="literal">NULL</span>,<span class="string">&quot;led&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(IS_ERR(chrled.device))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(chrled.device);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">chrled_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">iounmap(CCM_CCGR1);</span><br><span class="line">iounmap(SW_MUX_GPIO1_IO03);</span><br><span class="line">iounmap(SW_PAD_GPIO1_IO03);</span><br><span class="line">iounmap(GPIO1_GDIR);</span><br><span class="line">iounmap(GPIO1_DR);</span><br><span class="line"></span><br><span class="line">cdev_del(&amp;chrled.cdev);</span><br><span class="line">unregister_chrdev_region(chrled.devid, <span class="number">1</span>);</span><br><span class="line">device_destroy(chrled.class, chrled.devid);</span><br><span class="line">class_destroy(chrled.class);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">module_init(chrled_init);</span><br><span class="line">module_exit(chrled_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nfsæŒ‚è½½è®¾å¤‡æ ‘å¤±è´¥</title>
      <link href="/2023/04/10/2023-4-10-nfs%E6%8C%82%E8%BD%BD%E8%AE%BE%E5%A4%87%E6%A0%91%E5%A4%B1%E8%B4%A5/"/>
      <url>/2023/04/10/2023-4-10-nfs%E6%8C%82%E8%BD%BD%E8%AE%BE%E5%A4%87%E6%A0%91%E5%A4%B1%E8%B4%A5/</url>
      
        <content type="html"><![CDATA[<h3 id="VFS-Cannot-open-root-device-â€œnfsâ€-or-unknown-block-2-0"><a href="#VFS-Cannot-open-root-device-â€œnfsâ€-or-unknown-block-2-0" class="headerlink" title="VFS: Cannot open root device â€œnfsâ€ or unknown-block(2,0)"></a>VFS: Cannot open root device â€œnfsâ€ or unknown-block(2,0)</h3><p>é¦–å…ˆè¯´æ˜ä¸€ä¸‹é—®é¢˜ï¼Œä¹‹å‰æ ¹æ–‡ä»¶ç³»ç»Ÿä¸€ç›´æ­£å¸¸ä½¿ç”¨ï¼Œçªç„¶ä»Šå¤©è¿›è¡Œäº†ä»¥ä¸ŠæŠ¥é”™ï¼Œé¦–å…ˆæ˜¯æœç´¢äº†ä¸€ä¸‹é—®é¢˜ï¼Œè¯´æ˜¯å¼€å‘æ¿å†…æ ¸å’ŒUbuntuçš„nfsç‰ˆæœ¬ä¸åŒ¹é…ï¼Œä¹‹å‰é‡åˆ°è¿‡ï¼Œç³»ç»Ÿæ¢æˆUbuntu16ç‰ˆæœ¬çš„äº†ï¼Œåº”è¯¥å¯ä»¥æ’é™¤ï¼Œä½†æ˜¯ä¹Ÿè¯•äº†ä¸€ä¸‹ä¸å¥½ä½¿ã€‚</p><p>æ„Ÿè§‰æ˜¯ipåœ°å€çš„å˜åŒ–å°†bootargså˜é‡é‡Œçš„æœåŠ¡å™¨ipåœ°å€çš„æ•°å€¼è¿›è¡Œäº†ç›¸åº”çš„æ”¹å˜ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰å˜åŒ–ã€‚</p><p>æŸ¥äº†ç›¸å…³çš„é—®é¢˜æœç´¢å‘ç°ï¼Œæ²¡æœ‰è§£å†³æ–¹æ¡ˆï¼Œæˆ‘å…ˆæ˜¯è¿›è¡Œäº†å¼€å‘æ¿çš„å›ºåŒ–ç³»ç»Ÿï¼Œä½¿ç”¨äº†emmcä¸­çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå‘ç°æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ä½¿ç”¨ç½‘ç»œnfsæŒ‚è½½è¿˜æ˜¯å‡ºç°äº†é—®é¢˜ï¼Œæœ€åé€šè¿‡è£…è½½äº†ç¬¬äºŒä¸ªç³»ç»Ÿè¿›è¡ŒæŒ‚è½½å‘ç°äº†é—®é¢˜æ‰€åœ¨ã€‚</p><p>é—®é¢˜æ˜¯ï¼šæ¿å­çš„ipåœ°å€å’Œåˆ«çš„è®¾å¤‡çš„ipåœ°å€å†²çªäº†ï¼ˆè™½ç„¶ä¹‹å‰ä¹Ÿdhcpäº†ä½†å½“æ—¶æ²¡å¥½ä½¿ï¼‰ï¼ŒåŠ ä¸Šäº†æœåŠ¡å™¨ipåœ°å€çš„å˜åŒ–å¯¼è‡´çš„ã€‚</p><p>æ‰€ä»¥ä¸ºäº†ä¸€åŠ³æ°¸é€¸ï¼Œå°†Ubuntuçš„åŠ¨æ€åˆ†é…ipåœ°å€è¿›è¡Œäº†æ›´æ”¹ï¼Œæ”¹ä¸ºé™æ€åˆ†é…ipåœ°å€ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipaddr</span><br></pre></td></tr></table></figure><p>å¯ä»¥æŸ¥çœ‹å‘ç°ç½‘å¡çš„åå­—ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-10%20210629.png"></p><p>ç½‘å¡åå­—å«åšens33</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/network/interfaces</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">auto lo</span><br><span class="line"> </span><br><span class="line">iface lo inet loopback</span><br><span class="line"> </span><br><span class="line">auto ens33</span><br><span class="line"> </span><br><span class="line">iface ens33 inet static</span><br><span class="line">address  192.168.1.128</span><br><span class="line">netmask  255.255.255.0</span><br><span class="line">gateway  192.168.1.1</span><br></pre></td></tr></table></figure><p>ä¹‹åè¿›è¡Œé‡å¯ç½‘å¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/networking start</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾å¤‡æ ‘å¸¸ç”¨çš„ofæ“ä½œæ ‘</title>
      <link href="/2023/04/09/2023-4-9-%E8%AE%BE%E5%A4%87%E6%A0%91%E5%B8%B8%E7%94%A8%E7%9A%84of%E6%93%8D%E4%BD%9C%E6%A0%91/"/>
      <url>/2023/04/09/2023-4-9-%E8%AE%BE%E5%A4%87%E6%A0%91%E5%B8%B8%E7%94%A8%E7%9A%84of%E6%93%8D%E4%BD%9C%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<h3 id="è®¾å¤‡æ ‘å¸¸ç”¨-OF-æ“ä½œå‡½æ•°"><a href="#è®¾å¤‡æ ‘å¸¸ç”¨-OF-æ“ä½œå‡½æ•°" class="headerlink" title="è®¾å¤‡æ ‘å¸¸ç”¨ OF æ“ä½œå‡½æ•°"></a>è®¾å¤‡æ ‘å¸¸ç”¨ OF æ“ä½œå‡½æ•°</h3><p>è®¾å¤‡æ ‘æè¿°äº†è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åŒ…æ‹¬æ•°å­—ç±»å‹çš„ã€å­—ç¬¦ä¸²ç±»å‹çš„ã€æ•°ç»„ç±»å‹çš„ï¼Œåœ¨ç¼–å†™é©±åŠ¨çš„æ—¶å€™éœ€è¦è·å–åˆ°è¿™äº›ä¿¡æ¯ã€‚æ¯”å¦‚è®¾å¤‡æ ‘ä½¿ç”¨ reg å±æ€§æè¿°äº†æŸä¸ªå¤–è®¾çš„å¯„å­˜å™¨åœ°å€ä¸º 0X02005482ï¼Œé•¿åº¦ä¸º 0X400ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™é©±åŠ¨çš„æ—¶å€™éœ€è¦è·å–åˆ° reg å±æ€§0X02005482å’Œ 0X400 è¿™ä¸¤ä¸ªå€¼ï¼Œç„¶ååˆå§‹åŒ–å¤–è®¾ã€‚ </p><p>Linux å†…æ ¸ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—çš„å‡½æ•°æ¥è·å–è®¾å¤‡æ ‘ä¸­çš„èŠ‚ç‚¹æˆ–è€…å±æ€§ä¿¡æ¯ï¼Œè¿™ä¸€ç³»åˆ—çš„å‡½æ•°éƒ½æœ‰ä¸€ä¸ªç»Ÿä¸€çš„å‰ç¼€â€œof_â€ï¼Œæ‰€ä»¥åœ¨å¾ˆå¤šèµ„æ–™é‡Œé¢ä¹Ÿè¢«å«åš OF å‡½æ•°ã€‚è¿™äº› OF å‡½æ•°åŸå‹éƒ½å®šä¹‰åœ¨ include&#x2F;linux&#x2F;of.h æ–‡ä»¶ä¸­ã€‚</p><p>linuxå†…æ ¸ä½¿ç”¨device_codeç»“æ„ä½“æ¥æè¿°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ­¤ç»“æ„ä½“å®šä¹‰åœ¨include&#x2F;linux&#x2F;of.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> &#123;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name; <span class="comment">/* èŠ‚ç‚¹åå­— */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *type; <span class="comment">/* è®¾å¤‡ç±»å‹ */</span></span><br><span class="line">phandle phandle;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *full_name; <span class="comment">/* èŠ‚ç‚¹å…¨å */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span> <span class="title">fwnode</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">properties</span>;</span> <span class="comment">/* å±æ€§ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">deadprops</span>;</span> <span class="comment">/* removed å±æ€§ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">parent</span>;</span> <span class="comment">/* çˆ¶èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">child</span>;</span> <span class="comment">/* å­èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">sibling</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> _flags;</span><br><span class="line"><span class="type">void</span> *data;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPARC)</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *path_component_name;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> unique_id;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">of_irq_controller</span> *<span class="title">irq_trans</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æŸ¥æ‰¾èŠ‚ç‚¹ofå‡½æ•°"><a href="#æŸ¥æ‰¾èŠ‚ç‚¹ofå‡½æ•°" class="headerlink" title="æŸ¥æ‰¾èŠ‚ç‚¹ofå‡½æ•°"></a>æŸ¥æ‰¾èŠ‚ç‚¹ofå‡½æ•°</h3><p>1ã€é€šè¿‡èŠ‚ç‚¹åå­—æŸ¥æ‰¾æŒ‡å®šèŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_find_node_by_name</span><span class="params">(<span class="keyword">struct</span> device_node *from, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line"><span class="comment">//fromå¼€å§‹æŸ¥æ‰¾çš„èŠ‚ç‚¹ </span></span><br><span class="line"><span class="comment">//nameè¦æŸ¥æ‰¾çš„èŠ‚ç‚¹åå­—è¿”å›æ‰¾åˆ°çš„èŠ‚ç‚¹ï¼ŒNULLè¡¨ç¤ºå¤±è´¥</span></span><br></pre></td></tr></table></figure><p>2ã€é€šè¿‡device_typeå±æ€§æŸ¥æ‰¾æŒ‡å®šçš„èŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_find_node_by_type</span><span class="params">(<span class="keyword">struct</span> device_node *from, <span class="type">const</span> <span class="type">char</span> *type)</span></span><br><span class="line"><span class="comment">//fromå¼€å§‹æŸ¥æ‰¾çš„èŠ‚ç‚¹ï¼ŒNULLè¡¨ç¤ºä»æ ¹èŠ‚ç‚¹æŸ¥æ‰¾æ•´ä¸ªè®¾å¤‡æ ‘ </span></span><br><span class="line"><span class="comment">//typeè¦æŸ¥æ‰¾çš„èŠ‚ç‚¹å¯¹åº”çš„typeå­—ç¬¦ä¸²ï¼Œ</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ä¸ºæ‰¾åˆ°çš„èŠ‚ç‚¹ï¼ŒNULLå¤±è´¥</span></span><br></pre></td></tr></table></figure><p>3ã€æ ¹æ®device_typeå’Œcompatibleä¸¤ä¸ªå±æ€§æŸ¥æ‰¾æŒ‡å®šçš„èŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_find_compatible_node</span><span class="params">(<span class="keyword">struct</span> device_node *from,<span class="type">const</span> <span class="type">char</span> *type, <span class="type">const</span> <span class="type">char</span> *compatible)</span></span><br><span class="line"><span class="comment">//from å¼€å§‹æŸ¥æ‰¾çš„èŠ‚ç‚¹NULLè¡¨ç¤ºä»æ ¹èŠ‚ç‚¹æŸ¥æ‰¾æ•´ä¸ªè®¾å¤‡æ ‘</span></span><br><span class="line"><span class="comment">//type è¦æŸ¥æ‰¾çš„èŠ‚ç‚¹å¯¹åº”çš„typeå­—ç¬¦ä¸²ï¼ˆdevice_typeå±æ€§å€¼ï¼‰ï¼ŒNULLè¡¨ç¤ºå¿½ç•¥device_typeå±æ€§</span></span><br><span class="line"><span class="comment">//compatible è¦æŸ¥æ‰¾çš„èŠ‚ç‚¹æ‰€å¯¹åº”çš„compatibleå±æ€§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š æ‰¾åˆ°çš„èŠ‚ç‚¹ï¼Œå¦‚æœä¸º NULL è¡¨ç¤ºæŸ¥æ‰¾å¤±è´¥</span></span><br></pre></td></tr></table></figure><p>4ã€é€šè¿‡of_device_idåŒ¹é…è¡¨æ¥æŸ¥æ‰¾èŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_find_matching_node_and_match</span><span class="params">(<span class="keyword">struct</span> device_node *from, </span></span><br><span class="line"><span class="params">                                                    <span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches,</span></span><br><span class="line"><span class="params">                                                    <span class="type">const</span> <span class="keyword">struct</span> of_device_id **match)</span></span><br><span class="line"><span class="comment">//fromå¼€å§‹æŸ¥æ‰¾çš„èŠ‚ç‚¹ï¼ŒNULLä»£è¡¨ä»æ ¹èŠ‚ç‚¹æŸ¥æ‰¾æ•´ä¸ªè®¾å¤‡æ ‘</span></span><br><span class="line"><span class="comment">//matches of_device_idåŒ¹é…è¡¨ï¼Œåœ¨åŒ¹é…è¡¨é‡ŒæŸ¥æ‰¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//match æ‰¾åˆ°çš„åŒ¹é…çš„of_device_id</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šæ‰¾åˆ°çš„èŠ‚ç‚¹ï¼ŒNULLè¡¨ç¤ºå¤±è´¥ï¼Œ</span></span><br></pre></td></tr></table></figure><p>5ã€é€šè¿‡è·¯å¾„æ¥æŸ¥æ‰¾æŒ‡å®šçš„èŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">struct</span> device_node *<span class="title function_">of_find_node_by_path</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span></span><br><span class="line"><span class="comment">//path:å¸¦æœ‰å…¨è·¯å¾„çš„èŠ‚ç‚¹å</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼æ‰¾åˆ°çš„èŠ‚ç‚¹ï¼ŒNULLè¡¨ç¤ºå¤±è´¥</span></span><br></pre></td></tr></table></figure><h4 id="æŸ¥æ‰¾çˆ¶-x2F-å­èŠ‚ç‚¹çš„ofå‡½æ•°"><a href="#æŸ¥æ‰¾çˆ¶-x2F-å­èŠ‚ç‚¹çš„ofå‡½æ•°" class="headerlink" title="æŸ¥æ‰¾çˆ¶&#x2F;å­èŠ‚ç‚¹çš„ofå‡½æ•°"></a>æŸ¥æ‰¾çˆ¶&#x2F;å­èŠ‚ç‚¹çš„ofå‡½æ•°</h4><p>1ã€è·å–æŒ‡å®šèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_get_parent</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *node)</span></span><br><span class="line"><span class="comment">//nodeï¼šè¦æŸ¥æ‰¾çš„çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š æ‰¾åˆ°çš„çˆ¶èŠ‚ç‚¹ã€‚</span></span><br></pre></td></tr></table></figure><p>2ã€ç”¨è¿­ä»£æ–¹å¼æŸ¥æ‰¾å­èŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_get_next_child</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *node , <span class="keyword">struct</span> device_node *prev)</span></span><br><span class="line"><span class="comment">//nodeçˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//prevå‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä»å“ªä¸€ä¸ªå­èŠ‚ç‚¹å¼€å§‹è¿­ä»£çš„æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹ã€‚å¯ä»¥è®¾ç½®ä¸ºNULLï¼Œè¡¨ç¤ºä»ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹å¼€å§‹ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š æ‰¾åˆ°çš„ä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="æå–å±æ€§å€¼çš„ofå‡½æ•°"><a href="#æå–å±æ€§å€¼çš„ofå‡½æ•°" class="headerlink" title="æå–å±æ€§å€¼çš„ofå‡½æ•°"></a>æå–å±æ€§å€¼çš„ofå‡½æ•°</h3><p>èŠ‚ç‚¹çš„å±æ€§ä¿¡æ¯é‡Œé¢ä¿å­˜äº†é©±åŠ¨æ‰€éœ€è¦çš„å†…å®¹ï¼Œå› æ­¤å¯¹äºå±æ€§å€¼çš„æå–éå¸¸é‡è¦ï¼Œ Linux å†…æ ¸ä¸­ä½¿ç”¨ç»“æ„ä½“ property è¡¨ç¤ºå±æ€§ï¼Œæ­¤ç»“æ„ä½“åŒæ ·å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;of.h ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property</span> &#123;</span></span><br><span class="line"><span class="type">char</span> *name; <span class="comment">/* å±æ€§åå­— */</span></span><br><span class="line"><span class="type">int</span> length; <span class="comment">/* å±æ€§é•¿åº¦ */</span></span><br><span class="line"><span class="type">void</span> *value; <span class="comment">/* å±æ€§å€¼ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">next</span>;</span> <span class="comment">/* ä¸‹ä¸€ä¸ªå±æ€§ */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> _flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> unique_id;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin_attribute</span> <span class="title">attr</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>1ã€ç”¨äºæŸ¥æ‰¾æŒ‡å®šçš„å±æ€§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">property *<span class="title function_">of_find_property</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> *lenp)</span></span><br><span class="line"><span class="comment">//np è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//name å±æ€§åå­—</span></span><br><span class="line"><span class="comment">//lenp å±æ€§å€¼çš„å­—èŠ‚æ ‘</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼æ‰¾åˆ°çš„å±æ€§</span></span><br></pre></td></tr></table></figure><p>2ã€ç”¨äºè·å–å±æ€§ä¸­å…ƒç´ çš„æ•°é‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_count_elems_of_size</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,<span class="type">const</span> <span class="type">char</span> *propnameï¼Œ<span class="type">int</span> elem_size)</span></span><br><span class="line"><span class="comment">//npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//pronameï¼š éœ€è¦ç»Ÿè®¡å…ƒç´ æ•°é‡çš„å±æ€§åå­—ã€‚</span></span><br><span class="line"><span class="comment">//elem_sizeï¼šå…ƒç´ é•¿åº¦ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š å¾—åˆ°çš„å±æ€§å…ƒç´ æ•°é‡</span></span><br></pre></td></tr></table></figure><p>3ã€ç”¨äºä»å±æ€§ä¸­è·å–æŒ‡å®šæ ‡å·çš„ u32 ç±»å‹æ•°æ®å€¼ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u32_index</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params">                               <span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params">                               u32 index,</span></span><br><span class="line"><span class="params">                               u32 *out_value               )</span></span><br><span class="line"><span class="comment">//npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//pronameï¼š è¦è¯»å–çš„å±æ€§åå­—ã€‚</span></span><br><span class="line"><span class="comment">//indexï¼šè¦è¯»å–çš„å€¼æ ‡å·ã€‚</span></span><br><span class="line"><span class="comment">//out_valueï¼šè¯»å–åˆ°çš„å€¼</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0 è¯»å–æˆåŠŸï¼Œè´Ÿå€¼ï¼Œè¯»å–å¤±è´¥ï¼Œ -EINVAL è¡¨ç¤ºå±æ€§ä¸å­˜åœ¨ï¼Œ -ENODATA è¡¨ç¤ºæ²¡æœ‰è¦è¯»å–çš„æ•°æ®ï¼Œ -EOVERFLOW è¡¨ç¤ºå±æ€§å€¼åˆ—è¡¨å¤ªå°ã€‚</span></span><br></pre></td></tr></table></figure><p>4ã€è¯»å–å±æ€§ä¸­ u8ã€ u16ã€ u32 å’Œ u64 ç±»å‹çš„æ•°ç»„æ•°æ® </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u8_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params">u8 *out_values,</span></span><br><span class="line"><span class="params"><span class="type">size_t</span> sz)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u16_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params">  u16 *out_values,</span></span><br><span class="line"><span class="params"> <span class="type">size_t</span> sz)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u32_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params"> u32 *out_values,</span></span><br><span class="line"><span class="params"> <span class="type">size_t</span> sz)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u64_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params"> u64 *out_values,</span></span><br><span class="line"><span class="params"> <span class="type">size_t</span> sz)</span></span><br><span class="line"><span class="comment">//npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//pronameï¼š è¦è¯»å–çš„å±æ€§åå­—ã€‚</span></span><br><span class="line"><span class="comment">//out_valueï¼šè¯»å–åˆ°çš„æ•°ç»„å€¼ï¼Œåˆ†åˆ«ä¸º u8ã€ u16ã€ u32 å’Œ u64ã€‚</span></span><br><span class="line"><span class="comment">//szï¼š è¦è¯»å–çš„æ•°ç»„å…ƒç´ æ•°é‡ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0ï¼Œè¯»å–æˆåŠŸï¼Œè´Ÿå€¼ï¼Œè¯»å–å¤±è´¥ï¼Œ -EINVAL è¡¨ç¤ºå±æ€§ä¸å­˜åœ¨ï¼Œ -ENODATA è¡¨ç¤ºæ²¡æœ‰è¦è¯»å–çš„æ•°æ®ï¼Œ -EOVERFLOW è¡¨ç¤ºå±æ€§å€¼åˆ—è¡¨å¤ªå°ã€‚</span></span><br></pre></td></tr></table></figure><p>5ã€ç”¨äºè¯»å–è¿™ç§åªæœ‰ä¸€ä¸ªæ•´å½¢å€¼çš„å±æ€§ï¼Œåˆ†åˆ«ç”¨äºè¯»å– u8ã€ u16ã€ u32 å’Œ u64 ç±»å‹å±æ€§å€¼ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u8</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params">u8 *out_value)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u16</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params">u16 *out_value)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u32</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params">  u32 *out_value)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u64</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *propname,</span></span><br><span class="line"><span class="params"> u64 *out_value)</span></span><br><span class="line"><span class="comment">//npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//pronameï¼š è¦è¯»å–çš„å±æ€§åå­—ã€‚</span></span><br><span class="line"><span class="comment">//out_valueï¼šè¯»å–åˆ°çš„æ•°ç»„å€¼ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0ï¼Œè¯»å–æˆåŠŸï¼Œè´Ÿå€¼ï¼Œè¯»å–å¤±è´¥ï¼Œ -EINVAL è¡¨ç¤ºå±æ€§ä¸å­˜åœ¨ï¼Œ -ENODATA è¡¨ç¤ºæ²¡æœ‰è¦è¯»å–çš„æ•°æ®ï¼Œ -EOVERFLOW è¡¨ç¤ºå±æ€§å€¼åˆ—è¡¨å¤ªå°ã€‚</span></span><br></pre></td></tr></table></figure><p>6ã€ç”¨äºè¯»å–å±æ€§ä¸­å­—ç¬¦ä¸²å€¼ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_string</span><span class="params">(<span class="keyword">struct</span> device_node *np,<span class="type">const</span> <span class="type">char</span> *propname,<span class="type">const</span> <span class="type">char</span> **out_string)</span></span><br><span class="line"><span class="comment">//npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//pronameï¼š è¦è¯»å–çš„å±æ€§åå­—ã€‚</span></span><br><span class="line"><span class="comment">//out_stringï¼šè¯»å–åˆ°çš„å­—ç¬¦ä¸²å€¼ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0ï¼Œè¯»å–æˆåŠŸï¼Œè´Ÿå€¼ï¼Œè¯»å–å¤±è´¥ã€‚</span></span><br></pre></td></tr></table></figure><p>7ã€ç”¨äºè·å–#address-cells å±æ€§å€¼ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_n_addr_cells</span><span class="params">(<span class="keyword">struct</span> device_node *np)</span></span><br><span class="line"><span class="comment">//npï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š è·å–åˆ°çš„#address-cells å±æ€§å€¼ã€‚</span></span><br></pre></td></tr></table></figure><p>8ã€ç”¨äºè·å–#size-cells å±æ€§å€¼ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_n_size_cells</span><span class="params">(<span class="keyword">struct</span> device_node *np)</span></span><br><span class="line"><span class="comment">//np è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//è·å–åˆ°çš„size-cells</span></span><br></pre></td></tr></table></figure><h4 id="å…¶ä»–å¸¸ç”¨çš„-OF-å‡½æ•°"><a href="#å…¶ä»–å¸¸ç”¨çš„-OF-å‡½æ•°" class="headerlink" title="å…¶ä»–å¸¸ç”¨çš„ OF å‡½æ•°"></a>å…¶ä»–å¸¸ç”¨çš„ OF å‡½æ•°</h4><p>1ã€æŸ¥çœ‹èŠ‚ç‚¹çš„compatibleå±æ€§æ˜¯å¦åŒ…å«compatæŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥è®¾å¤‡èŠ‚ç‚¹çš„å…¼å®¹æ€§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_device_is_compatible</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *device,<span class="type">const</span> <span class="type">char</span> *compat)</span></span><br><span class="line"><span class="comment">//deviceï¼šè®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//compatï¼šè¦æŸ¥çœ‹çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0ï¼ŒèŠ‚ç‚¹çš„ compatible å±æ€§ä¸­ä¸åŒ…å« compat æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼› æ­£æ•°ï¼ŒèŠ‚ç‚¹çš„ compatibleå±æ€§ä¸­åŒ…å« compat æŒ‡å®šçš„å­—ç¬¦ä¸²ã€‚</span></span><br></pre></td></tr></table></figure><p>2ã€ç”¨äºè·å–åœ°å€ç›¸å…³å±æ€§ï¼Œä¸»è¦æ˜¯regå’Œassigned-addresså±æ€§å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> __be32 *<span class="title function_">of_get_address</span><span class="params">(<span class="keyword">struct</span> device_node *dev,<span class="type">int</span> index,u64 *size,<span class="type">unsigned</span> <span class="type">int</span> *flags)</span></span><br><span class="line"><span class="comment">//devè®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//indexï¼šè¦è¯»å–çš„åœ°å€æ ‡å·ã€‚</span></span><br><span class="line"><span class="comment">//sizeï¼šåœ°å€é•¿åº¦ã€‚</span></span><br><span class="line"><span class="comment">//flagsï¼šå‚æ•°ï¼Œæ¯”å¦‚ IORESOURCE_IOã€ IORESOURCE_MEM ç­‰</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š è¯»å–åˆ°çš„åœ°å€æ•°æ®é¦–åœ°å€ï¼Œä¸º NULL çš„è¯è¡¨ç¤ºè¯»å–å¤±è´¥ã€‚</span></span><br></pre></td></tr></table></figure><p>3ã€è´Ÿè´£å°†ä»è®¾å¤‡æ ‘è¯»å–åˆ°çš„åœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">u64 <span class="title function_">of_translate_address</span><span class="params">(<span class="keyword">struct</span> device_node *devï¼Œconst__be32*in_addr)</span></span><br><span class="line"><span class="comment">//devï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//in_addrï¼šè¦è½¬æ¢çš„åœ°å€ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š å¾—åˆ°çš„ç‰©ç†åœ°å€ï¼Œå¦‚æœä¸º OF_BAD_ADDR çš„è¯è¡¨ç¤ºè½¬æ¢å¤±è´¥</span></span><br></pre></td></tr></table></figure><p>4ã€IICã€ SPIã€ GPIO ç­‰è¿™äº›å¤–è®¾éƒ½æœ‰å¯¹åº”çš„å¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨å…¶å®å°±æ˜¯ä¸€ç»„å†…å­˜ç©ºé—´ï¼Œ Linuxå†…æ ¸ä½¿ç”¨ resource ç»“æ„ä½“æ¥æè¿°ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œâ€œresourceâ€ç¿»è¯‘å‡ºæ¥å°±æ˜¯â€œèµ„æºâ€ï¼Œå› æ­¤ç”¨ resourceç»“æ„ä½“æè¿°çš„éƒ½æ˜¯è®¾å¤‡èµ„æºä¿¡æ¯ï¼Œ resource ç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;ioport.h ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">resource</span> &#123;</span></span><br><span class="line"><span class="type">resource_size_t</span> start;</span><br><span class="line"><span class="type">resource_size_t</span> end;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">parent</span>, *<span class="title">sibling</span>, *<span class="title">child</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äº 32 ä½çš„ SOC æ¥è¯´ï¼Œ resource_size_t æ˜¯ u32 ç±»å‹çš„ã€‚å…¶ä¸­ start è¡¨ç¤ºå¼€å§‹åœ°å€ï¼Œ end è¡¨ç¤ºç»“æŸåœ°å€ï¼Œ name æ˜¯è¿™ä¸ªèµ„æºçš„åå­—ï¼Œ flags æ˜¯èµ„æºæ ‡å¿—ä½ï¼Œä¸€èˆ¬è¡¨ç¤ºèµ„æºç±»å‹ï¼Œå¯é€‰çš„èµ„æºæ ‡å¿—å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;ioport.h ä¸­ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_BITS 0x000000ff</span></span><br><span class="line"><span class="number">2</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_TYPE_BITS 0x00001f00</span></span><br><span class="line"><span class="number">3</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_IO 0x00000100</span></span><br><span class="line"><span class="number">4</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_MEM 0x00000200</span></span><br><span class="line"><span class="number">5</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_REG 0x00000300</span></span><br><span class="line"><span class="number">6</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_IRQ 0x00000400</span></span><br><span class="line"><span class="number">7</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_DMA 0x00000800</span></span><br><span class="line"><span class="number">8</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_BUS 0x00001000</span></span><br><span class="line"><span class="number">9</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_PREFETCH 0x00002000</span></span><br><span class="line"><span class="number">10</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_READONLY 0x00004000</span></span><br><span class="line"><span class="number">11</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_CACHEABLE 0x00008000</span></span><br><span class="line"><span class="number">12</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_RANGELENGTH 0x00010000</span></span><br><span class="line"><span class="number">13</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_SHADOWABLE 0x00020000</span></span><br><span class="line"><span class="number">14</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_SIZEALIGN 0x00040000</span></span><br><span class="line"><span class="number">15</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_STARTALIGN 0x00080000</span></span><br><span class="line"><span class="number">16</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_MEM_64 0x00100000</span></span><br><span class="line"><span class="number">17</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_WINDOW 0x00200000</span></span><br><span class="line"><span class="number">18</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_MUXED 0x00400000</span></span><br><span class="line"><span class="number">19</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_EXCLUSIVE 0x08000000</span></span><br><span class="line"><span class="number">20</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_DISABLED 0x10000000</span></span><br><span class="line"><span class="number">21</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_UNSET 0x20000000</span></span><br><span class="line"><span class="number">22</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_AUTO 0x40000000</span></span><br><span class="line"><span class="number">23</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_BUSY 0x80000000</span></span><br></pre></td></tr></table></figure><p>å°† reg å±æ€§å€¼ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸º resource ç»“æ„ä½“ç±»å‹ï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_address_to_resource</span><span class="params">(<span class="keyword">struct</span> device_node *dev,<span class="type">int</span> index,<span class="keyword">struct</span> resource *r)</span></span><br><span class="line"><span class="comment">//devï¼šè®¾å¤‡èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//indexï¼šåœ°å€èµ„æºæ ‡å·ã€‚</span></span><br><span class="line"><span class="comment">//rï¼šå¾—åˆ°çš„ resource ç±»å‹çš„èµ„æºå€¼ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼š 0ï¼ŒæˆåŠŸï¼›è´Ÿå€¼ï¼Œå¤±è´¥</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxè®¾å¤‡æ ‘</title>
      <link href="/2023/04/08/2023-4-8-linux%E8%AE%BE%E5%A4%87%E6%A0%91/"/>
      <url>/2023/04/08/2023-4-8-linux%E8%AE%BE%E5%A4%87%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<h3 id="è®¾å¤‡æ ‘å®šä¹‰"><a href="#è®¾å¤‡æ ‘å®šä¹‰" class="headerlink" title="è®¾å¤‡æ ‘å®šä¹‰"></a>è®¾å¤‡æ ‘å®šä¹‰</h3><p>è®¾å¤‡æ ‘ï¼ˆDevice treeï¼‰ï¼Œæè¿°è®¾å¤‡æ ‘çš„æ–‡ä»¶å«åšDTSï¼ˆTree Sourceï¼‰ï¼Œè¿™ä¸ªDTSé‡‡ç”¨æ ‘å½¢ç»“æ„æè¿°æ¿çº§è®¾å¤‡ï¼ˆå¼€å‘æ¿ä¸Šçš„è®¾å¤‡ä¿¡æ¯ï¼‰ã€‚æ ‘çš„ä¸»å¹²å°±æ˜¯ç³»ç»Ÿæ€»çº¿ï¼Œ IIC æ§åˆ¶å™¨ã€ GPIO æ§åˆ¶å™¨ã€ SPI æ§åˆ¶å™¨ç­‰éƒ½æ˜¯æ¥åˆ°ç³»ç»Ÿä¸»çº¿ä¸Šçš„åˆ†æ”¯ã€‚ </p><p>è®¾å¤‡æ ‘æºæ–‡ä»¶æ‰©å±•åä¸º.dtsï¼Œ DTS æ˜¯è®¾å¤‡æ ‘æºç æ–‡ä»¶ï¼Œ DTB æ˜¯å°†DTS ç¼–è¯‘ä»¥åå¾—åˆ°çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å°†.c æ–‡ä»¶ç¼–è¯‘ä¸º.o éœ€è¦ç”¨åˆ° gcc ç¼–è¯‘å™¨ï¼Œé‚£ä¹ˆå°†.dts ç¼–è¯‘ä¸º.dtbéœ€è¦ä»€ä¹ˆå·¥å…·å‘¢ï¼Ÿéœ€è¦ç”¨åˆ° DTC å·¥å…·ï¼ </p><h3 id="DTSè¯­æ³•"><a href="#DTSè¯­æ³•" class="headerlink" title="DTSè¯­æ³•"></a>DTSè¯­æ³•</h3><p>è®¾å¤‡æ ‘ä¹Ÿæ”¯æŒå¤´æ–‡ä»¶ï¼Œè®¾å¤‡æ ‘çš„å¤´æ–‡ä»¶æ‰©å±•åä¸º.dtsiã€‚ä¾‹å¦‚ï¼šåœ¨imx6ull-14x14-evk.dtsä¸­æœ‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ulll-14x14-evk.dsti&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡ç‚¹"><a href="#è®¾å¤‡ç‚¹" class="headerlink" title="è®¾å¤‡ç‚¹"></a>è®¾å¤‡ç‚¹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ç¤ºä¾‹ä»£ç  <span class="number">43.3</span><span class="number">.2</span><span class="number">.1</span> è®¾å¤‡æ ‘æ¨¡æ¿</span><br><span class="line"><span class="number">1</span> / &#123;</span><br><span class="line"><span class="number">2</span> aliases &#123;</span><br><span class="line"><span class="number">3</span> can0 = &amp;flexcan1;</span><br><span class="line"><span class="number">4</span> &#125;;</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span> cpus &#123;</span><br><span class="line"><span class="number">7</span> <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">8</span> <span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span> cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">11</span> compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">12</span> device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line"><span class="number">13</span> reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">14</span> &#125;;</span><br><span class="line"><span class="number">15</span> &#125;;</span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span> intc: interrupt-controller@<span class="number">00</span>a01000 &#123;</span><br><span class="line"><span class="number">18</span> compatible = <span class="string">&quot;arm,cortex-a7-gic&quot;</span>;</span><br><span class="line"><span class="number">19</span> <span class="meta">#interrupt-cells = <span class="string">&lt;3&gt;</span>;</span></span><br><span class="line"><span class="number">20</span> interrupt-controller;</span><br><span class="line"><span class="number">21</span> reg = &lt;<span class="number">0x00a01000</span> <span class="number">0x1000</span>&gt;,</span><br><span class="line"><span class="number">22</span> &lt;<span class="number">0x00a02000</span> <span class="number">0x100</span>&gt;;</span><br><span class="line"><span class="number">23</span> &#125;;</span><br><span class="line"><span class="number">24</span> &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 2ã€6 å’Œ 17 è¡Œï¼Œaliasesã€cpus å’Œ intc æ˜¯ä¸‰ä¸ªå­èŠ‚ç‚¹ï¼Œåœ¨è®¾å¤‡æ ‘ä¸­èŠ‚ç‚¹å‘½åæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node-name@unit-address</span><br></pre></td></tr></table></figure><p>å…¶ä¸­â€œnode-nameâ€æ˜¯èŠ‚ç‚¹åå­—ï¼Œä¸º ASCII å­—ç¬¦ä¸²ï¼ŒèŠ‚ç‚¹åå­—åº”è¯¥èƒ½å¤Ÿæ¸…æ™°çš„æè¿°å‡ºèŠ‚ç‚¹çš„åŠŸèƒ½ï¼Œæ¯”å¦‚â€œuart1â€å°±è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹æ˜¯ UART1 å¤–è®¾ã€‚â€œunit-addressâ€ä¸€èˆ¬è¡¨ç¤ºè®¾å¤‡çš„åœ°å€æˆ–å¯„å­˜å™¨é¦–åœ°å€ï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹æ²¡æœ‰åœ°å€æˆ–è€…å¯„å­˜å™¨çš„è¯â€œunit-addressâ€å¯ä»¥ä¸è¦ï¼Œæ¯”å¦‚â€œcpu@0â€ã€â€œinterrupt-controller@00a01000â€ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬åœ¨ç¤ºä¾‹ä»£ç  43.3.2.1 ä¸­æˆ‘ä»¬çœ‹åˆ°çš„èŠ‚ç‚¹å‘½åå´å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpu0:cpu@0</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å‘½ä»¤å¹¶ä¸æ˜¯â€œnode-name@unit-addressâ€è¿™æ ·çš„æ ¼å¼ï¼Œè€Œæ˜¯ç”¨â€œï¼šâ€éš”å¼€æˆäº†ä¸¤éƒ¨åˆ†ï¼Œâ€œï¼šâ€<br>å‰é¢çš„æ˜¯èŠ‚ç‚¹æ ‡ç­¾(label)ï¼Œâ€œï¼šâ€åé¢çš„æ‰æ˜¯èŠ‚ç‚¹åå­—ï¼Œæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label: node-name@unit-address</span><br></pre></td></tr></table></figure><h4 id="è®¾å¤‡èŠ‚ç‚¹"><a href="#è®¾å¤‡èŠ‚ç‚¹" class="headerlink" title="è®¾å¤‡èŠ‚ç‚¹"></a>è®¾å¤‡èŠ‚ç‚¹</h4><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-07%20201941.png"></p><p>è®¾å¤‡æ ‘æºç ä¸­å¸¸ç”¨çš„å‡ ç§æ•°æ®å½¢å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>â‘ ã€å­—ç¬¦ä¸²</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compatible = &quot;arm,cortex-a7&quot;;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è®¾ç½® compatible å±æ€§çš„å€¼ä¸ºå­—ç¬¦ä¸²â€œarm,cortex-a7â€ã€‚<br>â‘¡ã€32 ä½æ— ç¬¦å·æ•´æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg = &lt;0&gt;;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è®¾ç½® reg å±æ€§çš„å€¼ä¸º 0ï¼Œreg çš„å€¼ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºä¸€ç»„å€¼ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg = &lt;0 0x123456 100&gt;;</span><br></pre></td></tr></table></figure><p>â‘¢ã€å­—ç¬¦ä¸²åˆ—è¡¨<br>å±æ€§å€¼ä¹Ÿå¯ä»¥ä¸ºå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå­—ç¬¦ä¸²å’Œå­—ç¬¦ä¸²ä¹‹é—´é‡‡ç”¨â€œ,â€éš”å¼€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compatible = &quot;fsl,imx6ull-gpmi-nand&quot;, &quot;fsl, imx6ul-gpmi-nand&quot;;</span><br></pre></td></tr></table></figure><h4 id="æ ‡å‡†å±æ€§"><a href="#æ ‡å‡†å±æ€§" class="headerlink" title="æ ‡å‡†å±æ€§"></a>æ ‡å‡†å±æ€§</h4><p>èŠ‚ç‚¹æ˜¯ç”±ä¸€å †çš„å±æ€§ç»„æˆï¼ŒèŠ‚ç‚¹éƒ½æ˜¯å…·ä½“çš„è®¾å¤‡ï¼Œä¸åŒçš„è®¾å¤‡éœ€è¦çš„å±æ€§ä¸åŒï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰å±æ€§ã€‚é™¤äº†ç”¨æˆ·è‡ªå®šä¹‰å±æ€§ï¼Œæœ‰å¾ˆå¤šå±æ€§æ˜¯æ ‡å‡†å±æ€§ï¼Œ Linux ä¸‹çš„å¾ˆå¤šå¤–è®¾é©±åŠ¨éƒ½ä¼šä½¿ç”¨è¿™äº›æ ‡å‡†å±æ€§ã€‚</p><p><strong>1ã€compatibleå±æ€§</strong></p><p>compatible å±æ€§ä¹Ÿå«åšâ€œå…¼å®¹æ€§â€å±æ€§ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªå±æ€§ï¼ compatible å±æ€§çš„å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œ compatible å±æ€§ç”¨äºå°†è®¾å¤‡å’Œé©±åŠ¨ç»‘å®šèµ·æ¥ã€‚å­—ç¬¦ä¸²åˆ—è¡¨ç”¨äºé€‰æ‹©è®¾å¤‡æ‰€è¦ä½¿ç”¨çš„é©±åŠ¨ç¨‹åºï¼Œ compatible å±æ€§çš„å€¼æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;manufacturer,model&quot;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ manufacturer è¡¨ç¤ºå‚å•†ï¼Œ model ä¸€èˆ¬æ˜¯æ¨¡å—å¯¹åº”çš„é©±åŠ¨åå­—ã€‚ </p><p>I.MX6U-ALPHA å¼€å‘æ¿ä¸Šçš„éŸ³é¢‘èŠ¯ç‰‡é‡‡ç”¨çš„æ¬§èƒœ(WOLFSON)å‡ºå“çš„ WM8960ï¼Œ sound èŠ‚ç‚¹çš„ compatible å±æ€§å€¼å¦‚ä¸‹ï¼š </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compatible = &quot;fsl,imx6ul-evk-wm8960&quot;,&quot;fsl,imx-audio-wm8960&quot;;</span><br></pre></td></tr></table></figure><p>å±æ€§å€¼æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«ä¸ºâ€œfsl,imx6ul-evk-wm8960â€å’Œâ€œfsl,imx-audio-wm8960â€ ,soundè¿™ä¸ªè®¾å¤‡é¦–å…ˆä½¿ç”¨ç¬¬ä¸€ä¸ªå…¼å®¹å€¼åœ¨ Linux å†…æ ¸é‡Œé¢æŸ¥æ‰¾ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°ä¸ä¹‹åŒ¹é…çš„é©±åŠ¨æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯å°±ä½¿ç”¨ç¬¬äºŒä¸ªå…¼å®¹å€¼æŸ¥ã€‚ </p><p><strong><u>ä¸€èˆ¬é©±åŠ¨ç¨‹åºæ–‡ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ª OF åŒ¹é…è¡¨ï¼Œæ­¤ OF åŒ¹é…è¡¨ä¿å­˜ç€ä¸€äº› compatible å€¼ï¼Œå¦‚æœè®¾å¤‡èŠ‚ç‚¹çš„compatible å±æ€§å€¼å’Œ OF åŒ¹é…è¡¨ä¸­çš„ä»»ä½•ä¸€ä¸ªå€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºè®¾å¤‡å¯ä»¥ä½¿ç”¨è¿™ä¸ªé©±åŠ¨ã€‚</u></strong> </p><p><strong>2ã€modelå±æ€§</strong></p><p>modelå±æ€§å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸€èˆ¬modelå±æ€§æè¿°è®¾å¤‡æ¨¡å—ä¿¡æ¯ï¼Œæ¯”å¦‚åå­—ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model = &quot;wm8960-audio&quot;;</span><br></pre></td></tr></table></figure><p><strong>3ã€statuså±æ€§</strong></p><p>status å±æ€§çœ‹åå­—å°±çŸ¥é“æ˜¯å’Œè®¾å¤‡çŠ¶æ€æœ‰å…³çš„ï¼Œ status å±æ€§å€¼ä¹Ÿæ˜¯å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²æ˜¯è®¾å¤‡çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¯é€‰çš„çŠ¶æ€å¦‚è¡¨ :</p><table><thead><tr><th align="center">å€¼</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="center">â€okeyâ€œ</td><td align="left">è¡¨æ˜è®¾å¤‡æ˜¯å¯æ“ä½œçš„ã€‚</td></tr><tr><td align="center">â€disabledâ€œ</td><td align="left">è¡¨æ˜è®¾å¤‡å½“å‰æ˜¯ä¸å¯æ“ä½œçš„ï¼Œä½†æ˜¯åœ¨æœªæ¥å¯ä»¥å˜ä¸ºå¯æ“ä½œçš„ï¼Œæ¯”å¦‚çƒ­æ’æ‹”è®¾å¤‡æ’å…¥ä»¥åã€‚å…·ä½“å«ä¹‰çœ‹è®¾å¤‡ç»‘å®šçš„æ–‡æ¡£ã€‚</td></tr><tr><td align="center">â€failâ€œ</td><td align="left">è¡¨æ˜è®¾å¤‡ä¸å¯æ“ä½œï¼Œè®¾å¤‡æ£€æµ‹åˆ°äº†ä¸€ç³»åˆ—çš„é”™è¯¯ï¼Œè€Œä¸”è®¾å¤‡ä¹Ÿä¸å¤§å¯èƒ½å˜å¾—æ“ä½œã€‚</td></tr><tr><td align="center">â€fail-sssâ€œ</td><td align="left">å«ä¹‰å’Œâ€œfailâ€ç›¸åŒï¼Œåé¢çš„ sss éƒ¨åˆ†æ˜¯æ£€æµ‹åˆ°çš„é”™è¯¯å†…å®¹ã€‚</td></tr></tbody></table><p><strong>4ã€#address-cellså’Œ#size-cellså±æ€§</strong></p><p>è¿™ä¸¤ä¸ªå±æ€§çš„å€¼éƒ½æ˜¯æ— ç¬¦å· 32 ä½æ•´å½¢ï¼Œ #address-cells å’Œ#size-cells è¿™ä¸¤ä¸ªå±æ€§å¯ä»¥ç”¨åœ¨ä»»ä½•æ‹¥æœ‰å­èŠ‚ç‚¹çš„è®¾å¤‡ä¸­ï¼Œç”¨äºæè¿°å­èŠ‚ç‚¹çš„åœ°å€ä¿¡æ¯ã€‚ #address-cells å±æ€§å€¼å†³å®šäº†å­èŠ‚ç‚¹ reg å±æ€§ä¸­åœ°å€ä¿¡æ¯æ‰€å ç”¨çš„å­—é•¿(32 ä½)ï¼Œ </p><p>#size-cells å±æ€§å€¼å†³å®šäº†å­èŠ‚ç‚¹ reg å±æ€§ä¸­é•¿åº¦ä¿¡æ¯æ‰€å çš„å­—é•¿(32 ä½)ã€‚ #address-cells å’Œ#size-cells è¡¨æ˜äº†å­èŠ‚ç‚¹åº”è¯¥å¦‚ä½•ç¼–å†™ reg å±æ€§å€¼ï¼Œä¸€èˆ¬ reg å±æ€§éƒ½æ˜¯å’Œåœ°å€æœ‰å…³çš„å†…å®¹ï¼Œå’Œåœ°å€ç›¸å…³çš„ä¿¡æ¯æœ‰ä¸¤ç§ï¼šèµ·å§‹åœ°å€å’Œåœ°å€é•¿åº¦ã€‚regæ ¼å¼ä¸€èˆ¬ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg = &lt;address1 length1 address2 length2 address3 length3â€¦â€¦&gt;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªâ€œaddress lengthâ€ç»„åˆè¡¨ç¤ºä¸€ä¸ªåœ°å€èŒƒå›´ï¼Œå…¶ä¸­ address æ˜¯èµ·å§‹åœ°å€ï¼Œ length æ˜¯åœ°å€é•¿åº¦ï¼Œ #address-cells è¡¨æ˜ address è¿™ä¸ªæ•°æ®æ‰€å ç”¨çš„å­—é•¿ï¼Œ #size-cells è¡¨æ˜ length è¿™ä¸ªæ•°æ®æ‰€å ç”¨çš„å­—é•¿ </p><p><strong>5ã€regå±æ€§</strong></p><p>reg å±æ€§çš„å€¼ä¸€èˆ¬æ˜¯(addressï¼Œ length)å¯¹ã€‚ reg å±æ€§ä¸€èˆ¬ç”¨äºæè¿°è®¾å¤‡åœ°å€ç©ºé—´èµ„æºä¿¡æ¯ï¼Œä¸€èˆ¬éƒ½æ˜¯æŸä¸ªå¤–è®¾çš„å¯„å­˜å™¨åœ°å€èŒƒå›´ä¿¡æ¯ã€‚</p><p><strong>6ã€ ranges å±æ€§</strong><br>rangeså±æ€§å€¼å¯ä»¥ä¸ºç©ºæˆ–è€…æŒ‰ç…§(child-bus-address,parent-bus-address,length)æ ¼å¼ç¼–å†™çš„æ•°å­—çŸ©é˜µï¼Œ ranges æ˜¯ä¸€ä¸ªåœ°å€æ˜ å°„&#x2F;è½¬æ¢è¡¨ï¼Œ ranges å±æ€§æ¯ä¸ªé¡¹ç›®ç”±å­åœ°å€ã€çˆ¶åœ°å€å’Œåœ°å€ç©ºé—´é•¿åº¦ã€‚<br>è¿™ä¸‰éƒ¨åˆ†ç»„æˆï¼š<br>    child-bus-addressï¼šå­æ€»çº¿åœ°å€ç©ºé—´çš„ç‰©ç†åœ°å€ï¼Œç”±çˆ¶èŠ‚ç‚¹çš„#address-cells ç¡®å®šæ­¤ç‰©ç†åœ°å€æ‰€å ç”¨çš„å­—é•¿ã€‚<br>    parent-bus-addressï¼š çˆ¶æ€»çº¿åœ°å€ç©ºé—´çš„ç‰©ç†åœ°å€ï¼ŒåŒæ ·ç”±çˆ¶èŠ‚ç‚¹çš„#address-cells ç¡®å®šæ­¤ç‰©ç†åœ°å€æ‰€å ç”¨çš„å­—é•¿ã€‚<br>    lengthï¼š å­åœ°å€ç©ºé—´çš„é•¿åº¦ï¼Œç”±çˆ¶èŠ‚ç‚¹çš„#size-cells ç¡®å®šæ­¤åœ°å€é•¿åº¦æ‰€å ç”¨çš„å­—é•¿ </p><p><strong>7ã€ name å±æ€§</strong><br>name å±æ€§å€¼ä¸ºå­—ç¬¦ä¸²ï¼Œ name å±æ€§ç”¨äºè®°å½•èŠ‚ç‚¹åå­—ï¼Œ name å±æ€§å·²ç»è¢«å¼ƒç”¨ï¼Œä¸æ¨èä½¿ç”¨name å±æ€§ï¼Œä¸€äº›è€çš„è®¾å¤‡æ ‘æ–‡ä»¶å¯èƒ½ä¼šä½¿ç”¨æ­¤å±æ€§ã€‚<br><strong>8ã€ device_type å±æ€§</strong><br>device_type å±æ€§å€¼ä¸ºå­—ç¬¦ä¸²ï¼Œ IEEE 1275 ä¼šç”¨åˆ°æ­¤å±æ€§ï¼Œç”¨äºæè¿°è®¾å¤‡çš„ FCodeï¼Œä½†æ˜¯è®¾å¤‡æ ‘æ²¡æœ‰ FCodeï¼Œæ‰€ä»¥æ­¤å±æ€§ä¹Ÿè¢«æŠ›å¼ƒäº†ã€‚<u>æ­¤å±æ€§åªèƒ½ç”¨äº cpu èŠ‚ç‚¹æˆ–è€… memory èŠ‚ç‚¹</u>ã€‚imx6ull.dtsi çš„ cpu0 èŠ‚ç‚¹ç”¨åˆ°äº†æ­¤å±æ€§ ã€‚</p><h4 id="æ ¹èŠ‚ç‚¹-compatible-å±æ€§"><a href="#æ ¹èŠ‚ç‚¹-compatible-å±æ€§" class="headerlink" title="æ ¹èŠ‚ç‚¹ compatible å±æ€§"></a>æ ¹èŠ‚ç‚¹ compatible å±æ€§</h4><p>è®¾å¤‡èŠ‚ç‚¹çš„ compatible å±æ€§å€¼æ˜¯ä¸ºäº†åŒ¹é… Linux å†…æ ¸ä¸­çš„é©±åŠ¨ç¨‹åºï¼Œé€šè¿‡æ ¹èŠ‚ç‚¹çš„ compatible å±æ€§å¯ä»¥çŸ¥é“æˆ‘ä»¬æ‰€ä½¿ç”¨çš„è®¾å¤‡ï¼Œä¸€èˆ¬ç¬¬<br>ä¸€ä¸ªå€¼æè¿°äº†æ‰€ä½¿ç”¨çš„ç¡¬ä»¶è®¾å¤‡åå­—ï¼Œç¬¬äºŒä¸ªå€¼æè¿°äº†è®¾å¤‡æ‰€ä½¿ç”¨çš„ SOCã€‚ <u>Linux å†…æ ¸ä¼šé€šè¿‡æ ¹èŠ‚ç‚¹çš„ compoatible å±æ€§æŸ¥çœ‹æ˜¯å¦æ”¯æŒæ­¤è®¾å¤‡ï¼Œå¦‚æœæ”¯æŒçš„è¯è®¾å¤‡å°±ä¼šå¯åŠ¨ Linux å†…æ ¸ã€‚</u> </p><p><strong>1ã€ä½¿ç”¨è®¾å¤‡æ ‘ä¹‹å‰çš„è®¾å¤‡åŒ¹é…æ–¹æ³•</strong></p><p>åœ¨æ²¡æœ‰ä½¿ç”¨è®¾å¤‡æ ‘ä»¥å‰ï¼Œ uboot ä¼šå‘ Linux å†…æ ¸ä¼ é€’ä¸€ä¸ªå«åš machine id çš„å€¼ï¼Œ machine idä¹Ÿå°±æ˜¯è®¾å¤‡ IDï¼Œå‘Šè¯‰ Linux å†…æ ¸è‡ªå·±æ˜¯ä¸ªä»€ä¹ˆè®¾å¤‡ï¼Œçœ‹çœ‹ Linux å†…æ ¸æ˜¯å¦æ”¯æŒã€‚ </p><p>uboot ä¼šç»™ Linux å†…æ ¸ä¼ é€’ machine id è¿™ä¸ªå‚æ•°ï¼Œ Linux å†…æ ¸ä¼šæ£€æŸ¥è¿™ä¸ª machine idï¼Œå…¶å®å°±æ˜¯å°† machine id ä¸MACH_TYPE_XXX å®è¿›è¡Œå¯¹æ¯”ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ç›¸ç­‰çš„ï¼Œå¦‚æœç›¸ç­‰çš„è¯å°±è¡¨ç¤º Linux å†…æ ¸æ”¯æŒè¿™ä¸ªè®¾å¤‡ï¼Œå¦‚æœä¸æ”¯æŒçš„è¯é‚£ä¹ˆè¿™ä¸ªè®¾å¤‡å°±æ²¡æ³•å¯åŠ¨ Linux å†…æ ¸ã€‚ </p><p><strong>2ã€ä½¿ç”¨è®¾å¤‡æ ‘ä»¥åçš„è®¾å¤‡åŒ¹é…æ–¹æ³•</strong></p><p>å½“ Linux å†… æ ¸ å¼• å…¥ è®¾ å¤‡ æ ‘ ä»¥ å å°± ä¸ å† ä½¿ ç”¨ MACHINE_START äº† ï¼Œ è€Œ æ˜¯ æ¢ ä¸º äº†DT_MACHINE_STARTã€‚ DT_MACHINE_START ä¹Ÿå®šä¹‰åœ¨æ–‡ä»¶ arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;mach&#x2F;arch.hé‡Œé¢ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DT_MACHINE_START(_name, _namestr) \</span></span><br><span class="line"><span class="meta">static const struct machine_desc __mach_desc_##_name \</span></span><br><span class="line"><span class="meta">__used \</span></span><br><span class="line"><span class="meta">__attribute__((__section__(<span class="string">&quot;.arch.info.init&quot;</span>))) = &#123; \</span></span><br><span class="line"><span class="meta">.nr = ~0, \</span></span><br><span class="line"><span class="meta">.name = _namestr,</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œ DT_MACHINE_START å’Œ MACHINE_START åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯.nr çš„è®¾ç½®ä¸åŒï¼Œåœ¨ DT_MACHINE_START é‡Œé¢ç›´æ¥å°†.nr è®¾ç½®ä¸º~0ã€‚è¯´æ˜å¼•å…¥è®¾å¤‡æ ‘ä»¥åä¸ä¼šå†æ ¹æ® machineid æ¥æ£€æŸ¥ Linux å†…æ ¸æ˜¯å¦æ”¯æŒæŸä¸ªè®¾å¤‡äº†ã€‚ </p><p>æ‰“å¼€æ–‡ä»¶ arch&#x2F;arm&#x2F;mach-imx&#x2F;mach-imx6ul.cï¼Œæœ‰å¦‚ä¸‹æ‰€ç¤ºå†…å®¹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">208</span> <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *imx6ul_dt_compat[] __initconst = &#123;</span><br><span class="line"><span class="number">209</span> <span class="string">&quot;fsl,imx6ul&quot;</span>,</span><br><span class="line"><span class="number">210</span> <span class="string">&quot;fsl,imx6ull&quot;</span>,</span><br><span class="line"><span class="number">211</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="number">212</span> &#125;;</span><br><span class="line"><span class="number">213</span></span><br><span class="line"><span class="number">214</span> DT_MACHINE_START(IMX6UL, <span class="string">&quot;Freescale i.MX6 Ultralite (Device Tree)&quot;</span>)</span><br><span class="line"><span class="number">215</span> .map_io = imx6ul_map_io,</span><br><span class="line"><span class="number">216</span> .init_irq = imx6ul_init_irq,</span><br><span class="line"><span class="number">217</span> .init_machine = imx6ul_init_machine,</span><br><span class="line"><span class="number">218</span> .init_late = imx6ul_init_late,</span><br><span class="line"><span class="number">219</span> .dt_compat = imx6ul_dt_compat,</span><br><span class="line"><span class="number">220</span> MACHINE_END</span><br></pre></td></tr></table></figure><p>machine_desc ç»“æ„ä½“ä¸­æœ‰ä¸ª.dt_compat æˆå‘˜å˜é‡ï¼Œæ­¤æˆå‘˜å˜é‡ä¿å­˜ç€æœ¬è®¾å¤‡å…¼å®¹å±æ€§ï¼Œè®¾ç½®.dt_compat &#x3D; imx6ul_dt_compatï¼Œ imx6ul_dt_compat è¡¨é‡Œé¢æœ‰â€fsl,imx6ulâ€å’Œâ€fsl,imx6ullâ€è¿™ä¸¤ä¸ªå…¼å®¹å€¼ã€‚åªè¦æŸä¸ªè®¾å¤‡(æ¿å­)æ ¹èŠ‚ç‚¹â€œ &#x2F;â€çš„ compatible å±æ€§å€¼ä¸imx6ul_dt_compat è¡¨ä¸­çš„ä»»ä½•ä¸€ä¸ªå€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±è¡¨ç¤º Linux å†…æ ¸æ”¯æŒæ­¤è®¾å¤‡ã€‚ </p><p>imx6ull-alientekemmc.dts ä¸­æ ¹èŠ‚ç‚¹çš„ compatible å±æ€§å€¼å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compatible = <span class="string">&quot;fsl,imx6ull-14x14-evk&quot;</span>, <span class="string">&quot;fsl,imx6ull&quot;</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­â€œfsl,imx6ullâ€ä¸ imx6ul_dt_compat ä¸­çš„â€œfsl,imx6ullâ€åŒ¹é…ï¼Œå› æ­¤ I.MX6U-ALPHA å¼€å‘æ¿å¯ä»¥æ­£å¸¸å¯åŠ¨ Linux å†…æ ¸ã€‚ </p><p>Linux å†…æ ¸è°ƒç”¨ start_kernel å‡½æ•°æ¥å¯åŠ¨å†…æ ¸ï¼Œ start_kernel å‡½æ•°ä¼šè°ƒç”¨setup_arch å‡½æ•°æ¥åŒ¹é… machine_descï¼Œ setup_arch å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ arch&#x2F;arm&#x2F;kernel&#x2F;setup.c ä¸­ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">913</span> <span class="type">void</span> __init <span class="title function_">setup_arch</span><span class="params">(<span class="type">char</span> **cmdline_p)</span></span><br><span class="line">914 &#123;</span><br><span class="line"><span class="number">915</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">machine_desc</span> *<span class="title">mdesc</span>;</span></span><br><span class="line"><span class="number">916</span></span><br><span class="line"><span class="number">917</span> setup_processor();</span><br><span class="line"><span class="number">918</span> mdesc = setup_machine_fdt(__atags_pointer);</span><br><span class="line"><span class="number">919</span> <span class="keyword">if</span> (!mdesc)</span><br><span class="line"><span class="number">920</span> mdesc = setup_machine_tags(__atags_pointer, __machine_arch_type);</span><br><span class="line"><span class="number">921</span> machine_desc = mdesc;</span><br><span class="line"><span class="number">922</span> machine_name = mdesc-&gt;name;</span><br><span class="line">......</span><br><span class="line"><span class="number">986</span> &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 918 è¡Œï¼Œè°ƒç”¨ setup_machine_fdt å‡½æ•°æ¥è·å–åŒ¹é…çš„ machine_descï¼Œå‚æ•°å°±æ˜¯ atags çš„é¦–åœ°å€ï¼Œä¹Ÿå°±æ˜¯ uboot ä¼ é€’ç»™ Linux å†…æ ¸çš„ dtb æ–‡ä»¶é¦–åœ°å€ï¼Œ setup_machine_fdt å‡½æ•°çš„è¿”å›å€¼å°±æ˜¯æ‰¾åˆ°çš„æœ€åŒ¹é…çš„ machine_descã€‚ </p><p>å‡½æ•° setup_machine_fdt å®šä¹‰åœ¨æ–‡ä»¶ arch&#x2F;arm&#x2F;kernel&#x2F;devtree.c ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">204</span> <span class="type">const</span> <span class="keyword">struct</span> machine_desc * __init <span class="title function_">setup_machine_fdt</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> dt_phys)</span></span><br><span class="line">205 &#123;</span><br><span class="line"><span class="number">206</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">machine_desc</span> *<span class="title">mdesc</span>, *<span class="title">mdesc_best</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">214</span></span><br><span class="line"><span class="number">215</span> <span class="keyword">if</span> (!dt_phys || !early_init_dt_verify(phys_to_virt(dt_phys)))</span><br><span class="line"><span class="number">216</span> <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">217</span></span><br><span class="line"><span class="number">218</span> mdesc = of_flat_dt_match_machine(mdesc_best,arch_get_next_mach);</span><br><span class="line"><span class="number">219</span></span><br><span class="line">......</span><br><span class="line"><span class="number">247</span> __machine_arch_type = mdesc-&gt;nr;</span><br><span class="line"><span class="number">248</span></span><br><span class="line"><span class="number">249</span> <span class="keyword">return</span> mdesc;</span><br><span class="line"><span class="number">250</span> &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 218 è¡Œï¼Œè°ƒç”¨å‡½æ•° of_flat_dt_match_machine æ¥è·å–åŒ¹é…çš„ machine_descï¼Œå‚æ•° mdesc_bestæ˜¯ é»˜ è®¤ çš„ machine_desc ï¼Œ å‚ æ•° arch_get_next_mach æ˜¯ ä¸ª å‡½ æ•° ï¼Œ æ­¤ å‡½ æ•° å®š ä¹‰ åœ¨ å®š ä¹‰ åœ¨arch&#x2F;arm&#x2F;kernel&#x2F;devtree.c æ–‡ä»¶ä¸­ã€‚æ‰¾åˆ°åŒ¹é…çš„ machine_desc çš„è¿‡ç¨‹å°±æ˜¯ç”¨è®¾å¤‡æ ‘æ ¹èŠ‚ç‚¹çš„compatible å±æ€§å€¼å’Œ Linux å†…æ ¸ä¸­ machine_desc ä¸‹.dt_compat çš„å€¼æ¯”è¾ƒï¼Œçœ‹çœ‹é‚£ä¸ªç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰çš„è¯å°±è¡¨ç¤ºæ‰¾åˆ°åŒ¹é…çš„ machine_descï¼Œ arch_get_next_mach å‡½æ•°çš„å·¥ä½œå°±æ˜¯è·å– Linux å†…æ ¸ä¸­ä¸‹ä¸€ä¸ª machine_desc ç»“æ„ä½“ã€‚ </p><p>æœ€åå†æ¥çœ‹ä¸€ä¸‹ of_flat_dt_match_machine å‡½æ•°ï¼Œæ­¤å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ drivers&#x2F;of&#x2F;fdt.c ä¸­ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">705</span> <span class="type">const</span> <span class="type">void</span> * __init <span class="title function_">of_flat_dt_match_machine</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *default_match,</span></span><br><span class="line"><span class="params"><span class="number">706</span> <span class="type">const</span> <span class="type">void</span> * (*get_next_compat)(<span class="type">const</span> <span class="type">char</span> * <span class="type">const</span>**))</span></span><br><span class="line">707 &#123;</span><br><span class="line"><span class="number">708</span> <span class="type">const</span> <span class="type">void</span> *data = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">709</span> <span class="type">const</span> <span class="type">void</span> *best_data = default_match;</span><br><span class="line"><span class="number">710</span> <span class="type">const</span> <span class="type">char</span> *<span class="type">const</span> *compat;</span><br><span class="line"><span class="number">711</span> <span class="type">unsigned</span> <span class="type">long</span> dt_root;</span><br><span class="line"><span class="number">712</span> <span class="type">unsigned</span> <span class="type">int</span> best_score = ~<span class="number">1</span>, score = <span class="number">0</span>;</span><br><span class="line"><span class="number">713</span></span><br><span class="line"><span class="number">714</span> dt_root = of_get_flat_dt_root();</span><br><span class="line"><span class="number">715</span> <span class="keyword">while</span> ((data = get_next_compat(&amp;compat))) &#123;</span><br><span class="line"><span class="number">716</span> score = of_flat_dt_match(dt_root, compat);</span><br><span class="line"><span class="number">717</span> <span class="keyword">if</span> (score &gt; <span class="number">0</span> &amp;&amp; score &lt; best_score) &#123;</span><br><span class="line"><span class="number">718</span> best_data = data;</span><br><span class="line"><span class="number">719</span> best_score = score;</span><br><span class="line"><span class="number">720</span> &#125;</span><br><span class="line"><span class="number">721</span> &#125;</span><br><span class="line">......</span><br><span class="line"><span class="number">739</span></span><br><span class="line"><span class="number">740</span> pr_info(<span class="string">&quot;Machine model: %s\n&quot;</span>, of_flat_dt_get_machine_name());</span><br><span class="line"><span class="number">741</span></span><br><span class="line"><span class="number">742</span> <span class="keyword">return</span> best_data;</span><br><span class="line"><span class="number">743</span> &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 714 è¡Œï¼Œé€šè¿‡å‡½æ•° of_get_flat_dt_root è·å–è®¾å¤‡æ ‘æ ¹èŠ‚ç‚¹ã€‚<br>ç¬¬ 715~720 è¡Œï¼Œæ­¤å¾ªç¯å°±æ˜¯æŸ¥æ‰¾åŒ¹é…çš„ machine_desc è¿‡ç¨‹ï¼Œç¬¬ 716 è¡Œçš„ of_flat_dt_match å‡½æ•°ä¼šå°†æ ¹èŠ‚ç‚¹ compatible å±æ€§çš„å€¼å’Œæ¯ä¸ª machine_desc ç»“æ„ä½“ä¸­. dt_compat çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œç›´è‡³æ‰¾åˆ°åŒ¹é…çš„é‚£ä¸ª machine_descã€‚ </p><p>Linux å†…æ ¸é€šè¿‡æ ¹èŠ‚ç‚¹ compatible å±æ€§æ‰¾åˆ°å¯¹åº”çš„è®¾å¤‡çš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹ å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-08%20105607.png"></p><h4 id="å‘èŠ‚ç‚¹è¿½åŠ æˆ–ä¿®æ”¹å†…å®¹"><a href="#å‘èŠ‚ç‚¹è¿½åŠ æˆ–ä¿®æ”¹å†…å®¹" class="headerlink" title="å‘èŠ‚ç‚¹è¿½åŠ æˆ–ä¿®æ”¹å†…å®¹"></a>å‘èŠ‚ç‚¹è¿½åŠ æˆ–ä¿®æ”¹å†…å®¹</h4><p>æ‰“å¼€imx6ull.dtsiæ–‡ä»¶è¿›è¡Œè¿½åŠ å†…å®¹ï¼Œå› ä¸ºimx6ull.dtsiæ˜¯è®¾å¤‡å¤´æ–‡ä»¶ï¼Œæ‰€æœ‰ä½¿ç”¨IMX6ULLè¿™ä¸ªsocçš„æ¿å­éƒ½ä¼šå¼•ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œå‘æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹ï¼Œç›¸å½“äºæ‰€æœ‰çš„æ¿å­éƒ½ä¼šæ·»åŠ è¿™ä¸ªè®¾å¤‡ï¼Œæ‰€ä»¥è¦åœ¨è‡ªå·±æ¿å­çš„.dtsæ–‡ä»¶è¿›è¡Œæ•°æ®è¿½åŠ å†…å®¹ã€‚</p><p>æ¯”å¦‚è¦å‘I2C1èŠ‚ç‚¹è¿½åŠ ä¸€ä¸ªfxls8471çš„å­èŠ‚ç‚¹ï¼Œéœ€è¦åœ¨imx6ull-alientek-emmc.dts æ–‡ä»¶ä¸­å®Œæˆæ•°æ®è¿½åŠ çš„å†…å®¹ï¼Œæ–¹å¼å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> &amp;i2c1 &#123;</span><br><span class="line"><span class="number">2</span> <span class="comment">/* è¦è¿½åŠ æˆ–ä¿®æ”¹çš„å†…å®¹ */</span></span><br><span class="line"><span class="number">3</span> &#125;;</span><br></pre></td></tr></table></figure><p>ç¬¬ 1 è¡Œï¼Œ &amp;i2c1 è¡¨ç¤ºè¦è®¿é—® i2c1 è¿™ä¸ª label æ‰€å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ imx6ull.dtsi ä¸­çš„â€œi2c1:i2c@021a0000â€ã€‚<br>ç¬¬ 2 è¡Œï¼ŒèŠ±æ‹¬å·å†…å°±æ˜¯è¦å‘ i2c1 è¿™ä¸ªèŠ‚ç‚¹æ·»åŠ çš„å†…å®¹ï¼ŒåŒ…æ‹¬ä¿®æ”¹æŸäº›å±æ€§çš„å€¼ã€‚ </p><p>æ‰“å¼€ imx6ull-alientek-emmc.dtsï¼Œæ‰¾åˆ°å¦‚ä¸‹æ‰€ç¤ºå†…å®¹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">224</span> &amp;i2c1 &#123;</span><br><span class="line"><span class="number">225</span> clock-frequency = &lt;<span class="number">100000</span>&gt;;</span><br><span class="line"><span class="number">226</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">227</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_i2c1&gt;;</span><br><span class="line"><span class="number">228</span> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">229</span></span><br><span class="line"><span class="number">230</span> mag3110@<span class="number">0</span>e &#123;</span><br><span class="line"><span class="number">231</span> compatible = <span class="string">&quot;fsl,mag3110&quot;</span>;</span><br><span class="line"><span class="number">232</span> reg = &lt;<span class="number">0x0e</span>&gt;;</span><br><span class="line"><span class="number">233</span> position = &lt;<span class="number">2</span>&gt;;</span><br><span class="line"><span class="number">234</span> &#125;;</span><br><span class="line"><span class="number">235</span></span><br><span class="line"><span class="number">236</span> fxls8471@<span class="number">1</span>e &#123;</span><br><span class="line"><span class="number">237</span> compatible = <span class="string">&quot;fsl,fxls8471&quot;</span>;</span><br><span class="line"><span class="number">238</span> reg = &lt;<span class="number">0x1e</span>&gt;;</span><br><span class="line"><span class="number">239</span> position = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">240</span> interrupt-parent = &lt;&amp;gpio5&gt;;</span><br><span class="line"><span class="number">241</span> interrupts = &lt;<span class="number">0</span> <span class="number">8</span>&gt;;</span><br><span class="line"><span class="number">242</span> &#125;;</span><br><span class="line"><span class="number">243</span>&#125;</span><br></pre></td></tr></table></figure><p>æœ¬ä»£ç å°±æ˜¯å‘ i2c1 èŠ‚ç‚¹æ·»åŠ &#x2F;ä¿®æ”¹æ•°æ®ï¼Œæ¯”å¦‚ç¬¬ 225 è¡Œçš„å±æ€§â€œclock-frequencyâ€å°±è¡¨ç¤º i2c1 æ—¶é’Ÿä¸º 100KHzã€‚â€œclock-frequencyâ€å°±æ˜¯æ–°æ·»åŠ çš„å±æ€§ã€‚<br>ç¬¬ 228 è¡Œï¼Œå°† status å±æ€§çš„å€¼ç”±åŸæ¥çš„ disabled æ”¹ä¸º okayã€‚<br>ç¬¬ 230<del>234 è¡Œï¼Œ i2c1 å­èŠ‚ç‚¹ mag3110ï¼Œå› ä¸º NXP å®˜æ–¹å¼€å‘æ¿åœ¨ I2C1 ä¸Šæ¥äº†ä¸€ä¸ªç£åŠ›è®¡èŠ¯ç‰‡ mag3110ï¼Œæ­£ç‚¹åŸå­çš„ I.MX6U-ALPHA å¼€å‘æ¿å¹¶æ²¡æœ‰ä½¿ç”¨ mag3110ã€‚<br>ç¬¬ 236</del>242 è¡Œï¼Œ i2c1 å­èŠ‚ç‚¹ fxls8471ï¼ŒåŒæ ·æ˜¯å› ä¸º NXP å®˜æ–¹å¼€å‘æ¿åœ¨ I2C1 ä¸Šæ¥äº† fxls8471è¿™é¢—å…­è½´èŠ¯ç‰‡ ã€‚</p><h3 id="åˆ›å»ºå°å‹æ¨¡æ¿è®¾å¤‡æ ‘"><a href="#åˆ›å»ºå°å‹æ¨¡æ¿è®¾å¤‡æ ‘" class="headerlink" title="åˆ›å»ºå°å‹æ¨¡æ¿è®¾å¤‡æ ‘"></a>åˆ›å»ºå°å‹æ¨¡æ¿è®¾å¤‡æ ‘</h3><p>ä»¥ I.MX6ULL è¿™ä¸ª SOC ä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è®¾å¤‡æ ‘é‡Œé¢æè¿°çš„å†…å®¹å¦‚ä¸‹ï¼š<br>â‘ ã€ I.MX6ULL è¿™ä¸ª Cortex-A7 æ¶æ„çš„ 32 ä½ CPUã€‚<br>â‘¡ã€ I.MX6ULL å†…éƒ¨ ocramï¼Œèµ·å§‹åœ°å€ 0x00900000ï¼Œå¤§å°ä¸º 128KB(0x20000)ã€‚<br>â‘¢ã€ I.MX6ULL å†…éƒ¨ aips1 åŸŸä¸‹çš„ ecspi1 å¤–è®¾æ§åˆ¶å™¨ï¼Œå¯„å­˜å™¨èµ·å§‹åœ°å€ä¸º 0x02008000ï¼Œå¤§å°ä¸º 0x4000ã€‚<br>â‘£ã€ I.MX6ULL å†…éƒ¨ aips2 åŸŸä¸‹çš„ usbotg1 å¤–è®¾æ§åˆ¶å™¨ï¼Œå¯„å­˜å™¨èµ·å§‹åœ°å€ä¸º 0x02184000ï¼Œå¤§å°ä¸º 0x4000ã€‚<br>â‘¤ã€ I.MX6ULL å†…éƒ¨ aips3 åŸŸä¸‹çš„ rngb å¤–è®¾æ§åˆ¶å™¨ï¼Œå¯„å­˜å™¨èµ·å§‹åœ°å€ä¸º 0x02284000ï¼Œå¤§å°ä¸º 0x4000ã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-09%20151328.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/&#123;</span><br><span class="line">compatible = <span class="string">&quot;fsl, imx6ull-alientek-evk&quot;</span>, <span class="string">&quot;fsl, imx6ull&quot;</span>;</span><br><span class="line">cpus &#123;</span><br><span class="line">    <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;<span class="comment">//åŸºåœ°å€ã€ç‰‡é€‰å·ç­‰ç»å¯¹èµ·å§‹åœ°å€æ‰€å å­—é•¿</span></span></span><br><span class="line">      <span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;<span class="comment">//é•¿åº¦æ‰€å å­—é•¿</span></span></span><br><span class="line">    cpu0 : cpu@<span class="number">0</span>&#123;</span><br><span class="line">      compatible = <span class="string">&quot;arm ,cortex-a7&quot;</span>;</span><br><span class="line">        device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  soc &#123;</span><br><span class="line">    <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">      <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">      compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line">      ranges;</span><br><span class="line">      ocram: sram@<span class="number">00900000</span> &#123;</span><br><span class="line">      compatible = <span class="string">&quot;fsl, lpm-sram&quot;</span>;</span><br><span class="line">      reg = &lt;<span class="number">0x00900000</span> <span class="number">0x20000</span>&gt;;</span><br><span class="line">      &#125;;</span><br><span class="line">      </span><br><span class="line">      apis1: aips-bus@<span class="number">02000000</span> &#123;</span><br><span class="line">      compatible = <span class="string">&quot;fsl, aip-bus&quot;</span>, <span class="string">&quot;simble-bus&quot;</span>;</span><br><span class="line">        <span class="meta">#address-cells  = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">        <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">        reg = &lt;<span class="number">0x2000000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line">        ranges;</span><br><span class="line">      </span><br><span class="line">        ecspi1: ecspi@<span class="number">02008000</span> &#123;</span><br><span class="line">        <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">          <span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">          compatible = <span class="string">&quot;fsl, imx6ul-ecspi&quot;</span>, <span class="string">&quot;fsl, imx5-ecspi&quot;</span>;</span><br><span class="line">          reg = &lt;<span class="number">0x02008000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">          status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">      apis2: aips-bus@<span class="number">02100000</span> &#123;</span><br><span class="line">      compatible = <span class="string">&quot;fsl, apis-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line">        <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">        <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">        reg = &lt;<span class="number">0x02100000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line">        ranges;</span><br><span class="line">        </span><br><span class="line">        usbotg1: usb@<span class="number">02184000</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;fsl, imx6ul-usb&quot;</span> , <span class="string">&quot;fsl, imx27-usb&quot;</span>;</span><br><span class="line">          reg = &lt;<span class="number">0x02184000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">          status  = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">      aips3: aips-bus@<span class="number">02200000</span> &#123;</span><br><span class="line">compatible = <span class="string">&quot;fsl,aips-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">reg = &lt;<span class="number">0x02200000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line">ranges;</span><br><span class="line"></span><br><span class="line">rngb: rngb@<span class="number">02284000</span> &#123;</span><br><span class="line">compatible = <span class="string">&quot;fsl,imx6sl-rng&quot;</span>, <span class="string">&quot;fsl,imx-rng&quot;</span>, <span class="string">&quot;imxrng&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">0x02284000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">      &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡æ ‘åœ¨ç³»ç»Ÿä¸­çš„ä½“ç°"><a href="#è®¾å¤‡æ ‘åœ¨ç³»ç»Ÿä¸­çš„ä½“ç°" class="headerlink" title="è®¾å¤‡æ ‘åœ¨ç³»ç»Ÿä¸­çš„ä½“ç°"></a>è®¾å¤‡æ ‘åœ¨ç³»ç»Ÿä¸­çš„ä½“ç°</h3><p>Linux å†…æ ¸å¯åŠ¨çš„æ—¶å€™ä¼šè§£æè®¾å¤‡æ ‘ä¸­å„ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„&#x2F;proc&#x2F;devicetree ç›®å½•ä¸‹æ ¹æ®èŠ‚ç‚¹åå­—åˆ›å»ºä¸åŒæ–‡ä»¶å¤¹ï¼Œ å¯ä»¥ä½¿ç”¨catå‘½ä»¤æ¥æŸ¥çœ‹modelå’Œcompatibleæ–‡ä»¶ä¿¡æ¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd proc/devicetree</span><br><span class="line">cat model</span><br><span class="line">cat compatible</span><br></pre></td></tr></table></figure><p>&#x2F;proc&#x2F;device-tree ç›®å½•å°±æ˜¯è®¾å¤‡æ ‘åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½“ç°ï¼ŒåŒæ ·æ˜¯æŒ‰ç…§æ ‘å½¢ç»“æ„ç»„ç»‡çš„ï¼Œè¿›å…¥&#x2F;proc&#x2F;device-tree&#x2F;soc ç›®å½•ä¸­å°±å¯ä»¥çœ‹åˆ° soc èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd soc</span><br><span class="line">ls</span><br></pre></td></tr></table></figure><h3 id="Linuxå†…æ ¸è§£æDTBæ–‡ä»¶"><a href="#Linuxå†…æ ¸è§£æDTBæ–‡ä»¶" class="headerlink" title="Linuxå†…æ ¸è§£æDTBæ–‡ä»¶"></a>Linuxå†…æ ¸è§£æDTBæ–‡ä»¶</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-09%20154941.png"></p><h3 id="å¦‚ä½•æ·»åŠ èŠ‚ç‚¹"><a href="#å¦‚ä½•æ·»åŠ èŠ‚ç‚¹" class="headerlink" title="å¦‚ä½•æ·»åŠ èŠ‚ç‚¹"></a>å¦‚ä½•æ·»åŠ èŠ‚ç‚¹</h3><p>å¯ä»¥æŸ¥çœ‹Linuxçš„æºç ä¸‹çš„&#x2F;Documentation&#x2F;devicetree&#x2F;bindingsï¼Œæ·»åŠ å“ªä¸ªå°±çœ‹å“ªä¸ªæ–‡ä»¶ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-09%20155142.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ–°å­—ç¬¦è®¾å¤‡é©±åŠ¨å¼€å‘</title>
      <link href="/2023/04/06/2023-4-7-%E6%96%B0%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
      <url>/2023/04/06/2023-4-7-%E6%96%B0%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h3 id="è®¾å¤‡å·"><a href="#è®¾å¤‡å·" class="headerlink" title="è®¾å¤‡å·"></a>è®¾å¤‡å·</h3><p>Linuxçš„è®¾å¤‡ç®¡ç†æ˜¯å’Œæ–‡ä»¶ç³»ç»Ÿç´§å¯†ç»“åˆçš„ï¼Œå„ç§è®¾å¤‡éƒ½ä»¥æ–‡ä»¶çš„å½¢å¼å­˜æ”¾åœ¨&#x2F;devç›®å½•ä¸‹ï¼Œç§°ä¸ºè®¾å¤‡æ–‡ä»¶ã€‚åº”ç”¨ç¨‹åºå¯ä»¥æ‰“å¼€ã€å…³é—­å’Œè¯»å†™è¿™äº›è®¾å¤‡æ–‡ä»¶ï¼Œå®Œæˆå¯¹è®¾å¤‡çš„æ“ä½œï¼Œå°±åƒæ“ä½œæ™®é€šçš„æ•°æ®æ–‡ä»¶ä¸€æ ·ã€‚ä¸ºäº†ç®¡ç†è¿™äº›è®¾å¤‡ï¼Œç³»ç»Ÿä¸ºè®¾å¤‡ç¼–äº†å·ï¼Œæ¯ä¸ªè®¾å¤‡å·åˆåˆ†ä¸ºä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ã€‚<strong>ä¸»è®¾å¤‡å·ç”¨æ¥åŒºåˆ†ä¸åŒç§ç±»çš„è®¾å¤‡ï¼Œè€Œæ¬¡è®¾å¤‡å·ç”¨æ¥åŒºåˆ†åŒä¸€ç±»å‹çš„å¤šä¸ªè®¾å¤‡ã€‚</strong>å¯¹äºå¸¸ç”¨è®¾å¤‡ï¼ŒLinuxæœ‰çº¦å®šä¿—æˆçš„ç¼–å·ï¼Œå¦‚ç¡¬ç›˜çš„ä¸»è®¾å¤‡å·æ˜¯3ã€‚</p><p>ä¸€ä¸ªå­—ç¬¦è®¾å¤‡æˆ–è€…å—è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ã€‚ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ç»Ÿç§°ä¸ºè®¾å¤‡å·ã€‚ä¸»è®¾å¤‡å·ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç‰¹å®šçš„é©±åŠ¨ç¨‹åºã€‚æ¬¡è®¾å¤‡å·ç”¨æ¥è¡¨ç¤ºä½¿ç”¨è¯¥é©±åŠ¨ç¨‹åºçš„å„è®¾å¤‡ã€‚ä¾‹å¦‚ä¸€ä¸ªåµŒå…¥å¼ç³»ç»Ÿï¼Œæœ‰ä¸¤ä¸ªLEDæŒ‡ç¤ºç¯ï¼ŒLEDç¯éœ€è¦ç‹¬ç«‹çš„æ‰“å¼€æˆ–è€…å…³é—­ã€‚é‚£ä¹ˆï¼Œå¯ä»¥å†™ä¸€ä¸ªLEDç¯çš„å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œå¯ä»¥å°†å…¶ä¸»è®¾å¤‡å·æ³¨å†Œæˆ5å·è®¾å¤‡ï¼Œæ¬¡è®¾å¤‡å·åˆ†åˆ«ä¸º1å’Œ2ã€‚è¿™é‡Œï¼Œæ¬¡è®¾å¤‡å·å°±åˆ†åˆ«è¡¨ç¤ºä¸¤ä¸ªLEDç¯ã€‚</p><p> å‡½æ•°å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sysmacros.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line">MKDEV(<span class="type">int</span> major,<span class="type">int</span> minor) <span class="comment">//majorä¸ºä¸»è®¾å¤‡å· minorä¸ºæ¬¡è®¾å¤‡å·ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MKDEV(major,minor) (((major) &lt;&lt; MINORBITS) | (minor))ã€‚</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">major</span><span class="params">(<span class="type">dev_t</span> dev)</span>;<span class="comment">//è·å–ä¸»è®¾å¤‡å·</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">minor</span><span class="params">(<span class="type">dev_t</span> dev)</span>;<span class="comment">//è·å–æ¬¡è®¾å¤‡å·</span></span><br></pre></td></tr></table></figure><p>åœ¨ç¨‹åºä¸­ç”¨å®MAJOR(dev_t  dev)å¯ä»¥è§£æå‡ºä¸»è®¾å¤‡å·ï¼Œç”¨å®MINOR(dev_t dev)å¯ä»¥è§£æå‡ºæ¬¡è®¾å¤‡å·</p><h4 id="ç”³è¯·è®¾å¤‡å·"><a href="#ç”³è¯·è®¾å¤‡å·" class="headerlink" title="ç”³è¯·è®¾å¤‡å·"></a>ç”³è¯·è®¾å¤‡å·</h4><p>åŠ¨æ€ç”³è¯·è®¾å¤‡å·ï¼Œæ²¡æœ‰æŒ‡å®šè®¾å¤‡å·ç”¨ä»¥ä¸‹å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">alloc_chrdev_region</span><span class="params">(<span class="type">dev_t</span> *dev, <span class="type">unsigned</span> baseminor, <span class="type">unsigned</span> count, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br></pre></td></tr></table></figure><p>dev :alloc_chrdev_regionå‡½æ•°å‘å†…æ ¸ç”³è¯·ä¸‹æ¥çš„è®¾å¤‡å·</p><p>baseminor :æ¬¡è®¾å¤‡å·çš„èµ·å§‹</p><p>count: ç”³è¯·æ¬¡è®¾å¤‡å·çš„ä¸ªæ•°</p><p>name :æ‰§è¡Œ cat &#x2F;proc&#x2F;devicesæ˜¾ç¤ºçš„åç§°</p><p>é™æ€ç”³è¯·è®¾å¤‡å·ï¼Œç»™å®šäº†è®¾å¤‡çš„ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·å°±ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºå‡½æ•°æ¥æ³¨å†Œè®¾å¤‡å·å³å¯ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">register_chrdev_region</span><span class="params">(<span class="type">dev_t</span> from, <span class="type">unsigned</span> count, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br></pre></td></tr></table></figure><p>from:èµ·å§‹è®¾å¤‡å·</p><p>countï¼šæ•°é‡è®¾å¤‡</p><p>nameï¼šè®¾å¤‡åå­—</p><p>æ³¨ é”€ å­— ç¬¦ è®¾ å¤‡ ä¹‹ å è¦ é‡Š æ”¾ æ‰ è®¾ å¤‡ å· ï¼Œ ä¸ ç®¡ æ˜¯ é€š è¿‡ alloc_chrdev_region å‡½ æ•° è¿˜ æ˜¯register_chrdev_region å‡½æ•°ç”³è¯·çš„è®¾å¤‡å·ï¼Œç»Ÿä¸€ä½¿ç”¨å¦‚ä¸‹é‡Šæ”¾å‡½æ•°ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">unregister_chrdev_region</span><span class="params">(<span class="type">dev_t</span> from, <span class="type">unsigned</span> count)</span></span><br></pre></td></tr></table></figure><p>æ–°å­—ç¬¦è®¾å¤‡é©±åŠ¨ä¸‹ï¼Œè®¾å¤‡å·åˆ†é…å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> major; <span class="comment">/* ä¸»è®¾å¤‡å· */</span></span><br><span class="line"><span class="type">int</span> minor; <span class="comment">/* æ¬¡è®¾å¤‡å· */</span></span><br><span class="line"><span class="type">dev_t</span> devid; <span class="comment">/* è®¾å¤‡å· */</span></span><br><span class="line"><span class="keyword">if</span> (major) </span><br><span class="line">&#123; <span class="comment">/* å®šä¹‰äº†ä¸»è®¾å¤‡å· */</span></span><br><span class="line">  devid = MKDEV(major, <span class="number">0</span>); <span class="comment">/* å¤§éƒ¨åˆ†é©±åŠ¨æ¬¡è®¾å¤‡å·éƒ½é€‰æ‹© 0*/</span></span><br><span class="line">register_chrdev_region(devid, <span class="number">1</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">/* æ²¡æœ‰å®šä¹‰è®¾å¤‡å· */</span></span><br><span class="line">alloc_chrdev_region(&amp;devid, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">/* ç”³è¯·è®¾å¤‡å· */</span></span><br><span class="line">major = MAJOR(devid); <span class="comment">/* è·å–åˆ†é…å·çš„ä¸»è®¾å¤‡å· */</span></span><br><span class="line">minor = MINOR(devid); <span class="comment">/* è·å–åˆ†é…å·çš„æ¬¡è®¾å¤‡å· */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å­—ç¬¦è®¾å¤‡ç»“æ„"><a href="#å­—ç¬¦è®¾å¤‡ç»“æ„" class="headerlink" title="å­—ç¬¦è®¾å¤‡ç»“æ„"></a>å­—ç¬¦è®¾å¤‡ç»“æ„</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span><span class="comment">//æ˜¯ä¸€ä¸ªåµŒå…¥åœ¨è¯¥ç»“æ„ä¸­çš„å†…æ ¸å¯¹è±¡ã€‚å®ƒç”¨äºè¯¥æ•°æ®ç»“æ„çš„ä¸€èˆ¬ç®¡ç†</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span><span class="comment">//owneræŒ‡å‘æä¾›é©±åŠ¨ç¨‹åºçš„æ¨¡å—</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ops</span>;</span><span class="comment">//opsæ˜¯ä¸€ç»„æ–‡ä»¶æ“ä½œï¼Œå®ç°äº†ä¸ç¡¬ä»¶é€šä¿¡çš„å…·ä½“æ“ä½œ</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span><span class="comment">//listç”¨æ¥å®ç°ä¸€ä¸ªé“¾è¡¨ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰è¡¨ç¤ºè¯¥è®¾å¤‡çš„è®¾å¤‡ç‰¹æ®Šæ–‡ä»¶çš„inode</span></span><br><span class="line"><span class="type">dev_t</span> dev;<span class="comment">//devæŒ‡å®šäº†è®¾å¤‡å·</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> count;<span class="comment">//è¡¨ç¤ºä¸è¯¥è®¾å¤‡å…³è”çš„ä»è®¾å¤‡çš„æ•°ç›®</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>cdevä¸¤ç§å®šä¹‰åˆå§‹åŒ–æ–¹å¼ï¼š<a href="https://blog.csdn.net/daocaokafei/article/details/119720422"> Linuxé©±åŠ¨|cdev_initã€cdev_allocåŒºåˆ«_ä¸€å£Linuxçš„åšå®¢-CSDNåšå®¢</a></p><p><strong>é™æ€åˆå§‹åŒ–ï¼šcdev_initå‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cdev_init</span><span class="params">(<span class="keyword">struct</span> cdev *cdev, <span class="type">const</span> <span class="keyword">struct</span> file_operations *fops)</span> </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">my_cdev</span>;</span></span><br><span class="line">cdev_init(&amp;my_cdev, &amp;fops);</span><br><span class="line">my_cdev.owner = THIS_MODULE;</span><br><span class="line">my_cdev.ops = &amp;fops;</span><br></pre></td></tr></table></figure><p><strong>åŠ¨æ€åˆå§‹åŒ–ï¼šcdev_allocå‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> *<span class="title">my_cdev</span> =</span> cdev_alloc();</span><br><span class="line">my_cdev-&gt;ops = &amp;fops;</span><br><span class="line">my_cdev-&gt;owner = THIS_MODULE;</span><br></pre></td></tr></table></figure><p>å°†cdevæ·»åŠ åˆ°ç³»ç»Ÿä¸­å» <strong>cdev_addå‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">cdev_add</span><span class="params">(<span class="keyword">struct</span> cdev *p, <span class="type">dev_t</span> dev, <span class="type">unsigned</span> count)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">testcdev</span>;</span></span><br><span class="line"><span class="comment">/* è®¾å¤‡æ“ä½œå‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">test_fops</span> =</span> &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line"> <span class="comment">/* å…¶ä»–å…·ä½“çš„åˆå§‹é¡¹ */</span></span><br><span class="line">&#125;;</span><br><span class="line">testcdev.owner = THIS_MODULE;</span><br><span class="line">cdev_init(&amp;testcdev, &amp;test_fops); <span class="comment">/* åˆå§‹åŒ– cdev ç»“æ„ä½“å˜é‡ */</span></span><br><span class="line">cdev_add(&amp;testcdev, devid, <span class="number">1</span>); <span class="comment">/* æ·»åŠ å­—ç¬¦è®¾å¤‡ */</span></span><br></pre></td></tr></table></figure><p><strong>cdev_del å‡½æ•°</strong> </p><p>å¸è½½é©±åŠ¨çš„æ—¶å€™ä¸€å®šè¦ä½¿ç”¨ cdev_del å‡½æ•°ä» Linux å†…æ ¸ä¸­åˆ é™¤ç›¸åº”çš„å­—ç¬¦è®¾å¤‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cdev_del</span><span class="params">(<span class="keyword">struct</span> cdev *p)</span></span><br></pre></td></tr></table></figure><p>å‚æ•° p å°±æ˜¯è¦åˆ é™¤çš„å­—ç¬¦è®¾å¤‡ã€‚å¦‚æœè¦åˆ é™¤å­—ç¬¦è®¾å¤‡ï¼Œå‚è€ƒå¦‚ä¸‹ä»£ç ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cdev_del(&amp;testcdev); <span class="comment">/* åˆ é™¤ cdev */</span></span><br></pre></td></tr></table></figure><p>cdev_del å’Œ unregister_chrdev_region è¿™ä¸¤ä¸ªå‡½æ•°åˆèµ·æ¥çš„åŠŸèƒ½ç›¸å½“äº unregister_chrdev å‡½æ•°ã€‚ </p><h3 id="è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹"><a href="#è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹" class="headerlink" title="è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹"></a>è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</h3><p>æ—©æœŸçš„Linuxå†…æ ¸ï¼ˆç‰ˆæœ¬2.4ä¹‹å‰ï¼‰å¹¶æ²¡æœ‰å®ç°ä¸€ä¸ªç»Ÿä¸€çš„è®¾å¤‡æ¨¡å‹ï¼Œè®¾å¤‡èŠ‚ç‚¹çš„åˆ›å»ºä¸€èˆ¬æ˜¯mknodå‘½ä»¤æ‰‹åŠ¨åˆ›å»ºæˆ–åˆ©ç”¨devfsæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºã€‚æ—©æœŸçš„Linuxå‘è¡Œç‰ˆä¸€èˆ¬ä¼šé‡‡ç”¨æ‰‹åŠ¨åˆ›å»ºçš„æ–¹å¼é¢„å…ˆæŠŠé€šå¸¸ç”¨åˆ°çš„èŠ‚ç‚¹éƒ½åˆ›å»ºå‡ºæ¥ï¼Œè€ŒåµŒå…¥å¼ç³»ç»Ÿåˆ™ä¼šé‡‡ç”¨devfsçš„æ–¹å¼ã€‚èµ·åˆLinux2.6 å†…æ ¸è¿˜æ”¯æŒdevfsï¼Œä½†ä»2.6.18å¼€å§‹ï¼Œå†…æ ¸å®Œå…¨ç§»é™¤äº†devfsç³»ç»Ÿè€Œé‡‡ç”¨çš„udevçš„æ–¹å¼åŠ¨æ€çš„åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œæ–°çš„Linuxå‘è¡Œç‰ˆéƒ½é‡‡ç”¨udevçš„æ–¹å¼ç®¡ç†è®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶ã€‚<br>classå¯ä»¥è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œä¸éœ€è¦udevï¼Œè€Œudevè‡ªåŠ¨åˆ›å»ºèŠ‚ç‚¹éœ€è¦ç”¨åˆ°classã€‚</p><h4 id="åˆ›å»ºå’Œåˆ é™¤ç±»"><a href="#åˆ›å»ºå’Œåˆ é™¤ç±»" class="headerlink" title="åˆ›å»ºå’Œåˆ é™¤ç±»"></a>åˆ›å»ºå’Œåˆ é™¤ç±»</h4><p>è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹çš„å·¥ä½œæ˜¯åœ¨é©±åŠ¨ç¨‹åºçš„å…¥å£å‡½æ•°ä¸­å®Œæˆçš„ï¼Œä¸€èˆ¬åœ¨ cdev_add å‡½æ•°åé¢æ·»åŠ è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ç›¸å…³ä»£ç ã€‚é¦–å…ˆè¦åˆ›å»ºä¸€ä¸ª class ç±»ï¼Œ class æ˜¯ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰åœ¨æ–‡ä»¶include&#x2F;linux&#x2F;device.h é‡Œé¢ã€‚ class_create æ˜¯ç±»åˆ›å»ºå‡½æ•°ï¼Œ class_create æ˜¯ä¸ªå®å®šä¹‰ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> class_create(owner, name) \</span></span><br><span class="line"><span class="meta">(&#123; \</span></span><br><span class="line"><span class="meta">static struct lock_class_key __key; \</span></span><br><span class="line"><span class="meta">__class_create(owner, name, &amp;__key); \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *__<span class="title">class_create</span>(<span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>,<span class="keyword">struct</span> <span class="title">lock_class_key</span> *<span class="title">key</span>)</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šè¿°ä»£ç ï¼Œå°†å® class_create å±•å¼€ä»¥åå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> class *<span class="title function_">class_create</span> <span class="params">(<span class="keyword">struct</span> module *owner, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br></pre></td></tr></table></figure><p>class_create ä¸€å…±æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•° owner ä¸€èˆ¬ä¸º THIS_MODULEï¼Œå‚æ•° name æ˜¯ç±»åå­—ã€‚<br>è¿”å›å€¼æ˜¯ä¸ªæŒ‡å‘ç»“æ„ä½“ class çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºçš„ç±»ã€‚<br>å¸è½½é©±åŠ¨ç¨‹åºçš„æ—¶å€™éœ€è¦åˆ é™¤æ‰ç±»ï¼Œç±»åˆ é™¤å‡½æ•°ä¸º class_destroyï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">class_destroy</span><span class="params">(<span class="keyword">struct</span> class *cls)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•° cls å°±æ˜¯è¦åˆ é™¤çš„ç±»ã€‚ </p><h4 id="åˆ›å»ºè®¾å¤‡"><a href="#åˆ›å»ºè®¾å¤‡" class="headerlink" title="åˆ›å»ºè®¾å¤‡"></a>åˆ›å»ºè®¾å¤‡</h4><p>ä½¿ç”¨ device_create å‡½æ•°åœ¨ç±»ä¸‹é¢åˆ›å»ºè®¾å¤‡ï¼Œ device_create å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device *<span class="title function_">device_create</span><span class="params">(<span class="keyword">struct</span> class *class,</span></span><br><span class="line"><span class="params">                                <span class="keyword">struct</span> device *parent,</span></span><br><span class="line"><span class="params">                                <span class="type">dev_t</span> devt,</span></span><br><span class="line"><span class="params">                                <span class="type">void</span> *drvdata,</span></span><br><span class="line"><span class="params">                                <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br></pre></td></tr></table></figure><p>device_create æ˜¯ä¸ªå¯å˜å‚æ•°å‡½æ•°ï¼Œå‚æ•° class å°±æ˜¯è®¾å¤‡è¦åˆ›å»ºå“ªä¸ªç±»ä¸‹é¢ï¼›å‚æ•° parent æ˜¯çˆ¶è®¾å¤‡ï¼Œä¸€èˆ¬ä¸º NULLï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰çˆ¶è®¾å¤‡ï¼›å‚æ•° devt æ˜¯è®¾å¤‡å·ï¼›å‚æ•° drvdata æ˜¯è®¾å¤‡å¯èƒ½ä¼šä½¿ç”¨çš„ä¸€äº›æ•°æ®ï¼Œä¸€èˆ¬ä¸º NULLï¼›å‚æ•° fmt æ˜¯è®¾å¤‡åå­—ï¼Œå¦‚æœè®¾ç½® fmt&#x3D;xxx çš„è¯ï¼Œå°±ä¼šç”Ÿæˆ&#x2F;dev&#x2F;xxxè¿™ä¸ªè®¾å¤‡æ–‡ä»¶ã€‚è¿”å›å€¼å°±æ˜¯åˆ›å»ºå¥½çš„è®¾å¤‡ã€‚<br>åŒæ ·çš„ï¼Œå¸è½½é©±åŠ¨çš„æ—¶å€™éœ€è¦åˆ é™¤æ‰åˆ›å»ºçš„è®¾å¤‡ï¼Œè®¾å¤‡åˆ é™¤å‡½æ•°ä¸º device_destroyï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">device_destroy</span><span class="params">(<span class="keyword">struct</span> class *class, <span class="type">dev_t</span> devt)</span></span><br></pre></td></tr></table></figure><p>å‚æ•° class æ˜¯è¦åˆ é™¤çš„è®¾å¤‡æ‰€å¤„çš„ç±»ï¼Œå‚æ•° devt æ˜¯è¦åˆ é™¤çš„è®¾å¤‡å·ã€‚</p><h3 id="è®¾ç½®æ–‡ä»¶ç§æœ‰æ•°æ®"><a href="#è®¾ç½®æ–‡ä»¶ç§æœ‰æ•°æ®" class="headerlink" title="è®¾ç½®æ–‡ä»¶ç§æœ‰æ•°æ®"></a>è®¾ç½®æ–‡ä»¶ç§æœ‰æ•°æ®</h3><p>æ¯ä¸ªç¡¬ä»¶è®¾å¤‡éƒ½æœ‰ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ä¸»è®¾å¤‡å·(dev_t)ï¼Œç±»(class)ã€è®¾å¤‡(device)ã€å¼€å…³çŠ¶æ€(state)ç­‰ç­‰ï¼Œåœ¨ç¼–å†™é©±åŠ¨çš„æ—¶å€™ä½ å¯ä»¥å°†è¿™äº›å±æ€§å…¨éƒ¨å†™æˆå˜é‡çš„å½¢å¼ ï¼Œä¸€èˆ¬ä»¥è®¾å¤‡çš„æ‰€æœ‰å±æ€§æ¥ä½œä¸ºä¸€ä¸ªç»“æ„ä½“ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">test_dev</span>&#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid; <span class="comment">/* è®¾å¤‡å· */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span> <span class="comment">/* cdev */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span> <span class="comment">/* ç±» */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span> <span class="comment">/* è®¾å¤‡ */</span></span><br><span class="line"><span class="type">int</span> major; <span class="comment">/* ä¸»è®¾å¤‡å· */</span></span><br><span class="line"><span class="type">int</span> minor; <span class="comment">/* æ¬¡è®¾å¤‡å· */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">test_dev</span> <span class="title">testdev</span>;</span></span><br><span class="line"><span class="comment">/* open å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">test_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">filp-&gt;private_data = &amp;testdev; <span class="comment">/* è®¾ç½®ç§æœ‰æ•°æ® */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ open å‡½æ•°é‡Œé¢è®¾ç½®å¥½ç§æœ‰æ•°æ®ä»¥åï¼Œåœ¨ writeã€ readã€ close ç­‰å‡½æ•°ä¸­ç›´æ¥è¯»å– private_dataå³å¯å¾—åˆ°è®¾å¤‡ç»“æ„ä½“ã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-07%20100106.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>NEWCHRLED_CNT1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>NEWCHRLED_NAME<span class="string">&quot;newchrled&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_MAJOR200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>LED_NAME<span class="string">&quot;led&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>CCM_CCGR1_BASE(0X020C406C)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SW_PAD_GPIO1_IO03_BASE(0X020E02F4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SW_MUX_GPIO1_IO03_BASE(0X020E0068)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO1_DR_BASE(0X0209C000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO1_GDIR_BASE(0X0209C004)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> on1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>off0</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *CCM_CCGR1;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *SW_PAD_GPIO1_IO03;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *SW_MUX_GPIO1_IO03;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *GPIO1_DR;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *GPIO1_GDIR;</span><br><span class="line"><span class="comment">//è®¾å¤‡å±æ€§</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">newchrled_dev</span>&#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span><span class="title">cdev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"><span class="type">int</span> major;</span><br><span class="line"><span class="type">int</span> minor;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">newchrled_dev</span> <span class="title">newchrled</span>;</span><span class="comment">//led è®¾å¤‡</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">led_switch</span><span class="params">(u8 sta)</span></span><br><span class="line">&#123;</span><br><span class="line">u32 num;</span><br><span class="line"><span class="keyword">if</span>(sta == on)</span><br><span class="line">&#123;</span><br><span class="line">num =readl(GPIO1_DR);</span><br><span class="line">num &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">writel( num, GPIO1_DR);</span><br><span class="line">printk(<span class="string">&quot;on\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(sta == off)</span><br><span class="line">&#123;</span><br><span class="line">num = readl(GPIO1_DR);</span><br><span class="line">num |= (<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">writel( num, GPIO1_DR);</span><br><span class="line">printk(<span class="string">&quot;off\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_dev_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">filp-&gt;private_data = &amp;newchrled;<span class="comment">//è®¾ç½®ç§æœ‰æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_dev_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_dev_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_dev_write</span><span class="params">(<span class="keyword">struct</span> file *filp,<span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> val = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">1</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> state ;</span><br><span class="line"></span><br><span class="line">val = copy_from_user(databuf, buf, cnt);</span><br><span class="line"><span class="keyword">if</span>(val &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kernl write failed \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">&#125;</span><br><span class="line">state = databuf[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(state == on)</span><br><span class="line">led_switch(on);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(state == off)</span><br><span class="line">led_switch(off);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">led_fops</span> =</span> &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.open = led_dev_open,</span><br><span class="line">.read = led_dev_read,</span><br><span class="line">.write = led_dev_write,</span><br><span class="line">.release = led_dev_release,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//int value = 0;</span></span><br><span class="line">u32 val = <span class="number">0</span>;</span><br><span class="line">CCM_CCGR1 = ioremap(CCM_CCGR1_BASE, <span class="number">4</span>);</span><br><span class="line">SW_MUX_GPIO1_IO03 = ioremap(SW_MUX_GPIO1_IO03_BASE, <span class="number">4</span>);</span><br><span class="line">SW_PAD_GPIO1_IO03 = ioremap(SW_PAD_GPIO1_IO03_BASE, <span class="number">4</span>);</span><br><span class="line">GPIO1_DR = ioremap(GPIO1_DR_BASE, <span class="number">4</span>); </span><br><span class="line">GPIO1_GDIR = ioremap(GPIO1_GDIR_BASE, <span class="number">4</span>);</span><br><span class="line">    </span><br><span class="line">val = readl(CCM_CCGR1);</span><br><span class="line">val &amp;= ~(<span class="number">3</span> &lt;&lt; <span class="number">26</span>);<span class="comment">//CCM_CCGR1çš„ç¬¬27å’Œ26ä½æ§åˆ¶GPIO1 clockçš„ä½¿èƒ½</span></span><br><span class="line">val |= (<span class="number">3</span> &lt;&lt; <span class="number">26</span>);</span><br><span class="line">writel(val, CCM_CCGR1);</span><br><span class="line"><span class="comment">//GPIOå¤ä½</span></span><br><span class="line">writel(<span class="number">5</span>,SW_MUX_GPIO1_IO03);</span><br><span class="line"><span class="comment">//é…ç½®ç”µå™¨å±æ€§ </span></span><br><span class="line">writel(<span class="number">0x10B0</span>, SW_PAD_GPIO1_IO03);</span><br><span class="line"><span class="comment">//é…ç½®è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">val = readl(GPIO1_GDIR);</span><br><span class="line">val &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">val |= (<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">writel(val, GPIO1_GDIR);</span><br><span class="line">    <span class="comment">//é»˜è®¤å…³é—­led</span></span><br><span class="line">val = readl(GPIO1_DR);</span><br><span class="line">val |= (<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">writel( val , GPIO1_DR);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ³¨å†Œè®¾å¤‡é©±åŠ¨</span></span><br><span class="line"><span class="keyword">if</span>(newchrled.major)</span><br><span class="line">&#123;</span><br><span class="line">newchrled.devid = MKDEV(newchrled.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(newchrled.devid, <span class="number">1</span>, <span class="string">&quot;led&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">alloc_chrdev_region(&amp;newchrled.devid, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;led&quot;</span>);</span><br><span class="line">newchrled.major = MAJOR(newchrled.devid);</span><br><span class="line">newchrled.minor = MINOR(newchrled.devid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">cdev_init(&amp;newchrled.cdev, &amp;led_fops);</span><br><span class="line">newchrled.cdev.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ·»åŠ åˆ°ç³»ç»Ÿä¸­</span></span><br><span class="line">cdev_add(&amp;newchrled.cdev, newchrled.devid, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//åˆ›å»ºç±»</span></span><br><span class="line">newchrled.class = class_create(THIS_MODULE , <span class="string">&quot;led&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(IS_ERR(newchrled.class))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(newchrled.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆ›å»ºè®¾å¤‡</span></span><br><span class="line">newchrled.device = device_create(newchrled.class, <span class="literal">NULL</span>, newchrled.devid, <span class="literal">NULL</span>, <span class="string">&quot;led&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(IS_ERR(newchrled.device))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(newchrled.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">iounmap(CCM_CCGR1);</span><br><span class="line">iounmap(GPIO1_DR);</span><br><span class="line">iounmap(GPIO1_GDIR);</span><br><span class="line">iounmap(SW_PAD_GPIO1_IO03);</span><br><span class="line">iounmap(SW_MUX_GPIO1_IO03);</span><br><span class="line"><span class="comment">//æ³¨é”€ledè®¾å¤‡</span></span><br><span class="line">cdev_del(&amp;newchrled.cdev);<span class="comment">/*  åˆ é™¤cdev */</span></span><br><span class="line">unregister_chrdev_region(newchrled.devid, NEWCHRLED_CNT); <span class="comment">/* æ³¨é”€è®¾å¤‡å· */</span></span><br><span class="line"></span><br><span class="line">device_destroy(newchrled.class, newchrled.devid);</span><br><span class="line">class_destroy(newchrled.class);</span><br><span class="line">printk(<span class="string">&quot;led exit\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(led_init);</span><br><span class="line">module_exit(led_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LEDé©±åŠ¨å¼€å‘</title>
      <link href="/2023/04/04/2023-4-4-LED%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
      <url>/2023/04/04/2023-4-4-LED%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h3 id="åœ°å€æ˜ å°„"><a href="#åœ°å€æ˜ å°„" class="headerlink" title="åœ°å€æ˜ å°„"></a>åœ°å€æ˜ å°„</h3><p>MMU(Memory Manage Unit)ä¸ºå†…å­˜ç®¡ç†å•å…ƒï¼ŒLinuxå†…æ ¸2.6ä»¥å‰å¿…é¡»è¦æœ‰MMUï¼Œä¹‹åæ”¯æŒæ— MMUçš„å¤„ç†å™¨ã€‚MMUçš„åŠŸèƒ½æœ‰ï¼š</p><p>â‘ å®Œæˆè™šæ‹Ÿç©ºé—´åˆ°ç‰©ç†ç©ºé—´çš„æ˜ å°„ã€‚â‘¡å†…å­˜ä¿æŠ¤ï¼Œè®¾ç½®å­˜å‚¨å™¨çš„è®¿é—®æƒé™ï¼Œè®¾ç½®è™šæ‹Ÿå­˜å‚¨ç©ºé—´çš„ç¼“å†²ç‰¹æ€§ã€‚Linux å†…æ ¸å¯åŠ¨çš„æ—¶å€™ä¼šåˆå§‹åŒ– MMUï¼Œè®¾ç½®å¥½å†…å­˜æ˜ å°„ï¼Œè®¾ç½®å¥½ä»¥å CPU è®¿é—®çš„éƒ½æ˜¯è™šæ‹Ÿ åœ° å€ ã€‚ æ¯” å¦‚ I.MX6ULL çš„GPIO1_IO03 å¼• è„š çš„ å¤ ç”¨ å¯„ å­˜ å™¨IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03 çš„åœ°å€ä¸º 0X020E0068ã€‚å¦‚æœæ²¡æœ‰å¼€å¯MMU çš„è¯ç›´æ¥å‘ 0X020E0068 è¿™ä¸ªå¯„å­˜å™¨åœ°å€å†™å…¥æ•°æ®å°±å¯ä»¥é…ç½® GPIO1_IO03 çš„å¤ç”¨åŠŸèƒ½ã€‚ç°åœ¨å¼€å¯äº† MMUï¼Œå¹¶ä¸”è®¾ç½®äº†å†…å­˜æ˜ å°„ï¼Œå› æ­¤å°±ä¸èƒ½ç›´æ¥å‘ 0X020E0068 è¿™ä¸ªåœ°å€å†™å…¥æ•°æ®äº†ã€‚æˆ‘ä»¬å¿…é¡»å¾—åˆ° 0X020E0068 è¿™ä¸ªç‰©ç†åœ°å€åœ¨ Linux ç³»ç»Ÿé‡Œé¢å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°äº†ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜ä¹‹é—´çš„è½¬æ¢ï¼Œéœ€è¦ç”¨åˆ°ä¸¤ä¸ªå‡½æ•°ï¼š ioremap å’Œ iounmapã€‚ </p><h4 id="ioremapå‡½æ•°"><a href="#ioremapå‡½æ•°" class="headerlink" title="ioremapå‡½æ•°"></a>ioremapå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ioremap(cookie,size) __arm_ioremap((cookie), (size),MT_DEVICE)</span></span><br><span class="line"><span class="type">void</span> __iomem * __arm_ioremap(<span class="type">phys_addr_t</span> phys_addr, <span class="type">size_t</span> size, <span class="type">unsigned</span> <span class="type">int</span> mtype)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> arch_ioremap_caller(phys_addr, size,mtype,__builtin_return_address(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>phys_addrï¼šè¦æ˜ å°„çš„ç‰©ç†èµ·å§‹åœ°å€ã€‚<br>sizeï¼šè¦æ˜ å°„çš„å†…å­˜ç©ºé—´å¤§å°ã€‚<br>mtypeï¼š ioremap çš„ç±»å‹ï¼Œå¯ä»¥é€‰æ‹© MT_DEVICEã€MT_DEVICE_NONSHAREDã€MT_DEVICE_CACHED å’Œ MT_DEVICE_WCï¼Œ ioremap å‡½æ•°é€‰æ‹© MT_DEVICEã€‚<br>è¿”å›å€¼ï¼š __iomem ç±»å‹çš„æŒ‡é’ˆï¼ŒæŒ‡å‘æ˜ å°„åçš„è™šæ‹Ÿç©ºé—´é¦–åœ°å€ã€‚ </p><p>å‡å¦‚æˆ‘ä»¬è¦è·å– I.MX6ULL çš„ IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03 å¯„å­˜å™¨å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ç å³å¯ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SW_MUX_GPIO1_IO03_BASE (0X020E0068)</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem* SW_MUX_GPIO1_IO03;</span><br><span class="line">SW_MUX_GPIO1_IO03 = ioremap(SW_MUX_GPIO1_IO03_BASE, <span class="number">4</span>);</span><br></pre></td></tr></table></figure><p>å® SW_MUX_GPIO1_IO03_BASE æ˜¯å¯„å­˜å™¨ç‰©ç†åœ°å€ï¼Œ SW_MUX_GPIO1_IO03 æ˜¯æ˜ å°„åçš„è™šæ‹Ÿåœ°å€ã€‚å¯¹äº I.MX6ULL æ¥è¯´ä¸€ä¸ªå¯„å­˜å™¨æ˜¯ 4 å­—èŠ‚(32 ä½)çš„ï¼Œå› æ­¤æ˜ å°„çš„å†…å­˜é•¿åº¦ä¸º 4ã€‚æ˜ å°„å®Œæˆä»¥åç›´æ¥å¯¹ SW_MUX_GPIO1_IO03 è¿›è¡Œè¯»å†™æ“ä½œå³å¯ã€‚ </p><h4 id="iounmapå‡½æ•°"><a href="#iounmapå‡½æ•°" class="headerlink" title="iounmapå‡½æ•°"></a>iounmapå‡½æ•°</h4><p>å¸è½½é©±åŠ¨çš„æ—¶å€™éœ€è¦ä½¿ç”¨ iounmap å‡½æ•°é‡Šæ”¾æ‰ ioremap å‡½æ•°æ‰€åšçš„æ˜ å°„ï¼Œ iounmap å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">iounmap</span> <span class="params">(<span class="keyword">volatile</span> <span class="type">void</span> __iomem *addr)</span></span><br></pre></td></tr></table></figure><p>iounmap åªæœ‰ä¸€ä¸ªå‚æ•° addrï¼Œæ­¤å‚æ•°å°±æ˜¯è¦å–æ¶ˆæ˜ å°„çš„è™šæ‹Ÿåœ°å€ç©ºé—´é¦–åœ°å€ã€‚ </p><h3 id="I-x2F-Oå†…å­˜è®¿é—®"><a href="#I-x2F-Oå†…å­˜è®¿é—®" class="headerlink" title="I&#x2F;Oå†…å­˜è®¿é—®"></a>I&#x2F;Oå†…å­˜è®¿é—®</h3><p><strong>å½“å¤–éƒ¨å¯„å­˜å™¨æˆ–å†…å­˜æ˜ å°„åˆ° IO ç©ºé—´æ—¶ï¼Œç§°ä¸º I&#x2F;O ç«¯å£ã€‚</strong><br><strong>å½“å¤–éƒ¨å¯„å­˜å™¨æˆ–å†…å­˜æ˜ å°„åˆ°å†…å­˜ç©ºé—´æ—¶ï¼Œç§°ä¸º I&#x2F;O å†…å­˜ã€‚</strong> </p><p><u>ä½†æ˜¯å¯¹äº ARM æ¥è¯´æ²¡æœ‰ I&#x2F;O ç©ºé—´è¿™ä¸ªæ¦‚å¿µï¼Œå› æ­¤ ARM ä½“ç³»ä¸‹åªæœ‰ I&#x2F;O å†…å­˜(å¯ä»¥ç›´æ¥ç†è§£ä¸ºå†…å­˜)ã€‚</u> </p><h4 id="è¯»æ“ä½œå‡½æ•°"><a href="#è¯»æ“ä½œå‡½æ•°" class="headerlink" title="è¯»æ“ä½œå‡½æ•°"></a>è¯»æ“ä½œå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">u8 <span class="title function_">readb</span><span class="params">(<span class="type">const</span> <span class="keyword">volatile</span> <span class="type">void</span> __iomem *addr)</span></span><br><span class="line">u16 <span class="title function_">readw</span><span class="params">(<span class="type">const</span> <span class="keyword">volatile</span> <span class="type">void</span> __iomem *addr)</span></span><br><span class="line">u32 <span class="title function_">readl</span><span class="params">(<span class="type">const</span> <span class="keyword">volatile</span> <span class="type">void</span> __iomem *addr)</span></span><br></pre></td></tr></table></figure><p>å‚æ•° addr å°±æ˜¯è¦è¯»å–å†™å†…å­˜åœ°å€ï¼Œè¿”å›å€¼å°±æ˜¯è¯»å–åˆ°çš„æ•°æ®ã€‚ </p><h4 id="å†™æ“ä½œå‡½æ•°"><a href="#å†™æ“ä½œå‡½æ•°" class="headerlink" title="å†™æ“ä½œå‡½æ•°"></a>å†™æ“ä½œå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">writeb</span><span class="params">(u8 value, <span class="keyword">volatile</span> <span class="type">void</span> __iomem *addr)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">writew</span><span class="params">(u16 value, <span class="keyword">volatile</span> <span class="type">void</span> __iomem *addr)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">writel</span><span class="params">(u32 value, <span class="keyword">volatile</span> <span class="type">void</span> __iomem *addr)</span></span><br></pre></td></tr></table></figure><p>å‚æ•° value æ˜¯è¦å†™å…¥çš„æ•°å€¼ï¼Œ addr æ˜¯è¦å†™å…¥çš„åœ°å€ã€‚ </p><h3 id="å†™LEDé©±åŠ¨ç¨‹åº"><a href="#å†™LEDé©±åŠ¨ç¨‹åº" class="headerlink" title="å†™LEDé©±åŠ¨ç¨‹åº"></a>å†™LEDé©±åŠ¨ç¨‹åº</h3><p>é¦–å…ˆåœ¨æ±‡ç¼–ç‚¹äº®LEDçš„ç¨‹åºé‡Œé¢ä½¿èƒ½äº†imx6ullçš„å¤–è®¾æ—¶é’Ÿï¼Œä½¿èƒ½GPIO1_03,é…ç½®äº†IOå£çš„å±æ€§ï¼Œä¹‹åè¿›è¡Œäº†åˆå§‹åŒ–ï¼ŒDRå¯„å­˜å™¨ç½®ä½ç‚¹ç¯ã€‚</p><p>LEDçš„é©±åŠ¨å¼€å‘é¦–å…ˆè¦æŸ¥å‡ºæ‰€è¦ç”¨åˆ°çš„å¯„å­˜å™¨çš„åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CCGR1çš„åœ°å€</span></span><br><span class="line">CCM_CCGR1<span class="number">20</span>C_406Ch</span><br><span class="line"><span class="comment">//GPIO1_03çš„åœ°å€</span></span><br><span class="line">IOMUXC_SW_PAD_CTL_PAD_GPIO1_IO03<span class="number">20</span>E_02F4h</span><br><span class="line">IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03<span class="number">20</span>E_0068h</span><br><span class="line">GPIO1_DR<span class="number">209</span>_C000h</span><br><span class="line">GPIO1_GDIR<span class="number">20</span>A_0004h</span><br></pre></td></tr></table></figure><p>GPIO1_DRå’ŒGPIO1_GPIRçš„åœ°å€å®åœ¨GPIO memory mapï¼ˆGPIOçš„åœ°å€æ˜ å°„ï¼‰ä¸­å¯»æ‰¾ã€‚</p><p><strong>DRï¼ˆdata registerï¼‰</strong>ï¼Œå³æ•°æ®å¯„å­˜å™¨ï¼Œå®ƒæ˜¯32ä½çš„ï¼Œä¸€ä¸ªGPIOç»„æœ€å¤§åªæœ‰32ä¸ªIOï¼Œå› æ­¤DRå¯„å­˜å™¨ä¸­çš„æ¯ä¸ªä½éƒ½å¯¹åº”ä¸€ä¸ª GPIOã€‚</p><ul><li>å½“GPIOè¢«é…ç½®ä¸º<strong>è¾“å‡ºæ¨¡å¼</strong>åï¼Œå‘æŒ‡å®šçš„ä½å†™å…¥æ•°æ®é‚£ä¹ˆç›¸åº”çš„IOå°±ä¼šè¾“å‡ºç›¸åº”çš„é«˜ä½ç”µå¹³ï¼Œä¾‹å¦‚ï¼Œè¦è®¾ç½®GPIO5_IO03è¾“å‡ºä½ç”µå¹³ï¼Œé‚£ä¹ˆå°±åº”è¯¥è®¾ç½® GPIO5.DR&#x3D;0x08ã€‚</li><li>å½“ GPIOè¢«é…ç½®ä¸º<strong>è¾“å…¥æ¨¡å¼</strong>åï¼Œæ­¤å¯„å­˜å™¨å°±ä¿å­˜ç€å¯¹åº”IOçš„ç”µå¹³å€¼ï¼Œæ¯ä¸ªä½å¯¹å¯¹åº”ä¸€ä¸ªGPIOï¼Œä¾‹å¦‚ï¼Œå½“GPIO5_IO03è¿™ä¸ªå¼•è„šæ¥åœ°çš„è¯ï¼Œé‚£ä¹ˆ GPIO5.DR çš„bit3å°±æ˜¯0ã€‚</li></ul><p><strong>GDIRï¼ˆGPIO direction registerï¼‰</strong>ï¼Œå³æ–¹å‘å¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯32ä½çš„ï¼Œç”¨æ¥è®¾ç½®æŸä¸ªGPIOçš„å·¥ä½œæ–¹å‘çš„ï¼Œå³è¾“å…¥&#x2F;è¾“å‡ºã€‚</p><p>åŒæ ·çš„ï¼Œæ¯ä¸ªIOå¯¹åº”ä¸€ä¸ªä½ï¼Œå¦‚æœè¦è®¾ç½®GPIOä¸ºè¾“å…¥ï¼Œå°±è®¾ç½®ç›¸åº”çš„ä½ä¸º0ï¼Œå¦‚æœè¦è®¾ç½®ä¸ºè¾“å‡ºï¼Œå°±è®¾ç½®ä¸º 1ã€‚</p><h3 id="ç¨‹åºä»¥åŠæ­å»ºæ€è·¯"><a href="#ç¨‹åºä»¥åŠæ­å»ºæ€è·¯" class="headerlink" title="ç¨‹åºä»¥åŠæ­å»ºæ€è·¯"></a>ç¨‹åºä»¥åŠæ­å»ºæ€è·¯</h3><h4 id="ledé©±åŠ¨æ­¥éª¤ï¼š"><a href="#ledé©±åŠ¨æ­¥éª¤ï¼š" class="headerlink" title="ledé©±åŠ¨æ­¥éª¤ï¼š"></a>ledé©±åŠ¨æ­¥éª¤ï¼š</h4><p>â‘ ã€ä¹¦å†™å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶ï¼Œæ·»åŠ å¤´æ–‡ä»¶ï¼Œå®šä¹‰file_operationsï¼Œä»¥åŠç›¸å…³å‡½æ•°æ¡†æ¶ã€‚<br>â‘¡ã€æ·»åŠ åœ°å€å®å®šä¹‰åˆ›å»ºæŒ‡é’ˆï¼Œä»¥åŠåœ¨å…¥å£å‡½æ•°ä¸­å®ç°è™šæ‹Ÿåœ°å€çš„æ˜ å°„ï¼Œæ³¨å†Œè®¾å¤‡ã€‚<br>â‘¢ã€åœ¨å‡ºæ¥å£åœ°å€ä¸­å–æ¶ˆè™šæ‹Ÿåœ°å€çš„æ˜ å°„ï¼Œæ³¨é”€è®¾å¤‡ã€‚<br>â‘£ã€åœ¨openå‡½æ•°ä¸­å®ç°GPIOçš„ä½¿èƒ½ï¼Œä»¥åŠIOå¼•è„šçš„é…ç½®ã€‚<br>â‘¤ã€åœ¨writeå‡½æ•°ä¸­ä»åº”ç”¨å±‚è·å–æ•°æ®ï¼Œæ¥æ ¹æ®æ•°æ®æ¥è¿›è¡ŒGPIOçš„è¾“å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_MAJOR200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>LED_NAME<span class="string">&quot;led&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>CCM_CCGR1_BASE(0X020C406C)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SW_PAD_GPIO1_IO03_BASE(0X020E02F4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SW_MUX_GPIO1_IO03_BASE(0X020E0068)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO1_DR_BASE(0X0209C000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO1_GDIR_BASE(0X0209C004)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> on1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>off0</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *CCM_CCGR1;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *SW_PAD_GPIO1_IO03;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *SW_MUX_GPIO1_IO03;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *GPIO1_DR;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __iomem *GPIO1_GDIR;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">led_switch</span><span class="params">(u8 sta)</span></span><br><span class="line">&#123;</span><br><span class="line">u32 num;</span><br><span class="line"><span class="keyword">if</span>(sta == on)</span><br><span class="line">&#123;</span><br><span class="line">num =readl(GPIO1_DR);</span><br><span class="line">num &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">writel( num, GPIO1_DR);</span><br><span class="line">printk(<span class="string">&quot;on\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(sta == off)</span><br><span class="line">&#123;</span><br><span class="line">num = readl(GPIO1_DR);</span><br><span class="line">num |= (<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">writel( num, GPIO1_DR);</span><br><span class="line">printk(<span class="string">&quot;off\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_dev_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_dev_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_dev_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_dev_write</span><span class="params">(<span class="keyword">struct</span> file *filp,<span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> val = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">1</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> state ;</span><br><span class="line"></span><br><span class="line">val = copy_from_user(databuf, buf, cnt);</span><br><span class="line"><span class="keyword">if</span>(val &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kernl write failed \r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">&#125;</span><br><span class="line">state = databuf[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(state == on)</span><br><span class="line">led_switch(on);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(state == off)</span><br><span class="line">led_switch(off);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">led_fops</span> =</span> &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.open = led_dev_open,</span><br><span class="line">.read = led_dev_read,</span><br><span class="line">.write = led_dev_write,</span><br><span class="line">.release = led_dev_release,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">u32 val = <span class="number">0</span>;</span><br><span class="line">CCM_CCGR1 = ioremap(CCM_CCGR1_BASE, <span class="number">4</span>);</span><br><span class="line">SW_MUX_GPIO1_IO03 = ioremap(SW_MUX_GPIO1_IO03_BASE, <span class="number">4</span>);</span><br><span class="line">SW_PAD_GPIO1_IO03 = ioremap(SW_PAD_GPIO1_IO03_BASE, <span class="number">4</span>);</span><br><span class="line">GPIO1_DR = ioremap(GPIO1_DR_BASE, <span class="number">4</span>); </span><br><span class="line">GPIO1_GDIR = ioremap(GPIO1_GDIR_BASE, <span class="number">4</span>);    </span><br><span class="line">val = readl(CCM_CCGR1);</span><br><span class="line">val &amp;= ~(<span class="number">3</span> &lt;&lt; <span class="number">26</span>);<span class="comment">//CCM_CCGR1çš„ç¬¬27å’Œ26ä½æ§åˆ¶GPIO1 clockçš„ä½¿èƒ½</span></span><br><span class="line">val |= (<span class="number">3</span> &lt;&lt; <span class="number">26</span>);</span><br><span class="line">writel(val, CCM_CCGR1);</span><br><span class="line"><span class="comment">//GPIOå¤ä½</span></span><br><span class="line">writel(<span class="number">5</span>,SW_MUX_GPIO1_IO03);</span><br><span class="line"><span class="comment">//é…ç½®ç”µå™¨å±æ€§ </span></span><br><span class="line">writel(<span class="number">0x10B0</span>, SW_PAD_GPIO1_IO03);</span><br><span class="line"><span class="comment">//é…ç½®è¾“å‡ºæ¨¡å¼</span></span><br><span class="line">val = readl(GPIO1_GDIR);</span><br><span class="line">val &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">val |= (<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">writel(val, GPIO1_GDIR);</span><br><span class="line">    <span class="comment">//é»˜è®¤å…³é—­led</span></span><br><span class="line">val = readl(GPIO1_DR);</span><br><span class="line">val |= (<span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">writel( val , GPIO1_DR);</span><br><span class="line">value = register_chrdev(LED_MAJOR, LED_NAME, &amp;led_fops);</span><br><span class="line"><span class="keyword">if</span>(value &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;led register failed\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -EIO;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">iounmap(CCM_CCGR1);</span><br><span class="line">iounmap(GPIO1_DR);</span><br><span class="line">iounmap(GPIO1_GDIR);</span><br><span class="line">iounmap(SW_PAD_GPIO1_IO03);</span><br><span class="line">iounmap(SW_MUX_GPIO1_IO03);</span><br><span class="line"><span class="comment">//æ³¨é”€ledè®¾å¤‡</span></span><br><span class="line">unregister_chrdev(LED_MAJOR, LED_NAME);</span><br><span class="line">printk(<span class="string">&quot;led exit\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(led_init);</span><br><span class="line">module_exit(led_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="åº”ç”¨å±‚ç¨‹åº"><a href="#åº”ç”¨å±‚ç¨‹åº" class="headerlink" title="åº”ç”¨å±‚ç¨‹åº"></a>åº”ç”¨å±‚ç¨‹åº</h4><p>æ­å»ºæ€è·¯ï¼š</p><p>â‘ ã€è·å–å‘½ä»¤è¡Œçš„æ•°æ®<br>â‘¡ã€æ‰“å¼€è®¾å¤‡<br>â‘¢ã€å†™å…¥æŒ‡ä»¤<br>â‘£ã€å…³é—­è®¾å¤‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;unistd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/types.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc , <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span>  value;</span><br><span class="line">    FILE *fp == <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span> *filename</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">1</span>];</span><br><span class="line">    filename = argv[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>((fp = fopen(filename, <span class="string">&quot;w+&quot;</span>))==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    perror(<span class="string">&quot;fopen error:&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶æ‰“å¼€æˆåŠŸ!\n&quot;</span>);</span><br><span class="line">    databuf[<span class="number">0</span>] = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">sizeof</span>(buf) &gt; fwrite(databuf, <span class="number">1</span>, <span class="keyword">sizeof</span>(databuf), fp))</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fwrite error\n&quot;</span>);</span><br><span class="line"> fclose(fp);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ•°æ®å†™å…¥æˆåŠŸ!\n&quot;</span>);</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line"> fclose(fp);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Makefileæ–‡ä»¶ç¼–å†™ï¼Œè·Ÿä¹‹å‰ä¸€æ ·ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">KERNELDIR := /home/moss/linux/imx-kernel/linux-fslc-4.9-2.0.x-imx</span><br><span class="line">CURRENT_PATH := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line">obj-m := led.o</span><br><span class="line"></span><br><span class="line"><span class="section">build: kernel_modules</span></span><br><span class="line"></span><br><span class="line"><span class="section">kernel_modules:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(CURRENT_PATH)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­—ç¬¦è®¾å¤‡é©±åŠ¨å¼€å‘</title>
      <link href="/2023/04/01/2023-4-1-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
      <url>/2023/04/01/2023-4-1-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h3 id="å­—ç¬¦è®¾å¤‡é©±åŠ¨ç®€ä»‹"><a href="#å­—ç¬¦è®¾å¤‡é©±åŠ¨ç®€ä»‹" class="headerlink" title="å­—ç¬¦è®¾å¤‡é©±åŠ¨ç®€ä»‹"></a>å­—ç¬¦è®¾å¤‡é©±åŠ¨ç®€ä»‹</h3><p>å­—ç¬¦è®¾å¤‡æ˜¯Linuxé©±åŠ¨åŸºæœ¬çš„ä¸€ç±»è®¾å¤‡é©±åŠ¨ï¼Œå­—ç¬¦è®¾å¤‡å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚ï¼ŒæŒ‰ç…§å­—èŠ‚æµè¿›è¡Œè¯»å†™æ“ä½œçš„è®¾å¤‡ï¼Œè¯»å†™æ•°æ®æ˜¯åˆ†å…ˆåé¡ºåºçš„ï¼›æ•°æ®æ˜¯å®æ—¶ä¼ è¾“çš„ï¼Œæ²¡æœ‰ç¼“å­˜ï¼Œå­—ç¬¦è®¾å¤‡æ˜¯æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿçš„ã€‚</p><p>ç»å¤§éƒ¨åˆ†è®¾å¤‡é©±åŠ¨æ˜¯å­—ç¬¦è®¾å¤‡ï¼šLEDã€æŒ‰é”®ã€å£°å¡ã€IICã€SPIã€LCDã€æ‘„åƒå¤´ç­‰éƒ½æ˜¯å­—ç¬¦è®¾å¤‡ã€‚è¿™äº›è®¾å¤‡çš„é©±åŠ¨éƒ½æ˜¯å­—ç¬¦è®¾å¤‡é©±åŠ¨ã€‚</p><p>åœ¨ Linux ä¸­ä¸€åˆ‡çš†ä¸ºæ–‡ä»¶ï¼Œé©±åŠ¨åŠ è½½æˆåŠŸä»¥åä¼šåœ¨â€œ&#x2F;devâ€ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªç›¸åº”çš„æ–‡ä»¶ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡å¯¹è¿™ä¸ªåä¸ºâ€œ&#x2F;dev&#x2F;xxxâ€ (xxx æ˜¯å…·ä½“çš„é©±åŠ¨æ–‡ä»¶åå­—)çš„æ–‡ä»¶è¿›è¡Œç›¸åº”çš„æ“ä½œå³å¯å®ç°å¯¹ç¡¬ä»¶çš„æ“ä½œã€‚ </p><p>åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œè€Œ Linux é©±åŠ¨å±äºå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤é©±åŠ¨è¿è¡Œäºå†…æ ¸ç©ºé—´ã€‚å½“æˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´æƒ³è¦å®ç°å¯¹å†…æ ¸çš„æ“ä½œï¼Œæ¯”å¦‚ä½¿ç”¨ open å‡½æ•°æ‰“å¼€&#x2F;dev&#x2F;led è¿™ä¸ªé©±åŠ¨ï¼Œå› ä¸ºç”¨æˆ·ç©ºé—´ä¸èƒ½ç›´æ¥å¯¹å†…æ ¸è¿›è¡Œæ“ä½œï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨ä¸€ä¸ªå«åšâ€œç³»ç»Ÿè°ƒç”¨â€çš„æ–¹æ³•æ¥å®ç°ä»ç”¨æˆ·ç©ºé—´â€œé™·å…¥â€ åˆ°å†…æ ¸ç©ºé—´ï¼Œè¿™æ ·æ‰èƒ½å®ç°å¯¹åº•å±‚é©±åŠ¨çš„æ“ä½œã€‚ </p><h3 id="é©±åŠ¨æ¨¡å—åŠ è½½å’Œå¸è½½"><a href="#é©±åŠ¨æ¨¡å—åŠ è½½å’Œå¸è½½" class="headerlink" title="é©±åŠ¨æ¨¡å—åŠ è½½å’Œå¸è½½"></a>é©±åŠ¨æ¨¡å—åŠ è½½å’Œå¸è½½</h3><p>Linux é©±åŠ¨æœ‰ä¸¤ç§è¿è¡Œæ–¹å¼ï¼Œç¬¬ä¸€ç§å°±æ˜¯å°†é©±åŠ¨ç¼–è¯‘è¿› Linux å†…æ ¸ä¸­ï¼Œè¿™æ ·å½“ Linux å†…æ ¸å¯åŠ¨çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨è¿è¡Œé©±åŠ¨ç¨‹åºã€‚ç¬¬äºŒç§å°±æ˜¯å°†é©±åŠ¨ç¼–è¯‘æˆæ¨¡å—(Linux ä¸‹æ¨¡å—æ‰©å±•åä¸º.ko)ï¼Œåœ¨Linux å†…æ ¸å¯åŠ¨ä»¥åä½¿ç”¨â€œinsmodâ€å‘½ä»¤åŠ è½½é©±åŠ¨æ¨¡å—ã€‚ </p><p>æ¨¡å—æœ‰åŠ è½½å’Œå¸è½½ä¸¤ç§æ“ä½œï¼Œæˆ‘ä»¬åœ¨ç¼–å†™é©±åŠ¨çš„æ—¶å€™éœ€è¦æ³¨å†Œè¿™ä¸¤ç§æ“ä½œå‡½æ•°ï¼Œæ¨¡å—çš„åŠ è½½å’Œå¸è½½æ³¨å†Œå‡½æ•°å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module_init(xxx_init); <span class="comment">//æ³¨å†Œæ¨¡å—åŠ è½½å‡½æ•°</span></span><br><span class="line">module_exit(xxx_exit); <span class="comment">//æ³¨å†Œæ¨¡å—å¸è½½å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>module_init å‡½æ•°ç”¨æ¥å‘ Linux å†…æ ¸æ³¨å†Œä¸€ä¸ªæ¨¡å—åŠ è½½å‡½æ•°ï¼Œå‚æ•° xxx_init å°±æ˜¯éœ€è¦æ³¨å†Œçš„å…·ä½“å‡½æ•°ï¼Œå½“ä½¿ç”¨â€œinsmodâ€å‘½ä»¤åŠ è½½é©±åŠ¨çš„æ—¶å€™ï¼Œ xxx_init è¿™ä¸ªå‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚ module_exit()å‡½æ•°ç”¨æ¥å‘ Linux å†…æ ¸æ³¨å†Œä¸€ä¸ªæ¨¡å—å¸è½½å‡½æ•°ï¼Œå‚æ•° xxx_exit å°±æ˜¯éœ€è¦æ³¨å†Œçš„å…·ä½“å‡½æ•°ï¼Œå½“ä½¿ç”¨â€œrmmodâ€å‘½ä»¤å¸è½½å…·ä½“é©±åŠ¨çš„æ—¶å€™ xxx_exit å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚ </p><p>ç¼–å†™ä¸€ä¸ªchrdevbaseçš„é©±åŠ¨</p><p>é¦–å…ˆæ ¹æ®åŠ è½½æ¨¡æ¿å†™å‡ºchrdevabase.cæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">chrdevbase_init</span><span class="params">(<span class="type">void</span>)</span><span class="comment">//é©±åŠ¨å­—ç¬¦å…¥å£å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">chrdevbase_exit</span><span class="params">(<span class="type">void</span>)</span><span class="comment">//é©±åŠ¨å‡ºå£å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">module_init(chrdevbase_init);</span><br><span class="line">module_exit(chrdevbase_exit);</span><br></pre></td></tr></table></figure><p>ç¼–å†™Makefile</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KERNELDIR := /home/moss/linux/imx-kernel/linux-fslc-4.9-2.0.x-imx</span><br><span class="line">CURRENT_PATH := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line">obj-m := chrdevbase.o</span><br><span class="line"><span class="section">build: kernel_modules</span></span><br><span class="line"><span class="section">kernel_modules:</span></span><br><span class="line"><span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(CURRENT_PATH)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line"><span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></table></figure><p>ç¬¬ 1 è¡Œï¼Œ KERNELDIR è¡¨ç¤ºå¼€å‘æ¿æ‰€ä½¿ç”¨çš„ Linux å†…æ ¸æºç ç›®å½•ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œå¤§å®¶æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µå¡«å†™å³å¯ã€‚<br>ç¬¬ 2 è¡Œï¼Œ CURRENT_PATH è¡¨ç¤ºå½“å‰è·¯å¾„ï¼Œç›´æ¥é€šè¿‡è¿è¡Œâ€œpwdâ€å‘½ä»¤æ¥è·å–å½“å‰æ‰€å¤„è·¯å¾„ã€‚<br>ç¬¬ 3 è¡Œï¼Œ obj-m è¡¨ç¤ºå°† chrdevbase.c è¿™ä¸ªæ–‡ä»¶ç¼–è¯‘ä¸º chrdevbase.ko æ¨¡å—ã€‚<br>ç¬¬ 86è¡Œï¼Œå…·ä½“çš„ç¼–è¯‘å‘½ä»¤ï¼Œåé¢çš„ modules è¡¨ç¤ºç¼–è¯‘æ¨¡å—ï¼Œ -C è¡¨ç¤ºå°†å½“å‰çš„å·¥ä½œç›®å½•åˆ‡æ¢åˆ°æŒ‡å®šç›®å½•ä¸­ï¼Œä¹Ÿå°±æ˜¯ KERNERLDIR ç›®å½•ã€‚ M è¡¨ç¤ºæ¨¡å—æºç ç›®å½•ï¼Œâ€œmake modulesâ€å‘½ä»¤ä¸­åŠ å…¥ M&#x3D;dir ä»¥åç¨‹åºä¼šè‡ªåŠ¨åˆ°æŒ‡å®šçš„ dir ç›®å½•ä¸­è¯»å–æ¨¡å—çš„æºç å¹¶å°†å…¶ç¼–è¯‘ä¸º.ko æ–‡ä»¶ã€‚ </p><p>ä¹‹ååœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­ä½¿ç”¨modprobeåŠ è½½æ¨¡å—å‘½ä»¤æ¥çœ‹ç¼ºå¤±çš„æ–‡ä»¶ï¼Œä¹‹åéƒ½åˆ›ç«‹å¥½ï¼Œå°†ç¼–è¯‘å¥½çš„.koæ–‡ä»¶å¤åˆ¶åˆ°ä¸‹é¢ï¼Œä¹‹åå¯ä½¿ç”¨modprobeå‘½ä»¤åŠ è½½è®¾å¤‡ï¼Œæˆ–è€…ä½¿ç”¨rmmodå¸è½½è®¾å¤‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modprobe chrdevbase.ko</span><br><span class="line">rmmod chrdevbase.ko</span><br></pre></td></tr></table></figure><p>åœ¨æ¿å­çš„å‘½ä»¤æ®µä½¿ç”¨ã€‚</p><h3 id="å­—ç¬¦è®¾å¤‡æ³¨å†Œä¸æ³¨é”€"><a href="#å­—ç¬¦è®¾å¤‡æ³¨å†Œä¸æ³¨é”€" class="headerlink" title="å­—ç¬¦è®¾å¤‡æ³¨å†Œä¸æ³¨é”€"></a>å­—ç¬¦è®¾å¤‡æ³¨å†Œä¸æ³¨é”€</h3><p>å¯¹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨è€Œè¨€ï¼Œå½“é©±åŠ¨æ¨¡å—åŠ è½½æˆåŠŸä»¥åéœ€è¦æ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼ŒåŒæ ·ï¼Œå¸è½½é©±åŠ¨æ¨¡å—çš„æ—¶å€™ä¹Ÿéœ€è¦æ³¨é”€æ‰å­—ç¬¦è®¾å¤‡ã€‚å­—ç¬¦è®¾å¤‡çš„æ³¨å†Œå’Œæ³¨é”€å‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤º: </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">register_chrdev</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> major, <span class="type">const</span> <span class="type">char</span> *name,<span class="type">const</span> <span class="keyword">struct</span> file_operations *fops)</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">unregister_chrdev</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> major, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br></pre></td></tr></table></figure><p>majorï¼š ä¸»è®¾å¤‡å·ï¼Œ Linux ä¸‹æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªè®¾å¤‡å·ï¼Œè®¾å¤‡å·åˆ†ä¸ºä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ä¸¤éƒ¨åˆ†ï¼Œå…³äºè®¾å¤‡å·åé¢ä¼šè¯¦ç»†è®²è§£ã€‚<br>nameï¼šè®¾å¤‡åå­—ï¼ŒæŒ‡å‘ä¸€ä¸²å­—ç¬¦ä¸²ã€‚æŸ¥çœ‹è®¾å¤‡ä¸­çš„è®¾å¤‡å·å¯ä»¥ä½¿ç”¨â€œ<strong>cat &#x2F;proc&#x2F;devices</strong> â€æ¥æŸ¥çœ‹ã€‚<br>fopsï¼š ç»“æ„ä½“ file_operations ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘è®¾å¤‡çš„æ“ä½œå‡½æ•°é›†åˆå˜é‡ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">                                        <span class="comment">/*file_operationsç»“æ„ä½“*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="type">loff_t</span> (*llseek) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line"><span class="type">ssize_t</span> (*read) (<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line"><span class="type">ssize_t</span> (*write) (<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line"><span class="type">ssize_t</span> (*read_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line"><span class="type">ssize_t</span> (*write_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line"><span class="type">int</span> (*iterate) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*poll)</span> <span class="params">(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *)</span>;</span><br><span class="line"><span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line"><span class="type">int</span> (*mmap) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line"><span class="type">int</span> (*mremap)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line"><span class="type">int</span> (*open) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line"><span class="type">int</span> (*flush) (<span class="keyword">struct</span> file *, <span class="type">fl_owner_t</span> id);</span><br><span class="line"><span class="type">int</span> (*release) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line"><span class="type">int</span> (*fsync) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span> datasync);</span><br><span class="line"><span class="type">int</span> (*aio_fsync) (<span class="keyword">struct</span> kiocb *, <span class="type">int</span> datasync);</span><br><span class="line"><span class="type">int</span> (*fasync) (<span class="type">int</span>, <span class="keyword">struct</span> file *, <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*lock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line"><span class="type">ssize_t</span> (*sendpage) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *, <span class="type">int</span>, <span class="type">size_t</span>, <span class="type">loff_t</span> *, <span class="type">int</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, unsignedlong)</span>;</span><br><span class="line"><span class="type">int</span> (*check_flags)(<span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*flock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line"><span class="type">ssize_t</span> (*splice_write)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">ssize_t</span> (*splice_read)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="keyword">struct</span> pipe_inode_info *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"><span class="type">int</span> (*setlease)(<span class="keyword">struct</span> file *, <span class="type">long</span>, <span class="keyword">struct</span> file_lock **, <span class="type">void</span> **);</span><br><span class="line"><span class="type">long</span> (*fallocate)(<span class="keyword">struct</span> file *file, <span class="type">int</span> mode, <span class="type">loff_t</span> offset,<span class="type">loff_t</span> len);</span><br><span class="line"><span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line"><span class="type">unsigned</span> (*mmap_capabilities)(<span class="keyword">struct</span> file *);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶"><a href="#å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶" class="headerlink" title="å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶"></a>å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶</h3><p>è®¾å¤‡çš„å…·ä½“æ“ä½œå‡½æ•°å°±æ˜¯é€šè¿‡file_operationsç»“æ„ä½“æ¥è¿›è¡Œè®¾ç½®ï¼Œé¦–å…ˆåˆå§‹åŒ–ä¹‹å‰è¦è¿›è¡Œåˆ†æéœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯å¯¹chrtestè¿™ä¸ªè®¾å¤‡è¿›è¡Œå“ªäº›æ“ä½œï¼Œæ‰çŸ¥é“è¦å®ç°å“ªäº›æ“ä½œå‡½æ•°ã€‚æ­¤è®¾ç½®æ˜¯å‡è®¾å¯¹å­—ç¬¦è®¾å¤‡è¿›è¡Œæ‰“å¼€å’Œå…³é—­æ“ä½œï¼ˆåŸºæœ¬è®¾å¤‡éƒ½è¦æ‰“å¼€å…³é—­ï¼‰ï¼Œå¯¹å­—ç¬¦è®¾å¤‡è¿›è¡Œè¯»å†™ï¼ˆå‡è®¾  è¿™ä¸ªè®¾å¤‡æ§åˆ¶ç€ä¸€æ®µç¼“å†²åŒº(å†…å­˜)ï¼Œåº”ç”¨ç¨‹åºéœ€è¦é€šè¿‡ read å’Œ write è¿™ä¸¤ä¸ªå‡½æ•°å¯¹ chrtest çš„ç¼“å†²åŒºè¿›è¡Œè¯»å†™æ“ä½œ ï¼‰ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-03%20172521.png"></p><p>æ‰€ä»¥è¿›è¡Œä¿®æ”¹chrdevbase.cæ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">chrtest_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">chrtest_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">chrtest_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf , <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">chrtest_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">test_fops</span> =</span> &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">    .open = chrtest_open,</span><br><span class="line">    .read = chrtest_read,</span><br><span class="line">    .write = chrtest_write,</span><br><span class="line">    .release = chrtest_release,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">chrdevbase_init</span><span class="params">(<span class="type">void</span>)</span><span class="comment">//é©±åŠ¨å­—ç¬¦å…¥å£å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    value = register_chrdev(<span class="number">200</span>, <span class="string">&quot;chrtest&quot;</span>, &amp;test_fops);</span><br><span class="line">    <span class="keyword">if</span>(value &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    printk(<span class="string">&quot;æ³¨å†Œå¤±è´¥\n&quot;</span>);<span class="comment">//å†…æ ¸ç©ºé—´çš„printf</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">chrdevbase_exit</span><span class="params">(<span class="type">void</span>)</span><span class="comment">//é©±åŠ¨å‡ºå£å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">    unregister_chrdev(<span class="number">200</span>, <span class="string">&quot;chrtest&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(chrdevbase_init);</span><br><span class="line">module_exit(chrdevbase_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);<span class="comment">//é˜²æ­¢åŠ è½½æ¨¡å—è­¦å‘Š</span></span><br></pre></td></tr></table></figure><h3 id="å…³äºè®¾å¤‡å·ç "><a href="#å…³äºè®¾å¤‡å·ç " class="headerlink" title="å…³äºè®¾å¤‡å·ç "></a>å…³äºè®¾å¤‡å·ç </h3><h4 id="é™æ€åˆ†é…è®¾å¤‡å·"><a href="#é™æ€åˆ†é…è®¾å¤‡å·" class="headerlink" title="é™æ€åˆ†é…è®¾å¤‡å·"></a>é™æ€åˆ†é…è®¾å¤‡å·</h4><p>æ³¨å†Œå­—ç¬¦è®¾å¤‡çš„æ—¶å€™éœ€è¦ç»™è®¾å¤‡æŒ‡å®šä¸€ä¸ªè®¾å¤‡å·ï¼Œè¿™ä¸ªè®¾å¤‡å·å¯ä»¥æ˜¯é©±åŠ¨å¼€å‘è€…é™æ€çš„æŒ‡å®šä¸€ä¸ªè®¾å¤‡å·ï¼Œæ¯”å¦‚é€‰æ‹© 200 è¿™ä¸ªä¸»è®¾å¤‡å·ã€‚æœ‰ä¸€äº›å¸¸ç”¨çš„è®¾å¤‡å·å·²ç»è¢« Linux å†…æ ¸å¼€å‘è€…ç»™åˆ†é…æ‰äº†ï¼Œå…·ä½“åˆ†é…çš„å†…å®¹å¯ä»¥æŸ¥çœ‹æ–‡æ¡£ Documentation&#x2F;devices.txtã€‚å¹¶ä¸æ˜¯è¯´å†…æ ¸å¼€å‘è€…å·²ç»åˆ†é…æ‰çš„ä¸»è®¾å¤‡å·æˆ‘ä»¬å°±ä¸èƒ½ç”¨äº†ï¼Œå…·ä½“èƒ½ä¸èƒ½ç”¨è¿˜å¾—çœ‹æˆ‘ä»¬çš„ç¡¬ä»¶å¹³å°è¿è¡Œè¿‡ç¨‹ä¸­æœ‰æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªä¸»è®¾å¤‡å·ï¼Œã€‚</p><h4 id="åŠ¨æ€åˆ†é…è®¾å¤‡å·"><a href="#åŠ¨æ€åˆ†é…è®¾å¤‡å·" class="headerlink" title="åŠ¨æ€åˆ†é…è®¾å¤‡å·"></a>åŠ¨æ€åˆ†é…è®¾å¤‡å·</h4><p>é™æ€åˆ†é…è®¾å¤‡å·éœ€è¦æˆ‘ä»¬æ£€æŸ¥å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰è¢«ä½¿ç”¨äº†çš„è®¾å¤‡å·ï¼Œç„¶åæŒ‘é€‰ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨çš„ã€‚è€Œä¸”é™æ€åˆ†é…è®¾å¤‡å·å¾ˆå®¹æ˜“å¸¦æ¥å†²çªé—®é¢˜ï¼Œ Linux ç¤¾åŒºæ¨èä½¿ç”¨åŠ¨æ€åˆ†é…è®¾å¤‡å·ï¼Œåœ¨æ³¨å†Œå­—ç¬¦è®¾å¤‡ä¹‹å‰å…ˆç”³è¯·ä¸€ä¸ªè®¾å¤‡å·ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç»™ä½ ä¸€ä¸ªæ²¡æœ‰è¢«ä½¿ç”¨çš„è®¾å¤‡å·ï¼Œè¿™æ ·å°±é¿å…äº†å†²çªã€‚å¸è½½é©±åŠ¨çš„æ—¶å€™é‡Šæ”¾æ‰è¿™ä¸ªè®¾å¤‡å·å³å¯ï¼Œ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">alloc_chrdev_region</span><span class="params">(<span class="type">dev_t</span> *dev, <span class="type">unsigned</span> baseminor, <span class="type">unsigned</span> count, <span class="type">const</span> <span class="type">char</span> *name)</span><span class="comment">//ç”³è¯·å‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">unregister_chrdev_region</span><span class="params">(<span class="type">dev_t</span> from, <span class="type">unsigned</span> count)</span><span class="comment">//é‡Šæ”¾å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>ç”³è¯·è®¾å¤‡å‡½æ•°æœ‰ 4 ä¸ªå‚æ•°ï¼š<br>devï¼šä¿å­˜ç”³è¯·åˆ°çš„è®¾å¤‡å·ã€‚<br>baseminorï¼š æ¬¡è®¾å¤‡å·èµ·å§‹åœ°å€ï¼Œ alloc_chrdev_region å¯ä»¥ç”³è¯·ä¸€æ®µè¿ç»­çš„å¤šä¸ªè®¾å¤‡å·ï¼Œè¿™äº›è®¾å¤‡å·çš„ä¸»è®¾å¤‡å·ä¸€æ ·ï¼Œä½†æ˜¯æ¬¡è®¾å¤‡å·ä¸åŒï¼Œæ¬¡è®¾å¤‡å·ä»¥ baseminor ä¸ºèµ·å§‹åœ°å€åœ°å€å¼€å§‹é€’å¢ã€‚ä¸€èˆ¬ baseminor ä¸º 0ï¼Œä¹Ÿå°±æ˜¯è¯´æ¬¡è®¾å¤‡å·ä» 0 å¼€å§‹ã€‚<br>countï¼š è¦ç”³è¯·çš„è®¾å¤‡å·æ•°é‡ã€‚<br>nameï¼šè®¾å¤‡åå­—ã€‚<br>é‡Šæ”¾å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼š<br>fromï¼šè¦é‡Šæ”¾çš„è®¾å¤‡å·ã€‚<br>countï¼š è¡¨ç¤ºä» from å¼€å§‹ï¼Œè¦é‡Šæ”¾çš„è®¾å¤‡å·æ•°é‡ã€‚ </p><h3 id="å®ç°ä¾‹ç¨‹"><a href="#å®ç°ä¾‹ç¨‹" class="headerlink" title="å®ç°ä¾‹ç¨‹"></a>å®ç°ä¾‹ç¨‹</h3><p>åº”ç”¨ç¨‹åºè°ƒç”¨ open å‡½æ•°æ‰“å¼€ chrdevbase è¿™ä¸ªè®¾å¤‡ï¼Œæ‰“å¼€ä»¥åå¯ä»¥ä½¿ç”¨ write å‡½æ•°å‘chrdevbase çš„å†™ç¼“å†²åŒº writebuf ä¸­å†™å…¥æ•°æ®(ä¸è¶…è¿‡ 100 ä¸ªå­—èŠ‚)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ read å‡½æ•°è¯»å–è¯»ç¼“å†²åŒº readbuf ä¸­çš„æ•°æ®æ“ä½œï¼Œæ“ä½œå®Œæˆä»¥ååº”ç”¨ç¨‹åºä½¿ç”¨ close å‡½æ•°å…³é—­ chrdevbase è®¾å¤‡ã€‚ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="type">static</span><span class="type">char</span> readbuf[<span class="number">100</span>];</span><br><span class="line"><span class="type">static</span><span class="type">char</span>writebuf[<span class="number">100</span>];</span><br><span class="line"><span class="type">static</span><span class="type">char</span>kerneldata[] = &#123;<span class="string">&quot;kernel data&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">chrdev_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;open devices\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">chrdev_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;release devices\n&quot;</span>)ï¼›</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">chrdev_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//å‘ç”¨æˆ·ç©ºé—´å‘é€ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">memcpy</span>(readbuf, kerneldata, <span class="keyword">sizeof</span>(kerneldata));<span class="comment">//å°†kerneldataçš„sizeofä¸ªæ•°æ®å¤åˆ¶readbuf</span></span><br><span class="line">value = copy_to_user(buf, readbuf, cnt);</span><br><span class="line">    <span class="keyword">if</span>(value == <span class="number">0</span>)</span><br><span class="line">        printk(<span class="string">&quot;kernel senddata ok\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        printk(<span class="string">&quot;kernel senddata failed&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">chrdev_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> retvalue = <span class="number">0</span>;</span><br><span class="line">    retvalue  = copy_from_user(writebuf, buf, cnt);</span><br><span class="line">    <span class="keyword">if</span>(retvalue == <span class="number">0</span>)</span><br><span class="line">        printk(<span class="string">&quot;kernel recedata :%s ok\n&quot;</span>, writebuf);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        printk(<span class="string">&quot;kernel recedata failed\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">chrdevbase_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = chrdev_open,</span><br><span class="line">    .read = chrdev_read,</span><br><span class="line">    .write = chrdev_write,</span><br><span class="line">    .release = chrdev_release,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">chrdevbase_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> retvalue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ */</span></span><br><span class="line">retvalue = register_chrdev(<span class="number">200</span>, <span class="string">&quot;chrdevbase&quot;</span>, &amp;chrdevbase_fops);</span><br><span class="line"><span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>)&#123;</span><br><span class="line">printk(<span class="string">&quot;chrdevbase driver register failed\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">chrdevbase_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//å¸è½½é©±åŠ¨</span></span><br><span class="line">    unregister_chrdev(<span class="number">200</span>, <span class="string">&quot;chrdevbase&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">module_init(chrdevbase_init);</span><br><span class="line">module_exit(chrdevbase_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="copy-to-user-x2F-copy-from-userå‡½æ•°è§£æ"><a href="#copy-to-user-x2F-copy-from-userå‡½æ•°è§£æ" class="headerlink" title="copy_to_user&#x2F;copy_from_userå‡½æ•°è§£æ"></a>copy_to_user&#x2F;copy_from_userå‡½æ•°è§£æ</h4><p>copy_to_userå’Œcopy_from_useræ˜¯åœ¨è¿›è¡Œé©±åŠ¨ç›¸å…³ç¨‹åºè®¾è®¡çš„æ—¶å€™ï¼Œè¦ç»å¸¸é‡åˆ°çš„å‡½æ•°ã€‚<strong>ç”±äºå†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´çš„å†…å­˜ä¸èƒ½ç›´æ¥äº’è®¿ï¼Œå› æ­¤å€ŸåŠ©å‡½æ•°copy_to_user()å®Œæˆå†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„å¤åˆ¶ï¼Œå‡½æ•°copy_from_user()å®Œæˆç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„å¤åˆ¶ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">copy_to_user</span> <span class="params">(<span class="type">void</span> __user * to, <span class="type">const</span> <span class="type">void</span> * from, <span class="type">unsigned</span> <span class="type">long</span> n)</span>;</span><br><span class="line">toç›®æ ‡åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯ç”¨æˆ·ç©ºé—´çš„åœ°å€</span><br><span class="line">fromæºåœ°å€  ï¼Œè¿™ä¸ªåœ°å€æ˜¯å†…æ ¸ç©ºé—´çš„åœ°å€</span><br><span class="line">nè¦æ‹·è´æ•°æ®çš„å­—èŠ‚æ•°</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">copy_from_user</span> <span class="params">(<span class="type">void</span> * to, <span class="type">const</span> <span class="type">void</span> __user * from, <span class="type">unsigned</span> <span class="type">long</span> n)</span>;</span><br><span class="line">toç›®æ ‡åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯ç”¨æˆ·ç©ºé—´çš„åœ°å€</span><br><span class="line">fromæºåœ°å€  ï¼Œè¿™ä¸ªåœ°å€æ˜¯å†…æ ¸ç©ºé—´çš„åœ°å€</span><br><span class="line">nè¦æ‹·è´æ•°æ®çš„å­—èŠ‚æ•°</span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™æµ‹è¯•APP"><a href="#ç¼–å†™æµ‹è¯•APP" class="headerlink" title="ç¼–å†™æµ‹è¯•APP"></a>ç¼–å†™æµ‹è¯•APP</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;unistd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> usrdata[] = &#123;<span class="string">&quot;usr data!&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description : main ä¸»ç¨‹åº</span></span><br><span class="line"><span class="comment"> * @param - argc : argv æ•°ç»„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"><span class="comment"> * @param - argv : å…·ä½“å‚æ•°</span></span><br><span class="line"><span class="comment"> * @return : 0 æˆåŠŸ;å…¶ä»– å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> fd, retvalue;</span><br><span class="line"><span class="type">char</span> *filename;</span><br><span class="line"><span class="type">char</span> readbuf[<span class="number">100</span>], writebuf[<span class="number">100</span>];</span><br><span class="line"><span class="keyword">if</span>(argc != <span class="number">3</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Error Usage!\r\n&quot;</span>);</span><br><span class="line"> <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filename = argv[<span class="number">1</span>];</span><br><span class="line"><span class="comment">/* æ‰“å¼€é©±åŠ¨æ–‡ä»¶ */</span></span><br><span class="line">fd = open(filename, O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t open file %s\r\n&quot;</span>, filename);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(atoi(argv[<span class="number">2</span>]) == <span class="number">1</span>)&#123; <span class="comment">/* ä»é©±åŠ¨æ–‡ä»¶è¯»å–æ•°æ® */</span></span><br><span class="line">retvalue = read(fd, readbuf, <span class="number">50</span>);</span><br><span class="line"><span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;read file %s failed!\r\n&quot;</span>, filename);</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="comment">/* è¯»å–æˆåŠŸï¼Œæ‰“å°å‡ºè¯»å–æˆåŠŸçš„æ•°æ® */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;read data:%s\r\n&quot;</span>,readbuf);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(atoi(argv[<span class="number">2</span>]) == <span class="number">2</span>)&#123;</span><br><span class="line"><span class="comment">/* å‘è®¾å¤‡é©±åŠ¨å†™æ•°æ® */</span></span><br><span class="line"><span class="built_in">memcpy</span>(writebuf, usrdata, <span class="keyword">sizeof</span>(usrdata));</span><br><span class="line">retvalue = write(fd, writebuf, <span class="number">50</span>);</span><br><span class="line"><span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;write file %s failed!\r\n&quot;</span>, filename);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">/* å…³é—­è®¾å¤‡ */</span></span><br><span class="line">    retvalue = close(fd);</span><br><span class="line"><span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t close file %s\r\n&quot;</span>, filename);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº¤å‰ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-gcc chrdevbaseApp.c -o chrdevbaseApp</span><br></pre></td></tr></table></figure><p>æŠŠchrdevbaseAppä¹Ÿå¤åˆ¶åˆ°é‚£ä¸ªæ–‡ä»¶å¤¹ä¸­ã€‚</p><p><strong>åˆ›å»ºè®¾å¤‡è®¾å¤‡èŠ‚ç‚¹</strong></p><p>é©±åŠ¨åŠ è½½æˆåŠŸéœ€è¦åœ¨&#x2F;dev ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶ï¼Œåº”ç”¨ç¨‹åºå°±æ˜¯é€šè¿‡æ“è¿™ä¸ªè®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶æ¥å®Œæˆå¯¹å…·ä½“è®¾å¤‡çš„æ“ä½œã€‚è¾“å…¥å¦‚ä¸‹å‘½ä»¤åˆ›å»º&#x2F;dev&#x2F;chrdevbase è¿™ä¸ªè®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶ ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mknod /dev/chrdevbase c 200 0</span><br><span class="line">ls /dev/chrdevbase -l</span><br><span class="line">/chrdevbaseApp /dev/chrdevbase 1 //è¿›è¡Œæµ‹è¯•</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é©±åŠ¨å¼€å‘æµç¨‹</title>
      <link href="/2023/03/31/2023-3-31-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/"/>
      <url>/2023/03/31/2023-3-31-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h3 id="åµŒå…¥å¼linuxé©±åŠ¨å¼€å‘æµç¨‹"><a href="#åµŒå…¥å¼linuxé©±åŠ¨å¼€å‘æµç¨‹" class="headerlink" title="åµŒå…¥å¼linuxé©±åŠ¨å¼€å‘æµç¨‹"></a>åµŒå…¥å¼linuxé©±åŠ¨å¼€å‘æµç¨‹</h3><p>åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œæ“ä½œç³»ç»Ÿæ˜¯é€šè¿‡å„ç§é©±åŠ¨ç¨‹åºæ¥é©¾é©­ç¡¬ä»¶è®¾å¤‡çš„ã€‚è®¾å¤‡é©±åŠ¨ç¨‹åºæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸å’Œç¡¬ä»¶è®¾å¤‡ä¹‹é—´çš„æ¥å£ï¼Œå®ƒä¸ºåº”ç”¨ç¨‹åºå±è”½äº†ç¡¬ä»¶çš„ç»†èŠ‚ï¼Œè¿™æ ·åœ¨åº”ç”¨ç¨‹åºçœ‹æ¥ï¼Œç¡¬ä»¶è®¾å¤‡åªæ˜¯ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œå¯ä»¥åƒæ“ä½œæ™®é€šæ–‡ä»¶ä¸€æ ·å¯¹ç¡¬ä»¶è®¾å¤‡è¿›è¡Œæ“ä½œã€‚è®¾å¤‡é©±åŠ¨ç¨‹åºæ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œå®Œæˆä»¥ä¸‹åŠŸèƒ½ï¼š<br>â—‡ é©±åŠ¨ç¨‹åºçš„æ³¨å†Œå’Œæ³¨é”€ã€‚<br>â—‡ è®¾å¤‡çš„æ‰“å¼€å’Œé‡Šæ”¾ã€‚<br>â—‡ è®¾å¤‡çš„è¯»å†™æ“ä½œã€‚<br>â—‡ è®¾å¤‡çš„æ§åˆ¶æ“ä½œã€‚<br>â—‡ è®¾å¤‡çš„ä¸­æ–­å’Œè½®è¯¢å¤„ç†ã€‚</p><p>åœ¨ Linux ä¸­ä¸€åˆ‡çš†ä¸ºæ–‡ä»¶ï¼Œé©±åŠ¨åŠ è½½æˆåŠŸä»¥åä¼šåœ¨â€œ&#x2F;devâ€ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªç›¸åº”çš„æ–‡ä»¶ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡å¯¹è¿™ä¸ªåä¸ºâ€œ&#x2F;dev&#x2F;xxxâ€ (xxx æ˜¯å…·ä½“çš„é©±åŠ¨æ–‡ä»¶åå­—)çš„æ–‡ä»¶è¿›è¡Œç›¸åº”çš„æ“ä½œå³å¯å®ç°å¯¹ç¡¬ä»¶çš„æ“ä½œã€‚ </p><p><strong>åº”ç”¨ç¨‹åºå¯¹é©±åŠ¨ç¨‹åºçš„è°ƒç”¨ä¸ºï¼šåº”ç”¨ç¨‹åº-&gt;åº“-&gt;å†…æ ¸-&gt;é©±åŠ¨ç¨‹åº-&gt;ç¡¬ä»¶</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/e588edd3300840379caa5357296b7c58.png"></p><p>Linuxä¸»è¦å°†è®¾å¤‡åˆ†ä¸ºä¸‰ç±»ï¼šå­—ç¬¦è®¾å¤‡ã€å—è®¾å¤‡å’Œç½‘ç»œè®¾å¤‡ã€‚å­—ç¬¦è®¾å¤‡æ˜¯æŒ‡å‘é€å’Œæ¥æ”¶æ•°æ®ä»¥å­—ç¬¦çš„å½¢å¼è¿›è¡Œï¼Œæ²¡æœ‰ç¼“å†²åŒºçš„è®¾å¤‡ï¼›å—è®¾å¤‡æ˜¯æŒ‡å‘é€å’Œæ¥æ”¶æ•°æ®ä»¥æ•´ä¸ªæ•°æ®ç¼“å†²åŒºçš„å½¢å¼è¿›è¡Œçš„è®¾å¤‡ï¼›ç½‘ç»œè®¾å¤‡æ˜¯æŒ‡ç½‘ç»œè®¾å¤‡è®¿é—®çš„BSD socket æ¥å£ã€‚</p><p><strong>åŸºäºæ“ä½œç³»ç»Ÿçš„é©±åŠ¨å°±æ˜¯åœ¨æ— æ“ä½œç³»ç»Ÿä¸‹çš„ç¡¬ä»¶æ¥å£å‡½æ•°åŠ ä¸Šæ“ä½œç³»ç»Ÿå¤–å¥—</strong></p><p>å®ç°ä¸€ä¸ªåµŒå…¥å¼Linuxè®¾å¤‡é©±åŠ¨ç¨‹åºçš„å¤§è‡´æµç¨‹å¦‚ä¸‹:<br>(l)æŸ¥çœ‹åŸç†å›¾ï¼Œç†è§£è®¾å¤‡çš„å·¥ä½œåŸç†ã€‚<br>(2)å®šä¹‰ä¸»è®¾å¤‡å·ã€‚è®¾å¤‡ç”±ä¸€ä¸ªä¸»è®¾å¤‡å·å’Œä¸€ä¸ªæ¬¡è®¾å¤‡å·æ¥æ ‡è¯†ã€‚ä¸»è®¾å¤‡å·å”¯ä¸€æ ‡è¯†äº†è®¾å¤‡ç±»å‹ï¼Œå³è®¾å¤‡é©±åŠ¨ç¨‹åºç±»å‹ï¼Œå®ƒæ˜¯å—è®¾å¤‡è¡¨æˆ–å­—ç¬¦è®¾å¤‡è¡¨ä¸­è®¾å¤‡è¡¨é¡¹çš„ç´¢å¼•ã€‚æ¬¡è®¾å¤‡å·ä»…ç”±è®¾å¤‡é©±åŠ¨ç¨‹åºè§£é‡Šï¼ŒåŒºåˆ†è¢«ä¸€ä¸ªè®¾å¤‡é©±åŠ¨æ§åˆ¶ä¸‹çš„æŸä¸ªç‹¬ç«‹çš„è®¾å¤‡ã€‚<br>(3)å®ç°åˆå§‹åŒ–å‡½æ•°ã€‚åœ¨é©±åŠ¨ç¨‹åºä¸­å®ç°é©±åŠ¨çš„æ³¨å†Œå’Œå¸è½½ã€‚<br>(4)è®¾è®¡æ‰€è¦å®ç°çš„æ–‡ä»¶æ“ä½œï¼Œå®šä¹‰fileâ€“operationsç»“æ„ã€‚<br>(5)å®ç°æ‰€éœ€çš„æ–‡ä»¶æ“ä½œè°ƒç”¨ï¼Œå¦‚readï¼Œwriteç­‰ã€‚<br>(6)å®ç°ä¸­æ–­æœåŠ¡ï¼Œå¹¶ç”¨requestâ€“irqå‘å†…æ ¸æ³¨å†Œï¼Œä¸­æ–­å¹¶ä¸æ˜¯æ¯ä¸ªè®¾å¤‡é©±åŠ¨æ‰€å¿…éœ€çš„ã€‚<br>(7)ç¼–è¯‘è¯¥é©±åŠ¨ç¨‹åºåˆ°å†…æ ¸ä¸­ï¼Œæˆ–è€…ç”¨insmodå‘½ä»¤åŠ è½½æ¨¡å—ã€‚<br>(8)æµ‹è¯•è¯¥è®¾å¤‡ï¼Œç¼–å†™åº”ç”¨ç¨‹åºï¼Œå¯¹é©±åŠ¨ç¨‹åºè¿›è¡Œæµ‹è¯•ã€‚</p><h4 id="é©±åŠ¨å¼€å‘å¥—è·¯"><a href="#é©±åŠ¨å¼€å‘å¥—è·¯" class="headerlink" title="é©±åŠ¨å¼€å‘å¥—è·¯"></a>é©±åŠ¨å¼€å‘å¥—è·¯</h4><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/20200227155905995.png"></p><h3 id="linuxå†…å­˜ç®¡ç†"><a href="#linuxå†…å­˜ç®¡ç†" class="headerlink" title="linuxå†…å­˜ç®¡ç†"></a>linuxå†…å­˜ç®¡ç†</h3><p><a href="https://blog.csdn.net/yusiguyuan/article/details/12045255?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168023029416800186520924%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168023029416800186520924&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-12045255-null-null.142%5Ev80%5Einsert_down38,201%5Ev4%5Eadd_ask,239%5Ev2%5Einsert_chatgpt&utm_term=linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86--%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%92%8C%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4&spm=1018.2226.3001.4187">linuxå†…å­˜ç®¡ç†â€“ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´_é±¼æ€æ•…æ¸Šçš„åšå®¢-CSDNåšå®¢</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> é©±åŠ¨å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ ¹æ–‡ä»¶ç³»ç»Ÿæ„å»º</title>
      <link href="/2023/03/30/2023-3-30-%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/"/>
      <url>/2023/03/30/2023-3-30-%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h3 id="æ ¹æ–‡ä»¶ç³»ç»Ÿå®šä¹‰"><a href="#æ ¹æ–‡ä»¶ç³»ç»Ÿå®šä¹‰" class="headerlink" title="æ ¹æ–‡ä»¶ç³»ç»Ÿå®šä¹‰"></a>æ ¹æ–‡ä»¶ç³»ç»Ÿå®šä¹‰</h3><p>æ ¹æ–‡ä»¶ç³»ç»Ÿé¦–å…ˆæ˜¯å†…æ ¸å¯åŠ¨æ—¶æ‰€ mount(æŒ‚è½½)çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå†…æ ¸ä»£ç æ˜ åƒæ–‡ä»¶ä¿å­˜åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œè€Œç³»ç»Ÿå¼•å¯¼å¯åŠ¨ç¨‹åºä¼šåœ¨æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¹‹åä»ä¸­æŠŠä¸€äº›åŸºæœ¬çš„åˆå§‹åŒ–è„šæœ¬å’ŒæœåŠ¡ç­‰åŠ è½½åˆ°å†…å­˜ä¸­å»è¿è¡Œã€‚ </p><p>æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ Linux å†…æ ¸å¯åŠ¨ä»¥åæŒ‚è½½(mount)çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åä»æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–åˆå§‹åŒ–è„šæœ¬ï¼Œæ¯”å¦‚ rcSï¼Œ inittab ç­‰ã€‚æ ¹æ–‡ä»¶ç³»ç»Ÿå’Œ Linux å†…æ ¸æ˜¯åˆ†å¼€çš„ï¼Œå•ç‹¬çš„ Linux å†…æ ¸æ˜¯æ²¡æ³•æ­£å¸¸å·¥ä½œçš„ï¼Œå¿…é¡»è¦æ­é…æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚ </p><h4 id="å¸¸ç”¨å­ç›®å½•"><a href="#å¸¸ç”¨å­ç›®å½•" class="headerlink" title="å¸¸ç”¨å­ç›®å½•"></a>å¸¸ç”¨å­ç›®å½•</h4><table><thead><tr><th align="left">ç›®å½•</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="left">&#x2F;bin</td><td align="center">å­˜æ”¾å¯æ‰§è¡Œæ–‡ä»¶ä¸€èˆ¬éƒ½æ˜¯å‘½ä»¤</td></tr><tr><td align="left">&#x2F;dev</td><td align="center">è®¾å¤‡æ–‡ä»¶</td></tr><tr><td align="left">&#x2F;etc</td><td align="center">å„ç§é…ç½®æ–‡ä»¶</td></tr><tr><td align="left">&#x2F;lib</td><td align="center">linuxæ‰€éœ€çš„å¿…å¤‡åº“æ–‡ä»¶ï¼ˆå…±äº«åº“ï¼‰</td></tr><tr><td align="left">&#x2F;mnt</td><td align="center">ä¸´æ—¶æŒ‚è½½ç›®å½•ï¼ˆä¸€èˆ¬ä¸ºç©ºï¼‰</td></tr><tr><td align="left">&#x2F;proc</td><td align="center">ä½œä¸º proc æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ï¼ˆæ–‡ä»¶æ˜¯ä¸´æ—¶å­˜åœ¨çš„ï¼Œä¸€èˆ¬å­˜å‚¨ç³»ç»Ÿè¿è¡Œä¿¡æ¯æ–‡ä»¶ï¼‰</td></tr><tr><td align="left">&#x2F;usr</td><td align="center">Unix æ“ä½œç³»ç»Ÿè½¯ä»¶èµ„æºç›®å½•</td></tr><tr><td align="left">&#x2F;var</td><td align="center">å­˜æ”¾ä¸€äº›å¯ä»¥æ”¹å˜çš„æ•°æ®</td></tr><tr><td align="left">&#x2F;sbin</td><td align="center">æ­¤ç›®å½•é¡µç”¨æˆ·å­˜æ”¾ä¸€äº›å¯æ‰§è¡Œæ–‡ä»¶</td></tr><tr><td align="left">&#x2F;sys</td><td align="center">æ­¤ç›®å½•ä½œä¸º sysfs æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹</td></tr><tr><td align="left">&#x2F;opt</td><td align="center">å¯é€‰çš„æ–‡ä»¶ã€è½¯ä»¶å­˜æ”¾åŒºï¼ˆç”¨æˆ·é€‰æ‹©æ”¾å“ªäº›ï¼‰</td></tr></tbody></table><h3 id="BusyBoxæ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ"><a href="#BusyBoxæ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="BusyBoxæ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ"></a>BusyBoxæ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ</h3><h4 id="é¡¶å±‚Makefileä¿®æ”¹"><a href="#é¡¶å±‚Makefileä¿®æ”¹" class="headerlink" title="é¡¶å±‚Makefileä¿®æ”¹"></a>é¡¶å±‚Makefileä¿®æ”¹</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">164 CROSS_COMPILE ?= /usr/local/arm/gcc/bin/arm-linux-gnueabihf-</span><br><span class="line">......</span><br><span class="line">190 ARCH ?= arm</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹busyboxæ”¯æŒä¸­æ–‡å­—ç¬¦"><a href="#ä¿®æ”¹busyboxæ”¯æŒä¸­æ–‡å­—ç¬¦" class="headerlink" title="ä¿®æ”¹busyboxæ”¯æŒä¸­æ–‡å­—ç¬¦"></a>ä¿®æ”¹busyboxæ”¯æŒä¸­æ–‡å­—ç¬¦</h4><p>æ‰“å¼€&#x2F;libbb&#x2F;printable_string.c </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span> <span class="type">const</span> <span class="type">char</span>* FAST_FUNC <span class="title function_">printable_string</span><span class="params">(<span class="type">uni_stat_t</span> *stats, <span class="type">const</span> <span class="type">char</span></span></span><br><span class="line"><span class="params">*str)</span></span><br><span class="line">13 &#123;</span><br><span class="line"><span class="number">14</span> <span class="type">char</span> *dst;</span><br><span class="line"><span class="number">15</span> <span class="type">const</span> <span class="type">char</span> *s;</span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span> s = str;</span><br><span class="line"><span class="number">18</span> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">......</span><br><span class="line"><span class="number">30</span> <span class="keyword">if</span> (c &lt; <span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="number">31</span> <span class="keyword">break</span>;</span><br><span class="line"><span class="number">32</span> <span class="comment">/* æ³¨é‡Šæ‰ä¸‹é¢è¿™ä¸ªä¸¤è¡Œä»£ç  */</span></span><br><span class="line"><span class="number">33</span> <span class="comment">/* if (c &gt;= 0x7f)</span></span><br><span class="line"><span class="comment">34 break; */</span></span><br><span class="line"><span class="number">35</span> s++;</span><br><span class="line"><span class="number">36</span> &#125;</span><br><span class="line"><span class="number">37</span></span><br><span class="line"><span class="number">38</span> <span class="meta">#<span class="keyword">if</span> ENABLE_UNICODE_SUPPORT</span></span><br><span class="line"><span class="number">39</span> dst = unicode_conv_to_printable(stats, str);</span><br><span class="line"><span class="number">40</span> <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="number">41</span> &#123;</span><br><span class="line"><span class="number">42</span> <span class="type">char</span> *d = dst = xstrdup(str);</span><br><span class="line"><span class="number">43</span> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">44</span> <span class="type">unsigned</span> <span class="type">char</span> c = *d;</span><br><span class="line"><span class="number">45</span> <span class="keyword">if</span> (c == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line"><span class="number">46</span> <span class="keyword">break</span>;</span><br><span class="line"><span class="number">47</span> <span class="comment">/* ä¿®æ”¹ä¸‹é¢ä»£ç  */</span></span><br><span class="line"><span class="number">48</span> <span class="comment">/* if (c &lt; &#x27; &#x27; || c &gt;= 0x7f) */</span></span><br><span class="line"><span class="number">49</span> <span class="keyword">if</span>( c &lt; <span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="number">50</span> *d = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line"><span class="number">51</span> d++;</span><br><span class="line"><span class="number">52</span> &#125;</span><br><span class="line">......</span><br><span class="line"><span class="number">59</span> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">60</span> <span class="keyword">return</span> auto_string(dst);</span><br><span class="line"><span class="number">61</span> &#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æ‰“å¼€æ–‡ä»¶ busybox-1.29.0&#x2F;libbb&#x2F;unicode.c </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1003</span> <span class="type">static</span> <span class="type">char</span>* FAST_FUNC <span class="title function_">unicode_conv_to_printable2</span><span class="params">(<span class="type">uni_stat_t</span> *stats, <span class="type">const</span> <span class="type">char</span> *src, <span class="type">unsigned</span> width, <span class="type">int</span> flags)</span></span><br><span class="line">1004 &#123;</span><br><span class="line"><span class="number">1005</span> <span class="type">char</span> *dst;</span><br><span class="line"><span class="number">1006</span> <span class="type">unsigned</span> dst_len;</span><br><span class="line"><span class="number">1007</span> <span class="type">unsigned</span> uni_count;</span><br><span class="line"><span class="number">1008</span> <span class="type">unsigned</span> uni_width;</span><br><span class="line"><span class="number">1009</span></span><br><span class="line"><span class="number">1010</span> <span class="keyword">if</span> (unicode_status != UNICODE_ON) &#123;</span><br><span class="line"><span class="number">1011</span> <span class="type">char</span> *d;</span><br><span class="line"><span class="number">1012</span> <span class="keyword">if</span> (flags &amp; UNI_FLAG_PAD) &#123;</span><br><span class="line"><span class="number">1013</span> d = dst = xmalloc(width + <span class="number">1</span>);</span><br><span class="line">......</span><br><span class="line"><span class="number">1022</span> <span class="comment">/* ä¿®æ”¹ä¸‹é¢ä¸€è¡Œä»£ç  */</span></span><br><span class="line"><span class="number">1023</span> <span class="comment">/* *d++ = (c &gt;= &#x27; &#x27; &amp;&amp; c &lt; 0x7f) ? c : &#x27;?&#x27;; */</span></span><br><span class="line"><span class="number">1024</span> *d++ = (c &gt;= <span class="string">&#x27; &#x27;</span>) ? c : <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line"><span class="number">1025</span> src++;</span><br><span class="line"><span class="number">1026</span> &#125;</span><br><span class="line"><span class="number">1027</span> *d = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="number">1028</span> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1029</span> d = dst = xstrndup(src, width);</span><br><span class="line"><span class="number">1030</span> <span class="keyword">while</span> (*d) &#123;</span><br><span class="line"><span class="number">1031</span> <span class="type">unsigned</span> <span class="type">char</span> c = *d;</span><br><span class="line"><span class="number">1032</span> <span class="comment">/* ä¿®æ”¹ä¸‹é¢ä¸€è¡Œä»£ç  */</span></span><br><span class="line"><span class="number">1033</span> <span class="comment">/* if (c &lt; &#x27; &#x27; || c &gt;= 0x7f) */</span></span><br><span class="line"><span class="number">1034</span> <span class="keyword">if</span>(c &lt; <span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="number">1035</span> *d = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line"><span class="number">1036</span> d++;</span><br><span class="line"><span class="number">1037</span> &#125;</span><br><span class="line"><span class="number">1038</span> &#125;</span><br><span class="line">......</span><br><span class="line"><span class="number">1044</span> <span class="keyword">return</span> dst;</span><br><span class="line"><span class="number">1045</span> &#125;</span><br><span class="line">......</span><br><span class="line"><span class="number">1047</span></span><br><span class="line"><span class="number">1048</span> <span class="keyword">return</span> dst;</span><br><span class="line"><span class="number">1049</span> &#125;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®busybox"><a href="#é…ç½®busybox" class="headerlink" title="é…ç½®busybox"></a>é…ç½®busybox</h4><p>è¦å…ˆå¯¹ busybox è¿›è¡Œé»˜è®¤çš„é…ç½®ï¼Œæœ‰ä»¥ä¸‹å‡ ç§é…ç½®é€‰é¡¹ï¼š </p><p>â‘ defconfigï¼Œç¼ºçœé…ç½®ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤é…ç½®é€‰é¡¹ã€‚<br>â‘¡allyesconfigï¼Œå…¨é€‰é…ç½®ï¼Œä¹Ÿå°±æ˜¯é€‰ä¸­ busybox çš„æ‰€æœ‰åŠŸèƒ½ã€‚<br>â‘¢allnoconfigï¼Œæœ€å°é…ç½®ã€‚ </p><p>ä¹Ÿå¯ä»¥å›¾å½¢åŒ–é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p>é…ç½®è·¯å¾„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Location:</span><br><span class="line">-&gt; Settings</span><br><span class="line">-&gt; Build static binary (no shared libs)</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªé€‰é¡¹ä¸é€‰ã€‚</strong></p><p>é€‰é¡¹â€œBuild static binary (no shared libs)â€ç”¨æ¥å†³å®šæ˜¯é™æ€ç¼–è¯‘ busybox è¿˜æ˜¯åŠ¨æ€ç¼–è¯‘ï¼Œé™æ€ç¼–è¯‘çš„è¯å°±ä¸éœ€è¦åº“æ–‡ä»¶ï¼Œä½†æ˜¯ç¼–è¯‘å‡ºæ¥çš„åº“ä¼šå¾ˆå¤§ã€‚åŠ¨æ€ç¼–è¯‘çš„è¯è¦æ±‚æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰åº“æ–‡ä»¶ï¼Œä½†æ˜¯ç¼–è¯‘å‡ºæ¥çš„ busybox ä¼šå°å¾ˆå¤šã€‚ä¸èƒ½é‡‡ç”¨é™æ€ç¼–è¯‘ï¼å› ä¸ºé‡‡ç”¨é™æ€ç¼–è¯‘çš„è¯ DNS ä¼šå‡ºé—®é¢˜ï¼æ— æ³•è¿›è¡ŒåŸŸåè§£æ ã€‚</p><p>ç»§ç»­é…ç½®ï¼Œé€‰ä¸Šã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Location:</span><br><span class="line">-&gt; Settings</span><br><span class="line">-&gt; vi-style line editing commands</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Location:</span><br><span class="line">-&gt; Linux Module Utilities</span><br><span class="line">-&gt; Simplified modutils</span><br></pre></td></tr></table></figure><p>ä¸é€‰simplified modutils</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Location:</span><br><span class="line">-&gt; Linux System Utilities</span><br><span class="line">-&gt; mdev (16 kb) //ç¡®ä¿ä¸‹é¢çš„å…¨éƒ¨é€‰ä¸­ï¼Œé»˜è®¤éƒ½æ˜¯é€‰ä¸­çš„</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-28%20212143.png"></p><p>æœ€åä½¿èƒ½busyboxçš„unicodeç¼–ç æ”¯æŒä¸­æ–‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Location:</span><br><span class="line">-&gt; Settings</span><br><span class="line">-&gt; Support Unicode //é€‰ä¸­</span><br><span class="line">-&gt; Check $LC_ALL, $LC_CTYPE and $LANG environment variables //é€‰ä¸­</span><br></pre></td></tr></table></figure><h4 id="ç¼–è¯‘busybox"><a href="#ç¼–è¯‘busybox" class="headerlink" title="ç¼–è¯‘busybox"></a>ç¼–è¯‘busybox</h4><p>è¦å°†ç¼–è¯‘ç»“æœå­˜æ”¾åˆ°å‰é¢åˆ›å»ºçš„ rootfs ç›®å½•ä¸­ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install CONFIG_PREFIX=/home/moss/linux/nfs/rootfs</span><br></pre></td></tr></table></figure><p>busybox çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œä½†æ˜¯æ­¤æ—¶çš„æ ¹æ–‡ä»¶ç³»ç»Ÿè¿˜ä¸èƒ½ä½¿ç”¨ï¼Œè¿˜éœ€è¦ä¸€äº›å…¶ä»–çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬ç»§ç»­æ¥å®Œå–„ rootfsã€‚ </p><h4 id="å‘æ ¹æ–‡ä»¶ç³»ç»Ÿæ·»åŠ -lib-åº“"><a href="#å‘æ ¹æ–‡ä»¶ç³»ç»Ÿæ·»åŠ -lib-åº“" class="headerlink" title="å‘æ ¹æ–‡ä»¶ç³»ç»Ÿæ·»åŠ  lib åº“"></a>å‘æ ¹æ–‡ä»¶ç³»ç»Ÿæ·»åŠ  lib åº“</h4><p>Linux ä¸­çš„åº”ç”¨ç¨‹åºä¸€èˆ¬éƒ½æ˜¯éœ€è¦åŠ¨æ€åº“çš„ ã€‚æ‰€ä»¥åœ¨rootfsä¸­åˆ›å»ºä¸€ä¸ªlibæ–‡ä»¶å¤¹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir lib</span><br></pre></td></tr></table></figure><p>åº“æ–‡ä»¶ä»å“ªé‡Œæ¥å‘¢ï¼Ÿ lib åº“æ–‡ä»¶ä»äº¤å‰ç¼–è¯‘å™¨ä¸­è·å–ï¼Œå‰é¢æˆ‘ä»¬æ­å»ºäº¤å‰ç¼–è¯‘ç¯å¢ƒçš„æ—¶å€™å°†äº¤å‰ç¼–è¯‘å™¨å­˜æ”¾åˆ°äº†â€œ&#x2F;usr&#x2F;local&#x2F;arm&#x2F;â€ç›®å½•ä¸­ã€‚ </p><p>è¿›å…¥å¯¹åº”è·¯å¾„çš„ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd/usr/local/arm/gcc/arm-linux-gnueabihf/libc/lib</span><br></pre></td></tr></table></figure><p>æ­¤ç›®å½•ä¸‹æœ‰å¾ˆå¤šçš„* <strong>so</strong>*(*<em>æ˜¯é€šé…ç¬¦)å’Œ.a æ–‡ä»¶ï¼Œè¿™äº›å°±æ˜¯åº“æ–‡ä»¶ï¼Œå°†æ­¤ç›®å½•ä¸‹æ‰€æœ‰çš„</em>so*å’Œ.aæ–‡ä»¶éƒ½æ‹·è´åˆ° rootfs&#x2F;lib ç›®å½•ä¸­ï¼Œæ‹·è´å‘½ä»¤å¦‚ä¸‹ï¼š </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp *so* *.a /home/moss/linux/nfs/rootfs/lib/ -d</span><br></pre></td></tr></table></figure><p>åé¢çš„â€œ-dâ€è¡¨ç¤ºæ‹·è´ç¬¦å·é“¾æ¥ï¼Œè¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„åº“æ–‡ä»¶ï¼š ld-linux-armhf.so.3ï¼Œæ­¤åº“æ–‡ä»¶ä¹Ÿæ˜¯ä¸ªç¬¦å·é“¾æ¥ï¼Œ</p><p>è¦æŠŠå®ƒå˜æˆæœ¬èº«çš„æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm ld-linux-armhf.so.3</span><br></pre></td></tr></table></figure><p>ç„¶ å é‡  è¿› å…¥ åˆ° &#x2F;usr&#x2F;local&#x2F;arm&#x2F;gcc&#x2F;armlinux-gnueabihf&#x2F;libc&#x2F;lib ç›®å½•ä¸­ï¼Œé‡æ–°æ‹·è´ ld-linux-armhf.so.3ï¼Œå‘½ä»¤ï¼š </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ld-linux-armhf.so.3 /home/moss/linux/nfs/rootfs/lib/</span><br></pre></td></tr></table></figure><p>ç»§ç»­è¿›å…¥å¦‚ä¸‹ç›®å½•ä¸­ï¼š </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd/usr/local/arm/gcc/arm-linux-gnueabihf/libc/lib</span><br><span class="line">cp *so* *.a /home/moss/linux/nfs/rootfs/lib/ -d</span><br></pre></td></tr></table></figure><p><strong>å‘rootfsçš„usr&#x2F;libç›®å½•æ·»åŠ åº“æ–‡ä»¶</strong></p><p>åœ¨ rootfs çš„ usr ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º lib çš„ç›®å½• ï¼Œä¹‹å‰arm-linux-gnueabihf&#x2F;usr&#x2F;libçš„soå’Œ.aåº“æ–‡ä»¶å¤åˆ¶åˆ°rootfs&#x2F;usr&#x2F;libç›®å½•ä¸­</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp *so* *.a /home/moss/linux/nfs/rootfs/usr/lib/ -d</span><br><span class="line">cd /home/moss/linux/nfs/rootfs//è¿›å…¥æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•</span><br><span class="line">du ./lib ./usr/lib/ -sh//æŸ¥çœ‹ lib å’Œ usr/lib è¿™ä¸¤ä¸ªç›®å½•çš„å¤§å°</span><br></pre></td></tr></table></figure><p>åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºå…¶ä»–æ–‡ä»¶å¤¹ï¼Œå¦‚ devã€ procã€ mntã€ sysã€ tmp å’Œ root ç­‰ .</p><h3 id="åˆæ­¥æµ‹è¯•æ ¹æ–‡ä»¶ç³»ç»Ÿ"><a href="#åˆæ­¥æµ‹è¯•æ ¹æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åˆæ­¥æµ‹è¯•æ ¹æ–‡ä»¶ç³»ç»Ÿ"></a>åˆæ­¥æµ‹è¯•æ ¹æ–‡ä»¶ç³»ç»Ÿ</h3><p>é¦–å…ˆä½¿ç”¨nfsæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œé¦–å…ˆç†Ÿæ‚‰bootargsç¯å¢ƒå˜é‡çš„rootå€¼çš„æ ¼å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root=/dev/nfs nfsroot=[&lt;server-ip&gt;:]&lt;root-dir&gt;[,&lt;nfs-options&gt;] ip=&lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gwip&gt;:&lt;netmask&gt;:&lt;hostname&gt;:&lt;device&gt;:&lt;autoconf&gt;:&lt;dns0-ip&gt;:&lt;dns1-ip&gt;</span><br></pre></td></tr></table></figure><p><server-ip>ï¼šæœåŠ¡å™¨IPåœ°å€ã€‚ï¼ˆä¹Ÿå°±æ˜¯Ubuntuçš„IPï¼‰</p><p><root-dir>ï¼šæ ¹æ–‡ä»¶ç³»ç»Ÿå­˜æ”¾è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯rootfsçš„ç»å¯¹è·¯å¾„ï¼Œå¯ç”¨pwdå‘½ä»¤æŸ¥è¯¢ã€‚</p><p><nfs-options>ï¼šNFSçš„å…¶ä»–é€‰é¡¹ä¸€èˆ¬ä¸ç”¨ã€‚</p><p><client-ip>ï¼šå¼€å‘æ¿IPåœ°å€</p><p><server-ip>ï¼šæœåŠ¡å™¨IP</p><p><gw-ip>ï¼šç½‘å…³åœ°å€ï¼Œæˆ‘çš„æ˜¯192.168.1.1</p><p><netmask>ï¼šå­ç½‘æ©ç ï¼Œ255.255.255.0</p><p><hostname>ï¼šå®¢æˆ·æœºåå­—ï¼Œä¸€èˆ¬ä¸ç”¨</p><p><device>ï¼šç½‘å¡åå­—ï¼šä¸€èˆ¬eth0,eht1,ä¹‹ç±»çš„</p><p><autoconf>ï¼šè‡ªåŠ¨é…ç½®ï¼Œä¸€èˆ¬ä¸ºoff</p><p><dns0-ip>ï¼šDNS0æœåŠ¡å™¨IPåœ°å€ï¼Œä¸ä½¿ç”¨</p><p><dns1-ip>ï¼šDNS1æœåŠ¡å™¨IPåœ°å€ï¼Œä¸ä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;console=ttymxc0,115200 root=/dev/nfs nfsroot=192.168.1.115:</span><br><span class="line">/home/moss/linux/nfs/rootfs,proto=tcp rw ip=192.168.1.114:192.168.1.115:192.168.1.1:</span><br><span class="line">255.255.255.0::eth0:off&#x27; </span><br></pre></td></tr></table></figure><h3 id="å®Œå–„æ ¹æ–‡ä»¶ç³»ç»Ÿ"><a href="#å®Œå–„æ ¹æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="å®Œå–„æ ¹æ–‡ä»¶ç³»ç»Ÿ"></a>å®Œå–„æ ¹æ–‡ä»¶ç³»ç»Ÿ</h3><p>Linux å†…æ ¸å¯åŠ¨ä»¥åéœ€è¦å¯åŠ¨ä¸€äº›æœåŠ¡ï¼Œ<u>è€Œ rcS å°±æ˜¯è§„å®šå¯åŠ¨å“ªäº›æ–‡ä»¶çš„è„šæœ¬æ–‡ä»¶</u>ã€‚åœ¨ rootfs ä¸­åˆ›å»º&#x2F;etc&#x2F;init.d&#x2F;rcS æ–‡ä»¶ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1 #!/bin/sh</span><br><span class="line">2 </span><br><span class="line">3 PATH=/sbin:/bin:/usr/sbin:/usr/bin:$PATH</span><br><span class="line">4 LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib:/usr/lib</span><br><span class="line">5 export PATH LD_LIBRARY_PATH</span><br><span class="line">6</span><br><span class="line">7 mount -a</span><br><span class="line">8 mkdir /dev/pts</span><br><span class="line">9 mount -t devpts devpts /dev/pts</span><br><span class="line">10</span><br><span class="line">11 echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class="line">12 mdev -s</span><br></pre></td></tr></table></figure><p>ç¬¬ 1 è¡Œï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª shell è„šæœ¬ã€‚<br>ç¬¬ 3 è¡Œï¼Œ PATH ç¯å¢ƒå˜é‡ä¿å­˜ç€å¯æ‰§è¡Œæ–‡ä»¶å¯èƒ½å­˜åœ¨çš„ç›®å½•ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨æ‰§è¡Œä¸€äº›å‘½ä»¤æˆ–è€…å¯æ‰§è¡Œæ–‡ä»¶çš„æ—¶å€™å°±ä¸ä¼šæç¤ºæ‰¾ä¸åˆ°æ–‡ä»¶è¿™æ ·çš„é”™è¯¯ã€‚<br>ç¬¬ 4 è¡Œï¼Œ LD_LIBRARY_PATH ç¯å¢ƒå˜é‡ä¿å­˜ç€åº“æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ã€‚<br>ç¬¬ 5 è¡Œï¼Œä½¿ç”¨ export æ¥å¯¼å‡ºä¸Šé¢è¿™äº›ç¯å¢ƒå˜é‡ï¼Œç›¸å½“äºå£°æ˜ä¸€äº›â€œå…¨å±€å˜é‡â€ã€‚<br>ç¬¬ 7 è¡Œï¼Œä½¿ç”¨ mount å‘½ä»¤æ¥æŒ‚è½½æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™äº›æ–‡ä»¶ç³»ç»Ÿç”±æ–‡ä»¶&#x2F;etc&#x2F;fstab æ¥æŒ‡å®šï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€ä¼šè¿˜è¦åˆ›å»º&#x2F;etc&#x2F;fstab æ–‡ä»¶ã€‚<br>ç¬¬ 8 å’Œ 9 è¡Œï¼Œåˆ›å»ºç›®å½•&#x2F;dev&#x2F;ptsï¼Œç„¶åå°† devpts æŒ‚è½½åˆ°&#x2F;dev&#x2F;pts ç›®å½•ä¸­ã€‚<br>ç¬¬ 11 å’Œ 12 è¡Œï¼Œä½¿ç”¨ mdev æ¥ç®¡ç†çƒ­æ’æ‹”è®¾å¤‡ï¼Œé€šè¿‡è¿™ä¸¤è¡Œï¼Œ Linux å†…æ ¸å°±å¯ä»¥åœ¨&#x2F;dev ç›®å½•ä¸‹è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ã€‚ </p><p>ä½¿ç”¨chmodç»™äºˆ&#x2F;ec&#x2F;init.d&#x2F;rcS å¯æ‰§è¡Œæƒé™</p><h4 id="åˆ›å»º-x2F-etc-x2F-fstab-æ–‡ä»¶"><a href="#åˆ›å»º-x2F-etc-x2F-fstab-æ–‡ä»¶" class="headerlink" title="åˆ›å»º&#x2F;etc&#x2F;fstab æ–‡ä»¶"></a>åˆ›å»º&#x2F;etc&#x2F;fstab æ–‡ä»¶</h4><p><u>fstab åœ¨ Linux å¼€æœºä»¥åè‡ªåŠ¨é…ç½®å“ªäº›éœ€è¦è‡ªåŠ¨æŒ‚è½½çš„åˆ†åŒº</u>ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;file system&gt; &lt;mount point&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;</span><br></pre></td></tr></table></figure><p><file system>ï¼šè¦æŒ‚è½½çš„ç‰¹æ®Šçš„è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥æ˜¯å—è®¾å¤‡ï¼Œæ¯”å¦‚&#x2F;dev&#x2F;sda </p><p><mount point>ï¼šæŒ‚è½½ç‚¹ã€‚</p><p><type>ï¼šæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œæ¯”å¦‚ ext2ã€ ext3ã€ procã€ romfsã€ tmpfs ç­‰ç­‰ã€‚</p><p><options>ï¼šæŒ‚è½½é€‰é¡¹ï¼Œåœ¨ Ubuntu ä¸­è¾“å…¥â€œman mountâ€å‘½ä»¤å¯ä»¥æŸ¥çœ‹å…·ä½“çš„é€‰é¡¹ã€‚ä¸€èˆ¬ä½¿ç”¨ defaultsï¼Œä¹Ÿå°±æ˜¯é»˜è®¤é€‰é¡¹ï¼Œ </p><p>defaults åŒ…å«äº† rwã€ suidã€ devã€ execã€ autoã€ nouser å’Œ asyncã€‚</p><p><dump>ï¼šä¸º 1 çš„è¯è¡¨ç¤ºå…è®¸å¤‡ä»½ï¼Œä¸º 0 ä¸å¤‡ä»½ï¼Œä¸€èˆ¬ä¸å¤‡ä»½ï¼Œå› æ­¤è®¾ç½®ä¸º 0ã€‚</p><p><pass>ï¼šç£ç›˜æ£€æŸ¥è®¾ç½®ï¼Œä¸º 0 è¡¨ç¤ºä¸æ£€æŸ¥ã€‚æ ¹ç›®å½•â€˜&#x2F;â€™è®¾ç½®ä¸º 1ï¼Œå…¶ä»–çš„éƒ½ä¸èƒ½è®¾ç½®ä¸º 1ï¼Œå…¶ä»–çš„åˆ†åŒºä» 2 å¼€å§‹ã€‚ä¸€èˆ¬ä¸åœ¨ </p><p>fstab ä¸­æŒ‚è½½æ ¹ç›®å½•ï¼Œå› æ­¤è¿™é‡Œä¸€èˆ¬è®¾ç½®ä¸º 0ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#&lt;file system&gt; &lt;mount point&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;</span><br><span class="line">proc /proc  proc defaults  0  0</span><br><span class="line">tmpfs /tmp  tmpfs defaults  0  0</span><br><span class="line">sysfs /sys  sysfs defaults  0  0</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»º-x2F-etc-x2F-inittab-æ–‡ä»¶"><a href="#åˆ›å»º-x2F-etc-x2F-inittab-æ–‡ä»¶" class="headerlink" title="åˆ›å»º&#x2F;etc&#x2F;inittab æ–‡ä»¶"></a>åˆ›å»º&#x2F;etc&#x2F;inittab æ–‡ä»¶</h4><p>init ç¨‹åºä¼šè¯»å–&#x2F;etc&#x2F;inittabè¿™ä¸ªæ–‡ä»¶ï¼Œ inittab ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆã€‚æ¯æ¡æŒ‡ä»¤çš„ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç”±ä»¥â€œ:â€åˆ†éš”çš„ 4 ä¸ªæ®µç»„æˆï¼Œæ ¼å¼å¦‚ä¸‹ï¼š </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;</span><br></pre></td></tr></table></figure><p><id>ï¼šæ¯ä¸ªæŒ‡ä»¤çš„æ ‡è¯†ç¬¦ï¼Œä¸èƒ½é‡å¤ã€‚ä½†æ˜¯å¯¹äº busybox çš„ init æ¥è¯´ï¼Œ <id>æœ‰ç€ç‰¹æ®Šæ„ä¹‰ã€‚å¯¹äº busybox è€Œè¨€<id>ç”¨æ¥æŒ‡å®šå¯åŠ¨è¿›ç¨‹çš„æ§åˆ¶ ttyï¼Œä¸€èˆ¬æˆ‘ä»¬å°†ä¸²å£æˆ–è€… LCD å±å¹•è®¾ç½®ä¸ºæ§åˆ¶ ttyã€‚</p><p><runlevels>ï¼š å¯¹ busybox æ¥è¯´æ­¤é¡¹å®Œå…¨æ²¡ç”¨ï¼Œæ‰€ä»¥ç©ºç€ã€‚</p><p><action>ï¼šåŠ¨ä½œï¼Œç”¨äºæŒ‡å®š<process>å¯èƒ½ç”¨åˆ°çš„åŠ¨ä½œã€‚ <process>ï¼š å…·ä½“çš„åŠ¨ä½œï¼Œæ¯”å¦‚ç¨‹åºã€è„šæœ¬æˆ–å‘½ä»¤ç­‰ã€‚åŠ¨ä½œè¡¨å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-29%20211432.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ç¤ºä¾‹ä»£ç  38.4.3.1 /etc/inittab æ–‡ä»¶</span><br><span class="line">1 #etc/inittab</span><br><span class="line">2 ::sysinit:/etc/init.d/rcS</span><br><span class="line">3 console::askfirst:-/bin/sh</span><br><span class="line">4 ::restart:/sbin/init</span><br><span class="line">5 ::ctrlaltdel:/sbin/reboot</span><br><span class="line">6 ::shutdown:/bin/umount -a -r</span><br><span class="line">7 ::shutdown:/sbin/swapoff -a</span><br></pre></td></tr></table></figure><p>ç¬¬ 2 è¡Œï¼Œç³»ç»Ÿå¯åŠ¨ä»¥åè¿è¡Œ&#x2F;etc&#x2F;init.d&#x2F;rcS è¿™ä¸ªè„šæœ¬æ–‡ä»¶ã€‚<br>ç¬¬ 3 è¡Œï¼Œå°† console ä½œä¸ºæ§åˆ¶å°ç»ˆç«¯ï¼Œä¹Ÿå°±æ˜¯ ttymxc0ã€‚<br>ç¬¬ 4 è¡Œï¼Œé‡å¯çš„è¯è¿è¡Œ&#x2F;sbin&#x2F;initã€‚<br>ç¬¬ 5 è¡Œï¼ŒæŒ‰ä¸‹ ctrl+alt+del ç»„åˆé”®çš„è¯å°±è¿è¡Œ&#x2F;sbin&#x2F;rebootï¼Œçœ‹æ¥ ctrl+alt+del ç»„åˆé”®ç”¨äºé‡å¯ç³»ç»Ÿã€‚<br>ç¬¬ 6 è¡Œï¼Œå…³æœºçš„æ—¶å€™æ‰§è¡Œ&#x2F;bin&#x2F;umountï¼Œä¹Ÿå°±æ˜¯å¸è½½å„ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚<br>ç¬¬ 7 è¡Œï¼Œå…³æœºçš„æ—¶å€™æ‰§è¡Œ&#x2F;sbin&#x2F;swapoffï¼Œä¹Ÿå°±æ˜¯å…³é—­äº¤æ¢åˆ†åŒºã€‚ </p>]]></content>
      
      
      
        <tags>
            
            <tag> ç³»ç»Ÿç§»æ¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…æ ¸ç§»æ¤</title>
      <link href="/2023/03/28/2023-3-28-%E5%86%85%E6%A0%B8%E7%A7%BB%E6%A4%8D/"/>
      <url>/2023/03/28/2023-3-28-%E5%86%85%E6%A0%B8%E7%A7%BB%E6%A4%8D/</url>
      
        <content type="html"><![CDATA[<h3 id="å†…æ ¸ç§»æ¤"><a href="#å†…æ ¸ç§»æ¤" class="headerlink" title="å†…æ ¸ç§»æ¤"></a>å†…æ ¸ç§»æ¤</h3><p>é¦–å…ˆæ˜¯è¦å°†å®˜æ–¹çš„æ¿è½½å†…æ ¸è¿›è¡Œä¸‹è½½ï¼Œåœ¨å…¶ä¹‹ä¸Šè¿›è¡Œæ”¹åŠ¨æ¥æ”¯æŒè‡ªå·±çš„æ¿å­ã€‚</p><p>ä¾‹å¦‚å¯ä»¥ä¸‹è½½nxpå…³äºimx6ullçš„linuxå†…æ ¸ï¼Œgithubçš„åœ°å€<a href="https://github.com/Freescale/linux-fslc/tree/5.4-2.1.x-imx">GitHub - Freescale&#x2F;linux-fslc at 5.4-2.1.x-imx</a></p><p>äº¤å‰ç¼–è¯‘å™¨ä½¿ç”¨çš„ä¸ºarm-linux-gnueabihf-</p><p>éšä¾¿å¼„ä¸€ä¸ªå†…æ ¸ä¸‹æ¥ï¼Œç¼–è¯‘é¡¶å±‚çš„Makefile</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ARCH?= arm</span><br><span class="line">CROSS_COMPILE?=arm-linux-gnueabihf-</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªåé¢ä¸è¦åŠ ç©ºæ ¼ç›´æ¥å›è½¦ï¼Œä¸ç„¶æ‰¾ä¸åˆ°äº¤å‰ç¼–è¯‘å™¨ã€‚</p><h4 id="æ·»åŠ è‡ªå·±çš„æ¿å­"><a href="#æ·»åŠ è‡ªå·±çš„æ¿å­" class="headerlink" title="æ·»åŠ è‡ªå·±çš„æ¿å­"></a>æ·»åŠ è‡ªå·±çš„æ¿å­</h4><p>ä¹‹åå¤åˆ¶ä¸€ä»½è‡ªå·±çš„é…ç½®æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cdarch/arm/configs</span><br><span class="line">ls</span><br><span class="line">cpimx_v7_mfg_defonfig imx_alientek_emmc_defconfig</span><br></pre></td></tr></table></figure><p>ä¹‹åè¿›å…¥arch&#x2F;arm&#x2F;boot&#x2F;dtsï¼Œå¤åˆ¶ä¸€ä»½imx6ull-14x14-evk.dts</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp imx6ull-14x14-evk.dts imx6ull-alientek-emmc.dts</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹makefileçš„dtb-$(CONFIG_SOC_IMX6ULL)çš„å†…å®¹ï¼Œæ·»åŠ è®¾å¤‡æ ‘</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-28%20103201.png"></p><p>ä¹‹åè¿”å›é¡¶å±‚ç¼–è¯‘å·¥ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makedistclean</span><br><span class="line">makeimx_alientek_emmc_defconfig</span><br><span class="line">make-j8</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„-j8æ˜¯å› ä¸ºæˆ‘çš„è™šæ‹Ÿæœºå°±åªæœ‰8ä¸ªå¤„ç†å™¨</p><h4 id="ä¿®æ”¹æ¿å­ä¸»é¢‘"><a href="#ä¿®æ”¹æ¿å­ä¸»é¢‘" class="headerlink" title="ä¿®æ”¹æ¿å­ä¸»é¢‘"></a>ä¿®æ”¹æ¿å­ä¸»é¢‘</h4><p>åœ¨ä¸²å£è½¯ä»¶ä¾‹å¦‚æˆ‘çš„æ˜¯Mobaxtermï¼ŒæŸ¥çœ‹cpuä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo</span><br></pre></td></tr></table></figure><p>BogoMIPS æ˜¯ Linux ç³»ç»Ÿä¸­è¡¡é‡å¤„ç†å™¨è¿è¡Œé€Ÿåº¦çš„ä¸€ä¸ªâ€œå°ºå­â€ï¼Œå¤„ç†å™¨æ€§èƒ½è¶Šå¼ºï¼Œä¸»é¢‘è¶Šé«˜ï¼Œ BogoMIPS å€¼å°±è¶Šå¤§ã€‚BogoMIPS åªæ˜¯ç²—ç•¥çš„è®¡ç®— CPU æ€§èƒ½ï¼Œå¹¶ä¸ååˆ†å‡†ç¡®ã€‚ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /sys/bus/cpu/devices/cpu0/cpufreq</span><br><span class="line">cat cpuinfo_cur_freq</span><br></pre></td></tr></table></figure><p>æ­¤ç›®å½•ä¸­è®°å½•äº† CPU é¢‘ç‡ç­‰ä¿¡æ¯ï¼Œè¿™äº›æ–‡ä»¶çš„å«ä¹‰å¦‚ä¸‹ï¼š<br>cpuinfo_cur_freqï¼šå½“å‰ cpu å·¥ä½œé¢‘ç‡ï¼Œä» CPU å¯„å­˜å™¨è¯»å–åˆ°çš„å·¥ä½œé¢‘ç‡ã€‚<br>cpuinfo_max_freqï¼šå¤„ç†å™¨æ‰€èƒ½è¿è¡Œçš„æœ€é«˜å·¥ä½œé¢‘ç‡(å•ä½: KHzï¼‰ã€‚<br>cpuinfo_min_freq ï¼šå¤„ç†å™¨æ‰€èƒ½è¿è¡Œçš„æœ€ä½å·¥ä½œé¢‘ç‡(å•ä½: KHzï¼‰ã€‚<br>cpuinfo_transition_latencyï¼šå¤„ç†å™¨åˆ‡æ¢é¢‘ç‡æ‰€éœ€è¦çš„æ—¶é—´(å•ä½:ns)ã€‚<br>scaling_available_frequenciesï¼šå¤„ç†å™¨æ”¯æŒçš„ä¸»é¢‘ç‡åˆ—è¡¨(å•ä½: KHzï¼‰ã€‚<br>scaling_available_governorsï¼šå½“å‰å†…æ ¸ä¸­æ”¯æŒçš„æ‰€æœ‰ governor(è°ƒé¢‘)ç±»å‹ã€‚<br>scaling_cur_freqï¼šä¿å­˜ç€ cpufreq æ¨¡å—ç¼“å­˜çš„å½“å‰ CPU é¢‘ç‡ï¼Œä¸ä¼šå¯¹ CPU ç¡¬ä»¶å¯„å­˜å™¨è¿›è¡Œæ£€æŸ¥ã€‚<br>scaling_driverï¼šè¯¥æ–‡ä»¶ä¿å­˜å½“å‰ CPU æ‰€ä½¿ç”¨çš„è°ƒé¢‘é©±åŠ¨ã€‚<br>scaling_governorï¼š governor(è°ƒé¢‘)ç­–ç•¥ï¼Œ Linux å†…æ ¸ä¸€å…±æœ‰ 5 ä¸­è°ƒé¢‘ç­–ç•¥ï¼Œ<br>â‘ ã€ Performanceï¼Œæœ€é«˜æ€§èƒ½ï¼Œç›´æ¥ç”¨æœ€é«˜é¢‘ç‡ï¼Œä¸è€ƒè™‘è€—ç”µã€‚<br>â‘¡ã€ Interactiveï¼Œä¸€å¼€å§‹ç›´æ¥ç”¨æœ€é«˜é¢‘ç‡ï¼Œç„¶åæ ¹æ® CPU è´Ÿè½½æ…¢æ…¢é™ä½ã€‚<br>â‘¢ã€ Powersaveï¼Œçœç”µæ¨¡å¼ï¼Œé€šå¸¸ä»¥æœ€ä½é¢‘ç‡è¿è¡Œï¼Œç³»ç»Ÿæ€§èƒ½ä¼šå—å½±å“ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªï¼<br>â‘£ã€ Userspaceï¼Œå¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´æ‰‹åŠ¨è°ƒèŠ‚é¢‘ç‡ã€‚<br>â‘¤ã€ Ondemandï¼Œå®šæ—¶æ£€æŸ¥è´Ÿè½½ï¼Œç„¶åæ ¹æ®è´Ÿè½½æ¥è°ƒèŠ‚é¢‘ç‡ã€‚è´Ÿè½½ä½çš„æ—¶å€™é™ä½ CPU é¢‘ç‡ï¼Œè¿™æ ·çœç”µï¼Œè´Ÿè½½é«˜çš„æ—¶å€™æé«˜ CPU é¢‘ç‡ï¼Œå¢åŠ æ€§èƒ½ã€‚<br>scaling_max_freqï¼š governor(è°ƒé¢‘)å¯ä»¥è°ƒèŠ‚çš„æœ€é«˜é¢‘ç‡ã€‚<br>cpuinfo_min_freqï¼š governor(è°ƒé¢‘)å¯ä»¥è°ƒèŠ‚çš„æœ€ä½é¢‘ç‡ã€‚ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat scaling_governor = ondemand</span><br></pre></td></tr></table></figure><p>ondmandæ˜¯å®šæœŸæ£€æŸ¥è´Ÿè½½ï¼Œè°ƒæ•´åŠŸç‡ï¼Œä¸€èˆ¬ç”¨è¿™ä¸ªã€‚</p><p>æŸ¥çœ‹ stats ç›®å½•ä¸‹çš„ time_in_state æ–‡ä»¶å¯ä»¥çœ‹åˆ° CPU åœ¨å„é¢‘ç‡ä¸‹çš„å·¥ä½œæ—¶é—´ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/bus/cpu/devices/cpu0/cpufreq/stats/time_in_state</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³ä¸€ç›´é«˜é¢‘å°±åœ¨å†…æ ¸æ–‡ä»¶çš„imx_alientek_emmc_defconfigæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_CPU_FREQ_DEFAULT_GOV_ONDEMAND=y//å±è”½æ‰</span><br><span class="line">CONFIG_CPU_FREQ_GOV_ONDEMAND=y//æ·»åŠ </span><br></pre></td></tr></table></figure><h4 id="EMMCé©±åŠ¨ä¿®æ”¹"><a href="#EMMCé©±åŠ¨ä¿®æ”¹" class="headerlink" title="EMMCé©±åŠ¨ä¿®æ”¹"></a>EMMCé©±åŠ¨ä¿®æ”¹</h4><p>ä¿®æ”¹imx6ull-alientek-emmc.dtsçš„usdhc2éƒ¨åˆ†ï¼Œå°†å…¶ä¿®æ”¹ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">734</span> &amp;usdhc2 &#123;</span><br><span class="line"><span class="number">735</span> pinctrl-names = <span class="string">&quot;default&quot;</span>, <span class="string">&quot;state_100mhz&quot;</span>, <span class="string">&quot;state_200mhz&quot;</span>;</span><br><span class="line"><span class="number">736</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_usdhc2_8bit&gt;;</span><br><span class="line"><span class="number">737</span> pinctrl<span class="number">-1</span> = &lt;&amp;pinctrl_usdhc2_8bit_100mhz&gt;;</span><br><span class="line"><span class="number">738</span> pinctrl<span class="number">-2</span> = &lt;&amp;pinctrl_usdhc2_8bit_200mhz&gt;;</span><br><span class="line"><span class="number">739</span> bus-width = &lt;<span class="number">8</span>&gt;;</span><br><span class="line"><span class="number">740</span> non-removable;</span><br><span class="line"><span class="number">741</span> no<span class="number">-1</span><span class="number">-8</span>-v;</span><br><span class="line"><span class="number">742</span> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">743</span> &#125;;</span><br></pre></td></tr></table></figure><h4 id="ç½‘ç»œé©±åŠ¨ä¿®æ”¹"><a href="#ç½‘ç»œé©±åŠ¨ä¿®æ”¹" class="headerlink" title="ç½‘ç»œé©±åŠ¨ä¿®æ”¹"></a>ç½‘ç»œé©±åŠ¨ä¿®æ”¹</h4><h5 id="ä¿®æ”¹LAN8720çš„å¤ä½ä»¥åŠç½‘ç»œæ—¶é’Ÿå¼•è„šé©±åŠ¨"><a href="#ä¿®æ”¹LAN8720çš„å¤ä½ä»¥åŠç½‘ç»œæ—¶é’Ÿå¼•è„šé©±åŠ¨" class="headerlink" title="ä¿®æ”¹LAN8720çš„å¤ä½ä»¥åŠç½‘ç»œæ—¶é’Ÿå¼•è„šé©±åŠ¨"></a>ä¿®æ”¹LAN8720çš„å¤ä½ä»¥åŠç½‘ç»œæ—¶é’Ÿå¼•è„šé©±åŠ¨</h5><p>ENET1 å¤ä½å¼•è„š ENET1_RST è¿æ¥åœ¨ I.M6ULL çš„ SNVS_TAMPER7 è¿™ä¸ªå¼•è„šä¸Šã€‚ ENET2çš„å¤ä½å¼•è„š ENET2_RST è¿æ¥åœ¨ I.MX6ULL çš„ SNVS_TAMPER8 ä¸Šã€‚æ‰“å¼€è®¾å¤‡æ ‘æ–‡ä»¶ imx6ullalientek-emmc.dtsï¼Œæ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">584</span> pinctrl_spi4: spi4grp &#123;</span><br><span class="line"><span class="number">585</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">586</span> MX6ULL_PAD_BOOT_MODE0__GPIO5_IO10 <span class="number">0x70a1</span></span><br><span class="line"><span class="number">587</span> MX6ULL_PAD_BOOT_MODE1__GPIO5_IO11 <span class="number">0x70a1</span></span><br><span class="line"><span class="number">588</span> MX6ULL_PAD_SNVS_TAMPER7__GPIO5_IO07 <span class="number">0x70a1</span></span><br><span class="line"><span class="number">589</span> MX6ULL_PAD_SNVS_TAMPER8__GPIO5_IO08 <span class="number">0x80000000</span></span><br><span class="line"><span class="number">590</span> &gt;;</span><br><span class="line"><span class="number">591</span> &#125;;</span><br></pre></td></tr></table></figure><p>åˆ é™¤åŸæœ‰çš„588å’Œ589è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">125</span> spi4 &#123;</span><br><span class="line"><span class="number">126</span> compatible = <span class="string">&quot;spi-gpio&quot;</span>;</span><br><span class="line"><span class="number">127</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">128</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_spi4&gt;;</span><br><span class="line"><span class="number">129</span> pinctrl-assert-gpios = &lt;&amp;gpio5 <span class="number">8</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">......</span><br><span class="line"><span class="number">133</span> cs-gpios = &lt;&amp;gpio5 <span class="number">7</span> <span class="number">0</span>&gt;;</span><br></pre></td></tr></table></figure><p>GPIO5_IO07 å’Œ GPIO5_IO08 åˆ†åˆ«ä½œä¸º ENET1 å’Œ ENET2 çš„å¤ä½å¼•è„šï¼Œè€Œä¸æ˜¯ SPI4 çš„ä»€ä¹ˆåŠŸèƒ½å¼•è„šï¼Œå› æ­¤å°†ç¤ºä¾‹ä»£ç  37.4.3.2 ä¸­çš„ç¬¬ 129 è¡Œå’Œç¬¬ 133 è¡Œå¤„çš„ä»£ç åˆ é™¤æ‰ï¼ï¼ å¦åˆ™ä¼šå¹²æ‰°åˆ°ç½‘ç»œå¤ä½å¼•è„šï¼ </p><p>åœ¨ imx6ull-alientek-emmc.dts é‡Œé¢æ‰¾åˆ°åä¸ºâ€œiomuxc_snvsâ€çš„èŠ‚ç‚¹(å°±æ˜¯ç›´æ¥æœç´¢)ï¼Œç„¶ååœ¨æ­¤èŠ‚ç‚¹ä¸‹æ·»åŠ ç½‘ç»œå¤ä½å¼•è„šä¿¡æ¯ï¼Œæ·»åŠ å®Œæˆä»¥åçš„â€œiomuxc_snvsâ€çš„èŠ‚ç‚¹å†…å®¹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> &amp;iomuxc_snvs &#123;</span><br><span class="line"><span class="number">2</span> pinctrl-names = <span class="string">&quot;default_snvs&quot;</span>;</span><br><span class="line"><span class="number">3</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_hog_2&gt;;</span><br><span class="line"><span class="number">4</span> imx6ul-evk &#123;</span><br><span class="line"><span class="number">5</span></span><br><span class="line">...... <span class="comment">/*çœç•¥æ‰å…¶ä»–*/</span></span><br><span class="line"><span class="number">43</span></span><br><span class="line"><span class="number">44</span> <span class="comment">/*enet1 reset zuozhongkai*/</span></span><br><span class="line"><span class="number">45</span> pinctrl_enet1_reset: enet1resetgrp &#123;</span><br><span class="line"><span class="number">46</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">47</span> <span class="comment">/* used for enet1 reset */</span></span><br><span class="line"><span class="number">48</span> MX6ULL_PAD_SNVS_TAMPER7__GPIO5_IO07 <span class="number">0x10B0</span></span><br><span class="line"><span class="number">49</span> &gt;;</span><br><span class="line"><span class="number">50</span> &#125;;</span><br><span class="line"><span class="number">51</span></span><br><span class="line"><span class="number">52</span> <span class="comment">/*enet2 reset zuozhongkai*/</span></span><br><span class="line"><span class="number">53</span> pinctrl_enet2_reset: enet2resetgrp &#123;</span><br><span class="line"><span class="number">54</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">55</span> <span class="comment">/* used for enet2 reset */</span></span><br><span class="line"><span class="number">56</span> MX6ULL_PAD_SNVS_TAMPER8__GPIO5_IO08 <span class="number">0x10B0</span></span><br><span class="line"><span class="number">57</span> &gt;;</span><br><span class="line"><span class="number">58</span> &#125;;</span><br><span class="line"><span class="number">59</span> &#125;;</span><br><span class="line"><span class="number">60</span> &#125;;</span><br></pre></td></tr></table></figure><p>æœ€åè¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸‹ ENET1 å’Œ ENET2 çš„ç½‘ç»œæ—¶é’Ÿå¼•è„šé…ç½®ï¼Œ ç»§ç»­åœ¨ imx6ull-alientekemmc.dts ä¸­æ‰¾åˆ°å¦‚ä¸‹æ‰€ç¤ºä»£ç ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">309</span> pinctrl_enet1: enet1grp &#123;</span><br><span class="line"><span class="number">310</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">311</span> MX6UL_PAD_ENET1_RX_EN__ENET1_RX_EN <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">312</span> MX6UL_PAD_ENET1_RX_ER__ENET1_RX_ER <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">313</span> MX6UL_PAD_ENET1_RX_DATA0__ENET1_RDATA00 <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">314</span> MX6UL_PAD_ENET1_RX_DATA1__ENET1_RDATA01 <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">315</span> MX6UL_PAD_ENET1_TX_EN__ENET1_TX_EN <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">316</span> MX6UL_PAD_ENET1_TX_DATA0__ENET1_TDATA00 <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">317</span> MX6UL_PAD_ENET1_TX_DATA1__ENET1_TDATA01 <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">318</span> MX6UL_PAD_ENET1_TX_CLK__ENET1_REF_CLK1 <span class="number">0x4001b009</span></span><br><span class="line"><span class="number">319</span> &gt;;</span><br><span class="line"><span class="number">320</span> &#125;;</span><br><span class="line"><span class="number">321</span></span><br><span class="line"><span class="number">322</span> pinctrl_enet2: enet2grp &#123;</span><br><span class="line"><span class="number">323</span> fsl,pins = &lt;</span><br><span class="line"><span class="number">324</span> MX6UL_PAD_GPIO1_IO07__ENET2_MDC <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">325</span> MX6UL_PAD_GPIO1_IO06__ENET2_MDIO <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">326</span> MX6UL_PAD_ENET2_RX_EN__ENET2_RX_EN <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">327</span> MX6UL_PAD_ENET2_RX_ER__ENET2_RX_ER <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">328</span> MX6UL_PAD_ENET2_RX_DATA0__ENET2_RDATA00 <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">329</span> MX6UL_PAD_ENET2_RX_DATA1__ENET2_RDATA01 <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">330</span> MX6UL_PAD_ENET2_TX_EN__ENET2_TX_EN <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">331</span> MX6UL_PAD_ENET2_TX_DATA0__ENET2_TDATA00 <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">332</span> MX6UL_PAD_ENET2_TX_DATA1__ENET2_TDATA01 <span class="number">0x1b0b0</span></span><br><span class="line"><span class="number">333</span> MX6UL_PAD_ENET2_TX_CLK__ENET2_REF_CLK2 <span class="number">0x4001b009</span></span><br><span class="line"><span class="number">334</span> &gt;;</span><br><span class="line"><span class="number">335</span> &#125;;</span><br></pre></td></tr></table></figure><p>ç¬¬ 318 å’Œ 333 è¡Œï¼Œ åˆ†åˆ«ä¸º ENET1 å’Œ ENET2 çš„ç½‘ç»œæ—¶é’Ÿå¼•è„šé…ç½®ä¿¡æ¯ï¼Œå°†è¿™ä¸¤ä¸ªå¼•è„šçš„ç”µæ°”å±æ€§å€¼æ”¹ä¸º 0x4001b009ï¼ŒåŸæ¥é»˜è®¤å€¼ä¸º 0x4001b031ã€‚ </p><h5 id="ä¿®æ”¹-fec1-å’Œ-fec2-èŠ‚ç‚¹çš„-pinctrl-0-å±æ€§"><a href="#ä¿®æ”¹-fec1-å’Œ-fec2-èŠ‚ç‚¹çš„-pinctrl-0-å±æ€§" class="headerlink" title="ä¿®æ”¹ fec1 å’Œ fec2 èŠ‚ç‚¹çš„ pinctrl-0 å±æ€§"></a>ä¿®æ”¹ fec1 å’Œ fec2 èŠ‚ç‚¹çš„ pinctrl-0 å±æ€§</h5><p>åœ¨ imx6ull-alientek-emmc.dts æ–‡ä»¶ä¸­æ‰¾åˆ°åä¸ºâ€œfec1â€å’Œâ€œfec2â€çš„è¿™ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä¿®æ”¹å…¶ä¸­çš„â€œpinctrl-0â€å±æ€§å€¼ï¼Œä¿®æ”¹ä»¥åå¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> &amp;fec1 &#123;</span><br><span class="line"><span class="number">2</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">3</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_enet1&amp;pinctrl_enet1_reset&gt;;</span><br><span class="line"><span class="number">4</span> phy-mode = <span class="string">&quot;rmii&quot;</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">9</span> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">10</span> &#125;;</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span> &amp;fec2 &#123;</span><br><span class="line"><span class="number">13</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">14</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_enet2&amp;pinctrl_enet2_reset&gt;;</span><br><span class="line"><span class="number">15</span> phy-mode = <span class="string">&quot;rmii&quot;</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">36</span> &#125;;</span><br></pre></td></tr></table></figure><p>ç¬¬ 3<del>4 è¡Œï¼Œä¿®æ”¹åçš„ fec1 èŠ‚ç‚¹â€œpinctrl-0â€å±æ€§å€¼ã€‚<br>ç¬¬ 14</del>15 è¡Œï¼Œä¿®æ”¹åçš„ fec2 èŠ‚ç‚¹â€œpinctrl-0â€å±æ€§å€¼ .</p><h5 id="ä¿®æ”¹-LAN8720A-çš„-PHY-åœ°å€"><a href="#ä¿®æ”¹-LAN8720A-çš„-PHY-åœ°å€" class="headerlink" title="ä¿®æ”¹ LAN8720A çš„ PHY åœ°å€"></a>ä¿®æ”¹ LAN8720A çš„ PHY åœ°å€</h5><p>ENET1 çš„ LAN8720A åœ°å€ä¸º 0x0ï¼Œ ENET2 çš„ LAN8720Aåœ°å€ä¸º 0x1 ï¼Œåœ¨ imx6ull-alientek-emmc.dts ä¸­æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">171</span> &amp;fec1 &#123;</span><br><span class="line"><span class="number">172</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">175</span> phy-handle = &lt;&amp;ethphy0&gt;;</span><br><span class="line"><span class="number">176</span> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">177</span> &#125;;</span><br><span class="line"><span class="number">178</span></span><br><span class="line"><span class="number">179</span> &amp;fec2 &#123;</span><br><span class="line"><span class="number">180</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">183</span> phy-handle = &lt;&amp;ethphy1&gt;;</span><br><span class="line"><span class="number">184</span> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">185</span></span><br><span class="line"><span class="number">186</span> mdio &#123;</span><br><span class="line"><span class="number">187</span> <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">188</span> <span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">189</span></span><br><span class="line"><span class="number">190</span> ethphy0: ethernet-phy@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">191</span> compatible = <span class="string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;</span><br><span class="line"><span class="number">192</span> reg = &lt;<span class="number">2</span>&gt;;</span><br><span class="line"><span class="number">193</span> &#125;;</span><br><span class="line"><span class="number">194</span></span><br><span class="line"><span class="number">195</span> ethphy1: ethernet-phy@<span class="number">1</span> &#123;</span><br><span class="line"><span class="number">196</span> compatible = <span class="string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;</span><br><span class="line"><span class="number">197</span> reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line"><span class="number">198</span> &#125;;</span><br><span class="line"><span class="number">199</span> &#125;;</span><br><span class="line"><span class="number">200</span> &#125;;</span><br></pre></td></tr></table></figure><p>ç¬¬ 171<del>177 è¡Œï¼Œ ENET1 å¯¹åº”çš„è®¾å¤‡æ ‘èŠ‚ç‚¹ã€‚<br>ç¬¬ 179</del>200 è¡Œï¼Œ ENET2 å¯¹åº”çš„è®¾å¤‡æ ‘èŠ‚ç‚¹ã€‚ä½†æ˜¯ç¬¬ 186~198 è¡Œçš„ mdio èŠ‚ç‚¹æè¿°äº† ENET1å’Œ ENET2 çš„ PHY åœ°å€ä¿¡æ¯ã€‚ æ”¹ä¸ºå¦‚ä¸‹å†…å®¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">171</span> &amp;fec1 &#123;</span><br><span class="line"><span class="number">172</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">173</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_enet1</span><br><span class="line"><span class="number">174</span> &amp;pinctrl_enet1_reset&gt;;</span><br><span class="line"><span class="number">175</span> phy-mode = <span class="string">&quot;rmii&quot;</span>;</span><br><span class="line"><span class="number">176</span> phy-handle = &lt;&amp;ethphy0&gt;;</span><br><span class="line"><span class="number">177</span> phy-reset-gpios = &lt;&amp;gpio5 <span class="number">7</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line"><span class="number">178</span> phy-reset-duration = &lt;<span class="number">200</span>&gt;;</span><br><span class="line"><span class="number">179</span> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">180</span> &#125;;</span><br><span class="line"><span class="number">181</span></span><br><span class="line"><span class="number">182</span> &amp;fec2 &#123;</span><br><span class="line"><span class="number">183</span> pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">184</span> pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_enet2</span><br><span class="line"><span class="number">185</span> &amp;pinctrl_enet2_reset&gt;;</span><br><span class="line"><span class="number">186</span> phy-mode = <span class="string">&quot;rmii&quot;</span>;</span><br><span class="line"><span class="number">187</span> phy-handle = &lt;&amp;ethphy1&gt;;</span><br><span class="line"><span class="number">188</span> phy-reset-gpios = &lt;&amp;gpio5 <span class="number">8</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line"><span class="number">189</span> phy-reset-duration = &lt;<span class="number">200</span>&gt;;</span><br><span class="line"><span class="number">190</span> status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">191</span></span><br><span class="line"><span class="number">192</span> mdio &#123;</span><br><span class="line"><span class="number">193</span> <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">194</span> <span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">195</span></span><br><span class="line"><span class="number">196</span> ethphy0: ethernet-phy@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">197</span> compatible = <span class="string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;</span><br><span class="line"><span class="number">198</span> smsc,disable-energy-detect;</span><br><span class="line"><span class="number">199</span> reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">200</span> &#125;;</span><br><span class="line"><span class="number">201</span></span><br><span class="line"><span class="number">202</span> ethphy1: ethernet-phy@<span class="number">1</span> &#123;</span><br><span class="line"><span class="number">203</span> compatible = <span class="string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;</span><br><span class="line"><span class="number">204</span> smsc,disable-energy-detect;</span><br><span class="line"><span class="number">205</span> reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line"><span class="number">206</span> &#125;;</span><br><span class="line"><span class="number">207</span> &#125;;</span><br><span class="line"><span class="number">208</span> &#125;;</span><br></pre></td></tr></table></figure><h5 id="ä¿®æ”¹-fec-main-c-æ–‡ä»¶"><a href="#ä¿®æ”¹-fec-main-c-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ fec_main.c æ–‡ä»¶"></a>ä¿®æ”¹ fec_main.c æ–‡ä»¶</h5><p>è¦ åœ¨ I.MX6ULL ä¸Š ä½¿ ç”¨ LAN8720A ï¼Œ éœ€ è¦ ä¿® æ”¹ ä¸€ ä¸‹ Linux å†… æ ¸ æº ç  ï¼Œ æ‰“ å¼€drivers&#x2F;net&#x2F;ethernet&#x2F;freescale&#x2F;fec_main.cï¼Œæ‰¾åˆ°å‡½æ•° fec_probeï¼Œåœ¨ fec_probe ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3438</span> <span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="number">3439</span> fec_probe(<span class="keyword">struct</span> platform_device *pdev)</span><br><span class="line"><span class="number">3440</span> &#123;</span><br><span class="line"><span class="number">3441</span> <span class="class"><span class="keyword">struct</span> <span class="title">fec_enet_private</span> *<span class="title">fep</span>;</span></span><br><span class="line"><span class="number">3442</span> <span class="class"><span class="keyword">struct</span> <span class="title">fec_platform_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line"><span class="number">3443</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">ndev</span>;</span></span><br><span class="line"><span class="number">3444</span> <span class="type">int</span> i, irq, ret = <span class="number">0</span>;</span><br><span class="line"><span class="number">3445</span> <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">r</span>;</span></span><br><span class="line"><span class="number">3446</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">of_id</span>;</span></span><br><span class="line"><span class="number">3447</span> <span class="type">static</span> <span class="type">int</span> dev_id;</span><br><span class="line"><span class="number">3448</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span> =</span> pdev-&gt;dev.of_node, *phy_node;</span><br><span class="line"><span class="number">3449</span> <span class="type">int</span> num_tx_qs;</span><br><span class="line"><span class="number">3450</span> <span class="type">int</span> num_rx_qs;</span><br><span class="line"><span class="number">3451</span></span><br><span class="line"><span class="number">3452</span> <span class="comment">/* è®¾ç½® MX6UL_PAD_ENET1_TX_CLK å’Œ MX6UL_PAD_ENET2_TX_CLK</span></span><br><span class="line"><span class="comment">3453 * è¿™ä¸¤ä¸ª IO çš„å¤ç”¨å¯„å­˜å™¨çš„ SION ä½ä¸º 1ã€‚</span></span><br><span class="line"><span class="comment">3454 */</span></span><br><span class="line"><span class="number">3455</span> <span class="type">void</span> __iomem *IMX6U_ENET1_TX_CLK;</span><br><span class="line"><span class="number">3456</span> <span class="type">void</span> __iomem *IMX6U_ENET2_TX_CLK;</span><br><span class="line"><span class="number">3457</span></span><br><span class="line"><span class="number">3458</span> IMX6U_ENET1_TX_CLK = ioremap(<span class="number">0X020E00DC</span>, <span class="number">4</span>);</span><br><span class="line"><span class="number">3459</span> writel(<span class="number">0X14</span>, IMX6U_ENET1_TX_CLK);</span><br><span class="line"><span class="number">3460</span></span><br><span class="line"><span class="number">3461</span> IMX6U_ENET2_TX_CLK = ioremap(<span class="number">0X020E00FC</span>, <span class="number">4</span>);</span><br><span class="line"><span class="number">3462</span> writel(<span class="number">0X14</span>, IMX6U_ENET2_TX_CLK);</span><br><span class="line"><span class="number">3463</span></span><br><span class="line">......</span><br><span class="line"><span class="number">3656</span> <span class="keyword">return</span> ret;</span><br><span class="line"><span class="number">3657</span> &#125;</span><br></pre></td></tr></table></figure><h5 id="é…ç½®-Linux-å†…æ ¸ï¼Œä½¿èƒ½-LAN8720-é©±åŠ¨"><a href="#é…ç½®-Linux-å†…æ ¸ï¼Œä½¿èƒ½-LAN8720-é©±åŠ¨" class="headerlink" title="é…ç½® Linux å†…æ ¸ï¼Œä½¿èƒ½ LAN8720 é©±åŠ¨"></a>é…ç½® Linux å†…æ ¸ï¼Œä½¿èƒ½ LAN8720 é©±åŠ¨</h5><p>è¾“å…¥å‘½ä»¤â€œmake menuconfigâ€ï¼Œæ‰“å¼€å›¾å½¢åŒ–é…ç½®ç•Œé¢ï¼Œé€‰æ‹©ä½¿èƒ½ LAN8720A çš„é©±åŠ¨ï¼Œè·¯å¾„å¦‚ä¸‹ï¼š </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-&gt; Device Drivers</span><br><span class="line">-&gt; Network device support</span><br><span class="line">-&gt; PHY Device support and infrastructure</span><br><span class="line">-&gt; Drivers for SMSC PHYs</span><br></pre></td></tr></table></figure><h5 id="ä¿®æ”¹-smsc-c-æ–‡ä»¶"><a href="#ä¿®æ”¹-smsc-c-æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ smsc.c æ–‡ä»¶"></a>ä¿®æ”¹ smsc.c æ–‡ä»¶</h5><p>LAN8720A çš„é©±åŠ¨æ–‡ä»¶æ˜¯ drivers&#x2F;net&#x2F;phy&#x2F;smsc.cï¼Œ ä¿®æ”¹SMSC PHYçš„å¤ä½å‡½æ•° ï¼Œä¿®æ”¹ä»¥åçš„ smsc_phy_resetå‡½æ•°å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">smsc_phy_reset</span><span class="params">(<span class="keyword">struct</span> phy_device *phydev)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> err, phy_reset;</span><br><span class="line"><span class="type">int</span> msec = <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>;</span></span><br><span class="line"><span class="type">int</span> timeout = <span class="number">50000</span>;</span><br><span class="line"><span class="keyword">if</span>(phydev-&gt;addr == <span class="number">0</span>) <span class="comment">/* FEC1 */</span> </span><br><span class="line">    &#123;</span><br><span class="line">np = of_find_node_by_path(<span class="string">&quot;/soc/aips-bus@02100000/ethernet@02188000&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(np == <span class="literal">NULL</span>) </span><br><span class="line">        &#123;</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(phydev-&gt;addr == <span class="number">1</span>) <span class="comment">/* FEC2 */</span> </span><br><span class="line">    &#123;</span><br><span class="line">np = of_find_node_by_path(<span class="string">&quot;/soc/aips-bus@02000000/ethernet@020b4000&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(np == <span class="literal">NULL</span>) </span><br><span class="line">        &#123;</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = of_property_read_u32(np, <span class="string">&quot;phy-reset-duration&quot;</span>, &amp;msec);</span><br><span class="line"><span class="comment">/* A sane reset duration should not be longer than 1s */</span></span><br><span class="line"><span class="keyword">if</span> (!err &amp;&amp; msec &gt; <span class="number">1000</span>)</span><br><span class="line">msec = <span class="number">1</span>;</span><br><span class="line">phy_reset = of_get_named_gpio(np, <span class="string">&quot;phy-reset-gpios&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!gpio_is_valid(phy_reset))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">gpio_direction_output(phy_reset, <span class="number">0</span>);</span><br><span class="line">gpio_set_value(phy_reset, <span class="number">0</span>);</span><br><span class="line">msleep(msec);</span><br><span class="line">gpio_set_value(phy_reset, <span class="number">1</span>);</span><br><span class="line"><span class="type">int</span> rc = phy_read(phydev, MII_LAN83C185_SPECIAL_MODES);</span><br><span class="line"><span class="keyword">if</span> (rc &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If the SMSC PHY is in power down mode, then set it</span></span><br><span class="line"><span class="comment">* in all capable mode before using it.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> ((rc &amp; MII_LAN83C185_MODE_MASK) == MII_LAN83C185_MODE_POWERDOWN) </span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* set &quot;all capable&quot; mode and reset the phy */</span></span><br><span class="line">rc |= MII_LAN83C185_MODE_ALL;</span><br><span class="line">phy_write(phydev, MII_LAN83C185_SPECIAL_MODES, rc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">phy_write(phydev, MII_BMCR, BMCR_RESET);</span><br><span class="line"><span class="comment">/* wait end of reset (max 500 ms) */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">udelay(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span> (timeout-- == <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">rc = phy_read(phydev, MII_BMCR);</span><br><span class="line">&#125; <span class="keyword">while</span> (rc &amp; BMCR_RESET);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬è¿˜éœ€è¦åœ¨ drivers&#x2F;net&#x2F;phy&#x2F;smsc.c æ–‡ä»¶ä¸­æ·»åŠ ä¸¤ä¸ªå¤´æ–‡ä»¶ï¼Œå› ä¸ºä¿®æ”¹åçš„smsc_phy_reset å‡½æ•°ç”¨åˆ°äº† gpio_direction_output å’Œ gpio_set_value è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œéœ€è¦æ·»åŠ çš„å¤´æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br></pre></td></tr></table></figure><h4 id="ç½‘ç»œé©±åŠ¨æµ‹è¯•"><a href="#ç½‘ç»œé©±åŠ¨æµ‹è¯•" class="headerlink" title="ç½‘ç»œé©±åŠ¨æµ‹è¯•"></a>ç½‘ç»œé©±åŠ¨æµ‹è¯•</h4><p>ä¿®æ”¹å¥½è®¾å¤‡æ ‘å’Œ Linux å†…æ ¸ä»¥åé‡æ–°ç¼–è¯‘ä¸€ä¸‹ï¼Œå¾—åˆ°æ–°çš„ zImage é•œåƒæ–‡ä»¶å’Œ imx6ullalientek-emmc.dtb è®¾å¤‡æ ‘æ–‡ä»¶ï¼Œä½¿ç”¨ç½‘çº¿å°† I.MX6U-ALPHA å¼€å‘æ¿çš„ä¸¤ä¸ªç½‘å£ä¸è·¯ç”±å™¨æˆ–è€…ç”µè„‘è¿æ¥èµ·æ¥ï¼Œæœ€åä½¿ç”¨æ–°çš„æ–‡ä»¶å¯åŠ¨ Linux å†…æ ¸ã€‚å¯åŠ¨ä»¥åä½¿ç”¨â€œifconfigâ€å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹å½“å‰æ´»åŠ¨çš„ç½‘å¡æœ‰å“ªäº› ã€‚</p><p>è¾“å…¥å‘½ä»¤â€œifconfig -aâ€æ¥æŸ¥çœ‹ä¸€ä¸‹å¼€å‘æ¿ä¸­å­˜åœ¨çš„æ‰€æœ‰ç½‘å¡ï¼Œ </p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¾æ¬¡æ‰“å¼€ eth0 å’Œ eth1 è¿™ä¸¤ä¸ªç½‘å¡ï¼š </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 up</span><br><span class="line">ifconfig eth1 up</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½ä»¤ç»™ä¸¤ä¸ªç½‘å¡é…ç½®IPåœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 192.168.1.251</span><br><span class="line">ifconfig eth1 192.168.1.252</span><br></pre></td></tr></table></figure><p>ä¸€å®šè¦å’Œè‡ªå·±çš„ç”µè„‘å¤„äºåŒä¸€ä¸ªç½‘æ®µå†… ï¼Œå¯ä»¥pingä¸€ä¸‹è‡ªå·±çš„ä¸»æœºåœ°å€ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> ç³»ç»Ÿç§»æ¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…æ ¸åˆ†æ</title>
      <link href="/2023/03/24/2023-3-24-Linux-%E5%86%85%E6%A0%B8%E5%88%86%E6%9E%90/"/>
      <url>/2023/03/24/2023-3-24-Linux-%E5%86%85%E6%A0%B8%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="å†…æ ¸åˆ†æ"><a href="#å†…æ ¸åˆ†æ" class="headerlink" title="å†…æ ¸åˆ†æ"></a>å†…æ ¸åˆ†æ</h2><h3 id="linuxå†…æ ¸ç»„æˆéƒ¨åˆ†"><a href="#linuxå†…æ ¸ç»„æˆéƒ¨åˆ†" class="headerlink" title="linuxå†…æ ¸ç»„æˆéƒ¨åˆ†"></a>linuxå†…æ ¸ç»„æˆéƒ¨åˆ†</h3><p>linuxå†…æ ¸ä¸»è¦ç”±è¿›ç¨‹è°ƒåº¦ï¼ˆSCHEDï¼‰ã€å†…å­˜ç®¡ç†ï¼ˆMMï¼‰ã€è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰ã€ç½‘ç»œæ¥å£ï¼ˆNETï¼‰ã€è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰5ä¸ªå­ç³»ç»Ÿç»„æˆã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-04-03%20154334.png"></p><p>5ä¸ªå­ç³»ç»Ÿä¾èµ–å…³ç³»å¦‚ä¸‹ï¼š</p><p>è¿›ç¨‹è°ƒåº¦ä¸å†…å­˜ç®¡ç†ä¹‹é—´çš„å…³ç³»ï¼šè¿™ä¸¤ä¸ªå­ç³»ç»Ÿç›¸äº’ä¾èµ–ï¼Œåœ¨å¤šç¨‹åºç¯å¢ƒä¸‹ï¼Œç¨‹åºè¦è¿è¡Œï¼Œåˆ™å¿…é¡»åˆ›å»ºè¿›ç¨‹ï¼Œè€Œåˆ›å»ºè¿›ç¨‹ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯å°†ç¨‹åºå’Œæ•°æ®è£…å…¥å†…å­˜ã€‚</p><p>è¿›ç¨‹é—´é€šä¿¡ä¸å†…å­˜ç®¡ç†çš„å…³ç³»ï¼šè¿›ç¨‹é—´é€šä¿¡å­ç³»ç»Ÿè¦ä¾èµ–å†…å­˜ç®¡ç†æ”¯æŒå…±äº«å†…å­˜é€šä¿¡æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶å…è®¸ä¸¤ä¸ªè¿›ç¨‹é™¤äº†æ‹¥æœ‰è‡ªå·±çš„ç§æœ‰ç©ºé—´å¤–ï¼Œè¿˜å¯ä»¥å­˜å–å…±åŒçš„å†…å­˜åŒºåŸŸã€‚</p><p>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸ç½‘ç»œæ¥å£ä¹‹é—´çš„å…³ç³»ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿåˆ©ç”¨ç½‘ç»œæ¥å£æ”¯æŒç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼ˆNFSï¼‰ï¼Œä¹Ÿåˆ©ç”¨å†…å­˜ç®¡ç†æ”¯æŒRAMDISKè®¾å¤‡ã€‚</p><p>å†…å­˜ç®¡ç†ä¸è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¹‹é—´çš„å…³ç³»ï¼šå†…å­˜ç®¡ç†åˆ©ç”¨è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ”¯æŒäº¤æ¢ï¼Œäº¤æ¢è¿›ç¨‹å®šæœŸç”±è°ƒåº¦ç¨‹åºè°ƒåº¦ï¼Œè¿™ä¹Ÿæ˜¯å†…å­˜ç®¡ç†ä¾èµ–äºè¿›ç¨‹è°ƒåº¦çš„åŸå› ã€‚</p><h3 id="è¯¦æƒ…å‚è€ƒ"><a href="#è¯¦æƒ…å‚è€ƒ" class="headerlink" title="è¯¦æƒ…å‚è€ƒ"></a>è¯¦æƒ…å‚è€ƒ</h3><p><a href="http://blog.csdn.net/lizuobin2/article/details/51447338">Makefile.txtæ–‡ä»¶ç¿»è¯‘</a></p><h3 id="å†…æ ¸Makefileåˆ†ç±»"><a href="#å†…æ ¸Makefileåˆ†ç±»" class="headerlink" title="å†…æ ¸Makefileåˆ†ç±»"></a>å†…æ ¸Makefileåˆ†ç±»</h3><p>åœ¨Linuxå†…æ ¸é‡Œï¼Œæ¯ä¸ªå­ç›®å½•éƒ½æœ‰ä¸€ä¸ªmakefileï¼Œå®ƒè¢«ç§°ä½œKbuilt-makefileï¼Œå®ƒå°†å½“å‰ç›®å½•çš„æ–‡ä»¶ç¼–è¯‘æˆbuilt-in.oã€ä»¥åŠåº“æ–‡ä»¶ã€æ¨¡å—æ–‡ä»¶ã€‚ç„¶åé¡¶å±‚Makefileé‡ŒæŒ‡å®šè¿™äº›built-in.oçš„è·¯å¾„ï¼Œå°†å®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ã€‚</p><p><strong>å°†makefileåˆ†ä¸º 5éƒ¨åˆ†ï¼ŒKernel Makefileã€ARCH Makefileã€KBuild Makefileã€.configæ–‡ä»¶ä»¥åŠscripts&#x2F;Makefile.</strong></p><p>â‘ kernel Makefile(Top Makefile)ä½äºLinuxå†…æ ¸æºä»£ç çš„é¡¶å±‚ç›®å½•ï¼Œä¸»è¦ç¼–è¯‘Linux Kernelç›®æ ‡æ–‡ä»¶ï¼ˆvmlinuxï¼‰å’Œæ¨¡å—ï¼ˆmoduleï¼‰è·¯å¾„ã€‚å®ƒæ ¹æ®.configæ–‡ä»¶å†³å®šäº†å†…æ ¸æ ¹ç›®å½•ä¸‹çš„é‚£äº›æ–‡ä»¶ã€å­ç›®å½•è¢«ç¼–è¯‘è¿›å†…æ ¸ï¼Œæ˜¯æ‰€æœ‰æ–‡ä»¶æ ¸å¿ƒï¼Œä»æ€»ä½“æ§åˆ¶å†…æ ¸ç¼–è¯‘ã€é“¾æ¥ã€‚</p><p>â‘¡ARCH Makefileæ–‡ä»¶ï¼Œæ˜¯ç³»ç»Ÿå¯¹åº”å¹³å°çš„Makefileã€‚Kernel Top Makefile ä¼šåŒ…å«è¿™ä¸ªæ–‡ä»¶æ¥æŒ‡å®šå¹³å°ç›¸å…³ä¿¡æ¯ã€‚ARCH MakefileåŒæ ·<strong>æ ¹æ®.configæ–‡ä»¶ï¼Œå†³å®šäº†ARCH&#x2F;$(ARCH) ç›®å½•ä¸‹ é‚£äº›æ–‡ä»¶ã€å­ç›®å½•è¢«ç¼–è¯‘è¿›å†…æ ¸</strong> åªæœ‰å¹³å°å¼€å‘äººå‘˜ä¼šå…³å¿ƒè¿™ä¸ªæ–‡ä»¶ã€‚</p><p>â‘¢Kbuild Makefileï¼Œä»Linux å†…æ ¸2.6 å¼€å§‹ï¼ŒLinux å†…æ ¸çš„ç¼–è¯‘é‡‡ç”¨Kbuild ç³»ç»Ÿ ï¼Œè¿™åŒè¿‡å»çš„ç¼–è¯‘ç³»ç»Ÿæœ‰å¾ˆå¤§çš„ä¸åŒï¼ŒKbuild ç³»ç»Ÿä½¿ç”¨Kbuild Makefile æ¥ç¼–è¯‘å†…æ ¸æˆ–æ¨¡å—ã€‚å½“Kernel Makefile è¢«è§£æå®Œæˆåï¼ŒKbuild ä¼šè¯»å–ç›¸å…³çš„Kbuild Makefile è¿›è¡Œå†…æ ¸æˆ–æ¨¡å—çš„ç¼–è¯‘ã€‚Kbuild Makefile æœ‰ç‰¹å®šçš„è¯­æ³•æŒ‡å®šå“ªäº›ç¼–è¯‘è¿›å†…æ ¸ä¸­ã€å“ªäº›ç¼–è¯‘ä¸ºæ¨¡å—ã€åŠå¯¹åº”çš„æºæ–‡ä»¶æ˜¯ä»€ä¹ˆç­‰ã€‚å†…æ ¸åŠé©±åŠ¨å¼€å‘äººå‘˜éœ€è¦ç¼–å†™è¿™ä¸ªKbuild Makefile æ–‡ä»¶ã€‚<br>â‘£**scripts&#x2F;Makefile.* ï¼ŒMakefileå…±ç”¨çš„é€šç”¨è§„åˆ™ã€è„šæœ¬ç­‰</p><p>â‘¤**.config**ï¼Œæ¥è‡ªé…ç½®è¿‡ç¨‹ï¼Œç”Ÿæˆ auto.conf ä»¥åŠ autoconf.hï¼Œè¢«é¡¶å±‚Makefileæ‰€åŒ…å«</p><h3 id="5å¤§æ–‡ä»¶ä½œç”¨"><a href="#5å¤§æ–‡ä»¶ä½œç”¨" class="headerlink" title="5å¤§æ–‡ä»¶ä½œç”¨"></a>5å¤§æ–‡ä»¶ä½œç”¨</h3><p>é¦–å…ˆæ˜¯é¡¶å±‚Makefileå†³å®šå†…æ ¸æ ¹ç›®å½•ä¸‹çš„å“ªäº›å­ç›®å½•å°†è¢«ç¼–è¿›å†…æ ¸ã€‚</p><p>arch&#x2F;$(ARCH)&#x2F;Makefileå†³å®šarch&#x2F;$(ARCH)ç›®å½•ä¸‹å“ªäº›æ–‡ä»¶ã€å“ªäº›ç›®å½•è¢«ç¼–è¿›å†…æ ¸ã€‚</p><p>å„çº§å­ç›®å½•ä¸‹çš„Makefileå†³å®šæ‰€åœ¨ç›®å½•ä¸‹çš„å“ªäº›æ–‡ä»¶å°†è¢«ç¼–è¿›å†…æ ¸ï¼Œå“ªäº›è¢«ç¼–å†™æˆæ¨¡å—ï¼ˆé©±åŠ¨æ¨¡å—ï¼‰ï¼Œè¿›å…¥å“ªäº›å­ç›®å½•ç»§ç»­è°ƒç”¨å®ƒä»¬çš„Makefileã€‚</p><p>é¡¶å±‚Makefileå’Œarch&#x2F;$(ARCH)&#x2F;Makefileè®¾ç½®äº†å¯ä»¥å½±å“æ‰€æœ‰æ–‡ä»¶çš„ç¼–è¯‘ã€è¿æ¥é€‰é¡¹ï¼šCFLAGSã€AFLAGSã€LDFLAGSã€ARFLAFGSã€‚</p><p>å„çº§å­ç›®å½•ä¸‹çš„Makefileä¸­å¯ä»¥è®¾ç½®æˆèƒ½å¤Ÿå½±å“å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„ç¼–è¯‘ ã€è¿æ¥é€‰é¡¹ï¼šEXTRA_CFLAGSã€EXTRA_AFLAGSã€EXTRA_LDFLAGSã€EXTRA_ARFLAGS,è¿˜å¯ä»¥è®¾ç½®å½±å“æŸä¸ªæ–‡ä»¶çš„ç¼–è¯‘é€‰é¡¹ã€‚</p><p>é¡¶å±‚MakefileæŒ‰ç…§ä¸€å®šçš„é¡ºåºç»„ç»‡æ–‡ä»¶ï¼Œæ ¹æ®è¿æ¥è„šæœ¬arch&#x2F;$(ARCH)&#x2F;kernel&#x2F;vmlinux.ldsç”Ÿæˆå†…æ ¸é•œåƒæ–‡ä»¶vmlinuxã€‚</p><p>â‘ ã€ vmlinux æ˜¯ç¼–è¯‘å‡ºæ¥çš„æœ€åŸå§‹çš„å†…æ ¸æ–‡ä»¶ï¼Œæ˜¯æœªå‹ç¼©çš„ï¼Œæ¯”å¦‚æ­£ç‚¹åŸå­æä¾›çš„ Linux æºç ç¼–è¯‘å‡ºæ¥çš„ vmlinux å·®ä¸å¤šæœ‰ 16MBï¼Œ<br>â‘¡ã€ Image æ˜¯ Linux å†…æ ¸é•œåƒæ–‡ä»¶ï¼Œä½†æ˜¯ Image ä»…åŒ…å«å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ•°æ®ã€‚ Image å°±æ˜¯ä½¿ç”¨ objcopy å–æ¶ˆæ‰ vmlinux ä¸­çš„ä¸€äº›å…¶ä»–ä¿¡æ¯ï¼Œæ¯”å¦‚ç¬¦å·è¡¨ä»€ä¹ˆçš„ã€‚ä½†æ˜¯ Image æ˜¯æ²¡æœ‰å‹ç¼©è¿‡çš„ï¼Œ Image ä¿å­˜åœ¨ arch&#x2F;arm&#x2F;boot ç›®å½•ä¸‹ï¼Œå…¶å¤§å°å¤§æ¦‚åœ¨ 12MB å·¦å³ç›¸æ¯” vmlinux çš„ 16MBï¼Œ Image ç¼©å°åˆ°äº† 12MBã€‚<br>â‘¢ã€ zImage æ˜¯ç»è¿‡ gzip å‹ç¼©åçš„ Imageï¼Œç»è¿‡å‹ç¼©ä»¥åå…¶å¤§å°å¤§æ¦‚åœ¨ 6MB å·¦å³ </p><h3 id="å†…æ ¸çš„é…ç½®"><a href="#å†…æ ¸çš„é…ç½®" class="headerlink" title="å†…æ ¸çš„é…ç½®"></a>å†…æ ¸çš„é…ç½®</h3><p> 1ã€Makefileï¼šåˆ†å¸ƒåœ¨ Linux å†…æ ¸æºä»£ç æ ¹ç›®å½•åŠå„å±‚ç›®å½•ä¸­ï¼Œå®šä¹‰ Linux å†…æ ¸çš„ç¼–è¯‘è§„åˆ™ï¼›<br> 2ã€é…ç½®æ–‡ä»¶ï¼ˆconfig.in(2.4å†…æ ¸ï¼Œ2.6å†…æ ¸)ï¼‰ï¼šç»™ç”¨æˆ·æä¾›é…ç½®é€‰æ‹©çš„åŠŸèƒ½ï¼›<br> 3ã€é…ç½®å·¥å…·ï¼šåŒ…æ‹¬é…ç½®å‘½ä»¤è§£é‡Šå™¨ï¼ˆå¯¹é…ç½®è„šæœ¬ä¸­ä½¿ç”¨çš„é…ç½®å‘½ä»¤è¿›è¡Œè§£é‡Šï¼‰å’Œé…ç½®ç”¨æˆ·ç•Œé¢</p><p>make menuconfigè¿‡ç¨‹ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-23%20201421.png"></p><p> 1ã€scriptsæ–‡ä»¶å¤¹å­˜æ”¾çš„æ˜¯è·Ÿmake menuconfigé…ç½®ç•Œé¢çš„å›¾å½¢ç»˜åˆ¶ç›¸å…³çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½œä¸ºä½¿ç”¨è€…æ— éœ€å…³å¿ƒè¿™ä¸ªæ–‡ä»¶å¤¹çš„å†…å®¹<br> 2ã€è¯»å–arch&#x2F;arch&#x2F;$ARCH&#x2F;Kconfigä»¥åŠå„å­ç›®å½•ä¸‹çš„Kcondigæ–‡ä»¶ï¼Œç”Ÿæˆé…ç½®æ¡ç›®ã€‚<br>        $ARCHç”±linuxå†…æ ¸æ ¹ç›®å½•ä¸‹çš„makefileæ–‡ä»¶å†³å®š<br>        ARCH            ?&#x3D; arm<br>        CROSS_COMPILE   ?&#x3D; arm-linux-<br>        Kconfigæ–‡ä»¶ä¸­ä¸ºé…ç½®ä¿¡æ¯çš„å®å®šä¹‰ï¼Œä¸æˆ‘ä»¬åœ¨make menuconfigå›¾å½¢ç•Œé¢çœ‹åˆ°çš„ä¿¡æ¯ä¸€è‡´ã€‚<br>        ä¾‹å¦‚ï¼š<br>        config CPU_S3C2410_DMA<br>                bool<br>                depends on S3C2410_DMA &amp;&amp; (CPU_S3C2410 || CPU_S3C2442)<br>                default y if CPU_S3C2410 || CPU_S3C2442<br>                help<br>                   DMA device selection for S3C2410 and compatible CPUs<br>    <strong>å› æ­¤ï¼ŒKconfigæ–‡ä»¶å¾ˆé‡è¦çš„ä½œç”¨å°±æ˜¯ï¼šå®šä¹‰é…ç½®å®ã€ç›¸å…³ä¾èµ–å…³ç³»ã€å¸®åŠ©ä¿¡æ¯</strong><br>3ã€<strong>è¯»å–å†…æ ¸æ ¹ç›®å½•ä¸‹.configæ–‡ä»¶ï¼Œç”Ÿæˆé…ç½®é€‰é¡¹:[*]ç¼–è¯‘è¿›å†…æ ¸ [M]ç¼–è¯‘ä¸ºæ¨¡å— [ ]ä¸ç¼–è¯‘</strong><br>        arch&#x2F;arm&#x2F;configs&#x2F;æ–‡ä»¶å¤¹ä¸‹å­˜æ”¾äº†ä¸€äº›é…ç½®æ¨¡æ¿<br>        æˆ‘ä»¬å¯ä»¥é€šè¿‡cp &#x2F;arch&#x2F;arm&#x2F;configs&#x2F;xx_defconfig .configæ¥ä½¿ç”¨è¿™äº›é…ç½®æ¨¡æ¿<br>        é€šè¿‡å›¾å½¢ç•Œé¢å˜æ›´é…ç½®é€‰é¡¹ä¼šè‡ªåŠ¨æ›´æ–°åˆ°.configæ–‡ä»¶ä¸­<br>        make disclean ä¼šåˆ é™¤.config<br>4ã€<strong>ç¼–è¯‘è¿‡ç¨‹æ ¹æ®.configç”Ÿæˆ Linuxå†…æ ¸æ ¹ç›®å½•ä¸‹çš„ include&#x2F;config&#x2F;auto.confæ–‡ä»¶</strong><br>        CONFIG_EEPROM_93CX6&#x3D;m<br>        CONFIG_DM9000&#x3D;y<br>        æ ¹ç›®å½•Makefileä»¥åŠå­ç›®å½•çš„Makefileæ ¹æ®auto.confç”Ÿæˆç¼–è¯‘æ¡ä»¶<br>        obj-$(CONFIG_DM9000) +&#x3D; dm9000.o &#x2F;&#x2F;obj-m +&#x3D; dm9000.o<br>5ã€<strong>ç¼–è¯‘è¿‡ç¨‹æ ¹æ®.configç”ŸæˆLinuxå†…æ ¸æ ¹ç›®å½•ä¸‹çš„ include&#x2F;linux&#x2F;autoconf.hæ–‡ä»¶</strong><br>        .config æˆ– auto.conf ä¸­å®šä¹‰è¦ç¼–è¯‘ä¸º m æ¨¡å—çš„é¡¹ï¼Œå¦‚ï¼š<br>        CONFIG_DEBUG_NX_TEST&#x3D;m<br>        åœ¨ autoconf.h ä¸­ä¼šè¢«å®šä¹‰ä¸ºï¼š<br>        #define CONFIG_DEBUG_NX_TEST_MODULE 1    </p><p>â€‹.configæˆ–auto.conf ä¸­å®šä¹‰ä¸ºç¼–è¯‘ä¸º y çš„é€‰é¡¹,å¦‚ï¼š<br>â€‹        CONFIG_DM9000&#x3D; y<br>â€‹        åœ¨ autoconf.h ä¸­ä¼šè¢«å®šä¹‰ä¸ºï¼š<br>â€‹        #define CONFIG_DM9000 1<br>â€‹        autoconf.hä¸­æ˜¯.configæˆ–è€…auto.confä¸­é…ç½®ä¿¡æ¯çš„å¦ä¸€ç§ä½“ç°å½¢å¼ï¼Œå®ƒæ˜¯ç«™åœ¨æºç çš„è§’åº¦ï¼Œä¾›æºç ä½¿ç”¨çš„Cè¯­è¨€å®å®šä¹‰ã€‚<br>   6ã€æ€»ç»“<br>â€‹        æˆ‘ä»¬åœ¨ä½¿ç”¨make menuconfigæ—¶ï¼Œé¦–å…ˆä¼šç¡®å®šæ¶æ„archï¼Œç„¶åè¯»å–archç›®å½•çš„Kconfigä¸­çš„é…ç½®å®å®šä¹‰ï¼Œç”Ÿæˆç¼–è¯‘æ¡ç›®ï¼Œç„¶åè¯»å–Linuxå†…æ ¸æ ¹ç›®å½•ä¸‹çš„.configé€‰é¡¹ï¼Œ å°†.configä¸­çš„é…ç½®ä¿¡æ¯æ˜¾ç¤ºåœ¨å›¾å½¢ç•Œé¢ä¸Š[*] [M] or []ã€‚æˆ‘ä»¬åœ¨å›¾å½¢ç•Œé¢ä¸­æ›´æ”¹é…ç½®é€‰é¡¹ä¼šè‡ªåŠ¨ä¿å­˜åˆ°.configæ–‡ä»¶ä¸­ã€‚ç¼–è¯‘è¿‡ç¨‹æ ¹æ®.configéšåç”Ÿæˆauto.confæ–‡ä»¶ï¼Œå®ƒå†³å®šäº†makefileä¸­å„ä¸ªæ–‡ä»¶çš„ç¼–è¯‘ç±»å‹ï¼Œé™æ€ç¼–è¯‘è¿›å†…æ ¸ã€ç¼–è¯‘æˆæ¨¡å—ã€ä¸ç¼–è¯‘;åŒæ—¶ç”Ÿæˆautoconf.hï¼Œå®ƒä»¥Cè¯­è¨€å®å®šä¹‰çš„å½¢å¼è¡¨è¾¾äº† å„ä¸ªæ–‡ä»¶æ˜¯å¦è¢«ç¼–è¯‘ï¼Œæºç ä¸­ä¼šåˆ¤æ–­æŸæ–‡ä»¶æ˜¯å¦è¢«ç¼–è¯‘è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚</p><h2 id="å†…æ ¸å¯åŠ¨æµç¨‹"><a href="#å†…æ ¸å¯åŠ¨æµç¨‹" class="headerlink" title="å†…æ ¸å¯åŠ¨æµç¨‹"></a>å†…æ ¸å¯åŠ¨æµç¨‹</h2><p>linuxå¯åŠ¨å‰è¦æ±‚ï¼š</p><p>â‘ ã€å…³é—­ MMUã€‚<br>â‘¡ã€å…³é—­ D-cacheã€‚<br>â‘¢ã€ I-Cache æ— æ‰€è°“ã€‚<br>â‘£ã€ r0&#x3D;0ã€‚<br>â‘¤ã€ r1&#x3D;machine nr(ä¹Ÿå°±æ˜¯æœºå™¨ ID)ã€‚<br>â‘¥ã€ r2&#x3D;atags æˆ–è€…è®¾å¤‡æ ‘(dtb)é¦–åœ°å€ã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/20170315225401860.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ç³»ç»Ÿç§»æ¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bootcmdå’Œbootargsç¯å¢ƒå˜é‡</title>
      <link href="/2023/03/22/2023-3-22-bootcmd%E5%92%8Cbootargs%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/"/>
      <url>/2023/03/22/2023-3-22-bootcmd%E5%92%8Cbootargs%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¯å¢ƒå˜é‡bootcmd"><a href="#ç¯å¢ƒå˜é‡bootcmd" class="headerlink" title="ç¯å¢ƒå˜é‡bootcmd"></a>ç¯å¢ƒå˜é‡bootcmd</h2><p>bootcmd ä¿å­˜ç€ uboot é»˜è®¤å‘½ä»¤ï¼Œ uboot å€’è®¡æ—¶ç»“æŸä»¥åå°±ä¼šæ‰§è¡Œ bootcmd ä¸­çš„å‘½ä»¤ã€‚è¿™äº›å‘½ä»¤ä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥å¯åŠ¨ Linux å†…æ ¸çš„ï¼Œæ¯”å¦‚è¯»å– EMMC æˆ–è€… NAND Flash ä¸­çš„ Linux å†…æ ¸é•œåƒæ–‡ä»¶å’Œè®¾å¤‡æ ‘æ–‡ä»¶åˆ° DRAM ä¸­ï¼Œç„¶åå¯åŠ¨ Linux å†…æ ¸ã€‚ </p><p>å¦‚æœ EMMC æˆ–è€… NAND ä¸­æ²¡æœ‰ä¿å­˜ bootcmd çš„å€¼ï¼Œé‚£ä¹ˆ uboot å°±ä¼šä½¿ç”¨é»˜è®¤çš„å€¼ï¼Œæ¿å­ç¬¬ä¸€æ¬¡è¿è¡Œ uboot çš„æ—¶å€™éƒ½ä¼šä½¿ç”¨é»˜è®¤å€¼æ¥è®¾ç½® bootcmd ç¯å¢ƒå˜é‡ã€‚ </p><p>ä¸è®¾ç½®bootcmdä½¿ç”¨é»˜è®¤ä»emmcå¯åŠ¨ï¼Œ<strong>å…ˆæ£€æŸ¥ä¸€ä¸‹ EMMC çš„åˆ†åŒº 1 ä¸­æœ‰æ²¡æœ‰Image æ–‡ä»¶å’Œè®¾å¤‡æ ‘æ–‡ä»¶ï¼Œè¾“å…¥å‘½ä»¤â€œls mmc 1:1â€</strong> é‚£ä¹ˆå¯ä»¥å®šä¹‰CONFIG_BOOTCOMMAND</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_BOOTCOMMAND \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;mmc dev 1;&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;fatload mmc 1:1 0x80800000 zImage;&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;fatload mmc 1:1 0x83000000 imx6ull-alientek-emmc.dtb;&quot;</span> \</span></span><br><span class="line"><span class="meta"><span class="string">&quot;bootz 0x80800000 - 0x83000000;&quot;</span></span></span><br></pre></td></tr></table></figure><p>æˆ–è€…åœ¨ubootä¸­è®¾ç½®bootcmd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd &#x27;mmc dev 1; fatload mmc 1:1 80800000 zImage; fatload mmc 1:1 83000000 imx6ull-alientek-emmc.dtb; bootz 80800000 - 83000000;&#x27;</span><br></pre></td></tr></table></figure><h2 id="ç¯å¢ƒå˜é‡bootargs"><a href="#ç¯å¢ƒå˜é‡bootargs" class="headerlink" title="ç¯å¢ƒå˜é‡bootargs"></a>ç¯å¢ƒå˜é‡bootargs</h2><p>bootargs ç¯å¢ƒå˜é‡æ˜¯ç”± mmcargs è®¾ç½®çš„ï¼Œ mmcargs ç¯å¢ƒå˜é‡å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmcargs=setenv bootargs console=$&#123;console&#125;,$&#123;baudrate&#125; root=$&#123;mmcroot&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ console&#x3D;ttymxc0ï¼Œ baudrate&#x3D;115200ï¼Œ mmcroot&#x3D;&#x2F;dev&#x2F;mmcblk1p2 rootwait rwï¼Œå› æ­¤å°†mmcargs å±•å¼€ä»¥åå°±æ˜¯ï¼š </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmcargs=setenv bootargs console= ttymxc0, 115200 root= /dev/mmcblk1p2 rootwait rw</span><br></pre></td></tr></table></figure><h4 id="console"><a href="#console" class="headerlink" title="console"></a>console</h4><p>console ç”¨æ¥è®¾ç½® linux ç»ˆç«¯(æˆ–è€…å«æ§åˆ¶å°)ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ä»€ä¹ˆè®¾å¤‡æ¥å’Œ Linux è¿›è¡Œäº¤äº’ï¼Œæ˜¯ä¸²å£è¿˜æ˜¯ LCD å±å¹•ï¼Ÿå¦‚æœæ˜¯ä¸²å£çš„è¯åº”è¯¥æ˜¯ä¸²å£å‡ ç­‰ç­‰ã€‚ä¸€èˆ¬è®¾ç½®ä¸²å£ä½œä¸º Linux ç»ˆç«¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ç”µè„‘ä¸Šé€šè¿‡ SecureCRT æ¥å’Œ linux äº¤äº’äº†ã€‚ </p><p>è®¾ç½® console ä¸º ttymxc0ï¼Œå› ä¸º linuxå¯åŠ¨ä»¥å I.MX6ULL çš„ä¸²å£ 1 åœ¨ linux ä¸‹çš„è®¾å¤‡æ–‡ä»¶å°±æ˜¯&#x2F;dev&#x2F;ttymxc0 ï¼Œ115200æ˜¯æ³¢ç‰¹ç‡ã€‚</p><h4 id="root"><a href="#root" class="headerlink" title="root"></a>root</h4><p>root ç”¨æ¥è®¾ç½®æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ä½ç½®ï¼Œ root&#x3D;&#x2F;dev&#x2F;mmcblk1p2 ç”¨äºæŒ‡æ˜æ ¹æ–‡ä»¶ç³»ç»Ÿå­˜æ”¾åœ¨mmcblk1 è®¾å¤‡çš„åˆ†åŒº 2 ä¸­ã€‚emmcå¯åŠ¨ä¼šå­˜åœ¨ä¸¤ç§æ–‡ä»¶ï¼Œå…¶ä¸­&#x2F;dev&#x2F;mmcblkx(x&#x3D;0<del>n)è¡¨ç¤º mmc è®¾å¤‡ï¼Œè€Œ&#x2F;dev&#x2F;mmcblkxpy(x&#x3D;0</del>n,y&#x3D;1~n)è¡¨ç¤º mmc è®¾å¤‡x çš„åˆ†åŒº yã€‚åœ¨ I.MX6U-ALPHA å¼€å‘æ¿ä¸­&#x2F;dev&#x2F;mmcblk1 è¡¨ç¤º EMMCï¼Œè€Œ&#x2F;dev&#x2F;mmcblk1p2 è¡¨ç¤ºEMMC çš„åˆ†åŒº 2ã€‚root åé¢æœ‰â€œrootwait rwâ€ï¼Œ rootwait è¡¨ç¤ºç­‰å¾… mmc è®¾å¤‡åˆå§‹åŒ–å®Œæˆä»¥åå†æŒ‚è½½ï¼Œå¦åˆ™çš„è¯mmc è®¾å¤‡è¿˜æ²¡åˆå§‹åŒ–å®Œæˆå°±æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿä¼šå‡ºé”™çš„ã€‚ rw è¡¨ç¤ºæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯å¯ä»¥è¯»å†™çš„ï¼Œä¸åŠ rw çš„è¯å¯èƒ½æ— æ³•åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­è¿›è¡Œå†™æ“ä½œï¼Œåªèƒ½è¿›è¡Œè¯»æ“ä½œã€‚ </p><h4 id="rootstype"><a href="#rootstype" class="headerlink" title="rootstype"></a>rootstype</h4><p>æ­¤é€‰é¡¹ä¸€èˆ¬é…ç½® root ä¸€èµ·ä½¿ç”¨ï¼Œ rootfstype ç”¨äºæŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå¦‚æœæ ¹æ–‡ä»¶ç³»ç»Ÿä¸ºext æ ¼å¼çš„è¯æ­¤é€‰é¡¹æ— æ‰€è°“ã€‚å¦‚æœæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ yaffsã€ jffs æˆ– ubifs çš„è¯å°±éœ€è¦è®¾ç½®æ­¤é€‰é¡¹ï¼ŒæŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹ã€‚ </p><h2 id="ç½‘ç»œå¯åŠ¨Linuxç³»ç»Ÿ"><a href="#ç½‘ç»œå¯åŠ¨Linuxç³»ç»Ÿ" class="headerlink" title="ç½‘ç»œå¯åŠ¨Linuxç³»ç»Ÿ"></a>ç½‘ç»œå¯åŠ¨Linuxç³»ç»Ÿ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;console=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw&#x27;</span><br><span class="line">setenv bootcmd &#x27;tftp 80800000 zImage; tftp 83000000 imx6ull-alientek-emmc.dtb; bootz</span><br><span class="line">80800000 - 83000000&#x27;</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure><p>æ²¡ç½‘å°±å®Œè›‹ã€‚</p><h2 id="ä»emmcå¯åŠ¨Linuxç³»ç»Ÿ"><a href="#ä»emmcå¯åŠ¨Linuxç³»ç»Ÿ" class="headerlink" title="ä»emmcå¯åŠ¨Linuxç³»ç»Ÿ"></a>ä»emmcå¯åŠ¨Linuxç³»ç»Ÿ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;console=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw&#x27;</span><br><span class="line">setenv bootcmd &#x27;mmc dev 1; fatload mmc 1:1 80800000 zImage; fatload mmc 1:1 83000000</span><br><span class="line">imx6ull-alientek-emmc.dtb; bootz 80800000 - 83000000;&#x27;</span><br></pre></td></tr></table></figure><p>å‰ææ˜¯è®¾å¤‡æ ‘å’Œé•œåƒå·²ç»çƒ§å…¥emmcä¸­ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> ç³»ç»Ÿç§»æ¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>U-Bootç§»æ¤</title>
      <link href="/2023/03/21/2023-3-21-U-Boot%E7%A7%BB%E6%A4%8D/"/>
      <url>/2023/03/21/2023-3-21-U-Boot%E7%A7%BB%E6%A4%8D/</url>
      
        <content type="html"><![CDATA[<h3 id="Ubootçš„ç§»æ¤"><a href="#Ubootçš„ç§»æ¤" class="headerlink" title="Ubootçš„ç§»æ¤"></a>Ubootçš„ç§»æ¤</h3><p>é¦–å…ˆä»å®˜æ–¹ä¸‹è½½ä¸€ä¸ªUbootï¼Œä¹‹ååœ¨æ­¤ä¸Šé¢è¿›è¡Œç§»æ¤ï¼Œå¯ä»¥è¿›è¡Œä½¿ç”¨è„šæœ¬è¿›è¡Œç¼–è¯‘ä¸€ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm CORSS_COMPILE=arm-linux-gnueabihf- distclean</span><br><span class="line">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- mx6ull_14x14_evk_emmc_defconfig</span><br><span class="line">make V=1 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><h3 id="åœ¨Ubootä¸­æ·»åŠ ä½¿ç”¨çš„å¼€å‘æ¿"><a href="#åœ¨Ubootä¸­æ·»åŠ ä½¿ç”¨çš„å¼€å‘æ¿" class="headerlink" title="åœ¨Ubootä¸­æ·»åŠ ä½¿ç”¨çš„å¼€å‘æ¿"></a>åœ¨Ubootä¸­æ·»åŠ ä½¿ç”¨çš„å¼€å‘æ¿</h3><h4 id="æ·»åŠ å¼€å‘æ¿é»˜è®¤é…ç½®æ–‡ä»¶"><a href="#æ·»åŠ å¼€å‘æ¿é»˜è®¤é…ç½®æ–‡ä»¶" class="headerlink" title="æ·»åŠ å¼€å‘æ¿é»˜è®¤é…ç½®æ–‡ä»¶"></a>æ·»åŠ å¼€å‘æ¿é»˜è®¤é…ç½®æ–‡ä»¶</h4><p>å°†cofigsç›®å½•ä¸‹å¤åˆ¶åŸæœ‰çš„mx6ull_14x14_evk_emmc_defconfigè¿›è¡Œä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp mx6ull_14x14_evk_emmc_defconfig mx6ull_alientek_emmc_defconfig</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹mx6ull_alientek_emmc_defconfigæ–‡ä»¶ï¼Œå°†åŸæœ‰çš„æ›¿æ¢æˆmx6ull_alientek_emmc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SYS_EXTRA_OPTIONS=&quot;IMX_CONFIG=board/freescale/mx6ull_alientek_emmc/imximage.cfg,MX6ULL_EVK_EMMC_REWORK&quot;</span><br><span class="line">CONFIG_ARM=y</span><br><span class="line">CONFIG_ARCH_MX6=y</span><br><span class="line">CONFIG_TARGET_MX6ULL_ALIENTEK_EMMC=y</span><br><span class="line">CONFIG_CMD_GPIO=y</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„å¤´æ–‡ä»¶"><a href="#æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„å¤´æ–‡ä»¶" class="headerlink" title="æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„å¤´æ–‡ä»¶"></a>æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„å¤´æ–‡ä»¶</h4><p>åœ¨ ç›® å½• include&#x2F;configs ä¸‹ æ·» åŠ  I.MX6ULL-ALPHA å¼€ å‘ æ¿ å¯¹ åº” çš„ å¤´ æ–‡ ä»¶ ï¼Œ å¤ åˆ¶include&#x2F;configs&#x2F;mx6ullevk.hï¼Œå¹¶é‡å‘½åä¸º mx6ull_alientek_emmc.hï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp include/configs/mx6ullevk.h mx6ull_alientek_emmc.h</span><br></pre></td></tr></table></figure><p>æ‹·è´å®Œæˆä»¥åå°†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ifndef __MX6ULLEVK_CONFIG_H</span><br><span class="line">#define __MX6ULLEVK_CONFIG_H</span><br></pre></td></tr></table></figure><p>æ”¹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ifndef __MX6ULL_ALIENTEK_EMMC_CONFIG_H</span><br><span class="line">#define __MX6ULL_ALIENTEK_EMMC_CONFIG_H </span><br></pre></td></tr></table></figure><p>æ­¤å¤´æ–‡ä»¶ä¸»è¦åŠŸèƒ½å°±æ˜¯é…ç½®æˆ–è€…è£å‰ª ubootã€‚å¦‚æœéœ€è¦æŸä¸ªåŠŸèƒ½çš„è¯å°±åœ¨é‡Œé¢æ·»åŠ è¿™ä¸ªåŠŸèƒ½å¯¹åº”çš„ CONFIG_XXX å®å³å¯ï¼Œå¦‚æœä¸éœ€è¦æŸä¸ªåŠŸèƒ½çš„è¯å°±åˆ é™¤æ‰å¯¹åº”çš„å®å³å¯ã€‚ </p><h4 id="æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„æ¿çº§æ–‡ä»¶å¤¹"><a href="#æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„æ¿çº§æ–‡ä»¶å¤¹" class="headerlink" title="æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„æ¿çº§æ–‡ä»¶å¤¹"></a>æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„æ¿çº§æ–‡ä»¶å¤¹</h4><p>NXP çš„ I.MX ç³»åˆ—èŠ¯ç‰‡çš„æ‰€æœ‰æ¿çº§æ–‡ä»¶å¤¹éƒ½å­˜æ”¾åœ¨ board&#x2F;freescale ç›®å½•ä¸‹ï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸‹æœ‰ä¸ªåä¸º mx6ullevk çš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹å°±æ˜¯ NXP å®˜æ–¹ I.MX6ULL EVK å¼€å‘æ¿çš„æ¿çº§æ–‡ä»¶å¤¹ã€‚ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd board/freescale/</span><br><span class="line">cp mx6ullevk/ -r mx6ull_alientek_emmc</span><br><span class="line">cd mx6ull_alientek_emmc</span><br><span class="line">mv mx6ullevk.c mx6ull_alientek_emmc.c</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«éœ€è¦ä¿®æ”¹Makefileæ–‡ä»¶ã€imximage.cfg  æ–‡ä»¶ã€Kconfig æ–‡ä»¶ ã€MAINTAINERS æ–‡ä»¶ </p><p>Makefileè¦æ”¹ç¼–è¯‘çš„.oçš„æ–‡ä»¶åå­—ã€‚</p><p>imximage.cfg éœ€è¦ä¿®æ”¹PLUGIN åé¢çš„æ¿è½½äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨è·¯å¾„ã€‚</p><p>Kconfig æ–‡ä»¶ éœ€è¦æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if TARGET_MX6ULL_ALIENTEK_EMMC</span><br><span class="line"></span><br><span class="line">config SYS_BOARD</span><br><span class="line">default &quot;mx6ull_alientek_emmc&quot;</span><br><span class="line"></span><br><span class="line">config SYS_VENDOR</span><br><span class="line">default &quot;freescale&quot;</span><br><span class="line"></span><br><span class="line">config SYS_SOC</span><br><span class="line">default &quot;mx6&quot;</span><br><span class="line"></span><br><span class="line">config SYS_CONFIG_NAME</span><br><span class="line">default &quot;mx6ull_alientek_emmc&quot;</span><br><span class="line"></span><br><span class="line">endif</span><br></pre></td></tr></table></figure><p>MAINTAINERS æ–‡ä»¶éœ€æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MX6ULL_ALIENTEK_EMMC BOARD</span><br><span class="line">M: Peng Fan &lt;peng.fan@nxp.com&gt;</span><br><span class="line">S: Maintained</span><br><span class="line">F: board/freescale/mx6ull_alientek_emmc/</span><br><span class="line">F: include/configs/mx6ull_alientek_emmc.h</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹U-bootå›¾å½¢åŒ–é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹U-bootå›¾å½¢åŒ–é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹U-bootå›¾å½¢åŒ–é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹U-bootå›¾å½¢åŒ–é…ç½®æ–‡ä»¶</h4><p>ä¿®æ”¹æ–‡ä»¶arch&#x2F;arm&#x2F;cpu&#x2F;armv7&#x2F;mx6&#x2F;Kconfig ï¼Œ207è¡ŒåŠ å…¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config TARGET_MX6ULL_ALIENTEK_EMMC</span><br><span class="line">bool &quot;Support mx6ull_alientek_emmc&quot;</span><br><span class="line">select MX6ULL</span><br><span class="line">select DM</span><br><span class="line">select DM_THERMAL</span><br></pre></td></tr></table></figure><p>endifå‰åŠ å…¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &quot;board/freescale/mx6ull_alientek_emmc/Kconfig&quot;</span><br></pre></td></tr></table></figure><h3 id="LCDé©±åŠ¨ä¿®æ”¹"><a href="#LCDé©±åŠ¨ä¿®æ”¹" class="headerlink" title="LCDé©±åŠ¨ä¿®æ”¹"></a>LCDé©±åŠ¨ä¿®æ”¹</h3><p>ä¸€èˆ¬ uboot ä¸­ä¿®æ”¹é©±åŠ¨åŸºæœ¬éƒ½æ˜¯åœ¨ xxx.h å’Œ xxx.c è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­è¿›è¡Œçš„ï¼Œ xxx ä¸ºæ¿å­åç§°ï¼Œæ¯”å¦‚ mx6ull_alientek_emmc.h å’Œ mx6ull_alientek_emmc.c è¿™ä¸¤ä¸ªæ–‡ä»¶ã€‚<br>ä¸€èˆ¬ä¿®æ”¹ LCD é©±åŠ¨é‡ç‚¹æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š<br>â‘ ã€ LCD æ‰€ä½¿ç”¨çš„ GPIOï¼ŒæŸ¥çœ‹ uboot ä¸­ LCD çš„ IO é…ç½®æ˜¯å¦æ­£ç¡®ã€‚<br>â‘¡ã€ LCD èƒŒå…‰å¼•è„š GPIO çš„é…ç½®ã€‚<br>â‘¢ã€ LCD é…ç½®å‚æ•°æ˜¯å¦æ­£ç¡®ã€‚ </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-20%20204212.png"></p><p>åŸºäºä½¿ç”¨çš„lcdè®¾ç½®å‚æ•°ä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.mode= &#123;</span><br><span class="line">.name= &quot;TFT4384&quot;,</span><br><span class="line">.xres           = 800,</span><br><span class="line">.yres           = 480,</span><br><span class="line">.pixclock       = 31746,</span><br><span class="line">.left_margin    = 88,</span><br><span class="line">.right_margin   = 40,</span><br><span class="line">.upper_margin   = 32,</span><br><span class="line">.lower_margin   = 13,</span><br><span class="line">.hsync_len      = 48,</span><br><span class="line">.vsync_len      = 3,</span><br><span class="line">.sync           = 0,</span><br><span class="line">.vmode          = FB_VMODE_NONINTERLACED</span><br></pre></td></tr></table></figure><p>å°†mx6ull_alientek_emmc.hä¸­çš„panelè¿›è¡Œä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">panel=TFT4384</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥ç¼–è¯‘çƒ§å½•ã€‚æ­£å¸¸æ˜¾ç¤ºå‡ºç°ä»¥ä¸‹ä¸œè¥¿ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-22%20133153.png"></p><p>å¦‚æœæ²¡æœ‰å‡ºç°æ•ˆæœï¼Œä¿®æ”¹ç¯å¢ƒå˜é‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenv panel TFT7016</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure><p>å¦‚æœåªæ˜¾ç¤ºNXPæ²¡æœ‰ubootçš„ç‰ˆæœ¬å·ï¼Œå¹¶ä¸”æŠ¥é”™<strong>no valid bmp image at 88000000</strong>ï¼Œä½¿ç”¨ubootå‘½ä»¤æ¸…é™¤ä¸€ä¸‹ç¯å¢ƒå˜é‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">env default -a</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure><h3 id="ç½‘ç»œé©±åŠ¨ä¿®æ”¹"><a href="#ç½‘ç»œé©±åŠ¨ä¿®æ”¹" class="headerlink" title="ç½‘ç»œé©±åŠ¨ä¿®æ”¹"></a>ç½‘ç»œé©±åŠ¨ä¿®æ”¹</h3><p><strong>æ›´æ¢ PHY èŠ¯ç‰‡ä»¥åå¦‚ä½•è°ƒæ•´ç½‘ç»œé©±åŠ¨</strong> </p><p>ä¿®æ”¹ ENET1 ç½‘ç»œé©±åŠ¨çš„è¯é‡ç‚¹å°±ä¸‰ç‚¹ï¼š<br>â‘ ã€ ENET1 å¤ä½å¼•è„šåˆå§‹åŒ–ã€‚<br>â‘¡ã€ LAN8720A çš„å™¨ä»¶ IDã€‚<br>â‘¢ã€ LAN8720 é©±åŠ¨ </p><p>ENET2 ç½‘ç»œé©±åŠ¨çš„ä¿®æ”¹ä¹Ÿæ³¨æ„ä¸€ä¸‹ä¸‰ç‚¹ï¼š<br>â‘ ã€ ENET2 çš„å¤ä½å¼•è„šï¼Œä»å›¾ 33.2.7.2 å¯ä»¥çœ‹å‡ºï¼Œ ENET2 çš„å¤ä½å¼•è„š ENET2_RST æ¥åˆ°äº†<br>I.MX6ULL çš„ SNVS_TAMPER8 ä¸Šã€‚<br>â‘¡ã€ ENET2 æ‰€ä½¿ç”¨çš„ PHY èŠ¯ç‰‡å™¨ä»¶åœ°å€ï¼Œä»å›¾ 33.2.7.2 å¯ä»¥çœ‹å‡ºï¼Œ PHY å™¨ä»¶åœ°å€ä¸º 0X1ã€‚<br>â‘¢ã€ LAN8720 é©±åŠ¨ï¼Œ ENET1 å’Œ ENET2 éƒ½ä½¿ç”¨çš„ LAN8720ï¼Œæ‰€ä»¥é©±åŠ¨è‚¯å®šæ˜¯ä¸€æ ·çš„ã€‚ </p><h4 id="ç½‘ç»œPHYåœ°å€ä¿®æ”¹"><a href="#ç½‘ç»œPHYåœ°å€ä¿®æ”¹" class="headerlink" title="ç½‘ç»œPHYåœ°å€ä¿®æ”¹"></a>ç½‘ç»œPHYåœ°å€ä¿®æ”¹</h4><p>ä¿®æ”¹ENETIå’ŒENET2çš„PHYåœ°å€å’Œé©±åŠ¨ï¼ŒENET1å’ŒENET2çš„PHYçš„åœ°å€å­˜åœ¨mx6ull_alientek_emmc.hä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#if (CONFIG_FEC_ENET_DEV == 0)</span><br><span class="line">#define CONFIG_FEC_MXC_PHYADDR 0x2//ENET1çš„åœ°å€æ”¹ä¸º0x0</span><br><span class="line">#elif (CONFIG_FEC_ENET_DEV == 1)</span><br><span class="line">#define CONFIG_FEC_MXC_PHYADDR 0x1//ENET2çš„åœ°å€ç›¸åŒä¸ç”¨æ”¹</span><br><span class="line">#define CONFIG_PHY_MICREL //ä½¿ç”¨ LAN8720Aåˆ™æ”¹ä¸ºCONFIG_PHY_SMSC</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸¤ä¸ªæ¿å­çš„å¤ä½å¼•è„šä¸åŒã€‚åˆ é™¤ä¹‹å‰ä¸ºäº†å¤ä½çš„æ‰©å±•IOçš„ä»£ç ï¼Œåœ¨mx6ull_alientek_emmc.cä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define IOX_SDI IMX_GPIO_NR(5, 10)</span><br><span class="line">#define IOX_STCP IMX_GPIO_NR(5, 7)</span><br><span class="line">#define IOX_SHCP IMX_GPIO_NR(5, 11)</span><br><span class="line">#define IOX_OE IMX_GPIO_NR(5, 8)</span><br></pre></td></tr></table></figure><p>æ›¿æ¢ä¸ºè‡ªå·±ä½¿ç”¨æ¿å­çš„ç½‘ç»œå¤ä½IO</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define ENET1_RESET IMX_GPIO_NR(5, 7)</span><br><span class="line">#define ENET2_RESET IMX_GPIO_NR(5, 8)</span><br></pre></td></tr></table></figure><p>åˆ é™¤åŸæœ‰ç»“æ„ä½“å’Œå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">iomux_v3_cfg_t</span> <span class="type">const</span> iox_pads[] = &#123;</span><br><span class="line"><span class="comment">/* IOX_SDI */</span></span><br><span class="line">MX6_PAD_BOOT_MODE0__GPIO5_IO10 | MUX_PAD_CTRL(NO_PAD_CTRL),</span><br><span class="line"><span class="comment">/* IOX_SHCP */</span></span><br><span class="line">MX6_PAD_BOOT_MODE1__GPIO5_IO11 | MUX_PAD_CTRL(NO_PAD_CTRL),</span><br><span class="line"><span class="comment">/* IOX_STCP */</span></span><br><span class="line">MX6_PAD_SNVS_TAMPER7__GPIO5_IO07 | MUX_PAD_CTRL(NO_PAD_CTRL),</span><br><span class="line"><span class="comment">/* IOX_nOE */</span></span><br><span class="line">MX6_PAD_SNVS_TAMPER8__GPIO5_IO08 | MUX_PAD_CTRL(NO_PAD_CTRL),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">iox74lv_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line">gpio_direction_output(IOX_OE, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">gpio_direction_output(IOX_SHCP, <span class="number">0</span>);</span><br><span class="line">gpio_direction_output(IOX_SDI, seq[qn_output[i]][<span class="number">0</span>]);</span><br><span class="line">udelay(<span class="number">500</span>);</span><br><span class="line">gpio_direction_output(IOX_SHCP, <span class="number">1</span>);</span><br><span class="line">udelay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* shift register will be output to pins</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">gpio_direction_output(IOX_STCP, <span class="number">1</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">iox74lv_set</span><span class="params">(<span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">gpio_direction_output(IOX_SHCP, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (i == index)</span><br><span class="line">gpio_direction_output(IOX_SDI, seq[qn_output[i]][<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">gpio_direction_output(IOX_SDI, seq[qn_output[i]][<span class="number">1</span>]);</span><br><span class="line">udelay(<span class="number">500</span>);</span><br><span class="line">gpio_direction_output(IOX_SHCP, <span class="number">1</span>);</span><br><span class="line">udelay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* shift register will be output to pins</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">gpio_direction_output(IOX_STCP, <span class="number">1</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åˆ æ‰æ¿å­åˆå§‹åŒ–å‡½æ•°ä¸­çš„ç›¸å…³ç¨‹åº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">board_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">imx_iomux_v3_setup_multiple_pads(iox_pads, ARRAY_SIZE(iox_pads));<span class="comment">//åˆ æ‰</span></span><br><span class="line">iox74lv_init();<span class="comment">//åˆ æ‰</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ è‡ªå·±å¼€å‘æ¿çš„ç½‘ç»œå¤ä½å¼•è„šé©±åŠ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">iomux_v3_cfg_t</span> <span class="type">const</span> fec1_pads[] = </span><br><span class="line">&#123;</span><br><span class="line">MX6_PAD_GPIO1_IO06__ENET1_MDIO | MUX_PAD_CTRL(MDIO_PAD_CTRL),</span><br><span class="line">MX6_PAD_GPIO1_IO07__ENET1_MDC | MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="line">...</span><br><span class="line">MX6_PAD_ENET1_RX_ER__ENET1_RX_ER | MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="line">MX6_PAD_ENET1_RX_EN__ENET1_RX_EN | MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="line">MX6_PAD_SNVS_TAMPER7__GPIO5_IO07 | MUX_PAD_CTRL(NO_PAD_CTRL), <span class="comment">//æ–°åŠ çš„</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">iomux_v3_cfg_t</span> <span class="type">const</span> fec2_pads[] = </span><br><span class="line">&#123;</span><br><span class="line">MX6_PAD_GPIO1_IO06__ENET2_MDIO | MUX_PAD_CTRL(MDIO_PAD_CTRL),</span><br><span class="line">MX6_PAD_GPIO1_IO07__ENET2_MDC | MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="line">...</span><br><span class="line">MX6_PAD_ENET2_RX_EN__ENET2_RX_EN | MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="line">MX6_PAD_ENET2_RX_ER__ENET2_RX_ER | MUX_PAD_CTRL(ENET_PAD_CTRL),</span><br><span class="line">MX6_PAD_SNVS_TAMPER8__GPIO5_IO08 | MUX_PAD_CTRL(NO_PAD_CTRL),<span class="comment">//æ–°åŠ çš„</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åˆå§‹åŒ–ç½‘ç»œIOçš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">setup_iomux_fec</span><span class="params">(<span class="type">int</span> fec_id)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fec_id == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">imx_iomux_v3_setup_multiple_pads(fec1_pads,ARRAY_SIZE(fec1_pads));</span><br><span class="line">gpio_direction_output(ENET1_RESET, <span class="number">1</span>);</span><br><span class="line">gpio_set_value(ENET1_RESET, <span class="number">0</span>);</span><br><span class="line">mdelay(<span class="number">20</span>);</span><br><span class="line">gpio_set_value(ENET1_RESET, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">imx_iomux_v3_setup_multiple_pads(fec2_pads,ARRAY_SIZE(fec2_pads));</span><br><span class="line">gpio_direction_output(ENET2_RESET, <span class="number">1</span>);</span><br><span class="line">gpio_set_value(ENET2_RESET, <span class="number">0</span>);</span><br><span class="line">mdelay(<span class="number">20</span>);</span><br><span class="line">gpio_set_value(ENET2_RESET, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ drivers&#x2F;net&#x2F;phy&#x2F;phy.c æ–‡ä»¶ä¸­çš„å‡½æ•° genphy_update_link </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">genphy_update_link</span><span class="params">(<span class="keyword">struct</span> phy_device *phydev)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> mii_reg;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PHY_SMSC</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> lan8720_flag = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> bmcr_reg = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (lan8720_flag == <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">bmcr_reg = phy_read(phydev, MDIO_DEVAD_NONE, MII_BMCR);</span><br><span class="line">phy_write(phydev, MDIO_DEVAD_NONE, MII_BMCR, BMCR_RESET);</span><br><span class="line"><span class="keyword">while</span>(phy_read(phydev, MDIO_DEVAD_NONE, MII_BMCR) &amp; <span class="number">0X8000</span>) </span><br><span class="line">        &#123;</span><br><span class="line">udelay(<span class="number">100</span>);</span><br><span class="line"> &#125;</span><br><span class="line">phy_write(phydev, MDIO_DEVAD_NONE, MII_BMCR, bmcr_reg);</span><br><span class="line">lan8720_flag = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Wait if the link is up, and autonegotiation is in progress</span></span><br><span class="line"><span class="comment"> * (ie - we&#x27;re capable and it&#x27;s not done)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">mii_reg = phy_read(phydev, MDIO_DEVAD_NONE, MII_BMSR);</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±åœ¨Ubootä¸­è®¾ç½®ç¯å¢ƒå˜é‡ç½‘å€å°±å¯ä»¥åº”ç”¨äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> ç³»ç»Ÿç§»æ¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>U-Bootå¯åŠ¨æµç¨‹</title>
      <link href="/2023/03/17/2023-3-17-U-Boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
      <url>/2023/03/17/2023-3-17-U-Boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h3 id="Ubooté¡¶å±‚Makefileè¯¦è§£"><a href="#Ubooté¡¶å±‚Makefileè¯¦è§£" class="headerlink" title="Ubooté¡¶å±‚Makefileè¯¦è§£"></a>Ubooté¡¶å±‚Makefileè¯¦è§£</h3><p><a href="https://blog.csdn.net/liurunjiang/article/details/107386600#:~:text=U-Boot%20%E9%A1%B6%E5%B1%82%20Makefile%20%E8%AF%A6%E8%A7%A3_River-D%E7%9A%84%E5%8D%9A%E5%AE%A2-CSDN%E5%8D%9A%E5%AE%A2%20U-Boot%20%E9%A1%B6%E5%B1%82%20Makefile%20%E8%AF%A6%E8%A7%A31%E3%80%81U-Boot,%E5%B7%A5%E7%A8%8B%E7%9B%AE%E5%BD%95%E5%88%86%E6%9E%90%E6%88%91%E4%BB%AC%E5%9C%A8%E5%88%86%E6%9E%90%20uboot%20%E6%BA%90%E7%A0%81%E4%B9%8B%E5%89%8D%E4%B8%80%E5%AE%9A%E8%A6%81%E5%85%88%E5%9C%A8%20Ubuntu%20%E4%B8%AD%E7%BC%96%E8%AF%91%E4%B8%80%E4%B8%8B%20uboot%20%E6%BA%90%E7%A0%81%EF%BC%8C%E5%9B%A0%E4%B8%BA%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E4%BC%9A%E7%94%9F%E6%88%90%E4%B8%80%E4%BA%9B%E6%96%87%E4%BB%B6%EF%BC%8C%E8%80%8C%E7%94%9F%E6%88%90%E7%9A%84%E8%BF%99%E4%BA%9B%E6%81%B0%E6%81%B0%E6%98%AF%E5%88%86%E6%9E%90uboot%20%E6%BA%90%E7%A0%81%E4%B8%8D%E5%8F%AF%E6%88%96%E7%BC%BA%E7%9A%84%E6%96%87%E4%BB%B6%E3%80%82">(123æ¡æ¶ˆæ¯) U-Boot é¡¶å±‚ Makefile è¯¦è§£_River-Dçš„åšå®¢-CSDNåšå®¢</a></p><table><thead><tr><th>åå­—</th><th>æè¿°</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>api</td><td>ä¸ç¡¬ä»¶æ— å…³çš„ API å‡½æ•°ã€‚</td><td>uboot è‡ªå¸¦</td></tr><tr><td>arch</td><td>ä¸æ¶æ„ä½“ç³»æœ‰å…³çš„ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>board</td><td>ä¸åŒæ¿å­çš„ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>cmd</td><td>å‘½ä»¤ç›¸å…³çš„ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>common</td><td>é€šç”¨ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>configs</td><td>é…ç½®æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>disk</td><td>ç£ç›˜åˆ†åŒºç›¸å…³ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>doc</td><td>æ–‡æ¡£</td><td>uboot è‡ªå¸¦</td></tr><tr><td>drivers</td><td>é©±åŠ¨ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>dts</td><td>è®¾å¤‡æ ‘</td><td>uboot è‡ªå¸¦</td></tr><tr><td>examples</td><td>ç¤ºä¾‹ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>fs</td><td>æ–‡ä»¶ç³»ç»Ÿ</td><td>uboot è‡ªå¸¦</td></tr><tr><td>include</td><td>å¤´æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>lib</td><td>åº“æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>Licenses</td><td>è®¸å¯è¯ç›¸å…³ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>net</td><td>ç½‘ç»œç›¸å…³ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>post</td><td>ä¸Šç”µè‡ªæ£€ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>scripts</td><td>è„šæœ¬æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>test</td><td>æµ‹è¯•ä»£ç </td><td>uboot è‡ªå¸¦</td></tr><tr><td>tools</td><td>å·¥å…·æ–‡ä»¶å¤¹</td><td>uboot è‡ªå¸¦</td></tr><tr><td>.configé…ç½®æ–‡ä»¶</td><td>é‡è¦çš„æ–‡ä»¶</td><td>ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶</td></tr><tr><td>.gitignore git</td><td>å·¥å…·ç›¸å…³æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>.mailmap</td><td>é‚®ä»¶åˆ—è¡¨</td><td>uboot è‡ªå¸¦</td></tr><tr><td>.u-boot.xxx.cmd(ä¸€ç³»åˆ—)</td><td>è¿™æ˜¯ä¸€ç³»åˆ—çš„æ–‡ä»¶ï¼Œç”¨äºä¿å­˜ç€ä¸€äº›å‘½ä»¤</td><td>ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶</td></tr><tr><td>config.mk</td><td>æŸä¸ªMakefile ä¼šè°ƒç”¨æ­¤æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>imxdownload</td><td>çƒ§å†™è½¯ä»¶</td><td></td></tr><tr><td>Kbuild</td><td>ç”¨äºç”Ÿæˆä¸€äº›å’Œæ±‡ç¼–ç›¸å…³çš„æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>Kconfig</td><td>å›¾å½¢é…ç½®ç•Œé¢æè¿°æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>MAINTAINERS</td><td>ç»´æŠ¤è€…è”ç³»æ–¹å¼æ–‡ä»¶</td><td>uboot è‡ªå¸¦</td></tr><tr><td>MAKEALL</td><td>ä¸€ä¸ªshellè„šæœ¬æ–‡ä»¶ï¼Œå¸®åŠ©ç¼–è¯‘uboot</td><td>uboot è‡ªå¸¦</td></tr><tr><td>Makefile</td><td>ä¸»Makefile</td><td>uboot è‡ªå¸¦</td></tr><tr><td>mx6ull_alientek_emmc.sh</td><td>ç¼–å†™çš„ç¼–è¯‘è„šæœ¬æ–‡ä»¶</td><td></td></tr><tr><td>mx6ull_alientek_nand.sh</td><td>åŒä¸Š</td><td></td></tr><tr><td>README</td><td>å¸®åŠ©æ–‡æ¡£</td><td>uboot è‡ªå¸¦</td></tr><tr><td>snapshot.commint</td><td>ï¼Ÿ</td><td>uboot è‡ªå¸¦</td></tr><tr><td>System.map</td><td>ç³»ç»Ÿæ˜ å°„æ–‡ä»¶</td><td>ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶</td></tr><tr><td>u-boot</td><td>ç¼–è¯‘å‡ºæ¥çš„U-bootæ–‡ä»¶</td><td>ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶</td></tr><tr><td>u-boot.xxx(ä¸€ç³»åˆ—)</td><td>ç”Ÿæˆä¸€äº›u-bootç›¸å…³çš„æ–‡ä»¶</td><td>ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶</td></tr></tbody></table><p>makeå‘½ä»¤çš„æµç¨‹</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-17%20110210.png"></p><h3 id="Ubootå¯åŠ¨æµç¨‹"><a href="#Ubootå¯åŠ¨æµç¨‹" class="headerlink" title="Ubootå¯åŠ¨æµç¨‹"></a>Ubootå¯åŠ¨æµç¨‹</h3><p>1)è®¾ç½®CPUä¸ºç®¡ç†æ¨¡å¼<br>2)å…³çœ‹é—¨ç‹—<br>3)å…³ä¸­æ–­<br>4ï¼‰è®¾ç½®æ—¶é’Ÿé¢‘ç‡<br>5)å…³mmu,åˆå§‹åŒ–å„ä¸ªbank<br>6)è¿›å…¥board_init_f()å‡½æ•° (åˆå§‹åŒ–å®šæ—¶å™¨,GPIO,ä¸²å£ç­‰,åˆ’åˆ†å†…å­˜åŒºåŸŸ)<br>7)é‡å®šä½     å¤åˆ¶uboot,ç„¶åä¿®æ”¹SDRAMä¸Šçš„ubooté“¾æ¥åœ°å€)<br>8)æ¸…bss<br>9)è·³è½¬åˆ°board_init_r()å‡½æ•°,å¯åŠ¨æµç¨‹ç»“æŸ<br><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/11c1d307acd641938a58a17230b05bbb.png"></p><p>bootzå¯åŠ¨Linuxå†…æ ¸è¿‡ç¨‹</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-20%20143309.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ç³»ç»Ÿç§»æ¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6ull SPIæ§åˆ¶å…­è½´</title>
      <link href="/2023/03/16/2023-3-15-imx6ull-SPI%E6%8E%A7%E5%88%B6%E5%85%AD%E8%BD%B4/"/>
      <url>/2023/03/16/2023-3-15-imx6ull-SPI%E6%8E%A7%E5%88%B6%E5%85%AD%E8%BD%B4/</url>
      
        <content type="html"><![CDATA[<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><p>SPI å…¨ç§°æ˜¯ Serial Perripheral Interfaceï¼Œä¹Ÿå°±æ˜¯ä¸²è¡Œå¤–å›´è®¾å¤‡æ¥å£ã€‚æ˜¯ä¸€ç§é«˜é€Ÿã€<strong>å…¨åŒå·¥</strong>çš„åŒæ­¥é€šä¿¡æ€»çº¿ï¼ŒSPI æ—¶é’Ÿé¢‘ç‡ç›¸æ¯” I2C è¦é«˜å¾ˆå¤šï¼Œæœ€é«˜å¯ä»¥å·¥ä½œåœ¨ä¸Šç™¾ MHzã€‚</p><p><a href="https://shequ.stmicroelectronics.cn/forum.php?mod=viewthread&tid=627137">SPIåŸç†è¶…è¯¦ç»†è®²è§£-å€¼å¾—ä¸€çœ‹ (stmicroelectronics.cn)</a></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/e84057dcf8574933a3875761dd6002ef.png"></p><p>æ”¯æŒ<strong>å•ä¸»å¤šä»æ¨¡å¼åº”ç”¨ï¼Œæ—¶é’Ÿç”±Masteræ§åˆ¶ï¼Œåœ¨æ—¶é’Ÿç§»ä½è„‰å†²ä¸‹ï¼Œæ•°æ®æŒ‰ä½ä¼ è¾“ï¼Œé«˜ä½åœ¨å‰ï¼Œä½ä½åœ¨åï¼ˆMSB firstï¼‰ã€‚</strong> <strong>4çº¿SPIå™¨ä»¶æœ‰å››ä¸ªä¿¡å·ï¼šæ—¶é’Ÿ(SPI CLK, SCLK)ã€ä¸»æœºè¾“å‡ºä»æœºè¾“å…¥(MOSI)ã€ä¸»æœºè¾“å…¥ä»æœºè¾“å‡º(MISO)ã€ç‰‡é€‰(CS&#x2F;NSS)ã€‚</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-15%20150651.png"></p><h3 id="SPIæ•°æ®ä¼ è¾“"><a href="#SPIæ•°æ®ä¼ è¾“" class="headerlink" title="SPIæ•°æ®ä¼ è¾“"></a>SPIæ•°æ®ä¼ è¾“</h3><p>åœ¨MOSIã€MISOå’ŒSPIä¸»ä»æœºå†…éƒ¨çš„<a href="https://www.zhihu.com/search?q=%E6%95%B0%E6%8D%AE%E5%AF%84%E5%AD%98%E5%99%A8&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:2762981085%7D">æ•°æ®å¯„å­˜å™¨</a>æ„æˆä¸€ä¸ªæ•°æ®ä¸²è¡Œä¼ è¾“çš„ç¯è·¯ï¼Œåœ¨æ—¶é’ŸSCLKçš„æ§åˆ¶ä¸‹å®ç°æ•°æ®çš„ç¯å½¢ä¼ è¾“ã€‚ <strong>è¦å¼€å§‹SPIé€šä¿¡ï¼Œä¸»æœºå¿…é¡»å‘é€æ—¶é’Ÿä¿¡å·ï¼Œå¹¶é€šè¿‡ä½¿èƒ½NSSä¿¡å·é€‰æ‹©ä»æœºã€‚</strong></p><p><u>SPIåªæœ‰ä¸»æ¨¡å¼å’Œä»æ¨¡å¼ä¹‹åˆ†ï¼Œæ²¡æœ‰è¯»å’Œå†™çš„è¯´æ³•ï¼Œå¤–è®¾çš„å†™æ“ä½œå’Œè¯»æ“ä½œæ˜¯åŒæ­¥å®Œæˆçš„ã€‚å¦‚æœåªè¿›è¡Œå†™æ“ä½œï¼Œä¸»æœºåªéœ€å¿½ç•¥æ¥æ”¶åˆ°çš„å­—èŠ‚ï¼›åä¹‹ï¼Œè‹¥ä¸»æœºè¦è¯»å–ä»æœºçš„ä¸€ä¸ªå­—èŠ‚ï¼Œå°±å¿…é¡»å‘é€ä¸€ä¸ªç©ºå­—èŠ‚æ¥å¼•å‘ä»æœºçš„ä¼ è¾“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å‘ä¸€ä¸ªæ•°æ®å¿…ç„¶ä¼šæ”¶åˆ°ä¸€ä¸ªæ•°æ®ï¼›ä½ è¦æ”¶ä¸€ä¸ªæ•°æ®å¿…é¡»ä¹Ÿè¦å…ˆå‘ä¸€ä¸ªæ•°æ®ã€‚</u></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-14%20213838.png"></p><p>SPI æœ‰å››ç§å·¥ä½œæ¨¡å¼ï¼Œé€šè¿‡ä¸²è¡Œæ—¶é’Ÿææ€§(CPOL)å’Œç›¸ä½(CPHA)çš„æ­é…æ¥å¾—åˆ°å››ç§å·¥ä½œæ¨¡å¼ï¼š<br>â‘ ã€CPOL&#x3D;0ï¼Œä¸²è¡Œæ—¶é’Ÿç©ºé—²çŠ¶æ€ä¸ºä½ç”µå¹³ã€‚<br>â‘¡ã€CPOL&#x3D;1ï¼Œä¸²è¡Œæ—¶é’Ÿç©ºé—²çŠ¶æ€ä¸ºé«˜ç”µå¹³ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡é…ç½®æ—¶é’Ÿç›¸ä½(CPHA)æ¥é€‰æ‹©å…·ä½“çš„ä¼ è¾“åè®®ã€‚<br>â‘¢ã€CPHA&#x3D;0ï¼Œä¸²è¡Œæ—¶é’Ÿçš„ç¬¬ä¸€ä¸ªè·³å˜æ²¿(ä¸Šå‡æ²¿æˆ–ä¸‹é™æ²¿)é‡‡é›†æ•°æ®ã€‚<br>â‘£ã€CPHA&#x3D;1ï¼Œä¸²è¡Œæ—¶é’Ÿçš„ç¬¬äºŒä¸ªè·³å˜æ²¿(ä¸Šå‡æ²¿æˆ–ä¸‹é™æ²¿)é‡‡é›†æ•°æ®ã€‚</p><p>ä¸»ä»è®¾å¤‡å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å·¥ä½œæ¨¡å¼â€”â€”SCLKã€CPOL å’Œ CPHAï¼Œæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚å¦‚æœæœ‰å¤šä¸ªä»è®¾å¤‡ï¼Œå¹¶ä¸”å®ƒä»¬ä½¿ç”¨äº†ä¸åŒçš„å·¥ä½œæ¨¡å¼ï¼Œé‚£ä¹ˆä¸»è®¾å¤‡å¿…é¡»åœ¨è¯»å†™ä¸åŒä»è®¾å¤‡æ—¶éœ€è¦é‡æ–°ä¿®æ”¹å¯¹åº”ä»è®¾å¤‡çš„æ¨¡å¼ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-15%20151311.png"></p><p>I.MX6U è‡ªå¸¦çš„ SPI å¤–è®¾å«åš ECSPIï¼ŒESPIç‰¹æ€§ï¼š</p><p>â‘ ã€å…¨åŒå·¥åŒæ­¥ä¸²è¡Œæ¥å£ã€‚<br>â‘¡ã€å¯é…ç½®çš„ä¸»&#x2F;ä»æ¨¡å¼ã€‚<br>â‘¢ã€å››ä¸ªç‰‡é€‰ä¿¡å·ï¼Œæ”¯æŒå¤šä»æœºã€‚<br>â‘£ã€å‘é€å’Œæ¥æ”¶éƒ½æœ‰ä¸€ä¸ª 32x64 çš„ FIFOã€‚<br>â‘¤ã€ç‰‡é€‰ä¿¡å· SS&#x2F;CSï¼Œæ—¶é’Ÿä¿¡å· SCLK ææ€§å¯é…ç½®ã€‚<br>â‘¥ã€æ”¯æŒ DMAã€‚</p><p>This section provides initialization information for ECSPI.<br>To initialize the block:</p><ol><li>Clear the EN bit in ECSPI_CONREG to reset the block.</li><li>Enable the clocks for ECSPI within the CCM.</li><li>Configure the Control Register and then set the EN bit in the ECSPI_CONREG to put ECSPI out of reset.</li><li>Configure corresponding IOMUX for ECSPI external signals.</li><li>Configure registers of ECSPI properly according to the specifications of the external SPI device.</li></ol><h3 id="ä½¿ç”¨çš„å¯„å­˜å™¨ï¼š"><a href="#ä½¿ç”¨çš„å¯„å­˜å™¨ï¼š" class="headerlink" title="ä½¿ç”¨çš„å¯„å­˜å™¨ï¼š"></a>ä½¿ç”¨çš„å¯„å­˜å™¨ï¼š</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-15%20161914.png"></p><h3 id="ICM-20608ä¼ æ„Ÿå™¨"><a href="#ICM-20608ä¼ æ„Ÿå™¨" class="headerlink" title="ICM-20608ä¼ æ„Ÿå™¨"></a>ICM-20608ä¼ æ„Ÿå™¨</h3><p>é™€èºä»ªå…·æœ‰ä¸¤ä¸ªç‰¹æ€§ï¼šä¸€ä¸ªç©ºé—´çš„åˆšæ€§ï¼Œä¸€ä¸ªè¡Œè¿›æ€§ã€‚<em><strong>èºä»ªå°±æ˜¯æµ‹è§’é€Ÿåº¦çš„ï¼ŒåŠ é€Ÿåº¦ä¼ æ„Ÿå™¨å°±æ˜¯æµ‹è§’åŠ é€Ÿåº¦çš„ï¼ŒäºŒè€…æ•°æ®é€šè¿‡ç®—æ³•å°±å¯ä»¥å¾—åˆ°PITCHã€YAWã€ROLLè§’äº†ã€‚</strong></em>å…³äºé™€èºä»ªä¼ æ„Ÿå™¨åŸç†å¯çœ‹ä»¥ä¸‹é“¾æ¥<a href="https://www.bilibili.com/video/BV1YK411A7HU/?spm_id_from=333.337.search-card.all.click&vd_source=a29cba237e61c1d3e1d8193673a58e41">è§£å¯†æ‰‹æœºé™€èºä»ªåŸç†_å“”å“©å“”å“©_bilibili</a></p><p>ICM-20608 å†…éƒ¨æœ‰ä¸€ä¸ª 512å­—èŠ‚çš„ FIFOã€‚é™€èºä»ªçš„é‡ç¨‹èŒƒå›´å¯ä»¥ç¼–ç¨‹è®¾ç½®ï¼Œå¯é€‰æ‹©Â±250ï¼ŒÂ±500ï¼ŒÂ±1000 å’ŒÂ±2000Â°&#x2F;sï¼ŒåŠ é€Ÿåº¦çš„é‡ç¨‹èŒƒå›´ä¹Ÿå¯ä»¥ç¼–ç¨‹è®¾ç½®ï¼Œå¯é€‰æ‹©Â±2gï¼ŒÂ±4gï¼ŒÂ±8g å’ŒÂ±16gã€‚é™€èºä»ªå’ŒåŠ é€Ÿåº¦è®¡éƒ½æ˜¯ 16 ä½çš„ ADCï¼Œå¹¶ä¸”æ”¯æŒ I2C å’Œ SPI ä¸¤ç§åè®®ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><p>â‘ ã€é™€èºä»ªæ”¯æŒ X,Y å’Œ Z ä¸‰è½´è¾“å‡ºï¼Œå†…éƒ¨é›†æˆ 16 ä½ ADCï¼Œæµ‹é‡èŒƒå›´å¯è®¾ç½®ï¼šÂ±250ï¼ŒÂ±500ï¼ŒÂ±1000 å’ŒÂ±2000Â°&#x2F;sã€‚<br>â‘¡ã€åŠ é€Ÿåº¦è®¡æ”¯æŒ X,Y å’Œ Z è½´è¾“å‡ºï¼Œå†…éƒ¨é›†æˆ 16 ä½ ADCï¼Œæµ‹é‡èŒƒå›´å¯è®¾ç½®ï¼šÂ±2gï¼ŒÂ±4gï¼ŒÂ±4gï¼ŒÂ±8g å’ŒÂ±16gã€‚<br>â‘¢ã€ç”¨æˆ·å¯ç¼–ç¨‹ä¸­æ–­ã€‚<br>â‘£ã€å†…éƒ¨åŒ…å« 512 å­—èŠ‚çš„ FIFOã€‚<br>â‘¤ã€å†…éƒ¨åŒ…å«ä¸€ä¸ªæ•°å­—æ¸©åº¦ä¼ æ„Ÿå™¨ã€‚<br>â‘¥ã€è€ 10000g çš„å†²å‡»ã€‚<br>â‘¦ã€æ”¯æŒå¿«é€Ÿ I2Cï¼Œé€Ÿåº¦å¯è¾¾ 400KHzã€‚<br>â‘§ã€æ”¯æŒ SPIï¼Œé€Ÿåº¦å¯è¾¾ 8MHzã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-16%20142813.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitæäº¤ä»£ç åˆ°è¿œç¨‹ä»“åº“</title>
      <link href="/2023/03/16/2023-3-16-git%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E5%88%B0%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/"/>
      <url>/2023/03/16/2023-3-16-git%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E5%88%B0%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h2 id="gitå¦‚ä½•æäº¤ä»£ç åˆ°è¿œç¨‹ä»“åº“"><a href="#gitå¦‚ä½•æäº¤ä»£ç åˆ°è¿œç¨‹ä»“åº“" class="headerlink" title="gitå¦‚ä½•æäº¤ä»£ç åˆ°è¿œç¨‹ä»“åº“"></a>gitå¦‚ä½•æäº¤ä»£ç åˆ°è¿œç¨‹ä»“åº“</h2><p>ä½¿ç”¨è¿™ä¸ªçš„åŸå› çš„æ˜¯çœ‹åˆ°æœ‰çš„åµŒå…¥å¼å°±èŒè¯¢é—®ä¼šé—®é“ï¼Œè€Œä¸”ä½¿ç”¨gitå¯ä»¥å°†æœ¬åœ°ä»£ç éƒ¨ç½²åˆ°githubï¼Œå¯ä»¥å¤‡ä»½ï¼Œå¤šå°ç”µè„‘å¼€å‘ä¸€ä¸ªå·¥ç¨‹å¾ˆæ–¹ä¾¿ã€‚</p><p>é¦–å…ˆæ˜¯è¿›è¡Œå®‰è£…gitå†Linuxçš„ç³»ç»Ÿ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure><p>æ³¨å†Œç”¨æˆ·åå’Œé‚®ç®±</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;ç”¨æˆ·å&quot;</span><br><span class="line">git config --global user.email &quot;é‚®ç®±&quot;</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥é…ç½®ä¿¡æ¯çš„å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --list</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨git cloneä»ç°æœ‰çš„gitä»“åº“ä¸­æ‹·è´é¡¹ç›®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone ä»“åº“åœ°å€</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-16%20132517.png"></p><p>å¦‚æœå…‹éš†åˆ°æŒ‡å®šç›®å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone ä»“åº“åœ°å€ ç›®å½•</span><br></pre></td></tr></table></figure><p>å¦‚æœgit cloneå¡ä½äº†ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹é“¾æ¥<a href="https://zhuanlan.zhihu.com/p/557331130#:~:text=git%20clone%20%E7%89%B9%E5%88%AB%E6%85%A2%E6%98%AF%E7%94%B1%E4%BA%8E%20github.global.ssl.fastly.net%20%E5%92%8C%20github.com%20%E5%9F%9F%E5%90%8D%E8%A2%AB%E9%99%90%E5%88%B6%E4%BA%86%EF%BC%8C%E6%89%80%E4%BB%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E7%9A%84%E6%80%9D%E8%B7%AF%E5%B0%B1%E6%98%AF,%E6%89%BE%E5%88%B0%E8%BF%99%E4%B8%AA%E5%9F%9F%E5%90%8D%E5%AF%B9%E5%BA%94%E7%9A%84ip%EF%BC%8C%E7%84%B6%E5%90%8E%E5%9C%A8%E6%88%91%E4%BB%AC%E6%9C%BA%E5%99%A8%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%8A%A0%E4%B8%8A%20ip%20-%3E%20%E5%9F%9F%E5%90%8D%E7%9A%84%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB%EF%BC%8C%E5%88%B7%E6%96%B0%20DNS%20%E7%BC%93%E5%AD%98%E5%8D%B3%E5%8F%AF%20%E3%80%82">ææ™ºå¼€å‘ | è§£å†³ linux ä¸Š git clone æ…¢æˆ–å¤±è´¥çš„æ–¹æ³• - çŸ¥ä¹ (zhihu.com)</a></p><p>ä¹‹åå°±å¯ä»¥å¾€è¿™ä¸ªç›®å½•ä¸­å†™å…¥æ–‡ä»¶ï¼Œä¹‹åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œéƒ¨ç½²</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">è¿™ä¸ªå‘½ä»¤æ˜¯å°†ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒºåŸŸ</span><br><span class="line">git add æ–‡ä»¶å</span><br><span class="line">æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åº“</span><br><span class="line">git status</span><br><span class="line">æŸ¥çœ‹ä»“åº“å½“å‰çš„çŠ¶æ€ï¼Œæ˜¾ç¤ºå˜æ›´çš„æ–‡ä»¶</span><br><span class="line">git commit</span><br><span class="line">æ·»åŠ æ–‡ä»¶åˆ°æœ¬åœ°åº“</span><br><span class="line">git commit -m &quot;å¤‡æ³¨&quot;</span><br><span class="line">æ·»åŠ æ–‡ä»¶åˆ°æœ¬åœ°åº“å¹¶å†™ä¸Šå¤‡æ³¨</span><br><span class="line">git push</span><br><span class="line">å°±å¯ä»¥éƒ¨ç½²äº†</span><br></pre></td></tr></table></figure><p>å¦‚æœgit pushå¼¹å‡ºè´¦å·å’Œå¯†ç çš„è¾“å…¥ï¼Œå°±éœ€è¦å¡«å†™ç”¨æˆ·ä¿¡æ¯ï¼Œä»¥åŠgithubçš„tokenï¼Œå› ä¸ºæœ€è¿‘çš„ç‰ˆæœ¬çš„åªå…è®¸ä½¿ç”¨tokenç¦ç”¨äº†å¯†ç ï¼Œå¦‚æœæƒ³å…é™¤æ¯æ¬¡è¾“å…¥tokençš„é—®é¢˜</p><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;é‚®ç®±&quot;</span><br></pre></td></tr></table></figure><p>ä¹‹åä¸€ç›´å›è½¦</p><p>æœ€åæŸ¥çœ‹ç”Ÿæˆçš„id_rsa.pubæ–‡ä»¶å†…å®¹ï¼Œå°†å…¶æ·»åŠ åˆ°GitHubä¸­ï¼Œå½¢æˆç§é’¥ã€‚</p><p>å¦‚æœgit push å¤±è´¥é‚£ä¹ˆï¼Œä½¿ç”¨æŒ‡ä»¤è¿›è¡Œé‡ç½®ä»£ç†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global  --unset http.https://github.com.proxy </span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> å®æˆ˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Imx6ullæ•°æ®æ‰‹å†Œç”Ÿè¯</title>
      <link href="/2023/03/14/2023-3-14-Imx6ull%E6%95%B0%E6%8D%AE%E6%89%8B%E5%86%8C%E7%94%9F%E8%AF%8D/"/>
      <url>/2023/03/14/2023-3-14-Imx6ull%E6%95%B0%E6%8D%AE%E6%89%8B%E5%86%8C%E7%94%9F%E8%AF%8D/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>ç”Ÿè¯</th><th>æ±‰è¯‘</th></tr></thead><tbody><tr><td>prescaler</td><td>é¢„åˆ†é¢‘å™¨</td></tr><tr><td>programmable</td><td>å¯ç¼–ç¨‹</td></tr><tr><td>route</td><td>çº¿è·¯</td></tr><tr><td>formula</td><td>å…¬å¼</td></tr><tr><td>subroutine</td><td>å­ç¨‹åº</td></tr><tr><td>reprogram</td><td>é‡æ–°ç¼–ç¨‹</td></tr><tr><td>parameter</td><td>å‚æ•°</td></tr><tr><td>slave</td><td>ä»æœº</td></tr><tr><td>arbitration</td><td>ä»²è£</td></tr><tr><td>addressed</td><td>è§£å†³</td></tr><tr><td>multiplexing</td><td>å¤šè·¯å¤ç”¨</td></tr><tr><td>acknowledge signal</td><td>åº”ç­”ä¿¡å·</td></tr><tr><td>master drive high</td><td>ä¸»é©±åŠ¨å™¨é«˜</td></tr><tr><td>pending</td><td>å¾…å®š</td></tr><tr><td>idle</td><td>é—²ç½®</td></tr><tr><td>muxe</td><td>å¤šè·¯å¤ç”¨å™¨</td></tr><tr><td>peripheral</td><td>å¤–è®¾</td></tr><tr><td>dedicated software</td><td>ä¸“ç”¨è½¯ä»¶</td></tr><tr><td>daisy chain</td><td>èŠèŠ±é“¾å¼ç»“æ„</td></tr><tr><td>external</td><td>å¤–éƒ¨</td></tr><tr><td>diagram</td><td>å›¾</td></tr><tr><td>synchronize</td><td>åŒæ­¥</td></tr><tr><td>field</td><td>åœº</td></tr><tr><td>initialize the counter</td><td>åˆå§‹åŒ–è®¡æ•°å™¨</td></tr><tr><td>duplex</td><td>åŒå·¥</td></tr><tr><td>synchronous</td><td>åŒæ­¥</td></tr><tr><td>polarity</td><td>ææ€§</td></tr><tr><td>FIFO</td><td>å…ˆè¿›å…ˆå‡º</td></tr><tr><td>kernel</td><td>å†…æ ¸</td></tr><tr><td>relocaddr</td><td>æ¬è¿åœ°å€</td></tr><tr><td>bracket</td><td>æŠŠã€‚ã€‚ã€‚åˆ†ç±»</td></tr><tr><td>framebuffer</td><td>å¸§ç¼“å­˜</td></tr><tr><td>alignment</td><td>é˜Ÿåˆ—</td></tr><tr><td>alloc</td><td>åˆ†é…å†…å­˜</td></tr><tr><td>miscellaneous</td><td>æ‚é¡¹</td></tr><tr><td>modularize</td><td>æ¨¡å—åŒ–</td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6ullçš„IICå®éªŒ</title>
      <link href="/2023/03/13/2023-3-13-imx6ull%E7%9A%84IIC%E5%AE%9E%E9%AA%8C/"/>
      <url>/2023/03/13/2023-3-13-imx6ull%E7%9A%84IIC%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="I2Cåè®®"><a href="#I2Cåè®®" class="headerlink" title="I2Cåè®®"></a>I2Cåè®®</h2><p>IICæ˜¯åŠåŒå·¥é€šä¿¡ï¼ˆåŒä¸€æ—¶é—´å•å‘é€šä¿¡ï¼‰ï¼ŒI2C ä½¿ç”¨ä¸¤æ¡çº¿åœ¨ä¸»æ§åˆ¶å™¨å’Œä»æœºä¹‹é—´è¿›è¡Œæ•°æ®é€šä¿¡ã€‚ä¸€æ¡æ˜¯ SCL(ä¸²è¡Œæ—¶é’Ÿçº¿)ï¼Œå¦å¤–ä¸€æ¡æ˜¯ SDA(ä¸²è¡Œæ•°æ®çº¿)ï¼Œè¿™ä¸¤æ¡æ•°æ®çº¿éœ€è¦æ¥ä¸Šæ‹‰ç”µé˜»ï¼Œæ€»çº¿ç©ºé—²çš„æ—¶å€™ SCL å’Œ SDA å¤„äºé«˜ç”µå¹³ã€‚I2C æ€»çº¿æ ‡å‡†æ¨¡å¼ä¸‹é€Ÿåº¦å¯ä»¥è¾¾åˆ° 100Kb&#x2F;Sï¼Œå¿«é€Ÿæ¨¡å¼ä¸‹å¯ä»¥è¾¾åˆ° 400Kb&#x2F;Sã€‚I2C æ€»çº¿å·¥ä½œæ˜¯æŒ‰ç…§ä¸€å®šçš„åè®®æ¥è¿è¡Œçš„ï¼Œæ¥ä¸‹æ¥å°±çœ‹ä¸€ä¸‹ I2C åè®®ã€‚</p><p>ä¸»æœºå°±æ˜¯è´Ÿè´£æ•´ä¸ªç³»ç»Ÿçš„ä»»åŠ¡åè°ƒä¸åˆ†é…ï¼Œä»æœºä¸€èˆ¬æ˜¯é€šè¿‡æ¥æ”¶ä¸»æœºçš„æŒ‡ä»¤ä»è€Œå®ŒæˆæŸäº›ç‰¹å®šçš„ä»»åŠ¡ï¼Œä¸»æœºå’Œä»æœºä¹‹é—´é€šè¿‡æ€»çº¿è¿æ¥ï¼Œè¿›è¡Œæ•°æ®é€šè®¯ã€‚</p><ul><li>å‘å¸ƒä¸»è¦å‘½ä»¤çš„ç§°ä¸ºä¸»æœº</li><li>æ¥å—å‘½ä»¤çš„ç§°ä¸ºä»æœº</li></ul><p>IICä¸»è®¾å¤‡åŠŸèƒ½ï¼šä¸»è¦äº§ç”Ÿæ—¶é’Ÿï¼Œäº§ç”Ÿèµ·å§‹ä¿¡å·ï¼Œåœæ­¢ä¿¡å·ã€‚</p><p>IICä»è®¾å¤‡åŠŸèƒ½ï¼šå¯ç¼–ç¨‹çš„IICåœ°å€æ£€æµ‹ï¼Œåœæ­¢ä½æ£€æµ‹ã€‚</p><p>**IICçš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å®ƒæ”¯æŒå¤šä¸»æ§(multimastering)**ï¼Œ å…¶ä¸­ä»»ä½•ä¸€ä¸ªèƒ½å¤Ÿè¿›è¡Œå‘é€å’Œæ¥æ”¶çš„è®¾å¤‡éƒ½å¯ä»¥æˆä¸ºä¸»æ€»çº¿ã€‚ä¸€ä¸ªä¸»æ§èƒ½å¤Ÿæ§åˆ¶ä¿¡å·çš„ä¼ è¾“å’Œæ—¶é’Ÿé¢‘ç‡ã€‚å½“ç„¶ï¼Œåœ¨ä»»ä½•æ—¶é—´ç‚¹ä¸Šåªèƒ½æœ‰ä¸€ä¸ªä¸»æ§ã€‚</p><p>I2Cæ˜¯æ”¯æŒå¤šä»æœºåº”ç­”ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª I2C æ§åˆ¶å™¨ä¸‹å¯ä»¥æŒ‚å¤šä¸ª I2C ä»è®¾å¤‡ï¼Œè¿™äº›ä¸åŒçš„ I2Cä»è®¾å¤‡æœ‰ä¸åŒçš„å™¨ä»¶åœ°å€ï¼Œè¿™æ · I2C ä¸»æ§åˆ¶å™¨å°±å¯ä»¥é€šè¿‡ I2C è®¾å¤‡çš„å™¨ä»¶åœ°å€è®¿é—®æŒ‡å®šçš„ I2Cè®¾å¤‡äº†ï¼Œ</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-11%20145203.png"></p><p>I2Cåè®®</p><p>èµ·å§‹ä¿¡å·ï¼šåœ¨ SCL ä¸ºé«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDA å‡ºç°ä¸‹é™æ²¿å°±è¡¨ç¤ºä¸ºèµ·å§‹ä½ã€‚</p><p>ç»ˆæ­¢ä¿¡å·ï¼šåœæ­¢ä½å°±æ˜¯åœæ­¢ I2C é€šä¿¡çš„æ ‡å¿—ä½ï¼Œå’Œèµ·å§‹ä½çš„åŠŸèƒ½ç›¸åã€‚åœ¨ SCL ä½é«˜ç”µå¹³çš„æ—¶å€™ï¼ŒSDAå‡ºç°ä¸Šå‡æ²¿å°±è¡¨ç¤ºä¸ºåœæ­¢ä½ã€‚</p><p>æ•°æ®ä¼ è¾“ï¼šI2C æ€»çº¿åœ¨æ•°æ®ä¼ è¾“çš„æ—¶å€™è¦ä¿è¯åœ¨ SCL é«˜ç”µå¹³æœŸé—´ï¼ŒSDA ä¸Šçš„æ•°æ®ç¨³å®šï¼Œå› æ­¤ SDA ä¸Šçš„æ•°æ®å˜åŒ–åªèƒ½åœ¨ SCL ä½ç”µå¹³æœŸé—´å‘ç”Ÿ</p><p>åº”ç­”ä¿¡å·ï¼šå½“ I2C ä¸»æœºå‘é€å®Œ 8 ä½æ•°æ®ä»¥åä¼šå°† SDA è®¾ç½®ä¸ºè¾“å…¥çŠ¶æ€ï¼Œç­‰å¾… I2C ä»æœºåº”ç­”ï¼Œä¹Ÿå°±æ˜¯ç­‰åˆ° I2C ä»æœºå‘Šè¯‰ä¸»æœºå®ƒæ¥æ”¶åˆ°æ•°æ®äº†ã€‚åº”ç­”ä¿¡å·æ˜¯ç”±ä»æœºå‘å‡ºçš„ï¼Œä¸»æœºéœ€è¦æä¾›åº”ç­”ä¿¡å·æ‰€éœ€çš„æ—¶é’Ÿï¼Œä¸»æœºå‘é€å®Œ 8 ä½æ•°æ®ä»¥åç´§è·Ÿç€çš„ä¸€ä¸ªæ—¶é’Ÿä¿¡å·å°±æ˜¯ç»™åº”ç­”ä¿¡å·ä½¿ç”¨çš„ã€‚ä»æœºé€šè¿‡å°† SDA æ‹‰ä½æ¥è¡¨ç¤ºå‘å‡ºåº”ç­”ä¿¡å·ï¼Œè¡¨ç¤ºé€šä¿¡æˆåŠŸï¼Œå¦åˆ™è¡¨ç¤ºé€šä¿¡å¤±è´¥ã€‚</p><h2 id="IICå†™æ•°æ®"><a href="#IICå†™æ•°æ®" class="headerlink" title="IICå†™æ•°æ®"></a>IICå†™æ•°æ®</h2><p>å†™æ—¶åº</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-11%20153434.png"></p><p>èµ·å§‹ä¿¡å·-&gt;å™¨ä»¶åœ°å€ï¼ˆ7ä½åœ°å€åŠ ä¸€ä¸ªè¯»å†™ä½ï¼‰-&gt;ç­‰å¾…åº”ç­”-&gt;è¦æ“ä½œå†…å­˜çš„åœ°å€-&gt;ç­‰å¾…åº”ç­”-&gt;å†™å…¥æ•°æ®-&gt;ç­‰å¾…åº”ç­”-&gt;åœæ­¢è¯»æ—¶åº</p><p>ä¸»æœºå‘ä»æœºå†™æ•°æ®æ—¶å€™ï¼›</p><p>1.ä¸»æœºäº§ç”Ÿèµ·å§‹ä¿¡å·ï¼›</p><p>2.ç„¶åç´§è·Ÿç€å‘é€ä¸€ä¸ªåœ°å€ï¼Œåœ°å€ä¸€å…±æœ‰7ä½ï¼Œç´§è·Ÿç€ç¬¬8ä½æ˜¯æ•°æ®æ–¹å‘ä½ï¼Œ0è¡¨ç¤ºä¸»æœºå‘é€æ•°æ®ï¼Œ1è¡¨ç¤ºä¸»æœºæ¥å—æ•°æ®ï¼ˆè¯»ï¼‰ï¼›</p><p>3.ä¸»æœºå‘é€åœ°å€æ—¶ï¼Œæ€»çº¿ä¸Šçš„æ¯ä¸ªä»æœºéƒ½å°†7ä½åœ°å€ä½ä¸è‡ªå·±çš„åœ°å€æ¯”è¾ƒï¼Œç›¸åŒä»£è¡¨æ­£åœ¨è¢«ä¸»æœºå¯»å€ï¼Œæ ¹æ®R&#x2F;Tä½å°†è‡ªå·±ç¡®å®šä¸ºå‘é€å™¨æˆ–è€…æ¥æ”¶å™¨ï¼›</p><p>4.è¿™æ—¶ä¸»æœºç­‰å¾…ä»æœºçš„åº”ç­”ä¿¡å·ï¼ˆAï¼‰ï¼›</p><p>5.å½“ä¸»æœºæ”¶åˆ°åº”ç­”ä¿¡å·æ—¶ï¼Œå‘é€è¦è®¿é—®ä»æœºçš„é‚£ä¸ªåœ°å€ï¼Œç»§ç»­ç­‰å¾…ä»æœºçš„åº”ç­”ä¿¡å·ï¼›</p><p>6.å½“ä¸»æœºæ”¶åˆ°åº”ç­”ä¿¡å·æ—¶ï¼Œå‘é€Nä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œç»§ç»­ç­‰å¾…ä»æœºçš„Næ¬¡åº”ç­”ä¿¡å·ï¼›</p><p>7.ä¸»æœºäº§ç”Ÿåœæ­¢ä¿¡å·ï¼Œç»“æŸä¼ è¾“è¿‡ç¨‹ã€‚</p><h2 id="IICè¯»æ•°æ®"><a href="#IICè¯»æ•°æ®" class="headerlink" title="IICè¯»æ•°æ®"></a>IICè¯»æ•°æ®</h2><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-11%20153441.png"></p><p>èµ·å§‹ä¿¡å·-&gt;å™¨ä»¶åœ°å€(7+1ä½å†™ï¼ˆ0ï¼‰)-&gt;åº”ç­”-&gt;è¯»å–åœ°å€-&gt;åº”ç­”-&gt;èµ·å§‹ä¿¡å·-.&gt;å™¨ä»¶åœ°å€ï¼ˆ7ä½+è¯»ï¼ˆ1ï¼‰ï¼‰-&gt;åº”ç­”-&gt;è¯»å–æ•°æ®-&gt;å‘é€åº”ç­”-&gt;åœæ­¢ä¿¡å·</p><p>1.ä¸»æœºäº§ç”Ÿèµ·å§‹ä¿¡å·ï¼›</p><p>2.ç„¶åç´§è·Ÿç€å‘é€ä¸€ä»æœºä¸ªåœ°å€ï¼Œåœ°å€ä¸€å…±æœ‰7ä½ï¼Œç¬¬8ä½ä¸º0ï¼Œè¡¨æ˜æ˜¯å‘ä»æœºå†™å‘½ä»¤ï¼›</p><p>3.ä¸»æœºç­‰å¾…ä»æœºçš„åº”ç­”ä¿¡å·ï¼ˆACKï¼‰ï¼›</p><p>4.è¿™æ—¶ä¸»æœºæ”¶åˆ°ä»æœºçš„åº”ç­”ä¿¡å·ï¼ˆAï¼‰ï¼Œå‘é€è¦è®¿é—®çš„åœ°å€ï¼Œç»§ç»­ç­‰å¾…ä»æœºçš„åº”ç­”ä¿¡å·ï¼›</p><p>5.å½“ä¸»æœºæ”¶åˆ°åº”ç­”ä¿¡å·åï¼Œä¸»æœºè¦æ”¹å˜é€šä¿¡æ¨¡å¼ï¼ˆä¸»æœºå°†ç”±å‘é€å˜ä¸ºæ¥å—ï¼Œä»æœºå°†ç”±æ¥å—å˜ä¸ºå‘é€ï¼‰æ‰€ä»¥ä¸»æœºé‡æ–°å‘é€ä¸€ä¸ªèµ·å§‹ä¿¡å·ï¼Œä¹‹åç´§æ¥ç€å‘é€ä¸€ä¸ªä»æœºåœ°å€ï¼Œæ­¤æ—¶è¯¥åœ°å€ç¬¬8ä½ä¸º1ï¼Œè¡¨æ˜å°†ä¸»æœºè®¾ç½®æˆæ¥å—æ¨¡å¼å¼€å§‹è¯»å–æ•°æ®ï¼›</p><p>6.è¿™æ—¶å€™ä¸»æœºç­‰å¾…ä»æœºçš„åº”ç­”ä¿¡å·ï¼Œå½“ä¸»æœºæ”¶åˆ°åº”ç­”ä¿¡å·æ—¶ï¼Œ å°±å¯ä»¥æ¥å—1ä¸ªå­—èŠ‚æ•°æ®ï¼Œå½“æ¥å—å®Œæˆåï¼Œ ä¸»æœºå‘é€éåº”ç­”ä¿¡å·æ—¶å€™ï¼Œè¡¨ç¤ºä¸åœ¨æ¥å—æ•°æ®ï¼›</p><p>7.ä¸»æœºäº§ç”Ÿåœæ­¢ä¿¡å·ï¼Œç»“æŸä¼ è¾“è¿‡ç¨‹ã€‚</p><h3 id="ä½¿ç”¨çš„å¯„å­˜å™¨"><a href="#ä½¿ç”¨çš„å¯„å­˜å™¨" class="headerlink" title="ä½¿ç”¨çš„å¯„å­˜å™¨"></a>ä½¿ç”¨çš„å¯„å­˜å™¨</h3><p>IICçš„åœ°å€å¯„å­˜å™¨ I2Cx_IADR(x&#x3D;1<del>4)å¯„å­˜å™¨ï¼Œ(x&#x3D;1</del>4)å¯„å­˜å™¨ï¼Œè¿™æ˜¯I2C çš„åœ°å€å¯„å­˜å™¨ï¼Œåªæœ‰ ADR(bit7:1)ä½æœ‰æ•ˆï¼Œ</p><p>ç”¨æ¥ä¿å­˜ I2C ä»è®¾å¤‡åœ°å€æ•°æ®ã€‚</p><p>I2C Frequency Divider Register (I2C1_IFDR) ï¼šIC(bit5:0)è¿™ä¸ªä½ï¼Œç”¨æ¥è®¾ç½® I2C çš„æ³¢ç‰¹ç‡ï¼ŒI2C çš„æ—¶é’Ÿæºå¯ä»¥é€‰æ‹© IPG_CLK_ROOT&#x3D;66MHzï¼Œé€šè¿‡è®¾ç½® IC ä½æ—¢å¯ä»¥å¾—åˆ°æƒ³è¦çš„ I2C æ³¢ç‰¹ç‡ã€‚</p><p>&#x3D;&#x3D;<strong>æ—¶é’Ÿæº&#x3D;ICè®¾ç½®çš„åˆ†é¢‘å€¼*æ³¢ç‰¹ç‡ã€‚</strong>&#x3D;&#x3D;</p><p>I2C Control Register (I2C1_I2CR) </p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-11%20172654.png"></p><p>IEN(bit7)ï¼šI2C ä½¿èƒ½ä½ï¼Œä¸º 1 çš„æ—¶å€™ä½¿èƒ½ I2Cï¼Œä¸º 0 çš„æ—¶å€™å…³é—­ I2Cã€‚<br>IIEN(bit6)ï¼šI2C ä¸­æ–­ä½¿èƒ½ä½ï¼Œä¸º 1 çš„æ—¶å€™ä½¿èƒ½ I2C ä¸­æ–­ï¼Œä¸º 0 çš„æ—¶å€™å…³é—­ I2C ä¸­æ–­ã€‚<br>MSTA(bit5)ï¼šä¸»ä»æ¨¡å¼é€‰æ‹©ä½ï¼Œè®¾ç½® IIC å·¥ä½œåœ¨ä¸»æ¨¡å¼è¿˜æ˜¯ä»æ¨¡å¼ï¼Œä¸º 1 çš„æ—¶å€™å·¥ä½œåœ¨ä¸»<br>æ¨¡å¼ï¼Œä¸º 0 çš„æ—¶å€™å·¥ä½œåœ¨ä»æ¨¡å¼ã€‚<br>MTX(bit4)ï¼šä¼ è¾“æ–¹å‘é€‰æ‹©ä½ï¼Œç”¨æ¥è®¾ç½®æ˜¯è¿›è¡Œå‘é€è¿˜æ˜¯æ¥æ”¶ï¼Œä¸º 0 çš„æ—¶å€™æ˜¯æ¥æ”¶ï¼Œä¸º 1 çš„<br>æ—¶å€™æ˜¯å‘é€ã€‚<br>TXAK(bit3)ï¼šä¼ è¾“åº”ç­”ä½ä½¿èƒ½ï¼Œä¸º 0 çš„è¯å‘é€ ACK ä¿¡å·ï¼Œä¸º 1 çš„è¯å‘é€ NO ACK ä¿¡å·ã€‚<br>RSTA(bit2)ï¼šé‡å¤å¼€å§‹ä¿¡å·ï¼Œä¸º 1 çš„è¯äº§ç”Ÿä¸€ä¸ªé‡æ–°å¼€å§‹ä¿¡å·ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-11%20173313.png"></p><p>ICF(bit7)ï¼šæ•°æ®ä¼ è¾“çŠ¶æ€ä½ï¼Œä¸º 0 çš„æ—¶å€™è¡¨ç¤ºæ•°æ®æ­£åœ¨ä¼ è¾“ï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤ºæ•°æ®ä¼ è¾“å®Œæˆã€‚<br>IAAS(bit6)ï¼šå½“ä¸º 1 çš„æ—¶å€™è¡¨ç¤º I2C åœ°å€ï¼Œä¹Ÿå°±æ˜¯ I2Cx_IADR å¯„å­˜å™¨ä¸­çš„åœ°å€æ˜¯ä»è®¾å¤‡åœ°å€ã€‚<br>IBB(bit5)ï¼šI2C æ€»çº¿å¿™æ ‡å¿—ä½ï¼Œå½“ä¸º 0 çš„æ—¶å€™è¡¨ç¤º I2C æ€»çº¿ç©ºé—²ï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤º I2C æ€»çº¿å¿™ã€‚<br>IAL(bit4)ï¼šä»²è£ä¸¢å¤±ä½ï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤ºå‘ç”Ÿä»²è£ä¸¢å¤±ã€‚<br>SRW(bit2)ï¼šä»æœºè¯»å†™çŠ¶æ€ä½ï¼Œå½“ I2C ä½œä¸ºä»æœºçš„æ—¶å€™ä½¿ç”¨ï¼Œæ­¤ä½ç”¨æ¥è¡¨æ˜ä¸»æœºå‘é€ç»™ä»æœºçš„æ˜¯è¯»è¿˜æ˜¯å†™å‘½ä»¤ã€‚ä¸º 0 çš„æ—¶å€™è¡¨ç¤ºä¸»æœºè¦å‘ä»æœºå†™æ•°æ®ï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤ºä¸»æœºè¦ä»ä»æœºè¯»å–æ•°æ®ã€‚<br>IIF(bit1)ï¼šI2C ä¸­æ–­æŒ‚èµ·æ ‡å¿—ä½ï¼Œå½“ä¸º 1 çš„æ—¶å€™è¡¨ç¤ºæœ‰ä¸­æ–­æŒ‚èµ·ï¼Œæ­¤ä½éœ€è¦è½¯ä»¶æ¸…é›¶ã€‚<br>RXAK(bit0)ï¼šåº”ç­”ä¿¡å·æ ‡å¿—ä½ï¼Œä¸º 0 çš„æ—¶å€™è¡¨ç¤ºæ¥æ”¶åˆ° ACK åº”ç­”ä¿¡å·ï¼Œä¸º 1 çš„è¯è¡¨ç¤ºæ£€æµ‹åˆ° NO ACK ä¿¡å·ã€‚</p><p>I2C Data I&#x2F;O Register (I2C1_I2DR) ï¼Œè¿™æ˜¯ I2C çš„æ•°æ®å¯„å­˜å™¨ï¼Œæ­¤å¯„å­˜å™¨åªæœ‰ä½ 8 ä½æœ‰æ•ˆï¼Œå½“è¦å‘é€æ•°æ®çš„æ—¶å€™å°†è¦å‘é€çš„æ•°æ®å†™å…¥åˆ°æ­¤å¯„å­˜å™¨ï¼Œå¦‚æœè¦æ¥æ”¶æ•°æ®çš„è¯ç›´æ¥è¯»å–æ­¤å¯„å­˜å™¨å³å¯å¾—åˆ°æ¥æ”¶åˆ°çš„æ•°æ®ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-15%20112239.png"></p><h2 id="ç¡¬ä»¶IICå’Œè½¯ä»¶IIC"><a href="#ç¡¬ä»¶IICå’Œè½¯ä»¶IIC" class="headerlink" title="ç¡¬ä»¶IICå’Œè½¯ä»¶IIC"></a>ç¡¬ä»¶IICå’Œè½¯ä»¶IIC</h2><p>æ‰€è°“ç¡¬ä»¶I2Cå¯¹åº”èŠ¯ç‰‡ä¸Šçš„I2Cå¤–è®¾ï¼Œæœ‰ç›¸åº”I2Cé©±åŠ¨ç”µè·¯ï¼Œå…¶æ‰€ä½¿ç”¨çš„I2Cç®¡è„šä¹Ÿæ˜¯ä¸“ç”¨çš„ï¼›è½¯ä»¶I2Cä¸€èˆ¬æ˜¯ç”¨GPIOç®¡è„šï¼Œç”¨è½¯ä»¶æ§åˆ¶ç®¡è„šçŠ¶æ€ä»¥æ¨¡æ‹ŸI2Cé€šä¿¡æ³¢å½¢ã€‚</p><p>ç¡¬ä»¶I2Cçš„æ•ˆç‡è¦è¿œé«˜äºè½¯ä»¶çš„ï¼Œè€Œè½¯ä»¶I2Cç”±äºä¸å—ç®¡è„šé™åˆ¶ï¼Œæ¥å£æ¯”è¾ƒçµæ´»ã€‚</p><p>è‡³äºå¦‚ä½•åŒºåˆ†å®ƒä»¬ï¼š<br>å¯ä»¥çœ‹åº•å±‚é…ç½®ï¼Œæ¯”å¦‚IOå£é…ç½®ï¼Œå¦‚æœé…ç½®äº†IOå£çš„åŠŸèƒ½ï¼ˆIICåŠŸèƒ½ï¼‰é‚£å°±æ˜¯å›ºä»¶IICï¼Œå¦åˆ™å°±æ˜¯æ¨¡æ‹Ÿã€‚<br>å¯ä»¥çœ‹IICå†™å‡½æ•°ï¼Œçœ‹é‡Œé¢æœ‰æœ¨æœ‰è°ƒç”¨ç°æˆçš„å‡½æ•°æˆ–è€…ç»™æŸä¸ªå¯„å­˜å™¨èµ‹å€¼ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è‚¯å®šæ˜¯å›ºä»¶IICåŠŸèƒ½ï¼Œæ²¡æœ‰çš„è¯è‚¯å®šæ˜¯æ•°æ®ä¸€ä¸ªbitä¸€ä¸ªbitæ¨¡æ‹Ÿå‘ç”Ÿé€çš„ï¼Œè‚¯å®šç”¨åˆ°äº†å¾ªç¯ï¼Œåˆ™ä¸ºæ¨¡æ‹Ÿã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6ullçš„RTC å®æ—¶æ—¶é’Ÿå®éªŒ</title>
      <link href="/2023/03/10/2023-3-20-imx6ull%E7%9A%84RTC-%E5%AE%9E%E6%97%B6%E6%97%B6%E9%92%9F%E5%AE%9E%E9%AA%8C/"/>
      <url>/2023/03/10/2023-3-20-imx6ull%E7%9A%84RTC-%E5%AE%9E%E6%97%B6%E6%97%B6%E9%92%9F%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h4 id="å®æ—¶æ—¶é’Ÿå®ç°åŸç†"><a href="#å®æ—¶æ—¶é’Ÿå®ç°åŸç†" class="headerlink" title="å®æ—¶æ—¶é’Ÿå®ç°åŸç†"></a>å®æ—¶æ—¶é’Ÿå®ç°åŸç†</h4><p>I.MX6U ç³»åˆ—çš„ RTC æ˜¯åœ¨ SNVS é‡Œé¢ï¼ŒSNVS ç›´è¯‘è¿‡æ¥å°±æ˜¯å®‰å…¨çš„éæ˜“æ€§å­˜å‚¨ï¼ŒSNVS é‡Œé¢ä¸»è¦æ˜¯ä¸€äº›ä½åŠŸè€—çš„å¤–è®¾ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå®‰å…¨çš„å®æ—¶è®¡æ•°å™¨(RTC)ã€ä¸€ä¸ªå•è°ƒè®¡æ•°å™¨(monotonic counter)å’Œä¸€äº›é€šç”¨çš„å¯„å­˜å™¨ã€‚SNVS æœ‰ä¸¤éƒ¨åˆ†ï¼šSNVS_HP å’Œ SNVS_LPï¼Œç³»ç»Ÿä¸»ç”µæºæ–­ç”µä»¥å SNVS_HP ä¹Ÿä¼šæ–­ç”µï¼Œä½†æ˜¯åœ¨åå¤‡ç”µæºæ”¯æŒä¸‹ï¼ŒSNVS_LP æ˜¯ä¸ä¼šæ–­ç”µçš„ï¼Œè€Œä¸” SNVS_LPæ˜¯å’ŒèŠ¯ç‰‡å¤ä½éš”ç¦»å¼€çš„ï¼Œå› æ­¤ SNVS_LP ç›¸å…³çš„å¯„å­˜å™¨çš„å€¼ä¼šä¸€ç›´ä¿å­˜ç€ã€‚</p><p>â‘ ã€SNVS_LPï¼šä¸“ç”¨çš„always-powered-onç”µæºåŸŸï¼Œç³»ç»Ÿä¸»ç”µæºå’Œå¤‡ç”¨ç”µæºéƒ½å¯ä»¥ä¸ºå…¶ä¾›ç”µã€‚<br>â‘¡ã€SNVS_HPï¼šç³»ç»Ÿï¼ˆèŠ¯ç‰‡ï¼‰ç”µæºã€‚</p><p>SNVS_LPå’ŒSNVS_LPéƒ½æœ‰SRTCï¼Œä¸ºä¿è¯æ‰ç”µåä¾æ—§å¯ä»¥æ‰§è¡Œï¼Œæ‰€ä»¥è®¾ç½®SNVS_LPä¸­çš„SRTCæ¥å®ç°å®æ—¶æ—¶é’Ÿã€‚</p><p>åœ¨ç¡¬ä»¶æ–¹é¢ï¼ŒSRTCéœ€è¦å¤–ç•Œæä¾›ä¸€ä¸ª32.768KHzçš„æ—¶é’Ÿï¼Œå¯„å­˜å™¨ SNVS_LPSRTCMR å’Œ SNVS_LPSRTCLR ä¿å­˜ç€ç§’æ•°ï¼Œç›´æ¥è¯»å–è¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼å°±çŸ¥é“è¿‡äº†å¤šé•¿æ—¶é—´äº†ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-10%20135947.png"></p><h4 id="ä½¿ç”¨çš„SNVSå¯„å­˜å™¨ï¼š"><a href="#ä½¿ç”¨çš„SNVSå¯„å­˜å™¨ï¼š" class="headerlink" title="ä½¿ç”¨çš„SNVSå¯„å­˜å™¨ï¼š"></a>ä½¿ç”¨çš„SNVSå¯„å­˜å™¨ï¼š</h4><p><strong>â‘ </strong>SNVS_HPCOMR</p><p>NPSWA_EN(bit31)ï¼Œè¿™ä¸ªä½æ˜¯éç‰¹æƒè½¯ä»¶è®¿é—®æ§åˆ¶ä½ï¼Œå¦‚æœéç‰¹æƒè½¯ä»¶è¦è®¿é—® SNVS çš„è¯æ­¤ä½å¿…é¡»ä¸º 1</p><p><strong>â‘¡</strong>SNVS_LPCR</p><p>SRTC_ENV(bit0)ï¼Œæ­¤ä½ä¸º 1 çš„è¯å°±ä½¿èƒ½ STC è®¡æ•°å™¨ã€‚</p><p><strong>â‘¢</strong>SNVS_SRTCMR</p><p>SNVS_SRTCMR çš„ bit14:0 è¿™ 15 ä½æ˜¯ SRTC è®¡æ•°å™¨çš„é«˜ 15 ä½ã€‚</p><p><strong>â‘£</strong>SNVS_SRTCLR</p><p>SNVS_SRTCLR çš„ bit31:bit15 è¿™ 17 ä½æ˜¯ SRTC è®¡æ•°å™¨çš„ä½ 17 ä½ã€‚</p><h4 id="ä½¿èƒ½SRTCçš„é…ç½®å¦‚ä¸‹ï¼š"><a href="#ä½¿èƒ½SRTCçš„é…ç½®å¦‚ä¸‹ï¼š" class="headerlink" title="ä½¿èƒ½SRTCçš„é…ç½®å¦‚ä¸‹ï¼š"></a><strong>ä½¿èƒ½SRTCçš„é…ç½®å¦‚ä¸‹ï¼š</strong></h4><p>ï¼ˆ1ï¼‰åˆå§‹åŒ–SNVS_SRTC<br>     åˆå§‹åŒ–SNVS_LPä¸­çš„SRTCã€‚<br>ï¼ˆ2ï¼‰è®¾ç½®RTCæ—¶é—´<br>     ç¬¬ä¸€æ¬¡ä½¿ç”¨RTCè‚¯å®šè¦å…ˆè®¾ç½®æ—¶é—´ã€‚<br>ï¼ˆ3ï¼‰ä½¿èƒ½RTC<br>     é…ç½®å¥½RTCå¹¶è®¾ç½®å¥½åˆå§‹æ—¶é—´ä»¥åå°±å¯ä»¥å¼€å¯RTCäº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¡¥å……çŸ¥è¯†ç‚¹</title>
      <link href="/2023/03/07/2023-3-06-%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
      <url>/2023/03/07/2023-3-06-%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<h3 id="åµŒå…¥å¼é¢å‘å¯¹è±¡ç¼–ç¨‹"><a href="#åµŒå…¥å¼é¢å‘å¯¹è±¡ç¼–ç¨‹" class="headerlink" title="åµŒå…¥å¼é¢å‘å¯¹è±¡ç¼–ç¨‹"></a>åµŒå…¥å¼é¢å‘å¯¹è±¡ç¼–ç¨‹</h3><p>é¢å‘å¯¹è±¡ï¼Œæ˜¯ç¼–ç¨‹ç•Œçš„ä¸€ä¸ªæ¦‚å¿µã€‚ä»€ä¹ˆå«é¢å‘å¯¹è±¡å‘¢ï¼Ÿç¼–ç¨‹æœ‰ä¸¤ç§è¦ç´ ï¼šç¨‹åºï¼ˆæ–¹æ³•ï¼‰ï¼Œæ•°æ®ï¼ˆå±æ€§ï¼‰ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªLEDï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹äº®æˆ–è€…ç†„ç­å®ƒï¼Œè¿™å«æ–¹æ³•ã€‚LEDä»€ä¹ˆçŠ¶æ€ï¼Ÿäº®è¿˜æ˜¯ç­ï¼Ÿè¿™å°±æ˜¯å±æ€§ã€‚æˆ‘ä»¬é€šå¸¸è¿™æ ·ç¼–ç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">u8 ledsta = <span class="number">0</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ledset</span><span class="params">(u8 sta)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„ç¼–ç¨‹æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰10ä¸ªè¿™æ ·çš„LEDï¼Œæ€ä¹ˆå†™ï¼Ÿè¿™æ—¶æˆ‘ä»¬å¯ä»¥å¼•å…¥é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œå°†æ¯ä¸€ä¸ªLEDå°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚å¯ä»¥è¿™æ ·åšï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå°†LEDè¿™ä¸ªå¯¹è±¡çš„å±æ€§è·Ÿæ–¹æ³•å°è£…ã€‚</span></span><br><span class="line"><span class="comment">è¿™ä¸ªç»“æ„ä½“å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">ä½†æ˜¯è¿™ä¸ªä¸æ˜¯ä¸€ä¸ªçœŸå®çš„å­˜åœ¨ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯¹è±¡çš„æŠ½è±¡ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">u8 sta;</span><br><span class="line"><span class="type">void</span> (*setsta)(u8 sta);</span><br><span class="line">&#125;LedObj;</span><br><span class="line"><span class="comment">/* å£°æ˜ä¸€ä¸ªLEDå¯¹è±¡ï¼Œåç§°å«åšLED1ï¼Œå¹¶ä¸”å®ç°å®ƒçš„æ–¹æ³•drv_led1_setsta*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">drv_led1_setsta</span><span class="params">(u8 sta)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LedObj LED1=&#123;</span><br><span class="line"></span><br><span class="line">.sta = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">.setsta = drv_led1_setsta,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å£°æ˜ä¸€ä¸ªLEDå¯¹è±¡ï¼Œåç§°å«åšLED2ï¼Œå¹¶ä¸”å®ç°å®ƒçš„æ–¹æ³•drv_led2_setsta*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">drv_led2_setsta</span><span class="params">(u8 sta)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LedObj LED2=&#123;</span><br><span class="line"></span><br><span class="line">.sta = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">.setsta = drv_led2_setsta,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* æ“ä½œLEDçš„å‡½æ•°ï¼Œå‚æ•°æŒ‡å®šå“ªä¸ªled*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ledset</span><span class="params">(LedObj *led, u8 sta)</span></span><br><span class="line">&#123;</span><br><span class="line">led-&gt;setsta(sta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯çš„ï¼Œåœ¨Cè¯­è¨€ä¸­ï¼Œå®ç°é¢å‘å¯¹è±¡çš„æ‰‹æ®µå°±æ˜¯ç»“æ„ä½“çš„ä½¿ç”¨ã€‚ä¸Šé¢çš„ä»£ç ï¼Œå¯¹äºAPIæ¥è¯´ï¼Œå°±å¾ˆå‹å¥½äº†ã€‚æ“ä½œæ‰€æœ‰LEDï¼Œä½¿ç”¨åŒä¸€ä¸ªæ¥å£ï¼Œåªéœ€å‘Šè¯‰æ¥å£å“ªä¸ªLEDã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6uçš„RGBlCDæ˜¾ç¤º</title>
      <link href="/2023/03/06/2023-3-06-imx6u%E7%9A%84RGBlCD%E6%98%BE%E7%A4%BA/"/>
      <url>/2023/03/06/2023-3-06-imx6u%E7%9A%84RGBlCD%E6%98%BE%E7%A4%BA/</url>
      
        <content type="html"><![CDATA[<h3 id="åƒç´ æ ¼å¼"><a href="#åƒç´ æ ¼å¼" class="headerlink" title="åƒç´ æ ¼å¼"></a>åƒç´ æ ¼å¼</h3><p>ä¸€ä¸ªåƒç´ ç‚¹å°±ç›¸å½“äºä¸€ä¸ª RGB å°ç¯ï¼Œé€šè¿‡æ§åˆ¶ Rã€Gã€B è¿™ä¸‰ç§é¢œè‰²çš„äº®åº¦å°±å¯ä»¥æ˜¾ç¤ºå‡ºå„ç§å„æ ·çš„è‰²å½©ã€‚é‚£è¯¥å¦‚ä½•æ§åˆ¶ Rã€Gã€B è¿™ä¸‰ç§é¢œè‰²çš„æ˜¾ç¤ºäº®åº¦å‘¢ï¼Ÿä¸€èˆ¬ä¸€ä¸ª Rã€Gã€B è¿™ä¸‰éƒ¨åˆ†åˆ†åˆ«ä½¿ç”¨ 8bit çš„æ•°æ®ï¼Œé‚£ä¹ˆä¸€ä¸ªåƒç´ ç‚¹å°±æ˜¯ 8bit*3&#x3D;24bitï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªåƒç´ ç‚¹3 ä¸ªå­—èŠ‚ï¼Œè¿™ç§åƒç´ æ ¼å¼ç§°ä¸º RGB888ã€‚å¦‚æœå†åŠ å…¥ 8bit çš„ Alpha(é€æ˜)é€šé“çš„è¯ä¸€ä¸ªåƒç´ ç‚¹å°±æ˜¯ 32bitï¼Œä¹Ÿå°±æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œè¿™ç§åƒç´ æ ¼å¼ç§°ä¸º ARGB8888ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20140301.png"></p><p>ä¸€ä¸ªåƒç´ ç‚¹æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­ bit31<del>bit24 æ˜¯ Alpha é€šé“ï¼Œbit23</del>bit16 æ˜¯RED é€šé“ï¼Œbit15<del>bit14 æ˜¯ GREEN é€šé“ï¼Œbit7</del>bit0 æ˜¯ BLUE é€šé“ã€‚æ‰€ä»¥çº¢è‰²å¯¹åº”çš„å€¼å°±æ˜¯0X00FF0000ï¼Œè“è‰²å¯¹åº”çš„å€¼å°±æ˜¯ 0X000000FFï¼Œç»¿è‰²å¯¹åº”çš„å€¼ä¸º 0X0000FF00ã€‚é€šè¿‡è°ƒèŠ‚ Rã€Gã€Bçš„æ¯”ä¾‹å¯ä»¥äº§ç”Ÿå…¶å®ƒçš„é¢œè‰²ï¼Œæ¯”å¦‚0X00FFFF00å°±æ˜¯é»„è‰²ï¼Œ0X00000000å°±æ˜¯é»‘è‰²ï¼Œ0X00FFFFFFå°±æ˜¯ç™½è‰²ã€‚</p><p>R[7:0]ã€G[7:0]å’ŒB[7:0]è¿™24æ ¹æ˜¯æ•°æ®çº¿ï¼ŒDEã€VSYNCã€HSYNC å’Œ PCLK è¿™å››æ ¹æ˜¯æ§åˆ¶ä¿¡å·çº¿ã€‚RGB LCD ä¸€èˆ¬æœ‰ä¸¤ç§é©±åŠ¨æ¨¡å¼ï¼šDE æ¨¡å¼å’Œ HV æ¨¡å¼ï¼Œè¿™ä¸¤ä¸ªæ¨¡å¼çš„åŒºåˆ«æ˜¯ DE æ¨¡å¼éœ€è¦ç”¨åˆ° DE ä¿¡å·çº¿ï¼Œè€Œ HV æ¨¡å¼ä¸éœ€è¦ç”¨åˆ° DE ä¿¡å·çº¿ï¼Œåœ¨ DEæ¨¡å¼ä¸‹æ˜¯å¯ä»¥ä¸éœ€è¦ HSYNC ä¿¡å·çº¿çš„ï¼Œå³ä½¿ä¸æ¥ HSYNC ä¿¡å·çº¿ LCD ä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p><h3 id="lcdæ˜¾ç¤ºè¿‡ç¨‹"><a href="#lcdæ˜¾ç¤ºè¿‡ç¨‹" class="headerlink" title="lcdæ˜¾ç¤ºè¿‡ç¨‹"></a><a href="https://www.cnblogs.com/fah936861121/articles/7116400.html">lcdæ˜¾ç¤ºè¿‡ç¨‹</a></h3><h3 id="RGBLCDå±å¹•æ—¶åº"><a href="#RGBLCDå±å¹•æ—¶åº" class="headerlink" title="RGBLCDå±å¹•æ—¶åº"></a>RGBLCDå±å¹•æ—¶åº</h3><p>è¡Œæ˜¾ç¤ºæ—¶åºå›¾ç‰‡ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20142928.png"></p><p>HSYNCï¼šè¡ŒåŒæ­¥ä¿¡å·ï¼Œå½“æ­¤ä¿¡å·æœ‰æ•ˆçš„è¯å°±è¡¨ç¤ºå¼€å§‹æ˜¾ç¤ºæ–°çš„ä¸€è¡Œæ•°æ®ï¼ŒæŸ¥é˜…æ‰€ä½¿ç”¨çš„LCD æ•°æ®æ‰‹å†Œå¯ä»¥çŸ¥é“æ­¤ä¿¡å·æ˜¯ä½ç”µå¹³æœ‰æ•ˆè¿˜æ˜¯é«˜ç”µå¹³æœ‰æ•ˆï¼Œå‡è®¾æ­¤æ—¶æ˜¯ä½ç”µå¹³æœ‰æ•ˆã€‚<br>HSPWï¼šæœ‰äº›åœ°æ–¹ä¹Ÿå«åš thpï¼Œæ˜¯ HSYNC ä¿¡å·å®½åº¦ï¼Œä¹Ÿå°±æ˜¯ HSYNC ä¿¡å·æŒç»­æ—¶é—´ã€‚HSYNCä¿¡å·ä¸æ˜¯ä¸€ä¸ªè„‰å†²ï¼Œè€Œæ˜¯éœ€è¦æŒç»­ä¸€æ®µæ—¶é—´æ‰æ˜¯æœ‰æ•ˆçš„ï¼Œå•ä½ä¸º CLKã€‚<br>HBPï¼šæœ‰äº›åœ°æ–¹å«åš thbï¼Œå‰é¢å·²ç»è®²è¿‡äº†ï¼Œæœ¯è¯­å«åšè¡ŒåŒæ­¥ä¿¡å·åè‚©ï¼Œå•ä½æ˜¯ CLKã€‚<br>HOZVALï¼šæœ‰äº›åœ°æ–¹å«åš thdï¼Œæ˜¾ç¤ºä¸€è¡Œæ•°æ®æ‰€éœ€çš„æ—¶é—´ï¼Œå‡å¦‚å±å¹•åˆ†è¾¨ç‡ä¸º 1024*600ï¼Œé‚£ä¹ˆ HOZVAL å°±æ˜¯ 1024ï¼Œå•ä½ä¸º CLKã€‚<br>HFPï¼šæœ‰äº›åœ°æ–¹å«åš thfï¼Œæœ¯è¯­å«åšè¡ŒåŒæ­¥ä¿¡å·å‰è‚©ï¼Œå•ä½æ˜¯ CLKã€‚å½“ HSYNC ä¿¡å·å‘å‡ºä»¥åï¼Œéœ€è¦ç­‰å¾… HSPW+HBP ä¸ª CLK æ—¶é—´æ‰ä¼šæ¥æ”¶åˆ°çœŸæ­£æœ‰æ•ˆçš„åƒç´ æ•°æ®ã€‚å½“æ˜¾ç¤ºå®Œä¸€è¡Œæ•°æ®ä»¥åéœ€è¦ç­‰å¾… HFP ä¸ª CLK æ—¶é—´æ‰èƒ½å‘å‡ºä¸‹ä¸€ä¸ª HSYNC ä¿¡å·ï¼Œæ‰€ä»¥æ˜¾ç¤ºä¸€è¡Œæ‰€éœ€è¦çš„æ—¶é—´å°±æ˜¯ï¼šHSPW + HBP + HOZVAL + HFPã€‚<br>ä¸€å¸§å›¾åƒå°±æ˜¯ç”±å¾ˆå¤šä¸ªè¡Œç»„æˆçš„ï¼Œ</p><p>å¸§æ˜¾ç¤ºæ—¶åºå›¾ç‰‡ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20143953.png"></p><p>VSYNCï¼šå¸§åŒæ­¥ä¿¡å·ï¼Œå½“æ­¤ä¿¡å·æœ‰æ•ˆçš„è¯å°±è¡¨ç¤ºå¼€å§‹æ˜¾ç¤ºæ–°çš„ä¸€å¸§æ•°æ®ï¼ŒæŸ¥é˜…æ‰€ä½¿ç”¨çš„<br>LCD æ•°æ®æ‰‹å†Œå¯ä»¥çŸ¥é“æ­¤ä¿¡å·æ˜¯ä½ç”µå¹³æœ‰æ•ˆè¿˜æ˜¯é«˜ç”µå¹³æœ‰æ•ˆï¼Œå‡è®¾æ­¤æ—¶æ˜¯ä½ç”µå¹³æœ‰æ•ˆã€‚<br>VSPWï¼šæœ‰äº›åœ°æ–¹ä¹Ÿå«åš tvpï¼Œæ˜¯ VSYNC ä¿¡å·å®½åº¦ï¼Œä¹Ÿå°±æ˜¯ VSYNC ä¿¡å·æŒç»­æ—¶é—´ï¼Œå•ä½ä¸º 1 è¡Œçš„æ—¶é—´ã€‚<br>VBPï¼šæœ‰äº›åœ°æ–¹å«åš tvbï¼Œå‰é¢å·²ç»è®²è¿‡äº†ï¼Œæœ¯è¯­å«åšå¸§åŒæ­¥ä¿¡å·åè‚©ï¼Œå•ä½ä¸º 1 è¡Œçš„æ—¶é—´ã€‚<br>LINEï¼šæœ‰äº›åœ°æ–¹å«åš tvdï¼Œæ˜¾ç¤ºä¸€å¸§æœ‰æ•ˆæ•°æ®æ‰€éœ€çš„æ—¶é—´ï¼Œå‡å¦‚å±å¹•åˆ†è¾¨ç‡ä¸º 1024*600ï¼Œé‚£ä¹ˆ LINE å°±æ˜¯ 600 è¡Œçš„æ—¶é—´ã€‚<br>VFPï¼šæœ‰äº›åœ°æ–¹å«åš tvfï¼Œå‰é¢å·²ç»è®²è¿‡äº†ï¼Œæœ¯è¯­å«åšå¸§åŒæ­¥ä¿¡å·å‰è‚©ï¼Œå•ä½ä¸º 1 è¡Œçš„æ—¶é—´ã€‚æ˜¾ç¤ºä¸€å¸§æ‰€éœ€è¦çš„æ—¶é—´å°±æ˜¯ï¼šVSPW+VBP+LINE+VFP ä¸ªè¡Œæ—¶é—´</p><p><strong>æœ€ç»ˆçš„è®¡ç®—å…¬å¼ï¼š</strong><br>T &#x3D; (VSPW+VBP+LINE+VFP) * (HSPW + HBP + HOZVAL + HFP)</p><p>4.3å¯¸å±å¹•å‚æ•°ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-20%20212722.png"></p><p>æ˜¾ç¤ºä¸€å¸§å›¾åƒæ‰€è¦çš„æ—¶é’Ÿæ•°ä¸º</p><p>&#x3D; (VSPW+VBP+LINE+VFP) * (HSPW + HBP + HOZVAL + HFP)</p><p>&#x3D;(480+3+32+13)*(48+88+800+40)&#x3D;515328</p><p>æ˜¾ç¤ºä¸€å¸§å›¾åƒéœ€è¦515328ä¸ªæ—¶é’Ÿæ•°ï¼Œé‚£ä¹ˆæ˜¾ç¤º60å¸§å°±æ˜¯ï¼š515328 * 60 &#x3D; 30,919,680â‰ˆ31Mï¼Œæ‰€ä»¥åƒç´ æ—¶é’Ÿå°±æ˜¯ 31MHzã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20144933.png"></p><p>â‘ ã€æ­¤éƒ¨åˆ†æ˜¯ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œç”¨äºé€‰æ‹©å“ªä¸ª PLL å¯ä»¥ä½œä¸º LCDIF æ—¶é’Ÿæºï¼Œç”±å¯„å­˜å™¨CCM_CSCDR2 çš„ä½ LCDIF1_PRE_CLK_SEL(bit17:15)æ¥å†³å®šï¼ŒLCDIF1_PRE_CLK_SEL é€‰æ‹©è®¾ç½®å¦‚è¡¨</p><table><thead><tr><th align="center">å€¼</th><th>æ—¶é’Ÿæº</th></tr></thead><tbody><tr><td align="center">0</td><td>PLL2 ä½œä¸º LCDIF çš„æ—¶é’Ÿæºã€‚</td></tr><tr><td align="center">1</td><td>PLL3_PFD3 ä½œä¸º LCDIF çš„æ—¶é’Ÿæºã€‚</td></tr><tr><td align="center">2</td><td>PLL5 ä½œä¸º LCDIF çš„æ—¶é’Ÿæºã€‚</td></tr><tr><td align="center">3</td><td>PLL2_PFD0 ä½œä¸º LCDIF çš„æ—¶é’Ÿæºã€‚</td></tr><tr><td align="center">4</td><td>PLL2_PFD1 ä½œä¸º LCDIF çš„æ—¶é’Ÿæºã€‚</td></tr><tr><td align="center">5</td><td>PLL3_PFD1 ä½œä¸º LCDIF çš„æ—¶é’Ÿæºã€‚</td></tr></tbody></table><p>â‘¡ã€æ­¤éƒ¨åˆ†æ˜¯ LCDIF æ—¶é’Ÿçš„é¢„åˆ†é¢‘å™¨ï¼Œç”±å¯„å­˜å™¨ CCM_CSCDR2 çš„ä½ LCDIF1_PRED æ¥å†³å®šé¢„åˆ†é¢‘å€¼ã€‚å¯è®¾ç½®å€¼ä¸º 0<del>7ï¼Œåˆ†åˆ«å¯¹åº” 1</del>8 åˆ†é¢‘ã€‚<br>â‘¢ã€æ­¤éƒ¨åˆ†è¿›ä¸€æ­¥åˆ†é¢‘ï¼Œç”±å¯„å­˜å™¨ CBCMR çš„ä½ LCDIF1_PODF æ¥å†³å®šåˆ†é¢‘å€¼ã€‚å¯è®¾ç½®å€¼ä¸º 0<del>7ï¼Œåˆ†åˆ«å¯¹åº” 1</del>8 åˆ†é¢‘ã€‚<br>â‘£ã€æ­¤éƒ¨åˆ†æ˜¯ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé€‰æ‹© LCDIF æœ€ç»ˆçš„æ ¹æ—¶é’Ÿï¼Œç”±å¯„å­˜å™¨ CSCDR2 çš„ä½LCDIF1_CLK_SEL å†³å®šï¼ŒLCDIF1_CLK_SEL é€‰æ‹©è®¾ç½®å¦‚è¡¨</p><table><thead><tr><th align="center">å€¼</th><th align="left">æ—¶é’Ÿæº</th></tr></thead><tbody><tr><td align="center">0</td><td align="left">å‰é¢å¤ç”¨å™¨å‡ºæ¥çš„æ—¶é’Ÿï¼Œä¹Ÿå°±æ˜¯å‰é¢ PLL5 å‡ºæ¥çš„æ—¶é’Ÿä½œ<br/>ä¸º LCDIF çš„æ ¹æ—¶é’Ÿã€‚</td></tr><tr><td align="center">1</td><td align="left">ipp_di0_clk ä½œä¸º LCDIF çš„æ ¹æ—¶é’Ÿã€‚</td></tr><tr><td align="center">2</td><td align="left">ipp_di1_clk ä½œä¸º LCDIF çš„æ ¹æ—¶é’Ÿã€‚</td></tr><tr><td align="center">3</td><td align="left">ldb_di0_clk ä½œä¸º LCDIF çš„æ ¹æ—¶é’Ÿã€‚</td></tr><tr><td align="center">4</td><td align="left">ldb_di1_clk ä½œä¸º LCDIF çš„æ ¹æ—¶é’Ÿã€‚</td></tr></tbody></table><p>å®šé€‰æ‹© PLL5 å‡ºæ¥çš„é‚£ä¸€è·¯æ—¶é’Ÿä½œä¸º LCDIF çš„æ ¹æ—¶é’Ÿï¼Œå› æ­¤ LCDIF1_CLK_SEL è®¾ç½®ä¸º 0ã€‚LCDIF æ—¢ç„¶é€‰æ‹©äº† PLL5 ä½œä¸ºæ—¶é’Ÿæºï¼Œé‚£ä¹ˆè¿˜éœ€è¦åˆå§‹åŒ– PLL5ï¼ŒLCDIF çš„æ—¶é’Ÿæ˜¯ç”±PLL5 å’Œæ¥å£æ—¶é’Ÿå›¾ç‰‡â‘¡ã€â‘¢è¿™ä¸¤ä¸ªåˆ†é¢‘å€¼å†³å®šçš„ï¼Œ</p><p><strong>PLL5_CLK &#x3D; OSC24M * (loopDivider + (denominator &#x2F; numerator)) &#x2F; postDivider</strong></p><p>è®¾ç½®ä¸º24*ï¼ˆ1+7&#x2F;8ï¼‰&#x2F;1&#x3D;45</p><p>â‘¡å’Œâ‘¢è¿›ä¸€æ­¥åˆ†é¢‘ï¼Œè®¾ç½®â‘¡ä¸­ä¸º 1 åˆ†é¢‘ï¼Œä¹Ÿå°±æ˜¯å¯„å­˜å™¨ CCM_CSCDR2 çš„ä½ LCDIF1_PRED(bit14:12)ä¸º 0ã€‚è®¾ç½®â‘¢ä¸­ä¸º 5 åˆ†é¢‘ï¼Œå°±æ˜¯å¯„å­˜å™¨CCM_CBCMR çš„ä½ LCDIF1_PODF(bit25:23)ä¸º 4ã€‚è®¾ç½®å¥½ä»¥åæœ€ç»ˆè¿›å…¥åˆ° LCDIF çš„æ—¶é’Ÿé¢‘ç‡å°±æ˜¯ï¼š45&#x2F;1&#x2F;5 &#x3D;9MHzï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„åƒç´ æ—¶é’Ÿé¢‘ç‡ã€‚</p><h3 id="æ˜¾å­˜"><a href="#æ˜¾å­˜" class="headerlink" title="æ˜¾å­˜"></a>æ˜¾å­˜</h3><p>å¦‚æœé‡‡ç”¨ ARGB8888 æ ¼å¼çš„è¯ä¸€ä¸ªåƒç´ éœ€è¦ 4 ä¸ªå­—èŠ‚çš„å†…å­˜æ¥å­˜æ”¾åƒç´ æ•°æ®ï¼Œé‚£ä¹ˆ 1024<em>600 åˆ†è¾¨ç‡å°±éœ€è¦ 1024</em>600*4&#x3D;2457600Bâ‰ˆ2.4MB å†…å­˜ã€‚ä½†æ˜¯ RGB LCD å†…éƒ¨æ˜¯æ²¡æœ‰å†…å­˜çš„ï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨å¼€å‘æ¿ä¸Šçš„ DDR3 ä¸­åˆ†å‡ºä¸€æ®µå†…å­˜ä½œä¸º RGB LCD å±å¹•çš„æ˜¾å­˜ï¼Œæˆ‘ä»¬å¦‚æœè¦åœ¨å±å¹•ä¸Šæ˜¾ç¤ºä»€ä¹ˆå›¾åƒçš„è¯ç›´æ¥æ“ä½œè¿™éƒ¨åˆ†æ˜¾å­˜å³å¯ã€‚</p><h3 id="eLCDIF-æ¥å£"><a href="#eLCDIF-æ¥å£" class="headerlink" title="eLCDIF æ¥å£"></a>eLCDIF æ¥å£</h3><p>eLCDIF æ˜¯ I.MX6U è‡ªå¸¦çš„æ¶²æ™¶å±å¹•æ¥å£ï¼Œç”¨äºè¿æ¥ RGB LCD æ¥å£çš„å±å¹•ï¼ŒeLCDIF æ¥å£ç‰¹æ€§å¦‚ä¸‹ï¼š</p><p>â‘ ã€æ”¯æŒ RGB LCD çš„ DE æ¨¡å¼ã€‚<br>â‘¡ã€æ”¯æŒ VSYNC æ¨¡å¼ä»¥å®ç°é«˜é€Ÿæ•°æ®ä¼ è¾“ã€‚<br>â‘¢ã€æ”¯æŒ ITU-R BT.656 æ ¼å¼çš„ 4:2:2 çš„ YCbCr æ•°å­—è§†é¢‘ï¼Œå¹¶ä¸”å°†å…¶è½¬æ¢ä¸ºæ¨¡æ‹Ÿ TV ä¿¡å·ã€‚<br>â‘£ã€æ”¯æŒ 8&#x2F;16&#x2F;18&#x2F;24&#x2F;32 ä½ LCDã€‚</p><p>eLCDIF æ”¯æŒä¸‰ç§æ¥å£ï¼šMPU æ¥å£ã€VSYNC æ¥å£å’Œ DOTCLK æ¥å£ï¼Œè¿™ä¸‰ç§æ¥å£åŒºåˆ«å¦‚ä¸‹ï¼š</p><p>â‘ MPU æ¥å£ç”¨äºåœ¨ I.MX6U å’Œ LCD å±å¹•ç›´æ¥ä¼ è¾“æ•°æ®å’Œå‘½ä»¤ï¼Œè¿™ä¸ªæ¥å£ç”¨äº 6080&#x2F;8080 æ¥å£çš„ LCD å±å¹•ï¼Œå…³äº MPU æ¥å£çš„è¯¦ç»†ä¿¡æ¯ä»¥åŠæ—¶åºå‚è€ƒã€ŠI.MX6ULL å‚è€ƒæ‰‹å†Œã€‹ç¬¬ 2150 é¡µçš„â€œ34.4.6MPU Interfaceâ€å°èŠ‚</p><p>â‘¤VSYNC æ¥å£æ—¶åºå’Œ MPU æ¥å£æ—¶åºåŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯å¤šäº† VSYNC ä¿¡å·æ¥ä½œä¸ºå¸§åŒæ­¥ï¼Œå½“LCDIF_CTRL çš„ä½ VSYNC_MODE ä¸º 1 çš„æ—¶å€™æ­¤æ¥å£ä½¿èƒ½ã€‚å…³äº VSYNC æ¥å£çš„è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒã€ŠI.MX6ULL å‚è€ƒæ‰‹å†Œã€‹ç¬¬ 2152 é¡µçš„â€œ34.4.7 VSYNC Interfaceâ€å°èŠ‚ã€‚</p><p>â‘¢DOTCLK æ¥å£å°±æ˜¯ç”¨æ¥è¿æ¥ RGB LCD æ¥å£å±å¹•çš„ï¼Œ å®ƒåŒ…æ‹¬ VSYNCã€HSYNCã€DOTCLKå’Œ ENABLE(å¯é€‰çš„)è¿™å››ä¸ªä¿¡å·ï¼Œè¿™æ ·çš„æ¥å£é€šå¸¸è¢«ç§°ä¸º RGB æ¥å£ã€‚</p><h3 id="é…ç½®å¯„å­˜å™¨"><a href="#é…ç½®å¯„å­˜å™¨" class="headerlink" title="é…ç½®å¯„å­˜å™¨"></a>é…ç½®å¯„å­˜å™¨</h3><p><strong>é…ç½®eLCDIFæ¥å£çš„å¯„å­˜å™¨</strong>ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20154312.png"></p><p>SFTRST(bit31)ï¼šeLCDIF è½¯å¤ä½æ§åˆ¶ä½ï¼Œå½“æ­¤ä½ä¸º 1 çš„è¯å°±ä¼šå¼ºåˆ¶å¤ä½ LCDã€‚<br>CLKGATE(bit30)ï¼šæ­£å¸¸è¿è¡Œæ¨¡å¼ä¸‹ï¼Œæ­¤ä½å¿…é¡»ä¸º 0ï¼å¦‚æœæ­¤ä½ä¸º 1 çš„è¯æ—¶é’Ÿå°±ä¸ä¼šè¿›å…¥åˆ°LCDIFã€‚<br>BYPASS_COUNT(bit19)ï¼šå¦‚æœè¦å·¥ä½œåœ¨ DOTCLK æ¨¡å¼çš„è¯å°±æ­¤ä½å¿…é¡»ä¸º 1ã€‚<br>VSYNC_MODE(bit18)ï¼šæ­¤ä½ä¸º 1 çš„è¯ LCDIF å·¥ä½œåœ¨ VSYNC æ¥å£æ¨¡å¼ã€‚<br>DOTCLK_MODE(bit17)ï¼šæ­¤ä½ä¸º 1 çš„è¯ LCDIF å·¥ä½œåœ¨ DOTCLK æ¥å£æ¨¡å¼ã€‚<br>INPUT_DATA_SWIZZLE(bit15:14)ï¼šè¾“å…¥æ•°æ®å­—èŠ‚äº¤æ¢è®¾ç½®ï¼Œæ­¤ä½ä¸º 0 çš„è¯ä¸äº¤æ¢å­—èŠ‚ä¹Ÿå°±æ˜¯å°ç«¯æ¨¡å¼ï¼›ä¸º 1 çš„è¯äº¤æ¢æ‰€æœ‰å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å¤§ç«¯æ¨¡å¼ï¼›ä¸º 2 çš„è¯åŠå­—äº¤æ¢ï¼›ä¸º 3 çš„è¯åœ¨æ¯ä¸ªåŠå­—å†…è¿›è¡Œå­—èŠ‚äº¤æ¢ã€‚æœ¬ç« æˆ‘ä»¬è®¾ç½®ä¸º 0ï¼Œä¹Ÿå°±æ˜¯ä¸ä½¿ç”¨å­—èŠ‚äº¤æ¢ã€‚<br>CSC_DATA_SWIZZLE(bit13:12) ï¼š CSC æ•° æ® å­— èŠ‚ äº¤ æ¢ è®¾ ç½® ï¼Œ äº¤ æ¢ æ–¹ å¼ å’ŒINPUT_DATA_SWIZZLE ä¸€æ ·ï¼Œæœ¬ç« è®¾ç½®ä¸º 0ï¼Œä¸ä½¿ç”¨å­—èŠ‚äº¤æ¢ã€‚<br>LCD_DATABUS_WIDTH(bit11:10)ï¼šLCD æ•°æ®æ€»çº¿å®½åº¦ï¼Œä¸º 0 çš„è¯æ€»çº¿å®½åº¦ä¸º 16 ä½ï¼›ä¸º1 çš„è¯æ€»çº¿å®½åº¦ä¸º 8 ä½ï¼›ä¸º 2 çš„è¯æ€»çº¿å®½åº¦ä¸º 18 ä½ï¼›ä¸º 3 çš„è¯æ€»çº¿å®½åº¦ä¸º 24 ä½ã€‚æœ¬ç« æˆ‘ä»¬ä½¿ç”¨ 24 ä½æ€»çº¿å®½åº¦ã€‚WORD_LENGTH(bit9:8)ï¼šè¾“å…¥çš„æ•°æ®æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯åƒç´ æ•°æ®å®½åº¦ï¼Œä¸º 0 çš„è¯æ¯ä¸ªåƒç´  16ä½ï¼›ä¸º 1 çš„è¯æ¯ä¸ªåƒç´  8 ä½ï¼›ä¸º 2 çš„è¯æ¯ä¸ªåƒç´  18 ä½ï¼›ä¸º 3 çš„è¯æ¯ä¸ªåƒç´  24 ä½ã€‚<br>MASTER(bit5)ï¼šä¸º 1 çš„è¯è®¾ç½® eLCDIF å·¥ä½œåœ¨ä¸»æ¨¡å¼ã€‚<br>DATA_FORMAT_16_BIT(bit3)ï¼šå½“æ­¤ä½ä¸º 1 å¹¶ä¸” WORD_LENGTH ä¸º 0 çš„æ—¶å€™åƒç´ æ ¼å¼ä¸º ARGB555ï¼Œå½“æ­¤ä½ä¸º 0 å¹¶ä¸” WORD_LENGTH ä¸º 0 çš„æ—¶å€™åƒç´ æ ¼å¼ä¸º RGB565ã€‚<br>DATA_FORMAT_18_BIT(bit2)ï¼šåªæœ‰å½“ WORD_LENGTH ä¸º 2 çš„æ—¶å€™æ­¤ä½æ‰æœ‰æ•ˆï¼Œæ­¤ä½ä¸º 0 çš„è¯ä½ 18 ä½æœ‰æ•ˆï¼Œåƒç´ æ ¼å¼ä¸º RGB666ï¼Œé«˜ 14 ä½æ•°æ®æ— æ•ˆã€‚å½“æ­¤ä½ä¸º 1 çš„è¯é«˜ 18 ä½æœ‰æ•ˆï¼Œåƒç´ æ ¼å¼ä¾æ—§æ˜¯ RGB666ï¼Œä½†æ˜¯ä½ 14 ä½æ•°æ®æ— æ•ˆã€‚<br>DATA_FORMAT_24_BIT(bit1)ï¼šåªæœ‰å½“ WORD_LENGTH ä¸º 3 çš„æ—¶å€™æ­¤ä½æ‰æœ‰æ•ˆï¼Œä¸º 0 çš„æ—¶å€™è¡¨ç¤ºå…¨éƒ¨çš„ 24 ä½æ•°æ®éƒ½æœ‰æ•ˆã€‚ä¸º 1 çš„è¯å®é™…è¾“å…¥çš„æ•°æ®æœ‰æ•ˆä½åªæœ‰ 18 ä½ï¼Œè™½ç„¶è¾“å…¥çš„æ˜¯24 ä½æ•°æ®ï¼Œä½†æ˜¯æ¯ä¸ªé¢œè‰²é€šé“çš„é«˜ 2 ä½æ•°æ®ä¼šè¢«ä¸¢å¼ƒæ‰ã€‚<br>RUN(bit0)ï¼šeLCDIF æ¥å£è¿è¡Œæ§åˆ¶ä½ï¼Œå½“æ­¤ä½ä¸º 1 çš„è¯ eLCDIF æ¥å£å°±å¼€å§‹ä¼ è¾“æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ eLCDIF çš„ä½¿èƒ½ä½ã€‚</p><p>æ¥ ä¸‹ æ¥ çœ‹ ä¸€ ä¸‹ å¯„ å­˜ å™¨ <strong>LCDIF_CTRL1</strong> ï¼Œ æ­¤ å¯„ å­˜ å™¨ æˆ‘ ä»¬ åª ç”¨ åˆ° ä½BYTE_PACKING_FORMAT(bit19:16)ï¼Œæ­¤ä½ç”¨æ¥å†³å®šåœ¨ 32 ä½çš„æ•°æ®ä¸­å“ªäº›å­—èŠ‚çš„æ•°æ®æœ‰æ•ˆï¼Œé»˜è®¤å€¼ä¸º 0XFï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„å­—èŠ‚æœ‰æ•ˆï¼Œå½“ä¸º 0 çš„è¯è¡¨ç¤ºæ‰€æœ‰çš„å­—èŠ‚éƒ½æ— æ•ˆã€‚å¦‚æœæ˜¾ç¤ºçš„æ•°æ®æ˜¯24 ä½(ARGB æ ¼å¼ï¼Œä½†æ˜¯ A é€šé“ä¸ä¼ è¾“)çš„è¯å°±è®¾ç½®æ­¤ä½ä¸º 0X7ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å¯„å­˜å™¨ <strong>LCDIF_TRANSFER_COUNT</strong>ï¼Œè¿™ä¸ªå¯„å­˜å™¨ç”¨æ¥è®¾ç½®æ‰€è¿æ¥çš„ RGB LCD å±å¹•åˆ†è¾¨ç‡å¤§å°ï¼Œå¯„å­˜å™¨LCDIF_TRANSFER_COUNT åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œé«˜16ä½å’Œä½16ä½ï¼Œé«˜16ä½æ˜¯V_COUNTï¼Œæ˜¯ LCD çš„å‚ç›´åˆ†è¾¨ç‡ã€‚ä½ 16 ä½æ˜¯ H_COUNTï¼Œæ˜¯ LCD çš„æ°´å¹³åˆ†è¾¨ç‡ã€‚å¦‚æœ LCD åˆ†è¾¨ç‡ä¸º480*272 çš„è¯ï¼Œé‚£ä¹ˆ V_COUNT å°±æ˜¯ 272ï¼ŒH_COUNT å°±æ˜¯ 480ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å¯„å­˜å™¨ <strong>LCDIF_VDCTRL0</strong>ï¼Œè¿™ä¸ªå¯„å­˜å™¨æ˜¯ VSYNC å’Œ DOTCLK æ¨¡å¼æ§åˆ¶å¯„å­˜å™¨ 0ï¼Œ</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20160914.png"></p><p>VSYNC_OEB(bit29)ï¼šVSYNC ä¿¡å·æ–¹å‘æ§åˆ¶ä½ï¼Œä¸º 0 çš„è¯ VSYNC æ˜¯è¾“å‡ºï¼Œä¸º 1 çš„è¯VSYNC æ˜¯è¾“å…¥ã€‚<br>ENABLE_PRESENT(bit28)ï¼šEBABLE æ•°æ®çº¿ä½¿èƒ½ä½ï¼Œä¹Ÿå°±æ˜¯ DE æ•°æ®çº¿ã€‚ä¸º 1 çš„è¯ä½¿èƒ½ENABLE æ•°æ®çº¿ï¼Œä¸º 0 çš„è¯å…³é—­ ENABLE æ•°æ®çº¿ã€‚<br>VSYNC_POL(bit27)ï¼šVSYNC æ•°æ®çº¿ææ€§è®¾ç½®ä½ï¼Œä¸º 0 çš„è¯ VSYNC ä½ç”µå¹³æœ‰æ•ˆï¼Œä¸º 1 çš„è¯ VSYNC é«˜ç”µå¹³æœ‰æ•ˆï¼Œè¦æ ¹æ®æ‰€ä½¿ç”¨çš„ LCD æ•°æ®æ‰‹å†Œæ¥è®¾ç½®ã€‚<br>HSYNC_POL(bit26)ï¼šHSYNC æ•°æ®çº¿ææ€§è®¾ç½®ä½ï¼Œä¸º 0 çš„è¯ HSYNC ä½ç”µå¹³æœ‰æ•ˆï¼Œä¸º 1 çš„è¯ HSYNC é«˜ç”µå¹³æœ‰æ•ˆï¼Œè¦æ ¹æ®æ‰€ä½¿ç”¨çš„ LCD æ•°æ®æ‰‹å†Œæ¥è®¾ç½®ã€‚<br>DOTCLK_POL(bit25)ï¼šDOTCLK æ•°æ®çº¿(åƒç´ æ—¶é’Ÿçº¿ CLK) ææ€§è®¾ç½®ä½ï¼Œä¸º 0 çš„è¯ä¸‹é™æ²¿é”å­˜æ•°æ®ï¼Œä¸Šå‡æ²¿æ•è·æ•°æ®ï¼Œä¸º 1 çš„è¯ç›¸åï¼Œè¦æ ¹æ®æ‰€ä½¿ç”¨çš„ LCD æ•°æ®æ‰‹å†Œæ¥è®¾ç½®ã€‚<br>ENABLE_POL(bit24)ï¼šEANBLE æ•°æ®çº¿ææ€§è®¾ç½®ä½ï¼Œä¸º 0 çš„è¯ä½ç”µå¹³æœ‰æ•ˆï¼Œä¸º 1 çš„è¯é«˜ç”µå¹³æœ‰æ•ˆã€‚<br>VSYNC_PERIOD_UNIT(bit21)ï¼šVSYNC ä¿¡å·å‘¨æœŸå•ä½ï¼Œä¸º 0 çš„è¯ VSYNC å‘¨æœŸå•ä½ä¸ºåƒç´ æ—¶é’Ÿã€‚ä¸º 1 çš„è¯ VSYNC å‘¨æœŸå•ä½æ˜¯æ°´å¹³è¡Œï¼Œå¦‚æœä½¿ç”¨ DOTCLK æ¨¡å¼è¯å°±è¦è®¾ç½®ä¸º 1ã€‚<br>VSYNC_PULSE_WIDTH_UNIT(bit20) ï¼š VSYNC ä¿¡ å· è„‰ å†² å®½ åº¦ å• ä½ ï¼Œ å’ŒVSYNC_PERIOD_UNUT ä¸€æ ·ï¼Œå¦‚æœä½¿ç”¨ DOTCLK æ¨¡å¼çš„è¯è¦è®¾ç½®ä¸º 1ã€‚<br>VSYNC_PULSE_WIDTH(bit17:0)ï¼šVSPW å‚æ•°è®¾ç½®ä½ã€‚</p><p>çœ‹ä¸€ä¸‹å¯„å­˜å™¨ <strong>LCDIF_VDCTRL1</strong>ï¼Œè¿™ä¸ªå¯„å­˜å™¨æ˜¯ VSYNC å’Œ DOTCLK æ¨¡å¼æ§åˆ¶å¯„å­˜å™¨ 1ï¼Œæ­¤å¯„å­˜å™¨åªæœ‰ä¸€ä¸ªåŠŸèƒ½ç”¨æ¥è®¾ç½® VSYNC æ€»å‘¨æœŸï¼Œå°±æ˜¯ï¼šå±å¹•é«˜åº¦+VSPW+VBP+VFPã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å¯„å­˜å™¨ <strong>LCDIF_VDCTRL2</strong>ï¼Œè¿™ä¸ªå¯„å­˜å™¨åˆ†ä¸ºé«˜ 16 ä½å’Œä½ 16 ä½ä¸¤éƒ¨åˆ†ï¼Œé«˜ 16ä½æ˜¯HSYNC_PULSE_WIDTHï¼Œç”¨æ¥è®¾ç½® HSYNC ä¿¡å·å®½åº¦ï¼Œä¹Ÿå°±æ˜¯ HSPWã€‚ä½ 16 ä½æ˜¯HSYNC_PERIODï¼Œè®¾ç½® HSYNC æ€»å‘¨æœŸï¼Œå°±æ˜¯ï¼šå±å¹•å®½åº¦+HSPW+HBP+HFPã€‚</p><p>çœ‹ä¸€ä¸‹å¯„å­˜å™¨ <strong>LCDIF_VDCTRL3</strong>ï¼ŒHORIZONTAL_WAIT_CNT(bit27:16)ï¼šæ­¤ä½ç”¨äº DOTCLK æ¨¡å¼ï¼Œç”¨äºè®¾ç½® HSYNC ä¿¡å·äº§ç”Ÿåˆ°æœ‰æ•ˆæ•°æ®äº§ç”Ÿä¹‹é—´çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ HSPW+HBPã€‚<br>VERTICAL_WAIR_CNT(bit15:0)ï¼šå’Œ HORIZONTAL_WAIT_CNT ä¸€æ ·ï¼Œåªæ˜¯æ­¤ä½ç”¨äºVSYNC ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯ VSPW+VBPã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å¯„å­˜å™¨ <strong>LCDIF_VDCTRL4</strong>ï¼Œå¯„å­˜å™¨ LCDIF_VDCTRL4 ç”¨åˆ°çš„é‡è¦ä½å¦‚ä¸‹ï¼š<br>SYNC_SIGNALS_ON(bit18)ï¼šåŒæ­¥ä¿¡å·ä½¿èƒ½ä½ï¼Œè®¾ç½®ä¸º 1 çš„è¯ä½¿èƒ½ VSYNCã€HSYNCã€DOTCLK è¿™äº›ä¿¡å·ã€‚<br>DOTCLK_H_VALID_DATA_CNT(bit15:0)ï¼šè®¾ç½® LCD çš„å®½åº¦ï¼Œä¹Ÿå°±æ˜¯æ°´å¹³åƒç´ æ•°é‡ã€‚æœ€ååœ¨çœ‹ä¸€ä¸‹å¯„å­˜å™¨ LCDIF_CUR_BUF å’Œ LCDIF_NEXT_BUFï¼Œè¿™ä¸¤ä¸ªå¯„å­˜å™¨åˆ†åˆ«ä¸ºå½“å‰å¸§å’Œä¸‹ä¸€å¸§ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯ LCD æ˜¾å­˜ã€‚ä¸€èˆ¬è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¿å­˜åŒä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±æ˜¯åˆ’åˆ†ç»™ LCDçš„æ˜¾å­˜é¦–åœ°å€ã€‚</p><h3 id="é©±åŠ¨å±å¹•çš„æ­¥éª¤"><a href="#é©±åŠ¨å±å¹•çš„æ­¥éª¤" class="headerlink" title="é©±åŠ¨å±å¹•çš„æ­¥éª¤"></a>é©±åŠ¨å±å¹•çš„æ­¥éª¤</h3><p>é…ç½®æ­¥éª¤å¦‚ä¸‹ï¼š<br><strong>1ã€åˆå§‹åŒ– LCD æ‰€ä½¿ç”¨çš„ IO</strong><br>é¦–å…ˆè‚¯å®šæ˜¯åˆå§‹åŒ– LCD æ‰€ç¤ºä½¿ç”¨çš„ IOï¼Œå°†å…¶å¤ç”¨ä¸º eLCDIF æ¥å£ IOã€‚<br><strong>2ã€è®¾ç½® LCD çš„åƒç´ æ—¶é’Ÿ</strong><br>æŸ¥é˜…æ‰€ä½¿ç”¨çš„ LCD å±å¹•æ•°æ®æ‰‹å†Œï¼Œæˆ–è€…è‡ªå·±è®¡ç®—å‡ºçš„æ—¶é’Ÿåƒç´ ï¼Œç„¶åè®¾ç½® CCM ç›¸åº”çš„å¯„å­˜å™¨ã€‚<br><strong>3ã€é…ç½® eLCDIF æ¥å£</strong><br>è®¾ç½® LCDIF çš„å¯„å­˜å™¨ CTRLã€CTRL1ã€TRANSFER_COUNTã€VDCTRL0~4ã€CUR_BUF å’ŒNEXT_BUFã€‚æ ¹æ® LCD çš„æ•°æ®æ‰‹å†Œè®¾ç½®ç›¸åº”çš„å‚æ•°ã€‚<br><strong>4ã€ç¼–å†™ API å‡½æ•°</strong><br>é©±åŠ¨ LCD å±å¹•çš„ç›®çš„å°±æ˜¯æ˜¾ç¤ºå†…å®¹ï¼Œæ‰€ä»¥éœ€è¦ç¼–å†™ä¸€äº›åŸºæœ¬çš„ API å‡½æ•°ï¼Œæ¯”å¦‚ç”»ç‚¹ã€ç”»çº¿ã€ç”»åœ†å‡½æ•°ï¼Œå­—ç¬¦ä¸²æ˜¾ç¤ºå‡½æ•°ç­‰ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>U-Bootä½¿ç”¨å®éªŒ</title>
      <link href="/2023/03/01/2023-3-01-U-Boot%E4%BD%BF%E7%94%A8%E5%AE%9E%E9%AA%8C/"/>
      <url>/2023/03/01/2023-3-01-U-Boot%E4%BD%BF%E7%94%A8%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h3 id="U-Bootç®€ä»‹"><a href="#U-Bootç®€ä»‹" class="headerlink" title="U-Bootç®€ä»‹"></a>U-Bootç®€ä»‹</h3><h3 id="Linuxå¯åŠ¨ç®€ä»‹ä»¥åŠBootloader"><a href="#Linuxå¯åŠ¨ç®€ä»‹ä»¥åŠBootloader" class="headerlink" title="Linuxå¯åŠ¨ç®€ä»‹ä»¥åŠBootloader"></a>Linuxå¯åŠ¨ç®€ä»‹ä»¥åŠBootloader</h3><p>linuxç³»ç»Ÿä»è½¯ä»¶è§’åº¦çœ‹ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››ä¸ªå±‚æ¬¡ã€‚</p><ul><li>å¼•å¯¼åŠ è½½ç¨‹åºï¼ŒåŒ…æ‹¬å›ºåŒ–å›ºä»¶çš„bootä»£ç å’ŒBootloaderä¸¤ä¸ªéƒ¨åˆ†ã€‚å¤§å¤šæ•°æ˜¯æ²¡æœ‰å›ºä»¶çš„ï¼ŒBootloaderæ˜¯ä¸Šç”µåæ‰§è¡Œåçš„ç¬¬ä¸€ä¸ªç¨‹åºã€‚</li><li>Linuxå†…æ ¸ï¼Œç‰¹å®šäºåµŒå…¥å¼æ¿å­çš„å®šåˆ¶å†…æ ¸ä»¥åŠå†…æ ¸çš„å¯åŠ¨å‚æ•°ï¼Œå¯åŠ¨å‚æ•°å¯ä»¥æ˜¯å†…æ ¸é»˜è®¤çš„æˆ–è€…Bootloaderä¼ é€’çš„ã€‚</li><li>æ–‡ä»¶ç³»ç»Ÿï¼Œåšçˆ±é˜”æ ¹æ–‡ä»¶ç³»ç»Ÿå’Œå»ºç«‹äºflashå†…å­˜ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…å«äº†Linuxç³»ç»Ÿèƒ½è¿‡è¿è¡Œæ‰€éœ€è¦çš„åº”ç”¨ç¨‹åºã€åº“ç­‰ã€‚</li><li>ç”¨æˆ·åº”ç”¨ç¨‹åºï¼Œå­˜å‚¨äºæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œåˆæ˜¯åœ¨ç”¨æˆ·åº”ç”¨ç¨‹åºå’Œå†…æ ¸å±‚ä¹‹é—´å¯èƒ½åŒ…å«ä¸€ä¸ªåµŒå…¥å¼å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼Œå¸¸ç”¨çš„GUIæœ‰ï¼šQtopiaå’ŒMini GUIç­‰ã€‚</li></ul><p>Bootloaderå­˜æ”¾å‚æ•°å¦‚ä¸²å£ï¼ŒIPåœ°å€ç­‰ï¼Œæ­£å¸¸å¯åŠ¨Bootloaderè¿è¡Œï¼Œå®ƒå°†kernel(å†…æ ¸ï¼‰å¤åˆ¶åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”åœ¨å†…å­˜çš„å›ºå®šåœ°å€è®¾ç½®å¥½ä¼ é€’çš„å†…æ ¸å‚æ•°ï¼Œè¿è¡Œå†…æ ¸ï¼Œå†…æ ¸å¯åŠ¨åæŒ‚åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>Bootloaderå¯åŠ¨è¦åˆ†ä¸¤è¿‡ç¨‹ï¼Œç¬¬ä¸€ä¸ªä½¿ç”¨æ±‡ç¼–ï¼Œåˆ©ç”¨å…¶å®ŒæˆCPUä½“ç³»ç»“æ„çš„åˆå§‹åŒ–ï¼ˆç¡¬ä»¶è®¾å¤‡åˆå§‹åŒ–ï¼ŒæœªåŠ è½½ç¬¬äºŒè¿‡ç¨‹å‡†å¤‡RAMç©ºé—´ï¼Œå¤åˆ¶Bootloaderç¬¬äºŒè¿‡ç¨‹ä»£ç åˆ°RAMä¸­ï¼Œè®¾ç½®å¥½æ ˆï¼Œè·³è½¬åˆ°Cçš„å…¥å£ï¼‰ï¼Œå¹¶è°ƒç¬¬äºŒè¿‡ç¨‹ä»£ç ï¼Œç¬¬äºŒè¿‡ç¨‹ä½¿ç”¨Cè¯­è¨€æ¥å®ç°ï¼ˆåˆå§‹åŒ–ä½¿ç”¨çš„ç¡¬ä»¶è®¾å¤‡ï¼Œæ£€æµ‹ç³»ç»Ÿå†…å­˜æ˜ å°„ï¼Œå°†å†…æ ¸æ˜ åƒå’Œæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜ åƒä»Flashè¯»åˆ°RAMä¸­ï¼Œä¸ºå†…æ ¸è®¾ç½®å¯åŠ¨å‚æ•°ï¼Œè°ƒç”¨å†…æ ¸ï¼‰ã€‚</p><p>è°ƒç”¨å†…æ ¸å‰å¿…é¡»æ»¡è¶³ï¼š</p><ol><li><p>CPU å¯„å­˜å™¨çš„è®¾ç½®</p><ul><li><p>R0&#x3D;0</p></li><li><p>R1&#x3D;æœºå™¨ç±»å‹çš„ID</p></li><li><p>R2&#x3D;å¯åŠ¨å‚æ•°æ ‡è®°åˆ—è¡¨åœ¨RAMä¸­çš„èµ·å§‹åŸºåœ°å€</p></li></ul></li><li><p>CPUå·¥ä½œæ¨¡å¼</p><ul><li><p>å¿…é¡»ç¦æ­¢ä¸­æ–­</p></li><li><p>CPUå¿…é¡»ä¸ºSVC æ¨¡å¼</p></li></ul></li><li><p>Cacheå’ŒMMUçš„è®¾ç½®</p><ul><li><p>MMUå¿…é¡»å…³é—­</p></li><li><p>æŒ‡ä»¤Cacheå¯å¼€å¯å…³</p></li><li><p>æ•°æ®Cacheå¿…é¡»å…³</p></li></ul></li></ol><p>Ubootæ˜¯é€šç”¨Bootloaderï¼Œå¯ä»¥å¼•å¯¼å¤šç§æ¶æ„çš„CPUï¼Œå…·æœ‰å¼€æºä»£ç ï¼Œæ”¯æŒå¤šç§åµŒå…¥å¼æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œæ”¯æŒå¤šç§å¤„ç†å™¨ç³»åˆ—ï¼Œæœ‰è¾ƒé«˜çš„å¯é æ€§å’Œç¨³å®šæ€§ï¼Œé«˜åº¦çµæ´»çš„åŠŸèƒ½è®¾ç½®ï¼Œæœ‰ä¸°å¯Œçš„è®¾å¤‡é©±åŠ¨æºç ï¼Œæœ‰è°ƒè¯•æ–‡æ¡£å’ŒæŠ€æœ¯æ”¯æŒï¼Œæ”¯æŒNFSæŒ‚è½½ï¼Œæ”¯æŒç›®æ ‡æ¿ç¯å¢ƒå˜é‡å¤šç§å­˜å‚¨æ–¹å¼ï¼Œä¸Šç”µè‡ªæ£€ã€‚</p><h3 id="ä½¿ç”¨Uboot"><a href="#ä½¿ç”¨Uboot" class="headerlink" title="ä½¿ç”¨Uboot"></a>ä½¿ç”¨Uboot</h3><p>å°†Ubootå‹ç¼©åŒ…åœ¨Ubuntuä¸Šè§£å‹åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥ç¼–è¯‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean</span><br><span class="line">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- (åŠ ç©ºæ ¼)</span><br><span class="line">mx6ull_14x14_ddr512_emmc_defconfig</span><br><span class="line">make V=1 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j12</span><br></pre></td></tr></table></figure><p>è¿™ä¸‰æ¡å‘½ä»¤ä¸­ ARCH&#x3D;arm è®¾ç½®ç›®æ ‡ä¸º arm æ¶æ„ï¼ŒCROSS_COMPILE æŒ‡å®šæ‰€ä½¿ç”¨çš„äº¤å‰ç¼–è¯‘å™¨ã€‚ç¬¬ä¸€æ¡å‘½ä»¤ç›¸å½“äºâ€œmake distcleanâ€ï¼Œç›®çš„æ˜¯æ¸…é™¤å·¥ç¨‹ï¼Œä¸€èˆ¬åœ¨ç¬¬ä¸€æ¬¡ç¼–è¯‘çš„æ—¶å€™æœ€å¥½æ¸…ç†ä¸€ä¸‹å·¥ç¨‹ã€‚ç¬¬äºŒæ¡æŒ‡ä»¤ç›¸å½“äºâ€œmake mx6ull_14x14_ddr512_emmc_defconfigâ€ï¼Œç”¨äºé…ç½® ubootï¼Œé…ç½®æ–‡ä»¶ä¸º mx6ull_14x14_ddr512_emmc_defconfigã€‚æœ€åä¸€æ¡æŒ‡ä»¤ç›¸å½“äº â€œmake -j12â€ä¹Ÿå°±æ˜¯ä½¿ç”¨ 12 æ ¸æ¥ç¼–è¯‘ ubootã€‚</p><p>ä¹‹åä½¿ç”¨imxdownloadå°†uboot.binä¸‹è½½è¿›å…¥sdå¡ï¼Œä¹‹åå°†æ¿å­çš„uart1æ¥ä¸Šttlè½¬usbï¼Œä¹‹åæ‰“å¼€MobaXtermã€‚è®¾ç½®å¥½å‚æ•°åï¼Œå¤ä½linuxæ¿å­ï¼Œä¹‹åæŒ‰ä¸‹å›è½¦é”®ï¼Œè¿›å…¥ubootå‘½ä»¤è¡Œã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230302_164244.png"></p><h3 id="bootæŒ‡ä»¤ä½¿ç”¨"><a href="#bootæŒ‡ä»¤ä½¿ç”¨" class="headerlink" title="bootæŒ‡ä»¤ä½¿ç”¨"></a>bootæŒ‡ä»¤ä½¿ç”¨</h3><h4 id="ä¿¡æ¯æŸ¥è¯¢å‘½ä»¤"><a href="#ä¿¡æ¯æŸ¥è¯¢å‘½ä»¤" class="headerlink" title="ä¿¡æ¯æŸ¥è¯¢å‘½ä»¤"></a>ä¿¡æ¯æŸ¥è¯¢å‘½ä»¤</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bdinfo//ç”¨äºæŸ¥çœ‹æ¿å­ä¿¡æ¯</span><br><span class="line">printenv//ç”¨äºè¾“å‡ºç¯å¢ƒå˜é‡</span><br><span class="line">version //ç”¨äºæŸ¥çœ‹ubootç‰ˆæœ¬å·</span><br></pre></td></tr></table></figure><h4 id="ç¯å¢ƒå˜é‡æ“ä½œå‘½ä»¤"><a href="#ç¯å¢ƒå˜é‡æ“ä½œå‘½ä»¤" class="headerlink" title="ç¯å¢ƒå˜é‡æ“ä½œå‘½ä»¤"></a>ç¯å¢ƒå˜é‡æ“ä½œå‘½ä»¤</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">saveenv //ä¿å­˜ä¿®æ”¹åçš„ç¯å¢ƒå˜é‡ã€</span><br><span class="line">setenv  //ç”¨äºè®¾ç½®æˆ–è€…ä¿®æ”¹ç¯å¢ƒå˜é‡</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬ç¯å¢ƒå˜é‡æ˜¯å­˜æ”¾åœ¨å¤–éƒ¨ flash ä¸­çš„ï¼Œuboot å¯åŠ¨çš„æ—¶å€™ä¼šå°†ç¯å¢ƒå˜é‡ä» flash è¯»å–åˆ° DRAM ä¸­ã€‚æ‰€ä»¥ä½¿ç”¨å‘½ä»¤ setenv ä¿®æ”¹çš„æ˜¯ DRAMä¸­çš„ç¯å¢ƒå˜é‡å€¼ï¼Œä¿®æ”¹ä»¥åè¦ä½¿ç”¨ saveenv å‘½ä»¤å°†ä¿®æ”¹åçš„ç¯å¢ƒå˜é‡ä¿å­˜åˆ° flash ä¸­ï¼Œå¦åˆ™çš„è¯uboot ä¸‹ä¸€æ¬¡é‡å¯ä¼šç»§ç»­ä½¿ç”¨ä»¥å‰çš„ç¯å¢ƒå˜é‡å€¼ã€‚</p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨setenvæ¥åˆ é™¤ç¯å¢ƒå˜é‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set author</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤ä¸­é€šè¿‡ setenv ç»™ author èµ‹ç©ºå€¼ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆéƒ½ä¸å†™æ¥åˆ é™¤ç¯å¢ƒå˜é‡ authorã€‚é‡å¯uboot å°±ä¼šå‘ç°ç¯å¢ƒå˜é‡ author æ²¡æœ‰äº†ã€‚</p><h4 id="å†…å­˜æ“ä½œå‘½ä»¤"><a href="#å†…å­˜æ“ä½œå‘½ä»¤" class="headerlink" title="å†…å­˜æ“ä½œå‘½ä»¤"></a>å†…å­˜æ“ä½œå‘½ä»¤</h4><p>md å‘½ä»¤ç”¨äºæ˜¾ç¤ºå†…å­˜å€¼ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md[.b, .w, .l] address [# of objects]</span><br></pre></td></tr></table></figure><p>å‘½ä»¤ä¸­çš„[.b .w .l]å¯¹åº” byteã€word å’Œ longï¼Œä¹Ÿå°±æ˜¯åˆ†åˆ«ä»¥ 1ä¸ªå­—èŠ‚ã€2 ä¸ªå­—èŠ‚ã€4 ä¸ªå­—èŠ‚æ¥æ˜¾ç¤ºå†…å­˜å€¼ã€‚address å°±æ˜¯è¦æŸ¥çœ‹çš„å†…å­˜èµ·å§‹åœ°å€ï¼Œ[# of objects]è¡¨ç¤ºè¦æŸ¥çœ‹çš„æ•°æ®é•¿åº¦ã€‚</p><p><strong>Ubootå‘½ä»¤ä¸­çš„æ•°å­—æ˜¯åå…­è¿›åˆ¶çš„ã€‚</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md.b 80000000 14 ä»¥ 0X80000000 å¼€å§‹çš„ 20 ä¸ªå­—èŠ‚çš„å†…å­˜å€¼</span><br></pre></td></tr></table></figure><p>nm å‘½ä»¤ç”¨äºä¿®æ”¹æŒ‡å®šåœ°å€çš„å†…å­˜å€¼ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nm [.b, .w, .l] address</span><br></pre></td></tr></table></figure><p>nm å‘½ä»¤åŒæ ·å¯ä»¥ä»¥.bã€.w å’Œ.l æ¥æŒ‡å®šæ“ä½œæ ¼å¼ï¼Œæ¯”å¦‚ç°åœ¨ä»¥.læ ¼å¼ä¿®æ”¹ 0x80000000 åœ°å€çš„æ•°æ®ä¸º 0x12345678ã€‚è¾“å…¥å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nm.l 80000000</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230302_203017.png"></p><p>80000000 è¡¨ç¤ºç°åœ¨è¦ä¿®æ”¹çš„å†…å­˜åœ°å€ï¼Œ0500e031 è¡¨ç¤ºåœ°å€0x80000000 ç°åœ¨çš„æ•°æ®ï¼Œï¼Ÿåé¢å°±å¯ä»¥è¾“å…¥è¦ä¿®æ”¹åçš„æ•°æ® 0x12345678ï¼Œè¾“å…¥å®Œæˆä»¥åæŒ‰ä¸‹å›è½¦ï¼Œç„¶åå†è¾“å…¥â€˜qâ€™å³å¯é€€å‡º</p><p>mm å‘½ä»¤ä¹Ÿæ˜¯ä¿®æ”¹æŒ‡å®šåœ°å€å†…å­˜å€¼çš„ï¼Œä½¿ç”¨ mm ä¿®æ”¹å†…å­˜å€¼çš„æ—¶å€™åœ°å€ä¼šè‡ªå¢ã€‚æ¯”å¦‚ä»¥.l æ ¼å¼ä¿®æ”¹ä»åœ°å€ 0x80000000 å¼€å§‹çš„è¿ç»­ 3 ä¸ªå†…å­˜å—(3*4&#x3D;12ä¸ªå­—èŠ‚)çš„æ•°æ®ä¸º 0X05050505ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230302_203845.png"></p><p>å‘½ä»¤ mw ç”¨äºä½¿ç”¨ä¸€ä¸ªæŒ‡å®šçš„æ•°æ®å¡«å……ä¸€æ®µå†…å­˜ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mw [.b, .w, .l] address value [count]</span><br></pre></td></tr></table></figure><p>mw å‘½ä»¤åŒæ ·å¯ä»¥ä»¥.bã€.w å’Œ.l æ¥æŒ‡å®šæ“ä½œæ ¼å¼ï¼Œaddress è¡¨ç¤ºè¦å¡«å……çš„å†…å­˜èµ·å§‹åœ°å€ï¼Œvalueä¸ºè¦å¡«å……çš„æ•°æ®ï¼Œcount æ˜¯å¡«å……çš„é•¿åº¦ã€‚æ¯”å¦‚ä½¿ç”¨.l æ ¼å¼å°†ä»¥ 0X80000000 ä¸ºèµ·å§‹åœ°å€çš„ 0x10 ä¸ªå†…å­˜å—(0x10 * 4&#x3D;64 å­—èŠ‚)å¡«å……ä¸º 0X0A0A0A0A</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mw.l 80000000 0A0A0A0A 10</span><br></pre></td></tr></table></figure><p>cp æ˜¯æ•°æ®æ‹·è´å‘½ä»¤ï¼Œç”¨äºå°† DRAM ä¸­çš„æ•°æ®ä»ä¸€æ®µå†…å­˜æ‹·è´åˆ°å¦ä¸€æ®µå†…å­˜ä¸­ï¼Œæˆ–è€…æŠŠ Nor Flash ä¸­çš„æ•°æ®æ‹·è´åˆ° DRAM ä¸­ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp [.b, .w, .l] source target count</span><br></pre></td></tr></table></figure><p>cp å‘½ä»¤åŒæ ·å¯ä»¥ä»¥.bã€.w å’Œ.l æ¥æŒ‡å®šæ“ä½œæ ¼å¼ï¼Œsource ä¸ºæºåœ°å€ï¼Œtarget ä¸ºç›®çš„åœ°å€ï¼Œcountä¸ºæ‹·è´çš„é•¿åº¦ã€‚æˆ‘ä»¬ä½¿ç”¨.l æ ¼å¼å°† 0x80000000 å¤„çš„åœ°å€æ‹·è´åˆ° 0X80000100 å¤„ï¼Œé•¿åº¦ä¸º0x10 ä¸ªå†…å­˜å—(0x10 * 4&#x3D;64 ä¸ªå­—èŠ‚)ï¼Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp.l 80000000 80000100 10</span><br></pre></td></tr></table></figure><p>cmp æ˜¯æ¯”è¾ƒå‘½ä»¤ï¼Œç”¨äºæ¯”è¾ƒä¸¤æ®µå†…å­˜çš„æ•°æ®æ˜¯å¦ç›¸ç­‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmp [.b, .w, .l] addr1 addr2 count</span><br></pre></td></tr></table></figure><p>addr1 ä¸ºç¬¬ä¸€æ®µå†…å­˜é¦–åœ°å€ï¼Œaddr2 ä¸ºç¬¬äºŒæ®µå†…å­˜é¦–åœ°å€ï¼Œcount ä¸ºè¦æ¯”è¾ƒçš„é•¿åº¦ã€‚</p><h4 id="ç½‘ç»œæ“ä½œå‘½ä»¤"><a href="#ç½‘ç»œæ“ä½œå‘½ä»¤" class="headerlink" title="ç½‘ç»œæ“ä½œå‘½ä»¤"></a>ç½‘ç»œæ“ä½œå‘½ä»¤</h4><p>å°†å¼€å‘æ¿çš„enet2æ¥å£å’Œwifiæˆ–è€…ç”µè„‘è¿æ¥ï¼Œä½¿ç”¨setenvå’Œsaveenvå‘½ä»¤æ¥è®¾ç½®ç½‘ç»œçš„ipç›¸å…³å‚æ•°ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230303_130601.png"></p><p><strong>ping å‘½ä»¤</strong></p><p>å¼€å‘æ¿çš„ç½‘ç»œèƒ½å¦ä½¿ç”¨ï¼Œæ˜¯å¦å¯ä»¥å’ŒæœåŠ¡å™¨(Ubuntu ä¸»æœº)è¿›è¡Œé€šä¿¡ï¼Œé€šè¿‡ ping å‘½ä»¤å°±å¯ä»¥éªŒè¯ï¼Œç›´æ¥ ping æœåŠ¡å™¨çš„ IP åœ°å€å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.1.115</span><br></pre></td></tr></table></figure><p><strong>dhcp å‘½ä»¤</strong></p><p>dhcp ç”¨äºä»è·¯ç”±å™¨è·å– IP åœ°å€ï¼Œå‰æå¾—å¼€å‘æ¿è¿æ¥åˆ°è·¯ç”±å™¨ä¸Šçš„ï¼Œå¦‚æœå¼€å‘æ¿æ˜¯å’Œç”µè„‘ç›´è¿çš„ï¼Œé‚£ä¹ˆ dhcp å‘½ä»¤å°±ä¼šå¤±æ•ˆã€‚ç›´æ¥è¾“å…¥ dhcp å‘½ä»¤å³å¯é€šè¿‡è·¯ç”±å™¨è·å–åˆ° IP åœ°å€.</p><p><strong>nfs å‘½ä»¤</strong></p><p>nfs(Network File System)ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œé€šè¿‡ nfs å¯ä»¥åœ¨è®¡ç®—æœºä¹‹é—´é€šè¿‡ç½‘ç»œæ¥åˆ†äº«èµ„æºï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒè¯• linux é•œåƒå’Œè®¾å¤‡æ ‘ï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œè°ƒè¯•ï¼Œé€šè¿‡ç½‘ç»œè°ƒè¯•æ˜¯ Linux å¼€å‘ä¸­æœ€å¸¸ç”¨çš„è°ƒè¯•æ–¹æ³•ã€‚åœ¨ Linux å†…æ ¸è°ƒè¯•é˜¶æ®µï¼Œå¦‚æœç”¨è¿™ä¸ªçƒ§å†™è½¯ä»¶çš„è¯å°†ä¼šéå¸¸æµªè´¹æ—¶é—´ï¼Œè€Œè¿™ä¸ªæ—¶å€™ç½‘ç»œè°ƒè¯•çš„ä¼˜åŠ¿å°±æ˜¾ç°å‡ºæ¥äº†ï¼Œå¯ä»¥é€šè¿‡ç½‘ç»œå°†ç¼–è¯‘å¥½çš„ linux é•œåƒå’Œè®¾å¤‡æ ‘æ–‡ä»¶ä¸‹è½½åˆ° DRAM ä¸­ï¼Œç„¶åå°±å¯ä»¥ç›´æ¥è¿è¡Œã€‚</p><p>ä¸€èˆ¬ä½¿ç”¨ uboot ä¸­çš„ nfs å‘½ä»¤å°† Ubuntu ä¸­çš„æ–‡ä»¶ä¸‹è½½åˆ°å¼€å‘æ¿çš„ DRAM ä¸­ï¼Œåœ¨ä½¿ç”¨ä¹‹å‰éœ€è¦å¼€å¯ Ubuntu ä¸»æœºçš„ NFS æœåŠ¡ï¼Œå¹¶ä¸”è¦æ–°å»ºä¸€ä¸ª NFS ä½¿ç”¨çš„ç›®å½•ï¼Œä»¥åæ‰€æœ‰è¦é€šè¿‡NFS è®¿é—®çš„æ–‡ä»¶éƒ½éœ€è¦æ”¾åˆ°è¿™ä¸ª NFS ç›®å½•ä¸­ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs [loadAddress] [[hostIPaddr:]bootfilename]</span><br></pre></td></tr></table></figure><p>loadAddress æ˜¯è¦ä¿å­˜çš„ DRAM åœ°å€[[hostIPaddr:]bootfilename]æ˜¯è¦ä¸‹è½½çš„æ–‡ä»¶åœ°å€ã€‚</p><p>Ubuntu20.04å…·ä½“å‚è€ƒä»¥ä¸‹æ–¹æ³•ï¼š</p><p><a href="https://blog.csdn.net/weixin_56646002/article/details/127388021">(åµŒå…¥å¼Linuxå¼€å‘â€”â€”è§£å†³ubootæ— æ³•ä½¿ç”¨nfsæœåŠ¡ä»ubuntuä¸­ä¸‹è½½æ–‡ä»¶ï¼ˆTTTã€cannot mountç­‰é”™è¯¯ï¼‰_</a></p><h4 id="EMMC-å’Œ-SD-å¡æ“ä½œå‘½ä»¤"><a href="#EMMC-å’Œ-SD-å¡æ“ä½œå‘½ä»¤" class="headerlink" title="EMMC å’Œ SD å¡æ“ä½œå‘½ä»¤"></a>EMMC å’Œ SD å¡æ“ä½œå‘½ä»¤</h4><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230303_190432.png">                       </p><p>å¦‚æœè¦åœ¨ uboot ä¸­æ›´æ–° SDå¯¹åº”çš„ ubootï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºå‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 0 0//åˆ‡æ¢SDå¡çš„0åŒº</span><br><span class="line">mmc write 80800000 2 2E6//2E6è¿™ä¸ªæ•°æ®æ ¹æ®å†™å…¥çš„å­—èŠ‚æ¥è½¬æ¢ä¸ºåå…­è¿›åˆ¶çƒ§å…¥ç¬¬ä¸‰ä¸ªæ‰‡åŒº</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦åœ¨ uboot ä¸­æ›´æ–° EMMC å¯¹åº”çš„ ubootï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºå‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 1 0 //åˆ‡æ¢åˆ° EMMC åˆ†åŒº 0</span><br><span class="line">tftp 80800000 u-boot.imx //ä¸‹è½½ u-boot.imx åˆ° DRAM</span><br><span class="line">mmc write 80800000 2 32E //çƒ§å†™ u-boot.imx åˆ° EMMC ä¸­çš„ç¬¬ä¸‰ä¸ªæ‰‡åŒº</span><br><span class="line">mmc partconf 1 1 0 0 //åˆ†åŒºé…ç½®ï¼ŒEMMC éœ€è¦è¿™ä¸€æ­¥ï¼</span><br></pre></td></tr></table></figure><h4 id="FAT-æ ¼å¼æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‘½ä»¤"><a href="#FAT-æ ¼å¼æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‘½ä»¤" class="headerlink" title="FAT æ ¼å¼æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‘½ä»¤"></a>FAT æ ¼å¼æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‘½ä»¤</h4><p><strong>fatinfo å‘½ä»¤</strong></p><p>fatinfo å‘½ä»¤ç”¨äºæŸ¥è¯¢æŒ‡å®š MMC è®¾å¤‡åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatinfo &lt;interface&gt; [&lt;dev[:part]&gt;]</span><br></pre></td></tr></table></figure><p>interface è¡¨ç¤ºæ¥å£ï¼Œæ¯”å¦‚ mmcï¼Œdev æ˜¯æŸ¥è¯¢çš„è®¾å¤‡å·ï¼Œpart æ˜¯è¦æŸ¥è¯¢çš„åˆ†åŒºã€‚æ¯”å¦‚æˆ‘ä»¬è¦æŸ¥è¯¢ EMMC åˆ†åŒº 1 çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatinfo mmc 1:1</span><br></pre></td></tr></table></figure><p><strong>fatls å‘½ä»¤</strong></p><p>fatls å‘½ä»¤ç”¨äºæŸ¥è¯¢ FAT æ ¼å¼è®¾å¤‡çš„ç›®å½•å’Œæ–‡ä»¶ä¿¡æ¯ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatls &lt;interface&gt; [&lt;dev[:part]&gt;] [directory]</span><br></pre></td></tr></table></figure><p>interface æ˜¯è¦æŸ¥è¯¢çš„æ¥å£ï¼Œæ¯”å¦‚ mmcï¼Œdev æ˜¯è¦æŸ¥è¯¢çš„è®¾å¤‡å·ï¼Œpart æ˜¯è¦æŸ¥è¯¢çš„åˆ†åŒºï¼Œdirectoryæ˜¯è¦æŸ¥è¯¢çš„ç›®å½•ã€‚</p><p><strong>fstype å‘½ä»¤</strong></p><p>fstype ç”¨äºæŸ¥çœ‹ MMC è®¾å¤‡æŸä¸ªåˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fstype &lt;interface&gt; &lt;dev&gt;:&lt;part&gt;</span><br></pre></td></tr></table></figure><p><strong>fatloadå‘½ä»¤</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatload &lt;interface&gt; [&lt;dev[:part]&gt; [&lt;addr&gt; [&lt;filename&gt; [bytes [pos]]]]]</span><br></pre></td></tr></table></figure><p>interface ä¸ºæ¥å£ï¼Œæ¯”å¦‚ mmcï¼Œdev æ˜¯è®¾å¤‡å·ï¼Œpart æ˜¯åˆ†åŒºï¼Œaddr æ˜¯ä¿å­˜åœ¨ DRAM ä¸­çš„èµ·å§‹åœ°å€ï¼Œfilename æ˜¯è¦è¯»å–çš„æ–‡ä»¶åå­—ã€‚bytes è¡¨ç¤ºè¯»å–å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼Œå¦‚æœ bytes ä¸º 0 æˆ–è€…çœç•¥çš„è¯è¡¨ç¤ºè¯»å–æ•´ä¸ªæ–‡ä»¶ã€‚pos æ˜¯è¦è¯»çš„æ–‡ä»¶ç›¸å¯¹äºæ–‡ä»¶é¦–åœ°å€çš„åç§»ï¼Œå¦‚æœä¸º 0 æˆ–è€…çœç•¥çš„è¯è¡¨ç¤ºä»æ–‡ä»¶é¦–åœ°å€å¼€å§‹è¯»å–ã€‚</p><p><strong>fatwriteå‘½ä»¤</strong></p><p><u>uboot é»˜è®¤æ²¡æœ‰ä½¿èƒ½ fatwrite å‘½ä»¤ï¼Œéœ€è¦ä¿®æ”¹æ¿å­é…ç½®å¤´æ–‡ä»¶</u></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define CONFIG_FAT_WRITE /* ä½¿èƒ½ fatwrite å‘½ä»¤ */</span><br></pre></td></tr></table></figure><p>fatwirte å‘½ä»¤ç”¨äºå°† DRAM ä¸­çš„æ•°æ®å†™å…¥åˆ° MMC è®¾å¤‡ä¸­ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatwrite &lt;interface&gt; &lt;dev[:part]&gt; &lt;addr&gt; &lt;filename&gt; &lt;bytes&gt;</span><br></pre></td></tr></table></figure><p>interface ä¸ºæ¥å£ï¼Œæ¯”å¦‚ mmcï¼Œdev æ˜¯è®¾å¤‡å·ï¼Œpart æ˜¯åˆ†åŒºï¼Œaddr æ˜¯è¦å†™å…¥çš„æ•°æ®åœ¨ DRAMä¸­çš„èµ·å§‹åœ°å€ï¼Œfilename æ˜¯å†™å…¥çš„æ•°æ®æ–‡ä»¶åå­—ï¼Œbytes è¡¨ç¤ºè¦å†™å…¥å¤šå°‘å­—èŠ‚çš„æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ fatwrite å‘½ä»¤åœ¨ uboot ä¸­æ›´æ–° linux é•œåƒæ–‡ä»¶å’Œè®¾å¤‡æ ‘ã€‚</p><h4 id="EXT-æ ¼å¼æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‘½ä»¤"><a href="#EXT-æ ¼å¼æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‘½ä»¤" class="headerlink" title="EXT æ ¼å¼æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‘½ä»¤"></a>EXT æ ¼å¼æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‘½ä»¤</h4><p>å¸¸ç”¨çš„å°±å››ä¸ªå‘½ä»¤ï¼Œåˆ†åˆ«ä¸ºï¼šext2loadã€ext2lsã€ext4loadã€ext4ls å’Œ ext4writeï¼Œè¿™äº›å‘½ä»¤çš„å«ä¹‰å’Œä½¿ç”¨ä¸ fatloadã€fatls å’Œ fatwriteä¸€æ ·ï¼Œåªæ˜¯ ext2 å’Œ ext4 éƒ½æ˜¯é’ˆå¯¹ ext æ–‡ä»¶ç³»ç»Ÿçš„ã€‚</p><h4 id="Bootæ“ä½œå‘½ä»¤"><a href="#Bootæ“ä½œå‘½ä»¤" class="headerlink" title="Bootæ“ä½œå‘½ä»¤"></a>Bootæ“ä½œå‘½ä»¤</h4><p><strong>bootzå‘½ä»¤</strong></p><p>è¦å¯åŠ¨ Linuxï¼Œéœ€è¦å…ˆå°† Linux é•œåƒæ–‡ä»¶æ‹·è´åˆ° DRAM ä¸­ï¼Œå¦‚æœä½¿ç”¨åˆ°è®¾å¤‡æ ‘çš„è¯ä¹Ÿéœ€è¦å°†è®¾å¤‡æ ‘æ‹·è´åˆ° DRAM ä¸­ã€‚å¯ä»¥ä» EMMC æˆ–è€… NAND ç­‰å­˜å‚¨è®¾å¤‡ä¸­å°† Linux é•œåƒå’Œè®¾å¤‡æ ‘æ–‡ä»¶æ‹·è´åˆ° DRAMï¼Œä¹Ÿå¯ä»¥é€šè¿‡ nfs æˆ–è€… tftp å°† Linux é•œåƒæ–‡ä»¶å’Œè®¾å¤‡æ ‘æ–‡ä»¶ä¸‹è½½åˆ° DRAM ä¸­ã€‚</p><p>ä¹‹åå°±å¯ä»¥ä½¿ç”¨bootzæ¥å¯åŠ¨zImageé•œåƒæ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootz [addr [initrd[:size]] [fdt]]</span><br></pre></td></tr></table></figure><p>å‘½ä»¤ bootz æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œaddr æ˜¯ Linux é•œåƒæ–‡ä»¶åœ¨ DRAM ä¸­çš„ä½ç½®ï¼Œinitrd æ˜¯ initrd æ–‡ä»¶åœ¨DRAM ä¸­çš„åœ°å€ï¼Œå¦‚æœä¸ä½¿ç”¨ initrd çš„è¯ä½¿ç”¨â€˜-â€™ä»£æ›¿å³å¯ï¼Œfdt å°±æ˜¯è®¾å¤‡æ ‘æ–‡ä»¶åœ¨ DRAM ä¸­çš„åœ°å€ã€‚</p><p><strong>bootm å‘½ä»¤</strong></p><p>bootm å’Œ bootz åŠŸèƒ½ç±»ä¼¼ï¼Œä½†æ˜¯ bootm ç”¨äºå¯åŠ¨ uImage é•œåƒæ–‡ä»¶ã€‚å¦‚æœä¸ä½¿ç”¨è®¾å¤‡æ ‘çš„è¯å¯åŠ¨ Linux å†…æ ¸çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootm addr</span><br></pre></td></tr></table></figure><p>addr æ˜¯ uImage é•œåƒåœ¨ DRAM ä¸­çš„é¦–åœ°å€ã€‚<br>å¦‚æœè¦ä½¿ç”¨è®¾å¤‡æ ‘ï¼Œé‚£ä¹ˆ bootm å‘½ä»¤å’Œ bootz ä¸€æ ·ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootm [addr [initrd[:size]] [fdt]]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ addr æ˜¯ uImage åœ¨ DRAM ä¸­çš„é¦–åœ°å€ï¼Œinitrd æ˜¯ initrd çš„åœ°å€ï¼Œfdt æ˜¯è®¾å¤‡æ ‘(.dtb)æ–‡ä»¶åœ¨ DRAM ä¸­çš„é¦–åœ°å€ï¼Œå¦‚æœ initrd ä¸ºç©ºçš„è¯ï¼ŒåŒæ ·æ˜¯ç”¨â€œ-â€æ¥æ›¿ä»£ã€‚</p><p><strong>boot å‘½ä»¤</strong></p><p>boot å‘½ä»¤ä¹Ÿæ˜¯ç”¨æ¥å¯åŠ¨ Linux ç³»ç»Ÿçš„ï¼Œåªæ˜¯ boot ä¼šè¯»å–ç¯å¢ƒå˜é‡ bootcmd æ¥å¯åŠ¨ Linux ç³»ç»Ÿï¼Œbootcmd æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç¯å¢ƒå˜é‡ï¼å…¶åå­—åˆ†ä¸ºâ€œbootâ€å’Œâ€œcmdâ€ï¼Œä¹Ÿå°±æ˜¯â€œå¼•å¯¼â€å’Œâ€œå‘½ä»¤â€ï¼Œè¯´æ˜è¿™ä¸ªç¯å¢ƒå˜é‡ä¿å­˜ç€å¼•å¯¼å‘½ä»¤ï¼Œå…¶å®å°±æ˜¯å¯åŠ¨çš„å‘½ä»¤é›†åˆï¼Œå…·ä½“çš„å¼•å¯¼å‘½ä»¤å†…å®¹æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚æ¯”å¦‚æˆ‘ä»¬è¦æƒ³ä½¿ç”¨ tftp å‘½ä»¤ä»ç½‘ç»œå¯åŠ¨ Linux é‚£ä¹ˆå°±å¯ä»¥è®¾ç½® bootcmd ä¸ºâ€œtftp 80800000 zImage; tftp 83000000 imx6ull-14x14-emmc-7-1024x600-c.dtb; bootz 80800000 -83000000â€ï¼Œç„¶åä½¿ç”¨ saveenv å°† bootcmd ä¿å­˜èµ·æ¥ã€‚ç„¶åç›´æ¥è¾“å…¥ boot å‘½ä»¤å³å¯ä»ç½‘ç»œå¯åŠ¨Linux ç³»ç»Ÿï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd &#x27;tftp 80800000 zImage; tftp 83000000 imx6ull-14x14-emmc-7-1024x600-c.dtb; bootz 80800000 - 83000000&#x27;</span><br><span class="line">saveenv</span><br><span class="line">boot</span><br></pre></td></tr></table></figure><h4 id="å…¶ä»–å¸¸ç”¨å‘½ä»¤"><a href="#å…¶ä»–å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å…¶ä»–å¸¸ç”¨å‘½ä»¤"></a>å…¶ä»–å¸¸ç”¨å‘½ä»¤</h4><p><strong>resetå‘½ä»¤</strong></p><p>è¾“å…¥resetå³å¯å®ç°å¤ä½é‡å¯ã€‚</p><p><strong>go å‘½ä»¤</strong></p><p>go å‘½ä»¤ç”¨äºè·³åˆ°æŒ‡å®šçš„åœ°å€å¤„æ‰§è¡Œåº”ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go addr [arg ...]</span><br></pre></td></tr></table></figure><p><strong>run å‘½ä»¤</strong></p><p>run å‘½ä»¤ç”¨äºè¿è¡Œç¯å¢ƒå˜é‡ä¸­å®šä¹‰çš„å‘½ä»¤ï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡â€œrun bootcmdâ€æ¥è¿è¡Œ bootcmd ä¸­çš„å¯åŠ¨å‘½ä»¤ï¼Œä½†æ˜¯ run å‘½ä»¤æœ€å¤§çš„ä½œç”¨åœ¨äºè¿è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç¯å¢ƒå˜é‡ã€‚åœ¨åé¢è°ƒè¯• Linux ç³»ç»Ÿçš„æ—¶å€™å¸¸å¸¸è¦åœ¨ç½‘ç»œå¯åŠ¨å’Œ EMMC&#x2F;NAND å¯åŠ¨ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œè€Œ bootcmd åªèƒ½ä¿å­˜ä¸€ç§å¯åŠ¨æ–¹å¼ï¼Œå¦‚æœè¦æ¢å¦å¤–ä¸€ç§å¯åŠ¨æ–¹å¼çš„è¯å°±å¾—é‡å†™ bootcmdï¼Œä¼šå¾ˆéº»çƒ¦ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç¯å¢ƒå˜é‡æ¥å®ç°ä¸åŒçš„å¯åŠ¨æ–¹å¼ï¼Œæ¯”å¦‚å®šä¹‰ç¯å¢ƒå˜é‡ mybootemmc è¡¨ç¤ºä» emmc å¯åŠ¨ï¼Œå®šä¹‰ mybootnet è¡¨ç¤ºä»ç½‘ç»œå¯åŠ¨ï¼Œå®šä¹‰ mybootnand è¡¨ç¤ºä» NAND å¯åŠ¨ã€‚å¦‚æœè¦åˆ‡æ¢å¯åŠ¨æ–¹å¼çš„è¯åªéœ€è¦è¿è¡Œâ€œrun mybootxxx(xxx ä¸º emmcã€net æˆ– nand)â€å³å¯ã€‚</p><p><strong>mtest å‘½ä»¤</strong></p><p>mtest å‘½ä»¤æ˜¯ä¸€ä¸ªç®€å•çš„å†…å­˜è¯»å†™æµ‹è¯•å‘½ä»¤ï¼Œå¯ä»¥ç”¨æ¥æµ‹è¯•è‡ªå·±å¼€å‘æ¿ä¸Šçš„ DDRï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mtest [start [end [pattern [iterations]]]]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ç³»ç»Ÿç§»æ¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6ualçš„DDR3ï¼ˆå†…å­˜èŠ¯ç‰‡ï¼‰çš„ä½¿ç”¨</title>
      <link href="/2023/02/28/2023-2-28-imx6ual%E7%9A%84DDR3%EF%BC%88%E5%86%85%E5%AD%98%E8%8A%AF%E7%89%87%EF%BC%89%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/2023/02/28/2023-2-28-imx6ual%E7%9A%84DDR3%EF%BC%88%E5%86%85%E5%AD%98%E8%8A%AF%E7%89%87%EF%BC%89%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="ä½•ä¸ºä½ï¼Ÿä½å®½ï¼Ÿå­—ï¼Ÿå­—é•¿ï¼Ÿå­—èŠ‚ï¼Ÿ"><a href="#ä½•ä¸ºä½ï¼Ÿä½å®½ï¼Ÿå­—ï¼Ÿå­—é•¿ï¼Ÿå­—èŠ‚ï¼Ÿ" class="headerlink" title="ä½•ä¸ºä½ï¼Ÿä½å®½ï¼Ÿå­—ï¼Ÿå­—é•¿ï¼Ÿå­—èŠ‚ï¼Ÿ"></a>ä½•ä¸ºä½ï¼Ÿä½å®½ï¼Ÿå­—ï¼Ÿå­—é•¿ï¼Ÿå­—èŠ‚ï¼Ÿ</h3><p><strong>è®¡ç®—æœºåœ¨è¿›è¡Œæ•°æ®å¤„ç†ï¼Œä¸€æ¬¡å­˜å–ã€åŠ å·¥ã€ä¼ é€çš„æ•°æ®é•¿åº¦ç§°ä¸ºå­—(word)ã€‚</strong></p><p><strong>å­—é•¿ï¼Œæ˜¯CPUä¸€æ¬¡èƒ½å¤„ç†çš„äºŒè¿›åˆ¶æ•°çš„ä½æ•°ï¼Œ*å­—é•¿ä¸ä¹‹å…³è”çš„æ˜¯æ•°æ®æ€»çº¿çš„ä½æ•°</strong>ï¼Œå­—é•¿ä¸º32ï¼Œåˆ™æ•°æ®æ€»çº¿çš„å®½åº¦ä¸º32ä½ã€‚*æ¯”å¦‚CPUä¸€æ¬¡å¯ä»¥å¤„ç†8ä¸ª1ï¼ˆæˆ–è€…0ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°è¿™ä¸ªCPUæ˜¯8ä½çš„CPUï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªCPUçš„å­—é•¿æ˜¯8ä½ã€‚å¦‚æœCPUä¸€æ¬¡å¯ä»¥å¤„ç†16ä¸ªäºŒè¿›åˆ¶æ•°ï¼Œè¿™ä¸ªCPUçš„å­—é•¿å°±æ˜¯16ä½ã€‚<br><strong>ä½å®½å°±æ˜¯å†…å­˜æˆ–æ˜¾å­˜ä¸€æ¬¡èƒ½ä¼ è¾“çš„æ•°æ®é‡</strong>ã€‚(è¿™é‡Œæˆ‘å¯¹ä½å®½çš„ç†è§£ä¹Ÿä»…é™äºæ­¤ï¼‰ç®€å•åœ°è®²å°±æ˜¯ä¸€æ¬¡èƒ½ä¼ é€’çš„æ•°æ®å®½åº¦ã€‚å­—é•¿æŒ‡çš„æ˜¯è®¡ç®—èƒ½åŠ›ï¼Œä½å®½æŒ‡çš„æ˜¯ä¼ è¾“èƒ½åŠ›ã€‚</p><p><em>è®¡ç®—æœºä¸‰å¤§æ€»çº¿ï¼šåœ°å€çº¿ï¼Œæ§åˆ¶çº¿ï¼Œæ•°æ®çº¿ã€‚</em></p><p><strong>æ•°æ®æ€»çº¿</strong><br>â‘ æ˜¯CPUä¸å†…å­˜æˆ–å…¶ä»–å™¨ä»¶ä¹‹é—´çš„æ•°æ®ä¼ é€çš„é€šé“ã€‚</p><p>â‘¡æ•°æ®æ€»çº¿çš„å®½åº¦å†³å®šäº†CPUå’Œå¤–ç•Œçš„æ•°æ®ä¼ é€é€Ÿåº¦ã€‚</p><p>â‘¢æ¯æ¡ä¼ è¾“çº¿ä¸€æ¬¡åªèƒ½ä¼ è¾“1ä½äºŒè¿›åˆ¶æ•°æ®ã€‚eg: 8æ ¹æ•°æ®çº¿ä¸€æ¬¡å¯ä¼ é€ä¸€ä¸ª8ä½äºŒè¿›åˆ¶æ•°æ®(å³ä¸€ä¸ªå­—èŠ‚)ã€‚</p><p>â‘£æ•°æ®æ€»çº¿æ˜¯æ•°æ®çº¿æ•°é‡ä¹‹å’Œã€‚</p><p><strong>åœ°å€æ€»çº¿</strong><br>â‘ CPUæ˜¯é€šè¿‡åœ°å€æ€»çº¿æ¥æŒ‡å®šå­˜å‚¨å•å…ƒçš„ã€‚</p><p>â‘¡åœ°å€æ€»çº¿å†³å®šäº†cpuæ‰€èƒ½è®¿é—®çš„æœ€å¤§å†…å­˜ç©ºé—´çš„å¤§å°ã€‚eg: 10æ ¹åœ°å€çº¿èƒ½è®¿é—®çš„æœ€å¤§çš„å†…å­˜ä¸º1024ä½äºŒè¿›åˆ¶æ•°æ®ï¼ˆ1024ä¸ªå†…å­˜å•å…ƒï¼‰(1B)</p><p>â‘¢åœ°å€æ€»çº¿æ˜¯åœ°å€çº¿æ•°é‡ä¹‹å’Œã€‚</p><p><strong>æ§åˆ¶æ€»çº¿</strong><br>â‘ CPUé€šè¿‡æ§åˆ¶æ€»çº¿å¯¹å¤–éƒ¨å™¨ä»¶è¿›è¡Œæ§åˆ¶ã€‚</p><p>â‘¡æ§åˆ¶æ€»çº¿çš„å®½åº¦å†³å®šäº†CPUå¯¹å¤–éƒ¨å™¨ä»¶çš„æ§åˆ¶èƒ½åŠ›ã€‚</p><p>â‘¢æ§åˆ¶æ€»çº¿æ˜¯æ§åˆ¶çº¿æ•°é‡ä¹‹å’Œã€‚</p><h3 id="RAMå’ŒROM"><a href="#RAMå’ŒROM" class="headerlink" title="RAMå’ŒROM"></a>RAMå’ŒROM</h3><p>RAMï¼šéšæœºå­˜å‚¨å™¨ï¼Œå¯ä»¥éšæ—¶è¿›è¡Œè¯»å†™æ“ä½œï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œæ‰ç”µä»¥åæ•°æ®ä¼šä¸¢å¤±ã€‚æ¯”å¦‚å†…å­˜æ¡ã€SRAMã€SDRAMã€DDR ç­‰éƒ½æ˜¯ RAMã€‚RAM ä¸€èˆ¬ç”¨æ¥ä¿å­˜ç¨‹åºæ•°æ®ã€ä¸­é—´ç»“æœï¼Œæ‰ç”µå°±ä¼šä¸¢å¤±æ•°æ®ã€‚</p><p>ROMï¼šåªè¯»å­˜å‚¨å™¨ï¼Œå®¹é‡å¤§ï¼Œä½†æ˜¯æ‰ç”µåæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œé€‚åˆç”¨æ¥å­˜å‚¨èµ„æ–™ï¼Œä¾‹å¦‚å›¾ç‰‡ï¼ŒéŸ³é¢‘ï¼Œæ–‡ä»¶ç­‰ã€‚</p><p>SRAMï¼šé™æ€éšæœºå­˜å‚¨å™¨ï¼Œè¿™é‡Œçš„â€œé™æ€â€è¯´çš„å°±æ˜¯åªè¦ SRAM ä¸Šç”µï¼Œé‚£ä¹ˆ SRAM é‡Œé¢çš„æ•°æ®å°±ä¼šä¸€ç›´ä¿å­˜ç€ï¼Œç›´åˆ° SRAM æ‰ç”µã€‚</p><p>SDRAM å…¨ç§°æ˜¯ åŒæ­¥åŠ¨æ€éšæœºå­˜å‚¨å™¨ï¼Œâ€œåŒæ­¥â€çš„æ„æ€æ˜¯ SDRAM å·¥ä½œéœ€è¦æ—¶é’Ÿçº¿ï¼Œâ€œåŠ¨æ€â€çš„æ„æ€æ˜¯ SDRAM ä¸­çš„æ•°æ®éœ€è¦ä¸æ–­çš„åˆ·æ–°æ¥ä¿è¯æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œâ€œéšæœºâ€çš„æ„æ€å°±æ˜¯å¯ä»¥è¯»å†™ä»»æ„åœ°å€çš„æ•°æ®ã€‚SDRAM åˆ†ä¸º SDR SDRAMã€DDR SDRAMã€DDR2 SDRAMã€DDR3 SDRAMã€DDR4 SDRAMã€‚</p><p>DDR å…¨ç§°æ˜¯ Double Data Rate SDRAMï¼Œä¹Ÿå°±æ˜¯åŒå€é€Ÿç‡ SDRAMï¼Œçœ‹åå­—å°±çŸ¥é“ DDR çš„é€Ÿç‡(æ•°æ®ä¼ è¾“é€Ÿç‡)æ¯” SDRAM é«˜ 1 å€ï¼è¿™ 1 å€çš„é€Ÿåº¦ä¸æ˜¯ç®€ç®€å•å•çš„å°† CLK æé«˜ 1 å€ï¼ŒSDRAM åœ¨ä¸€ä¸ª CLK å‘¨æœŸä¼ è¾“ä¸€æ¬¡æ•°æ®ï¼ŒDDR åœ¨ä¸€ä¸ª CLK å‘¨æœŸä¼ è¾“ä¸¤æ¬¡æ•°æ®ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸Šå‡æ²¿å’Œä¸‹é™æ²¿å„ä¼ è¾“ä¸€æ¬¡æ•°æ®ï¼Œè¿™ä¸ªæ¦‚å¿µå«åšé¢„å–(prefetch)ï¼Œç›¸å½“äº DDR çš„é¢„å–ä¸º 2bitï¼Œå› æ­¤DDR çš„é€Ÿåº¦ç›´æ¥åŠ å€ï¼</p><p><a href="https://www.cnblogs.com/leaven/archive/2010/07/21/1782341.html#:~:text=1%E3%80%81%E5%B7%AE%E5%88%86%E6%97%B6%E9%92%9F%20%E5%B7%AE%E5%88%86%E6%97%B6%E9%92%9F%EF%BC%88%E5%8F%82%E8%A7%81%E4%B8%8A%E6%96%87%E2%80%9CDDR%20SDRAM%E8%AF%BB%E6%93%8D%E4%BD%9C%E6%97%B6%E5%BA%8F%E5%9B%BE%E2%80%9D%EF%BC%89%E6%98%AFDDR%E7%9A%84%E4%B8%80%E4%B8%AA%E5%BF%85%E8%A6%81%E8%AE%BE%E8%AE%A1%EF%BC%8C%E4%BD%86,CK%23%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%8C%E5%B9%B6%E4%B8%8D%E8%83%BD%E7%90%86%E8%A7%A3%E4%B8%BA%E7%AC%AC%E4%BA%8C%E4%B8%AA%E8%A7%A6%E5%8F%91%E6%97%B6%E9%92%9F%20%EF%BC%88%E4%BD%A0%E5%8F%AF%E4%BB%A5%E5%9C%A8%E8%AE%B2%E8%BF%B0DDR%E5%8E%9F%E7%90%86%E6%97%B6%E7%AE%80%E5%8D%95%E5%9C%B0%E8%BF%99%E4%B9%88%E6%AF%94%E5%96%BB%EF%BC%89%EF%BC%8C%E8%80%8C%E6%98%AF%E8%B5%B7%E5%88%B0%20%E8%A7%A6%E5%8F%91%E6%97%B6%E9%92%9F%E6%A0%A1%E5%87%86%20%E7%9A%84%E4%BD%9C%E7%94%A8%E3%80%82">DDR DQS ï¼ˆDouble Data Rate SDRAM ï¼‰ åŸç†åŠä¸SDRAMæ¯”è¾ƒ(cnblogs.com)</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6uçš„ä¸²å£é€šä¿¡</title>
      <link href="/2023/02/28/2023-2-28-imx6u%E7%9A%84%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1/"/>
      <url>/2023/02/28/2023-2-28-imx6u%E7%9A%84%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<p><strong>UART é€šä¿¡æ ¼å¼</strong></p><p>ä¸²å£å…¨ç§°å«åšä¸²è¡Œæ¥å£ï¼Œé€šå¸¸ä¹Ÿå«åš COM æ¥å£ï¼Œä¸²è¡Œæ¥å£æŒ‡çš„æ˜¯æ•°æ®ä¸€ä¸ªä¸€ä¸ªçš„é¡ºåºä¼ è¾“ï¼Œé€šä¿¡çº¿è·¯ç®€å•ã€‚ä½¿ç”¨ä¸¤æ¡çº¿å³å¯å®ç°åŒå‘é€šä¿¡ï¼Œä¸€æ¡ç”¨äºå‘é€ï¼Œä¸€æ¡ç”¨äºæ¥æ”¶ã€‚ä¸²å£é€šä¿¡è·ç¦»è¿œï¼Œä½†æ˜¯é€Ÿåº¦ç›¸å¯¹ä¼šä½ï¼Œä¸²å£æ˜¯ä¸€ç§å¾ˆå¸¸ç”¨çš„å·¥ä¸šæ¥å£ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230227_203724.png"></p><p>ç©ºé—²ä½ï¼šæ•°æ®çº¿åœ¨ç©ºé—²çŠ¶æ€çš„æ—¶å€™ä¸ºé€»è¾‘â€œ1â€çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯é«˜ç”µå¹³ï¼Œè¡¨ç¤ºæ²¡æœ‰æ•°æ®çº¿ç©ºé—²ï¼Œæ²¡æœ‰æ•°æ®ä¼ è¾“ã€‚<br>èµ·å§‹ä½ï¼šå½“è¦ä¼ è¾“æ•°æ®çš„æ—¶å€™å…ˆä¼ è¾“ä¸€ä¸ªé€»è¾‘â€œ0â€ï¼Œä¹Ÿå°±æ˜¯å°†æ•°æ®çº¿æ‹‰ä½ï¼Œè¡¨ç¤ºå¼€å§‹æ•°æ®ä¼ è¾“ã€‚<br>æ•°æ®ä½ï¼šæ•°æ®ä½å°±æ˜¯å®é™…è¦ä¼ è¾“çš„æ•°æ®ï¼Œæ•°æ®ä½æ•°å¯é€‰æ‹© 5~8 ä½ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯æŒ‰ç…§å­—èŠ‚ä¼ è¾“æ•°æ®çš„ï¼Œä¸€ä¸ªå­—èŠ‚ 8 ä½ï¼Œå› æ­¤æ•°æ®ä½é€šå¸¸æ˜¯ 8 ä½çš„ã€‚ä½ä½åœ¨å‰ï¼Œå…ˆä¼ è¾“ï¼Œé«˜ä½æœ€åä¼ è¾“ã€‚<br>å¥‡å¶æ ¡éªŒä½ï¼šè¿™æ˜¯å¯¹æ•°æ®ä¸­â€œ1â€çš„ä½æ•°è¿›è¡Œå¥‡å¶æ ¡éªŒç”¨çš„ï¼Œå¯ä»¥ä¸ä½¿ç”¨å¥‡å¶æ ¡éªŒåŠŸèƒ½ã€‚<br>åœæ­¢ä½ï¼šæ•°æ®ä¼ è¾“å®Œæˆæ ‡å¿—ä½ï¼Œåœæ­¢ä½çš„ä½æ•°å¯ä»¥é€‰æ‹© 1 ä½ã€1.5 ä½æˆ– 2 ä½é«˜ç”µå¹³ï¼Œä¸€èˆ¬éƒ½é€‰æ‹© 1 ä½åœæ­¢ä½ã€‚<br>æ³¢ç‰¹ç‡ï¼šæ³¢ç‰¹ç‡å°±æ˜¯ UART æ•°æ®ä¼ è¾“çš„é€Ÿç‡ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’ä¼ è¾“çš„æ•°æ®ä½æ•°ï¼Œä¸€èˆ¬é€‰æ‹© 9600ã€19200ã€115200 ç­‰ã€‚</p><p>UART ä¸€èˆ¬çš„æ¥å£ç”µå¹³æœ‰ TTL å’Œ RS-232ï¼Œä¸€èˆ¬å¼€å‘æ¿ä¸Šéƒ½æœ‰ TXD å’Œ RXD è¿™æ ·çš„å¼•è„šï¼Œè¿™äº›å¼•è„šä½ç”µå¹³è¡¨ç¤ºé€»è¾‘ 0ï¼Œé«˜ç”µå¹³è¡¨ç¤ºé€»è¾‘ 1ï¼Œè¿™ä¸ªå°±æ˜¯ TTL ç”µå¹³ã€‚RS-232 é‡‡ç”¨å·®åˆ†çº¿ï¼Œ-3<del>-15V è¡¨ç¤ºé€»è¾‘ 1ï¼Œ+3</del>+15V è¡¨ç¤ºé€»è¾‘ 0ã€‚</p><p>I.MX6U ä¸€å…±æœ‰ 8 ä¸ª UARTï¼Œå…¶ä¸»è¦ç‰¹æ€§å¦‚ä¸‹ï¼š<br>â‘ ã€å…¼å®¹ TIA&#x2F;EIA-232F æ ‡å‡†ï¼Œé€Ÿåº¦æœ€é«˜å¯åˆ° 5Mbit&#x2F;Sã€‚<br>â‘¡ã€æ”¯æŒä¸²è¡Œ IR æ¥å£ï¼Œå…¼å®¹ IrDAï¼Œæœ€é«˜å¯åˆ° 115.2Kbit&#x2F;sã€‚<br>â‘¢ã€æ”¯æŒ 9 ä½æˆ–è€…å¤šèŠ‚ç‚¹æ¨¡å¼(RS-485)ã€‚<br>â‘£ã€1 æˆ– 2 ä½åœæ­¢ä½ã€‚<br>â‘¤ã€å¯ç¼–ç¨‹çš„å¥‡å¶æ ¡éªŒ(å¥‡æ ¡éªŒå’Œå¶æ ¡éªŒ)ã€‚<br>â‘¥ã€è‡ªåŠ¨æ³¢ç‰¹ç‡æ£€æµ‹(æœ€é«˜æ”¯æŒ 115.2Kbit&#x2F;S)ã€‚</p><p>UCR1å¯„å­˜å™¨</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20122716.png"></p><p>ADBR(bit14)ï¼šè‡ªåŠ¨æ³¢ç‰¹ç‡æ£€æµ‹ä½¿èƒ½ä½ï¼Œä¸º 0 çš„æ—¶å€™å…³é—­è‡ªåŠ¨æ³¢ç‰¹ç‡æ£€æµ‹ï¼Œä¸º 1 çš„æ—¶å€™ä½¿èƒ½è‡ªåŠ¨æ³¢ç‰¹ç‡æ£€æµ‹ã€‚<br>UARTEN(bit0)ï¼šUART ä½¿èƒ½ä½ï¼Œä¸º 0 çš„æ—¶å€™å…³é—­ UARTï¼Œä¸º 1 çš„æ—¶å€™ä½¿èƒ½ UARTã€‚</p><p>UCR2å¯„å­˜å™¨</p><p><img src="C:\Users\hanfeng\AppData\Roaming\Typora\typora-user-images\1678081179783.png" alt="1678081179783"></p><p>IRTS(bit14)ï¼šä¸º 0 çš„æ—¶å€™ä½¿ç”¨ RTS å¼•è„šåŠŸèƒ½ï¼Œä¸º 1 çš„æ—¶å€™å¿½ç•¥ RTS å¼•è„šã€‚<br>PREN(bit8)ï¼šå¥‡å¶æ ¡éªŒä½¿èƒ½ä½ï¼Œä¸º 0 çš„æ—¶å€™å…³é—­å¥‡å¶æ ¡éªŒï¼Œä¸º 1 çš„æ—¶å€™ä½¿èƒ½å¥‡å¶æ ¡éªŒã€‚<br>PROE(bit7)ï¼šå¥‡å¶æ ¡éªŒæ¨¡å¼é€‰æ‹©ä½ï¼Œå¼€å¯å¥‡å¶æ ¡éªŒä»¥åæ­¤ä½å¦‚æœä¸º 0 çš„è¯å°±ä½¿ç”¨å¶æ ¡éªŒï¼Œæ­¤ä½ä¸º 1 çš„è¯å°±ä½¿èƒ½å¥‡æ ¡éªŒã€‚<br>STOP(bit6)ï¼šåœæ­¢ä½æ•°é‡ï¼Œä¸º 0 çš„è¯ 1 ä½åœæ­¢ä½ï¼Œä¸º 1 çš„è¯ 2 ä½åœæ­¢ä½ã€‚<br>WS(bit5)ï¼šæ•°æ®ä½é•¿åº¦ï¼Œä¸º 0 çš„æ—¶å€™é€‰æ‹© 7 ä½æ•°æ®ä½ï¼Œä¸º 1 çš„æ—¶å€™é€‰æ‹© 8 ä½æ•°æ®ä½ã€‚<br>TXEN(bit2)ï¼šå‘é€ä½¿èƒ½ä½ï¼Œä¸º 0 çš„æ—¶å€™å…³é—­ UART çš„å‘é€åŠŸèƒ½ï¼Œä¸º 1 çš„æ—¶å€™æ‰“å¼€ UARTçš„å‘é€åŠŸèƒ½ã€‚<br>RXEN(bit1)ï¼šæ¥æ”¶ä½¿èƒ½ä½ï¼Œä¸º 0 çš„æ—¶å€™å…³é—­ UART çš„æ¥æ”¶åŠŸèƒ½ï¼Œä¸º 1 çš„æ—¶å€™æ‰“å¼€ UARTçš„æ¥æ”¶åŠŸèƒ½ã€‚<br>SRST(bit0)ï¼šè½¯ä»¶å¤ä½ï¼Œä¸º 0 çš„æ˜¯æ—¶å€™è½¯ä»¶å¤ä½ UARTï¼Œä¸º 1 çš„æ—¶å€™è¡¨ç¤ºå¤ä½å®Œæˆã€‚å¤ä½å®Œæˆä»¥åæ­¤ä½ä¼šè‡ªåŠ¨ç½® 1ï¼Œè¡¨ç¤ºå¤ä½å®Œæˆã€‚æ­¤ä½åªèƒ½å†™ 0ï¼Œå†™ 1 ä¼šè¢«å¿½ç•¥æ‰ã€‚</p><p>UCR3å¯„å­˜å™¨</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/20230306134052.png"></p><p>UARTx_UCR3 ä¸­çš„ä½ RXDMUXSEL(bit2)ï¼Œè¿™ä¸ªä½åº”è¯¥å§‹ç»ˆä¸º 1ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å¯„å­˜å™¨ UARTx_UFCR ã€ UARTx_UBIR å’Œ UARTx_UBMR ï¼Œå¯„å­˜å™¨UARTx_UFCR ä¸­æˆ‘ä»¬è¦ç”¨åˆ°çš„æ˜¯ä½ RFDIV(bit9:7)ï¼Œç”¨æ¥è®¾ç½®å‚è€ƒæ—¶é’Ÿåˆ†é¢‘</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20134323.png"></p><p>æ³¢ç‰¹ç‡æ˜¯</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-06%20134333.png"></p><p>Ref Freqï¼šç»è¿‡åˆ†é¢‘ä»¥åè¿›å…¥ UART çš„æœ€ç»ˆæ—¶é’Ÿé¢‘ç‡ã€‚<br>UBMRï¼šå¯„å­˜å™¨ UARTx_UBMR ä¸­çš„å€¼ã€‚<br>UBIRï¼šå¯„å­˜å™¨ UARTx_UBIR ä¸­çš„å€¼ã€‚</p><h3 id="Uart1çš„é…ç½®æ­¥éª¤"><a href="#Uart1çš„é…ç½®æ­¥éª¤" class="headerlink" title="Uart1çš„é…ç½®æ­¥éª¤"></a>Uart1çš„é…ç½®æ­¥éª¤</h3><p>UART1 çš„é…ç½®æ­¥éª¤å¦‚ä¸‹ï¼š<br>1ã€è®¾ç½® UART1 çš„æ—¶é’Ÿæº<br>è®¾ç½® UART çš„æ—¶é’Ÿæºä¸º pll3_80mï¼Œè®¾ç½®å¯„å­˜å™¨ CCM_CSCDR1 çš„ UART_CLK_SEL ä½ä¸º 0å³å¯ã€‚<br>2ã€åˆå§‹åŒ– UART1<br>åˆå§‹åŒ– UART1 æ‰€ä½¿ç”¨ IOï¼Œè®¾ç½® UART1 çš„å¯„å­˜å™¨ UART1_UCR1~UART1_UCR3ï¼Œè®¾ç½®å†…å®¹åŒ…æ‹¬æ³¢ç‰¹ç‡ï¼Œå¥‡å¶æ ¡éªŒã€åœæ­¢ä½ã€æ•°æ®ä½ç­‰ç­‰ã€‚<br>4ã€ä½¿èƒ½ UART1<br>UART1 åˆå§‹åŒ–å®Œæˆä»¥åå°±å¯ä»¥ä½¿èƒ½ UART1 äº†ï¼Œè®¾ç½®å¯„å­˜å™¨ UART1_UCR1 çš„ä½ UARTENä¸º 1ã€‚<br>5ã€ç¼–å†™ UART1 æ•°æ®æ”¶å‘å‡½æ•°<br>ç¼–å†™ä¸¤ä¸ªå‡½æ•°ç”¨äº UART1 çš„æ•°æ®æ”¶å‘æ“ä½œã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6uçš„EPITå®šæ—¶å™¨</title>
      <link href="/2023/02/27/2023-2-27-imx6u%E7%9A%84EPIT%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
      <url>/2023/02/27/2023-2-27-imx6u%E7%9A%84EPIT%E5%AE%9A%E6%97%B6%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="EPIT"><a href="#EPIT" class="headerlink" title="EPIT"></a>EPIT</h3><p>EPITçš„å…¨ç§°æ˜¯ï¼šEnhanced Periodic Interrupt Timerï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯å¢å¼ºçš„å‘¨æœŸä¸­æ–­å®šæ—¶å™¨ï¼Œå®ƒä¸»è¦æ˜¯å®Œæˆå‘¨æœŸæ€§ä¸­æ–­å®šæ—¶çš„ã€‚</p><p>EPIT æ˜¯ä¸€ä¸ª 32 ä½å®šæ—¶å™¨ï¼Œåœ¨å¤„ç†å™¨å‡ ä¹ä¸ç”¨ä»‹å…¥çš„æƒ…å†µä¸‹æä¾›ç²¾å‡†çš„å®šæ—¶ä¸­æ–­ï¼Œè½¯ä»¶ä½¿èƒ½ä»¥å EPIT å°±ä¼šå¼€å§‹è¿è¡Œï¼ŒEPIT å®šæ—¶å™¨æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><p>â‘ ã€æ—¶é’Ÿæºå¯é€‰çš„ 32 ä½å‘ä¸‹è®¡æ•°å™¨ã€‚<br>â‘¡ã€12 ä½çš„åˆ†é¢‘å€¼ã€‚<br>â‘¢ã€å½“è®¡æ•°å€¼å’Œæ¯”è¾ƒå€¼ç›¸ç­‰çš„æ—¶å€™äº§ç”Ÿä¸­æ–­ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230227_193455.png"></p><p>â‘ ã€è¿™æ˜¯ä¸ªå¤šè·¯é€‰æ‹©å™¨ï¼Œç”¨æ¥é€‰æ‹© EPIT å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼ŒEPIT å…±æœ‰ 3 ä¸ªæ—¶é’Ÿæºå¯é€‰æ‹©ï¼Œipg_clkã€ipg_clk_32k å’Œ ipg_clk_highfreqã€‚<br>â‘¡ã€è¿™æ˜¯ä¸€ä¸ª 12 ä½çš„åˆ†é¢‘å™¨ï¼Œè´Ÿè´£å¯¹æ—¶é’Ÿæºè¿›è¡Œåˆ†é¢‘ï¼Œ12 ä½å¯¹åº”çš„å€¼æ˜¯ 0<del>4095ï¼Œå¯¹åº”ç€1</del>4096 åˆ†é¢‘ã€‚<br>â‘¢ã€ç»è¿‡åˆ†é¢‘çš„æ—¶é’Ÿè¿›å…¥åˆ° EPIT å†…éƒ¨ï¼Œåœ¨ EPIT å†…éƒ¨æœ‰ä¸‰ä¸ªé‡è¦çš„å¯„å­˜å™¨ï¼šè®¡æ•°å¯„å­˜å™¨(EPIT_CNR)ã€åŠ è½½å¯„å­˜å™¨(EPIT_LR)å’Œæ¯”è¾ƒå¯„å­˜å™¨(EPIT_CMPR)ï¼Œè¿™ä¸‰ä¸ªå¯„å­˜å™¨éƒ½æ˜¯ 32 ä½çš„ã€‚EPIT æ˜¯ä¸€ä¸ªå‘ä¸‹è®¡æ•°å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ç»™å®ƒä¸€ä¸ªåˆå€¼ï¼Œå®ƒå°±ä¼šä»è¿™ä¸ªç»™å®šçš„åˆå€¼å¼€å§‹é€’å‡ï¼Œç›´åˆ°å‡ä¸º 0ï¼Œè®¡æ•°å¯„å­˜å™¨é‡Œé¢ä¿å­˜çš„å°±æ˜¯å½“å‰çš„è®¡æ•°å€¼ã€‚å¦‚æœ EPIT å·¥ä½œåœ¨ set-and-forget æ¨¡å¼ä¸‹ï¼Œå½“è®¡æ•°å¯„å­˜å™¨é‡Œé¢çš„å€¼å‡å°‘åˆ° 0ï¼ŒEPIT å°±ä¼šé‡æ–°ä»åŠ è½½å¯„å­˜å™¨è¯»å–æ•°å€¼åˆ°è®¡æ•°å¯„å­˜å™¨é‡Œé¢ï¼Œé‡æ–°å¼€å§‹å‘ä¸‹è®¡æ•°ã€‚æ¯”è¾ƒå¯„å­˜å™¨é‡Œé¢ä¿å­˜çš„æ•°å€¼ç”¨äºå’Œè®¡æ•°å¯„å­˜å™¨é‡Œé¢çš„è®¡æ•°å€¼æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰çš„è¯å°±ä¼šäº§ç”Ÿä¸€ä¸ªæ¯”è¾ƒäº‹ä»¶ã€‚<br>â‘£ã€æ¯”è¾ƒå™¨ã€‚<br>â‘¤ã€EPIT å¯ä»¥è®¾ç½®å¼•è„šè¾“å‡ºï¼Œå¦‚æœè®¾ç½®äº†çš„è¯å°±ä¼šé€šè¿‡æŒ‡å®šçš„å¼•è„šè¾“å‡ºä¿¡å·ã€‚<br>â‘¥ã€äº§ç”Ÿæ¯”è¾ƒä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯å®šæ—¶ä¸­æ–­ã€‚</p><p>EPIT å®šæ—¶å™¨æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼šset-and-forget å’Œ free-runningï¼Œè¿™ä¸¤ä¸ªå·¥ä½œæ¨¡å¼çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><p>set-and-forget æ¨¡å¼ï¼šEPITx_CR(x&#x3D;1ï¼Œ2)å¯„å­˜å™¨çš„ RLD ä½ç½® 1 çš„æ—¶å€™ EPIT å·¥ä½œåœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œåœ¨æ­¤æ¨¡å¼ä¸‹ EPIT çš„è®¡æ•°å™¨ä»åŠ è½½å¯„å­˜å™¨ EPITx_LR ä¸­è·å–åˆå§‹å€¼ï¼Œä¸èƒ½ç›´æ¥å‘è®¡æ•°å™¨å¯„å­˜å™¨å†™å…¥æ•°æ®ã€‚ä¸ç®¡ä»€ä¹ˆæ—¶å€™ï¼Œåªè¦è®¡æ•°å™¨è®¡æ•°åˆ° 0ï¼Œé‚£ä¹ˆå°±ä¼šä»åŠ è½½å¯„å­˜å™¨ EPITx_LR ä¸­é‡æ–°åŠ è½½æ•°æ®åˆ°è®¡æ•°å™¨ä¸­ï¼Œå‘¨è€Œå¤å§‹ã€‚<br>free-running æ¨¡å¼ï¼šEPITx_CR å¯„å­˜å™¨çš„ RLD ä½æ¸…é›¶çš„æ—¶å€™ EPIT å·¥ä½œåœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå½“è®¡æ•°å™¨è®¡æ•°åˆ°0ä»¥åä¼šé‡æ–°ä»0XFFFFFFFFå¼€å§‹è®¡æ•°ï¼Œå¹¶ä¸æ˜¯ä»åŠ è½½å¯„å­˜å™¨EPITx_LRä¸­è·å–æ•°æ®ã€‚</p><p>ä¸‰ä¸ªå¯„å­˜å™¨çš„å…·ä½“é…ç½®æŸ¥è¯¢æ‰‹å†Œã€‚</p><h3 id="EPIT-çš„é…ç½®æ­¥éª¤å¦‚ä¸‹ï¼š"><a href="#EPIT-çš„é…ç½®æ­¥éª¤å¦‚ä¸‹ï¼š" class="headerlink" title="EPIT çš„é…ç½®æ­¥éª¤å¦‚ä¸‹ï¼š"></a><strong>EPIT çš„é…ç½®æ­¥éª¤å¦‚ä¸‹ï¼š</strong></h3><p><strong>1ã€è®¾ç½® EPIT1 çš„æ—¶é’Ÿæº</strong><br>è®¾ç½®å¯„å­˜å™¨ EPIT1_CR å¯„å­˜å™¨çš„ CLKSRC(bit25:24)ä½ï¼Œé€‰æ‹© EPIT1 çš„æ—¶é’Ÿæºã€‚<br><strong>2ã€è®¾ç½®åˆ†é¢‘å€¼</strong><br>è®¾ç½®å¯„å­˜å™¨ EPIT1_CR å¯„å­˜å™¨çš„ PRESCALAR(bit15:4)ä½ï¼Œè®¾ç½®åˆ†é¢‘å€¼ã€‚<br><strong>3ã€è®¾ç½®å·¥ä½œæ¨¡å¼</strong><br>è®¾ç½®å¯„å­˜å™¨ EPIT1_CR çš„ RLD(bit3)ä½ï¼Œè®¾ç½® EPTI1 çš„å·¥ä½œæ¨¡å¼ã€‚<br><strong>4ã€è®¾ç½®è®¡æ•°å™¨çš„åˆå§‹å€¼æ¥æº</strong><br>è®¾ç½®å¯„å­˜å™¨ EPIT1_CR çš„ ENMOD(bit1)ä½ï¼Œè®¾ç½®è®¡æ•°å™¨çš„åˆå§‹å€¼æ¥æºã€‚<br><strong>5ã€ä½¿èƒ½æ¯”è¾ƒä¸­æ–­</strong><br>ä½¿ç”¨å°±è®¾ç½®å¯„å­˜å™¨ EPIT1_CR çš„ OCIEN(bit2)ä½ï¼Œä½¿èƒ½æ¯”è¾ƒä¸­æ–­ã€‚<br><strong>6ã€è®¾ç½®åŠ è½½å€¼å’Œæ¯”è¾ƒå€¼</strong><br>è®¾ç½®å¯„å­˜å™¨ EPIT1_LR ä¸­çš„åŠ è½½å€¼å’Œå¯„å­˜å™¨ EPIT1_CMPR ä¸­çš„æ¯”è¾ƒå€¼ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå¯„å­˜å™¨å°±å¯ä»¥å†³å®šå®šæ—¶å™¨çš„ä¸­æ–­å‘¨æœŸã€‚<br><strong>7ã€EPIT1 ä¸­æ–­è®¾ç½®å’Œä¸­æ–­æœåŠ¡å‡½æ•°ç¼–å†™</strong><br>ä½¿èƒ½ GIC ä¸­å¯¹åº”çš„ EPIT1 ä¸­æ–­ï¼Œæ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œå¦‚æœéœ€è¦çš„è¯è¿˜å¯ä»¥è®¾ç½®ä¸­æ–­ä¼˜å…ˆçº§ã€‚æœ€åç¼–å†™ä¸­æ–­æœåŠ¡å‡½æ•°ã€‚<br><strong>8ã€ä½¿èƒ½ EPIT1 å®šæ—¶å™¨</strong><br>é…ç½®å¥½ EPIT1 ä»¥åå°±å¯ä»¥ä½¿èƒ½ EPIT1 äº†ï¼Œé€šè¿‡å¯„å­˜å™¨ EPIT1_CR çš„ EN(bit0)ä½æ¥è®¾ç½®ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6uçš„GPIOä¸­æ–­</title>
      <link href="/2023/02/22/2023-2-16-imx6u%E7%9A%84GPIO%E4%B8%AD%E6%96%AD/"/>
      <url>/2023/02/22/2023-2-16-imx6u%E7%9A%84GPIO%E4%B8%AD%E6%96%AD/</url>
      
        <content type="html"><![CDATA[<h3 id="ä¸­æ–­è¿‡ç¨‹"><a href="#ä¸­æ–­è¿‡ç¨‹" class="headerlink" title="ä¸­æ–­è¿‡ç¨‹"></a>ä¸­æ–­è¿‡ç¨‹</h3><p>STM32 çš„ä¸­æ–­ç³»ç»Ÿä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š<br>â‘ ã€ä¸­æ–­å‘é‡è¡¨ã€‚<br>â‘¡ã€NVIC(å†…åµŒå‘é‡ä¸­æ–­æ§åˆ¶å™¨)ã€‚<br>â‘¢ã€ä¸­æ–­ä½¿èƒ½ã€‚<br>â‘£ã€ä¸­æ–­æœåŠ¡å‡½æ•°</p><p>è€Œåœ¨imx6ulä¸­çš„NVICä¸­æ–­ç®¡ç†æœºæ„å«åšGICã€‚</p><p>ä¸­æ–­æœåŠ¡ç¨‹åºçš„å…¥å£åœ°å€æˆ–å­˜æ”¾ä¸­æ–­æœåŠ¡ç¨‹åºçš„é¦–åœ°å€æˆä¸ºä¸­æ–­å‘é‡ï¼Œå› æ­¤ä¸­æ–­å‘é‡è¡¨æ˜¯ä¸€ç³»åˆ—ä¸­æ–­æœåŠ¡ç¨‹åºå…¥å£åœ°å€ç»„æˆçš„è¡¨ã€‚</p><h3 id="Cortex-A7ä¸­æ–­ç³»ç»Ÿç®€ä»‹"><a href="#Cortex-A7ä¸­æ–­ç³»ç»Ÿç®€ä»‹" class="headerlink" title="Cortex-A7ä¸­æ–­ç³»ç»Ÿç®€ä»‹"></a>Cortex-A7ä¸­æ–­ç³»ç»Ÿç®€ä»‹</h3><p>è·Ÿ STM32 ä¸€æ ·ï¼ŒCortex-A7 ä¹Ÿæœ‰ä¸­æ–­å‘é‡è¡¨ï¼Œä¸­æ–­å‘é‡è¡¨ä¹Ÿæ˜¯åœ¨ä»£ç çš„æœ€å‰é¢ã€‚CortexA7 å†…æ ¸æœ‰ 8 ä¸ªå¼‚å¸¸ä¸­æ–­ï¼Œè¿™ 8 ä¸ªå¼‚å¸¸ä¸­æ–­çš„ä¸­æ–­å‘é‡è¡¨å¦‚è¡¨ ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230219_211414.png"></p><p>â‘ ã€å¤ä½ä¸­æ–­(Rest)ï¼ŒCPU å¤ä½ä»¥åå°±ä¼šè¿›å…¥å¤ä½ä¸­æ–­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤ä½ä¸­æ–­æœåŠ¡å‡½æ•°é‡Œé¢åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œæ¯”å¦‚åˆå§‹åŒ– SP æŒ‡é’ˆã€DDR ç­‰ç­‰ã€‚<br>â‘¡ã€æœªå®šä¹‰æŒ‡ä»¤ä¸­æ–­(Undefined Instruction)ï¼Œå¦‚æœæŒ‡ä»¤ä¸èƒ½è¯†åˆ«çš„è¯å°±ä¼šäº§ç”Ÿæ­¤ä¸­æ–­ã€‚<br>â‘¢ã€è½¯ä¸­æ–­(Software Interrupt,SWI)ï¼Œç”± SWI æŒ‡ä»¤å¼•èµ·çš„ä¸­æ–­ï¼ŒLinux çš„ç³»ç»Ÿè°ƒç”¨ä¼šç”¨ SWIæŒ‡ä»¤æ¥å¼•èµ·è½¯ä¸­æ–­ï¼Œé€šè¿‡è½¯ä¸­æ–­æ¥é™·å…¥åˆ°å†…æ ¸ç©ºé—´ã€‚<br>â‘£ã€æŒ‡ä»¤é¢„å–ä¸­æ­¢ä¸­æ–­(Prefetch Abort)ï¼Œé¢„å–æŒ‡ä»¤çš„å‡ºé”™çš„æ—¶å€™ä¼šäº§ç”Ÿæ­¤ä¸­æ–­ã€‚<br>â‘¤ã€æ•°æ®è®¿é—®ä¸­æ­¢ä¸­æ–­(Data Abort)ï¼Œè®¿é—®æ•°æ®å‡ºé”™çš„æ—¶å€™ä¼šäº§ç”Ÿæ­¤ä¸­æ–­ã€‚<br>â‘¥ã€IRQ ä¸­æ–­(IRQ Interrupt)ï¼Œå¤–éƒ¨ä¸­æ–­ï¼Œå‰é¢å·²ç»è¯´äº†ï¼ŒèŠ¯ç‰‡å†…éƒ¨çš„å¤–è®¾ä¸­æ–­éƒ½ä¼šå¼•èµ·æ­¤ä¸­æ–­çš„å‘ç”Ÿã€‚<br>â‘¦ã€FIQ ä¸­æ–­(FIQ Interrupt)ï¼Œå¿«é€Ÿä¸­æ–­ï¼Œå¦‚æœéœ€è¦å¿«é€Ÿå¤„ç†ä¸­æ–­çš„è¯å°±å¯ä»¥ä½¿ç”¨æ­¤ä¸­æ–­ã€‚</p><p>ä¸­æ–­å‘é‡è¡¨ä¸€èˆ¬å†™åœ¨start.Sçš„å‰é¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">ç¤ºä¾‹ä»£ç  17.1.1.1 Cortex-A å‘é‡è¡¨æ¨¡æ¿</span><br><span class="line">1 .global _start /* å…¨å±€æ ‡å· */</span><br><span class="line">2 </span><br><span class="line">3 _start:</span><br><span class="line">4 ldr pc, =Reset_Handler /* å¤ä½ä¸­æ–­ */ </span><br><span class="line">5 ldr pc, =Undefined_Handler /* æœªå®šä¹‰æŒ‡ä»¤ä¸­æ–­ */</span><br><span class="line">6 ldr pc, =SVC_Handler /* SVC(Supervisor)ä¸­æ–­ */</span><br><span class="line">7 ldr pc, =PrefAbort_Handler /* é¢„å–ç»ˆæ­¢ä¸­æ–­ */</span><br><span class="line">8 ldr pc, =DataAbort_Handler /* æ•°æ®ç»ˆæ­¢ä¸­æ–­ */</span><br><span class="line">9 ldr pc, =NotUsed_Handler /* æœªä½¿ç”¨ä¸­æ–­ */</span><br><span class="line">10 ldr pc, =IRQ_Handler /* IRQ ä¸­æ–­ */</span><br><span class="line">11 ldr pc, =FIQ_Handler /* FIQ(å¿«é€Ÿä¸­æ–­)æœªå®šä¹‰ä¸­æ–­ */</span><br><span class="line">12</span><br><span class="line">13 /* å¤ä½ä¸­æ–­ */ </span><br><span class="line">14 Reset_Handler:</span><br><span class="line">15 /* å¤ä½ä¸­æ–­å…·ä½“å¤„ç†è¿‡ç¨‹ */</span><br><span class="line">16</span><br><span class="line">17 /* æœªå®šä¹‰ä¸­æ–­ */</span><br><span class="line">18 Undefined_Handler:</span><br><span class="line">19 ldr r0, =Undefined_Handler</span><br><span class="line">20 bx r0</span><br><span class="line">21</span><br><span class="line">22 /* SVC ä¸­æ–­ */</span><br><span class="line">23 SVC_Handler:</span><br><span class="line">24 ldr r0, =SVC_Handler</span><br><span class="line">25 bx r0</span><br><span class="line">26</span><br><span class="line">27 /* é¢„å–ç»ˆæ­¢ä¸­æ–­ */</span><br><span class="line">28 PrefAbort_Handler:</span><br><span class="line">29 ldr r0, =PrefAbort_Handler </span><br><span class="line">30 bx r0</span><br><span class="line">31</span><br><span class="line">32 /* æ•°æ®ç»ˆæ­¢ä¸­æ–­ */</span><br><span class="line">33 DataAbort_Handler:</span><br><span class="line">34 ldr r0, =DataAbort_Handler</span><br><span class="line">35 bx r0</span><br><span class="line">36</span><br><span class="line">37 /* æœªä½¿ç”¨çš„ä¸­æ–­ */</span><br><span class="line">38 NotUsed_Handler:</span><br><span class="line">39</span><br><span class="line">40 ldr r0, =NotUsed_Handler</span><br><span class="line">41 bx r0</span><br><span class="line">42</span><br><span class="line">43 /* IRQ ä¸­æ–­ï¼é‡ç‚¹ï¼ï¼ï¼ï¼ï¼ */</span><br><span class="line">44 IRQ_Handler:</span><br><span class="line">45 /* å¤ä½ä¸­æ–­å…·ä½“å¤„ç†è¿‡ç¨‹ */</span><br><span class="line">46 </span><br><span class="line">47 /* FIQ ä¸­æ–­ */</span><br><span class="line">48 FIQ_Handler:</span><br><span class="line">49 ldr r0, =FIQ_Handler </span><br><span class="line">50 bx r0 </span><br></pre></td></tr></table></figure><h4 id="GICæ§åˆ¶å™¨"><a href="#GICæ§åˆ¶å™¨" class="headerlink" title="GICæ§åˆ¶å™¨"></a>GICæ§åˆ¶å™¨</h4><p>ARM é’ˆå¯¹ GIC V2 å°±å¼€å‘å‡ºäº† GIC400 è¿™ä¸ªä¸­æ–­æ§åˆ¶å™¨ IP æ ¸ã€‚å½“ GIC æ¥æ”¶åˆ°å¤–éƒ¨ä¸­æ–­ä¿¡å·ä»¥åå°±ä¼šæŠ¥ç»™ ARM å†…æ ¸ï¼Œä½†æ˜¯ARM å†…æ ¸åªæä¾›äº†å››ä¸ªä¿¡å·ç»™ GIC æ¥æ±‡æŠ¥ä¸­æ–­æƒ…å†µï¼šVFIQã€VIRQã€FIQ å’Œ IRQã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230219_212349.png"></p><p><strong>VFIQ:è™šæ‹Ÿå¿«é€Ÿ FIQã€‚</strong><br><strong>VIRQ:è™šæ‹Ÿå¤–éƒ¨ IRQã€‚</strong><br><strong>FIQ:å¿«é€Ÿä¸­æ–­ IRQã€‚</strong><br><strong>IRQ:å¤–éƒ¨ä¸­æ–­ IRQã€‚</strong>ï¼ˆGPIOä¸­æ–­å±äºIRQå¤–éƒ¨ä¸­æ–­ã€‚ï¼‰</p><p>GIC å°†ä¼—å¤šçš„ä¸­æ–­æºåˆ†ä¸ºåˆ†ä¸ºä¸‰ç±»ï¼š<br>â‘ ã€SPI(Shared Peripheral Interrupt),å…±äº«ä¸­æ–­ï¼Œé¡¾åæ€ä¹‰ï¼Œæ‰€æœ‰ Core å…±äº«çš„ä¸­æ–­ï¼Œè¿™ä¸ªæ˜¯æœ€å¸¸è§çš„ï¼Œé‚£äº›å¤–éƒ¨ä¸­æ–­éƒ½å±äº SPI ä¸­æ–­(æ³¨æ„ï¼ä¸æ˜¯ SPI æ€»çº¿é‚£ä¸ªä¸­æ–­) ã€‚æ¯”å¦‚æŒ‰é”®ä¸­æ–­ã€ä¸²å£ä¸­æ–­ç­‰ç­‰ï¼Œè¿™äº›ä¸­æ–­æ‰€æœ‰çš„ Core éƒ½å¯ä»¥å¤„ç†ï¼Œä¸é™å®šç‰¹å®š Coreã€‚<br>â‘¡ã€PPI(Private Peripheral Interrupt)ï¼Œç§æœ‰ä¸­æ–­ï¼Œæˆ‘ä»¬è¯´äº† GIC æ˜¯æ”¯æŒå¤šæ ¸çš„ï¼Œæ¯ä¸ªæ ¸è‚¯å®šæœ‰è‡ªå·±ç‹¬æœ‰çš„ä¸­æ–­ã€‚è¿™äº›ç‹¬æœ‰çš„ä¸­æ–­è‚¯å®šæ˜¯è¦æŒ‡å®šçš„æ ¸å¿ƒå¤„ç†ï¼Œå› æ­¤è¿™äº›ä¸­æ–­å°±å«åšç§æœ‰ä¸­æ–­ã€‚<br>â‘¢ã€SGI(Software-generated Interrupt)ï¼Œè½¯ä»¶ä¸­æ–­ï¼Œç”±è½¯ä»¶è§¦å‘å¼•èµ·çš„ä¸­æ–­ï¼Œé€šè¿‡å‘å¯„å­˜å™¨GICD_SGIR å†™å…¥æ•°æ®æ¥è§¦å‘ï¼Œç³»ç»Ÿä¼šä½¿ç”¨ SGI ä¸­æ–­æ¥å®Œæˆå¤šæ ¸ä¹‹é—´çš„é€šä¿¡ã€‚</p><p><strong>ä¸­æ–­æºæœ‰å¾ˆå¤šï¼Œä¸ºäº†åŒºåˆ†è¿™äº›ä¸åŒçš„ä¸­æ–­æºè‚¯å®šè¦ç»™ä»–ä»¬åˆ†é…ä¸€ä¸ªå”¯ä¸€ IDï¼Œè¿™äº› ID å°±æ˜¯ä¸­æ–­ ID</strong>ã€‚æ¯ä¸€ä¸ª CPU æœ€å¤šæ”¯æŒ 1020 ä¸ªä¸­æ–­ IDï¼Œä¸­æ–­ ID å·ä¸º ID0<del>ID1019ã€‚è¿™ 1020 ä¸ª ID åŒ…å«äº† PPIã€SPI å’Œ SGIã€‚<br>ID0</del>ID15ï¼šè¿™ 16 ä¸ª ID åˆ†é…ç»™ SGIã€‚<br>ID16<del>ID31ï¼šè¿™ 16 ä¸ª ID åˆ†é…ç»™ PPIã€‚<br>ID32</del>ID1019ï¼šè¿™ 988 ä¸ª ID åˆ†é…ç»™ SPIã€‚å…·ä½“çœ‹æ‰‹å†Œã€‚</p><p><strong>GIC æ¶æ„åˆ†ä¸ºäº†ä¸¤ä¸ªé€»è¾‘å—ï¼šDistributor å’Œ CPU Interfaceï¼Œä¹Ÿå°±æ˜¯åˆ†å‘å™¨ç«¯å’Œ CPU æ¥å£ç«¯ã€‚</strong></p><p>Distributor(åˆ†å‘å™¨ç«¯)ï¼šæ­¤é€»è¾‘å—è´Ÿè´£å¤„ç†å„ä¸ªä¸­æ–­äº‹ä»¶çš„åˆ†å‘é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ä¸­æ–­äº‹ä»¶åº”è¯¥å‘é€åˆ°å“ªä¸ª CPU Interface ä¸Šå»ã€‚åˆ†å‘å™¨æ”¶é›†æ‰€æœ‰çš„ä¸­æ–­æºï¼Œå¯ä»¥æ§åˆ¶æ¯ä¸ªä¸­æ–­çš„ä¼˜å…ˆçº§ï¼Œå®ƒæ€»æ˜¯å°†ä¼˜å…ˆçº§æœ€é«˜çš„ä¸­æ–­äº‹ä»¶å‘é€åˆ° CPU æ¥å£ç«¯ã€‚åˆ†å‘å™¨ç«¯è¦åšçš„ä¸»è¦å·¥ä½œå¦‚ä¸‹ï¼š<br>â‘ ã€å…¨å±€ä¸­æ–­ä½¿èƒ½æ§åˆ¶ã€‚<br>â‘¡ã€æ§åˆ¶æ¯ä¸€ä¸ªä¸­æ–­çš„ä½¿èƒ½æˆ–è€…å…³é—­ã€‚<br>â‘¢ã€è®¾ç½®æ¯ä¸ªä¸­æ–­çš„ä¼˜å…ˆçº§ã€‚<br>â‘£ã€è®¾ç½®æ¯ä¸ªä¸­æ–­çš„ç›®æ ‡å¤„ç†å™¨åˆ—è¡¨ã€‚<br>â‘¤ã€è®¾ç½®æ¯ä¸ªå¤–éƒ¨ä¸­æ–­çš„è§¦å‘æ¨¡å¼ï¼šç”µå¹³è§¦å‘æˆ–è¾¹æ²¿è§¦å‘ã€‚<br>â‘¥ã€è®¾ç½®æ¯ä¸ªä¸­æ–­å±äºç»„ 0 è¿˜æ˜¯ç»„ 1ã€‚</p><p>CPU Interface(CPU æ¥å£ç«¯)ï¼šCPU æ¥å£ç«¯å¬åå­—å°±çŸ¥é“æ˜¯å’Œ CPU Core ç›¸è¿æ¥çš„ï¼Œå› æ­¤åœ¨æ¯ä¸ª CPU Core éƒ½å¯ä»¥åœ¨ GIC ä¸­æ‰¾åˆ°ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ CPU Interfaceã€‚CPU æ¥å£ç«¯å°±æ˜¯åˆ†å‘å™¨å’Œ CPU Core ä¹‹é—´çš„æ¡¥æ¢ï¼ŒCPU æ¥å£ç«¯ä¸»è¦å·¥ä½œå¦‚ä¸‹ï¼š<br>â‘ ã€ä½¿èƒ½æˆ–è€…å…³é—­å‘é€åˆ° CPU Core çš„ä¸­æ–­è¯·æ±‚ä¿¡å·ã€‚<br>â‘¡ã€åº”ç­”ä¸­æ–­ã€‚<br>â‘¢ã€é€šçŸ¥ä¸­æ–­å¤„ç†å®Œæˆã€‚<br>â‘£ã€è®¾ç½®ä¼˜å…ˆçº§æ©ç ï¼Œé€šè¿‡æ©ç æ¥è®¾ç½®å“ªäº›ä¸­æ–­ä¸éœ€è¦ä¸ŠæŠ¥ç»™ CPU Coreã€‚<br>â‘¤ã€å®šä¹‰æŠ¢å ç­–ç•¥ã€‚<br>â‘¥ã€å½“å¤šä¸ªä¸­æ–­åˆ°æ¥çš„æ—¶å€™ï¼Œé€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„ä¸­æ–­é€šçŸ¥ç»™ CPU Coreã€‚</p><p><strong>CP15 åå¤„ç†å™¨</strong></p><p>CP15 åå¤„ç†å™¨ä¸€èˆ¬ç”¨äºå­˜å‚¨ç³»ç»Ÿç®¡ç†ï¼Œä½†æ˜¯åœ¨ä¸­æ–­ä¸­ä¹Ÿä¼šä½¿ç”¨åˆ°ï¼ŒCP15 åå¤„ç†å™¨ä¸€å…±æœ‰16 ä¸ª 32 ä½å¯„å­˜å™¨ã€‚</p><p>CP15 åå¤„ç†å™¨çš„è®¿é—®é€šè¿‡å¦‚ä¸‹å¦ä¸ªæŒ‡ä»¤å®Œæˆï¼š</p><p>MRC: å°† CP15 åå¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨æ•°æ®è¯»åˆ° ARM å¯„å­˜å™¨ä¸­ã€‚è¯»CP5å¯„å­˜å™¨<br>MCR: å°† ARM å¯„å­˜å™¨çš„æ•°æ®å†™å…¥åˆ° CP15 åå¤„ç†å™¨å¯„å­˜å™¨ä¸­ã€‚å†™CP15å¯„å­˜å™¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MCR&#123;cond&#125; p15, &lt;opc1&gt;, &lt;Rt&gt;, &lt;CRn&gt;, &lt;CRm&gt;, &lt;opc2&gt;</span><br><span class="line">MRC p15, 0, r0, c0, c0, 0//CP15 ä¸­ C0 å¯„å­˜å™¨çš„å€¼è¯»å–åˆ° R0 å¯„å­˜å™¨</span><br></pre></td></tr></table></figure><p>cond:æŒ‡ä»¤æ‰§è¡Œçš„æ¡ä»¶ç ï¼Œå¦‚æœå¿½ç•¥çš„è¯å°±è¡¨ç¤ºæ— æ¡ä»¶æ‰§è¡Œã€‚<br>opc1ï¼šåå¤„ç†å™¨è¦æ‰§è¡Œçš„æ“ä½œç ã€‚<br>Rtï¼šARM æºå¯„å­˜å™¨ï¼Œè¦å†™å…¥åˆ° CP15 å¯„å­˜å™¨çš„æ•°æ®å°±ä¿å­˜åœ¨æ­¤å¯„å­˜å™¨ä¸­ã€‚<br>CRnï¼šCP15 åå¤„ç†å™¨çš„ç›®æ ‡å¯„å­˜å™¨ã€‚<br>CRmï¼šåå¤„ç†å™¨ä¸­é™„åŠ çš„ç›®æ ‡å¯„å­˜å™¨æˆ–è€…æºæ“ä½œæ•°å¯„å­˜å™¨ï¼Œå¦‚æœä¸éœ€è¦é™„åŠ ä¿¡æ¯å°±å°†<br>CRm è®¾ç½®ä¸º C0ï¼Œå¦åˆ™ç»“æœä¸å¯é¢„æµ‹ã€‚<br>opc2ï¼šå¯é€‰çš„åå¤„ç†å™¨ç‰¹å®šæ“ä½œç ï¼Œå½“ä¸éœ€è¦çš„æ—¶å€™è¦è®¾ç½®ä¸º 0ã€‚</p><p>CP15 åå¤„ç†å™¨æœ‰ 16 ä¸ª 32 ä½å¯„å­˜å™¨ï¼Œc0~c15ï¼Œåœ¨ä½¿ç”¨ MRC æˆ–è€… MCR æŒ‡ä»¤è®¿é—®è¿™ 16 ä¸ª<br>å¯„å­˜å™¨çš„æ—¶å€™ï¼ŒæŒ‡ä»¤ä¸­çš„ CRnã€opc1ã€CRm å’Œ opc2 é€šè¿‡ä¸åŒçš„æ­é…ï¼Œå…¶å¾—åˆ°çš„å¯„å­˜å™¨å«ä¹‰æ˜¯<br>ä¸åŒçš„ã€‚ä¾‹å¦‚C1å¯„å­˜å™¨çš„æ­é…ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230219_220740.png"></p><h4 id="ä¸­æ–­ä½¿èƒ½"><a href="#ä¸­æ–­ä½¿èƒ½" class="headerlink" title="ä¸­æ–­ä½¿èƒ½"></a>ä¸­æ–­ä½¿èƒ½</h4><p>ä¸­æ–­ä½¿èƒ½åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ IRQ æˆ–è€… FIQ æ€»ä¸­æ–­ä½¿èƒ½ï¼Œå¦ä¸€ä¸ªå°±æ˜¯ ID0~ID1019 è¿™ 1020<br>ä¸ªä¸­æ–­æºçš„ä½¿èƒ½ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230219_221931.png"></p><p>GIC å¯„å­˜å™¨ GICD_ISENABLERn å’Œ GICD_ ICENABLERn ç”¨æ¥å®Œæˆå¤–éƒ¨ä¸­æ–­çš„ä½¿èƒ½å’Œç¦æ­¢ï¼Œå¯¹äº Cortex-A7 å†…æ ¸æ¥è¯´ä¸­æ–­ ID åªä½¿ç”¨äº† 512 ä¸ªã€‚ä¸€ä¸ª bit æ§åˆ¶ä¸€ä¸ªä¸­æ–­ ID çš„ä½¿èƒ½ï¼Œé‚£ä¹ˆå°±éœ€è¦ 512&#x2F;32&#x3D;16 ä¸ª GICD_ISENABLER å¯„å­˜å™¨æ¥å®Œæˆä¸­æ–­çš„ä½¿èƒ½ã€‚åŒç†ï¼Œä¹Ÿéœ€è¦ 16 ä¸ªGICD_ICENABLER å¯„å­˜å™¨æ¥å®Œæˆä¸­æ–­çš„ç¦æ­¢ã€‚å…¶ä¸­ GICD_ISENABLER0 çš„ bit[15:0]å¯¹åº”ID15<del>0 çš„ SGI ä¸­æ–­ï¼ŒGICD_ISENABLER0 çš„ bit[31:16]å¯¹åº” ID31</del>16 çš„ PPI ä¸­æ–­ã€‚å‰©ä¸‹çš„GICD_ISENABLER1~GICD_ISENABLER15 å°±æ˜¯æ§åˆ¶ SPI ä¸­æ–­çš„ã€‚</p><h4 id="ä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®"><a href="#ä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®" class="headerlink" title="ä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®"></a>ä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®</h4><p><strong>ä¼˜å…ˆçº§æ•°é…ç½®</strong></p><p>GIC æ§åˆ¶å™¨æœ€å¤šå¯ä»¥æ”¯æŒ 256 ä¸ªä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Cortex-A7 é€‰æ‹©äº† 32 ä¸ªä¼˜å…ˆçº§ã€‚åœ¨ä½¿ç”¨ä¸­æ–­çš„æ—¶å€™éœ€è¦åˆå§‹åŒ– GICC_PMR å¯„å­˜å™¨ï¼Œæ­¤å¯„å­˜å™¨ç”¨æ¥å†³å®šä½¿ç”¨å‡ çº§ä¼˜å…ˆçº§ã€‚I.MX6U æ˜¯ Cortex-A7å†…æ ¸ï¼Œæ‰€ä»¥æ”¯æŒ 32 ä¸ªä¼˜å…ˆçº§ï¼Œå› æ­¤ GICC_PMR è¦è®¾ç½®ä¸º 0b11111000ã€‚</p><p><strong>æŠ¢å ä¼˜å…ˆçº§å’Œå­ä¼˜å…ˆçº§ä½æ•°è®¾ç½®</strong></p><p>ä¼˜å…ˆçº§å¯„å­˜å™¨åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šæŠ¢å ä¼˜å…ˆçº§å’Œå­ä¼˜å…ˆçº§ã€‚åˆ†é…ç»™æ¯ä¸ªéƒ¨åˆ†çš„ä½æ•°æ˜¯å¯é…ç½®çš„ã€‚æŠ¢å ä¼˜å…ˆçº§å®šä¹‰äº†ä¸€ä¸ªä¸­æ–­æ˜¯å¦å¯ä»¥æŠ¢å ä¸€ä¸ªå·²ç»åœ¨æ‰§è¡Œçš„ä¸­æ–­ã€‚å½“ä¸¤ä¸ªæŠ¢å ä¼˜å…ˆçº§ç›¸åŒçš„ä¸­æ–­åŒæ—¶å‘ç”Ÿæ—¶ï¼Œå­ä¼˜å…ˆçº§å†³å®šå“ªä¸ªä¸­æ–­å°†é¦–å…ˆæ‰§è¡Œã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230219_222553.png"></p><p><strong>ä¼˜å…ˆçº§è®¾ç½®</strong></p><p>å‰é¢å·²ç»è®¾ç½®å¥½äº† I.MX6U ä¸€å…±æœ‰ 32 ä¸ªæŠ¢å ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚å…·ä½“è¦ä½¿ç”¨æŸä¸ªä¸­æ–­çš„æ—¶å€™å°±å¯ä»¥è®¾ç½®å…¶ä¼˜å…ˆçº§ä¸º 0~31ã€‚æŸä¸ªä¸­æ–­ ID çš„ä¸­æ–­ä¼˜å…ˆçº§è®¾ç½®ç”±å¯„å­˜å™¨D_IPRIORITYR æ¥å®Œæˆï¼Œå‰é¢è¯´äº† Cortex-A7 ä½¿ç”¨äº† 512 ä¸ªä¸­æ–­ IDï¼Œæ¯ä¸ªä¸­æ–­ ID é…æœ‰ä¸€ä¸ªä¼˜å…ˆçº§å¯„å­˜å™¨ï¼Œæ‰€ä»¥ä¸€å…±æœ‰ 512 ä¸ª D_IPRIORITYR å¯„å­˜å™¨ã€‚å¦‚æœä¼˜å…ˆçº§ä¸ªæ•°ä¸º 32 çš„è¯ï¼Œä½¿ç”¨å¯„å­˜å™¨ D_IPRIORITYR çš„ bit7:4 æ¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œä¹Ÿå°±æ˜¯è¯´å®é™…çš„ä¼˜å…ˆçº§è¦å·¦ç§» 3 ä½ã€‚æ¯”å¦‚è¦è®¾ç½®ID40 ä¸­æ–­çš„ä¼˜å…ˆçº§ä¸º 5ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GICD_IPRIORITYR[40] = 5 &lt;&lt; 3;</span><br></pre></td></tr></table></figure><p>æœ‰å…³ä¼˜å…ˆçº§è®¾ç½®çš„å†…å®¹å°±è®²è§£åˆ°è¿™é‡Œï¼Œä¼˜å…ˆçº§è®¾ç½®ä¸»è¦æœ‰ä¸‰éƒ¨åˆ†ï¼š<br>â‘ ã€è®¾ç½®å¯„å­˜å™¨ GICC_PMRï¼Œé…ç½®ä¼˜å…ˆçº§ä¸ªæ•°ï¼Œæ¯”å¦‚ I.MX6U æ”¯æŒ 32 çº§ä¼˜å…ˆçº§ã€‚<br>â‘¡ã€è®¾ç½®æŠ¢å ä¼˜å…ˆçº§å’Œå­ä¼˜å…ˆçº§ä½æ•°ã€‚<br>â‘¢ã€è®¾ç½®æŒ‡å®šä¸­æ–­ ID çš„ä¼˜å…ˆçº§ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®å¤–è®¾ä¼˜å…ˆçº§ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>imx6uæ—¶é’Ÿé…ç½®</title>
      <link href="/2023/02/16/2023-2-16-imx6u%E6%97%B6%E9%92%9F%E9%85%8D%E7%BD%AE/"/>
      <url>/2023/02/16/2023-2-16-imx6u%E6%97%B6%E9%92%9F%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h3 id="ç³»ç»Ÿæ—¶é’Ÿæ¥æº"><a href="#ç³»ç»Ÿæ—¶é’Ÿæ¥æº" class="headerlink" title="ç³»ç»Ÿæ—¶é’Ÿæ¥æº"></a>ç³»ç»Ÿæ—¶é’Ÿæ¥æº</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230215_214959.png"></p><p>å¼€å‘æ¿çš„ç³»ç»Ÿæ—¶é’Ÿæ¥æºäºä¸¤éƒ¨åˆ†ï¼š32.768KHz å’Œ24MHz çš„æ™¶æŒ¯ï¼Œå…¶ä¸­ 32.768KHz æ™¶æŒ¯æ˜¯ I.MX6U çš„ RTC æ—¶é’Ÿæºï¼Œ24MHz æ™¶æŒ¯æ˜¯ I.MX6U å†…æ ¸å’Œå…¶å®ƒå¤–è®¾çš„æ—¶é’Ÿæºã€‚</p><p>I.MX6U çš„å¤–è®¾æœ‰å¾ˆå¤šï¼Œä¸åŒçš„å¤–è®¾æ—¶é’Ÿæºä¸åŒï¼Œè¿™äº›å¤–è®¾çš„æ—¶é’Ÿæºåˆ†äº†7ç»„ï¼Œè¿™ 7 ç»„æ—¶é’Ÿæºéƒ½æ˜¯ä» 24MHz æ™¶æŒ¯ PLL è€Œæ¥çš„ï¼Œå› æ­¤ä¹Ÿå«åš 7 ç»„ PLL.</p><h3 id="æ—¶é’Ÿæ ‘"><a href="#æ—¶é’Ÿæ ‘" class="headerlink" title="æ—¶é’Ÿæ ‘"></a>æ—¶é’Ÿæ ‘</h3><p>ç”±ä¸‹é¢çš„æ—¶é’Ÿåˆ‡æ¢å›¾å¯çŸ¥ï¼ŒIMX6Uæ€»å…±æœ‰7ç»„PLLï¼š</p><p>PLL1ï¼ˆ996Mï¼‰ã€PLL2ï¼ˆ528Mï¼‰ã€PLL3ï¼ˆ480Mï¼‰ã€PLL4ã€PLL5ã€PLL6ã€PLL7</p><p>å…¶ä¸­PLL2ã€PLL3å„è‡ªæœ‰4ç»„PFDï¼Œè¿™äº›PFDä»¥PLLä¸ºåŸºç¡€ï¼Œç»è¿‡ä¸åŒçš„åˆ†é¢‘ç³»æ•°å¯ä»¥äº§ç”Ÿä¸åŒé¢‘ç‡çš„æ—¶é’Ÿï¼Œåœ¨å‚è€ƒæ‰‹å†Œçš„ç›¸å…³å¯„å­˜å™¨çš„åœ°æ–¹ï¼Œå¯ä»¥çœ‹åˆ°å®˜æ–¹æœ‰æ¨èçš„é…ç½®å‚æ•°ã€‚(ã€ŠIMX6ULå‚è€ƒæ‰‹å†Œã€‹</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/edr.png"></p><p>â‘ ã€ ARM_PLLï¼ˆPLL1ï¼‰ï¼Œæ­¤è·¯ PLL æ˜¯ä¾› ARM å†…æ ¸ä½¿ç”¨çš„ï¼ŒARM å†…æ ¸æ—¶é’Ÿå°±æ˜¯ç”±æ­¤ PLLç”Ÿæˆçš„ï¼Œæ­¤ PLL é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼æœ€é«˜å¯å€é¢‘åˆ° 1.3GHzã€‚<br>â‘¡ã€528_PLL(PLL2)ï¼Œæ­¤è·¯ PLL ä¹Ÿå«åš System_PLLï¼Œæ­¤è·¯ PLL æ˜¯å›ºå®šçš„ 22 å€é¢‘ï¼Œä¸å¯ç¼–ç¨‹ä¿®æ”¹ã€‚å› æ­¤ï¼Œæ­¤è·¯ PLL æ—¶é’Ÿ&#x3D;24MHz * 22 &#x3D; 528MHzï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ­¤ PLL å«åš 528_PLL çš„åŸå› ã€‚æ­¤ PLL åˆ†å‡ºäº† 4 è·¯ PFDï¼Œåˆ†åˆ«ä¸ºï¼šPLL2_PFD0<del>PLL2_PFD3ï¼Œè¿™ 4 è·¯ PFD å’Œ 528_PLLå…±åŒä½œä¸ºå…¶å®ƒå¾ˆå¤šå¤–è®¾çš„æ ¹æ—¶é’Ÿæºã€‚é€šå¸¸ 528_PLL å’Œè¿™ 4 è·¯ PFD æ˜¯ I.MX6U å†…éƒ¨ç³»ç»Ÿæ€»çº¿çš„æ—¶é’Ÿæºï¼Œæ¯”å¦‚å†…å¤„ç†é€»è¾‘å•å…ƒã€DDR æ¥å£ã€NAND&#x2F;NOR æ¥å£ç­‰ç­‰ã€‚<br>â‘¢ã€USB1_PLL(PLL3)ï¼Œæ­¤è·¯ PLL ä¸»è¦ç”¨äº USBPHYï¼Œæ­¤ PLL ä¹Ÿæœ‰å››è·¯ PFDï¼Œä¸ºï¼šPLL3_PFD0</del>PLL3_PFD3ï¼ŒUSB1_PLL æ˜¯å›ºå®šçš„ 20 å€é¢‘ï¼Œå› æ­¤ USB1_PLL&#x3D;24MHz *20&#x3D;480MHzã€‚<br>USB1_PLLè™½ç„¶ä¸»è¦ç”¨äºUSB1PHYï¼Œä½†æ˜¯å…¶å’Œå››è·¯PFDåŒæ ·ä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–å¤–è®¾çš„æ ¹æ—¶é’Ÿæºã€‚<br>â‘£ã€USB2_PLL(PLL7ï¼Œæ²¡æœ‰å†™é”™ï¼å°±æ˜¯ PLL7ï¼Œè™½ç„¶åºå·æ ‡ä¸º 4ï¼Œä½†æ˜¯å®é™…æ˜¯ PLL7)ï¼Œçœ‹åå­—å°±çŸ¥é“æ­¤è·¯PLLæ˜¯ç»™USB2PHY ä½¿ç”¨çš„ã€‚åŒæ ·çš„ï¼Œæ­¤è·¯PLLå›ºå®šä¸º20å€é¢‘ï¼Œå› æ­¤ä¹Ÿæ˜¯480MHzã€‚<br>â‘¤ã€ENET_PLL(PLL6),æ­¤è·¯ PLL å›ºå®šä¸º 20+5&#x2F;6 å€é¢‘ï¼Œå› æ­¤ ENET_PLL&#x3D;24MHz * (20+5&#x2F;6) &#x3D; 500MHzã€‚æ­¤è·¯ PLL ç”¨äºç”Ÿæˆç½‘ç»œæ‰€éœ€çš„æ—¶é’Ÿï¼Œå¯ä»¥åœ¨æ­¤ PLL çš„åŸºç¡€ä¸Šç”Ÿæˆ 25&#x2F;50&#x2F;100&#x2F;125MHzçš„ç½‘ç»œæ—¶é’Ÿã€‚<br>â‘¥ã€VIDEO_PLL(PLL5),æ­¤è·¯ PLL ç”¨äºæ˜¾ç¤ºç›¸å…³çš„å¤–è®¾ï¼Œæ¯”å¦‚ LCDï¼Œæ­¤è·¯ PLL çš„å€é¢‘å¯ä»¥è°ƒæ•´ï¼ŒPLL çš„è¾“å‡ºèŒƒå›´åœ¨ 650MHz<del>1300MHzã€‚æ­¤è·¯ PLL åœ¨æœ€ç»ˆè¾“å‡ºçš„æ—¶å€™è¿˜å¯ä»¥è¿›è¡Œåˆ†é¢‘ï¼Œå¯é€‰ 1&#x2F;2&#x2F;4&#x2F;8&#x2F;16 åˆ†é¢‘ã€‚<br>â‘¦ã€AUDIO_PLL(PLL4),æ­¤è·¯ PLL ç”¨äºéŸ³é¢‘ç›¸å…³çš„å¤–è®¾ï¼Œæ­¤è·¯ PLL çš„å€é¢‘å¯ä»¥è°ƒæ•´ï¼ŒPLLçš„è¾“å‡ºèŒƒå›´åŒæ ·ä¹Ÿæ˜¯ 650MHz</del>1300MHzï¼Œæ­¤è·¯ PLL åœ¨æœ€ç»ˆè¾“å‡ºçš„æ—¶å€™ä¹Ÿå¯ä»¥è¿›è¡Œåˆ†é¢‘ï¼Œå¯é€‰1&#x2F;2&#x2F;4 åˆ†é¢‘ã€‚</p><p>PLLï¼šæ¥æ”¶é”ç›¸ç¯è¾“å‡ºæ—¶é’Ÿå’Œé”ç›¸ç¯æ—è·¯æ—¶é’Ÿã€‚ ç®€å•æ¥è¯´ï¼Œé”ç›¸ç¯å°±æ˜¯ç”¨æ¥å°†å¤–éƒ¨æ™¶æŒ¯è¿›è¡Œå€é¢‘ï¼Œä»¥å®ç°ç¨³å®šä¸”é«˜é¢‘çš„æ—¶é’Ÿä¿¡å·ã€‚</p><h4 id="å†…æ ¸æ—¶é’Ÿè®¾ç½®ï¼ˆPLL1ï¼‰"><a href="#å†…æ ¸æ—¶é’Ÿè®¾ç½®ï¼ˆPLL1ï¼‰" class="headerlink" title="å†…æ ¸æ—¶é’Ÿè®¾ç½®ï¼ˆPLL1ï¼‰"></a>å†…æ ¸æ—¶é’Ÿè®¾ç½®ï¼ˆPLL1ï¼‰</h4><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230216_182344.png"></p><p>â‘ ã€pll1_sw_clk ä¹Ÿå°±æ˜¯ PLL1 çš„æœ€ç»ˆè¾“å‡ºé¢‘ç‡ã€‚<br>â‘¡ã€æ­¤å¤„æ˜¯ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé€‰æ‹© pll1_sw_clk çš„æ—¶é’Ÿæºï¼Œç”±å¯„å­˜å™¨ CCM_CCSR çš„PLL1_SW_CLK_SEL ä½å†³å®š pll1_sw_clk æ˜¯é€‰æ‹© pll1_main_clk è¿˜æ˜¯ step_clkã€‚æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥é€‰æ‹© pll1_main_clkï¼Œä½†æ˜¯å¦‚æœè¦å¯¹ pll1_main_clk(PLL1)çš„é¢‘ç‡è¿›è¡Œè°ƒæ•´çš„è¯ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦è®¾ç½®PLL1&#x3D;1056MHzï¼Œæ­¤æ—¶å°±è¦å…ˆå°† pll1_sw_clk åˆ‡æ¢åˆ° step_clk ä¸Šã€‚ç­‰ pll1_main_clk è°ƒæ•´å®Œæˆä»¥åå†åˆ‡æ¢å›æ¥ã€‚<br>â‘¢ã€æ­¤å¤„ä¹Ÿæ˜¯ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œé€‰æ‹© step_clk çš„æ—¶é’Ÿæºï¼Œç”±å¯„å­˜å™¨ CCM_CCSR çš„ STEP_SEL ä½æ¥å†³å®š step_clk æ˜¯é€‰æ‹© osc_clk è¿˜æ˜¯ secondary_clkã€‚ä¸€èˆ¬é€‰æ‹© osc_clkï¼Œä¹Ÿå°±æ˜¯ 24MHz çš„æ™¶æŒ¯ã€‚</p><p><strong>é¦–å…ˆè¦ä½¿ç”¨CCM_CCSRå¯„å­˜å™¨æ¥å†³å®šä½¿ç”¨æ—¶é’Ÿæºæ¥è¿›è¡Œé…ç½®ã€‚</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230216_174705.png"></p><p>â‘ ã€ è®¾ç½®å¯„å­˜å™¨ CCSR çš„ STEP_SEL ä½ï¼Œè®¾ç½® step_clk çš„æ—¶é’Ÿæºä¸º 24M çš„æ™¶æŒ¯ã€‚<br>â‘¡ã€è®¾ç½®å¯„å­˜å™¨ CCSR çš„ PLL1_SW_CLK_SEL ä½ï¼Œè®¾ç½® pll1_sw_clk çš„æ—¶é’Ÿæºä¸º<br>step_clk&#x3D;24MHzï¼Œé€šè¿‡è¿™ä¸€æ­¥æˆ‘ä»¬å°±å°† I.MX6U çš„ä¸»é¢‘å…ˆè®¾ç½®ä¸º 24MHzï¼Œç›´æ¥æ¥è‡ªäºå¤–éƒ¨çš„<br>24M æ™¶æŒ¯ã€‚<br>â‘¢ã€è®¾ç½®å¯„å­˜å™¨ CCM_ANALOG_PLL_ARMnï¼Œå°† pll1_main_clk(PLL1)è®¾ç½®ä¸º 1056MHzã€‚<br>â‘£ã€è®¾ç½®å¯„å­˜å™¨ CCSR çš„ PLL1_SW_CLK_SEL ä½ï¼Œé‡æ–°å°† pll1_sw_clk çš„æ—¶é’Ÿæºåˆ‡æ¢å›<br>pll1_main_clkï¼Œåˆ‡æ¢å›æ¥ä»¥åçš„ pll1_sw_clk å°±ç­‰äº 1056MHzã€‚<br>â‘¤ã€æœ€åè®¾ç½®å¯„å­˜å™¨ CCM_CACRR çš„ ARM_PODF ä¸º 2 åˆ†é¢‘ï¼ŒI.MX6U çš„å†…æ ¸ä¸»é¢‘å°±ä¸º<br>1056&#x2F;2&#x3D;528MHzã€‚</p><h4 id="PFD-æ—¶é’Ÿè®¾ç½®"><a href="#PFD-æ—¶é’Ÿè®¾ç½®" class="headerlink" title="PFD æ—¶é’Ÿè®¾ç½®"></a>PFD æ—¶é’Ÿè®¾ç½®</h4><p>è®¾ç½®å¥½ä¸»é¢‘ä»¥åæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®å¥½å…¶ä»–çš„ PLL å’Œ PFD æ—¶é’Ÿï¼ŒPLL1 ä¸Šä¸€å°èŠ‚å·²ç»è®¾ç½®äº†ï¼ŒPLL2ã€PLL3 å’Œ PLL7 å›ºå®šä¸º 528MHzã€480MHz å’Œ 480MHzï¼ŒPLL4~PLL6 éƒ½æ˜¯é’ˆå¯¹ç‰¹æ®Šå¤–è®¾çš„ï¼Œç”¨åˆ°çš„æ—¶å€™å†è®¾ç½®ã€‚å› æ­¤ï¼Œæ¥ä¸‹æ¥é‡ç‚¹å°±æ˜¯è®¾ç½® PLL2 å’Œ PLL3 çš„å„è‡ª 4 è·¯ PFDï¼Œè¿™ 8 è·¯ PFD é¢‘ç‡å¦‚è¡¨  æ‰€ç¤ºï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230216_183230.png"></p><p>è®¾ç½®PFD0~3éœ€è¦æŒ‰ç…§å¯„å­˜å™¨çš„æ‰€åœ¨ä½è¿›è¡Œç½®æ•°ã€‚ä»¥ä¸‹æ˜¯å¯„å­˜å™¨CCM_ANALOG_PFD_528nçš„ç»“æ„ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230216_191351.png"></p><p>é¢‘ç‡è®¡ç®—å…¬å¼</p><p><strong>PLL2_PFDX&#x3D;528*18&#x2F;PFDX_FRAC(X&#x3D;1~3)ã€‚</strong></p><p>*<em>PLL3_PFDX&#x3D;480</em>18&#x2F;PFDX_FRAC(X&#x3D;0~3)**ã€‚</p><p>ä¾‹å¦‚è®¾ç½®PFD3çš„çš„é¢‘ç‡ä¸º297MHzéœ€è¦è¿›è¡Œä»¥ä¸‹è®¾ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> reg = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> x;</span><br><span class="line">reg &amp;= ~(<span class="number">0X3F3F3F3F</span>);<span class="comment">//æ¸…æ¥šä»¥å‰è®¾ç½®</span></span><br><span class="line">x = <span class="number">32</span>;<span class="comment">//528*18/297</span></span><br><span class="line">reg |= (x&lt;&lt;<span class="number">24</span>);<span class="comment">//24æ˜¯å¯„å­˜å™¨çš„ä½ç½®</span></span><br></pre></td></tr></table></figure><h4 id="AHBã€IPG-å’Œ-PERCLK-æ ¹æ—¶é’Ÿè®¾ç½®"><a href="#AHBã€IPG-å’Œ-PERCLK-æ ¹æ—¶é’Ÿè®¾ç½®" class="headerlink" title="AHBã€IPG å’Œ PERCLK æ ¹æ—¶é’Ÿè®¾ç½®"></a>AHBã€IPG å’Œ PERCLK æ ¹æ—¶é’Ÿè®¾ç½®</h4><p>7 è·¯ PLL å’Œ 8 è·¯ PFD è®¾ç½®å®Œæˆä»¥åæœ€åè¿˜éœ€è¦è®¾ç½® AHB_CLK_ROOT å’Œ IPG_CLK_ROOTçš„æ—¶é’Ÿï¼ŒI.MX6U å¤–è®¾æ ¹æ—¶é’Ÿå¯è®¾ç½®èŒƒå›´å¦‚å›¾ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230216_192443.png"></p><p>AHB_CLK_ROOT æœ€é«˜å¯ä»¥è®¾ç½® 132MHzï¼ŒIPG_CLK_ROOT å’ŒPERCLK_CLK_ROOT æœ€é«˜å¯ä»¥è®¾ç½®66MHzã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230216_193126.png"></p><p>â‘ ã€æ­¤é€‰æ‹©å™¨ç”¨æ¥é€‰æ‹© pre_periph_clk çš„æ—¶é’Ÿæºï¼Œå¯ä»¥é€‰æ‹© PLL2ã€PLL2_PFD2ã€PLL2_PFD0å’Œ PLL2_PFD2&#x2F;2ã€‚å¯„å­˜å™¨ CCM_CBCMR çš„ PRE_PERIPH_CLK_SEL ä½å†³å®šé€‰æ‹©å“ªä¸€ä¸ªï¼Œé»˜è®¤é€‰æ‹© PLL2_PFD2ï¼Œå› æ­¤ pre_periph_clk&#x3D;PLL2_PFD2&#x3D;396MHzã€‚<br>â‘¡ã€æ­¤é€‰æ‹©å™¨ç”¨æ¥é€‰æ‹© periph_clk çš„æ—¶é’Ÿæºï¼Œç”±å¯„å­˜å™¨ CCM_CBCDR çš„ PERIPH_CLK_SELä½ä¸ PLL_bypass_en2 ç»„æˆçš„æˆ–æ¥é€‰æ‹©ã€‚å½“ CCM_CBCDR çš„ PERIPH_CLK_SEL ä½ä¸º 0 çš„æ—¶å€™periph_clk&#x3D;pr_periph_clk&#x3D;396MHzã€‚<br>â‘¢ã€é€šè¿‡ CBCDR çš„ AHB_PODF ä½æ¥è®¾ç½® AHB_CLK_ROOT çš„åˆ†é¢‘å€¼ï¼Œå¯ä»¥è®¾ç½® 1<del>8 åˆ†é¢‘ï¼Œå¦‚æœæƒ³è¦ AHB_CLK_ROOT&#x3D;132MHz çš„è¯å°±åº”è¯¥è®¾ç½®ä¸º 3 åˆ†é¢‘ï¼š396&#x2F;3&#x3D;132MHzã€‚å›¾ ä¸­è™½ç„¶å†™çš„æ˜¯é»˜è®¤ 4 åˆ†é¢‘ï¼Œä½†æ˜¯ I.MX6U çš„å†…éƒ¨ boot rom å°†å…¶æ”¹ä¸ºäº† 3 åˆ†é¢‘ï¼<br>â‘£ã€é€šè¿‡ CBCDR çš„ IPG_PODF ä½æ¥è®¾ç½® IPG_CLK_ROOT çš„åˆ†é¢‘å€¼ï¼Œå¯ä»¥è®¾ç½® 1</del>4 åˆ†é¢‘ï¼ŒIPG_CLK_ROOT æ—¶é’Ÿæºæ˜¯ AHB_CLK_ROOTï¼Œè¦æƒ³ IPG_CLK_ROOT&#x3D;66MHz çš„è¯å°±åº”è¯¥è®¾ç½®2 åˆ†é¢‘ï¼š132&#x2F;2&#x3D;66MHzã€‚</p><p><strong>è®¾ç½® PERCLK_CLK_ROOT æ—¶é’Ÿé¢‘ç‡</strong></p><p>PERCLK_CLK_ROOT æ¥ æº æœ‰ ä¸¤ ç§ ï¼š OSC(24MHz) å’ŒIPG_CLK_ROOTï¼Œç”±å¯„å­˜å™¨ CCM_CSCMR1 çš„ PERCLK_CLK_SEL ä½æ¥å†³å®šï¼Œå¦‚æœä¸º 0 çš„è¯ï¼ŒPERCLK_CLK_ROOT çš„æ—¶é’Ÿæºå°±æ˜¯ IPG_CLK_ROOT&#x3D;66MHz ã€‚å¯ä»¥é€šè¿‡å¯„å­˜å™¨CCM_CSCMR1 çš„ PERCLK_PODF ä½æ¥è®¾ç½®åˆ†é¢‘ï¼Œå¦‚æœè¦è®¾ç½® PERCLK_CLK_ROOT ä¸º 66MHzçš„è¯å°±è¦è®¾ç½®ä¸º 1 åˆ†é¢‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">clk_enable</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">CCM-&gt;CCGR0 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">CCM-&gt;CCGR1 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">CCM-&gt;CCGR2 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">CCM-&gt;CCGR3 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">CCM-&gt;CCGR4 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">CCM-&gt;CCGR5 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">CCM-&gt;CCGR6 = <span class="number">0XFFFFFFFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description: åˆå§‹åŒ–ç³»ç»Ÿæ—¶é’Ÿï¼Œè®¾ç½®ç³»ç»Ÿæ—¶é’Ÿä¸º792Mhzï¼Œå¹¶ä¸”è®¾ç½®PLL2å’ŒPLL3å„ä¸ª</span></span><br><span class="line"><span class="comment">   PFDæ—¶é’Ÿ,æ‰€æœ‰çš„æ—¶é’Ÿé¢‘ç‡å‡æŒ‰ç…§I.MX6Uå®˜æ–¹æ‰‹å†Œæ¨èçš„å€¼.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">imx6u_clkinit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> reg = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* 1ã€è®¾ç½®ARMå†…æ ¸æ—¶é’Ÿä¸º792MHz */</span></span><br><span class="line"><span class="comment">/* 1.1ã€åˆ¤æ–­å½“å‰ARMå†…æ ¸æ˜¯ä½¿ç”¨çš„é‚£ä¸ªæ—¶é’Ÿæºå¯åŠ¨çš„ï¼Œæ­£å¸¸æƒ…å†µä¸‹ARMå†…æ ¸æ˜¯ç”±pll1_sw_clké©±åŠ¨çš„ï¼Œè€Œ</span></span><br><span class="line"><span class="comment"> *  pll1_sw_clkæœ‰ä¸¤ä¸ªæ¥æºï¼špll1_main_clkå’Œtep_clkã€‚</span></span><br><span class="line"><span class="comment"> *  å¦‚æœæˆ‘ä»¬è¦è®©ARMå†…æ ¸è·‘åˆ°792Mçš„è¯é‚£å¿…é¡»é€‰æ‹©pll1_main_clkä½œä¸ºpll1çš„æ—¶é’Ÿæºã€‚</span></span><br><span class="line"><span class="comment"> *  å¦‚æœæˆ‘ä»¬è¦ä¿®æ”¹pll1_main_clkæ—¶é’Ÿçš„è¯å°±å¿…é¡»å…ˆå°†pll1_sw_clkä»pll1_main_clkåˆ‡æ¢åˆ°step_clk,</span></span><br><span class="line"><span class="comment"> *å½“ä¿®æ”¹å®Œpll1_main_clkä»¥ååœ¨å°†pll1_sw_clkåˆ‡æ¢å›pll1_main_clkã€‚è€Œstep_clkçš„æ—¶é’Ÿæºå¯ä»¥é€‰æ‹©</span></span><br><span class="line"><span class="comment"> * æ¿å­ä¸Šçš„24MHzæ™¶æŒ¯ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((((CCM-&gt;CCSR) &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x1</span> ) == <span class="number">0</span>) <span class="comment">/* å½“å‰pll1_sw_clkä½¿ç”¨çš„pll1_main_clk*/</span></span><br><span class="line">&#123;</span><br><span class="line">CCM-&gt;CCSR &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">8</span>);<span class="comment">/* é…ç½®step_clkæ—¶é’Ÿæºä¸º24MH OSC */</span></span><br><span class="line">CCM-&gt;CCSR |= (<span class="number">1</span> &lt;&lt; <span class="number">2</span>);<span class="comment">/* é…ç½®pll1_sw_clkæ—¶é’Ÿæºä¸ºstep_clk */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 1.2ã€è®¾ç½®pll1_main_clkä¸º792MHz</span></span><br><span class="line"><span class="comment"> *      å› ä¸ºpll1_sw_clkè¿›ARMå†…æ ¸çš„æ—¶å€™ä¼šè¢«äºŒåˆ†é¢‘ï¼</span></span><br><span class="line"><span class="comment"> *      é…ç½®CCM_ANLOG-&gt;PLL_ARMå¯„å­˜å™¨</span></span><br><span class="line"><span class="comment"> *      bit13: 1 ä½¿èƒ½æ—¶é’Ÿè¾“å‡º</span></span><br><span class="line"><span class="comment"> *      bit[6:0]: 66, ç”±å…¬å¼ï¼šFout = Fin * div_select / 2.0ï¼Œ792=24*div_select/2.0,</span></span><br><span class="line"><span class="comment"> *              å¾—å‡ºï¼šdiv_select=    66 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CCM_ANALOG-&gt;PLL_ARM = (<span class="number">1</span> &lt;&lt; <span class="number">13</span>) | ((<span class="number">66</span> &lt;&lt; <span class="number">0</span>) &amp; <span class="number">0X7F</span>); <span class="comment">/* é…ç½®pll1_main_clk=792MHz */</span></span><br><span class="line">CCM-&gt;CCSR &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">2</span>);<span class="comment">/* å°†pll_sw_clkæ—¶é’Ÿé‡æ–°åˆ‡æ¢å›pll1_main_clk */</span></span><br><span class="line">CCM-&gt;CACRR = <span class="number">0</span>;<span class="comment">/* ARMå†…æ ¸æ—¶é’Ÿä¸ºpll1_sw_clk/1=792/1=792Mhz */</span></span><br><span class="line"><span class="comment">/* 2ã€è®¾ç½®PLL2(SYS PLL)å„ä¸ªPFD */</span></span><br><span class="line">reg = CCM_ANALOG-&gt;PFD_528;</span><br><span class="line">reg &amp;= ~(<span class="number">0X3F3F3F3F</span>);<span class="comment">/* æ¸…é™¤åŸæ¥çš„è®¾ç½® */</span></span><br><span class="line">reg |= <span class="number">32</span>&lt;&lt;<span class="number">24</span>;<span class="comment">/* PLL2_PFD3=528*18/32=297Mhz */</span></span><br><span class="line">reg |= <span class="number">24</span>&lt;&lt;<span class="number">16</span>;<span class="comment">/* PLL2_PFD2=528*18/24=396Mhz(DDRä½¿ç”¨çš„æ—¶é’Ÿï¼Œæœ€å¤§400Mhz) */</span></span><br><span class="line">reg |= <span class="number">16</span>&lt;&lt;<span class="number">8</span>;<span class="comment">/* PLL2_PFD1=528*18/16=594Mhz */</span></span><br><span class="line">reg |= <span class="number">27</span>&lt;&lt;<span class="number">0</span>;<span class="comment">/* PLL2_PFD0=528*18/27=352Mhz  */</span></span><br><span class="line">CCM_ANALOG-&gt;PFD_528=reg;<span class="comment">/* è®¾ç½®PLL2_PFD0~3  */</span></span><br><span class="line"><span class="comment">/* 3ã€è®¾ç½®PLL3(USB1)å„ä¸ªPFD */</span></span><br><span class="line">reg = <span class="number">0</span>;<span class="comment">/* æ¸…é›¶   */</span></span><br><span class="line">reg = CCM_ANALOG-&gt;PFD_480;</span><br><span class="line">reg &amp;= ~(<span class="number">0X3F3F3F3F</span>);<span class="comment">/* æ¸…é™¤åŸæ¥çš„è®¾ç½® */</span></span><br><span class="line">reg |= <span class="number">19</span>&lt;&lt;<span class="number">24</span>;<span class="comment">/* PLL3_PFD3=480*18/19=454.74Mhz */</span></span><br><span class="line">reg |= <span class="number">17</span>&lt;&lt;<span class="number">16</span>;<span class="comment">/* PLL3_PFD2=480*18/17=508.24Mhz */</span></span><br><span class="line">reg |= <span class="number">16</span>&lt;&lt;<span class="number">8</span>;<span class="comment">/* PLL3_PFD1=480*18/16=540Mhz*/</span></span><br><span class="line">reg |= <span class="number">12</span>&lt;&lt;<span class="number">0</span>;<span class="comment">/* PLL3_PFD0=480*18/12=720Mhz */</span></span><br><span class="line">CCM_ANALOG-&gt;PFD_480=reg;<span class="comment">/* è®¾ç½®PLL3_PFD0~3 */</span></span><br><span class="line"><span class="comment">/* 4ã€è®¾ç½®AHBæ—¶é’Ÿ æœ€å°6Mhzï¼Œ æœ€å¤§132Mhz (boot romè‡ªåŠ¨è®¾ç½®å¥½äº†å¯ä»¥ä¸ç”¨è®¾ç½®)*/</span></span><br><span class="line">CCM-&gt;CBCMR &amp;= ~(<span class="number">3</span> &lt;&lt; <span class="number">18</span>); <span class="comment">/* æ¸…é™¤è®¾ç½®*/</span> </span><br><span class="line">CCM-&gt;CBCMR |= (<span class="number">1</span> &lt;&lt; <span class="number">18</span>);<span class="comment">/* pre_periph_clk=PLL2_PFD2=396MHz */</span></span><br><span class="line">CCM-&gt;CBCDR &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">25</span>);<span class="comment">/* periph_clk=pre_periph_clk=396MHz */</span></span><br><span class="line"><span class="keyword">while</span>(CCM-&gt;CDHIPR &amp; (<span class="number">1</span> &lt;&lt; <span class="number">5</span>));<span class="comment">/* ç­‰å¾…æ¡æ‰‹å®Œæˆ */</span></span><br><span class="line"><span class="comment">/* 5ã€è®¾ç½®IPG_CLK_ROOTæœ€å°3Mhzï¼Œæœ€å¤§66Mhz (boot romè‡ªåŠ¨è®¾ç½®å¥½äº†å¯ä»¥ä¸ç”¨è®¾ç½®)*/</span></span><br><span class="line">CCM-&gt;CBCDR &amp;= ~(<span class="number">3</span> &lt;&lt; <span class="number">8</span>);<span class="comment">/* CBCDRçš„IPG_PODFæ¸…é›¶ */</span></span><br><span class="line">CCM-&gt;CBCDR |= <span class="number">1</span> &lt;&lt; <span class="number">8</span>;<span class="comment">/* IPG_PODF 2åˆ†é¢‘ï¼ŒIPG_CLK_ROOT=66MHz */</span></span><br><span class="line"><span class="comment">/* 6ã€è®¾ç½®PERCLK_CLK_ROOTæ—¶é’Ÿ */</span></span><br><span class="line">CCM-&gt;CSCMR1 &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">6</span>);<span class="comment">/* PERCLK_CLK_ROOTæ—¶é’Ÿæºä¸ºIPG */</span></span><br><span class="line">CCM-&gt;CSCMR1 &amp;= ~(<span class="number">7</span> &lt;&lt; <span class="number">0</span>);<span class="comment">/* PERCLK_PODFä½æ¸…é›¶ï¼Œå³1åˆ†é¢‘ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GPIOå¯„å­˜å™¨é…ç½®åŸç†</title>
      <link href="/2023/02/14/2023-2-14-GPIO%E5%AF%84%E5%AD%98%E5%99%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86/"/>
      <url>/2023/02/14/2023-2-14-GPIO%E5%AF%84%E5%AD%98%E5%99%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h3 id="i-MX6ULLä¹Ÿæœ‰å¤šç§ç‚¹ç¯æ–¹å¼ï¼šï¼ˆç©¶å…¶æœ¬è´¨ï¼Œæœ€ç»ˆéƒ½æ˜¯è¦æ“ä½œi-MX6ULLçš„å¯„å­˜å™¨ï¼‰"><a href="#i-MX6ULLä¹Ÿæœ‰å¤šç§ç‚¹ç¯æ–¹å¼ï¼šï¼ˆç©¶å…¶æœ¬è´¨ï¼Œæœ€ç»ˆéƒ½æ˜¯è¦æ“ä½œi-MX6ULLçš„å¯„å­˜å™¨ï¼‰" class="headerlink" title="i.MX6ULLä¹Ÿæœ‰å¤šç§ç‚¹ç¯æ–¹å¼ï¼šï¼ˆç©¶å…¶æœ¬è´¨ï¼Œæœ€ç»ˆéƒ½æ˜¯è¦æ“ä½œi.MX6ULLçš„å¯„å­˜å™¨ï¼‰"></a>i.MX6ULLä¹Ÿæœ‰å¤šç§ç‚¹ç¯æ–¹å¼ï¼šï¼ˆç©¶å…¶æœ¬è´¨ï¼Œæœ€ç»ˆéƒ½æ˜¯è¦æ“ä½œi.MX6ULLçš„å¯„å­˜å™¨ï¼‰</h3><ul><li><strong>è£¸æœºç³»ç»Ÿ</strong>ï¼šæ±‡ç¼–æ“ä½œå¯„å­˜å™¨ç‚¹ç¯ã€Cè¯­è¨€æ“ä½œå¯„å­˜å™¨ç‚¹ç¯</li><li><strong>è·‘Linuxç³»ç»Ÿ</strong>ï¼šå­—ç¬¦é©±åŠ¨LEDç‚¹ç¯ã€è®¾å¤‡æ ‘é©±åŠ¨LEDç‚¹ç¯</li></ul><h3 id="IOä¸GPIOæ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼ŒGPIOæ˜¯å±äºIOçš„ä¸€éƒ¨åˆ†ã€‚"><a href="#IOä¸GPIOæ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼ŒGPIOæ˜¯å±äºIOçš„ä¸€éƒ¨åˆ†ã€‚" class="headerlink" title="IOä¸GPIOæ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼ŒGPIOæ˜¯å±äºIOçš„ä¸€éƒ¨åˆ†ã€‚"></a>IOä¸GPIOæ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼ŒGPIOæ˜¯å±äºIOçš„ä¸€éƒ¨åˆ†ã€‚</h3><p>IO: Input Outputï¼Œç”¨äºCPUä¸å¤–ç•Œè¿›è¡Œä¿¡æ¯äº¤äº’ã€‚ä¾‹å¦‚CPU è¯»å†…å­˜æ•°æ®éœ€è¦ I&#x2F;O ç³»ç»Ÿï¼ŒCPU è¾“å‡ºæ•°æ®åˆ°å±å¹•æ˜¾ç¤ºå‡ºæ¥ä¹Ÿéœ€è¦ I&#x2F;O ç³»ç»Ÿï¼Œä¿¡æ¯åœ¨ I&#x2F;O ç³»ç»Ÿä¸Šä¼ è¾“æœ‰ä¸²è¡Œæˆ–å¹¶è¡Œã€‚<br>GPIO: General-Purpose IO portsï¼Œå³é€šç”¨I&#x2F;Oå£ï¼Œåœ¨å¾®æ§åˆ¶å™¨èŠ¯ç‰‡ä¸Šä¸€èˆ¬éƒ½ä¼šæä¾›ä¸€ä¸ªâ€œé€šç”¨å¯ç¼–ç¨‹I&#x2F;Oæ¥å£â€ã€‚æ¥å£è‡³å°‘æœ‰ä¸¤ä¸ªå¯„å­˜å™¨â€”â€”æ•°æ®å¯„å­˜å™¨ä¸æ§åˆ¶å¯„å­˜å™¨ã€‚æ•°æ®å¯„å­˜å™¨çš„å„ä½ç›´æ¥å¼•åˆ°èŠ¯ç‰‡å¤–éƒ¨ï¼Œæ§åˆ¶å¯„å­˜å™¨åˆ™æ˜¯å¯¹æ•°æ®å¯„å­˜å™¨ä¸­æ¯ä¸€ä½è¿›è¡Œç‹¬ç«‹çš„è®¾ç½®ã€‚</p><h3 id="imx6ulçš„GPIOç¡¬ä»¶ç»“æ„"><a href="#imx6ulçš„GPIOç¡¬ä»¶ç»“æ„" class="headerlink" title="imx6ulçš„GPIOç¡¬ä»¶ç»“æ„"></a>imx6ulçš„GPIOç¡¬ä»¶ç»“æ„</h3><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230215_150827.png"></p><p>â‘  PADï¼šå®ƒä»£è¡¨äº†i.MX6ULLèŠ¯ç‰‡çš„ä¸€ä¸ªGPIOå¼•è„šã€‚</p><p>â‘¡ IOMUXå¤ç”¨é€‰æ‹©å™¨ï¼šä¸STM32çš„å¼•è„šå¤ç”¨åŠŸèƒ½ç±»ä¼¼ï¼Œi.MX6ULLèŠ¯ç‰‡çš„æ¯ä¸ªIOé€šè¿‡IOMUXCä¸­çš„MUXå¯„å­˜å™¨å’ŒPADå¯„å­˜å™¨è®¾ç½®ï¼Œå¯ä»¥æ”¯æŒå¤šç§åŠŸèƒ½(å¦‚GPIOã€IICã€USARTâ€¦)ã€‚</p><p>IOMUXç”±å…¶å·¦ä¾§çš„IOMUXCæä¾›å¯„å­˜å™¨ç»™ç”¨æˆ·è¿›è¡Œé…ç½®ï¼Œå®ƒåˆåˆ†æˆMUX_Modeï¼ˆIO æ¨¡å¼æ§åˆ¶ï¼‰ä»¥åŠPad Settingsï¼ˆPad é…ç½®ï¼‰ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ol><li><p>MUX_Modeé…ç½®ï¼šç”¨æ¥é…ç½®å¼•è„šçš„å¤ç”¨åŠŸèƒ½</p><p>2.Pad Settings é…ç½®ï¼šé…ç½®å¼•è„šçš„å±æ€§ï¼Œä¾‹å¦‚é©±åŠ¨èƒ½åŠ›ï¼Œæ˜¯å¦ä½¿ç”¨ä¸Šä¸‹æ‹‰ç”µé˜»ï¼Œæ˜¯å¦ä½¿ç”¨ä¿æŒå™¨ï¼Œæ˜¯å¦ä½¿ç”¨å¼€æ¼æ¨¡å¼ä»¥åŠä½¿ç”¨æ–½å¯†ç‰¹æ¨¡å¼è¿˜æ˜¯CMOSæ¨¡å¼ç­‰</p></li></ol><p>â‘¢ Blockå¤–è®¾åŠŸèƒ½æ§åˆ¶å—ï¼šä¾‹å¦‚å…·æœ‰PWMè¾“å‡ºåŠŸèƒ½çš„å¼•è„šï¼Œå®ƒéœ€è¦PWMå¤–è®¾çš„æ”¯æŒã€‚</p><p>â‘£ GPIOå¤–è®¾ï¼šGPIOæ¨¡å—æ˜¯æ¯ä¸ªIOéƒ½å…·æœ‰çš„å¤–è®¾ï¼Œ å®ƒæ˜¯IOæ§åˆ¶çš„åŸºæœ¬åŠŸèƒ½ï¼Œ å¦‚è¾“å‡ºé«˜ä½ç”µå¹³ã€ æ£€æµ‹ç”µå¹³è¾“å…¥ç­‰ã€‚å½“éœ€è¦ä½¿ç”¨å¼•è„šçš„GPIOåŠŸèƒ½æ—¶ï¼Œå°±è¦é…ç½®GPIOå¤–è®¾ä¸­çš„å„ä¸ªå¯„å­˜å™¨(DRã€GDIRã€PSRâ€¦)ã€‚</p><p>â‘¤ ä¸å…¶å®ƒå¼•è„šçš„è¿æ¥ï¼šè¿™é‡Œæ˜¯å¦ä¸€ä¸ªå¼•è„šPAD2ï¼Œå®ƒä¸PAD1æœ‰ä¸€æ ¹ä¿¡å·çº¿è¿æ¥ï¼Œè¡¨ç¤ºéƒ¨åˆ†å¼•è„šçš„è¾“å‡ºå¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªå¼•è„šçš„è¾“å…¥ã€‚</p><h4 id="GPIOé…ç½®"><a href="#GPIOé…ç½®" class="headerlink" title="GPIOé…ç½®"></a>GPIOé…ç½®</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> DR;         <span class="comment">/**&lt; GPIO data register, offset: 0x0 */</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> GDIR;       <span class="comment">/**&lt; GPIO direction register, offset: 0x4 */</span></span><br><span class="line">  __I  <span class="type">uint32_t</span> PSR;        <span class="comment">/**&lt; GPIO pad status register, offset: 0x8 */</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> ICR1;       <span class="comment">/**&lt; GPIO interrupt configuration register1, offset: 0xC */</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> ICR2;       <span class="comment">/**&lt; GPIO interrupt configuration register2, offset: 0x10 */</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> IMR;        <span class="comment">/**&lt; GPIO interrupt mask register, offset: 0x14 */</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> ISR;        <span class="comment">/**&lt; GPIO interrupt status register, offset: 0x18 */</span></span><br><span class="line">  __IO <span class="type">uint32_t</span> EDGE_SEL;   <span class="comment">/**&lt; GPIO edge select register, offset: 0x1C */</span></span><br><span class="line">&#125; GPIO_Type;</span><br></pre></td></tr></table></figure><p>DRï¼ˆdata registerï¼‰ï¼Œå³æ•°æ®å¯„å­˜å™¨ï¼Œå®ƒæ˜¯32ä½çš„ï¼Œä¸€ä¸ªGPIOç»„æœ€å¤§åªæœ‰32ä¸ªIOï¼Œå› æ­¤DRå¯„å­˜å™¨ä¸­çš„æ¯ä¸ªä½éƒ½å¯¹åº”ä¸€ä¸ª GPIOã€‚å½“GPIOè¢«é…ç½®ä¸ºè¾“å‡ºæ¨¡å¼åï¼Œå‘æŒ‡å®šçš„ä½å†™å…¥æ•°æ®é‚£ä¹ˆç›¸åº”çš„IOå°±ä¼šè¾“å‡ºç›¸åº”çš„é«˜ä½ç”µå¹³ï¼Œå½“ GPIOè¢«é…ç½®ä¸ºè¾“å…¥æ¨¡å¼åï¼Œæ­¤å¯„å­˜å™¨å°±ä¿å­˜ç€å¯¹åº”IOçš„ç”µå¹³å€¼ï¼Œæ¯ä¸ªä½å¯¹å¯¹åº”ä¸€ä¸ªGPIOã€‚</p><p><strong>GDIRï¼ˆGPIO direction registerï¼‰</strong>ï¼Œå³æ–¹å‘å¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯32ä½çš„ï¼Œç”¨æ¥è®¾ç½®æŸä¸ªGPIOçš„å·¥ä½œæ–¹å‘çš„ï¼Œå³è¾“å…¥&#x2F;è¾“å‡ºã€‚åŒæ ·çš„ï¼Œæ¯ä¸ªIOå¯¹åº”ä¸€ä¸ªä½ï¼Œå¦‚æœè¦è®¾ç½®GPIOä¸ºè¾“å…¥ï¼Œå°±è®¾ç½®ç›¸åº”çš„ä½ä¸º0ï¼Œå¦‚æœè¦è®¾ç½®ä¸ºè¾“å‡ºï¼Œå°±è®¾ç½®ä¸º1</p><p><strong>PSRï¼ˆPad Status Registerï¼‰</strong>ï¼Œå³çŠ¶æ€å¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯32ä½çš„ã€‚æ³¨æ„å®ƒæ˜¯ä¸€ä¸ª<strong>åªè¯»å¯„å­˜å™¨</strong>ï¼Œæ¯ä¸ªIOå¯¹åº”ä¸€ä¸ªä½ï¼Œè¯»å–ç›¸åº”çš„ä½å³å¯è·å–å¯¹åº”çš„GPIOçš„çŠ¶(é«˜ä½ç”µå¹³å€¼)ï¼ŒåŠŸèƒ½å’Œè¾“å…¥çŠ¶æ€ä¸‹çš„DRå¯„å­˜å™¨ä¸€æ ·ã€‚</p><p><strong>ICR1ï¼ˆinterrupt configuration register1ï¼‰å’ŒICR2</strong>ï¼Œéƒ½æ˜¯ä¸­æ–­æ§åˆ¶å¯„å­˜å™¨ï¼Œ ICR1ç”¨äºé…ç½®ä½16ä¸ªGPIOï¼ŒICR2 ç”¨äºé…ç½®é«˜16 ä¸ªGPIOã€‚</p><p><strong>IMRï¼ˆinterrupt mask registerï¼‰</strong>ï¼Œå³ä¸­æ–­å±è”½å¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯32ä½ï¼Œæ¯ä¸ªIOå¯¹åº”ä¸€ä¸ªä½ã€‚IMRå¯„å­˜å™¨ç”¨æ¥æ§åˆ¶GPIOçš„ä¸­æ–­ç¦æ­¢å’Œä½¿èƒ½ï¼Œå¦‚æœä½¿èƒ½æŸä¸ªGPIOçš„ä¸­æ–­ï¼Œé‚£ä¹ˆè®¾ç½®ç›¸åº”çš„ä½ä¸º1å³å¯ï¼Œåä¹‹ï¼Œå¦‚æœè¦ç¦æ­¢ä¸­æ–­ï¼Œé‚£ä¹ˆå°±è®¾ç½®ç›¸åº”çš„ä½ä¸º0å³å¯ã€‚</p><p><strong>ISRï¼ˆinterrupt status registerï¼‰</strong>ï¼Œå³ä¸­æ–­çŠ¶æ€å¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯32ä½ï¼Œæ¯ä¸ªIOå¯¹åº”ä¸€ä¸ªä½ã€‚åªè¦æŸä¸ªGPIOçš„ä¸­æ–­å‘ç”Ÿï¼Œåˆ™ISRä¸­ç›¸åº”çš„ä½å°±ä¼šè¢«ç½®1ã€‚æ‰€ä»¥é€šè¿‡è¯»å–ISRå¯„å­˜å™¨æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†ä¸­æ–­ï¼Œç±»ä¼¼äºå­¦ä¹ STM32ç”¨åˆ°çš„ä¸­æ–­æ ‡å¿—ä½ã€‚</p><p><strong>EDGE_SELï¼ˆedge select registerï¼‰</strong>ï¼Œå³è¾¹æ²¿é€‰æ‹©å¯„å­˜å™¨ï¼Œä¹Ÿæ˜¯32ä½ï¼Œæ¯ä¸ªIOå¯¹åº”ä¸€ä¸ªä½ã€‚</p><p>å®ƒç”¨æ¥è®¾ç½®è¾¹æ²¿ä¸­æ–­ï¼Œ å¹¶ä¼šè¦†ç›–ICR1å’ŒICR2çš„è®¾ç½®ã€‚</p><h4 id="æ—¶é’Ÿé…ç½®"><a href="#æ—¶é’Ÿé…ç½®" class="headerlink" title="æ—¶é’Ÿé…ç½®"></a>æ—¶é’Ÿé…ç½®</h4><p><strong>CCMï¼ˆClock Controller Moduleï¼‰æ—¶é’Ÿæ§åˆ¶æ¨¡å—å¯„å­˜å™¨ç”¨æ¥ä½¿èƒ½å¤–è®¾æ—¶é’Ÿã€‚ CMMä¸€å…±æœ‰CCM_CCGR0~CCM_CCGR6</strong>è¿™ 7 ä¸ªå¯„å­˜å™¨ï¼Œæ§åˆ¶ç€I.MX6Uçš„æ‰€æœ‰å¤–è®¾æ—¶é’Ÿå¼€å…³ã€‚</p><p>ä»¥CCM_CCGR0ä¸ºä¾‹ï¼Œå®ƒæ˜¯ä¸ª32ä½å¯„å­˜å™¨ï¼Œæ¯2ä½æ§åˆ¶ä¸€ä¸ªå¤–è®¾çš„æ—¶é’Ÿï¼Œæ¯”å¦‚ bit31:30 æ§åˆ¶ç€GPIO2 çš„å¤–è®¾æ—¶é’Ÿï¼Œä¸¤ä¸ªä½å°±æœ‰ 4 ç§æ“ä½œæ–¹å¼ï¼š</p><table><thead><tr><th>ä½è®¾ç½®</th><th>æ—¶é’Ÿæ§åˆ¶</th></tr></thead><tbody><tr><td>00</td><td>æ‰€æœ‰æ¨¡å¼ä¸‹éƒ½å…³é—­å¤–è®¾æ—¶é’Ÿ</td></tr><tr><td>01</td><td>åªæœ‰åœ¨è¿è¡Œæ¨¡å¼ä¸‹æ‰“å¼€å¤–è®¾æ—¶é’Ÿï¼Œç­‰å¾…æ¨¡å¼å’Œåœæ­¢æ¨¡å¼ä¸‹å‡å…³é—­å¤–è®¾æ—¶é’Ÿ</td></tr><tr><td>10</td><td>æœªä½¿ç”¨(ä¿ç•™)</td></tr><tr><td>11</td><td>é™¤äº†åœæ­¢æ¨¡å¼ä»¥å¤–ï¼Œå…¶ä»–æ‰€æœ‰æ¨¡å¼ä¸‹æ—¶é’Ÿéƒ½æ‰“å¼€</td></tr></tbody></table><p><strong>é…ç½®æ€»ç»“</strong><br>ä½¿ç”¨i.MX6ULLçš„GPIOæ—¶ï¼Œéœ€è¦å¦‚ä¸‹å‡ æ­¥é…ç½®ï¼š</p><p>ä½¿èƒ½ GPIO å¯¹åº”çš„æ—¶é’Ÿ<br>é…ç½®MUXå¯„å­˜å™¨ï¼Œè®¾ç½®IOçš„å¤ç”¨åŠŸèƒ½ï¼Œä½¿å…¶å¤ç”¨ä¸ºGPIOåŠŸèƒ½<br>é…ç½®PADå¯„å­˜å™¨ï¼Œè®¾ç½® IO çš„ä¸Šä¸‹æ‹‰ã€é€Ÿåº¦ç­‰<br>é…ç½®GPIOçš„å„ç§å¯„å­˜å™¨ï¼ˆDRã€GDIRã€â€¦ï¼‰ï¼Œè®¾ç½®è¾“å…¥&#x2F;è¾“å‡ºã€æ˜¯å¦ä½¿ç”¨ä¸­æ–­ã€é»˜è®¤è¾“å‡ºç”µå¹³ç­‰</p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bspå·¥ç¨‹ç®¡ç†</title>
      <link href="/2023/02/12/2023-2-12-bsp%E5%B7%A5%E7%A8%8B%E7%AE%A1%E7%90%86/"/>
      <url>/2023/02/12/2023-2-12-bsp%E5%B7%A5%E7%A8%8B%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h3 id="BSPç®¡ç†"><a href="#BSPç®¡ç†" class="headerlink" title="BSPç®¡ç†"></a>BSPç®¡ç†</h3><p><strong>æ‰€æœ‰å®ŒæˆåŒä¸€ä¸ªåŠŸèƒ½çš„ä»£ç æå–å‡ºæ¥æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œä¹Ÿå°±æ˜¯å¯¹ç¨‹åºåˆ†åŠŸèƒ½ç®¡ç†ã€‚</strong></p><p>æ‰€è°“bspç®¡ç†å°±æ˜¯æŒ‰ç…§å„ä¸ªåŠŸèƒ½å‡½æ•°æ¨¡å—åŒ–æ”¾å…¥å„è‡ªæ–‡ä»¶å¤¹è¿›è¡Œä¿å­˜ç®¡ç†ï¼Œä½¿ç”¨æ—¶åˆ°å„è‡ªçš„è·¯å¾„ä¸­è¿›è¡Œè°ƒç”¨ã€‚</p><p>ç±»ä¼¼äºstm32çš„å·¥ç¨‹ç®¡ç†æ ¼å¼æ¥å­˜å‚¨ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230212_222148.png"></p><p>é¦–å…ˆä»¥ledå®éªŒä¸ºä¾‹å­,å…¶ä¸­ bsp ç”¨æ¥å­˜æ”¾é©±åŠ¨æ–‡ä»¶ï¼›imx6ul ç”¨æ¥å­˜æ”¾è·ŸèŠ¯ç‰‡æœ‰å…³çš„æ–‡ä»¶ï¼Œæ¯”å¦‚  SDKåº“æ–‡ä»¶ï¼›obj ç”¨æ¥å­˜æ”¾ç¼–è¯‘ç”Ÿæˆçš„.o æ–‡ä»¶ï¼›project å­˜æ”¾ start.S å’Œ main.c æ–‡ä»¶ï¼Œcc.hã€fsl_common.hã€fsl_iomuxc.h å’Œ MCIMX6Y2.h è¿™å››ä¸ªæ–‡ä»¶æ‹·è´åˆ°æ–‡ä»¶å¤¹ imx6ul ä¸­ï¼›å°† start.S å’Œ main.c è¿™ä¸¤ä¸ªæ–‡ä»¶æ‹·è´åˆ°æ–‡ä»¶å¤¹ project ä¸­ã€‚å‰é¢çš„å®éªŒä¸­æ‰€æœ‰çš„é©±åŠ¨ç›¸å…³çš„å‡½æ•°éƒ½å†™åˆ°äº† main.c æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚å‡½æ•° clk_enableã€led_init å’Œ delayï¼Œè¿™ä¸‰ä¸ªå‡½æ•°å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼šæ—¶é’Ÿé©±åŠ¨ã€LED é©±åŠ¨å’Œå»¶æ—¶é©±åŠ¨ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ bsp æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸‰ä¸ªå­æ–‡ä»¶å¤¹ï¼šclkã€delay å’Œ ledï¼Œåˆ†åˆ«ç”¨æ¥å­˜æ”¾æ—¶é’Ÿé©±åŠ¨æ–‡ä»¶ã€å»¶æ—¶é©±åŠ¨æ–‡ä»¶å’Œ LED é©±åŠ¨æ–‡ä»¶ï¼Œè¿™æ ·main.c å‡½æ•°å°±ä¼šæ¸…çˆ½å¾ˆå¤šï¼Œç¨‹åºåŠŸèƒ½æ¨¡å—æ¸…æ™°ã€‚å·¥ç¨‹æ–‡ä»¶å¤¹éƒ½åˆ›å»ºå¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç¼–å†™ä»£ç äº†ï¼Œå…¶å®å°±æ˜¯å°†æ—¶é’Ÿé©±åŠ¨ã€LED é©±åŠ¨å’Œå»¶æ—¶é©±åŠ¨ç›¸å…³çš„å‡½æ•°ä» main.c ä¸­æå–å‡ºæ¥åšæˆä¸€ä¸ªç‹¬ç«‹çš„é©±åŠ¨æ–‡ä»¶ ã€‚</p><p>ä»£ç éƒ¨åˆ†å°±æ˜¯å°†å„éƒ¨åˆ†çš„é©±åŠ¨å‡½æ•°æ‰“åŒ…æˆå„è‡ªçš„é©±åŠ¨æ–‡ä»¶ï¼Œå‰©ä½™çš„ä¸å˜ã€‚æœ€ä¸»è¦çš„æ˜¯makefileçš„ç¼–å†™å’Œä¹‹å‰æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">1 CROSS_COMPILE ?= arm-linux-gnueabihf</span><br><span class="line">2 TARGET ?= bsp</span><br><span class="line">3 </span><br><span class="line">4 CC := <span class="variable">$(CROSS_COMPILE)</span>gcc</span><br><span class="line">5 LD := <span class="variable">$(CROSS_COMPILE)</span>ld</span><br><span class="line">6 OBJCOPY := <span class="variable">$(CROSS_COMPILE)</span>objcopy</span><br><span class="line">7 OBJDUMP := <span class="variable">$(CROSS_COMPILE)</span>objdump</span><br><span class="line">8 </span><br><span class="line">9 INCDIRS := imx6ul \                       //åŒ…å«æ•´ä¸ªå·¥ç¨‹çš„.h å¤´æ–‡ä»¶ç›®å½•</span><br><span class="line">10 bsp/clk \</span><br><span class="line">11 bsp/led \</span><br><span class="line">12 bsp/delay </span><br><span class="line">13 </span><br><span class="line">14 SRCDIRS := project \//åŒ…å«çš„æ˜¯æ•´ä¸ªå·¥ç¨‹çš„æ‰€æœ‰.c å’Œ.S æ–‡ä»¶ç›®å½•ã€‚</span><br><span class="line">15 bsp/clk \</span><br><span class="line">16 bsp/led \</span><br><span class="line">17 bsp/delay </span><br><span class="line">18 </span><br><span class="line">19 INCLUDE := <span class="variable">$(<span class="built_in">patsubst</span> %, -I %, <span class="variable">$(INCDIRS)</span>)</span>//ä½¿ç”¨patsubstå‡½æ•°ç»™INCDIRSåé¢åŠ ä¸Š-I</span><br><span class="line">20</span><br><span class="line">21 SFILES := <span class="variable">$(<span class="built_in">foreach</span> <span class="built_in">dir</span>, <span class="variable">$(SRCDIRS)</span>, $(<span class="built_in">wildcard</span> <span class="variable">$(dir)</span>/*.S)</span>)//ä½¿ç”¨foreachå’ŒdiræŒ‘å‡ºæ‰€æœ‰çš„.S æ±‡ç¼–æ–‡ä»¶å³å¯</span><br><span class="line">22 CFILES := <span class="variable">$(<span class="built_in">foreach</span> <span class="built_in">dir</span>, <span class="variable">$(SRCDIRS)</span>, $(<span class="built_in">wildcard</span> <span class="variable">$(dir)</span>/*.c)</span>)//æŒ‘å‡ºæ‰€æœ‰çš„.cæ–‡ä»¶</span><br><span class="line">ç­‰åŒCFILES = project/main.c bsp/clk/bsp_clk.c bsp/led/bsp_led.c bsp/delay/bsp_delay.c</span><br><span class="line">23</span><br><span class="line">24 SFILENDIR := <span class="variable">$(<span class="built_in">notdir</span> <span class="variable">$(SFILES)</span>)</span>//ä½¿ç”¨å‡½æ•° notdir å°† SFILES å’Œ CFILES ä¸­çš„è·¯å¾„å»æ‰</span><br><span class="line">25 CFILENDIR := <span class="variable">$(<span class="built_in">notdir</span> <span class="variable">$(CFILES)</span>)</span></span><br><span class="line">ç­‰åŒ SFILENDIR = start.S</span><br><span class="line">CFILENDIR = main.c bsp_clk.c bsp_led.c bsp_delay.c</span><br><span class="line">26</span><br><span class="line">27 SOBJS := <span class="variable">$(<span class="built_in">patsubst</span> %, obj/%, $(SFILENDIR:.S=.o)</span>)</span><br><span class="line">28 COBJS := <span class="variable">$(<span class="built_in">patsubst</span> %, obj/%, $(CFILENDIR:.c=.o)</span>)</span><br><span class="line">29 OBJS := <span class="variable">$(SOBJS)</span> <span class="variable">$(COBJS)</span></span><br><span class="line">30</span><br><span class="line">31 VPATH := <span class="variable">$(SRCDIRS)</span>//VPATH æ˜¯æŒ‡å®šæœç´¢ç›®å½•</span><br><span class="line">32</span><br><span class="line">33 .PHONY: clean</span><br><span class="line">34 </span><br><span class="line">35 <span class="variable">$(TARGET)</span>.bin : <span class="variable">$(OBJS)</span></span><br><span class="line">36 <span class="variable">$(LD)</span> -Timx6ul.lds -o <span class="variable">$(TARGET)</span>.elf <span class="variable">$^</span></span><br><span class="line">37 <span class="variable">$(OBJCOPY)</span> -O binary -S <span class="variable">$(TARGET)</span>.elf <span class="variable">$@</span></span><br><span class="line">38 <span class="variable">$(OBJDUMP)</span> -D -m arm <span class="variable">$(TARGET)</span>.elf &gt; <span class="variable">$(TARGET)</span>.dis</span><br><span class="line">39</span><br><span class="line">40 <span class="variable">$(SOBJS)</span> : obj/%.o : %.S</span><br><span class="line">41 <span class="variable">$(CC)</span> -Wall -nostdlib -c -O2 <span class="variable">$(INCLUDE)</span> -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line">42</span><br><span class="line">43 <span class="variable">$(COBJS)</span> : obj/%.o : %.c</span><br><span class="line">44 <span class="variable">$(CC)</span> -Wall -nostdlib -c -O2 <span class="variable">$(INCLUDE)</span> -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line">45 </span><br><span class="line">46 clean:</span><br><span class="line">47 rm -rf <span class="variable">$(TARGET)</span>.elf <span class="variable">$(TARGET)</span>.dis <span class="variable">$(TARGET)</span>.bin <span class="variable">$(COBJS)</span> <span class="variable">$(SOBJS)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cè¯­è¨€ç‚¹äº®led</title>
      <link href="/2023/02/05/2023-2-5-C%E8%AF%AD%E8%A8%80%E7%82%B9%E4%BA%AEled/"/>
      <url>/2023/02/05/2023-2-5-C%E8%AF%AD%E8%A8%80%E7%82%B9%E4%BA%AEled/</url>
      
        <content type="html"><![CDATA[<p>Cortex-A å¤„ç†å™¨è¿è¡Œæ¨¡å‹</p><p>Cortex-A7 å¤„ç†å™¨æœ‰ 9 ç§å¤„ç†æ¨¡å¼ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230206_165721.png"></p><p>æ‰€æœ‰çš„å¤„ç†å™¨æ¨¡å¼éƒ½å…±ç”¨ä¸€ä¸ª CPSR ç‰©ç†å¯„å­˜å™¨ï¼Œå› æ­¤ CPSR å¯ä»¥åœ¨ä»»ä½•æ¨¡å¼ä¸‹è¢«è®¿é—®ã€‚CPSR æ˜¯å½“å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼Œè¯¥å¯„å­˜å™¨åŒ…å«äº†æ¡ä»¶æ ‡å¿—ä½ã€ä¸­æ–­ç¦æ­¢ä½ã€å½“å‰å¤„ç†å™¨æ¨¡å¼æ ‡å¿—ç­‰ä¸€äº›çŠ¶æ€ä½ä»¥åŠä¸€äº›æ§åˆ¶ä½ã€‚æ‰€æœ‰çš„å¤„ç†å™¨æ¨¡å¼éƒ½å…±ç”¨ä¸€ä¸ª CPSR å¿…ç„¶ä¼šå¯¼è‡´å†²çªï¼Œä¸ºæ­¤ï¼Œé™¤äº† User å’Œ Sys è¿™ä¸¤ä¸ªæ¨¡å¼ä»¥å¤–ï¼Œå…¶ä»– 7 ä¸ªæ¨¡å¼æ¯ä¸ªéƒ½é…å¤‡äº†ä¸€ä¸ªä¸“ç”¨çš„ç‰©ç†çŠ¶æ€å¯„å­˜å™¨ï¼Œå«åš SPSR(å¤‡ä»½ç¨‹åºçŠ¶æ€å¯„å­˜å™¨)ï¼Œå½“ç‰¹å®šçš„å¼‚å¸¸ä¸­æ–­å‘ç”Ÿæ—¶ï¼ŒSPSR å¯„å­˜å™¨ç”¨æ¥ä¿å­˜å½“å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨(CPSR)çš„å€¼ï¼Œå½“å¼‚å¸¸é€€å‡ºä»¥åå¯ä»¥ç”¨ SPSR ä¸­ä¿å­˜çš„å€¼æ¥æ¢å¤ CPSRã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230206_170328.png"></p><p>N(bit31)ï¼šå½“ä¸¤ä¸ªè¡¥ç è¡¨ç¤ºçš„ æœ‰ç¬¦å·æ•´æ•°è¿ç®—çš„æ—¶å€™ï¼ŒN&#x3D;1 è¡¨ç¤ºè¿ç®—å¯¹çš„ç»“æœä¸ºè´Ÿæ•°ï¼ŒN&#x3D;0è¡¨ç¤ºç»“æœä¸ºæ­£æ•°ã€‚<br>Z(bit30)ï¼šZ&#x3D;1 è¡¨ç¤ºè¿ç®—ç»“æœä¸ºé›¶ï¼ŒZ&#x3D;0 è¡¨ç¤ºè¿ç®—ç»“æœä¸ä¸ºé›¶ï¼Œå¯¹äº CMP æŒ‡ä»¤ï¼ŒZ&#x3D;1 è¡¨ç¤ºè¿›è¡Œæ¯”è¾ƒçš„ä¸¤ä¸ªæ•°å¤§å°ç›¸ç­‰ã€‚<br>C(bit29)ï¼šåœ¨åŠ æ³•æŒ‡ä»¤ä¸­ï¼Œå½“ç»“æœäº§ç”Ÿäº†è¿›ä½ï¼Œåˆ™ C&#x3D;1ï¼Œè¡¨ç¤ºæ— ç¬¦å·æ•°è¿ç®—å‘ç”Ÿä¸Šæº¢ï¼Œå…¶å®ƒæƒ…å†µä¸‹ C&#x3D;0ã€‚åœ¨å‡æ³•æŒ‡ä»¤ä¸­ï¼Œå½“è¿ç®—ä¸­å‘ç”Ÿå€Ÿä½ï¼Œåˆ™ C&#x3D;0ï¼Œè¡¨ç¤ºæ— ç¬¦å·æ•°è¿ç®—å‘ç”Ÿä¸‹æº¢ï¼Œå…¶å®ƒæƒ…å†µä¸‹ C&#x3D;1ã€‚å¯¹äºåŒ…å«ç§»ä½æ“ä½œçš„éåŠ &#x2F;å‡æ³•è¿ç®—æŒ‡ä»¤ï¼ŒC ä¸­åŒ…å«æœ€åä¸€æ¬¡æº¢å‡ºçš„ä½çš„æ•°å€¼ï¼Œå¯¹äºå…¶å®ƒéåŠ &#x2F;å‡è¿ç®—æŒ‡ä»¤ï¼ŒC ä½çš„å€¼é€šå¸¸ä¸å—å½±å“ã€‚<br>V(bit28)ï¼šå¯¹äºåŠ &#x2F;å‡æ³•è¿ç®—æŒ‡ä»¤ï¼Œå½“æ“ä½œæ•°å’Œè¿ç®—ç»“æœè¡¨ç¤ºä¸ºäºŒè¿›åˆ¶çš„è¡¥ç è¡¨ç¤ºçš„å¸¦ç¬¦å·æ•°æ—¶ï¼ŒV&#x3D;1 è¡¨ç¤ºç¬¦å·ä½æº¢å‡ºï¼Œé€šå¸¸å…¶ä»–ä½ä¸å½±å“ V ä½ã€‚<br>Q(bit27)ï¼šä»… ARM v5TE_J æ¶æ„æ”¯æŒï¼Œè¡¨ç¤ºé¥±å’ŒçŠ¶æ€ï¼ŒQ&#x3D;1 è¡¨ç¤ºç´¯ç§¯é¥±å’Œï¼ŒQ&#x3D;0 è¡¨ç¤ºç´¯ç§¯ä¸é¥±å’Œã€‚<br>IT<a href="bit26:25">1:0</a>ï¼šå’Œ IT<a href="bit15:bit10">7:2</a>ä¸€èµ·ç»„æˆ IT[7:0]ï¼Œä½œä¸º IF-THEN æŒ‡ä»¤æ‰§è¡ŒçŠ¶æ€ã€‚<br>J(bit24)ï¼šä»… ARM_v5TE-J æ¶æ„æ”¯æŒï¼ŒJ&#x3D;1 è¡¨ç¤ºå¤„äº Jazelle çŠ¶æ€ï¼Œæ­¤ä½é€šå¸¸å’Œ T(bit5)ä½ä¸€èµ·è¡¨ç¤ºå½“å‰æ‰€ä½¿ç”¨çš„æŒ‡ä»¤é›†ã€‚<br>GE<a href="bit19:16">3:0</a>ï¼šSIMD æŒ‡ä»¤æœ‰æ•ˆï¼Œå¤§äºæˆ–ç­‰äºã€‚<br>IT<a href="bit15:10">7:2</a>ï¼šå‚è€ƒ IT[1:0]ã€‚<br>E(bit9)ï¼šå¤§å°ç«¯æ§åˆ¶ä½ï¼ŒE&#x3D;1 è¡¨ç¤ºå¤§ç«¯æ¨¡å¼ï¼ŒE&#x3D;0 è¡¨ç¤ºå°ç«¯æ¨¡å¼ã€‚<br>A(bit8)ï¼šç¦æ­¢å¼‚æ­¥ä¸­æ–­ä½ï¼ŒA&#x3D;1 è¡¨ç¤ºç¦æ­¢å¼‚æ­¥ä¸­æ–­ã€‚<br>I(bit7)ï¼šI&#x3D;1 ç¦æ­¢ IRQï¼ŒI&#x3D;0 ä½¿èƒ½ IRQã€‚<br>F(bit6)ï¼šF&#x3D;1 ç¦æ­¢ FIQï¼ŒF&#x3D;0 ä½¿èƒ½ FIQã€‚<br>T(bit5)ï¼šæ§åˆ¶æŒ‡ä»¤æ‰§è¡ŒçŠ¶æ€ï¼Œè¡¨æ˜æœ¬æŒ‡ä»¤æ˜¯ ARM æŒ‡ä»¤è¿˜æ˜¯ Thumb æŒ‡ä»¤ï¼Œé€šå¸¸å’Œ J(bit24)ä¸€èµ·è¡¨æ˜æŒ‡ä»¤ç±»å‹ï¼Œå‚è€ƒ J(bit24)ä½ã€‚<br>M[4:0]ï¼šå¤„ç†å™¨æ¨¡å¼æ§åˆ¶ä½</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230206_170546.png"></p><h3 id="ç‚¹äº®led"><a href="#ç‚¹äº®led" class="headerlink" title="ç‚¹äº®led"></a>ç‚¹äº®led</h3><p>åœ¨å¼€å§‹éƒ¨åˆ†ç”¨æ±‡ç¼–æ¥åˆå§‹åŒ–ä¸€ä¸‹ C è¯­è¨€ç¯å¢ƒï¼Œæ¯”å¦‚åˆå§‹åŒ– DDRã€è®¾ç½®å †æ ˆæŒ‡é’ˆ SP ç­‰ç­‰ï¼Œå½“è¿™äº›å·¥ä½œéƒ½åšå®Œä»¥åå°±å¯ä»¥è¿›å…¥ C è¯­è¨€ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯è¿è¡Œ C è¯­è¨€ä»£ç ï¼Œä¸€èˆ¬éƒ½æ˜¯è¿›å…¥ main å‡½æ•°ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰ä¸¤éƒ¨åˆ†æ–‡ä»¶è¦åšï¼š<br>â‘ ã€æ±‡ç¼–æ–‡ä»¶ï¼šæ±‡ç¼–æ–‡ä»¶åªæ˜¯ç”¨æ¥å®Œæˆ C è¯­è¨€ç¯å¢ƒæ­å»ºã€‚<br>â‘¡ã€C è¯­è¨€æ–‡ä»¶ï¼šC è¯­è¨€æ–‡ä»¶å°±æ˜¯å®Œæˆæˆ‘ä»¬çš„ä¸šåŠ¡å±‚ä»£ç çš„ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬å®é™…ä¾‹ç¨‹è¦å®Œæˆçš„åŠŸèƒ½ã€‚</p><p>start.sæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1 .global _start /* å…¨å±€æ ‡å· */</span><br><span class="line">2 </span><br><span class="line">3 /*</span><br><span class="line">4 * æè¿°ï¼š _start å‡½æ•°ï¼Œç¨‹åºä»æ­¤å‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œæ­¤å‡½æ•°ä¸»è¦åŠŸèƒ½æ˜¯è®¾ç½® C</span><br><span class="line">5 * è¿è¡Œç¯å¢ƒã€‚</span><br><span class="line">6 */</span><br><span class="line">7 _start:</span><br><span class="line">8 </span><br><span class="line">9 /* è¿›å…¥ SVC æ¨¡å¼ */</span><br><span class="line">10 mrs r0, cpsr</span><br><span class="line">11 bic r0, r0, #0x1f /* å°† r0 çš„ä½ 5 ä½æ¸…é›¶ï¼Œä¹Ÿå°±æ˜¯ cpsr çš„ M0~M4 */</span><br><span class="line">12 orr r0, r0, #0x13 /* r0 æˆ–ä¸Š 0x13,è¡¨ç¤ºä½¿ç”¨ SVC æ¨¡å¼ */</span><br><span class="line">13 msr cpsr, r0 /* å°† r0 çš„æ•°æ®å†™å…¥åˆ° cpsr_c ä¸­ */</span><br><span class="line">14</span><br><span class="line">15 ldr sp, =0X80200000 /* è®¾ç½®æ ˆæŒ‡é’ˆ */</span><br><span class="line">16 b main /* è·³è½¬åˆ° main å‡½æ•° */</span><br></pre></td></tr></table></figure><p>ç¬¬ 1 è¡Œå®šä¹‰äº†ä¸€ä¸ªå…¨å±€æ ‡å·_startã€‚<br>ç¬¬ 7 è¡Œå°±æ˜¯æ ‡å·_start å¼€å§‹çš„åœ°æ–¹ï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ª_start å‡½æ•°ï¼Œè¿™ä¸ª_start å°±æ˜¯ç¬¬ä¸€è¡Œä»£ç ã€‚<br>ç¬¬ 10<del>13 è¡Œå°±æ˜¯è®¾ç½®å¤„ç†å™¨è¿›å…¥ SVC æ¨¡å¼ï¼Œåœ¨ 6.2 å°èŠ‚çš„â€œCortex-A å¤„ç†å™¨è¿è¡Œæ¨¡å‹â€ä¸­ï¼Œè®¾ç½®å¤„ç†å™¨è¿è¡Œåœ¨ SVC æ¨¡å¼ä¸‹ã€‚å¤„ç†å™¨æ¨¡å¼çš„è®¾ç½®æ˜¯é€šè¿‡ä¿®æ”¹ CPSR(ç¨‹åºçŠ¶æ€)å¯„å­˜å™¨æ¥å®Œæˆçš„ï¼Œå…¶ä¸­ M[4:0](CPSR çš„ bit[4:0])å°±æ˜¯è®¾ç½®å¤„ç†å™¨è¿è¡Œæ¨¡å¼çš„ï¼Œå¦‚æœè¦å°†å¤„ç†å™¨è®¾ç½®ä¸º SVC æ¨¡å¼ï¼Œé‚£ä¹ˆ M[4:0]å°±è¦ç­‰äº 0X13ã€‚11</del>13 è¡Œä»£ç å°±æ˜¯å…ˆä½¿ç”¨æŒ‡ä»¤ MRS å°† CPSRå¯„å­˜å™¨çš„å€¼è¯»å–åˆ° R0 ä¸­ï¼Œç„¶åä¿®æ”¹ R0 ä¸­çš„å€¼ï¼Œè®¾ç½® R0 çš„ bit[4:0]ä¸º 0X13ï¼Œç„¶åå†ä½¿ç”¨æŒ‡ä»¤MSR å°†ä¿®æ”¹åçš„ R0 é‡æ–°å†™å…¥åˆ° CPSR ä¸­ã€‚<br>ç¬¬ 15 è¡Œé€šè¿‡ ldr æŒ‡ä»¤è®¾ç½® SVC æ¨¡å¼ä¸‹çš„ SP æŒ‡é’ˆ&#x3D;0X80200000ï¼Œå› ä¸º I.MX6U-ALPHA å¼€å‘æ¿ä¸Šçš„ DDR3 åœ°å€èŒƒå›´ æ˜¯ 0X80000000<del>0XA0000000(512MB) æˆ– è€…0X80000000</del>0X90000000(256MB)ï¼Œä¸ç®¡æ˜¯ 512MB ç‰ˆæœ¬è¿˜æ˜¯ 256MB ç‰ˆæœ¬çš„ï¼Œå…¶ DDR3 èµ·å§‹åœ°å€éƒ½æ˜¯ 0X80000000ã€‚ç”±äº Cortex-A7 çš„å †æ ˆæ˜¯å‘ä¸‹å¢é•¿çš„ï¼Œæ‰€ä»¥å°† SP æŒ‡é’ˆè®¾ç½®ä¸º 0X80200000ï¼Œå› æ­¤ SVC æ¨¡å¼çš„æ ˆå¤§å° 0X80200000-0X80000000&#x3D;0X200000&#x3D;2MBï¼Œ2MB çš„æ ˆç©ºé—´å·²ç»å¾ˆå¤§äº†ï¼Œå¦‚æœåšè£¸æœºå¼€å‘çš„è¯ç»°ç»°æœ‰ä½™ã€‚<br>ç¬¬ 16 è¡Œå°±æ˜¯è·³è½¬åˆ° main å‡½æ•°ï¼Œmain å‡½æ•°å°±æ˜¯ C è¯­è¨€ä»£ç äº†ã€‚<br>è‡³æ­¤æ±‡ç¼–éƒ¨åˆ†ç¨‹åºæ‰§è¡Œå®Œæˆï¼Œå°±å‡ è¡Œä»£ç ï¼Œç”¨æ¥è®¾ç½®å¤„ç†å™¨è¿è¡Œåˆ° SVC æ¨¡å¼ä¸‹ã€ç„¶ååˆå§‹åŒ– SP æŒ‡é’ˆã€æœ€ç»ˆè·³è½¬åˆ° C æ–‡ä»¶çš„ main å‡½æ•°ä¸­ã€‚</p><p>ç¼–å†™led.hæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __LED_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __LED_H</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * CCM ç›¸å…³å¯„å­˜å™¨åœ°å€</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> CCM_CCGR0 *((volatile unsigned int *)0X020C4068)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> CCM_CCGR1 *((volatile unsigned int *)0X020C406C)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> CCM_CCGR2 *((volatile unsigned int *)0X020C4070)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> CCM_CCGR3 *((volatile unsigned int *)0X020C4074)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> CCM_CCGR4 *((volatile unsigned int *)0X020C4078)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> CCM_CCGR5 *((volatile unsigned int *)0X020C407C)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> CCM_CCGR6 *((volatile unsigned int *)0X020C4080)</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* </span></span><br><span class="line"><span class="comment"> * IOMUX ç›¸å…³å¯„å­˜å™¨åœ°å€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> SW_MUX_GPIO1_IO03 *((volatile unsigned int *)0X020E0068)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> SW_PAD_GPIO1_IO03 *((volatile unsigned int *)0X020E02F4)</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* </span></span><br><span class="line"><span class="comment"> * GPIO1 ç›¸å…³å¯„å­˜å™¨åœ°å€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> GPIO1_DR *((volatile unsigned int *)0X0209C000)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> GPIO1_GDIR *((volatile unsigned int *)0X0209C004)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> GPIO1_PSR *((volatile unsigned int *)0X0209C008)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> GPIO1_ICR1 *((volatile unsigned int *)0X0209C00C)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> GPIO1_ICR2 *((volatile unsigned int *)0X0209C010)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> GPIO1_IMR *((volatile unsigned int *)0X0209C014)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> GPIO1_ISR *((volatile unsigned int *)0X0209C018)</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> GPIO1_EDGE_SEL *((volatile unsigned int *)0X0209C01C)</span></span><br><span class="line"></span><br><span class="line"> <span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>ç¼–å†™led.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;led.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  @description : ä½¿èƒ½ I.MX6U æ‰€æœ‰å¤–è®¾æ—¶é’Ÿ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">clk_enable</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"> &#123;</span><br><span class="line"> CCM_CCGR0 = <span class="number">0xffffffff</span>;</span><br><span class="line"> CCM_CCGR1 = <span class="number">0xffffffff</span>;</span><br><span class="line"> CCM_CCGR2 = <span class="number">0xffffffff</span>;</span><br><span class="line">CCM_CCGR3 = <span class="number">0xffffffff</span>;</span><br><span class="line">CCM_CCGR4 = <span class="number">0xffffffff</span>;</span><br><span class="line">CCM_CCGR5 = <span class="number">0xffffffff</span>;</span><br><span class="line">CCM_CCGR6 = <span class="number">0xffffffff</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  @description : åˆå§‹åŒ– LED å¯¹åº”çš„ GPIO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">/* 1ã€åˆå§‹åŒ– IO å¤ç”¨, å¤ç”¨ä¸º GPIO1_IO03 */</span></span><br><span class="line"> SW_MUX_GPIO1_IO03 = <span class="number">0x5</span>;  </span><br><span class="line"> <span class="comment">/* 2ã€é…ç½® GPIO1_IO03 çš„ IO å±æ€§ </span></span><br><span class="line"><span class="comment">bit 16:0 HYS å…³é—­</span></span><br><span class="line"><span class="comment">bit [15:14]: 00 é»˜è®¤ä¸‹æ‹‰</span></span><br><span class="line"><span class="comment"> bit [13]: 0 kepper åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> bit [12]: 1 pull/keeper ä½¿èƒ½</span></span><br><span class="line"><span class="comment"> bit [11]: 0 å…³é—­å¼€è·¯è¾“å‡º</span></span><br><span class="line"><span class="comment"> bit [7:6]: 10 é€Ÿåº¦ 100Mhz</span></span><br><span class="line"><span class="comment"> bit [5:3]: 110 R0/6 é©±åŠ¨èƒ½åŠ›</span></span><br><span class="line"><span class="comment"> bit [0]: 0 ä½è½¬æ¢ç‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SW_PAD_GPIO1_IO03 = <span class="number">0X10B0</span>; </span><br><span class="line"> <span class="comment">/* 3ã€åˆå§‹åŒ– GPIO, GPIO1_IO03 è®¾ç½®ä¸ºè¾“å‡º */</span></span><br><span class="line">GPIO1_GDIR = <span class="number">0X0000008</span>;</span><br><span class="line"> <span class="comment">/* 4ã€è®¾ç½® GPIO1_IO03 è¾“å‡ºä½ç”µå¹³ï¼Œæ‰“å¼€ LED0 */</span></span><br><span class="line">GPIO1_DR = <span class="number">0X0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">   æ‰“å¼€ LED ç¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">led_on</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">/* </span></span><br><span class="line"><span class="comment"> * å°† GPIO1_DR çš„ bit3 æ¸…é›¶ </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> GPIO1_DR &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description : å…³é—­ LED ç¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="type">void</span> <span class="title function_">led_off</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">   * å°† GPIO1_DR çš„ bit3 ç½® 1</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"> GPIO1_DR |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * @description : çŸ­æ—¶é—´å»¶æ—¶å‡½æ•°</span></span><br><span class="line"><span class="comment">   * @param - n : è¦å»¶æ—¶å¾ªç¯æ¬¡æ•°(ç©ºæ“ä½œå¾ªç¯æ¬¡æ•°ï¼Œæ¨¡å¼å»¶æ—¶)</span></span><br><span class="line"><span class="comment">   * @return : æ— </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_short</span><span class="params">(<span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">while</span>(n--)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description : å»¶æ—¶å‡½æ•°,åœ¨ 396Mhz çš„ä¸»é¢‘ä¸‹å»¶æ—¶æ—¶é—´å¤§çº¦ä¸º 1ms</span></span><br><span class="line"><span class="comment"> * @param - n : è¦å»¶æ—¶çš„ ms æ•°</span></span><br><span class="line"><span class="comment"> * @return : æ— </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay</span><span class="params">(<span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">while</span>(n--)</span><br><span class="line">&#123;</span><br><span class="line"> delay_short(<span class="number">0x7ff</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"> &#123;</span><br><span class="line"> clk_enable(); <span class="comment">/* ä½¿èƒ½æ‰€æœ‰çš„æ—¶é’Ÿ */</span></span><br><span class="line"> led_init(); <span class="comment">/* åˆå§‹åŒ– led */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span>(<span class="number">1</span>) <span class="comment">/* æ­»å¾ªç¯ */</span></span><br><span class="line">&#123; </span><br><span class="line"> led_off(); <span class="comment">/* å…³é—­ LED */</span></span><br><span class="line"> delay(<span class="number">500</span>); <span class="comment">/* å»¶æ—¶å¤§çº¦ 500ms */</span></span><br><span class="line">led_on(); <span class="comment">/* æ‰“å¼€ LED */</span></span><br><span class="line"> delay(<span class="number">500</span>); <span class="comment">/* å»¶æ—¶å¤§çº¦ 500ms */</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±ç¼–å†™Makefileæ–‡ä»¶</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">objects: start.o led.o</span></span><br><span class="line"><span class="section">ledc.bin:<span class="variable">$(objects)</span></span></span><br><span class="line">arm-linux-gnuebihf-ld -Ttext 0X8780000 -o ledc.elf start.o led.o</span><br><span class="line">arm-linux-gnuebihf-objcopy -O binary -S ledc.edf ledc.bin</span><br><span class="line">arm-linux-gnueabihf-objdump -D -m arm ledc.elf &gt; ledc.dis</span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.s</span></span><br><span class="line">arm-linux-gnueabihf-gcc -Wall -nostdlib -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line"><span class="section">%.o:%.S</span></span><br><span class="line">arm-linux-gnueabihf-gcc -Wall -nostdlib -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line"><span class="section">%.o:%.c</span></span><br><span class="line">arm-linux-gnueabihf-gcc -Wall -nostdlib -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm-rf *.o ledc.bin ledc.elf ledc.dis</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œå®šä¹‰å˜é‡ï¼Œç¬¬äºŒè¡Œé»˜è®¤ç›®æ ‡ç›®çš„æ˜¯ç”Ÿæˆstart.o å’Œled.oï¼Œä¹‹åæ˜¯ä½¿ç”¨arm-linux-gnueabihf-ldè¿›è¡Œé“¾æ¥ï¼Œé“¾æ¥åœ°å€æ˜¯0X87800000,ä¹‹åæ˜¯ç¼–è¯‘ä¸ºledc.binæ–‡ä»¶ï¼Œåœ¨ä¹‹åæ˜¯åæ±‡ç¼–ï¼Œç¬¬ä¸ƒè¡Œæ˜¯é’ˆå¯¹ä¸åŒæ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„.oæ–‡ä»¶ï¼Œç”¨åˆ°äº†è‡ªåŠ¨å˜é‡$@å’Œ$&lt;,å…¶ä¸­â€œ$&lt;â€çš„æ„æ€æ˜¯ä¾èµ–ç›®æ ‡é›†åˆçš„ç¬¬ä¸€ä¸ªæ–‡ä»¶</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230206_230300.png"></p><h4 id="é“¾æ¥è„šæœ¬ç¼–å†™æ ¼å¼"><a href="#é“¾æ¥è„šæœ¬ç¼–å†™æ ¼å¼" class="headerlink" title="é“¾æ¥è„šæœ¬ç¼–å†™æ ¼å¼"></a>é“¾æ¥è„šæœ¬ç¼–å†™æ ¼å¼</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1 SECTIONS&#123;</span><br><span class="line">2 . = 0X10000000;</span><br><span class="line">3 .text : &#123;*(.text)&#125;</span><br><span class="line">4 . = 0X30000000;</span><br><span class="line">5 .data ALIGN(4) : &#123; *(.data) &#125; </span><br><span class="line">6 .bss ALIGN(4) : &#123; *(.bss) &#125; </span><br><span class="line">7 &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 1 è¡Œæˆ‘ä»¬å…ˆå†™äº†ä¸€ä¸ªå…³é”®å­—â€œSECTIONSâ€ï¼Œåé¢è·Ÿäº†ä¸€ä¸ªå¤§æ‹¬å·ï¼Œè¿™ä¸ªå¤§æ‹¬å·å’Œç¬¬ 7 è¡Œçš„å¤§æ‹¬å·æ˜¯ä¸€å¯¹ï¼Œè¿™æ˜¯å¿…é¡»çš„ã€‚çœ‹èµ·æ¥å°±è·Ÿ C è¯­è¨€é‡Œé¢çš„å‡½æ•°ä¸€æ ·ã€‚<br>ç¬¬ 2 è¡Œå¯¹ä¸€ä¸ªç‰¹æ®Šç¬¦å·â€œ.â€è¿›è¡Œèµ‹å€¼ï¼Œâ€œ.â€åœ¨é“¾æ¥è„šæœ¬é‡Œé¢å«åšå®šä½è®¡æ•°å™¨ï¼Œé»˜è®¤çš„å®šä½è®¡æ•°å™¨ä¸º 0ã€‚æˆ‘ä»¬è¦æ±‚ä»£ç é“¾æ¥åˆ°ä»¥ 0X10000000 ä¸ºèµ·å§‹åœ°å€çš„åœ°æ–¹ï¼Œå› æ­¤è¿™ä¸€è¡Œç»™â€œ.â€èµ‹å€¼0X10000000ï¼Œè¡¨ç¤ºä»¥ 0X10000000 å¼€å§‹ï¼Œåé¢çš„æ–‡ä»¶æˆ–è€…æ®µéƒ½ä¼šä»¥ 0X10000000 ä¸ºèµ·å§‹åœ°å€å¼€å§‹é“¾æ¥ã€‚<br>ç¬¬ 3 è¡Œçš„â€œ.textâ€æ˜¯æ®µåï¼Œåé¢çš„å†’å·æ˜¯è¯­æ³•è¦æ±‚ï¼Œå†’å·åé¢çš„å¤§æ‹¬å·é‡Œé¢å¯ä»¥å¡«ä¸Šè¦é“¾æ¥åˆ°â€œ.textâ€è¿™ä¸ªæ®µé‡Œé¢çš„æ‰€æœ‰æ–‡ä»¶ï¼Œâ€œ*(.text)â€ä¸­çš„â€œ*â€æ˜¯é€šé…ç¬¦ï¼Œè¡¨ç¤ºæ‰€æœ‰è¾“å…¥æ–‡ä»¶çš„.textæ®µéƒ½æ”¾åˆ°â€œ.textâ€ä¸­ã€‚<br>ç¬¬ 4 è¡Œï¼Œæˆ‘ä»¬çš„è¦æ±‚æ˜¯æ•°æ®æ”¾åˆ° 0X30000000 å¼€å§‹çš„åœ°æ–¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡æ–°è®¾ç½®å®šä½è®¡æ•°å™¨â€œ.â€ï¼Œå°†å…¶æ”¹ä¸º 0X30000000ã€‚å¦‚æœä¸é‡æ–°è®¾ç½®çš„è¯ä¼šæ€ä¹ˆæ ·ï¼Ÿå‡è®¾â€œ.textâ€æ®µå¤§å°ä¸º 0X10000ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„.data æ®µå¼€å§‹åœ°å€å°±æ˜¯ 0X10000000+0X10000&#x3D;0X10010000ï¼Œè¿™æ˜æ˜¾ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚æ‰€ä»¥æˆ‘ä»¬å¿…é¡»è°ƒæ•´å®šä½è®¡æ•°å™¨ä¸º 0X30000000ã€‚<br>ç¬¬ 5 è¡Œè·Ÿç¬¬ 3 è¡Œä¸€æ ·ï¼Œå®šä¹‰äº†ä¸€ä¸ªåä¸ºâ€œ.dataâ€çš„æ®µï¼Œç„¶åæ‰€æœ‰æ–‡ä»¶çš„â€œ.dataâ€æ®µéƒ½æ”¾åˆ°è¿™é‡Œé¢ã€‚ä½†æ˜¯è¿™ä¸€è¡Œå¤šäº†ä¸€ä¸ªâ€œALIGN(4)â€ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè¿™æ˜¯ç”¨æ¥å¯¹â€œ.dataâ€è¿™ä¸ªæ®µçš„èµ·å§‹åœ°å€åšå­—èŠ‚å¯¹é½çš„ï¼ŒALIGN(4)è¡¨ç¤º 4 å­—èŠ‚å¯¹é½ã€‚ä¹Ÿå°±æ˜¯è¯´æ®µâ€œ.dataâ€çš„èµ·å§‹åœ°å€è¦èƒ½è¢« 4 æ•´é™¤ï¼Œä¸€èˆ¬å¸¸è§çš„éƒ½æ˜¯ ALIGN(4)æˆ–è€… ALIGN(8)ï¼Œä¹Ÿå°±æ˜¯ 4 å­—èŠ‚æˆ–è€… 8 å­—èŠ‚å¯¹é½ã€‚<br>ç¬¬ 6 è¡Œå®šä¹‰äº†ä¸€ä¸ªâ€œ.bssâ€æ®µï¼Œæ‰€æœ‰æ–‡ä»¶ä¸­çš„â€œ.bssâ€æ•°æ®éƒ½ä¼šè¢«æ”¾åˆ°è¿™ä¸ªé‡Œé¢ï¼Œâ€œ.bssâ€æ•°æ®å°±æ˜¯é‚£äº›å®šä¹‰äº†ä½†æ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–çš„å˜é‡ã€‚ä¸Šé¢å°±æ˜¯é“¾æ¥è„šæœ¬æœ€åŸºæœ¬çš„è¯­æ³•æ ¼å¼ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±æŒ‰ç…§è¿™ä¸ªåŸºæœ¬çš„è¯­æ³•æ ¼å¼æ¥ç¼–å†™æˆ‘ä»¬æœ¬è¯•éªŒçš„é“¾æ¥è„šæœ¬ï¼Œæˆ‘ä»¬æœ¬è¯•éªŒçš„é“¾æ¥è„šæœ¬è¦æ±‚å¦‚ä¸‹ï¼š<br>â‘ ã€é“¾æ¥èµ·å§‹åœ°å€ä¸º 0X87800000ã€‚<br>â‘¡ã€start.o è¦è¢«é“¾æ¥åˆ°æœ€å¼€å§‹çš„åœ°æ–¹ï¼Œå› ä¸º start.o é‡Œé¢åŒ…å«è¿™ç¬¬ä¸€ä¸ªè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚</p><h5 id="imx6ul-lds-é“¾æ¥è„šæœ¬ä»£ç "><a href="#imx6ul-lds-é“¾æ¥è„šæœ¬ä»£ç " class="headerlink" title="imx6ul.lds é“¾æ¥è„šæœ¬ä»£ç "></a>imx6ul.lds é“¾æ¥è„šæœ¬ä»£ç </h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1 SECTIONS&#123;</span><br><span class="line">2 . = 0X87800000;</span><br><span class="line">3 .text :</span><br><span class="line">4 &#123;</span><br><span class="line">5 start.o </span><br><span class="line">6led.o </span><br><span class="line">7 *(.text)</span><br><span class="line">8 &#125;</span><br><span class="line">9 .rodata ALIGN(4) : &#123;*(.rodata*)&#125; </span><br><span class="line">10 .data ALIGN(4) : &#123; *(.data) &#125; </span><br><span class="line">11 __bss_start = .; </span><br><span class="line">12 .bss ALIGN(4) : &#123; *(.bss) *(COMMON) &#125; </span><br><span class="line">13 __bss_end = .;</span><br><span class="line">14 &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ 11ã€13 è¿™ä¸¤è¡Œå…¶å®å°±æ˜¯å¯¹è¿™ä¸¤ä¸ªç¬¦å·è¿›è¡Œèµ‹å€¼ï¼Œå…¶å€¼ä¸ºå®šä½ç¬¦â€œ.â€ï¼Œè¿™ä¸¤ä¸ªç¬¦å·ç”¨æ¥ä¿å­˜.bss æ®µçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€,å‰é¢è¯´äº†.bss æ®µæ˜¯å®šä¹‰äº†ä½†æ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–çš„å˜é‡ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å¯¹.bss æ®µçš„å˜é‡æ¸…é›¶çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“.bss æ®µçš„èµ·å§‹å’Œç»“æŸåœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬ç›´æ¥å¯¹è¿™æ®µå†…å­˜èµ‹ 0 å³å¯å®Œæˆæ¸…é›¶ã€‚é€šè¿‡ç¬¬ 11ã€13 è¡Œä»£ç ï¼Œ.bss æ®µçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€å°±ä¿å­˜åœ¨äº†â€œ__bss_startâ€å’Œâ€œ__bss_endâ€ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨æ±‡ç¼–æˆ–è€… C æ–‡ä»¶é‡Œé¢ä½¿ç”¨è¿™ä¸¤ä¸ªç¬¦å·ã€‚</p><h5 id="ä¿®æ”¹-Makefile"><a href="#ä¿®æ”¹-Makefile" class="headerlink" title="ä¿®æ”¹ Makefile"></a>ä¿®æ”¹ Makefile</h5><p>å·²ç»ç¼–å†™å¥½äº†é“¾æ¥è„šæœ¬æ–‡ä»¶ï¼šimx6ul.ldsï¼Œå°† Makefile ä¸­çš„å¦‚ä¸‹ä¸€è¡Œä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-ld -Ttext 0X87800000 -o ledc.elf $^</span><br></pre></td></tr></table></figure><p>æ”¹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-ld -Timx6ul.lds -o ledc.elf $^</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ±‡ç¼–ç‚¹äº®led</title>
      <link href="/2023/02/05/2023-2-5-%E6%B1%87%E7%BC%96%E7%82%B9%E4%BA%AEled/"/>
      <url>/2023/02/05/2023-2-5-%E6%B1%87%E7%BC%96%E7%82%B9%E4%BA%AEled/</url>
      
        <content type="html"><![CDATA[<p>I.MX6ULLçš„IOåˆ†ä¸ºSNVSåŸŸå€¼å’Œé€šç”¨çš„ã€‚</p><p>ç‚¹äº®ledçš„GPIOéœ€è¦ä»¥ä¸‹è®¾ç½®ï¼š</p><p>â‘ ã€ä½¿èƒ½ GPIO å¯¹åº”çš„æ—¶é’Ÿã€‚<br>â‘¡ã€è®¾ç½®å¯„å­˜å™¨ IOMUXC_SW_MUX_CTL_PAD_XX_XXï¼Œè®¾ç½® IO çš„å¤ç”¨åŠŸèƒ½ï¼Œä½¿å…¶å¤ç”¨<br>ä¸º GPIO åŠŸèƒ½ã€‚<br>â‘¢ã€è®¾ç½®å¯„å­˜å™¨ IOMUXC_SW_PAD_CTL_PAD_XX_XXï¼Œè®¾ç½® IO çš„ä¸Šä¸‹æ‹‰ã€é€Ÿåº¦ç­‰ç­‰ã€‚<br>â‘£ã€ç¬¬â‘¡æ­¥å·²ç»å°† IO å¤ç”¨ä¸ºäº† GPIO åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦é…ç½® GPIOï¼Œè®¾ç½®è¾“å…¥&#x2F;è¾“å‡ºã€æ˜¯å¦ä½¿<br>ç”¨ä¸­æ–­ã€é»˜è®¤è¾“å‡ºç”µå¹³ç­‰ã€‚</p><p>1.é¦–å…ˆæ˜¯å®šä¹‰å…¨å±€æ ‡å·_start,ä»£ç æ˜¯ä»è¿™å¼€å§‹ç»­å†™ã€‚</p><p>2.åƒstm32ä¸€æ ·ä½¿èƒ½æ—¶é’Ÿï¼Œé¦–å…ˆæ˜¯æŸ¥è¯¢æ‰‹å†ŒæŸ¥æ‰¾æ¯ä¸€ä¸ªCCGRçš„åœ°å€å¹¶å°†å…¶è¿›è¡Œç½®1ï¼Œä¸ºç‚¹äº®ledï¼Œä½¿GPIOè¿›è¡Œå¤ç”¨ã€‚æŸ¥è¯¢æ‰‹å†Œå¯»æ‰¾SW_MUX_GPIO_IO103_BASEçš„åœ°å€ï¼Œå¹¶ä¸”æŸ¥çœ‹æ‰‹å†ŒMUX_MODEå°†å…¶è®¾ç½®ä¸ºGPIOçš„è¾“å‡ºã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230205_220552.png"></p><p>ä¼šæ˜¯ALT5æ¨¡å¼ç½®0101æ¥è°ƒä¸ºGPIOè¾“å‡ºï¼ŒGPIO1_IO00æœ‰ä¸¤ä¸ªä¹¦ç­¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO00<span class="comment">//é…ç½®å¤ç”¨æ¨¡å¼</span></span><br><span class="line">IOMUXC_SW_PAD_CTL_PAD_GPIO1_IO00<span class="comment">//é…ç½®ç”µæ°”å±æ€§</span></span><br></pre></td></tr></table></figure><p>3.æŸ¥è¯¢IOMUXC_SW_PAD_CTL_PAD_GPIO1_IO03çš„åœ°å€æ ¹æ®æ‰‹å†Œé…ç½®ç”µæ°”å±æ€§ã€‚</p><p>4.ä¹‹åé…ç½®GPIOä¸ºè¾“å‡ºæ¨¡å¼</p><p>5.GPIO1_IO03 å·²ç»é…ç½®å¥½äº†ï¼Œåªéœ€è¦å‘ GPIO1_DR å¯„å­˜å™¨çš„ bit3 å†™å…¥ 0 å³å¯æ§åˆ¶ GPIO1_IO03 è¾“å‡ºä½ç”µå¹³ï¼Œæ‰“å¼€ LEDï¼Œå‘ bit3 å†™å…¥ 1 å¯æ§åˆ¶ GPIO1_IO03 è¾“å‡ºé«˜ç”µå¹³ï¼Œå…³é—­ LEDã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">1 </span><br><span class="line">2 .global _start /* å…¨å±€æ ‡å· */</span><br><span class="line">3 </span><br><span class="line">4 /*</span><br><span class="line">5 * æè¿°ï¼š _start å‡½æ•°ï¼Œç¨‹åºä»æ­¤å‡½æ•°å¼€å§‹æ‰§è¡Œæ­¤å‡½æ•°å®Œæˆæ—¶é’Ÿä½¿èƒ½ã€</span><br><span class="line">6 * GPIO åˆå§‹åŒ–ã€æœ€ç»ˆæ§åˆ¶ GPIO è¾“å‡ºä½ç”µå¹³æ¥ç‚¹äº® LED ç¯ã€‚</span><br><span class="line">7 */</span><br><span class="line">8 _start:</span><br><span class="line">9 /* ä¾‹ç¨‹ä»£ç  */</span><br><span class="line">10 /* 1ã€ä½¿èƒ½æ‰€æœ‰æ—¶é’Ÿ */</span><br><span class="line">11 ldr r0, =0X020C4068 /* å¯„å­˜å™¨ CCGR0 */</span><br><span class="line">12 ldr r1, =0XFFFFFFFF </span><br><span class="line">13 str r1, [r0] </span><br><span class="line">14 </span><br><span class="line">15 ldr r0, =0X020C406C /* å¯„å­˜å™¨ CCGR1 */</span><br><span class="line">16 str r1, [r0]</span><br><span class="line">17</span><br><span class="line">18 ldr r0, =0X020C4070 /* å¯„å­˜å™¨ CCGR2 */</span><br><span class="line">19 str r1, [r0]</span><br><span class="line">20 </span><br><span class="line">21 ldr r0, =0X020C4074 /* å¯„å­˜å™¨ CCGR3 */</span><br><span class="line">22 str r1, [r0]</span><br><span class="line">23 </span><br><span class="line">24 ldr r0, =0X020C4078 /* å¯„å­˜å™¨ CCGR4 */</span><br><span class="line">25 str r1, [r0]</span><br><span class="line">26 </span><br><span class="line">27 ldr r0, =0X020C407C /* å¯„å­˜å™¨ CCGR5 */</span><br><span class="line">28 str r1, [r0]</span><br><span class="line">29 </span><br><span class="line">30 ldr r0, =0X020C4080 /* å¯„å­˜å™¨ CCGR6 */</span><br><span class="line">31 str r1, [r0]</span><br><span class="line">32 </span><br><span class="line">33</span><br><span class="line">34 /* 2ã€è®¾ç½® GPIO1_IO03 å¤ç”¨ä¸º GPIO1_IO03 */</span><br><span class="line">35 ldr r0, =0X020E0068 /* å°†å¯„å­˜å™¨ SW_MUX_GPIO1_IO03_BASE åŠ è½½åˆ° r0 ä¸­ */</span><br><span class="line">36 ldr r1, =0X5 /* è®¾ç½®å¯„å­˜å™¨ SW_MUX_GPIO1_IO03_BASE çš„ MUX_MODE ä¸º 5 */</span><br><span class="line">37 str r1,[r0]</span><br><span class="line">38</span><br><span class="line">39 /* 3ã€é…ç½® GPIO1_IO03 çš„ IO å±æ€§ </span><br><span class="line">40 *bit 16:0 HYS å…³é—­</span><br><span class="line">41 *bit [15:14]: 00 é»˜è®¤ä¸‹æ‹‰</span><br><span class="line">42 *bit [13]: 0 kepper åŠŸèƒ½</span><br><span class="line">43 *bit [12]: 1 pull/keeper ä½¿èƒ½</span><br><span class="line">44 *bit [11]: 0 å…³é—­å¼€è·¯è¾“å‡º</span><br><span class="line">45 *bit [7:6]: 10 é€Ÿåº¦ 100Mhz</span><br><span class="line">46 *bit [5:3]: 110 R0/6 é©±åŠ¨èƒ½åŠ›</span><br><span class="line">47 *bit [0]: 0 ä½è½¬æ¢ç‡</span><br><span class="line">48 */</span><br><span class="line">49 ldr r0, =0X020E02F4 /*å¯„å­˜å™¨ SW_PAD_GPIO1_IO03_BASE */</span><br><span class="line">50 ldr r1, =0X10B0/*æŠŠIOå±æ€§æŒ‰ç…§ä½æ¥è½¬æ¢æˆ16è¿›åˆ¶ä¹‹åç½®ä½*/</span><br><span class="line">51 str r1,[r0]</span><br><span class="line">52</span><br><span class="line">53 /* 4ã€è®¾ç½® GPIO1_IO03 ä¸ºè¾“å‡º */</span><br><span class="line">54 ldr r0, =0X0209C004 /*å¯„å­˜å™¨ GPIO1_GDIR */</span><br><span class="line">55 ldr r1, =0X0000008 </span><br><span class="line">56 str r1,[r0]</span><br><span class="line">57</span><br><span class="line">58 /* 5ã€æ‰“å¼€ LED0</span><br><span class="line">59 * è®¾ç½® GPIO1_IO03 è¾“å‡ºä½ç”µå¹³</span><br><span class="line">60 */</span><br><span class="line">61 ldr r0, =0X0209C000 /*å¯„å­˜å™¨ GPIO1_DR */</span><br><span class="line">62 ldr r1, =0 </span><br><span class="line">63 str r1,[r0]</span><br><span class="line">64</span><br><span class="line">65 /*</span><br><span class="line">66 * æè¿°ï¼š loop æ­»å¾ªç¯</span><br><span class="line">67 */</span><br><span class="line">68 loop:</span><br><span class="line">69 b loop</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>armæ±‡ç¼–</title>
      <link href="/2023/02/04/2023-2-4-arm%E6%B1%87%E7%BC%96/"/>
      <url>/2023/02/04/2023-2-4-arm%E6%B1%87%E7%BC%96/</url>
      
        <content type="html"><![CDATA[<h1 id="GNU-æ±‡ç¼–è¯­æ³•"><a href="#GNU-æ±‡ç¼–è¯­æ³•" class="headerlink" title="GNU æ±‡ç¼–è¯­æ³•"></a>GNU æ±‡ç¼–è¯­æ³•</h1><p>GNUæ±‡ç¼–è¯­æ³•é€‚ç”¨äºæ‰€æœ‰æ¶æ„ï¼Œæ¯æ¡è¯­å¥æœ‰ä¸‰ä¸ªå¯é€‰éƒ¨åˆ†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">labelï¼šinstruction @ comment</span><br></pre></td></tr></table></figure><p>label å³æ ‡å·ï¼Œè¡¨ç¤ºåœ°å€ä½ç½®ï¼Œæœ‰äº›æŒ‡ä»¤å‰é¢å¯èƒ½ä¼šæœ‰æ ‡å·ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ ‡å·å¾—åˆ°æŒ‡ä»¤çš„åœ°å€ï¼Œæ ‡å·ä¹Ÿå¯ä»¥ç”¨æ¥è¡¨ç¤ºæ•°æ®åœ°å€ã€‚æ³¨æ„ label åé¢çš„â€œï¼šâ€ï¼Œä»»ä½•ä»¥â€œï¼šâ€ç»“å°¾çš„æ ‡è¯†ç¬¦éƒ½ä¼šè¢«è¯†åˆ«ä¸ºä¸€ä¸ªæ ‡å·ã€‚<br>instruction å³æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯æ±‡ç¼–æŒ‡ä»¤æˆ–ä¼ªæŒ‡ä»¤ã€‚<br>@ç¬¦å·ï¼Œè¡¨ç¤ºåé¢çš„æ˜¯æ³¨é‡Šã€‚<br>comment å°±æ˜¯æ³¨é‡Šå†…å®¹ã€‚</p><p><strong>æ³¨æ„ï¼ARM ä¸­çš„æŒ‡ä»¤ã€ä¼ªæŒ‡ä»¤ã€ä¼ªæ“ä½œã€å¯„å­˜å™¨åç­‰å¯ä»¥å…¨éƒ¨ä½¿ç”¨å¤§å†™ï¼Œä¹Ÿå¯ä»¥å…¨éƒ¨ä½¿ç”¨å°å†™ï¼Œä½†æ˜¯ä¸èƒ½å¤§å°å†™æ··ç”¨ã€‚</strong></p><p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨.section ä¼ªæ“ä½œæ¥å®šä¹‰ä¸€ä¸ªæ®µï¼Œæ±‡ç¼–ç³»ç»Ÿé¢„å®šä¹‰äº†ä¸€äº›æ®µåï¼š<br>.text è¡¨ç¤ºä»£ç æ®µã€‚<br>.data åˆå§‹åŒ–çš„æ•°æ®æ®µã€‚<br>.bss æœªåˆå§‹åŒ–çš„æ•°æ®æ®µã€‚<br>.rodata åªè¯»æ•°æ®æ®µã€‚</p><p>å¸¸è§çš„ä¼ªæ“ä½œæœ‰ï¼š<br>.byte å®šä¹‰å•å­—èŠ‚æ•°æ®ï¼Œæ¯”å¦‚.byte 0x12ã€‚<br>.short å®šä¹‰åŒå­—èŠ‚æ•°æ®ï¼Œæ¯”å¦‚.short 0x1234ã€‚<br>.long å®šä¹‰ä¸€ä¸ª 4 å­—èŠ‚æ•°æ®ï¼Œæ¯”å¦‚.long 0x12345678ã€‚<br>.equ èµ‹å€¼è¯­å¥ï¼Œæ ¼å¼ä¸ºï¼š.equ å˜é‡åï¼Œè¡¨è¾¾å¼ï¼Œæ¯”å¦‚.equ num, 0x12ï¼Œè¡¨ç¤º num&#x3D;0x12ã€‚<br>.align æ•°æ®å­—èŠ‚å¯¹é½ï¼Œæ¯”å¦‚ï¼š.align 4 è¡¨ç¤º 4 å­—èŠ‚å¯¹é½ã€‚<br>.end è¡¨ç¤ºæºæ–‡ä»¶ç»“æŸã€‚<br>.global å®šä¹‰ä¸€ä¸ªå…¨å±€ç¬¦å·ï¼Œæ ¼å¼ä¸ºï¼š.global symbolï¼Œæ¯”å¦‚ï¼š.global _startã€‚</p><h3 id="å†…éƒ¨ä¼ è¾“æŒ‡ä»¤"><a href="#å†…éƒ¨ä¼ è¾“æŒ‡ä»¤" class="headerlink" title="å†…éƒ¨ä¼ è¾“æŒ‡ä»¤"></a>å†…éƒ¨ä¼ è¾“æŒ‡ä»¤</h3><p><strong>MOVæŒ‡ä»¤</strong></p><p>MOV æŒ‡ä»¤ç”¨äºå°†æ•°æ®ä»ä¸€ä¸ªå¯„å­˜å™¨æ‹·è´åˆ°å¦å¤–ä¸€ä¸ªå¯„å­˜å™¨ï¼Œæˆ–è€…å°†ä¸€ä¸ªç«‹å³æ•°ä¼ é€’åˆ°å¯„å­˜å™¨é‡Œé¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV R0ï¼ŒR1 @å°†å¯„å­˜å™¨ R1 ä¸­çš„æ•°æ®ä¼ é€’ç»™ R0ï¼Œå³ R0=R1</span><br><span class="line">MOV R0, #0X12 @å°†ç«‹å³æ•° 0X12 ä¼ é€’ç»™ R0 å¯„å­˜å™¨ï¼Œå³ R0=0X12</span><br></pre></td></tr></table></figure><p><strong>MRSæŒ‡ä»¤</strong></p><p>MRS æŒ‡ä»¤ç”¨äºå°†ç‰¹æ®Šå¯„å­˜å™¨(å¦‚ CPSR å’Œ SPSR)ä¸­çš„æ•°æ®ä¼ é€’ç»™é€šç”¨å¯„å­˜å™¨ï¼Œè¦è¯»å–ç‰¹æ®Šå¯„å­˜å™¨çš„æ•°æ®åªèƒ½ä½¿MRS </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MRS R0, CPSR @å°†ç‰¹æ®Šå¯„å­˜å™¨ CPSR é‡Œé¢çš„æ•°æ®ä¼ é€’ç»™ R0ï¼Œå³ R0=CPSR</span><br></pre></td></tr></table></figure><p><strong>MSRæŒ‡ä»¤</strong></p><p>MSR æŒ‡ä»¤ç”¨æ¥å°†æ™®é€šå¯„å­˜å™¨çš„æ•°æ®ä¼ é€’ç»™ç‰¹æ®Šå¯„å­˜å™¨ï¼Œå†™ç‰¹æ®Šå¯„å­˜å™¨åªèƒ½ä½¿ç”¨MSR</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSR CPSR, R0 @å°† R0 ä¸­çš„æ•°æ®å¤åˆ¶åˆ° CPSR ä¸­ï¼Œå³ CPSR=R0</span><br></pre></td></tr></table></figure><p><strong>å­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤</strong></p><p>ARM ä¸èƒ½ç›´æ¥è®¿é—®å­˜å‚¨å™¨ï¼Œä¸€èˆ¬å…ˆå°†è¦é…ç½®çš„å€¼å†™å…¥åˆ° Rx(x&#x3D;0~12)å¯„å­˜å™¨ä¸­ï¼Œç„¶åå€ŸåŠ©å­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤å°† Rx ä¸­çš„æ•°æ®å†™å…¥åˆ° I.MX6UL å¯„å­˜å™¨ä¸­ã€‚å¸¸ç”¨çš„å­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤æœ‰ä¸¤ç§ï¼šLDR å’ŒSTRã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/capture_20230204195445731.bmp"></p><p>LDR ä¸»è¦ç”¨äºä»å­˜å‚¨åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨ Rx ä¸­ï¼ŒLDR ä¹Ÿå¯ä»¥å°†ä¸€ä¸ªç«‹å³æ•°åŠ è½½åˆ°å¯„å­˜å™¨ Rxä¸­ï¼ŒLDR åŠ è½½ç«‹å³æ•°çš„æ—¶å€™è¦ä½¿ç”¨â€œ&#x3D;â€ï¼Œè€Œä¸æ˜¯â€œ#â€ã€‚åœ¨åµŒå…¥å¼å¼€å‘ä¸­ï¼ŒLDR æœ€å¸¸ç”¨çš„å°±æ˜¯è¯»å– CPU çš„å¯„å­˜å™¨å€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 LDR R0, =0X0209C004 @å°†å¯„å­˜å™¨åœ°å€ 0X0209C004 åŠ è½½åˆ° R0 ä¸­ï¼Œå³ R0=0X0209C004</span><br><span class="line">2 LDR R1, [R0] @è¯»å–åœ°å€ 0X0209C004 ä¸­çš„æ•°æ®åˆ° R1 å¯„å­˜å™¨ä¸­</span><br></pre></td></tr></table></figure><p>STR å°±æ˜¯å°†æ•°æ®å†™å…¥åˆ°å­˜å‚¨å™¨ä¸­ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 LDR R0, =0X0209C004 @å°†å¯„å­˜å™¨åœ°å€ 0X0209C004 åŠ è½½åˆ° R0 ä¸­ï¼Œå³ R0=0X0209C004</span><br><span class="line">2 LDR R1, =0X20000002 @R1 ä¿å­˜è¦å†™å…¥åˆ°å¯„å­˜å™¨çš„å€¼ï¼Œå³ R1=0X20000002</span><br><span class="line">3 STR R1, [R0] @å°† R1 ä¸­çš„å€¼å†™å…¥åˆ° R0 ä¸­æ‰€ä¿å­˜çš„åœ°å€ä¸­</span><br></pre></td></tr></table></figure><p>LDR å’Œ STR éƒ½æ˜¯æŒ‰ç…§å­—è¿›è¡Œè¯»å–å’Œå†™å…¥çš„ï¼ˆæ“ä½œçš„ 32 ä½æ•°æ®ï¼‰ï¼Œå¦‚æœè¦æŒ‰ç…§å­—èŠ‚ã€åŠå­—è¿›è¡Œæ“ä½œçš„è¯å¯ä»¥åœ¨æŒ‡ä»¤â€œLDRâ€åé¢åŠ ä¸Š B æˆ– Hï¼Œæ¯”å¦‚æŒ‰å­—èŠ‚æ“ä½œçš„æŒ‡ä»¤å°±æ˜¯ LDRB å’ŒSTRBï¼ŒæŒ‰åŠå­—æ“ä½œçš„æŒ‡ä»¤å°±æ˜¯ LDRH å’Œ STRHã€‚</p><p><strong>å‹æ ˆå’Œå‡ºæ ˆå‘½ä»¤</strong></p><p>æˆ‘ä»¬é€šå¸¸ä¼šåœ¨ A å‡½æ•°ä¸­è°ƒç”¨ B å‡½æ•°ï¼Œå½“ B å‡½æ•°æ‰§è¡Œå®Œä»¥åå†å›åˆ° A å‡½æ•°ç»§ç»­æ‰§è¡Œã€‚è¦æƒ³å†è·³å› A å‡½æ•°ä»¥åä»£ç èƒ½å¤Ÿæ¥ç€æ­£å¸¸è¿è¡Œï¼Œé‚£å°±å¿…é¡»åœ¨è·³åˆ° B å‡½æ•°ä¹‹å‰å°†å½“å‰å¤„ç†å™¨çŠ¶æ€ä¿å­˜èµ·æ¥(å°±æ˜¯ä¿å­˜ R0<del>R15 è¿™äº›å¯„å­˜å™¨å€¼)ï¼Œå½“ B å‡½æ•°æ‰§è¡Œå®Œæˆä»¥åå†ç”¨å‰é¢ä¿å­˜çš„å¯„å­˜å™¨å€¼æ¢å¤R0</del>R15 å³å¯ã€‚ä¿å­˜ R0<del>R15 å¯„å­˜å™¨çš„æ“ä½œå°±å«åš<u>ç°åœºä¿æŠ¤</u>ï¼Œæ¢å¤ R0</del>R15 å¯„å­˜å™¨çš„æ“ä½œå°±å«åš<u>æ¢å¤ç°åœº</u>ã€‚<strong>åœ¨è¿›è¡Œç°åœºä¿æŠ¤çš„æ—¶å€™éœ€è¦è¿›è¡Œå‹æ ˆ(å…¥æ ˆ)æ“ä½œï¼Œæ¢å¤ç°åœºå°±è¦è¿›è¡Œå‡ºæ ˆæ“ä½œã€‚</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230204_200747.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUSH &#123;R0~R3, R12&#125; @å°† R0~R3 å’Œ R12 å‹æ ˆ</span><br><span class="line">PUSH &#123;LR&#125; @å°† LR è¿›è¡Œå‹æ ˆ</span><br><span class="line">POP &#123;LR&#125; @å…ˆæ¢å¤ LR</span><br><span class="line">POP &#123;R0~R3,R12&#125; @åœ¨æ¢å¤ R0~R3,R12</span><br></pre></td></tr></table></figure><p>PUSH å’Œ POP çš„å¦å¤–ä¸€ç§å†™æ³•æ˜¯â€œSTMFD SPï¼â€å’Œâ€œLDMFD SP!â€.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 STMFD SP!,&#123;R0~R3, R12&#125; @R0~R3,R12 å…¥æ ˆ</span><br><span class="line">2 STMFD SP!,&#123;LR&#125; @LR å…¥æ ˆ</span><br><span class="line">4 LDMFD SP!, &#123;LR&#125; @å…ˆæ¢å¤ LR</span><br><span class="line">5 LDMFD SP!, &#123;R0~R3, R12&#125; @å†æ¢å¤ R0~R3, R12</span><br></pre></td></tr></table></figure><p>SP æŒ‡å‘æœ€åä¸€ä¸ªå…¥æ ˆçš„æ•°å€¼ï¼Œå †æ ˆæ˜¯ç”±é«˜åœ°å€å‘ä¸‹å¢é•¿çš„ï¼Œä¹Ÿå°±æ˜¯å‰é¢è¯´çš„å‘ä¸‹å¢é•¿çš„å †æ ˆã€‚</p><p><strong>è·³è½¬æŒ‡ä»¤</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230204_202454.png"></p><p><strong>BæŒ‡ä»¤</strong></p><p>B æŒ‡ä»¤ä¼šå°† PC å¯„å­˜å™¨çš„å€¼è®¾ç½®ä¸ºè·³è½¬ç›®æ ‡åœ°å€ï¼Œ ä¸€æ—¦æ‰§è¡Œ B æŒ‡ä»¤ï¼ŒARM å¤„ç†å™¨å°±ä¼šç«‹å³è·³è½¬åˆ°æŒ‡å®šçš„ç›®æ ‡åœ°å€ã€‚å¦‚æœè¦è°ƒç”¨çš„å‡½æ•°ä¸ä¼šå†è¿”å›åˆ°åŸæ¥çš„æ‰§è¡Œå¤„ï¼Œé‚£å°±å¯ä»¥ç”¨ B æŒ‡ä»¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 _start:</span><br><span class="line">2</span><br><span class="line">3 ldr sp,=0X80200000 @è®¾ç½®æ ˆæŒ‡é’ˆ</span><br><span class="line">4 b main @è·³è½¬åˆ° main å‡½æ•°</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å°±æ˜¯å…¸å‹çš„åœ¨æ±‡ç¼–ä¸­åˆå§‹åŒ– C è¿è¡Œç¯å¢ƒï¼Œç„¶åè·³è½¬åˆ° C æ–‡ä»¶çš„ main å‡½æ•°ä¸­è¿è¡Œï¼Œåªæ˜¯åˆå§‹åŒ–äº† SP æŒ‡é’ˆï¼Œæœ‰äº›å¤„ç†å™¨è¿˜éœ€è¦åšå…¶ä»–çš„åˆå§‹åŒ–ï¼Œ</p><p><strong>BLæŒ‡ä»¤</strong></p><p>BL æŒ‡ä»¤ç›¸æ¯” B æŒ‡ä»¤ï¼Œåœ¨è·³è½¬ä¹‹å‰ä¼šåœ¨å¯„å­˜å™¨ LR(R14)ä¸­ä¿å­˜å½“å‰ PC å¯„å­˜å™¨å€¼ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å°† LR å¯„å­˜å™¨ä¸­çš„å€¼é‡æ–°åŠ è½½åˆ° PC ä¸­æ¥ç»§ç»­ä»è·³è½¬ä¹‹å‰çš„ä»£ç å¤„è¿è¡Œï¼Œè¿™æ˜¯å­ç¨‹åºè°ƒç”¨ä¸€ä¸ªåŸºæœ¬ä½†å¸¸ç”¨çš„æ‰‹æ®µã€‚æ¯”å¦‚ Cortex-A å¤„ç†å™¨çš„ irq ä¸­æ–­æœåŠ¡å‡½æ•°éƒ½æ˜¯æ±‡ç¼–å†™çš„ï¼Œä¸»è¦ç”¨æ±‡ç¼–æ¥å®ç°ç°åœºçš„ä¿æŠ¤å’Œæ¢å¤ã€è·å–ä¸­æ–­å·ç­‰ã€‚ä½†æ˜¯å…·ä½“çš„ä¸­æ–­å¤„ç†è¿‡ç¨‹éƒ½æ˜¯ C å‡½æ•°ï¼Œæ‰€ä»¥å°±ä¼šå­˜åœ¨æ±‡ç¼–ä¸­è°ƒç”¨ C å‡½æ•°çš„é—®é¢˜ã€‚è€Œä¸”å½“ C è¯­è¨€ç‰ˆæœ¬çš„ä¸­æ–­å¤„ç†å‡½æ•°æ‰§è¡Œå®Œæˆä»¥åæ˜¯éœ€è¦è¿”å›åˆ°irq æ±‡ç¼–ä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œå› ä¸ºè¿˜è¦å¤„ç†å…¶ä»–çš„å·¥ä½œï¼Œä¸€èˆ¬æ˜¯æ¢å¤ç°åœºã€‚è¿™ä¸ªæ—¶å€™å°±ä¸èƒ½ç›´æ¥ä½¿ç”¨B æŒ‡ä»¤äº†ï¼Œå› ä¸º B æŒ‡ä»¤ä¸€æ—¦è·³è½¬å°±å†ä¹Ÿä¸ä¼šå›æ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™è¦ä½¿ç”¨ BL æŒ‡ä»¤ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1 push &#123;r0, r1&#125; @ä¿å­˜ r0,r1</span><br><span class="line">2 cps #0x13 @è¿›å…¥ SVC æ¨¡å¼ï¼Œå…è®¸å…¶ä»–ä¸­æ–­å†æ¬¡è¿›å»</span><br><span class="line">3</span><br><span class="line">5 bl system_irqhandler @åŠ è½½ C è¯­è¨€ä¸­æ–­å¤„ç†å‡½æ•°åˆ° r2 å¯„å­˜å™¨ä¸­</span><br><span class="line">6</span><br><span class="line">7 cps #0x12 @è¿›å…¥ IRQ æ¨¡å¼</span><br><span class="line">8 pop &#123;r0, r1&#125; </span><br><span class="line">9 str r0, [r1, #0X10] @ä¸­æ–­æ‰§è¡Œå®Œæˆï¼Œå†™ EOIR</span><br></pre></td></tr></table></figure><p><strong>ç®—æ•°æŒ‡ä»¤</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230204_223246.png"></p><p><strong>é€»è¾‘è¿ç®—æŒ‡ä»¤</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230204_223427.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> è£¸æœºå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹</title>
      <link href="/2023/01/20/2023-1-20-%E7%BA%BF%E7%A8%8B/"/>
      <url>/2023/01/20/2023-1-20-%E7%BA%BF%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p>çº¿ç¨‹æ˜¯å‚ä¸ç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿è¡Œå•ä½ã€‚ä¸€ä¸ªçº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼ˆæˆ–è€…è¯´æ˜¯æ‰§è¡Œè·¯çº¿ã€æ‰§è¡Œæµï¼‰ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å®ç°å¹¶å‘è¿è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</p><p>ä»»ä½•ä¸€ä¸ªè¿›ç¨‹éƒ½åŒ…å«ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œåªæœ‰ä¸»çº¿ç¨‹çš„è¿›ç¨‹ç§°ä¸ºå•çº¿ç¨‹è¿›ç¨‹.</p><p>é‚£è‡ªç„¶å°±å­˜åœ¨å¤šçº¿ç¨‹è¿›ç¨‹ï¼Œæ‰€è°“å¤šçº¿ç¨‹æŒ‡çš„æ˜¯é™¤äº†ä¸»çº¿ç¨‹ä»¥å¤–ï¼Œè¿˜åŒ…å«å…¶å®ƒçš„çº¿ç¨‹ï¼Œå…¶å®ƒçº¿ç¨‹é€šå¸¸ç”±ä¸»çº¿ç¨‹æ¥åˆ›å»ºï¼ˆè°ƒç”¨pthread_create åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼‰ï¼Œé‚£ä¹ˆåˆ›å»ºçš„æ–°çº¿ç¨‹å°±æ˜¯ä¸»çº¿ç¨‹çš„å­çº¿ç¨‹ã€‚</p><p>ä¸»çº¿ç¨‹çš„é‡è¦æ€§ä½“ç°åœ¨ä¸¤æ–¹é¢ï¼š<br>âš« å…¶å®ƒæ–°çš„çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯å­çº¿ç¨‹ï¼‰æ˜¯ç”±ä¸»çº¿ç¨‹åˆ›å»ºçš„ï¼›<br>âš« ä¸»çº¿ç¨‹é€šå¸¸ä¼šåœ¨æœ€åç»“æŸè¿è¡Œï¼Œæ‰§è¡Œå„ç§æ¸…ç†å·¥ä½œï¼Œè­¬å¦‚å›æ”¶å„ä¸ªå­çº¿ç¨‹ã€‚</p><p>çº¿ç¨‹æ˜¯ç¨‹åºæœ€åŸºæœ¬çš„è¿è¡Œå•ä½ï¼Œè€Œè¿›ç¨‹ä¸èƒ½è¿è¡Œï¼ŒçœŸæ­£è¿è¡Œçš„æ˜¯è¿›ç¨‹ä¸­çš„çº¿ç¨‹ã€‚åŒä¸€è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å°†å…±äº«è¯¥è¿›ç¨‹ä¸­çš„å…¨éƒ¨ç³»ç»Ÿèµ„æºï¼Œå¦‚è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ–‡ä»¶æè¿°ç¬¦å’Œä¿¡å·å¤„ç†ç­‰ç­‰ã€‚ä½†åŒä¸€è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹æœ‰å„è‡ªçš„è°ƒç”¨æ ˆï¼ˆcall stackï¼Œæˆ‘ä»¬ç§°ä¸ºçº¿ç¨‹æ ˆï¼‰ï¼Œè‡ªå·±çš„å¯„å­˜å™¨ç¯å¢ƒï¼ˆregister contextï¼‰ã€è‡ªå·±çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆthread-local storageï¼‰ã€‚</p><p><strong>å¤šè¿›ç¨‹ç¼–ç¨‹çš„åŠ£åŠ¿ï¼š</strong><br>âš« è¿›ç¨‹é—´åˆ‡æ¢å¼€é”€å¤§ã€‚å¤šä¸ªè¿›ç¨‹åŒæ—¶è¿è¡Œï¼ˆæŒ‡å®è§‚ä¸ŠåŒæ—¶è¿è¡Œï¼Œæ— ç‰¹åˆ«è¯´æ˜ï¼Œå‡æŒ‡å®è§‚ä¸Šï¼‰ï¼Œå¾®è§‚ä¸Šä¾ç„¶æ˜¯è½®æµåˆ‡æ¢è¿è¡Œï¼Œè¿›ç¨‹é—´åˆ‡æ¢å¼€é”€è¿œå¤§äºåŒä¸€è¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹é—´åˆ‡æ¢çš„å¼€é”€ï¼Œé€šå¸¸å¯¹äºä¸€äº›ä¸­å°å‹åº”ç”¨ç¨‹åºæ¥è¯´ä¸åˆ’ç®—ã€‚<br>âš« è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºéº»çƒ¦ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨å„è‡ªçš„åœ°å€ç©ºé—´ä¸­ã€ç›¸äº’ç‹¬ç«‹ã€éš”ç¦»ï¼Œå¤„åœ¨äºä¸åŒçš„åœ°å€ç©ºé—´ä¸­ï¼Œå› æ­¤ç›¸äº’é€šä¿¡è¾ƒä¸ºéº»çƒ¦ï¼Œåœ¨ä¸Šä¸€ç« èŠ‚ç»™å¤§å®¶æœ‰æ‰€ä»‹ç»ã€‚<br>è§£å†³æ–¹æ¡ˆä¾¿æ˜¯ä½¿ç”¨å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¤šçº¿ç¨‹èƒ½å¤Ÿå¼¥è¡¥ä¸Šé¢çš„é—®é¢˜ï¼š<br>âš« åŒä¸€è¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹é—´åˆ‡æ¢å¼€é”€æ¯”è¾ƒå°ã€‚<br>âš« åŒä¸€è¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹é—´é€šä¿¡å®¹æ˜“ã€‚å®ƒä»¬å…±äº«äº†è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ˜¯åœ¨åŒä¸€ä¸ªåœ°å€ç©ºé—´ä¸­ï¼Œé€šä¿¡å®¹æ˜“ã€‚<br>âš« çº¿ç¨‹åˆ›å»ºçš„é€Ÿåº¦è¿œå¤§äºè¿›ç¨‹åˆ›å»ºçš„é€Ÿåº¦ã€‚<br>âš« å¤šçº¿ç¨‹åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šæ›´æœ‰ä¼˜åŠ¿ï¼</p><blockquote><p>å¹¶è¡Œï¼šå½“ç³»ç»Ÿæœ‰ä¸€ä¸ªä»¥ä¸ŠCPUæ—¶,åˆ™çº¿ç¨‹çš„æ“ä½œæœ‰å¯èƒ½éå¹¶å‘ã€‚å½“ä¸€ä¸ªCPUæ‰§è¡Œä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œå¦ä¸€ä¸ªCPUå¯ä»¥æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸¤ä¸ªçº¿ç¨‹äº’ä¸æŠ¢å CPUèµ„æºï¼Œå¯ä»¥åŒæ—¶è¿›è¡Œï¼Œè¿™ç§æ–¹å¼æˆ‘ä»¬ç§°ä¹‹ä¸ºå¹¶è¡Œ(Parallel)ã€‚<br>å¹¶å‘ï¼šå½“æœ‰å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œæ—¶,å¦‚æœç³»ç»Ÿåªæœ‰ä¸€ä¸ªCPU,åˆ™å®ƒæ ¹æœ¬ä¸å¯èƒ½çœŸæ­£åŒæ—¶è¿›è¡Œä¸€ä¸ªä»¥ä¸Šçš„çº¿ç¨‹ï¼Œå®ƒåªèƒ½æŠŠCPUè¿è¡Œæ—¶é—´åˆ’åˆ†æˆè‹¥å¹²ä¸ªæ—¶é—´æ®µ,å†å°†æ—¶é—´æ®µåˆ†é…ç»™å„ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œåœ¨ä¸€ä¸ªæ—¶é—´æ®µçš„çº¿ç¨‹ä»£ç è¿è¡Œæ—¶ï¼Œå…¶å®ƒçº¿ç¨‹å¤„äºæŒ‚èµ·çŠ¶ã€‚.è¿™ç§æ–¹å¼æˆ‘ä»¬ç§°ä¹‹ä¸ºå¹¶å‘(Concurrent)ã€‚</p></blockquote><p>å†…æ ¸å®ç°äº†è°ƒåº¦ç®—æ³•ï¼Œç”¨äºæ§åˆ¶ç³»ç»Ÿä¸­æ‰€æœ‰çº¿ç¨‹çš„è°ƒåº¦ï¼Œç®€å•ç‚¹æ¥è¯´ï¼Œç³»ç»Ÿä¸­æ‰€æœ‰å‚ä¸è°ƒåº¦çš„çº¿ç¨‹ä¼šåŠ å…¥åˆ°ç³»ç»Ÿçš„è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œå®ƒä»¬ç”±å†…æ ¸æ§åˆ¶ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€æ®µæ—¶é—´åï¼Œç”±ç³»ç»Ÿè°ƒåº¦åˆ‡æ¢æ‰§è¡Œè°ƒåº¦é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼Œä¾æ¬¡è¿›è¡Œã€‚</p><p>å°±åƒæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ ID ä¸€æ ·ï¼Œæ¯ä¸ªçº¿ç¨‹ä¹Ÿæœ‰å…¶å¯¹åº”çš„æ ‡è¯†ï¼Œç§°ä¸ºçº¿ç¨‹ IDã€‚è¿›ç¨‹ ID åœ¨æ•´ä¸ªç³»ç»Ÿä¸­æ˜¯å”¯ä¸€çš„ã€‚ä¸€ä¸ªçº¿ç¨‹å¯é€šè¿‡åº“å‡½æ•° pthread_self()æ¥è·å–è‡ªå·±çš„çº¿ç¨‹ ID</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">pthread_t</span> <span class="title function_">pthread_self</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_equal</span><span class="params">(<span class="type">pthread_t</span> t1, <span class="type">pthread_t</span> t2)</span>;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸¤ä¸ªçº¿ç¨‹ ID t1 å’Œ t2 ç›¸ç­‰ï¼Œåˆ™ pthread_equal()è¿”å›ä¸€ä¸ªéé›¶å€¼ï¼›å¦åˆ™è¿”å› 0ã€‚</p><h3 id="åˆ›å»ºçº¿ç¨‹"><a href="#åˆ›å»ºçº¿ç¨‹" class="headerlink" title="åˆ›å»ºçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹</h3><p>ä¸»çº¿ç¨‹å¯ä»¥ä½¿ç”¨åº“å‡½æ•° pthread_create()è´Ÿè´£åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œåˆ›å»ºå‡ºæ¥çš„æ–°çº¿ç¨‹è¢«ç§°ä¸ºä¸»çº¿ç¨‹çš„å­çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_create</span><span class="params">(<span class="type">pthread_t</span> *thread, <span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">void</span> *(*start_routine) (<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;</span><br></pre></td></tr></table></figure><p>threadï¼špthread_t ç±»å‹æŒ‡é’ˆï¼Œå½“ pthread_create()æˆåŠŸè¿”å›æ—¶ï¼Œæ–°åˆ›å»ºçš„çº¿ç¨‹çš„çº¿ç¨‹ ID ä¼šä¿å­˜åœ¨å‚æ•° threadæ‰€æŒ‡å‘çš„å†…å­˜ä¸­ï¼Œåç»­çš„çº¿ç¨‹ç›¸å…³å‡½æ•°ä¼šä½¿ç”¨è¯¥æ ‡è¯†æ¥å¼•ç”¨æ­¤çº¿ç¨‹ã€‚<br>attrï¼špthread_attr_t ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘ pthread_attr_t ç±»å‹çš„ç¼“å†²åŒºï¼Œpthread_attr_t æ•°æ®ç±»å‹å®šä¹‰äº†çº¿ç¨‹çš„å„ç§å±æ€§ï¼Œå¦‚æœå°†å‚æ•° attr è®¾ç½®ä¸º NULLï¼Œé‚£ä¹ˆè¡¨ç¤ºå°†çº¿ç¨‹çš„æ‰€æœ‰å±æ€§è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œä»¥æ­¤åˆ›å»ºæ–°çº¿ç¨‹ã€‚<br>start_routineï¼šå‚æ•° start_routine æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªå‡½æ•°ï¼Œæ–°åˆ›å»ºçš„çº¿ç¨‹ä» start_routine()å‡½æ•°å¼€å§‹è¿è¡Œï¼Œè¯¥å‡½æ•°è¿”å›å€¼ç±»å‹ä¸ºvoid *ï¼Œå¹¶ä¸”è¯¥å‡½æ•°çš„å‚æ•°åªæœ‰ä¸€ä¸ªvoid *ï¼Œå…¶å®è¿™ä¸ªå‚æ•°å°±æ˜¯pthread_create()å‡½æ•°çš„ç¬¬å››ä¸ªå‚æ•° argã€‚å¦‚æœéœ€è¦å‘ start_routine()ä¼ é€’çš„å‚æ•°æœ‰ä¸€ä¸ªä»¥ä¸Šï¼Œé‚£ä¹ˆéœ€è¦æŠŠè¿™äº›å‚æ•°æ”¾åˆ°ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œç„¶åæŠŠè¿™ä¸ªç»“æ„ä½“å¯¹è±¡çš„åœ°å€ä½œä¸º arg å‚æ•°ä¼ å…¥ã€‚<br>argï¼šä¼ é€’ç»™ start_routine()å‡½æ•°çš„å‚æ•°ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéœ€è¦å°† arg æŒ‡å‘ä¸€ä¸ªå…¨å±€æˆ–å †å˜é‡ï¼Œæ„æ€å°±æ˜¯è¯´åœ¨çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¯¥ arg æŒ‡å‘çš„å¯¹è±¡å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™å¦‚æœçº¿ç¨‹ä¸­è®¿é—®äº†è¯¥å¯¹è±¡å°†ä¼šå‡ºç°é”™è¯¯ã€‚å½“ç„¶ä¹Ÿå¯å°†å‚æ•° arg è®¾ç½®ä¸º NULLï¼Œè¡¨ç¤ºä¸éœ€è¦ä¼ å…¥å‚æ•°ç»™ start_routine()å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">new_thread_start</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–°çº¿ç¨‹: è¿›ç¨‹ ID&lt;%d&gt; çº¿ç¨‹ ID&lt;%lu&gt;\n&quot;</span>, getpid(), pthread_self());</span><br><span class="line"> <span class="keyword">return</span> (<span class="type">void</span> *)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pthread_t</span> tid;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, new_thread_start, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;ä¸»çº¿ç¨‹: è¿›ç¨‹ ID&lt;%d&gt; çº¿ç¨‹ ID&lt;%lu&gt;\n&quot;</span>, getpid(), pthread_self());</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»ˆæ­¢è¿›ç¨‹"><a href="#ç»ˆæ­¢è¿›ç¨‹" class="headerlink" title="ç»ˆæ­¢è¿›ç¨‹"></a>ç»ˆæ­¢è¿›ç¨‹</h3><p>åœ¨æ–°çº¿ç¨‹çš„å¯åŠ¨å‡½æ•°ï¼ˆçº¿ç¨‹ start å‡½æ•°ï¼‰new_thread_start()é€šè¿‡ return è¿”å›ä¹‹<br>åï¼Œæ„å‘³ç€è¯¥çº¿ç¨‹å·²ç»ç»ˆæ­¢äº†ï¼Œé™¤äº†åœ¨çº¿ç¨‹ start å‡½æ•°ä¸­æ‰§è¡Œ return è¯­å¥ç»ˆæ­¢çº¿ç¨‹å¤–ï¼Œç»ˆæ­¢çº¿ç¨‹çš„æ–¹å¼è¿˜æœ‰<br>å¤šç§ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ç»ˆæ­¢çº¿ç¨‹çš„è¿è¡Œï¼š<br>âš« çº¿ç¨‹çš„ start å‡½æ•°æ‰§è¡Œ return è¯­å¥å¹¶è¿”å›æŒ‡å®šå€¼ï¼Œè¿”å›å€¼å°±æ˜¯çº¿ç¨‹çš„é€€å‡ºç ï¼›<br>âš« çº¿ç¨‹è°ƒç”¨ pthread_exit()å‡½æ•°ï¼›<br>âš« è°ƒç”¨ pthread_cancel()å–æ¶ˆçº¿ç¨‹</p><p>å¦‚æœè¿›ç¨‹ä¸­çš„ä»»æ„çº¿ç¨‹è°ƒç”¨ exit()ã€_exit()æˆ–è€…_Exit()ï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹ç»ˆæ­¢ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼</p><p>pthread_exit()å‡½æ•°å°†ç»ˆæ­¢è°ƒç”¨å®ƒçš„çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_exit</span><span class="params">(<span class="type">void</span> *retval)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•° retval çš„æ•°æ®ç±»å‹ä¸º void *ï¼ŒæŒ‡å®šäº†çº¿ç¨‹çš„è¿”å›å€¼ã€ä¹Ÿå°±æ˜¯çº¿ç¨‹çš„é€€å‡ºç ï¼Œè¯¥è¿”å›å€¼å¯ç”±å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡è°ƒç”¨ pthread_join()æ¥è·å–ï¼›åŒç†ï¼Œå¦‚æœçº¿ç¨‹æ˜¯åœ¨ start å‡½æ•°ä¸­æ‰§è¡Œ return è¯­å¥ç»ˆæ­¢ï¼Œé‚£ä¹ˆ return çš„è¿”å›å€¼ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡ pthread_join()æ¥è·å–çš„ã€‚<br>å‚æ•° retval æ‰€æŒ‡å‘çš„å†…å®¹ä¸åº”åˆ†é…äºçº¿ç¨‹æ ˆä¸­ï¼Œå› ä¸ºçº¿ç¨‹ç»ˆæ­¢åï¼Œå°†æ— æ³•ç¡®å®šçº¿ç¨‹æ ˆçš„å†…å®¹æ˜¯å¦æœ‰æ•ˆï¼›å‡ºäºåŒæ ·çš„ç†ç”±ï¼Œä¹Ÿä¸åº”åœ¨çº¿ç¨‹æ ˆä¸­åˆ†é…çº¿ç¨‹ start å‡½æ•°çš„è¿”å›å€¼ã€‚<br>è°ƒç”¨ pthread_exit()ç›¸å½“äºåœ¨çº¿ç¨‹çš„ start å‡½æ•°ä¸­æ‰§è¡Œ return è¯­å¥ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼Œå¯åœ¨çº¿ç¨‹ start å‡½æ•°æ‰€è°ƒç”¨çš„ä»»æ„å‡½æ•°ä¸­è°ƒç”¨ pthread_exit()æ¥ç»ˆæ­¢çº¿ç¨‹ã€‚å¦‚æœä¸»çº¿ç¨‹è°ƒç”¨äº† pthread_exit()ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹ä¹Ÿä¼šç»ˆæ­¢ï¼Œä½†å…¶å®ƒçº¿ç¨‹ä¾ç„¶æ­£å¸¸è¿è¡Œï¼Œç›´åˆ°è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹ç»ˆæ­¢æ‰ä¼šä½¿å¾—è¿›ç¨‹ç»ˆæ­¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">new_thread_start</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–°çº¿ç¨‹ start\n&quot;</span>);</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–°çº¿ç¨‹ end\n&quot;</span>);</span><br><span class="line"> pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pthread_t</span> tid;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, new_thread_start, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;ä¸»çº¿ç¨‹ end\n&quot;</span>);</span><br><span class="line"> pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å–æ¶ˆçº¿ç¨‹"><a href="#å–æ¶ˆçº¿ç¨‹" class="headerlink" title="å–æ¶ˆçº¿ç¨‹"></a>å–æ¶ˆçº¿ç¨‹</h3><p>è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹ä¼šå¹¶å‘æ‰§è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹å„å¸å…¶èŒï¼Œç›´åˆ°çº¿ç¨‹çš„ä»»åŠ¡å®Œæˆä¹‹åï¼Œè¯¥çº¿ç¨‹ä¸­ä¼šè°ƒç”¨ pthread_exit()é€€å‡ºï¼Œæˆ–åœ¨çº¿ç¨‹ start å‡½æ•°æ‰§è¡Œ return è¯­å¥é€€å‡ºã€‚</p><p>åœ¨ç¨‹åºè®¾è®¡éœ€æ±‚å½“ä¸­ï¼Œéœ€è¦å‘ä¸€ä¸ªçº¿ç¨‹å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¦æ±‚å®ƒç«‹åˆ»é€€å‡ºï¼Œæˆ‘ä»¬æŠŠè¿™ç§æ“ä½œç§°ä¸ºå–æ¶ˆçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯å‘æŒ‡å®šçš„çº¿ç¨‹å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¦æ±‚å…¶ç«‹åˆ»ç»ˆæ­¢ã€é€€å‡ºã€‚è­¬å¦‚ï¼Œä¸€ç»„çº¿ç¨‹æ­£åœ¨æ‰§è¡Œä¸€ä¸ªè¿ç®—ï¼Œä¸€æ—¦æŸä¸ªçº¿ç¨‹æ£€æµ‹åˆ°é”™è¯¯å‘ç”Ÿï¼Œéœ€è¦å…¶å®ƒçº¿ç¨‹é€€å‡ºï¼Œå–æ¶ˆçº¿ç¨‹è¿™é¡¹åŠŸèƒ½å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p><p>é€šè¿‡è°ƒç”¨ pthread_cancel()åº“å‡½æ•°å‘ä¸€ä¸ªæŒ‡å®šçš„çº¿ç¨‹å‘é€å–æ¶ˆè¯·æ±‚ï¼Œå…¶å‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cancel</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="type">void</span> ** retval)</span>;</span><br></pre></td></tr></table></figure><p>  thread å‚æ•°ç”¨äºæŒ‡å®šæ¥æ”¶å“ªä¸ªçº¿ç¨‹çš„è¿”å›å€¼ï¼›retval å‚æ•°è¡¨ç¤ºæ¥æ”¶åˆ°çš„è¿”å›å€¼ï¼Œå¦‚æœ thread çº¿ç¨‹æ²¡æœ‰è¿”å›å€¼ï¼Œåˆæˆ–è€…æˆ‘ä»¬ä¸éœ€è¦æ¥æ”¶ thread çº¿ç¨‹çš„è¿”å›å€¼ï¼Œå¯ä»¥å°† retval å‚æ•°ç½®ä¸º NULLã€‚</p><p>pthread_join() å‡½æ•°ä¼šä¸€ç›´é˜»å¡è°ƒç”¨å®ƒçš„çº¿ç¨‹ï¼Œç›´è‡³ç›®æ ‡çº¿ç¨‹æ‰§è¡Œç»“æŸï¼ˆæ¥æ”¶åˆ°ç›®æ ‡çº¿ç¨‹çš„è¿”å›å€¼ï¼‰ï¼Œé˜»å¡çŠ¶æ€æ‰ä¼šè§£é™¤ã€‚å¦‚æœ pthread_join() å‡½æ•°æˆåŠŸç­‰åˆ°äº†ç›®æ ‡çº¿ç¨‹æ‰§è¡Œç»“æŸï¼ˆæˆåŠŸè·å–åˆ°ç›®æ ‡çº¿ç¨‹çš„è¿”å›å€¼ï¼‰ï¼Œè¿”å›å€¼ä¸ºæ•°å­— 0ï¼›åä¹‹å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œå‡½æ•°ä¼šæ ¹æ®å¤±è´¥åŸå› è¿”å›ç›¸åº”çš„éé›¶å€¼ï¼Œæ¯ä¸ªéé›¶å€¼éƒ½å¯¹åº”ç€ä¸åŒçš„å®  ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">new_thread_start</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–°çº¿ç¨‹--running\n&quot;</span>);</span><br><span class="line"> <span class="keyword">for</span> ( ; ; )</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="keyword">return</span> (<span class="type">void</span> *)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pthread_t</span> tid;</span><br><span class="line"> <span class="type">void</span> *tret;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="comment">/* åˆ›å»ºæ–°çº¿ç¨‹ */</span></span><br><span class="line"> ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, new_thread_start, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_create error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="comment">/* å‘æ–°çº¿ç¨‹å‘é€å–æ¶ˆè¯·æ±‚ */</span></span><br><span class="line"> ret = pthread_cancel(tid);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_cancel error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* ç­‰å¾…æ–°çº¿ç¨‹ç»ˆæ­¢ */</span></span><br><span class="line"> ret = pthread_join(tid, &amp;tret);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_join error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–°çº¿ç¨‹ç»ˆæ­¢, code=%ld\n&quot;</span>, (<span class="type">long</span>)tret);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å–æ¶ˆçŠ¶æ€ä»¥åŠç±»å‹</p><p>å½“ç„¶ï¼Œçº¿ç¨‹å¯ä»¥é€‰æ‹©ä¸è¢«å–æ¶ˆæˆ–è€…æ§åˆ¶å¦‚ä½•è¢«å–æ¶ˆï¼Œé€šè¿‡ pthread_setcancelstate()å’Œ pthread_setcanceltype()æ¥è®¾ç½®çº¿ç¨‹çš„å–æ¶ˆæ€§çŠ¶æ€å’Œç±»å‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_setcancelstate</span><span class="params">(<span class="type">int</span> state, <span class="type">int</span> *oldstate)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_setcanceltype</span><span class="params">(<span class="type">int</span> type, <span class="type">int</span> *oldtype)</span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™äº›å‡½æ•°éœ€è¦åŒ…å«å¤´æ–‡ä»¶ï¼Œpthread_setcancelstate()å‡½æ•°ä¼šå°†è°ƒç”¨çº¿ç¨‹çš„å–æ¶ˆæ€§çŠ¶æ€è®¾ç½®ä¸ºå‚æ•° state ä¸­ç»™å®šçš„å€¼ï¼Œå¹¶å°†çº¿ç¨‹ä¹‹å‰çš„å–æ¶ˆæ€§çŠ¶æ€ä¿å­˜åœ¨å‚æ•° oldstate æŒ‡å‘çš„ç¼“å†²åŒºä¸­ï¼Œå¦‚æœå¯¹ä¹‹å‰çš„çŠ¶æ€ä¸æ„Ÿå…´è¶£ï¼ŒLinux å…è®¸å°†å‚æ•° oldstate è®¾ç½®ä¸º NULLï¼›pthread_setcancelstate()è°ƒç”¨æˆåŠŸå°†è¿”å› 0ï¼Œå¤±è´¥è¿”å›é 0 å€¼çš„é”™è¯¯ç ã€‚<br>pthread_setcancelstate()å‡½æ•°æ‰§è¡Œçš„è®¾ç½®å–æ¶ˆæ€§çŠ¶æ€å’Œè·å–æ—§çŠ¶æ€æ“ä½œï¼Œè¿™ä¸¤æ­¥æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚<br>å‚æ•° state å¿…é¡»æ˜¯ä»¥ä¸‹å€¼ä¹‹ä¸€ï¼š<br>âš« PTHREAD_CANCEL_ENABLEï¼šçº¿ç¨‹å¯ä»¥å–æ¶ˆï¼Œè¿™æ˜¯æ–°åˆ›å»ºçš„çº¿ç¨‹å–æ¶ˆæ€§çŠ¶æ€çš„é»˜è®¤å€¼ï¼Œæ‰€ä»¥<br>æ–°å»ºçº¿ç¨‹ä»¥åŠä¸»çº¿ç¨‹é»˜è®¤éƒ½æ˜¯å¯ä»¥å–æ¶ˆçš„ã€‚<br>âš« PTHREAD_CANCEL_DISABLEï¼šçº¿ç¨‹ä¸å¯è¢«å–æ¶ˆï¼Œå¦‚æœæ­¤ç±»çº¿ç¨‹æ¥æ”¶åˆ°å–æ¶ˆè¯·æ±‚ï¼Œåˆ™ä¼šå°†è¯·æ±‚<br>æŒ‚èµ·ï¼Œç›´è‡³çº¿ç¨‹çš„å–æ¶ˆæ€§çŠ¶æ€å˜ä¸º PTHREAD_CANCEL_ENABLEã€‚</p><p><strong>pthread_setcanceltype()å‡½æ•°</strong><br>å¦‚æœçº¿ç¨‹çš„å–æ¶ˆæ€§çŠ¶æ€ä¸º PTHREAD_CANCEL_ENABLEï¼Œé‚£ä¹ˆå¯¹å–æ¶ˆè¯·æ±‚çš„å¤„ç†åˆ™å–å†³äºçº¿ç¨‹çš„å–æ¶ˆæ€§ç±»å‹ï¼Œè¯¥ç±»å‹å¯ä»¥é€šè¿‡è°ƒç”¨ pthread_setcanceltype()å‡½æ•°æ¥è®¾ç½®ï¼Œå®ƒçš„å‚æ•° type æŒ‡å®šäº†éœ€è¦è®¾ç½®çš„ç±»å‹ï¼Œè€Œçº¿ç¨‹ä¹‹å‰çš„å–æ¶ˆæ€§ç±»å‹åˆ™ä¼šä¿å­˜åœ¨å‚æ•° oldtype æ‰€æŒ‡å‘çš„ç¼“å†²åŒºä¸­ï¼Œå¦‚æœå¯¹ä¹‹å‰çš„ç±»å‹ä¸æ•¢å…´è¶£ï¼ŒLinuxä¸‹å…è®¸å°†å‚æ•° oldtype è®¾ç½®ä¸º NULLã€‚åŒæ · pthread_setcanceltype()å‡½æ•°è°ƒç”¨æˆåŠŸå°†è¿”å› 0ï¼Œå¤±è´¥è¿”å›é 0 å€¼çš„é”™è¯¯ç ã€‚<br>pthread_setcanceltype()å‡½æ•°æ‰§è¡Œçš„è®¾ç½®å–æ¶ˆæ€§ç±»å‹å’Œè·å–æ—§ç±»å‹æ“ä½œï¼Œè¿™ä¸¤æ­¥æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚<br>å‚æ•° type å¿…é¡»æ˜¯ä»¥ä¸‹å€¼ä¹‹ä¸€ï¼š<br>âš« PTHREAD_CANCEL_DEFERREDï¼šå–æ¶ˆè¯·æ±‚åˆ°æ¥æ—¶ï¼Œçº¿ç¨‹è¿˜æ˜¯ç»§ç»­è¿è¡Œï¼Œå–æ¶ˆè¯·æ±‚è¢«æŒ‚èµ·ï¼Œç›´åˆ°çº¿ç¨‹åˆ°è¾¾æŸä¸ªå–æ¶ˆç‚¹ï¼ˆcancellation pointï¼Œå°†åœ¨ 11.6.3 å°èŠ‚ä»‹ç»ï¼‰ä¸ºæ­¢ï¼Œè¿™æ˜¯æ‰€æœ‰æ–°å»ºçº¿ç¨‹åŒ…æ‹¬ä¸»çº¿ç¨‹é»˜è®¤çš„å–æ¶ˆæ€§ç±»å‹ã€‚<br>âš« PTHREAD_CANCEL_ASYNCHRONOUSï¼šå¯èƒ½ä¼šåœ¨ä»»ä½•æ—¶é—´ç‚¹ï¼ˆä¹Ÿè®¸æ˜¯ç«‹å³å–æ¶ˆï¼Œä½†ä¸ä¸€å®šï¼‰<br>å–æ¶ˆçº¿ç¨‹ï¼Œå½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ fork()åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œå­è¿›ç¨‹ä¼šç»§æ‰¿è°ƒç”¨çº¿ç¨‹çš„å–æ¶ˆæ€§çŠ¶æ€å’Œå–æ¶ˆæ€§ç±»å‹ï¼Œè€Œå½“æŸçº¿ç¨‹<br>è°ƒ ç”¨ exec å‡½ æ•° æ—¶ ï¼Œ ä¼š å°† æ–° ç¨‹ åº ä¸» çº¿ ç¨‹ çš„ å– æ¶ˆ æ€§ çŠ¶ æ€ å’Œ ç±» å‹ é‡ ç½® ä¸º é»˜ è®¤ å€¼ ï¼Œ ä¹Ÿ å°± æ˜¯<br>PTHREAD_CANCEL_ENABLE å’Œ PTHREAD_CANCEL_DEFERREDã€‚</p><h3 id="åˆ†ç¦»çº¿ç¨‹"><a href="#åˆ†ç¦»çº¿ç¨‹" class="headerlink" title="åˆ†ç¦»çº¿ç¨‹"></a>åˆ†ç¦»çº¿ç¨‹</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“çº¿ç¨‹ç»ˆæ­¢æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨ pthread_join()è·å–å…¶è¿”å›çŠ¶æ€ã€å›æ”¶çº¿ç¨‹èµ„æºï¼Œæœ‰æ—¶ï¼Œç¨‹åºå‘˜å¹¶ä¸å…³ç³»çº¿ç¨‹çš„è¿”å›çŠ¶æ€ï¼Œåªæ˜¯å¸Œæœ›ç³»ç»Ÿåœ¨çº¿ç¨‹ç»ˆæ­¢æ—¶èƒ½å¤Ÿè‡ªåŠ¨å›æ”¶çº¿ç¨‹èµ„æºå¹¶å°†å…¶ç§»é™¤ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥è°ƒç”¨ pthread_detach()å°†æŒ‡å®šçº¿ç¨‹è¿›è¡Œåˆ†ç¦»ï¼Œä¹Ÿå°±æ˜¯åˆ†ç¦»çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_detach</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¯¥å‡½æ•°éœ€è¦åŒ…å«å¤´æ–‡ä»¶ï¼Œå‚æ•° thread æŒ‡å®šéœ€è¦åˆ†ç¦»çš„çº¿ç¨‹ï¼Œå‡½æ•° pthread_detach()è°ƒç”¨æˆåŠŸå°†è¿”å› 0ï¼›å¤±è´¥å°†è¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚ä¸€ä¸ªçº¿ç¨‹æ—¢å¯ä»¥å°†å¦ä¸€ä¸ªçº¿ç¨‹åˆ†ç¦»ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å°†è‡ªå·±åˆ†ç¦»ï¼Œè­¬å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_detach(pthread_self());</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦çº¿ç¨‹å¤„äºåˆ†ç¦»çŠ¶æ€ï¼Œå°±ä¸èƒ½å†ä½¿ç”¨ pthread_join()æ¥è·å–å…¶ç»ˆæ­¢çŠ¶æ€ï¼Œæ­¤è¿‡ç¨‹æ˜¯ä¸å¯é€†çš„ï¼Œä¸€æ—¦å¤„äºåˆ†ç¦»çŠ¶æ€ä¹‹åä¾¿ä¸èƒ½å†æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚å¤„äºåˆ†ç¦»çŠ¶æ€çš„çº¿ç¨‹ï¼Œå½“å…¶ç»ˆæ­¢åï¼Œèƒ½å¤Ÿè‡ªåŠ¨å›æ”¶çº¿ç¨‹èµ„æºã€‚</p><h3 id="æ³¨å†Œçº¿ç¨‹æ¸…ç†å¤„ç†å‡½æ•°"><a href="#æ³¨å†Œçº¿ç¨‹æ¸…ç†å¤„ç†å‡½æ•°" class="headerlink" title="æ³¨å†Œçº¿ç¨‹æ¸…ç†å¤„ç†å‡½æ•°"></a>æ³¨å†Œçº¿ç¨‹æ¸…ç†å¤„ç†å‡½æ•°</h3><p>ä½¿ç”¨ atexit()å‡½æ•°æ³¨å†Œè¿›ç¨‹ç»ˆæ­¢å¤„ç†å‡½æ•°ï¼Œå½“è¿›ç¨‹è°ƒç”¨ exit()é€€å‡ºæ—¶å°±ä¼šæ‰§è¡Œè¿›ç¨‹ç»ˆæ­¢å¤„ç†å‡½æ•°ï¼›å…¶å®ï¼Œå½“çº¿ç¨‹é€€å‡ºæ—¶ä¹Ÿå¯ä»¥è¿™æ ·åšï¼Œå½“çº¿ç¨‹ç»ˆæ­¢é€€å‡ºæ—¶ï¼Œå»æ‰§è¡Œè¿™æ ·çš„å¤„ç†å‡½æ•°ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªç§°ä¸ºçº¿ç¨‹æ¸…ç†å‡½æ•°ï¼ˆthread cleanup handlerï¼‰ã€‚ä¸è¿›ç¨‹ä¸åŒï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ³¨å†Œå¤šä¸ªæ¸…ç†å‡½æ•°ï¼Œè¿™äº›æ¸…ç†å‡½æ•°è®°å½•åœ¨æ ˆä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªæ¸…ç†å‡½æ•°æ ˆï¼Œæ ˆæ˜¯ä¸€ç§å…ˆè¿›åå‡ºçš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬çš„æ‰§è¡Œé¡ºåºä¸æ³¨å†Œï¼ˆæ·»åŠ ï¼‰é¡ºåºç›¸åï¼Œå½“æ‰§è¡Œå®Œæ‰€<br>æœ‰æ¸…ç†å‡½æ•°åï¼Œçº¿ç¨‹ç»ˆæ­¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_cleanup_push</span><span class="params">(<span class="type">void</span> (*routine)(<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;<span class="comment">//æ·»åŠ æ¸…ç†å‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_cleanup_pop</span><span class="params">(<span class="type">int</span> execute)</span>;<span class="comment">//ç§»é™¤æ¸…ç†å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>å½“çº¿ç¨‹æ‰§è¡Œä»¥ä¸‹åŠ¨ä½œæ—¶ï¼Œæ¸…ç†å‡½æ•°æ ˆä¸­çš„æ¸…ç†å‡½æ•°æ‰ä¼šè¢«æ‰§è¡Œï¼š<br>âš« çº¿ç¨‹è°ƒç”¨ pthread_exit()é€€å‡ºæ—¶ï¼›<br>âš« çº¿ç¨‹å“åº”å–æ¶ˆè¯·æ±‚æ—¶ï¼›<br>âš« ç”¨é 0 å‚æ•°è°ƒç”¨ pthread_cleanup_pop()</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cleanup</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;cleanup: %s\n&quot;</span>, (<span class="type">char</span> *)arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">new_thread_start</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–°çº¿ç¨‹--start run\n&quot;</span>);</span><br><span class="line"> pthread_cleanup_push(cleanup, <span class="string">&quot;ç¬¬ 1 æ¬¡è°ƒç”¨&quot;</span>);</span><br><span class="line"> pthread_cleanup_push(cleanup, <span class="string">&quot;ç¬¬ 2 æ¬¡è°ƒç”¨&quot;</span>);</span><br><span class="line"> pthread_cleanup_push(cleanup, <span class="string">&quot;ç¬¬ 3 æ¬¡è°ƒç”¨&quot;</span>);</span><br><span class="line"> sleep(<span class="number">2</span>);</span><br><span class="line"> pthread_exit((<span class="type">void</span> *)<span class="number">0</span>); <span class="comment">//çº¿ç¨‹ç»ˆæ­¢</span></span><br><span class="line"> <span class="comment">/* ä¸ºäº†ä¸ pthread_cleanup_push é…å¯¹,ä¸æ·»åŠ ç¨‹åºç¼–è¯‘ä¼šé€šä¸è¿‡ */</span></span><br><span class="line"> pthread_cleanup_pop(<span class="number">0</span>);</span><br><span class="line"> pthread_cleanup_pop(<span class="number">0</span>);</span><br><span class="line">     pthread_cleanup_pop(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pthread_t</span> tid;</span><br><span class="line"> <span class="type">void</span> *tret;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="comment">/* åˆ›å»ºæ–°çº¿ç¨‹ */</span></span><br><span class="line"> ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, new_thread_start, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_create error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* ç­‰å¾…æ–°çº¿ç¨‹ç»ˆæ­¢ */</span></span><br><span class="line"> ret = pthread_join(tid, &amp;tret);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_join error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–°çº¿ç¨‹ç»ˆæ­¢, code=%ld\n&quot;</span>, (<span class="type">long</span>)tret);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çº¿ç¨‹æ ˆå±æ€§"><a href="#çº¿ç¨‹æ ˆå±æ€§" class="headerlink" title="çº¿ç¨‹æ ˆå±æ€§"></a>çº¿ç¨‹æ ˆå±æ€§</h2><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆç©ºé—´ï¼Œpthread_attr_t æ•°æ®ç»“æ„ä¸­å®šä¹‰äº†æ ˆçš„èµ·å§‹åœ°å€ä»¥åŠæ ˆå¤§å°ï¼Œè°ƒç”¨å‡½æ•°pthread_attr_getstack()å¯ä»¥è·å–è¿™äº›ä¿¡æ¯ï¼Œå‡½æ•° pthread_attr_setstack()å¯¹æ ˆèµ·å§‹åœ°å€å’Œæ ˆå¤§å°è¿›è¡Œè®¾ç½®ï¼Œå…¶å‡½<br>æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setstack</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">void</span> *stackaddr, <span class="type">size_t</span> stacksize)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getstack</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">void</span> **stackaddr, <span class="type">size_t</span> *stacksize)</span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™äº›å‡½æ•°éœ€è¦åŒ…å«å¤´æ–‡ä»¶ï¼Œå‡½æ•° pthread_attr_getstack()ï¼Œå‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>attrï¼šå‚æ•° attr æŒ‡å‘çº¿ç¨‹å±æ€§å¯¹è±¡ã€‚<br>stackaddrï¼šè°ƒç”¨ pthread_attr_getstack()å¯è·å–æ ˆèµ·å§‹åœ°å€ï¼Œå¹¶å°†èµ·å§‹åœ°å€ä¿¡æ¯ä¿å­˜åœ¨*stackaddr ä¸­ï¼›<br>stacksizeï¼šè°ƒç”¨ pthread_attr_getstack()å¯è·å–æ ˆå¤§å°ï¼Œå¹¶å°†æ ˆå¤§å°ä¿¡æ¯ä¿å­˜åœ¨å‚æ•° stacksize æ‰€æŒ‡å‘çš„å†…å­˜ä¸­ï¼›<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥å°†è¿”å›ä¸€ä¸ªé 0 å€¼çš„é”™è¯¯ç ã€‚<br>å‡½æ•° pthread_attr_setstack()ï¼Œå‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>attrï¼šå‚æ•° attr æŒ‡å‘çº¿ç¨‹å±æ€§å¯¹è±¡ã€‚<br>stackaddrï¼šè®¾ç½®æ ˆèµ·å§‹åœ°å€ä¸ºæŒ‡å®šå€¼ã€‚<br>stacksizeï¼šè®¾ç½®æ ˆå¤§å°ä¸ºæŒ‡å®šå€¼ï¼›<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥å°†è¿”å›ä¸€ä¸ªé 0 å€¼çš„é”™è¯¯ç ã€‚</p><p>å¦‚æœæƒ³å•ç‹¬è·å–æˆ–è®¾ç½®æ ˆå¤§å°ã€æ ˆèµ·å§‹åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™äº›å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setstacksize</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> stacksize)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getstacksize</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> *stacksize)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setstackaddr</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">void</span> *stackaddr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getstackaddr</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">void</span> **stackaddr)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">new_thread_start</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line"> <span class="keyword">return</span> (<span class="type">void</span> *)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pthread_attr_t</span> attr;</span><br><span class="line"> <span class="type">size_t</span> stacksize;</span><br><span class="line"> <span class="type">pthread_t</span> tid;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="comment">/* å¯¹ attr å¯¹è±¡è¿›è¡Œåˆå§‹åŒ– */</span></span><br><span class="line"> pthread_attr_init(&amp;attr);</span><br><span class="line"> <span class="comment">/* è®¾ç½®æ ˆå¤§å°ä¸º 4K */</span></span><br><span class="line"> pthread_attr_setstacksize(&amp;attr, <span class="number">4096</span>);</span><br><span class="line"> <span class="comment">/* åˆ›å»ºæ–°çº¿ç¨‹ */</span></span><br><span class="line"> ret = pthread_create(&amp;tid, &amp;attr, new_thread_start, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_create error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* ç­‰å¾…æ–°çº¿ç¨‹ç»ˆæ­¢ */</span></span><br><span class="line"> ret = pthread_join(tid, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (ret) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_join error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* é”€æ¯ attr å¯¹è±¡ */</span></span><br><span class="line"> pthread_attr_destroy(&amp;attr);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> æ“ä½œç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C issue2</title>
      <link href="/2023/01/13/2022-11-25-C-issue2/"/>
      <url>/2023/01/13/2022-11-25-C-issue2/</url>
      
        <content type="html"><![CDATA[<h3 id="å †æ ˆç©ºé—´"><a href="#å †æ ˆç©ºé—´" class="headerlink" title="å †æ ˆç©ºé—´"></a>å †æ ˆç©ºé—´</h3><p>Cæºä»£ç è¿›è¿‡é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–å’Œé“¾æ¥4æ­¥ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºã€‚ç¨‹åºåœ¨æ²¡æœ‰è¿è¡Œä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´ç¨‹åºæ²¡æœ‰è¢«åŠ è½½åˆ°å†…å­˜å‰ï¼Œå¯æ‰§è¡Œç¨‹åºå†…éƒ¨å·²ç»åˆ†å¥½3æ®µä¿¡æ¯ï¼Œåˆ†åˆ«æ˜¯ä»£ç åŒº(text)ã€æ•°æ®åŒº(data)å’Œæœªåˆå§‹åŒ–æ•°æ®åŒº(bss)ä¸‰ä¸ªéƒ¨åˆ†ã€‚ï¼ˆéƒ¨åˆ†äººç›´æ¥æŠŠdataå’Œbssåˆèµ·æ¥å«åšå…¨å±€åŒºæˆ–é™æ€åŒºï¼‰ã€‚<br>è¿è¡Œå¯æ‰§è¡Œç¨‹åºï¼Œç³»ç»ŸæŠŠç¨‹åºåŠ è½½åˆ°å†…å­˜ï¼Œé™¤äº†æ ¹æ®å¯æ‰§è¡Œç¨‹åºçš„ä¿¡æ¯åˆ†å‡ºä»£ç åŒºã€åˆå§‹åŒ–æ•°æ®åŒºå’Œæœªåˆå§‹åŒ–æ•°æ®åŒºä¹‹å¤–ï¼Œè¿˜é¢å¤–å¢åŠ äº†æ ˆåŒºå’Œå †åŒºã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-20%20093154.png"></p><p>linuxä¸‹çš„å†…å­˜åˆ†é…ï¼š</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-20%20093433.png"></p><h3 id="ç»“æ„ä½“å’Œç»“æ„ä½“æŒ‡é’ˆçš„å†…å­˜ç”³è¯·"><a href="#ç»“æ„ä½“å’Œç»“æ„ä½“æŒ‡é’ˆçš„å†…å­˜ç”³è¯·" class="headerlink" title="ç»“æ„ä½“å’Œç»“æ„ä½“æŒ‡é’ˆçš„å†…å­˜ç”³è¯·"></a>ç»“æ„ä½“å’Œç»“æ„ä½“æŒ‡é’ˆçš„å†…å­˜ç”³è¯·</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span><span class="comment">//åŒ…å«mallocå‡½æ•°çš„å¤´æ–‡ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">student</span>//<span class="title">typedef</span>å¯ä»¥å°†<span class="keyword">struct</span> <span class="title">student</span>ç»“æ„ä½“ç±»å‹ç”¨<span class="title">std</span>æ›¿ä»£</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">20</span>];</span><br><span class="line">    <span class="type">int</span> number;</span><br><span class="line">    <span class="type">char</span> subject[<span class="number">20</span>];</span><br><span class="line">    <span class="type">float</span> scores;</span><br><span class="line">&#125;<span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">std</span> student1;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;student1,<span class="number">0</span>,<span class="keyword">sizeof</span>(<span class="built_in">std</span>));<span class="comment">//åˆå§‹åŒ–ä»student1å¼€å§‹çš„åœ°å€åˆ°åé¢sizeofï¼ˆstdï¼‰ä¹Ÿå°±æ˜¯ç»“æ„ä½“çš„å­—èŠ‚ä¸ªç©ºé—´ï¼Œè¿™äº›ç©ºé—´éƒ½åˆå§‹åŒ–ä¸º0ä¹Ÿå°±æ˜¯ç©ºã€‚</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name:&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,student1.name);<span class="comment">//å¦‚æœä¸ç”¨memsetåˆå§‹åŒ–å†…å­˜ï¼Œç”¨scanfè¯­å¥è¾“å…¥äº†student1.nameçš„ä¿¡æ¯å†ç”¨printfè¾“å‡ºæ˜¯çœ‹ä¸å‡ºæ¥çš„ï¼Œå¦‚æœä¸è¾“å…¥ç›´æ¥è¾“å‡ºçš„è¯å°±ä¼šä¹±ç ï¼ˆåŸå› ä¹Ÿæ˜¯ç³»ç»Ÿå†…å­˜æ²¡æœ‰åˆå§‹åŒ–è°ä¹Ÿä¸çŸ¥é“é‡Œé¢æœ¬æ¥å­˜çš„æ˜¯ä»€ä¹ˆï¼‰</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,student1.name);</span><br><span class="line">    <span class="comment">//ç»“æ„ä½“æ˜¯ç›´æ¥ç”±æ ˆè‡ªåŠ¨åˆ†é…æŒ‡é’ˆçš„æ‰€ä»¥ä¸éœ€è¦æˆ‘ä»¬æ¥æ‰‹åŠ¨åˆ†é…å’Œé‡Šæ”¾å†…å­˜ï¼Œè€Œæ¥ä¸‹æ¥æ˜¯ç”¨ç»“æ„ä½“æŒ‡é’ˆæ¥ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="built_in">std</span>* student2 = (<span class="built_in">std</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="built_in">std</span>));</span><br><span class="line">    <span class="keyword">if</span>(student2 == <span class="literal">NULL</span>)<span class="comment">//å¦‚æœç”³è¯·å†…å­˜å¤±è´¥ï¼Œmallocä¼šè¿”å›ä¸€ä¸ªNULl</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;malloc use failure&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;<span class="comment">//ç”³è¯·å†…å­˜å¤±è´¥ï¼Œé”™è¯¯é€€å‡º</span></span><br><span class="line">   &#125;</span><br><span class="line">    <span class="built_in">memset</span> (student2,<span class="number">0</span>,<span class="keyword">sizeof</span>(<span class="built_in">std</span>));<span class="comment">//</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,student2-&gt;name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name:%s\n&quot;</span>,student2-&gt;name);</span><br><span class="line">    <span class="built_in">free</span>(student2);<span class="comment">//é‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„å †çš„å†…å­˜ä½†æ˜¯ä¸é‡Šæ”¾æŒ‡é’ˆæœ¬èº«çš„å†…å­˜ï¼ŒæŒ‡é’ˆæœ¬èº«å­˜æ”¾åœ¨æ ˆåŒºï¼Œå†ç¨‹åºè¿è¡Œç»“æŸåæ‰èƒ½è‡ªåŠ¨é‡Šæ”¾</span></span><br><span class="line">    student2 = <span class="literal">NULL</span>;<span class="comment">//è¿™é‡Œå°±æ˜¯å°†æŒ‡é’ˆæŒ‡å‘ç©ºæŒ‡é’ˆï¼Œé¿å…è¢«é”™è¯¯è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶ä¸­è¯»å–ç»“æ„ä½“"><a href="#æ–‡ä»¶ä¸­è¯»å–ç»“æ„ä½“" class="headerlink" title="æ–‡ä»¶ä¸­è¯»å–ç»“æ„ä½“"></a>æ–‡ä»¶ä¸­è¯»å–ç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰ç»“æ„ä½“, å­˜å‚¨ä¸€ä¸ªå­—ç¬¦ä¸²å’Œå¹´é¾„ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">20</span>];</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è¦å†™å…¥æ–‡ä»¶çš„ç»“æ„ä½“</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">s1</span> =</span> &#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">18</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€è¦å†™å…¥çš„æ–‡ä»¶</span></span><br><span class="line">    FILE *p = fopen(<span class="string">&quot;D:/File/student.dat&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="comment">// æ‰“å¼€å¤±è´¥ç›´æ¥é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span>(p == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å°†ç»“æ„ä½“å†™å‡ºåˆ°æ–‡ä»¶ä¸­</span></span><br><span class="line">    fwrite(&amp;s1, <span class="number">1</span>, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> student), p);</span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">    fclose(p);</span><br><span class="line">    <span class="comment">// è¯»å–æ–‡ä»¶ä¸­çš„ç»“æ„ä½“</span></span><br><span class="line">    <span class="comment">// å­˜å‚¨è¯»å–åˆ°çš„ç»“æ„ä½“æ•°æ®</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">s2</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">    FILE *p2 = fopen(<span class="string">&quot;D:/File/student.dat&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="comment">// å¦‚æœæ‰“å¼€å¤±è´¥, é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span>(p2 == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ä»æ–‡ä»¶ä¸­è¯»å–ç»“æ„ä½“ä¿¡æ¯</span></span><br><span class="line">    fread(&amp;s2, <span class="number">1</span>, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> student), p2);</span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">    fclose(p2);</span><br><span class="line">    <span class="comment">// æ‰“å°æ•°æ®</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;student : name=%s, age=%d\n&quot;</span>, s2.name, s2.age);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»å–ç»“æ„ä½“æ•°ç»„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰ç»“æ„ä½“, å­˜å‚¨ä¸€ä¸ªå­—ç¬¦ä¸²å’Œå¹´é¾„ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">20</span>];</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è¦å†™å…¥æ–‡ä»¶çš„ç»“æ„ä½“</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">s1</span>[2] =</span> &#123;&#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">18</span>&#125;, &#123;<span class="string">&quot;Jerry&quot;</span>, <span class="number">20</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€è¦å†™å…¥çš„æ–‡ä»¶</span></span><br><span class="line">    FILE *p = fopen(<span class="string">&quot;D:/File/student.dat&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="comment">// æ‰“å¼€å¤±è´¥ç›´æ¥é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span>(p == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ç»“æ„ä½“å†™å‡ºåˆ°æ–‡ä»¶ä¸­</span></span><br><span class="line">    fwrite(s1, <span class="number">2</span>, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> student), p);</span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">    fclose(p);</span><br><span class="line">    <span class="comment">// è¯»å–æ–‡ä»¶ä¸­çš„ç»“æ„ä½“</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å‚¨è¯»å–åˆ°çš„ç»“æ„ä½“æ•°æ®</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">s2</span>[2] =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">    FILE *p2 = fopen(<span class="string">&quot;D:/File/student.dat&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="comment">// å¦‚æœæ‰“å¼€å¤±è´¥, é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span>(p2 == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»æ–‡ä»¶ä¸­è¯»å–ç»“æ„ä½“ä¿¡æ¯</span></span><br><span class="line">    fread(s2, <span class="number">2</span>, <span class="keyword">sizeof</span> (<span class="keyword">struct</span> student), p2);</span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">    fclose(p2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å°æ•°æ®</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;student : name=%s, age=%d\n&quot;</span>, s2[i].name, s2[i].age);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/ybny0421/article/details/123263594?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167220768816800184180646%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=167220768816800184180646&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~pc_rank_34-3-123263594-null-null.142">æ•°æ®ç»“æ„å¯¹äºæ–‡ä»¶çš„å¢åˆ æŸ¥æ”¹</a></p><h3 id="åšäº†ä¸€ä¸ªå°ç³»ç»Ÿé‡åˆ°çš„é—®é¢˜"><a href="#åšäº†ä¸€ä¸ªå°ç³»ç»Ÿé‡åˆ°çš„é—®é¢˜" class="headerlink" title="åšäº†ä¸€ä¸ªå°ç³»ç»Ÿé‡åˆ°çš„é—®é¢˜"></a>åšäº†ä¸€ä¸ªå°ç³»ç»Ÿé‡åˆ°çš„é—®é¢˜</h3><p><a href="https://gitee.com/hanfengdyh/code/blob/master/%E5%9B%BE%E4%B9%A6%E9%A6%86%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F.c">å›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿ.c (gitee.com)</a></p><p>é¦–å…ˆå…³äºæ¸…å±linuxæœ‰ä¸‰ç§æ–¹å¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;x1b[Hx1b[2J&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span> (<span class="string">&quot;033c&quot;</span>);</span><br></pre></td></tr></table></figure><p>è™½ç„¶éƒ½æ˜¯æ¸…å±ä½†æ˜¯ç•¥æœ‰åŒºåˆ«ï¼Œé¦–å…ˆæ˜¯system(â€œclearâ€)å¥½å¤„å¯ä»¥æ›¿ä»£windowsä¸­çš„system(â€œclrâ€)ä¸çŸ¥é“æ˜¯ä»€ä¹ˆé—®é¢˜è°ƒç”¨å†™çš„æ¬¡æ•°å¤šäº†ï¼Œä¼šæœ‰ä¸æ‰§è¡Œçš„æƒ…å†µ.ä¹‹åæ˜¯printf(â€œ033câ€)ä¼šæ¸…æ¥šæ‰ä¹‹å‰å¯¹äºç»ˆç«¯å‘½ä»¤è¡Œæ‰“å°é¢œè‰²çš„å‘½ä»¤ï¼Œæ‰€ä»¥å®ƒåº”è¯¥æ˜¯é‡ç½®æ•´ä¸ªç»ˆç«¯ã€‚</p><p>ä¹‹åçš„ä¸€äº›é—®é¢˜åŸºæœ¬éƒ½æ˜¯ç»“æ„ä½“çš„é—®é¢˜éƒ½å†™åœ¨äº†å‰é¢ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¿›ç¨‹</title>
      <link href="/2023/01/07/2023-1-7-%E8%BF%9B%E7%A8%8B/"/>
      <url>/2023/01/07/2023-1-7-%E8%BF%9B%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p> è¿›ç¨‹</p><p>argc å’Œ argv ä¼ å‚æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><p>å½“åœ¨ç»ˆç«¯æ‰§è¡Œç¨‹åºæ—¶ï¼Œå‘½ä»¤è¡Œå‚æ•°ï¼ˆcommand-line argumentï¼‰ç”± shell è¿›ç¨‹é€ä¸€è¿›è¡Œè§£æï¼Œshell è¿›ç¨‹ä¼šå°†è¿™äº›å‚æ•°ä¼ é€’ç»™åŠ è½½å™¨ï¼ŒåŠ è½½å™¨åŠ è½½åº”ç”¨ç¨‹åºæ—¶ä¼šå°†å…¶ä¼ é€’ç»™åº”ç”¨ç¨‹åºå¼•å¯¼ä»£ç ï¼Œå½“å¼•å¯¼ç¨‹åºè°ƒç”¨ main()å‡½æ•°æ—¶ï¼Œåœ¨ç”±å®ƒæœ€ç»ˆä¼ é€’ç»™ main()å‡½æ•°ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå½“ä¸­ä¾¿å¯ä»¥è·å–åˆ°å‘½ä»¤è¡Œå‚æ•°äº†ã€‚</p><p><strong>æ³¨å†Œè¿›ç¨‹ç»ˆæ­¢å¤„ç†å‡½æ•°atexit()</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">atexit</span><span class="params">(<span class="type">void</span> (*function)(<span class="type">void</span>))</span>;</span><br></pre></td></tr></table></figure><p>functionï¼šå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘æ³¨å†Œçš„å‡½æ•°ï¼Œæ­¤å‡½æ•°æ— éœ€ä¼ å…¥å‚æ•°ã€æ— è¿”å›å€¼ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥è¿”å›é 0ã€‚</p><p><strong><u>è¿›ç¨‹æ˜¯ä¸€ä¸ªåŠ¨æ€è¿‡ç¨‹ï¼Œè€Œéé™æ€æ–‡ä»¶ï¼Œå®ƒæ˜¯ç¨‹åºçš„ä¸€æ¬¡è¿è¡Œè¿‡ç¨‹ï¼Œå½“åº”ç”¨ç¨‹åºè¢«åŠ è½½åˆ°å†…å­˜ä¸­è¿è¡Œä¹‹åå®ƒå°±ç§°ä¸ºäº†ä¸€ä¸ªè¿›ç¨‹ï¼Œå½“ç¨‹åºè¿è¡Œç»“æŸåä¹Ÿå°±æ„å‘³ç€è¿›ç¨‹ç»ˆæ­¢ï¼Œè¿™å°±æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸã€‚</u></strong>*</p><p>åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œå¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ getpid()æ¥è·å–æœ¬è¿›ç¨‹çš„è¿›ç¨‹å·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getpid</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//è·å–è¿›ç¨‹å·</span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getppid</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//è·å–çˆ¶è¿›ç¨‹è¿›ç¨‹å·</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pid_t</span> pid = getpid();</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æœ¬è¿›ç¨‹çš„ PID ä¸º: %d\n&quot;</span>, pid);</span><br><span class="line">    pid = getppid(); <span class="comment">//è·å–çˆ¶è¿›ç¨‹ pid</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;çˆ¶è¿›ç¨‹çš„ PID ä¸º: %d\n&quot;</span>, pid);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h3><p>æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ç»„ä¸å…¶ç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼Œè¿™äº›ç¯å¢ƒå˜é‡ä»¥å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„åˆ—è¡¨ä¸­ï¼ŒæŠŠè¿™ä¸ªæ•°ç»„ç§°ä¸ºç¯å¢ƒåˆ—è¡¨ã€‚å…¶ä¸­æ¯ä¸ªå­—ç¬¦ä¸²éƒ½æ˜¯ä»¥â€œåç§°&#x3D;å€¼ï¼ˆname&#x3D;valueï¼‰â€å½¢å¼å®šä¹‰ï¼Œæ‰€ä»¥ç¯å¢ƒå˜é‡æ˜¯â€œåç§°-å€¼â€çš„æˆå¯¹é›†åˆï¼Œè­¬å¦‚åœ¨ shell ç»ˆç«¯ä¸‹å¯ä»¥ä½¿ç”¨ env å‘½ä»¤æŸ¥çœ‹åˆ° shell è¿›ç¨‹çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ã€‚</p><p>äº‹å®ä¸Šï¼Œè¿›ç¨‹çš„ç¯å¢ƒå˜é‡æ˜¯ä»å…¶çˆ¶è¿›ç¨‹ä¸­ç»§æ‰¿è¿‡æ¥çš„ï¼Œè­¬å¦‚åœ¨ shell ç»ˆç«¯ä¸‹æ‰§è¡Œä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆè¯¥è¿›ç¨‹çš„ç¯å¢ƒå˜é‡å°±æ˜¯ä»å…¶çˆ¶è¿›ç¨‹ï¼ˆshell è¿›ç¨‹ï¼‰ä¸­ç»§æ‰¿è¿‡æ¥çš„ã€‚æ–°çš„è¿›ç¨‹åœ¨åˆ›å»ºä¹‹å‰ï¼Œä¼šç»§æ‰¿å…¶çˆ¶è¿›ç¨‹çš„ç¯å¢ƒå˜é‡å‰¯æœ¬ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ; <span class="comment">// ç”³æ˜å¤–éƒ¨å…¨å±€å˜é‡ environ</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> i;</span><br><span class="line"> <span class="comment">/* æ‰“å°è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; <span class="literal">NULL</span> != environ[i]; i++)</span><br><span class="line"><span class="built_in">puts</span>(environ[i]);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è·å–æŒ‡å®šç¯å¢ƒå˜é‡getenv()</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">getenv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure><p>nameï¼šæŒ‡å®šè·å–çš„ç¯å¢ƒå˜é‡åç§°ã€‚<br>è¿”å›å€¼ï¼šå¦‚æœå­˜æ”¾è¯¥ç¯å¢ƒå˜é‡ï¼Œåˆ™è¿”å›è¯¥ç¯å¢ƒå˜é‡çš„å€¼å¯¹åº”å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼›å¦‚æœä¸å­˜åœ¨è¯¥ç¯å¢ƒå˜é‡è¿”å›NULLã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">const</span> <span class="type">char</span> *str_val = <span class="literal">NULL</span>;</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">2</span> &gt; argc) &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: è¯·ä¼ å…¥ç¯å¢ƒå˜é‡åç§°\n&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* è·å–ç¯å¢ƒå˜é‡ */</span></span><br><span class="line"> str_val = getenv(argv[<span class="number">1</span>]);</span><br><span class="line"> <span class="keyword">if</span> (<span class="literal">NULL</span> == str_val) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: ä¸å­˜åœ¨[%s]ç¯å¢ƒå˜é‡\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* æ‰“å°ç¯å¢ƒå˜é‡çš„å€¼ */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ç¯å¢ƒå˜é‡çš„å€¼: %s\n&quot;</span>, str_val);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ åˆ é™¤ä¿®æ”¹ç¯å¢ƒå˜é‡</strong></p><p><strong>putenvå‡½æ•°</strong>ç”¨äºå‘è¿›ç¨‹çš„ç¯å¢ƒå˜é‡æ•°ç»„ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ç¯å¢ƒå˜é‡ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç¯å¢ƒå˜é‡çš„å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">putenv</span><span class="params">(<span class="type">char</span> *<span class="built_in">string</span>)</span>;</span><br></pre></td></tr></table></figure><p>stringï¼šå‚æ•° string æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆï¼ŒæŒ‡å‘ name&#x3D;value å½¢å¼çš„å­—ç¬¦ä¸²ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›é 0 å€¼ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p>è¯¥å‡½æ•°è°ƒç”¨æˆåŠŸä¹‹åï¼Œå‚æ•° string æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²å°±æˆä¸ºäº†è¿›ç¨‹ç¯å¢ƒå˜é‡çš„ä¸€éƒ¨åˆ†äº†ï¼Œæ¢è¨€ä¹‹ï¼Œputenv()å‡½æ•°å°†è®¾å®š environ å˜é‡ï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼‰ä¸­çš„æŸä¸ªå…ƒç´ ï¼ˆå­—ç¬¦ä¸²æŒ‡é’ˆï¼‰æŒ‡å‘è¯¥ string å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯æŒ‡å‘å®ƒçš„å¤åˆ¶å‰¯æœ¬ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼å› æ­¤ï¼Œä¸èƒ½éšæ„ä¿®æ”¹å‚æ•° string æ‰€æŒ‡å‘çš„å†…å®¹ï¼Œè¿™å°†å½±å“è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ï¼Œå‡ºäºè¿™ç§åŸå› ï¼Œå‚æ•° string ä¸åº”ä¸ºè‡ªåŠ¨å˜é‡ï¼ˆå³åœ¨æ ˆä¸­åˆ†é…çš„å­—ç¬¦æ•°ç»„ï¼‰</p><p><strong>setenv()å‡½æ•°</strong>å¯ä»¥æ›¿ä»£ putenv()å‡½æ•°ï¼Œç”¨äºå‘è¿›ç¨‹çš„ç¯å¢ƒå˜é‡åˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ç¯å¢ƒå˜é‡æˆ–ä¿®æ”¹ç°æœ‰ç¯å¢ƒå˜é‡å¯¹åº”çš„å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">setenv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">char</span> *value, <span class="type">int</span> overwrite)</span>;</span><br></pre></td></tr></table></figure><p>nameï¼šéœ€è¦æ·»åŠ æˆ–ä¿®æ”¹çš„ç¯å¢ƒå˜é‡åç§°ã€‚<br>valueï¼šç¯å¢ƒå˜é‡çš„å€¼ã€‚<br>overwriteï¼šè‹¥å‚æ•° name æ ‡è¯†çš„ç¯å¢ƒå˜é‡å·²ç»å­˜åœ¨ï¼Œåœ¨å‚æ•° overwrite ä¸º 0 çš„æƒ…å†µä¸‹ï¼Œsetenv()å‡½æ•°å°†ä¸æ”¹å˜ç°æœ‰ç¯å¢ƒå˜é‡çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æœ¬æ¬¡è°ƒç”¨æ²¡æœ‰äº§ç”Ÿä»»ä½•å½±å“ï¼›å¦‚æœå‚æ•° overwrite çš„å€¼ä¸ºé 0ï¼Œè‹¥å‚æ•° nameæ ‡è¯†çš„ç¯å¢ƒå˜é‡å·²ç»å­˜åœ¨ï¼Œåˆ™è¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™è¡¨ç¤ºæ·»åŠ æ–°çš„ç¯å¢ƒå˜é‡ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚<br>setenv()å‡½æ•°ä¸ºå½¢å¦‚ name&#x3D;value çš„å­—ç¬¦ä¸²åˆ†é…ä¸€å—å†…å­˜ç¼“å†²åŒºï¼Œå¹¶å°†å‚æ•° name å’Œå‚æ•° value æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²å¤åˆ¶åˆ°æ­¤ç¼“å†²åŒºä¸­ï¼Œä»¥æ­¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç¯å¢ƒå˜é‡ï¼Œæ‰€ä»¥ï¼Œç”±æ­¤å¯çŸ¥ï¼Œsetenv()ä¸ putenv()å‡½æ•°æœ‰ä¸¤ä¸ªåŒºåˆ«ï¼š</p><p>âš« putenv()å‡½æ•°å¹¶ä¸ä¼šä¸º name&#x3D;value å­—ç¬¦ä¸²åˆ†é…å†…å­˜ï¼›<br>âš« setenv()å¯é€šè¿‡å‚æ•°overwriteæ§åˆ¶æ˜¯å¦éœ€è¦ä¿®æ”¹ç°æœ‰å˜é‡çš„å€¼è€Œä»…ä»¥æ·»åŠ å˜é‡ä¸ºç›®çš„ï¼Œæ˜¾ç„¶putenv()å¹¶ä¸èƒ½è¿›è¡Œæ§åˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">3</span> &gt; argc) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: ä¼ å…¥ name value\n&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">/* æ·»åŠ ç¯å¢ƒå˜é‡ */</span></span><br><span class="line"> <span class="keyword">if</span> (setenv(argv[<span class="number">1</span>], argv[<span class="number">2</span>], <span class="number">0</span>)) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;setenv error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>unsetenv()å‡½æ•°<br>unsetenv()å‡½æ•°å¯ä»¥ä»ç¯å¢ƒå˜é‡è¡¨ä¸­ç§»é™¤å‚æ•° name æ ‡è¯†çš„ç¯å¢ƒå˜é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">unsetenv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure><p><strong>æ¸…ç©ºç¯å¢ƒå˜é‡</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">clearenv</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>clearenv()å‡½æ•°å†…éƒ¨çš„åšæ³•å…¶å®å°±æ˜¯å°†environèµ‹å€¼ä¸ºNULLã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨setenv()å‡½æ•°å’Œclearenv()å‡½æ•°å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå†…å­˜æ³„æ¼ï¼Œå‰é¢æåˆ°è¿‡ï¼Œsetenv()å‡½æ•°ä¼šä¸ºç¯å¢ƒå˜é‡åˆ†é…ä¸€å—å†…å­˜ç¼“å†²åŒºï¼Œéšä¹‹ç§°ä¸ºè¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼›è€Œè°ƒç”¨ clearenv()å‡½æ•°æ—¶æ²¡æœ‰é‡Šæ”¾è¯¥ç¼“å†²åŒºï¼ˆclearenv()è°ƒç”¨å¹¶ä¸çŸ¥æ™“è¯¥ç¼“å†²åŒºçš„å­˜åœ¨ï¼Œæ•…è€Œä¹Ÿæ— æ³•å°†å…¶é‡Šæ”¾ï¼‰ï¼Œåå¤è°ƒç”¨è€…ä¸¤ä¸ªå‡½æ•°çš„ç¨‹åºï¼Œä¼šä¸æ–­äº§ç”Ÿå†…å­˜æ³„æ¼ã€‚</p><h3 id="è¿›ç¨‹çš„å†…å­˜å¸ƒå±€"><a href="#è¿›ç¨‹çš„å†…å­˜å¸ƒå±€" class="headerlink" title="è¿›ç¨‹çš„å†…å­˜å¸ƒå±€"></a>è¿›ç¨‹çš„å†…å­˜å¸ƒå±€</h3><p>âš« æ­£æ–‡æ®µã€‚ä¹Ÿå¯ç§°ä¸ºä»£ç æ®µï¼Œè¿™æ˜¯ CPU æ‰§è¡Œçš„æœºå™¨è¯­è¨€æŒ‡ä»¤éƒ¨åˆ†ï¼Œæ–‡æœ¬æ®µå…·æœ‰åªè¯»å±æ€§ï¼Œä»¥é˜²æ­¢ç¨‹åºç”±äºæ„å¤–è€Œä¿®æ”¹å…¶æŒ‡ä»¤ï¼›æ­£æ–‡æ®µæ˜¯å¯ä»¥å…±äº«çš„ï¼Œå³ä½¿åœ¨å¤šä¸ªè¿›ç¨‹é—´ä¹Ÿå¯åŒæ—¶è¿è¡ŒåŒä¸€æ®µç¨‹åºã€‚<br>âš« åˆå§‹åŒ–æ•°æ®æ®µã€‚é€šå¸¸å°†æ­¤æ®µç§°ä¸ºæ•°æ®æ®µï¼ŒåŒ…å«äº†æ˜¾å¼åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå½“ç¨‹åºåŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œä»å¯æ‰§è¡Œæ–‡ä»¶ä¸­è¯»å–è¿™äº›å˜é‡çš„å€¼ã€‚<br>âš« æœªåˆå§‹åŒ–æ•°æ®æ®µã€‚åŒ…å«äº†æœªè¿›è¡Œæ˜¾å¼åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œé€šå¸¸å°†æ­¤æ®µç§°ä¸º bss æ®µï¼Œè¿™ä¸€åè¯æ¥æºäºæ—©æœŸæ±‡ç¼–ç¨‹åºä¸­çš„ä¸€ä¸ªæ“ä½œç¬¦ï¼Œæ„æ€æ˜¯â€œç”±ç¬¦å·å¼€å§‹çš„å—â€ï¼ˆblock started by symbolï¼‰ï¼Œåœ¨ç¨‹åºå¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œç³»ç»Ÿä¼šå°†æœ¬æ®µå†…æ‰€æœ‰å†…å­˜åˆå§‹åŒ–ä¸º 0ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¹¶æ²¡æœ‰ä¸º bss æ®µå˜é‡åˆ†é…å­˜å‚¨ç©ºé—´ï¼Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­åªéœ€è®°å½• bss æ®µçš„ä½ç½®åŠå…¶æ‰€éœ€å¤§å°ï¼Œç›´åˆ°ç¨‹åºè¿è¡Œæ—¶ï¼Œç”±åŠ è½½å™¨æ¥åˆ†é…è¿™ä¸€æ®µå†…å­˜ç©ºé—´ã€‚<br>âš« æ ˆã€‚å‡½æ•°å†…çš„å±€éƒ¨å˜é‡ä»¥åŠæ¯æ¬¡å‡½æ•°è°ƒç”¨æ—¶æ‰€éœ€ä¿å­˜çš„ä¿¡æ¯éƒ½æ”¾åœ¨æ­¤æ®µä¸­ï¼Œæ¯æ¬¡è°ƒç”¨å‡½æ•°æ—¶ï¼Œå‡½æ•°ä¼ é€’çš„å®å‚ä»¥åŠå‡½æ•°è¿”å›å€¼ç­‰ä¹Ÿéƒ½å­˜æ”¾åœ¨æ ˆä¸­ã€‚æ ˆæ˜¯ä¸€ä¸ªåŠ¨æ€å¢é•¿å’Œæ”¶ç¼©çš„æ®µï¼Œç”±æ ˆå¸§ç»„æˆï¼Œç³»ç»Ÿä¼šä¸ºæ¯ä¸ªå½“å‰è°ƒç”¨çš„å‡½æ•°åˆ†é…ä¸€ä¸ªæ ˆå¸§ï¼Œæ ˆå¸§ä¸­å­˜å‚¨äº†å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼ˆæ‰€è°“è‡ªåŠ¨å˜é‡ï¼‰ã€å®å‚å’Œè¿”å›å€¼ã€‚<br>âš« å †ã€‚å¯åœ¨è¿è¡Œæ—¶åŠ¨æ€è¿›è¡Œå†…å­˜åˆ†é…çš„ä¸€å—åŒºåŸŸï¼Œè­¬å¦‚ä½¿ç”¨ malloc()åˆ†é…çš„å†…å­˜ç©ºé—´ï¼Œå°±æ˜¯ä»ç³»ç»Ÿå †å†…å­˜ä¸­ç”³è¯·åˆ†é…çš„ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230110_200011.png"></p><h3 id="è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´"><a href="#è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´"></a>è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´</h3><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œé‡‡ç”¨äº†è™šæ‹Ÿå†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œè™šæ‹Ÿåœ°å€ä¼šé€šè¿‡ç¡¬ä»¶ MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰æ˜ å°„åˆ°å®é™…çš„ç‰©ç†åœ°å€ç©ºé—´ä¸­ï¼Œå»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»åï¼Œå¯¹è™šæ‹Ÿåœ°å€çš„è¯»å†™æ“ä½œå®é™…ä¸Šå°±æ˜¯å¯¹ç‰©ç†åœ°å€çš„è¯»å†™æ“ä½œï¼ŒMMU ä¼šå°†ç‰©ç†åœ°å€â€œç¿»è¯‘â€ä¸ºå¯¹åº”çš„ç‰©ç†åœ°å€ã€‚</p><p>ä½¿å¾—è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å’Œç‰©ç†åœ°å€ç©ºé—´éš”ç¦»å¼€æ¥ï¼Œè¿™æ ·åšå¸¦æ¥äº†å¾ˆå¤šçš„ä¼˜ç‚¹ï¼š<br>âš« è¿›ç¨‹ä¸è¿›ç¨‹ã€è¿›ç¨‹ä¸å†…æ ¸ç›¸äº’éš”ç¦»ã€‚ä¸€ä¸ªè¿›ç¨‹ä¸èƒ½è¯»å–æˆ–ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹æˆ–å†…æ ¸çš„å†…å­˜æ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„åˆ°äº†ä¸åŒçš„ç‰©ç†åœ°å€ç©ºé—´ã€‚æé«˜äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ä¸ç¨³å®šæ€§ã€‚<br>âš« åœ¨æŸäº›åº”ç”¨åœºåˆä¸‹ï¼Œä¸¤ä¸ªæˆ–è€…æ›´å¤šè¿›ç¨‹èƒ½å¤Ÿå…±äº«å†…å­˜ã€‚å› ä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„æ˜ å°„è¡¨ï¼Œå¯ä»¥è®©ä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„åˆ°ç›¸åŒçš„ç‰©ç†åœ°å€ç©ºé—´ä¸­ã€‚é€šå¸¸ï¼Œå…±äº«å†…å­˜å¯ç”¨äºå®ç°è¿›ç¨‹é—´é€šä¿¡ã€‚<br>âš« ä¾¿äºå®ç°å†…å­˜ä¿æŠ¤æœºåˆ¶ã€‚è­¬å¦‚åœ¨å¤šä¸ªè¿›ç¨‹å…±äº«å†…å­˜æ—¶ï¼Œå…è®¸æ¯ä¸ªè¿›ç¨‹å¯¹å†…å­˜é‡‡å–ä¸åŒçš„ä¿æŠ¤æªæ–½ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä»¥åªè¯»æ–¹å¼è®¿é—®å†…å­˜ï¼Œè€Œå¦ä¸€è¿›ç¨‹åˆ™èƒ½å¤Ÿä»¥å¯è¯»å¯å†™çš„æ–¹å¼è®¿é—®ã€‚<br>âš« ç¼–è¯‘åº”ç”¨ç¨‹åºæ—¶ï¼Œæ— éœ€å…³å¿ƒé“¾æ¥åœ°å€ã€‚å‰é¢æåˆ°äº†ï¼Œå½“ç¨‹åºè¿è¡Œæ—¶ï¼Œè¦æ±‚é“¾æ¥åœ°å€ä¸è¿è¡Œåœ°å€ä¸€è‡´ï¼Œåœ¨å¼•å…¥äº†è™šæ‹Ÿåœ°å€æœºåˆ¶åï¼Œä¾¿æ— éœ€å…³å¿ƒè¿™ä¸ªé—®é¢˜ã€‚</p><h3 id="forkåˆ›å»ºå­è¿›ç¨‹"><a href="#forkåˆ›å»ºå­è¿›ç¨‹" class="headerlink" title="forkåˆ›å»ºå­è¿›ç¨‹"></a>forkåˆ›å»ºå­è¿›ç¨‹</h3><p>ä¸€ä¸ªç°æœ‰çš„è¿›ç¨‹å¯ä»¥è°ƒç”¨ fork()å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œè°ƒç”¨ fork()å‡½æ•°çš„è¿›ç¨‹ç§°ä¸ºçˆ¶è¿›ç¨‹ï¼Œç”± fork()å‡½æ•°åˆ›å»ºå‡ºæ¥çš„è¿›ç¨‹è¢«ç§°ä¸ºå­è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¸å¤šçš„åº”ç”¨ä¸­ï¼Œåˆ›å»ºå¤šä¸ªè¿›ç¨‹æ˜¯ä»»åŠ¡åˆ†è§£æ—¶è¡Œä¹‹æœ‰æ•ˆçš„æ–¹æ³•ï¼Œè­¬å¦‚ï¼ŒæŸä¸€ç½‘ç»œæœåŠ¡å™¨è¿›ç¨‹å¯åœ¨ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚çš„åŒæ—¶ï¼Œä¸ºå¤„ç†æ¯ä¸€ä¸ªè¯·æ±‚äº‹ä»¶è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œä¸æ­¤åŒæ—¶ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ä¼šç»§ç»­ç›‘å¬æ›´å¤šçš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ã€‚åœ¨ä¸€ä¸ªå¤§å‹çš„åº”ç”¨ç¨‹åºä»»åŠ¡ä¸­ï¼Œåˆ›å»ºå­è¿›ç¨‹é€šå¸¸ä¼šç®€åŒ–åº”ç”¨ç¨‹åºçš„è®¾è®¡ï¼ŒåŒæ—¶æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘æ€§ã€‚</p><p><u>åœ¨ç¨‹åºä»£ç ä¸­ï¼Œå¯é€šè¿‡è¿”å›å€¼æ¥åŒºåˆ†æ˜¯å­è¿›ç¨‹è¿˜æ˜¯çˆ¶è¿›ç¨‹ã€‚</u>fork()è°ƒç”¨æˆåŠŸåï¼Œå°†ä¼šåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹çš„ PIDï¼Œè€Œåœ¨å­è¿›ç¨‹ä¸­è¿”å›å€¼æ˜¯ 0ï¼›å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œçˆ¶è¿›ç¨‹è¿”å›å€¼-1ï¼Œä¸åˆ›å»ºå­è¿›ç¨‹ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p>ork()è°ƒç”¨æˆåŠŸåï¼Œå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹ä¼šç»§ç»­æ‰§è¡Œ fork()è°ƒç”¨ä¹‹åçš„æŒ‡ä»¤ï¼Œå­è¿›ç¨‹ã€çˆ¶è¿›ç¨‹å„è‡ªåœ¨è‡ªå·±çš„è¿›ç¨‹ç©ºé—´ä¸­è¿è¡Œã€‚äº‹å®ä¸Šï¼Œå­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œè­¬å¦‚å­è¿›ç¨‹æ‹·è´äº†çˆ¶è¿›ç¨‹çš„æ•°æ®æ®µã€å †ã€æ ˆä»¥åŠç»§æ‰¿äº†çˆ¶è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å¹¶ä¸å…±äº«è¿™äº›å­˜å‚¨ç©ºé—´ï¼Œè¿™æ˜¯å­è¿›ç¨‹å¯¹çˆ¶è¿›ç¨‹ç›¸åº”éƒ¨åˆ†å­˜å‚¨ç©ºé—´çš„å®Œå…¨å¤åˆ¶ï¼Œæ‰§è¡Œ fork()ä¹‹åï¼Œæ¯ä¸ªè¿›ç¨‹å‡å¯ä¿®æ”¹å„è‡ªçš„æ ˆæ•°æ®ä»¥åŠå †æ®µä¸­çš„å˜é‡ï¼Œè€Œå¹¶ä¸å½±å“å¦ä¸€ä¸ªè¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pid_t</span> pid;</span><br><span class="line">pid = fork();</span><br><span class="line"> <span class="keyword">switch</span> (pid) </span><br><span class="line">    &#123;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">-1</span>:perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="keyword">case</span> <span class="number">0</span>:<span class="built_in">printf</span>(<span class="string">&quot;è¿™æ˜¯å­è¿›ç¨‹æ‰“å°ä¿¡æ¯&lt;pid: %d, çˆ¶è¿›ç¨‹ pid: %d&gt;\n&quot;</span>,getpid(), getppid());</span><br><span class="line"> _exit(<span class="number">0</span>); <span class="comment">//å­è¿›ç¨‹ä½¿ç”¨_exit()é€€å‡º</span></span><br><span class="line"> <span class="keyword">default</span>:<span class="built_in">printf</span>(<span class="string">&quot;è¿™æ˜¯çˆ¶è¿›ç¨‹æ‰“å°ä¿¡æ¯&lt;pid: %d, å­è¿›ç¨‹ pid: %d&gt;\n&quot;</span>,getpid(), pid);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><u>å­è¿›ç¨‹è¢«åˆ›å»ºå‡ºæ¥ä¹‹åï¼Œä¾¿æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´ï¼Œç³»ç»Ÿå†…å”¯ä¸€çš„è¿›ç¨‹å·ï¼Œæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ PCBï¼ˆè¿›ç¨‹æ§åˆ¶å—ï¼‰ï¼Œå­è¿›ç¨‹ä¼šè¢«å†…æ ¸åŒç­‰è°ƒåº¦æ‰§è¡Œï¼Œå‚ä¸åˆ°ç³»ç»Ÿçš„è¿›ç¨‹è°ƒåº¦ä¸­ã€‚</u></p><h3 id="çˆ¶å­è¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«"><a href="#çˆ¶å­è¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«" class="headerlink" title="çˆ¶å­è¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«"></a>çˆ¶å­è¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«</h3><p><strong>è°ƒç”¨ fork()å‡½æ•°ä¹‹åï¼Œå­è¿›ç¨‹ä¼šè·å¾—çˆ¶è¿›ç¨‹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„å‰¯æœ¬ï¼Œè¿™äº›å‰¯æœ¬çš„åˆ›å»ºæ–¹å¼ç±»ä¼¼äº dup()ï¼Œè¿™ä¹Ÿæ„å‘³ç€çˆ¶ã€å­è¿›ç¨‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‡æŒ‡å‘ç›¸åŒçš„æ–‡ä»¶è¡¨ã€‚</strong></p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230114_190912.png"></p><p>å­è¿›ç¨‹æ‹·è´äº†çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œä½¿å¾—çˆ¶ã€å­è¿›ç¨‹ä¸­å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘äº†ç›¸åŒçš„æ–‡ä»¶è¡¨ï¼Œä¹Ÿæ„å‘³ç€çˆ¶ã€å­è¿›ç¨‹ä¸­å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘äº†ç£ç›˜ä¸­ç›¸åŒçš„æ–‡ä»¶ï¼Œå› è€Œè¿™äº›æ–‡ä»¶åœ¨çˆ¶ã€å­è¿›ç¨‹é—´å®ç°äº†å…±äº«.</p><p>fork()å‡½æ•°æœ‰ä»¥ä¸‹ä¸¤ç§ç”¨æ³•ï¼š<br>âš« çˆ¶è¿›ç¨‹å¸Œæœ›å­è¿›ç¨‹å¤åˆ¶è‡ªå·±ï¼Œä½¿çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹åŒæ—¶æ‰§è¡Œä¸åŒçš„ä»£ç æ®µã€‚è¿™åœ¨ç½‘ç»œæœåŠ¡è¿›ç¨‹ä¸­æ˜¯å¸¸è§çš„ï¼Œçˆ¶è¿›ç¨‹ç­‰å¾…å®¢æˆ·ç«¯çš„æœåŠ¡è¯·æ±‚ï¼Œå½“æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚äº‹ä»¶åï¼Œè°ƒç”¨ fork()åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œä½¿å­è¿›ç¨‹å»å¤„ç†æ­¤è¯·æ±‚ã€è€Œçˆ¶è¿›ç¨‹å¯ä»¥ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªæœåŠ¡è¯·æ±‚ã€‚<br>âš« ä¸€ä¸ªè¿›ç¨‹è¦æ‰§è¡Œä¸åŒçš„ç¨‹åºã€‚è­¬å¦‚åœ¨ç¨‹åº app1 ä¸­è°ƒç”¨ fork()å‡½æ•°åˆ›å»ºäº†å­è¿›ç¨‹ï¼Œæ­¤æ—¶å­è¿›ç¨‹æ˜¯è¦å»æ‰§è¡Œå¦ä¸€ä¸ªç¨‹åº app2ï¼Œä¹Ÿå°±æ˜¯å­è¿›ç¨‹éœ€è¦æ‰§è¡Œçš„ä»£ç æ˜¯ app2 ç¨‹åºå¯¹åº”çš„ä»£ç ï¼Œå­è¿›ç¨‹å°†ä» app2ç¨‹åºçš„ main å‡½æ•°å¼€å§‹è¿è¡Œã€‚è¿™ç§æƒ…å†µï¼Œé€šå¸¸åœ¨å­è¿›ç¨‹ä» fork()å‡½æ•°è¿”å›ä¹‹åç«‹å³è°ƒç”¨ exec æ—å‡½æ•°æ¥å®ç°ã€‚</p><h3 id="fork-ä¹‹åçš„ç«äº‰æ¡ä»¶"><a href="#fork-ä¹‹åçš„ç«äº‰æ¡ä»¶" class="headerlink" title="fork()ä¹‹åçš„ç«äº‰æ¡ä»¶"></a>fork()ä¹‹åçš„ç«äº‰æ¡ä»¶</h3><p>è°ƒç”¨ fork ä¹‹åï¼Œæ— æ³•ç¡®å®šçˆ¶ã€å­ä¸¤ä¸ªè¿›ç¨‹è°å°†ç‡å…ˆè®¿é—® CPUï¼Œä¹Ÿå°±æ˜¯è¯´æ— æ³•ç¡®è®¤è°å…ˆè¢«ç³»ç»Ÿè°ƒç”¨è¿è¡Œï¼ˆåœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œå®ƒä»¬å¯èƒ½ä¼šåŒæ—¶å„è‡ªè®¿é—®ä¸€ä¸ª CPUï¼‰ï¼Œè¿™å°†å¯¼è‡´è°å…ˆè¿è¡Œã€è°åè¿è¡Œè¿™ä¸ªé¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚</p><p>ä¸ºç¡®ä¿ä½¿å­è¿›ç¨‹ä¼˜å…ˆäºçˆ¶è¿›ç¨‹æˆ–è€…çˆ¶è¿›ç¨‹ä¼˜å…ˆäºå­è¿›ç¨‹ï¼Œå¯ä»¥ç”¨ä¿¡å·é˜»å¡æ¥å®ç°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">sig_handler</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ¥æ”¶åˆ°ä¿¡å·\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sig</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">sigset_t</span> wait_mask;</span><br><span class="line">    </span><br><span class="line">    sigemptyset(&amp;wait_mask);</span><br><span class="line">    </span><br><span class="line">    sig.sa_handler = sig_handler;</span><br><span class="line">    sig.sa_flags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(sigaction(SIGUSR1, &amp;sig, <span class="literal">NULL</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;sigaction error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="keyword">switch</span>(fork())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">            perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;å­è¿›ç¨‹å¼€å§‹æ‰§è¡Œ\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;å­è¿›ç¨‹æ‰“å°ä¿¡æ¯\n&quot;</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;~~~~~~~~~~~~~~~\n&quot;</span>);</span><br><span class="line"> sleep(<span class="number">2</span>);</span><br><span class="line">            kill(getppid(), SIGUSR1);</span><br><span class="line">            _exit(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span>(sigsuspend(&amp;wait_mask) != <span class="number">-1</span>)<span class="comment">//æŒ‚èµ·é˜»å¡</span></span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;çˆ¶è¿›ç¨‹æ‰§è¡Œ\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;çˆ¶è¿›ç¨‹æ‰“å°ä¿¡æ¯\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­è¿›ç¨‹å…ˆè¿è¡Œæ‰“å°ç›¸åº”ä¿¡æ¯ï¼Œä¹‹åå†æ‰§è¡Œçˆ¶è¿›ç¨‹æ‰“å°ä¿¡æ¯ï¼Œåœ¨çˆ¶è¿›ç¨‹åˆ†æ”¯ä¸­ï¼Œç›´æ¥è°ƒç”¨äº† sigsuspend()ä½¿çˆ¶è¿›ç¨‹è¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œç”±å­è¿›ç¨‹é€šè¿‡ kill å‘½ä»¤å‘é€ä¿¡å·å”¤é†’ã€‚</p><h3 id="è¿›ç¨‹çš„è¯ç”Ÿä¸ç»ˆæ­¢"><a href="#è¿›ç¨‹çš„è¯ç”Ÿä¸ç»ˆæ­¢" class="headerlink" title="è¿›ç¨‹çš„è¯ç”Ÿä¸ç»ˆæ­¢"></a>è¿›ç¨‹çš„è¯ç”Ÿä¸ç»ˆæ­¢</h3><p><u>init è¿›ç¨‹çš„ PID æ€»æ˜¯ä¸º 1ï¼Œå®ƒæ˜¯æ‰€æœ‰å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œä¸€åˆ‡ä» 1 å¼€å§‹ã€ä¸€åˆ‡ä» init è¿›ç¨‹å¼€å§‹ï¼</u></p><p>è¿›ç¨‹æœ‰ä¸¤ç§ç»ˆæ­¢æ–¹å¼ï¼šå¼‚å¸¸ç»ˆæ­¢å’Œæ­£å¸¸ç»ˆæ­¢ã€‚</p><p>ä¸€èˆ¬ä½¿ç”¨ exit()åº“å‡½æ•°è€Œé_exit()ç³»ç»Ÿè°ƒç”¨ï¼ŒåŸå› åœ¨äº exit()æœ€ç»ˆä¹Ÿä¼šé€šè¿‡_exit()ç»ˆæ­¢è¿›ç¨‹ï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œå®ƒå°†ä¼šå®Œæˆä¸€äº›å…¶å®ƒçš„å·¥ä½œï¼Œexit()å‡½æ•°ä¼šæ‰§è¡Œçš„åŠ¨ä½œå¦‚ä¸‹ï¼š<br>âš« å¦‚æœç¨‹åºä¸­æ³¨å†Œäº†è¿›ç¨‹ç»ˆæ­¢å¤„ç†å‡½æ•°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ç»ˆæ­¢å¤„ç†å‡½æ•°ã€‚<br>âš« åˆ·æ–° stdio æµç¼“å†²åŒºã€‚å…³äº stdio æµç¼“å†²åŒºçš„é—®é¢˜ï¼Œç¨åç¼–å†™ä¸€ä¸ªç®€å•åœ°æµ‹è¯•ç¨‹åºè¿›è¡Œè¯´æ˜ï¼›<br>âš« æ‰§è¡Œ_exit()ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>ä¸€èˆ¬æ¨èçš„æ˜¯å­è¿›ç¨‹ä½¿ç”¨_exit()é€€å‡ºã€è€Œçˆ¶è¿›ç¨‹åˆ™ä½¿ç”¨ exit()é€€å‡ºã€‚å…¶åŸå› å°±åœ¨äºè°ƒç”¨ exit()å‡½æ•°ç»ˆæ­¢è¿›ç¨‹æ—¶ä¼šåˆ·æ–°è¿›ç¨‹çš„ stdio ç¼“å†²åŒºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Hello World!&quot;</span>);<span class="comment">//æœ‰æ¢è¡Œç¬¦æ‰“å°1æ¬¡æ²¡æœ‰æ‰“å°ä¸¤æ¬¡</span></span><br><span class="line"> <span class="keyword">switch</span> (fork()) &#123;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line"> perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"> <span class="comment">/* å­è¿›ç¨‹ */</span></span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> <span class="keyword">default</span>:</span><br><span class="line"> <span class="comment">/* çˆ¶è¿›ç¨‹ */</span></span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æ¢è¡Œç¬¦é€šè¿‡ fork()åˆ›å»ºå­è¿›ç¨‹æ—¶ä¼šå¤åˆ¶è¿™äº›ç¼“å†²åŒºã€‚æ ‡å‡†è¾“å‡ºè®¾å¤‡é»˜è®¤ä½¿ç”¨çš„æ˜¯è¡Œç¼“å†²ï¼Œå½“æ£€æµ‹åˆ°æ¢è¡Œç¬¦\n æ—¶ä¼šç«‹å³æ˜¾ç¤ºå‡½æ•° printf()è¾“å‡ºçš„å­—ç¬¦ä¸²ï¼›æ— æ¢è¡Œç¬¦æ‰€ä»¥ä¼šç«‹å³è¯»èµ°ç¼“å†²åŒºä¸­çš„æ•°æ®å¹¶æ˜¾ç¤ºï¼Œè¯»èµ°ä¹‹åæ­¤æ—¶ç¼“å†²åŒºå°±ç©ºäº†ï¼Œå­è¿›ç¨‹è™½ç„¶æ‹·è´äº†çˆ¶è¿›ç¨‹çš„ç¼“å†²åŒºï¼Œä½†æ˜¯ç©ºçš„ï¼Œè™½ç„¶çˆ¶ã€å­è¿›ç¨‹ä½¿ç”¨ exit()é€€å‡ºæ—¶ä¼šåˆ·æ–°å„è‡ªçš„ç¼“å†²åŒºï¼Œä½†å¯¹äºç©ºç¼“å†²åŒºè‡ªç„¶æ— æ•°æ®å¯è¯»ã€‚</p><p>å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ä»»ä¸€æ–¹æ³•æ¥é¿å…é‡å¤çš„è¾“å‡ºç»“æœï¼š<br>âš« å¯¹äºè¡Œç¼“å†²è®¾å¤‡ï¼Œå¯ä»¥åŠ ä¸Šå¯¹åº”æ¢è¡Œç¬¦ï¼Œè­¬å¦‚ printf æ‰“å°è¾“å‡ºå­—ç¬¦ä¸²æ—¶åœ¨å­—ç¬¦ä¸²åé¢æ·»åŠ \n æ¢è¡Œç¬¦ï¼Œå¯¹äº puts()å‡½æ•°æ¥è¯´ï¼Œæœ¬èº«ä¼šè‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ï¼›<br>âš« åœ¨è°ƒç”¨ fork()ä¹‹å‰ï¼Œä½¿ç”¨å‡½æ•° fflush()æ¥åˆ·æ–° stdio ç¼“å†²åŒºï¼Œå½“ç„¶ï¼Œä½œä¸ºå¦ä¸€ç§é€‰æ‹©ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨setvbuf()å’Œ setbuf()æ¥å…³é—­ stdio æµçš„ç¼“å†²åŠŸèƒ½ï¼›<br>âš« å­è¿›ç¨‹è°ƒç”¨_ exit()é€€å‡ºè¿›ç¨‹ä¸æ˜¯ä½¿ç”¨exit()ï¼Œè°ƒç”¨_exit()åœ¨é€€å‡ºæ—¶ä¾¿ä¸ä¼šåˆ·æ–° stdio ç¼“å†²åŒºã€‚</p><h3 id="ç›‘è§†å­è¿›ç¨‹"><a href="#ç›‘è§†å­è¿›ç¨‹" class="headerlink" title="ç›‘è§†å­è¿›ç¨‹"></a>ç›‘è§†å­è¿›ç¨‹</h3><p>çˆ¶è¿›ç¨‹éœ€è¦çŸ¥é“å­è¿›ç¨‹äºä½•æ—¶è¢«ç»ˆæ­¢ï¼Œå¹¶ä¸”éœ€è¦çŸ¥é“å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ä¿¡æ¯ï¼Œæ˜¯æ­£å¸¸ç»ˆæ­¢ã€è¿˜æ˜¯å¼‚å¸¸ç»ˆæ­¢äº¦æˆ–è€…è¢«ä¿¡å·ç»ˆæ­¢ç­‰ï¼Œæ„å‘³ç€çˆ¶è¿›ç¨‹ä¼šå¯¹å­è¿›ç¨‹è¿›è¡Œç›‘è§†ã€‚</p><p><strong>wait()å‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">wait</span><span class="params">(<span class="type">int</span> *status)</span>;</span><br></pre></td></tr></table></figure><p>statusï¼šå‚æ•° status ç”¨äºå­˜æ”¾å­è¿›ç¨‹ç»ˆæ­¢æ—¶çš„çŠ¶æ€ä¿¡æ¯ï¼Œå‚æ•° status å¯ä»¥ä¸º NULLï¼Œè¡¨ç¤ºä¸æ¥æ”¶å­è¿›ç¨‹ç»ˆæ­¢æ—¶çš„çŠ¶æ€ä¿¡æ¯ã€‚<br>è¿”å›å€¼ï¼šè‹¥æˆåŠŸåˆ™è¿”å›ç»ˆæ­¢çš„å­è¿›ç¨‹å¯¹åº”çš„è¿›ç¨‹å·ï¼›å¤±è´¥åˆ™è¿”å›-1ã€‚<br>ç³»ç»Ÿè°ƒç”¨ wait()å°†æ‰§è¡Œå¦‚ä¸‹åŠ¨ä½œï¼š</p><p>âš« è°ƒç”¨ wait()å‡½æ•°ï¼Œå¦‚æœå…¶æ‰€æœ‰å­è¿›ç¨‹éƒ½è¿˜åœ¨è¿è¡Œï¼Œåˆ™ wait()ä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æŸä¸€ä¸ªå­è¿›ç¨‹ç»ˆæ­¢ï¼›                                                                                                                                                                                    âš« å¦‚æœè¿›ç¨‹è°ƒç”¨ wait()ï¼Œä½†æ˜¯è¯¥è¿›ç¨‹å¹¶æ²¡æœ‰å­è¿›ç¨‹ï¼Œä¹Ÿå°±æ„å‘³ç€è¯¥è¿›ç¨‹å¹¶æ²¡æœ‰éœ€è¦ç­‰å¾…çš„å­è¿›ç¨‹ï¼Œé‚£ä¹ˆ wait()å°†è¿”å›é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯è¿”å›-1ã€å¹¶ä¸”ä¼šå°† errno è®¾ç½®ä¸º ECHILDã€‚<br>âš« å¦‚æœè¿›ç¨‹è°ƒç”¨ wait()ä¹‹å‰ï¼Œå®ƒçš„å­è¿›ç¨‹å½“ä¸­å·²ç»æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹å·²ç»ç»ˆæ­¢äº†ï¼Œé‚£ä¹ˆè°ƒç”¨ wait()ä¹Ÿä¸ä¼šå¡ã€‚wait()å‡½æ•°çš„ä½œç”¨é™¤äº†è·å–å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ä¿¡æ¯ä¹‹å¤–ï¼Œæ›´é‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯å›æ”¶å­è¿›ç¨‹çš„ä¸€äº›èµ„æºï¼Œä¿—ç§°ä¸ºå­è¿›ç¨‹â€œæ”¶å°¸â€ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ wait()å‡½æ•°ä¹‹å‰ï¼Œå·²ç»æœ‰å­è¿›ç¨‹ç»ˆæ­¢äº†ï¼Œæ„å‘³ç€æ­£ç­‰å¾…ç€çˆ¶è¿›ç¨‹ä¸ºå…¶â€œæ”¶å°¸â€ï¼Œæ‰€ä»¥è°ƒç”¨ wait()å°†ä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯ä¼šç«‹å³æ›¿è¯¥å­è¿›ç¨‹â€œæ”¶å°¸â€ã€å¤„ç†å®ƒçš„â€œåäº‹â€ï¼Œç„¶åè¿”å›åˆ°æ­£å¸¸çš„ç¨‹åºæµç¨‹ä¸­ï¼Œä¸€æ¬¡ wait()è°ƒç”¨åªèƒ½å¤„ç†ä¸€æ¬¡ã€‚</p><p>å‚æ•° status ä¸ä¸º NULL çš„æƒ…å†µä¸‹ï¼Œåˆ™ wait()ä¼šå°†å­è¿›ç¨‹çš„ç»ˆæ­¢æ—¶çš„çŠ¶æ€ä¿¡æ¯å­˜å‚¨åœ¨å®ƒæŒ‡å‘çš„ int å˜é‡ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å®æ¥æ£€æŸ¥ status å‚æ•°ï¼š<br>âš« WIFEXITED(status)ï¼šå¦‚æœå­è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢ï¼Œåˆ™è¿”å› trueï¼›<br>âš« WEXITSTATUS(status)ï¼šè¿”å›å­è¿›ç¨‹é€€å‡ºçŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ªæ•°å€¼ï¼Œå…¶å®å°±æ˜¯å­è¿›ç¨‹è°ƒç”¨_ exit()æˆ– exit()æ—¶æŒ‡å®šçš„é€€å‡ºçŠ¶æ€ï¼›wait()è·å–å¾—åˆ°çš„ status å‚æ•°å¹¶ä¸æ˜¯è°ƒç”¨_exit()æˆ– exit()æ—¶æŒ‡å®šçš„çŠ¶æ€ï¼Œå¯é€šè¿‡WEXITSTATUS å®è½¬æ¢ï¼›<br>âš« WIFSIGNALED(status)ï¼šå¦‚æœå­è¿›ç¨‹è¢«ä¿¡å·ç»ˆæ­¢ï¼Œåˆ™è¿”å› trueï¼›<br>âš« WTERMSIG(status)ï¼šè¿”å›å¯¼è‡´å­è¿›ç¨‹ç»ˆæ­¢çš„ä¿¡å·ç¼–å·ã€‚å¦‚æœå­è¿›ç¨‹æ˜¯è¢«ä¿¡å·æ‰€ç»ˆæ­¢ï¼Œåˆ™å¯ä»¥é€šè¿‡æ­¤å®è·å–ç»ˆæ­¢å­è¿›ç¨‹çš„ä¿¡å·ï¼›<br>âš« WCOREDUMP(status)ï¼šå¦‚æœå­è¿›ç¨‹ç»ˆæ­¢æ—¶äº§ç”Ÿäº†æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œåˆ™è¿”å› trueï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> status;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"> <span class="comment">/* å¾ªç¯åˆ›å»º 3 ä¸ªå­è¿›ç¨‹ */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) </span><br><span class="line">    &#123;</span><br><span class="line"> <span class="keyword">switch</span> (fork()) &#123;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line"> perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"> <span class="comment">/* å­è¿›ç¨‹ */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;å­è¿›ç¨‹&lt;%d&gt;è¢«åˆ›å»º\n&quot;</span>, getpid());</span><br><span class="line"> sleep(i);</span><br><span class="line"> _exit(i);</span><br><span class="line"> <span class="keyword">default</span>:</span><br><span class="line"> <span class="comment">/* çˆ¶è¿›ç¨‹ */</span></span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;~~~~~~~~~~~~~~\n&quot;</span>);</span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line"> ret = wait(&amp;status);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> <span class="keyword">if</span> (ECHILD == errno) &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ²¡æœ‰éœ€è¦ç­‰å¾…å›æ”¶çš„å­è¿›ç¨‹\n&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> &#123;</span><br><span class="line"> perror(<span class="string">&quot;wait error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;å›æ”¶å­è¿›ç¨‹&lt;%d&gt;, ç»ˆæ­¢çŠ¶æ€&lt;%d&gt;\n&quot;</span>, ret,WEXITSTATUS(status));</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ for å¾ªç¯åˆ›å»ºäº† 3 ä¸ªå­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹ä¸­å¾ªç¯è°ƒç”¨ wait()å‡½æ•°ç­‰å¾…å›æ”¶å­è¿›ç¨‹ï¼Œå¹¶å°†æœ¬æ¬¡å›æ”¶çš„å­è¿›ç¨‹è¿›ç¨‹å·ä»¥åŠç»ˆæ­¢çŠ¶æ€æ‰“å°å‡ºæ¥ã€‚</p><p><strong>waitpid()å‡½æ•°</strong></p><p>ä½¿ç”¨ wait()ç³»ç»Ÿè°ƒç”¨å­˜åœ¨ç€ä¸€äº›é™åˆ¶ï¼Œè¿™äº›é™åˆ¶åŒ…æ‹¬å¦‚ä¸‹ï¼š<br>âš« å¦‚æœçˆ¶è¿›ç¨‹åˆ›å»ºäº†å¤šä¸ªå­è¿›ç¨‹ï¼Œä½¿ç”¨ wait()å°†æ— æ³•ç­‰å¾…æŸä¸ªç‰¹å®šçš„å­è¿›ç¨‹çš„å®Œæˆï¼Œåªèƒ½æŒ‰ç…§é¡ºåºç­‰å¾…ä¸‹ä¸€ä¸ªå­è¿›ç¨‹çš„ç»ˆæ­¢ï¼Œä¸€ä¸ªä¸€ä¸ªæ¥ã€è°å…ˆç»ˆæ­¢å°±å…ˆå¤„ç†è°ï¼›<br>âš« å¦‚æœå­è¿›ç¨‹æ²¡æœ‰ç»ˆæ­¢ï¼Œæ­£åœ¨è¿è¡Œï¼Œé‚£ä¹ˆ wait()æ€»æ˜¯ä¿æŒé˜»å¡ï¼Œæœ‰æ—¶æˆ‘ä»¬å¸Œæœ›æ‰§è¡Œéé˜»å¡ç­‰å¾…ï¼Œæ˜¯å¦æœ‰å­è¿›ç¨‹ç»ˆæ­¢ï¼Œé€šè¿‡åˆ¤æ–­å³å¯å¾—çŸ¥ï¼›<br>âš« ä½¿ç”¨ wait()åªèƒ½å‘ç°é‚£äº›è¢«ç»ˆæ­¢çš„å­è¿›ç¨‹ï¼Œå¯¹äºå­è¿›ç¨‹å› æŸä¸ªä¿¡å·ï¼ˆè­¬å¦‚ SIGSTOP ä¿¡å·ï¼‰è€Œåœæ­¢ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œåœæ­¢æŒ‡çš„æš‚åœè¿è¡Œï¼‰ï¼Œæˆ–æ˜¯å·²åœæ­¢çš„å­è¿›ç¨‹æ”¶åˆ° SIGCONT ä¿¡å·åæ¢å¤æ‰§è¡Œçš„æƒ…å†µå°±æ— èƒ½ä¸ºåŠ›äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">waitpid</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> *status, <span class="type">int</span> options)</span>;</span><br></pre></td></tr></table></figure><p>pidï¼šå‚æ•° pid ç”¨äºè¡¨ç¤ºéœ€è¦ç­‰å¾…çš„æŸä¸ªå…·ä½“å­è¿›ç¨‹ï¼Œå…³äºå‚æ•° pid çš„å–å€¼èŒƒå›´å¦‚ä¸‹ï¼š<br>âš« å¦‚æœ pid å¤§äº 0ï¼Œè¡¨ç¤ºç­‰å¾…è¿›ç¨‹å·ä¸º pid çš„å­è¿›ç¨‹ï¼›<br>âš« å¦‚æœ pid ç­‰äº 0ï¼Œåˆ™ç­‰å¾…ä¸è°ƒç”¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰åŒä¸€ä¸ªè¿›ç¨‹ç»„çš„æ‰€æœ‰å­è¿›ç¨‹ï¼›<br>âš« å¦‚æœ pid å°äº-1ï¼Œåˆ™ä¼šç­‰å¾…è¿›ç¨‹ç»„æ ‡è¯†ç¬¦ä¸ pid ç»å¯¹å€¼ç›¸ç­‰çš„æ‰€æœ‰å­è¿›ç¨‹ï¼›<br>âš« å¦‚æœ pid ç­‰äº-1ï¼Œåˆ™ç­‰å¾…ä»»æ„å­è¿›ç¨‹ã€‚wait(&amp;status)ä¸ waitpid(-1, &amp;status, 0)ç­‰ä»·ã€‚<br>statusï¼šä¸ wait()å‡½æ•°çš„ status å‚æ•°æ„ä¹‰ç›¸åŒã€‚<br>å‚æ•° options æ˜¯ä¸€ä¸ªä½æ©ç ï¼Œå¯ä»¥åŒ…æ‹¬ 0 ä¸ªæˆ–å¤šä¸ªå¦‚ä¸‹æ ‡å¿—ï¼š<br>âš« WNOHANGï¼šå¦‚æœå­è¿›ç¨‹æ²¡æœ‰å‘ç”ŸçŠ¶æ€æ”¹å˜ï¼ˆç»ˆæ­¢ã€æš‚åœï¼‰ï¼Œåˆ™ç«‹å³è¿”å›ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œéé˜»å¡ç­‰<br>å¾…ï¼Œå¯ä»¥å®ç°è½®è®­ pollï¼Œé€šè¿‡è¿”å›å€¼å¯ä»¥åˆ¤æ–­æ˜¯å¦æœ‰å­è¿›ç¨‹å‘ç”ŸçŠ¶æ€æ”¹å˜ï¼Œè‹¥è¿”å›å€¼ç­‰äº 0 è¡¨ç¤ºæ²¡<br>æœ‰å‘ç”Ÿæ”¹å˜ã€‚<br>âš« WUNTRACEDï¼šé™¤äº†è¿”å›ç»ˆæ­¢çš„å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯å¤–ï¼Œè¿˜è¿”å›å› ä¿¡å·è€Œåœæ­¢ï¼ˆæš‚åœè¿è¡Œï¼‰çš„å­è¿›<br>ç¨‹çŠ¶æ€ä¿¡æ¯ï¼›<br>âš« WCONTINUEDï¼šè¿”å›é‚£äº›å› æ”¶åˆ° SIGCONT ä¿¡å·è€Œæ¢å¤è¿è¡Œçš„å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚</p><p>è¿”å›å€¼ï¼šè¿”å›å€¼ä¸ wait()å‡½æ•°çš„è¿”å›å€¼æ„ä¹‰åŸºæœ¬ç›¸åŒï¼Œåœ¨å‚æ•° options åŒ…å«äº† WNOHANG æ ‡å¿—çš„æƒ…å†µ<br>ä¸‹ï¼Œè¿”å›å€¼ä¼šå‡ºç° 0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span><span class="comment">//waitpid()é˜»å¡æ–¹å¼</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> status;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="type">int</span> i;</span><br><span class="line"> <span class="comment">/* å¾ªç¯åˆ›å»º 3 ä¸ªå­è¿›ç¨‹ */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="keyword">switch</span> (fork()) &#123;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line"> perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"> <span class="comment">/* å­è¿›ç¨‹ */</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;å­è¿›ç¨‹&lt;%d&gt;è¢«åˆ›å»º\n&quot;</span>, getpid());</span><br><span class="line"> sleep(i);</span><br><span class="line"> _exit(i);</span><br><span class="line"> <span class="keyword">default</span>:</span><br><span class="line"> <span class="comment">/* çˆ¶è¿›ç¨‹ */</span></span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;~~~~~~~~~~~~~~\n&quot;</span>);</span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) </span><br><span class="line"> &#123;</span><br><span class="line"> ret = waitpid(<span class="number">-1</span>, &amp;status, <span class="number">0</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> <span class="keyword">if</span> (ECHILD == errno) &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ²¡æœ‰éœ€è¦ç­‰å¾…å›æ”¶çš„å­è¿›ç¨‹\n&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> &#123;</span><br><span class="line"> perror(<span class="string">&quot;wait error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;å›æ”¶å­è¿›ç¨‹&lt;%d&gt;, ç»ˆæ­¢çŠ¶æ€&lt;%d&gt;\n&quot;</span>, ret,WEXITSTATUS(status));</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span><span class="comment">//è½®è®­æ–¹å¼</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> status;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="type">int</span> i;</span><br><span class="line"> <span class="comment">/* å¾ªç¯åˆ›å»º 3 ä¸ªå­è¿›ç¨‹ */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="keyword">switch</span> (fork()) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line"> perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"> <span class="comment">/* å­è¿›ç¨‹ */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;å­è¿›ç¨‹&lt;%d&gt;è¢«åˆ›å»º\n&quot;</span>, getpid());</span><br><span class="line"> sleep(i);</span><br><span class="line"> _exit(i);</span><br><span class="line"> <span class="keyword">default</span>:</span><br><span class="line"> <span class="comment">/* çˆ¶è¿›ç¨‹ */</span></span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;~~~~~~~~~~~~~~\n&quot;</span>);</span><br><span class="line"> <span class="keyword">for</span> ( ; ; ) </span><br><span class="line"> &#123;</span><br><span class="line"> ret = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; ret) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="keyword">if</span> (ECHILD == errno)</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> <span class="keyword">else</span> &#123;</span><br><span class="line"> perror(<span class="string">&quot;wait error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line"> <span class="keyword">continue</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;å›æ”¶å­è¿›ç¨‹&lt;%d&gt;, ç»ˆæ­¢çŠ¶æ€&lt;%d&gt;\n&quot;</span>, ret,WEXITSTATUS(status));</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åƒµå°¸è¿›ç¨‹å’Œå­¤å„¿è¿›ç¨‹</p><p>çˆ¶è¿›ç¨‹å…ˆäºå­è¿›ç¨‹ç»“æŸï¼Œä¹Ÿå°±æ˜¯æ„å‘³ç€ï¼Œæ­¤æ—¶å­è¿›ç¨‹å˜æˆäº†ä¸€ä¸ªâ€œå­¤å„¿â€ï¼Œæˆ‘ä»¬æŠŠè¿™ç§è¿›ç¨‹å°±ç§°ä¸ºå­¤å„¿è¿›ç¨‹ã€‚åœ¨ Linux ç³»ç»Ÿå½“ä¸­ï¼Œæ‰€æœ‰çš„å­¤å„¿è¿›ç¨‹éƒ½è‡ªåŠ¨æˆä¸º init è¿›ç¨‹ï¼ˆè¿›ç¨‹å·ä¸º 1ï¼‰çš„å­è¿›ç¨‹ï¼Œæ¢è¨€ä¹‹ï¼ŒæŸä¸€å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ç»“æŸåï¼Œè¯¥å­è¿›ç¨‹è°ƒç”¨ getppid()å°†è¿”å› 1ï¼Œinit è¿›ç¨‹å˜æˆäº†å­¤å„¿è¿›ç¨‹çš„â€œå…»çˆ¶â€ã€‚</p><p>è¿›ç¨‹ç»“æŸä¹‹åï¼Œé€šå¸¸éœ€è¦å…¶çˆ¶è¿›ç¨‹ä¸ºå…¶â€œæ”¶å°¸â€ï¼Œå›æ”¶å­è¿›ç¨‹å ç”¨çš„ä¸€äº›å†…å­˜èµ„æºï¼Œçˆ¶è¿›ç¨‹é€šè¿‡è°ƒç”¨wait()ï¼ˆæˆ–å…¶å˜ä½“ waitpid()ã€waitid()ç­‰ï¼‰å‡½æ•°å›æ”¶å­è¿›ç¨‹èµ„æºï¼Œå½’è¿˜ç»™ç³»ç»Ÿã€‚å¦‚æœå­è¿›ç¨‹å…ˆäºçˆ¶è¿›ç¨‹ç»“æŸï¼Œæ­¤æ—¶çˆ¶è¿›ç¨‹è¿˜æœªæ¥å¾—åŠç»™å­è¿›ç¨‹â€œæ”¶å°¸â€ï¼Œé‚£ä¹ˆæ­¤æ—¶å­è¿›ç¨‹å°±å˜æˆäº†ä¸€ä¸ªåƒµå°¸è¿›ç¨‹ã€‚</p><p>SIGCHLD ä¿¡å·åœ¨ç¬¬å…«ç« ä¸­ç»™å¤§å®¶ä»‹ç»è¿‡ï¼Œå½“å‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶ï¼Œçˆ¶è¿›ç¨‹ä¼šæ”¶åˆ°è¯¥ä¿¡å·ï¼š<br>âš« å½“çˆ¶è¿›ç¨‹çš„æŸä¸ªå­è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œçˆ¶è¿›ç¨‹ä¼šæ”¶åˆ° SIGCHLD ä¿¡å·ï¼›<br>âš« å½“çˆ¶è¿›ç¨‹çš„æŸä¸ªå­è¿›ç¨‹å› æ”¶åˆ°ä¿¡å·è€Œåœæ­¢ï¼ˆæš‚åœè¿è¡Œï¼‰æˆ–æ¢å¤æ—¶ï¼Œå†…æ ¸ä¹Ÿå¯èƒ½å‘çˆ¶è¿›ç¨‹å‘é€è¯¥ä¿¡å·ã€‚<br>å­è¿›ç¨‹çš„ç»ˆæ­¢å±äºå¼‚æ­¥äº‹ä»¶ï¼Œçˆ¶è¿›ç¨‹äº‹å…ˆæ˜¯æ— æ³•é¢„çŸ¥çš„ï¼Œå¦‚æœçˆ¶è¿›ç¨‹æœ‰è‡ªå·±éœ€è¦åšçš„äº‹æƒ…ï¼Œå®ƒä¸èƒ½ä¸€ç›´wait()é˜»å¡ç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢ï¼ˆæˆ–è½®è®­ï¼‰ï¼Œè¿™æ ·çˆ¶è¿›ç¨‹å°†å•¥äº‹ä¹Ÿåšä¸äº†ï¼Œé‚£ä¹ˆæœ‰ä»€ä¹ˆåŠæ³•æ¥è§£å†³è¿™æ ·çš„å°´å°¬æƒ…å†µï¼Œå½“ç„¶æœ‰åŠæ³•ï¼Œé‚£å°±æ˜¯é€šè¿‡ SIGCHLD ä¿¡å·ã€‚<br>é‚£æ—¢ç„¶å­è¿›ç¨‹çŠ¶æ€æ”¹å˜æ—¶ï¼ˆç»ˆæ­¢ã€æš‚åœæˆ–æ¢å¤ï¼‰ï¼Œçˆ¶è¿›ç¨‹ä¼šæ”¶åˆ° SIGCHLD ä¿¡å·ï¼ŒSIGCHLD ä¿¡å·çš„ç³»ç»Ÿé»˜è®¤å¤„ç†æ–¹å¼æ˜¯å°†å…¶å¿½ç•¥ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ•è·å®ƒã€ç»‘å®šä¿¡å·å¤„ç†å‡½æ•°ï¼Œåœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ wait()æ”¶å›å­è¿›ç¨‹ï¼Œå›æ”¶å®Œæ¯•ä¹‹åå†å›åˆ°çˆ¶è¿›ç¨‹è‡ªå·±çš„å·¥ä½œæµç¨‹ä¸­ã€‚<br>å½“è°ƒç”¨ä¿¡å·å¤„ç†å‡½æ•°æ—¶ï¼Œä¼šæš‚æ—¶å°†å¼•å‘è°ƒç”¨çš„ä¿¡å·æ·»åŠ åˆ°è¿›ç¨‹çš„ä¿¡å·æ©ç ä¸­ï¼ˆé™¤é sigaction()æŒ‡å®šSA_NODEFER æ ‡å¿—ï¼‰ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå½“ SIGCHLD ä¿¡å·å¤„ç†å‡½æ•°æ­£åœ¨ä¸ºä¸€ä¸ªç»ˆæ­¢çš„å­è¿›ç¨‹â€œæ”¶å°¸â€æ—¶ï¼Œå¦‚æœç›¸ç»§æœ‰ä¸¤ä¸ªå­è¿›ç¨‹ç»ˆæ­¢ï¼Œå³ä½¿äº§ç”Ÿäº†ä¸¤æ¬¡ SIGCHLD ä¿¡å·ï¼Œçˆ¶è¿›ç¨‹ä¹Ÿåªèƒ½æ•è·åˆ°ä¸€æ¬¡ SIGCHLD ä¿¡å·ï¼Œç»“æœæ˜¯ï¼Œçˆ¶è¿›ç¨‹çš„ SIGCHLD ä¿¡å·å¤„ç†å‡½æ•°æ¯æ¬¡åªè°ƒç”¨ä¸€æ¬¡ wait()ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æœ‰äº›åƒµå°¸è¿›ç¨‹æˆä¸ºâ€œæ¼ç½‘ä¹‹é±¼â€ã€‚<br>è§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼šåœ¨ SIGCHLD ä¿¡å·å¤„ç†å‡½æ•°ä¸­å¾ªç¯ä»¥éé˜»å¡æ–¹å¼æ¥è°ƒç”¨ waitpid()ï¼Œç›´è‡³å†æ— å…¶å®ƒç»ˆæ­¢çš„<br>å­è¿›ç¨‹éœ€è¦å¤„ç†ä¸ºæ­¢ï¼Œæ‰€ä»¥ï¼Œé€šå¸¸ SIGCHLD ä¿¡å·å¤„ç†å‡½æ•°å†…éƒ¨ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸€ç›´å¾ªç¯ä¸‹å»ï¼Œç›´è‡³ waitpid()è¿”å› 0ï¼Œè¡¨æ˜å†æ— åƒµå°¸è¿›ç¨‹å­˜åœ¨ï¼›æˆ–è€…è¿”å›-1ï¼Œè¡¨æ˜æœ‰é”™è¯¯å‘ç”Ÿã€‚<br>åº”åœ¨åˆ›å»ºä»»ä½•å­è¿›ç¨‹ä¹‹å‰ï¼Œä¸º SIGCHLD ä¿¡å·ç»‘å®šå¤„ç†å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">wait_child</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* æ›¿å­è¿›ç¨‹æ”¶å°¸ */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;çˆ¶è¿›ç¨‹å›æ”¶å­è¿›ç¨‹\n&quot;</span>);</span><br><span class="line"><span class="keyword">while</span> (waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sig</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="comment">/* ä¸º SIGCHLD ä¿¡å·ç»‘å®šå¤„ç†å‡½æ•° */</span></span><br><span class="line">sigemptyset(sig.sa_mask);</span><br><span class="line">sig.sa_handler = wait_child;</span><br><span class="line">sig.sa_flags = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">-1</span> == sigaction(SIGCHLD, &amp;sig, <span class="literal">NULL</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">perror(<span class="string">&quot;sigaction error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* åˆ›å»ºå­è¿›ç¨‹ */</span></span><br><span class="line"><span class="keyword">switch</span> (fork()) </span><br><span class="line">    &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"><span class="comment">/* å­è¿›ç¨‹ */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;å­è¿›ç¨‹&lt;%d&gt;è¢«åˆ›å»º\n&quot;</span>, getpid());</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;å­è¿›ç¨‹ç»“æŸ\n&quot;</span>);</span><br><span class="line">_exit(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">/* çˆ¶è¿›ç¨‹ */</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">sleep(<span class="number">3</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œæ–°ç¨‹åº"><a href="#æ‰§è¡Œæ–°ç¨‹åº" class="headerlink" title="æ‰§è¡Œæ–°ç¨‹åº"></a>æ‰§è¡Œæ–°ç¨‹åº</h3><p>ç³»ç»Ÿè°ƒç”¨ execve()å¯ä»¥å°†æ–°ç¨‹åºåŠ è½½åˆ°æŸä¸€è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œé€šè¿‡è°ƒç”¨ execve()å‡½æ•°å°†ä¸€ä¸ªå¤–éƒ¨çš„å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½åˆ°è¿›ç¨‹çš„å†…å­˜ç©ºé—´è¿è¡Œï¼Œä½¿ç”¨æ–°çš„ç¨‹åºæ›¿æ¢æ—§çš„ç¨‹åºï¼Œè€Œè¿›ç¨‹çš„æ ˆã€æ•°æ®ã€ä»¥åŠå †æ•°æ®ä¼šè¢«æ–°ç¨‹åºçš„ç›¸åº”éƒ¨ä»¶æ‰€æ›¿æ¢ï¼Œç„¶åä»æ–°ç¨‹åºçš„ main()å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">execve</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">char</span> *<span class="type">const</span> argv[], <span class="type">char</span> *<span class="type">const</span> envp[])</span>;</span><br></pre></td></tr></table></figure><p>filenameï¼šå‚æ•° filename æŒ‡å‘éœ€è¦è½½å…¥å½“å‰è¿›ç¨‹ç©ºé—´çš„æ–°ç¨‹åºçš„è·¯å¾„åï¼Œæ—¢å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ã€ä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ã€‚<br>argvï¼šå‚æ•° argv åˆ™æŒ‡å®šäº†ä¼ é€’ç»™æ–°ç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ã€‚æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œè¯¥æ•°ç»„å¯¹åº”äº main(int argc, char *argv[])å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•° argvï¼Œä¸”æ ¼å¼ä¹Ÿä¸ä¹‹ç›¸åŒï¼Œæ˜¯ç”±å­—ç¬¦ä¸²æŒ‡é’ˆæ‰€ç»„æˆçš„æ•°ç»„ï¼Œä»¥ NULL ç»“æŸã€‚argv[0]å¯¹åº”çš„ä¾¿æ˜¯æ–°ç¨‹åºè‡ªèº«è·¯å¾„åã€‚<br>envpï¼šå‚æ•° envp ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆæ•°ç»„ï¼ŒæŒ‡å®šäº†æ–°ç¨‹åºçš„ç¯å¢ƒå˜é‡åˆ—è¡¨ï¼Œå‚æ•° envp å…¶å®å¯¹åº”äºæ–°ç¨‹åºçš„ environ æ•°ç»„ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä»¥ NULL ç»“æŸï¼Œæ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²æ ¼å¼ä¸º name&#x3D;valueã€‚<br>è¿”å›å€¼ï¼šexecve è°ƒç”¨æˆåŠŸå°†ä¸ä¼šè¿”å›ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¼–å†™ä¸€ä¸ªç®€å•åœ°ç¨‹åºï¼Œåœ¨æµ‹è¯•ç¨‹åº testApp å½“ä¸­é€šè¿‡ execve()å‡½æ•°è¿è¡Œå¦ä¸€ä¸ªæ–°ç¨‹åº newAppã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">char</span> *arg_arr[<span class="number">5</span>];</span><br><span class="line"> <span class="type">char</span> *env_arr[<span class="number">5</span>] = &#123;<span class="string">&quot;NAME=app&quot;</span>, <span class="string">&quot;AGE=25&quot;</span>,</span><br><span class="line"> <span class="string">&quot;SEX=man&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">2</span> &gt; argc)</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> arg_arr[<span class="number">0</span>] = argv[<span class="number">1</span>];</span><br><span class="line"> arg_arr[<span class="number">1</span>] = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"> arg_arr[<span class="number">2</span>] = <span class="string">&quot;World&quot;</span>;</span><br><span class="line"> arg_arr[<span class="number">3</span>] = <span class="literal">NULL</span>;</span><br><span class="line"> execve(argv[<span class="number">1</span>], arg_arr, env_arr);</span><br><span class="line"> perror(<span class="string">&quot;execve error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å°†ä¸Šè¿°ç¨‹åºç¼–è¯‘æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ testAppã€‚</span></span><br><span class="line"><span class="comment">//æ¥ç€ç¼–å†™æ–°ç¨‹åºï¼Œåœ¨æ–°ç¨‹åºå½“ä¸­æ‰“å°å‡ºç¯å¢ƒå˜é‡å’Œä¼ å‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">char</span> **ep = <span class="literal">NULL</span>;</span><br><span class="line"> <span class="type">int</span> j;</span><br><span class="line"> <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; argc; j++)</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;argv[%d]: %s\n&quot;</span>, j, argv[j]);</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;env:&quot;</span>);</span><br><span class="line"> <span class="keyword">for</span> (ep = environ; *ep != <span class="literal">NULL</span>; ep++)</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot; %s\n&quot;</span>, *ep);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>exec æ—å‡½æ•°åŒ…æ‹¬å¤šä¸ªä¸åŒçš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å‘½åéƒ½ä»¥ exec ä¸ºå‰ç¼€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execl</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *arg, ... <span class="comment">/* (char *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execlp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">const</span> <span class="type">char</span> *arg, ... <span class="comment">/* (char *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execle</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *arg, ... <span class="comment">/*, (char *) NULL, char * const envp[] */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvpe</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[], <span class="type">char</span> *<span class="type">const</span> envp[])</span>;</span><br></pre></td></tr></table></figure><p><strong>system()å‡½æ•°</strong></p><p><u><strong>ä½¿ç”¨ system()å‡½æ•°å¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨æˆ‘ä»¬çš„ç¨‹åºå½“ä¸­æ‰§è¡Œä»»æ„ shell å‘½ä»¤ã€‚</strong></u></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">system</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *command)</span>;</span><br></pre></td></tr></table></figure><p>system()å‡½æ•°å…¶å†…éƒ¨çš„æ˜¯é€šè¿‡è°ƒç”¨ fork()ã€execl()ä»¥åŠ waitpid()è¿™ä¸‰ä¸ªå‡½æ•°æ¥å®ç°å®ƒçš„åŠŸèƒ½ï¼Œé¦–å…ˆ system()ä¼šè°ƒç”¨ fork()åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥è¿è¡Œ shellï¼ˆå¯ä»¥æŠŠè¿™ä¸ªå­è¿›ç¨‹æˆä¸º shell è¿›ç¨‹ï¼‰ï¼Œå¹¶é€šè¿‡ shell æ‰§è¡Œå‚æ•°command æ‰€æŒ‡å®šçš„å‘½ä»¤ã€‚</p><p>system()çš„è¿”å›å€¼å¦‚ä¸‹ï¼š<br>âš« å½“å‚æ•° command ä¸º NULLï¼Œå¦‚æœ shell å¯ç”¨åˆ™è¿”å›ä¸€ä¸ªé 0 å€¼ï¼Œè‹¥ä¸å¯ç”¨åˆ™è¿”å› 0ï¼›é’ˆå¯¹ä¸€äº›éUNIX ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿä¸Šå¯èƒ½æ˜¯æ²¡æœ‰ shell çš„ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ shell ä¸å¯èƒ½ï¼›å¦‚æœ command å‚æ•°ä¸ä¸ºNULLï¼Œåˆ™è¿”å›å€¼ä»ä»¥ä¸‹çš„å„ç§æƒ…å†µæ‰€å†³å®šã€‚<br>âš« å¦‚æœæ— æ³•åˆ›å»ºå­è¿›ç¨‹æˆ–æ— æ³•è·å–å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ï¼Œé‚£ä¹ˆ system()è¿”å›-1ï¼›<br>âš« å¦‚æœå­è¿›ç¨‹ä¸èƒ½æ‰§è¡Œ shellï¼Œåˆ™ system()çš„è¿”å›å€¼å°±å¥½åƒæ˜¯å­è¿›ç¨‹é€šè¿‡è°ƒç”¨_exit(127)ç»ˆæ­¢äº†ï¼›<br>âš« å¦‚æœæ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éƒ½æˆåŠŸï¼Œsystem()å‡½æ•°ä¼šè¿”å›æ‰§è¡Œ command çš„ shell è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ã€‚</p><h3 id="è¿›ç¨‹çŠ¶æ€"><a href="#è¿›ç¨‹çŠ¶æ€" class="headerlink" title="è¿›ç¨‹çŠ¶æ€"></a>è¿›ç¨‹çŠ¶æ€</h3><p>Linux ç³»ç»Ÿä¸‹è¿›ç¨‹é€šå¸¸å­˜åœ¨ 6 ç§ä¸åŒçš„çŠ¶æ€ï¼š</p><p>âš« å°±ç»ªæ€ï¼ˆReadyï¼‰ï¼šæŒ‡è¯¥è¿›ç¨‹æ»¡è¶³è¢« CPU è°ƒåº¦çš„æ‰€æœ‰æ¡ä»¶ä½†æ­¤æ—¶å¹¶æ²¡æœ‰è¢«è°ƒåº¦æ‰§è¡Œï¼Œåªè¦å¾—åˆ° CPUå°±èƒ½å¤Ÿç›´æ¥è¿è¡Œï¼›æ„å‘³ç€è¯¥è¿›ç¨‹å·²ç»å‡†å¤‡å¥½è¢« CPU æ‰§è¡Œï¼Œå½“ä¸€ä¸ªè¿›ç¨‹çš„æ—¶é—´ç‰‡åˆ°è¾¾ï¼Œæ“ä½œç³»ç»Ÿè°ƒåº¦ç¨‹åºä¼šä»å°±ç»ªæ€é“¾è¡¨ä¸­è°ƒåº¦ä¸€ä¸ªè¿›ç¨‹ï¼›<br>âš« è¿è¡Œæ€ï¼šæŒ‡è¯¥è¿›ç¨‹å½“å‰æ­£åœ¨è¢« CPU è°ƒåº¦è¿è¡Œï¼Œå¤„äºå°±ç»ªæ€çš„è¿›ç¨‹å¾—åˆ° CPU è°ƒåº¦å°±ä¼šè¿›å…¥è¿è¡Œæ€ï¼›<br>âš« åƒµå°¸æ€ï¼šåƒµå°¸æ€è¿›ç¨‹å…¶å®æŒ‡çš„å°±æ˜¯åƒµå°¸è¿›ç¨‹ï¼ŒæŒ‡è¯¥è¿›ç¨‹å·²ç»ç»“æŸã€ä½†å…¶çˆ¶è¿›ç¨‹è¿˜æœªç»™å®ƒâ€œæ”¶å°¸â€ï¼›<br>âš« å¯ä¸­æ–­ç¡çœ çŠ¶æ€ï¼šå¯ä¸­æ–­ç¡çœ ä¹Ÿç§°ä¸ºæµ…åº¦ç¡çœ ï¼Œè¡¨ç¤ºç¡çš„ä¸å¤Ÿâ€œæ­»â€ï¼Œè¿˜å¯ä»¥è¢«å”¤é†’ï¼Œä¸€èˆ¬æ¥è¯´å¯ä»¥é€šè¿‡ä¿¡å·æ¥å”¤é†’ï¼›<br>âš« ä¸å¯ä¸­æ–­ç¡çœ çŠ¶æ€ï¼šä¸å¯ä¸­æ–­ç¡çœ ç§°ä¸ºæ·±åº¦ç¡çœ ï¼Œæ·±åº¦ç¡çœ æ— æ³•è¢«ä¿¡å·å”¤é†’ï¼Œåªèƒ½ç­‰å¾…ç›¸åº”çš„æ¡ä»¶æˆç«‹æ‰èƒ½ç»“æŸç¡çœ çŠ¶æ€ã€‚æŠŠæµ…åº¦ç¡çœ å’Œæ·±åº¦ç¡çœ ç»Ÿç§°ä¸ºç­‰å¾…æ€ï¼ˆæˆ–è€…å«é˜»å¡æ€ï¼‰ï¼Œè¡¨ç¤ºè¿›ç¨‹å¤„äºä¸€ç§ç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾…æŸç§æ¡ä»¶æˆç«‹ä¹‹åä¾¿ä¼šè¿›å…¥åˆ°å°±ç»ªæ€ï¼›æ‰€ä»¥ï¼Œå¤„äºç­‰å¾…æ€çš„è¿›ç¨‹æ˜¯æ— æ³•å‚ä¸è¿›ç¨‹ç³»ç»Ÿè°ƒåº¦çš„ã€‚<br>âš« æš‚åœæ€ï¼šæš‚åœå¹¶ä¸æ˜¯è¿›ç¨‹çš„ç»ˆæ­¢ï¼Œè¡¨ç¤ºè¿›ç¨‹æš‚åœè¿è¡Œï¼Œä¸€èˆ¬å¯é€šè¿‡ä¿¡å·å°†è¿›ç¨‹æš‚åœï¼Œè­¬å¦‚ SIGSTOPä¿¡å·ï¼›å¤„äºæš‚åœæ€çš„è¿›ç¨‹æ˜¯å¯ä»¥æ¢å¤è¿›å…¥åˆ°å°±ç»ªæ€çš„ï¼Œè­¬å¦‚æ”¶åˆ° SIGCONT ä¿¡å·ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230118_205012.png" alt="è¿›ç¨‹å„çŠ¶æ€è½¬æ¢"></p><p>å…³äºè¿›ç¨‹ç»„éœ€è¦æ³¨æ„ä»¥ä¸‹ä»¥ä¸‹å†…å®¹ï¼š<br>âš« æ¯ä¸ªè¿›ç¨‹å¿…å®šå±äºæŸä¸€ä¸ªè¿›ç¨‹ç»„ã€ä¸”åªèƒ½å±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼›<br>âš« æ¯ä¸€ä¸ªè¿›ç¨‹ç»„æœ‰ä¸€ä¸ªç»„é•¿è¿›ç¨‹ï¼Œç»„é•¿è¿›ç¨‹çš„ ID å°±ç­‰äºè¿›ç¨‹ç»„ IDï¼›<br>âš« åœ¨ç»„é•¿è¿›ç¨‹çš„ ID å‰é¢åŠ ä¸Šä¸€ä¸ªè´Ÿå·å³æ˜¯æ“ä½œè¿›ç¨‹ç»„ï¼›<br>âš« ç»„é•¿è¿›ç¨‹ä¸èƒ½å†åˆ›å»ºæ–°çš„è¿›ç¨‹ç»„ï¼›<br>âš« åªè¦è¿›ç¨‹ç»„ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œåˆ™è¯¥è¿›ç¨‹ç»„å°±å­˜åœ¨ï¼Œè¿™ä¸å…¶ç»„é•¿è¿›ç¨‹æ˜¯å¦ç»ˆæ­¢æ— å…³ï¼›<br>âš« ä¸€ä¸ªè¿›ç¨‹ç»„å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹ç»„çš„ç”Ÿå‘½å‘¨æœŸä»è¢«åˆ›å»ºå¼€å§‹ï¼Œåˆ°å…¶å†…æ‰€æœ‰è¿›ç¨‹ç»ˆæ­¢æˆ–ç¦»å¼€è¯¥è¿›ç¨‹ç»„ï¼›<br>âš« é»˜è®¤æƒ…å†µä¸‹ï¼Œæ–°åˆ›å»ºçš„è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ç»„ IDã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getpgid</span><span class="params">(<span class="type">pid_t</span> pid)</span>;<span class="comment">//è·å–è¿›ç¨‹ç»„ID</span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getpgrp</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//è·å–è¿›ç¨‹ç»„ID</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pid_t</span> pid = getpid();</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;è¿›ç¨‹ç»„ ID&lt;%d&gt;---getpgrp()\n&quot;</span>, getpgrp());</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;è¿›ç¨‹ç»„ ID&lt;%d&gt;---getpgid(0)\n&quot;</span>, getpgid(<span class="number">0</span>));</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;è¿›ç¨‹ç»„ ID&lt;%d&gt;---getpgid(%d)\n&quot;</span>, getpgid(pid), pid);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">setpgid</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">pid_t</span> pgid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setpgrp</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//åŠ å…¥ä¸€ä¸ªç°æœ‰è¿›ç¨‹æˆ–è€…æ˜¯åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹</span></span><br></pre></td></tr></table></figure><p>setpgid()å‡½æ•°å°†å‚æ•° pid æŒ‡å®šçš„è¿›ç¨‹çš„è¿›ç¨‹ç»„ ID è®¾ç½®ä¸ºå‚æ•° gpidã€‚å¦‚æœè¿™ä¸¤ä¸ªå‚æ•°ç›¸ç­‰ï¼ˆpid&#x3D;&#x3D;gpidï¼‰ï¼Œåˆ™ç”± pid æŒ‡å®šçš„è¿›ç¨‹å˜æˆä¸ºè¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼›å¦‚æœå‚æ•° pid ç­‰äº 0ï¼Œåˆ™ä½¿ç”¨è°ƒç”¨è€…çš„è¿›ç¨‹ IDï¼›å¦å¤–ï¼Œå¦‚æœå‚æ•° gpid ç­‰äº 0ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ç»„ï¼Œç”±å‚æ•° pid æŒ‡å®šçš„è¿›ç¨‹ä½œä¸ºè¿›ç¨‹ç»„ç»„é•¿è¿›ç¨‹ã€‚<br>setpgrp()å‡½æ•°ç­‰ä»·äº setpgid(0, 0)ã€‚<br>ä¸€ä¸ªè¿›ç¨‹åªèƒ½ä¸ºå®ƒè‡ªå·±æˆ–å®ƒçš„å­è¿›ç¨‹è®¾ç½®è¿›ç¨‹ç»„ IDï¼Œåœ¨å®ƒçš„å­è¿›ç¨‹è°ƒç”¨ exec å‡½æ•°åï¼Œå®ƒå°±ä¸èƒ½æ›´æ”¹è¯¥å­è¿›ç¨‹çš„è¿›ç¨‹ç»„ ID äº†ã€‚</p><p>å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemonï¼‰ä¹Ÿç§°ä¸ºç²¾çµè¿›ç¨‹ï¼Œæ˜¯è¿è¡Œåœ¨åå°çš„ä¸€ç§ç‰¹æ®Šè¿›ç¨‹ï¼Œå®ƒç‹¬ç«‹äºæ§åˆ¶ç»ˆç«¯å¹¶ä¸”å‘¨æœŸæ€§åœ°æ‰§è¡ŒæŸç§ä»»åŠ¡æˆ–ç­‰å¾…å¤„ç†æŸäº›äº‹æƒ…çš„å‘ç”Ÿï¼Œä¸»è¦è¡¨ç°ä¸ºä»¥ä¸‹ä¸¤ä¸ªç‰¹ç‚¹ï¼š<br>âš« é•¿æœŸè¿è¡Œã€‚å®ˆæŠ¤è¿›ç¨‹æ˜¯ä¸€ç§ç”Ÿå­˜æœŸå¾ˆé•¿çš„ä¸€ç§è¿›ç¨‹ï¼Œå®ƒä»¬ä¸€èˆ¬åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¼€å§‹è¿è¡Œï¼Œé™¤éå¼ºè¡Œç»ˆæ­¢ï¼Œå¦åˆ™ç›´åˆ°ç³»ç»Ÿå…³æœºéƒ½ä¼šä¿æŒè¿è¡Œã€‚ä¸å®ˆæŠ¤è¿›ç¨‹ç›¸æ¯”ï¼Œæ™®é€šè¿›ç¨‹éƒ½æ˜¯åœ¨ç”¨æˆ·ç™»å½•æˆ–è¿è¡Œç¨‹åºæ—¶åˆ›å»ºï¼Œåœ¨è¿è¡Œç»“æŸæˆ–ç”¨æˆ·æ³¨é”€æ—¶ç»ˆæ­¢ï¼Œä½†å®ˆæŠ¤è¿›ç¨‹ä¸å—ç”¨æˆ·ç™»å½•æ³¨é”€çš„å½±å“ï¼Œå®ƒä»¬å°†ä¼šä¸€ç›´è¿è¡Œç€ã€ç›´åˆ°ç³»ç»Ÿå…³æœºã€‚<br>âš« ä¸æ§åˆ¶ç»ˆç«¯è„±ç¦»ã€‚åœ¨ Linux ä¸­ï¼Œç³»ç»Ÿä¸ç”¨æˆ·äº¤äº’çš„ç•Œé¢ç§°ä¸ºç»ˆç«¯ï¼Œæ¯ä¸€ä¸ªä»ç»ˆç«¯å¼€å§‹è¿è¡Œçš„è¿›ç¨‹éƒ½ä¼šä¾é™„äºè¿™ä¸ªç»ˆç«¯ï¼Œè¿™æ˜¯ä¸Šä¸€å°èŠ‚ç»™å¤§å®¶ä»‹ç»çš„æ§åˆ¶ç»ˆç«¯ï¼Œä¹Ÿå°±æ˜¯ä¼šè¯çš„æ§åˆ¶ç»ˆç«¯ã€‚å½“æ§åˆ¶ç»ˆç«¯è¢«å…³é—­çš„æ—¶å€™ï¼Œè¯¥ä¼šè¯å°±ä¼šé€€å‡ºï¼Œç”±æ§åˆ¶ç»ˆç«¯è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šè¢«ç»ˆæ­¢ï¼Œè¿™ä½¿å¾—æ™®é€šè¿›ç¨‹éƒ½æ˜¯å’Œè¿è¡Œè¯¥è¿›ç¨‹çš„ç»ˆç«¯ç›¸ç»‘å®šçš„ï¼›ä½†å®ˆæŠ¤è¿›ç¨‹èƒ½çªç ´è¿™ç§é™åˆ¶ï¼Œå®ƒè„±ç¦»ç»ˆç«¯å¹¶ä¸”åœ¨åå°è¿è¡Œï¼Œè„±ç¦»ç»ˆç«¯çš„ç›®çš„æ˜¯ä¸ºäº†é¿å…è¿›ç¨‹åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­çš„ä¿¡æ¯åœ¨ç»ˆç«¯æ˜¾ç¤ºå¹¶ä¸”è¿›ç¨‹ä¹Ÿä¸ä¼šè¢«ä»»ä½•ç»ˆç«¯æ‰€äº§ç”Ÿçš„ä¿¡æ¯æ‰€æ‰“æ–­ã€‚</p><p>å®ˆæŠ¤è¿›ç¨‹ Daemonï¼Œé€šå¸¸ç®€ç§°ä¸º dï¼Œä¸€èˆ¬è¿›ç¨‹ååé¢å¸¦æœ‰ d å°±è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ã€‚å®ˆæŠ¤è¿›ç¨‹ä¸ç»ˆç«¯æ— ä»»ä½•å…³è”ï¼Œç”¨æˆ·çš„ç™»å½•ä¸æ³¨é”€ä¸å®ˆæŠ¤è¿›ç¨‹æ— å…³ã€ä¸å—å…¶å½±å“ï¼Œå®ˆæŠ¤è¿›ç¨‹è‡ªæˆè¿›ç¨‹ç»„ã€è‡ªæˆä¼šè¯ï¼Œå³pid&#x3D;gid&#x3D;sidã€‚é€šè¿‡å‘½ä»¤â€ps -ajxâ€æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰çš„è¿›ç¨‹ã€‚</p><h4 id="ç¼–å†™å®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤"><a href="#ç¼–å†™å®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤" class="headerlink" title="ç¼–å†™å®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤"></a>ç¼–å†™å®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤</h4><p><strong>1) åˆ›å»ºå­è¿›ç¨‹ã€ç»ˆæ­¢çˆ¶è¿›ç¨‹</strong><br>çˆ¶è¿›ç¨‹è°ƒç”¨ fork()åˆ›å»ºå­è¿›ç¨‹ï¼Œç„¶åçˆ¶è¿›ç¨‹ä½¿ç”¨ exit()é€€å‡ºï¼Œè¿™æ ·åšå®ç°äº†ä¸‹é¢å‡ ç‚¹ã€‚ç¬¬ä¸€ï¼Œå¦‚æœè¯¥å®ˆæŠ¤è¿›ç¨‹æ˜¯ä½œä¸ºä¸€æ¡ç®€å•åœ° shell å‘½ä»¤å¯åŠ¨ï¼Œé‚£ä¹ˆçˆ¶è¿›ç¨‹ç»ˆæ­¢ä¼šè®© shell è®¤ä¸ºè¿™æ¡å‘½ä»¤å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚ç¬¬äºŒï¼Œè™½ç„¶å­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ç»„IDï¼Œä½†å®ƒæœ‰è‡ªå·±ç‹¬ç«‹çš„è¿›ç¨‹IDï¼Œè¿™ä¿è¯äº†å­è¿›ç¨‹ä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹ï¼Œè¿™æ˜¯ä¸‹é¢å°†è¦è°ƒç”¨ setsid å‡½æ•°çš„å…ˆå†³æ¡ä»¶ï¼<br><strong>2) å­è¿›ç¨‹è°ƒç”¨ setsid åˆ›å»ºä¼šè¯</strong><br>è¿™æ­¥æ˜¯å…³é”®ï¼Œåœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨ä¸Šä¸€å°èŠ‚ç»™å¤§å®¶ä»‹ç»çš„ setsid()å‡½æ•°åˆ›å»ºæ–°çš„ä¼šè¯ï¼Œç”±äºä¹‹å‰å­è¿›ç¨‹å¹¶ä¸æ˜¯è¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹ï¼Œæ‰€ä»¥è°ƒç”¨ setsid()ä¼šä½¿å¾—å­è¿›ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œå­è¿›ç¨‹æˆä¸ºæ–°ä¼šè¯çš„é¦–é¢†è¿›ç¨‹ï¼ŒåŒæ ·ä¹Ÿåˆ›å»ºäº†æ–°çš„è¿›ç¨‹ç»„ã€å­è¿›ç¨‹æˆä¸ºç»„é•¿è¿›ç¨‹ï¼Œæ­¤æ—¶åˆ›å»ºçš„ä¼šè¯å°†æ²¡æœ‰æ§åˆ¶ç»ˆç«¯ã€‚æ‰€ä»¥è¿™é‡Œè°ƒç”¨ setsid æœ‰ä¸‰ä¸ªä½œç”¨ï¼šè®©å­è¿›ç¨‹æ‘†è„±åŸä¼šè¯çš„æ§åˆ¶ã€è®©å­è¿›ç¨‹æ‘†è„±åŸè¿›ç¨‹ç»„çš„æ§åˆ¶å’Œè®©å­è¿›ç¨‹æ‘†è„±åŸæ§åˆ¶ç»ˆç«¯çš„æ§åˆ¶ã€‚åœ¨è°ƒç”¨ fork å‡½æ•°æ—¶ï¼Œå­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„ä¼šè¯ã€è¿›ç¨‹ç»„ã€æ§åˆ¶ç»ˆç«¯ç­‰ï¼Œè™½ç„¶çˆ¶è¿›ç¨‹é€€å‡ºäº†ï¼Œä½†åŸå…ˆçš„ä¼šè¯æœŸã€è¿›ç¨‹ç»„ã€æ§åˆ¶ç»ˆç«¯ç­‰å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤ï¼Œé‚£è¿˜ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šä½¿ä¸¤è€…ç‹¬ç«‹å¼€æ¥ã€‚setsid å‡½æ•°èƒ½å¤Ÿä½¿å­è¿›ç¨‹å®Œå…¨ç‹¬ç«‹å‡ºæ¥ï¼Œä»è€Œè„±ç¦»æ‰€æœ‰å…¶ä»–è¿›ç¨‹çš„æ§åˆ¶ã€‚<br><strong>3) å°†å·¥ä½œç›®å½•æ›´æ”¹ä¸ºæ ¹ç›®å½•</strong><br>å­è¿›ç¨‹æ˜¯ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ï¼Œç”±äºåœ¨è¿›ç¨‹è¿è¡Œä¸­ï¼Œå½“å‰ç›®å½•æ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸èƒ½å¸è½½çš„ï¼Œè¿™å¯¹ä»¥åä½¿ç”¨ä¼šé€ æˆå¾ˆå¤šçš„éº»çƒ¦ã€‚å› æ­¤é€šå¸¸çš„åšæ³•æ˜¯è®©â€œ&#x2F;â€ä½œä¸ºå®ˆæŠ¤è¿›ç¨‹çš„å½“å‰ç›®å½•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šå…¶å®ƒç›®å½•æ¥ä½œä¸ºå®ˆæŠ¤è¿›ç¨‹çš„å·¥ä½œç›®å½•ã€‚<br><strong>4) é‡è®¾æ–‡ä»¶æƒé™æ©ç  umask</strong><br>æ–‡ä»¶æƒé™æ©ç  umask ç”¨äºå¯¹æ–°å»ºæ–‡ä»¶çš„æƒé™ä½è¿›è¡Œå±è”½ã€‚ç”±äºä½¿ç”¨ fork å‡½æ•°æ–°å»ºçš„å­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æƒé™æ©ç ï¼Œè¿™å°±ç»™å­è¿›ç¨‹ä½¿ç”¨æ–‡ä»¶å¸¦æ¥äº†è¯¸å¤šçš„éº»çƒ¦ã€‚å› æ­¤ï¼ŒæŠŠæ–‡ä»¶æƒé™æ©ç è®¾ç½®ä¸º 0ï¼Œç¡®ä¿å­è¿›ç¨‹æœ‰æœ€å¤§æ“ä½œæƒé™ã€è¿™æ ·å¯ä»¥å¤§å¤§å¢å¼ºè¯¥å®ˆæŠ¤è¿›ç¨‹çš„çµæ´»æ€§ã€‚è®¾ç½®æ–‡ä»¶æƒé™æ©ç çš„å‡½æ•°æ˜¯ umaskï¼Œé€šå¸¸çš„ä½¿ç”¨æ–¹æ³•ä¸º umask(0)ã€‚<br><strong>5) å…³é—­ä¸å†éœ€è¦çš„æ–‡ä»¶æè¿°ç¬¦</strong><br>å­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™äº›è¢«æ‰“å¼€çš„æ–‡ä»¶å¯èƒ½æ°¸è¿œä¸ä¼šè¢«å®ˆæŠ¤è¿›ç¨‹ï¼ˆæ­¤æ—¶å®ˆæŠ¤è¿›ç¨‹æŒ‡çš„å°±æ˜¯å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹é€€å‡ºã€å­è¿›ç¨‹æˆä¸ºå®ˆæŠ¤è¿›ç¨‹ï¼‰è¯»æˆ–å†™ï¼Œä½†å®ƒä»¬ä¸€æ ·æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå¯èƒ½å¯¼è‡´æ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿæ— æ³•å¸è½½ï¼Œæ‰€ä»¥å¿…é¡»å…³é—­è¿™äº›æ–‡ä»¶ï¼Œè¿™ä½¿å¾—å®ˆæŠ¤è¿›ç¨‹ä¸å†æŒæœ‰ä»å…¶çˆ¶è¿›ç¨‹ç»§æ‰¿è¿‡æ¥çš„ä»»ä½•æ–‡ä»¶æè¿°ç¬¦ã€‚<br><strong>6) å°†æ–‡ä»¶æè¿°ç¬¦å·ä¸º 0ã€1ã€2 å®šä½åˆ°&#x2F;dev&#x2F;null</strong><br>å°†å®ˆæŠ¤è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºä»¥åŠæ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°&#x2F;dev&#x2F;nullï¼Œè¿™ä½¿å¾—å®ˆæŠ¤è¿›ç¨‹çš„è¾“å‡ºæ— å¤„æ˜¾ç¤ºã€ä¹Ÿæ— å¤„ä»äº¤äº’å¼ç”¨æˆ·é‚£é‡Œæ¥æ”¶è¾“å…¥ã€‚<br><strong>7) å…¶å®ƒï¼šå¿½ç•¥ SIGCHLD ä¿¡å·</strong><br>å¤„ç† SIGCHLD ä¿¡å·ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†å¯¹äºæŸäº›è¿›ç¨‹ï¼Œç‰¹åˆ«æ˜¯å¹¶å‘æœåŠ¡å™¨è¿›ç¨‹å¾€å¾€æ˜¯ç‰¹åˆ«é‡è¦çš„ï¼ŒæœåŠ¡å™¨è¿›ç¨‹åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚æ—¶ä¼šåˆ›å»ºå­è¿›ç¨‹å»å¤„ç†è¯¥è¯·æ±‚ï¼Œå¦‚æœå­è¿›ç¨‹ç»“æŸä¹‹åï¼Œçˆ¶è¿›ç¨‹æ²¡æœ‰å» wait å›æ”¶å­è¿›ç¨‹ï¼Œåˆ™å­è¿›ç¨‹å°†æˆä¸ºåƒµå°¸è¿›ç¨‹ï¼›å¦‚æœçˆ¶è¿›ç¨‹ wait ç­‰å¾…å­è¿›ç¨‹é€€å‡ºï¼Œå°†åˆä¼šå¢åŠ çˆ¶è¿›ç¨‹çš„è´Ÿæ‹…ã€ä¹Ÿå°±æ˜¯å¢åŠ æœåŠ¡å™¨çš„è´Ÿæ‹…ï¼Œå½±å“æœåŠ¡å™¨è¿›ç¨‹çš„å¹¶å‘æ€§èƒ½ï¼Œåœ¨ Linux ä¸‹ï¼Œå¯ä»¥å°† SIGCHLD ä¿¡å·çš„å¤„ç†æ–¹å¼è®¾ç½®ä¸ºSIG_IGNï¼Œä¹Ÿå°±æ˜¯å¿½ç•¥è¯¥ä¿¡å·ï¼Œå¯è®©å†…æ ¸å°†åƒµå°¸è¿›ç¨‹è½¬äº¤ç»™ init è¿›ç¨‹å»å¤„ç†ï¼Œè¿™æ ·æ—¢ä¸ä¼šäº§ç”Ÿåƒµå°¸è¿›ç¨‹ã€åˆçœå»äº†æœåŠ¡å™¨è¿›ç¨‹å›æ”¶å­è¿›ç¨‹æ‰€å ç”¨çš„æ—¶é—´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">pid_t</span> pid;</span><br><span class="line"> <span class="type">int</span> i;</span><br><span class="line"> <span class="comment">/* åˆ›å»ºå­è¿›ç¨‹ */</span></span><br><span class="line"> pid = fork();</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; pid) &#123;</span><br><span class="line"> perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> &lt; pid)<span class="comment">//çˆ¶è¿›ç¨‹</span></span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">//ç›´æ¥é€€å‡º</span></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> *å­è¿›ç¨‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">/* 1.åˆ›å»ºæ–°çš„ä¼šè¯ã€è„±ç¦»æ§åˆ¶ç»ˆç«¯ */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; setsid()) &#123;</span><br><span class="line"> perror(<span class="string">&quot;setsid error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* 2.è®¾ç½®å½“å‰å·¥ä½œç›®å½•ä¸ºæ ¹ç›®å½• */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; chdir(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line"> perror(<span class="string">&quot;chdir error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* 3.é‡è®¾æ–‡ä»¶æƒé™æ©ç  umask */</span></span><br><span class="line"> umask(<span class="number">0</span>);</span><br><span class="line"> <span class="comment">/* 4.å…³é—­æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sysconf(_SC_OPEN_MAX); i++)</span><br><span class="line"> close(i);</span><br><span class="line"> <span class="comment">/* 5.å°†æ–‡ä»¶æè¿°ç¬¦å·ä¸º 0ã€1ã€2 å®šä½åˆ°/dev/null */</span></span><br><span class="line"> open(<span class="string">&quot;/dev/null&quot;</span>, O_RDWR);</span><br><span class="line"> dup(<span class="number">0</span>);</span><br><span class="line"> dup(<span class="number">0</span>);</span><br><span class="line"> <span class="comment">/* 6.å¿½ç•¥ SIGCHLD ä¿¡å· */</span></span><br><span class="line"> signal(SIGCHLD, SIG_IGN);</span><br><span class="line"> <span class="comment">/* æ­£å¼è¿›å…¥åˆ°å®ˆæŠ¤è¿›ç¨‹ */</span></span><br><span class="line"> <span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;å®ˆæŠ¤è¿›ç¨‹è¿è¡Œä¸­......&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h3><p>ä½†å¯¹äºæœ‰äº›ç¨‹åºè®¾è®¡æ¥è¯´ï¼Œä¸å…è®¸å‡ºç°è¿™ç§æƒ…å†µï¼Œç¨‹åºåªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œåªè¦è¯¥ç¨‹åºæ²¡æœ‰ç»“æŸï¼Œå°±æ— æ³•å†æ¬¡è¿è¡Œï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç§°ä¸ºå•ä¾‹æ¨¡å¼è¿è¡Œã€‚</p><p>é¦–å…ˆè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•ä¸”å®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•ï¼šç”¨ä¸€ä¸ªæ–‡ä»¶çš„å­˜åœ¨ä¸å¦æ¥åšæ ‡å¿—ï¼Œåœ¨ç¨‹åºè¿è¡Œæ­£å¼ä»£ç ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™è¡¨æ˜è¿›ç¨‹å·²ç»è¿è¡Œï¼Œæ­¤æ—¶åº”è¯¥ç«‹é©¬é€€å‡ºï¼›å¦‚æœä¸å­˜åœ¨åˆ™è¡¨æ˜è¿›ç¨‹æ²¡æœ‰è¿è¡Œï¼Œç„¶ååˆ›å»ºè¯¥æ–‡ä»¶ï¼Œå½“ç¨‹åºç»“æŸæ—¶å†åˆ é™¤è¯¥æ–‡ä»¶å³å¯ï¼</p><p>æœ‰å¾ˆå¤§çš„é—®é¢˜ï¼Œä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š<br>âš« ç¨‹åºä¸­ä½¿ç”¨_exit()é€€å‡ºï¼Œé‚£ä¹ˆå°†æ— æ³•æ‰§è¡Œ delete_file()å‡½æ•°ï¼Œæ„å‘³ç€æ— æ³•åˆ é™¤è¿™ä¸ªç‰¹å®šçš„æ–‡ä»¶ï¼›<br>âš« ç¨‹åºå¼‚å¸¸é€€å‡ºã€‚ç¨‹åºå¼‚å¸¸åŒæ ·æ— æ³•æ‰§è¡Œåˆ°è¿›ç¨‹ç»ˆæ­¢å¤„ç†å‡½æ•° delete_file()ï¼ŒåŒæ ·å°†å¯¼è‡´æ— æ³•åˆ é™¤è¿™ä¸ªç‰¹å®šçš„æ–‡ä»¶ï¼›<br>âš« è®¡ç®—æœºæ‰ç”µå…³æœºã€‚è¿™ç§æƒ…å†µå°±æ›´åŠ ç›´æ¥äº†ï¼Œè®¡ç®—æœºå¯èƒ½åœ¨ç¨‹åºè¿è¡Œåˆ°ä»»æ„ä½ç½®æ—¶å‘ç”Ÿæ‰ç”µå…³æœºçš„æƒ…å†µï¼Œè¿™æ˜¯æ— æ³•é¢„æ–™çš„ï¼›å¦‚æœæ–‡ä»¶æ²¡æœ‰åˆ é™¤å°±å‘ç”Ÿäº†è¿™ç§æƒ…å†µï¼Œè®¡ç®—æœºé‡å¯ä¹‹åæ–‡ä»¶ä¾ç„¶å­˜åœ¨ï¼Œå¯¼è‡´ç¨‹åºæ— æ³•æ‰§è¡Œã€‚</p><p>ç”±æ­¤ä½¿ç”¨æ–‡ä»¶é”</p><p>åŒæ ·ä¹Ÿéœ€è¦é€šè¿‡ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶æ¥å®ç°ï¼Œå½“ç¨‹åºå¯åŠ¨ä¹‹åï¼Œé¦–å…ˆæ‰“å¼€è¯¥æ–‡ä»¶ï¼Œè°ƒç”¨ open æ—¶ä¸€èˆ¬ä½¿ç”¨O_WRONLY | O_CREAT æ ‡å¿—ï¼Œå½“æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºè¯¥æ–‡ä»¶ï¼Œç„¶åå°è¯•å»è·å–æ–‡ä»¶é”ï¼Œè‹¥æ˜¯æˆåŠŸï¼Œåˆ™å°†ç¨‹åºçš„è¿›ç¨‹å·ï¼ˆPIDï¼‰å†™å…¥åˆ°è¯¥æ–‡ä»¶ä¸­ï¼Œå†™å…¥åä¸è¦å…³é—­æ–‡ä»¶æˆ–è§£é”ï¼ˆé‡Šæ”¾æ–‡ä»¶é”ï¼‰ï¼Œä¿è¯è¿›ç¨‹ä¸€ç›´æŒæœ‰è¯¥æ–‡ä»¶é”ï¼›è‹¥æ˜¯ç¨‹åºè·å–é”å¤±è´¥ï¼Œä»£è¡¨ç¨‹åºå·²ç»è¢«è¿è¡Œã€åˆ™é€€å‡ºæœ¬æ¬¡å¯åŠ¨ã€‚Tipsï¼šå½“ç¨‹åºé€€å‡ºæˆ–æ–‡ä»¶å…³é—­ä¹‹åï¼Œæ–‡ä»¶é”ä¼šè‡ªåŠ¨è§£é”ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCK_FILE <span class="string">&quot;./testApp.pid&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">char</span> str[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="type">int</span> fd;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€ lock æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º */</span></span><br><span class="line"> fd = open(LOCK_FILE, O_WRONLY | O_CREAT, <span class="number">0666</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == fd) &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* ä»¥éé˜»å¡æ–¹å¼è·å–æ–‡ä»¶é” */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == flock(fd, LOCK_EX | LOCK_NB)) &#123;</span><br><span class="line"> <span class="built_in">fputs</span>(<span class="string">&quot;ä¸èƒ½é‡å¤æ‰§è¡Œè¯¥ç¨‹åº!\n&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line"> close(fd);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;ç¨‹åºè¿è¡Œä¸­...&quot;</span>);</span><br><span class="line"> ftruncate(fd, <span class="number">0</span>); <span class="comment">//å°†æ–‡ä»¶é•¿åº¦æˆªæ–­ä¸º 0</span></span><br><span class="line"> <span class="built_in">sprintf</span>(str, <span class="string">&quot;%d\n&quot;</span>, getpid());</span><br><span class="line">write(fd, str, <span class="built_in">strlen</span>(str));<span class="comment">//å†™å…¥ pid</span></span><br><span class="line"> <span class="keyword">for</span> ( ; ; )</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºå¯åŠ¨é¦–å…ˆæ‰“å¼€ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¾‹ï¼Œä»¥å½“å‰ç›®å½•ä¸‹çš„ testApp.pid æ–‡ä»¶ä½œä¸ºç‰¹å®šæ–‡ä»¶ï¼Œä»¥ O_WRONLY | O_CREAT æ–¹å¼æ‰“å¼€ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºè¯¥æ–‡ä»¶ï¼›æ‰“å¼€æ–‡ä»¶ä¹‹åä½¿ç”¨ flock å°è¯•è·å–æ–‡ä»¶é”ï¼Œè°ƒç”¨ flock()æ—¶æŒ‡å®šäº†äº’æ–¥é”æ ‡å¿— LOCK_NBï¼Œæ„å‘³ç€åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æ‹¥æœ‰è¯¥é”ï¼Œå¦‚æœè·å–é”å¤±è´¥ï¼Œè¡¨ç¤ºè¯¥ç¨‹åºå·²ç»å¯åŠ¨äº†ï¼Œæ— éœ€å†æ¬¡æ‰§è¡Œï¼Œç„¶åé€€å‡ºï¼›å¦‚æœè·å–é”æˆåŠŸï¼Œå°†è¿›ç¨‹çš„ PID å†™å…¥åˆ°è¯¥æ–‡ä»¶ä¸­ï¼Œå½“ç¨‹åºé€€å‡ºæ—¶ï¼Œä¼šè‡ªåŠ¨è§£é”ã€å…³é—­æ–‡ä»¶ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> æ“ä½œç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cé”™é¢˜</title>
      <link href="/2022/12/17/2022-12-17-C%E9%94%99%E9%A2%98/"/>
      <url>/2022/12/17/2022-12-17-C%E9%94%99%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">sizeof</span>(i++);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç­‰äº1</p><p><strong>æ ¹æ®C99è§„èŒƒï¼Œ sizeofæ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶åˆ»å°±èµ·æ•ˆæœçš„è¿ç®—ç¬¦ï¼Œåœ¨å…¶å†…çš„ä»»ä½•è¿ç®—éƒ½æ²¡æœ‰æ„ä¹‰ï¼Œsizeof(i++); åœ¨ç¼–è¯‘çš„æ—¶å€™è¢«ç¿»è¯‘æˆ sizeof((i++çš„æ•°æ®ç±»å‹)) ä¹Ÿå°±æ˜¯ sizeof(int); ä¸ä¼šæ‰§è¡Œi++äº† ã€‚</strong></p><p>sizeofæ˜¯æ“ä½œç¬¦</p><h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><p>ä¸‹é¢è¯´æ³•ä¸­æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ </p><ul><li><pre><code>è‹¥å…¨å±€å˜é‡ä»…åœ¨å•ä¸ªC æ–‡ä»¶ä¸­è®¿é—®ï¼Œåˆ™å¯ä»¥å°†è¿™ä¸ªå˜é‡ä¿®æ”¹ä¸ºé™æ€å…¨å±€å˜é‡ï¼Œä»¥é™ä½æ¨¡å—é—´çš„è€¦åˆåº¦<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  è‹¥å…¨å±€å˜é‡ä»…ç”±å•ä¸ªå‡½æ•°è®¿é—®ï¼Œåˆ™å¯ä»¥å°†è¿™ä¸ªå˜é‡æ”¹ä¸ºè¯¥å‡½æ•°çš„é™æ€å±€éƒ¨å˜é‡ï¼Œä»¥é™ä½æ¨¡å—é—´çš„è€¦åˆåº¦</span><br></pre></td></tr></table></figure></code></pre></li><li><p>&#96;&#96;&#96;<br>è®¾è®¡å’Œä½¿ç”¨è®¿é—®åŠ¨æ€å…¨å±€å˜é‡ã€é™æ€å…¨å±€å˜é‡ã€é™æ€å±€éƒ¨å˜é‡çš„å‡½æ•°æ—¶ï¼Œéœ€è¦è€ƒè™‘å˜é‡ç”Ÿå‘½å‘¨æœŸé—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  é™æ€å…¨å±€å˜é‡ä½¿ç”¨è¿‡å¤šï¼Œå¯é‚£ä¼šå¯¼è‡´åŠ¨æ€å­˜å‚¨åŒº(å †æ ˆ)æº¢å‡º</span><br></pre></td></tr></table></figure></li></ul><p>Static å‡½æ•°åœ¨éç±»ä¸­æœ‰ä¸‰ä¸ªä½œç”¨ï¼š </p><p>  1ã€ç”¨æ¥éšè—ï¼Œåˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œå¯ä»¥åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­å®šä¹‰åŒåå˜é‡å’ŒåŒåå‡½æ•°ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå‘½åå†²çªï¼Œå¯¹åº”Aé€‰é¡¹ï¼› </p><p>  2ã€é»˜è®¤åˆå§‹åŒ–ä¸º0ï¼› </p><p>  3ã€ä¿æŒå±€éƒ¨å˜é‡çš„æŒä¹… ã€‚æ‰€ä»¥Aé€‰é¡¹æ˜¯å¯¹çš„ã€‚Bé€‰é¡¹æ¯«æ— å…³ç³»ï¼ŒCé€‰é¡¹ä¸­åŠ¨æ€å…¨å±€å˜é‡ã€é™æ€å…¨å±€å˜é‡ã€é™æ€å±€éƒ¨å˜é‡ç”Ÿå‘½æœŸéƒ½ä¸ºå‡½æ•°è¿è¡ŒæœŸé—´ã€‚ å…¶ä¸­é™æ€å±€éƒ¨å˜é‡çš„ç”Ÿå­˜å‘¨æœŸè™½ç„¶ä¸ºæ•´ä¸ªæºç¨‹åºï¼Œä½†æ˜¯å…¶ä½œç”¨åŸŸä»»ç„¶ä¸å±€éƒ¨å˜é‡ç›¸åŒï¼Œå½“é€€å‡ºè¯¥å‡½æ•°æ—¶ï¼Œè¯¥å˜é‡è¿˜ç»§ç»­å­˜åœ¨ï¼Œä½†æ˜¯ä¸èƒ½ä½¿ç”¨å®ƒã€‚æ‰€ä»¥Cé€‰é¡¹æ˜¯é”™çš„ã€‚  Dé€‰é¡¹ä¸­ï¼Œé™æ€å…¨å±€å˜é‡å­˜å‚¨åœ¨å…¨å±€ï¼ˆé™æ€ï¼‰å­˜å‚¨åŒºã€‚</p><h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`int` `a = ``248``, b = ``4``;``int` `const` `c = ``21``;``const` `int` `*d = &amp;a; ``int` `*``const` `e = &amp;b;``int` `const` `* ``const` `f = &amp;a; `</span><br></pre></td></tr></table></figure><p>  è¯·é—®ä¸‹åˆ—è¡¨è¾¾å¼å“ªäº›ä¼šè¢«ç¼–è¯‘å™¨ç¦æ­¢? </p><ul><li><pre><code>*c=32<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  *d=43</span><br></pre></td></tr></table></figure></code></pre></li><li><pre><code>e=&amp;a<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  f=0x321f</span><br></pre></td></tr></table></figure></code></pre></li><li><p>&#96;&#96;&#96;<br>d&#x3D;&amp;b</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  *e=34</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20221217_210448.png"></p><h3 id="4"><a href="#4" class="headerlink" title="4"></a>4</h3><p>å‡è®¾å‡½æ•°åŸå‹å’Œå˜é‡è¯´æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">f3</span><span class="params">(<span class="type">int</span>(*p)[<span class="number">4</span>])</span>;</span><br><span class="line"><span class="type">int</span> a[<span class="number">4</span>]=&#123;<span class="number">1</span>ï¼Œ<span class="number">2</span>ï¼Œ<span class="number">3</span>ï¼Œ<span class="number">4</span>&#125;ï¼Œ</span><br><span class="line"><span class="type">int</span> b[<span class="number">3</span>][<span class="number">4</span>]=&#123;&#123;<span class="number">1</span>ï¼Œ<span class="number">2</span>ï¼Œ<span class="number">3</span>ï¼Œ<span class="number">4</span>&#125;ï¼Œ&#123;<span class="number">5</span>ï¼Œ<span class="number">6</span>ï¼Œ<span class="number">7</span>ï¼Œ<span class="number">8</span>&#125;ï¼Œ&#123;<span class="number">9</span>ï¼Œ<span class="number">10</span>ï¼Œ<span class="number">11</span>ï¼Œ<span class="number">12</span>&#125;&#125;;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢è°ƒç”¨éæ³•çš„æ˜¯ï¼ˆbï¼‰<br>f3(&amp;a);<br>f3(b[1]);<br>f3(&amp;b[1]);<br>f3(b);</p><p>void f3(<strong>int(*p)[4]</strong>);    å…¶å‚æ•°æ˜¯<strong>æ•°ç»„æŒ‡é’ˆ</strong> ï¼ŒæŒ‡å‘æ•°ç»„pçš„æŒ‡é’ˆã€‚</p><ul><li>â€‹    é€‰é¡¹Aï¼šf3(<strong>&amp;a</strong>);  å‚æ•°ä¸ºä¸€ä¸ªåœ°å€ï¼Œç¬¦åˆæŒ‡é’ˆå®šä¹‰ã€‚   </li><li>â€‹    é€‰é¡¹Bï¼šf3(<strong>b[1]</strong>); å‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„çš„å…·ä½“å…ƒç´ ï¼Œä¸ç¬¦åˆæŒ‡é’ˆå®šä¹‰ã€‚<strong>æ‰€ä»¥Bæ˜¯éæ³•çš„è°ƒç”¨ã€‚</strong>   </li><li>â€‹    é€‰é¡¹Cï¼šf3(<strong>&amp;b[1]</strong>); å‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„å…ƒç´ çš„åœ°å€ï¼Œç¬¦åˆæŒ‡é’ˆå®šä¹‰ã€‚   </li><li>â€‹    é€‰é¡¹Dï¼šf3(<strong>b</strong>);  å‚æ•°ä¸ºæ•°ç»„åï¼Œè¡¨ç¤ºè¯¥æ•°ç»„çš„é¦–åœ°å€ï¼Œç¬¦åˆæŒ‡é’ˆå®šä¹‰ã€‚</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¿¡å·</title>
      <link href="/2022/12/17/2022-12-17-%E4%BF%A1%E5%8F%B7/"/>
      <url>/2022/12/17/2022-12-17-%E4%BF%A1%E5%8F%B7/</url>
      
        <content type="html"><![CDATA[<p>ä¿¡å·æ˜¯äº‹ä»¶å‘ç”Ÿæ—¶å¯¹è¿›ç¨‹çš„é€šçŸ¥æœºåˆ¶ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒç§°ä¸ºè½¯ä»¶ä¸­æ–­ã€‚ä¿¡å·ä¸ç¡¬ä»¶ä¸­æ–­çš„ç›¸ä¼¼ä¹‹å¤„åœ¨äºèƒ½å¤Ÿæ‰“æ–­ç¨‹åºå½“å‰æ‰§è¡Œçš„æ­£å¸¸æµç¨‹ï¼Œå…¶å®æ˜¯åœ¨è½¯ä»¶å±‚æ¬¡ä¸Šå¯¹ä¸­æ–­æœºåˆ¶çš„ä¸€ç§æ¨¡æ‹Ÿã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ˜¯æ— æ³•é¢„æµ‹ä¿¡å·è¾¾åˆ°çš„å‡†ç¡®æ—¶é—´ï¼Œæ‰€ä»¥ï¼Œä¿¡å·æä¾›äº†ä¸€ç§å¤„ç†å¼‚æ­¥äº‹ä»¶çš„æ–¹æ³•ã€‚</p><p><strong>äº§ç”Ÿä¿¡å·çš„æ–¹å¼ï¼š</strong></p><p>âš« ç¡¬ä»¶å‘ç”Ÿå¼‚å¸¸ï¼Œå³ç¡¬ä»¶æ£€æµ‹åˆ°é”™è¯¯æ¡ä»¶å¹¶é€šçŸ¥å†…æ ¸ï¼Œéšå³å†ç”±å†…æ ¸å‘é€ç›¸åº”çš„ä¿¡å·ç»™ç›¸å…³è¿›ç¨‹ã€‚ç¡¬ä»¶æ£€æµ‹åˆ°å¼‚å¸¸çš„ä¾‹å­åŒ…æ‹¬æ‰§è¡Œä¸€æ¡å¼‚å¸¸çš„æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼Œè¯¸å¦‚ï¼Œé™¤æ•°ä¸º 0ã€æ•°ç»„è®¿é—®è¶Šç•Œå¯¼è‡´å¼•ç”¨äº†æ— æ³•è®¿é—®çš„å†…å­˜åŒºåŸŸç­‰ï¼Œè¿™äº›å¼‚å¸¸æƒ…å†µéƒ½ä¼šè¢«ç¡¬ä»¶æ£€æµ‹åˆ°ï¼Œå¹¶é€šçŸ¥å†…æ ¸ã€ç„¶åå†…æ ¸ä¸ºè¯¥å¼‚å¸¸æƒ…å†µå‘ç”Ÿæ—¶æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å‘é€é€‚å½“çš„ä¿¡å·ä»¥é€šçŸ¥è¿›ç¨‹ã€‚<br>âš« ç”¨äºåœ¨ç»ˆç«¯ä¸‹è¾“å…¥äº†èƒ½å¤Ÿäº§ç”Ÿä¿¡å·çš„ç‰¹æ®Šå­—ç¬¦ã€‚è­¬å¦‚åœ¨ç»ˆç«¯ä¸ŠæŒ‰ä¸‹ CTRL + C ç»„åˆæŒ‰é”®å¯ä»¥äº§ç”Ÿä¸­æ–­ä¿¡å·ï¼ˆSIGINTï¼‰ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•å¯ä»¥ç»ˆæ­¢åœ¨å‰å°è¿è¡Œçš„è¿›ç¨‹ï¼›æŒ‰ä¸‹ CTRL + Z ç»„åˆæŒ‰é”®å¯ä»¥äº§ç”Ÿæš‚åœä¿¡ï¼ˆSIGCONTï¼‰ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•å¯ä»¥æš‚åœå½“å‰å‰å°è¿è¡Œçš„è¿›ç¨‹ã€‚<br>âš« è¿›ç¨‹è°ƒç”¨ kill()ç³»ç»Ÿè°ƒç”¨å¯å°†ä»»æ„ä¿¡å·å‘é€ç»™å¦ä¸€ä¸ªè¿›ç¨‹æˆ–è¿›ç¨‹ç»„ã€‚å½“ç„¶å¯¹æ­¤æ˜¯æœ‰æ‰€é™åˆ¶çš„ï¼Œæ¥æ”¶ä¿¡å·çš„è¿›ç¨‹å’Œå‘é€ä¿¡å·çš„è¿›ç¨‹çš„æ‰€æœ‰è€…å¿…é¡»ç›¸åŒï¼Œäº¦æˆ–è€…å‘é€ä¿¡å·çš„è¿›ç¨‹çš„æ‰€æœ‰è€…æ˜¯ root è¶…çº§ç”¨æˆ·ã€‚<br>âš« ç”¨æˆ·å¯ä»¥é€šè¿‡ kill å‘½ä»¤å°†ä¿¡å·å‘é€ç»™å…¶å®ƒè¿›ç¨‹ã€‚kill å‘½ä»¤æƒ³å¿…å¤§å®¶éƒ½ä¼šä½¿ç”¨ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šé€šè¿‡ killå‘½ä»¤æ¥â€œæ€æ­»â€ï¼ˆç»ˆæ­¢ï¼‰ä¸€ä¸ªè¿›ç¨‹ï¼Œè­¬å¦‚åœ¨ç»ˆç«¯ä¸‹æ‰§è¡Œâ€kill -9 xxxâ€æ¥æ€æ­» PID ä¸º xxx çš„è¿›ç¨‹ã€‚killå‘½ä»¤å…¶å†…éƒ¨çš„å®ç°åŸç†ä¾¿æ˜¯é€šè¿‡ kill()ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆçš„ã€‚<br>âš« å‘ç”Ÿäº†è½¯ä»¶äº‹ä»¶ï¼Œå³å½“æ£€æµ‹åˆ°æŸç§è½¯ä»¶æ¡ä»¶å·²ç»å‘ç”Ÿã€‚è¿™é‡ŒæŒ‡çš„ä¸æ˜¯ç¡¬ä»¶äº§ç”Ÿçš„æ¡ä»¶ï¼ˆå¦‚é™¤æ•°ä¸º 0ã€å¼•ç”¨æ— æ³•è®¿é—®çš„å†…å­˜åŒºåŸŸç­‰ï¼‰ï¼Œè€Œæ˜¯è½¯ä»¶çš„è§¦å‘æ¡ä»¶ã€è§¦å‘äº†æŸç§è½¯ä»¶æ¡ä»¶ï¼ˆè¿›ç¨‹æ‰€è®¾ç½®çš„å®šæ—¶å™¨å·²ç»è¶…æ—¶ã€è¿›ç¨‹æ‰§è¡Œçš„ CPU æ—¶é—´è¶…é™ã€è¿›ç¨‹çš„æŸä¸ªå­è¿›ç¨‹é€€å‡ºç­‰ç­‰æƒ…å†µï¼‰</p><p><strong><u>é€šå¸¸è¿›ç¨‹ä¼šè§†å…·ä½“ä¿¡å·æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š</u></strong><br>âš« å¿½ç•¥ä¿¡å·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¿¡å·åˆ°è¾¾è¿›ç¨‹åï¼Œè¯¥è¿›ç¨‹å¹¶ä¸ä¼šå»ç†ä¼šå®ƒã€ç›´æ¥å¿½ç•¥ï¼Œå°±å¥½åƒæ˜¯æ²¡æœ‰å‡ºè¯¥ä¿¡å·ï¼Œä¿¡å·å¯¹è¯¥è¿›ç¨‹ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚äº‹å®ä¸Šï¼Œå¤§å¤šæ•°ä¿¡å·éƒ½å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œä½†æœ‰ä¸¤ç§ä¿¡å·å´å†³ä¸èƒ½è¢«å¿½ç•¥ï¼Œå®ƒä»¬æ˜¯ SIGKILL å’Œ SIGSTOPï¼Œè¿™ä¸¤ç§ä¿¡å·ä¸èƒ½è¢«å¿½ç•¥çš„åŸå› æ˜¯ï¼šå®ƒä»¬å‘å†…æ ¸å’Œè¶…çº§ç”¨æˆ·æä¾›äº†ä½¿è¿›ç¨‹ç»ˆæ­¢æˆ–åœæ­¢çš„å¯é æ–¹æ³•ã€‚å¦å¤–ï¼Œå¦‚æœå¿½ç•¥æŸäº›ç”±ç¡¬ä»¶å¼‚å¸¸äº§ç”Ÿçš„ä¿¡å·ï¼Œåˆ™è¿›ç¨‹çš„è¿è¡Œè¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚<br>âš« æ•è·ä¿¡å·ã€‚å½“ä¿¡å·åˆ°è¾¾è¿›ç¨‹åï¼Œæ‰§è¡Œé¢„å…ˆç»‘å®šå¥½çš„ä¿¡å·å¤„ç†å‡½æ•°ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¦é€šçŸ¥å†…æ ¸åœ¨æŸç§ä¿¡å·å‘ç”Ÿæ—¶ï¼Œæ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„å¤„ç†å‡½æ•°ï¼Œè¯¥å¤„ç†å‡½æ•°ä¸­å°†ä¼šå¯¹è¯¥ä¿¡å·äº‹ä»¶ä½œå‡ºç›¸åº”çš„å¤„ç†ï¼ŒLinux ç³»ç»Ÿæä¾›äº† signal()ç³»ç»Ÿè°ƒç”¨å¯ç”¨äºæ³¨å†Œä¿¡å·çš„å¤„ç†å‡½æ•°ï¼Œå°†ä¼šåœ¨åé¢å‘å¤§å®¶ä»‹ç»ã€‚<br>âš« æ‰§è¡Œç³»ç»Ÿé»˜è®¤æ“ä½œã€‚è¿›ç¨‹ä¸å¯¹è¯¥ä¿¡å·äº‹ä»¶ä½œå‡ºå¤„ç†ï¼Œè€Œæ˜¯äº¤ç”±ç³»ç»Ÿè¿›è¡Œå¤„ç†ï¼Œæ¯ä¸€ç§ä¿¡å·éƒ½ä¼šæœ‰å…¶å¯¹åº”çš„ç³»ç»Ÿé»˜è®¤çš„å¤„ç†æ–¹å¼ï¼Œ8ä¸­å¯¹æ­¤æœ‰è¿›è¡Œä»‹ç»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹å¤§å¤šæ•°ä¿¡å·æ¥è¯´ï¼Œç³»ç»Ÿé»˜è®¤çš„å¤„ç†æ–¹å¼å°±æ˜¯ç»ˆæ­¢è¯¥è¿›ç¨‹ã€‚</p><p>å®æ—¶ä¿¡å·ä¸éå®æ—¶ä¿¡å·å…¶å®æ˜¯ä»æ—¶é—´å…³ç³»ä¸Šè¿›è¡Œçš„åˆ†ç±»ï¼Œä¸å¯é ä¿¡å·ä¸ä¸å¯é ä¿¡å·æ˜¯ç›¸äº’å¯¹åº”çš„ï¼Œéå®æ—¶ä¿¡å·éƒ½ä¸æ”¯æŒæ’é˜Ÿï¼Œéƒ½æ˜¯ä¸å¯é ä¿¡å·ï¼›å®æ—¶ä¿¡å·éƒ½æ”¯æŒæ’é˜Ÿï¼Œéƒ½æ˜¯å¯é ä¿¡å·ã€‚å®æ—¶ä¿¡å·ä¿è¯äº†å‘é€çš„å¤šä¸ªä¿¡å·éƒ½èƒ½è¢«æ¥æ”¶ï¼Œå®æ—¶ä¿¡å·æ˜¯ POSIX æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œå¯ç”¨äºåº”ç”¨è¿›ç¨‹ã€‚</p><p>Linux ä¸‹å¯¹æ ‡å‡†ä¿¡å·ï¼ˆä¸å¯é ä¿¡å·ã€éå®æ—¶ä¿¡å·ï¼‰çš„ç¼–å·ä¸º 1~31ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20221217_122938.png"></p><h3 id="è¿›ç¨‹å¯¹ä¿¡å·çš„å¤„ç†"><a href="#è¿›ç¨‹å¯¹ä¿¡å·çš„å¤„ç†" class="headerlink" title="è¿›ç¨‹å¯¹ä¿¡å·çš„å¤„ç†"></a>è¿›ç¨‹å¯¹ä¿¡å·çš„å¤„ç†</h3><p><strong>signalå‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">sig_t</span>)</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">sig_t</span> <span class="title function_">signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">sig_t</span> handler)</span>;</span><br></pre></td></tr></table></figure><p>signumï¼šæ­¤å‚æ•°æŒ‡å®šéœ€è¦è¿›è¡Œè®¾ç½®çš„ä¿¡å·ï¼Œå¯ä½¿ç”¨ä¿¡å·åï¼ˆå®ï¼‰æˆ–ä¿¡å·çš„æ•°å­—ç¼–å·ï¼Œå»ºè®®ä½¿ç”¨ä¿¡å·åã€‚<br>handlerï¼šsig_t ç±»å‹çš„å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¿¡å·å¯¹åº”çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå½“è¿›ç¨‹æ¥æ”¶åˆ°ä¿¡å·åä¼šè‡ªåŠ¨æ‰§è¡Œè¯¥å¤„ç†å‡½æ•°ï¼›å‚æ•° handler æ—¢å¯ä»¥è®¾ç½®ä¸ºç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æ•è·ä¿¡å·æ—¶éœ€è¦æ‰§è¡Œçš„å¤„ç†å‡½æ•°ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸º SIG_IGN æˆ– SIG_DFLï¼ŒSIG_IGN è¡¨ç¤ºæ­¤è¿›ç¨‹éœ€è¦å¿½ç•¥è¯¥ä¿¡å·ï¼ŒSIG_DFL åˆ™è¡¨ç¤ºè®¾ç½®ä¸ºç³»ç»Ÿé»˜è®¤æ“ä½œã€‚<br>sig_t å‡½æ•°æŒ‡é’ˆçš„ int ç±»å‹å‚æ•°æŒ‡çš„æ˜¯ï¼Œå½“å‰è§¦å‘è¯¥å‡½æ•°çš„ä¿¡å·ï¼Œå¯å°†å¤šä¸ªä¿¡å·ç»‘å®šåˆ°åŒä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ä¸Šï¼Œæ­¤æ—¶å°±å¯é€šè¿‡æ­¤å‚æ•°æ¥åˆ¤æ–­å½“å‰è§¦å‘çš„æ˜¯å“ªä¸ªä¿¡å·ã€‚</p><p>è¿”å›å€¼ï¼šæ­¤å‡½æ•°çš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ª sig_t ç±»å‹çš„å‡½æ•°æŒ‡é’ˆï¼ŒæˆåŠŸæƒ…å†µä¸‹çš„è¿”å›å€¼åˆ™æ˜¯æŒ‡å‘åœ¨æ­¤ä¹‹å‰çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼›å¦‚æœå‡ºé”™åˆ™è¿”å› SIG_ERRï¼Œå¹¶ä¼šè®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">sig_handler</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Received signal: %d\n&quot;</span>, sig);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">sig_t</span> ret = <span class="literal">NULL</span>;</span><br><span class="line"> ret = signal(SIGINT, (<span class="type">sig_t</span>)sig_handler);</span><br><span class="line"> <span class="keyword">if</span> (SIG_ERR == ret) </span><br><span class="line"> &#123;</span><br><span class="line">perror(<span class="string">&quot;signal error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* æ­»å¾ªç¯ */</span></span><br><span class="line"> <span class="keyword">for</span> ( ; ; ) &#123; &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>sigaction()å‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaction</span><span class="params">(<span class="type">int</span> signum, <span class="type">const</span> <span class="keyword">struct</span> sigaction *act, <span class="keyword">struct</span> sigaction *oldact)</span>;</span><br></pre></td></tr></table></figure><p>signumï¼šéœ€è¦è®¾ç½®çš„ä¿¡å·ï¼Œé™¤äº† SIGKILL ä¿¡å·å’Œ SIGSTOP ä¿¡å·ä¹‹å¤–çš„ä»»ä½•ä¿¡å·ã€‚<br>actï¼šact å‚æ•°æ˜¯ä¸€ä¸ª struct sigaction ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª struct sigaction æ•°æ®ç»“æ„ï¼Œè¯¥æ•°æ®ç»“æ„æè¿°äº†ä¿¡<br>å·çš„å¤„ç†æ–¹å¼ï¼Œç¨åä»‹ç»è¯¥æ•°æ®ç»“æ„ï¼›å¦‚æœå‚æ•° act ä¸ä¸º NULLï¼Œåˆ™è¡¨ç¤ºéœ€è¦ä¸ºä¿¡å·è®¾ç½®æ–°çš„å¤„ç†æ–¹å¼ï¼›å¦‚<br>æœå‚æ•° act ä¸º NULLï¼Œåˆ™è¡¨ç¤ºæ— éœ€æ”¹å˜ä¿¡å·å½“å‰çš„å¤„ç†æ–¹å¼ã€‚<br>oldactï¼šoldact å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ª struct sigaction ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª struct sigaction æ•°æ®ç»“æ„ã€‚å¦‚æœå‚æ•°<br>oldact ä¸ä¸º NULLï¼Œåˆ™ä¼šå°†ä¿¡å·ä¹‹å‰çš„å¤„ç†æ–¹å¼ç­‰ä¿¡æ¯é€šè¿‡å‚æ•° oldact è¿”å›å‡ºæ¥ï¼›å¦‚æœæ— æ„è·å–æ­¤ç±»ä¿¡æ¯ï¼Œ<br>é‚£ä¹ˆå¯å°†è¯¥å‚æ•°è®¾ç½®ä¸º NULLã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="type">void</span> (*sa_handler)(<span class="type">int</span>);</span><br><span class="line"> <span class="type">void</span> (*sa_sigaction)(<span class="type">int</span>, <span class="type">siginfo_t</span> *, <span class="type">void</span> *);</span><br><span class="line"> <span class="type">sigset_t</span> sa_mask;</span><br><span class="line"> <span class="type">int</span> sa_flags;</span><br><span class="line"> <span class="type">void</span> (*sa_restorer)(<span class="type">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">sig_handler</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Received signal: %d\n&quot;</span>, sig);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sig</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> sig.sa_handler = sig_handler;</span><br><span class="line"> sig.sa_flags = <span class="number">0</span>;</span><br><span class="line"> ret = sigaction(SIGINT, &amp;sig, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) </span><br><span class="line">    &#123;</span><br><span class="line"> perror(<span class="string">&quot;sigaction error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* æ­»å¾ªç¯ */</span></span><br><span class="line"> <span class="keyword">for</span> ( ; ; ) &#123; &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‘è¿›ç¨‹å‘ä¿¡å·"><a href="#å‘è¿›ç¨‹å‘ä¿¡å·" class="headerlink" title="å‘è¿›ç¨‹å‘ä¿¡å·"></a>å‘è¿›ç¨‹å‘ä¿¡å·</h3><p><strong>kill</strong>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kill</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> sig)</span>;</span><br></pre></td></tr></table></figure><p>pidï¼šå‚æ•° pid ä¸ºæ­£æ•°çš„æƒ…å†µä¸‹ï¼Œç”¨äºæŒ‡å®šæ¥æ”¶æ­¤ä¿¡å·çš„è¿›ç¨‹ pidï¼›é™¤æ­¤ä¹‹å¤–ï¼Œå‚æ•° pid ä¹Ÿå¯è®¾ç½®ä¸º 0 æˆ–-1 ä»¥åŠå°äº-1 ç­‰ä¸åŒå€¼ï¼Œç¨åç»™è¯´æ˜ã€‚<br>sigï¼šå‚æ•° sig æŒ‡å®šéœ€è¦å‘é€çš„ä¿¡å·ï¼Œä¹Ÿå¯è®¾ç½®ä¸º 0ï¼Œå¦‚æœå‚æ•° sig è®¾ç½®ä¸º 0 åˆ™è¡¨ç¤ºä¸å‘é€ä¿¡å·ï¼Œä½†ä»»æ‰§è¡Œé”™è¯¯æ£€æŸ¥ï¼Œè¿™é€šå¸¸å¯ç”¨äºæ£€æŸ¥å‚æ•° pid æŒ‡å®šçš„è¿›ç¨‹æ˜¯å¦å­˜åœ¨ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚<br>å‚æ•° pid ä¸åŒå–å€¼å«ä¹‰ï¼š<br>âš« å¦‚æœ pid ä¸ºæ­£ï¼Œåˆ™ä¿¡å· sig å°†å‘é€åˆ° pid æŒ‡å®šçš„è¿›ç¨‹ã€‚<br>âš« å¦‚æœ pid ç­‰äº 0ï¼Œåˆ™å°† sig å‘é€åˆ°å½“å‰è¿›ç¨‹çš„è¿›ç¨‹ç»„ä¸­çš„æ¯ä¸ªè¿›ç¨‹ã€‚<br>âš« å¦‚æœ pid ç­‰äº-1ï¼Œåˆ™å°† sig å‘é€åˆ°å½“å‰è¿›ç¨‹æœ‰æƒå‘é€ä¿¡å·çš„æ¯ä¸ªè¿›ç¨‹ï¼Œä½†è¿›ç¨‹ 1ï¼ˆinitï¼‰é™¤å¤–ã€‚<br>âš« å¦‚æœ pid å°äº-1ï¼Œåˆ™å°† sig å‘é€åˆ° ID ä¸º-pid çš„è¿›ç¨‹ç»„ä¸­çš„æ¯ä¸ªè¿›ç¨‹ã€‚<br>è¿›ç¨‹ä¸­å°†ä¿¡å·å‘é€ç»™å¦ä¸€ä¸ªè¿›ç¨‹æ˜¯éœ€è¦æƒé™çš„ï¼Œå¹¶ä¸æ˜¯å¯ä»¥éšä¾¿ç»™ä»»ä½•ä¸€ä¸ªè¿›ç¨‹å‘é€ä¿¡å·ï¼Œè¶…çº§ç”¨æˆ·root è¿›ç¨‹å¯ä»¥å°†ä¿¡å·å‘é€ç»™ä»»ä½•è¿›ç¨‹ï¼Œä½†å¯¹äºéè¶…çº§ç”¨æˆ·ï¼ˆæ™®é€šç”¨æˆ·ï¼‰è¿›ç¨‹æ¥è¯´ï¼Œå…¶åŸºæœ¬è§„åˆ™æ˜¯å‘é€è€…è¿›ç¨‹çš„å®é™…ç”¨æˆ· ID æˆ–æœ‰æ•ˆç”¨æˆ· ID å¿…é¡»ç­‰äºæ¥æ”¶è€…è¿›ç¨‹çš„å®é™…ç”¨æˆ· ID æˆ–æœ‰æ•ˆç”¨æˆ· IDã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> pid;</span><br><span class="line"> <span class="comment">/* åˆ¤æ–­ä¼ å‚ä¸ªæ•° */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">2</span> &gt; argc)</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="comment">/* å°†ä¼ å…¥çš„å­—ç¬¦ä¸²è½¬ä¸ºæ•´å½¢æ•°å­— */</span></span><br><span class="line"> pid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;pid: %d\n&quot;</span>, pid);</span><br><span class="line"> <span class="comment">/* å‘ pid æŒ‡å®šçš„è¿›ç¨‹å‘é€ä¿¡å· */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == kill(pid, SIGINT)) </span><br><span class="line">    &#123;</span><br><span class="line"> perror(<span class="string">&quot;kill error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>raise()å‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">raise</span><span class="params">(<span class="type">int</span> sig)</span>;</span><br></pre></td></tr></table></figure><p>sigï¼šéœ€è¦å‘é€çš„ä¿¡å·ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›éé›¶å€¼ã€‚<br>raise()å…¶å®ç­‰ä»·äºï¼škill(getpid(), sig);</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">sig_handler</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Received signal: %d\n&quot;</span>, sig);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sig</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> sig.sa_handler = sig_handler;</span><br><span class="line"> sig.sa_flags = <span class="number">0</span>;</span><br><span class="line"> ret = sigaction(SIGINT, &amp;sig, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;sigaction error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">for</span> ( ; ; ) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">/* å‘è‡ªèº«å‘é€ SIGINT ä¿¡å· */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> != raise(SIGINT)) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;raise error\n&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> sleep(<span class="number">3</span>); <span class="comment">// æ¯éš” 3 ç§’å‘é€ä¸€æ¬¡</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>alarm()å’Œ pause()å‡½æ•°</p><p>ä½¿ç”¨ alarm()å‡½æ•°å¯ä»¥è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼ˆé—¹é’Ÿï¼‰ï¼Œå½“å®šæ—¶å™¨å®šæ—¶æ—¶é—´åˆ°æ—¶ï¼Œå†…æ ¸ä¼šå‘è¿›ç¨‹å‘é€ SIGALRMä¿¡å·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">alarm</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> seconds)</span>;</span><br></pre></td></tr></table></figure><p>secondsï¼šè®¾ç½®å®šæ—¶æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ï¼›å¦‚æœå‚æ•° seconds ç­‰äº 0ï¼Œåˆ™è¡¨ç¤ºå–æ¶ˆä¹‹å‰è®¾ç½®çš„ alarm é—¹é’Ÿã€‚<br>è¿”å›å€¼ï¼šå¦‚æœåœ¨è°ƒç”¨ alarm()æ—¶ï¼Œä¹‹å‰å·²ç»ä¸ºè¯¥è¿›ç¨‹è®¾ç½®äº† alarm é—¹é’Ÿè¿˜æ²¡æœ‰è¶…æ—¶ï¼Œåˆ™è¯¥é—¹é’Ÿçš„å‰©ä½™å€¼ä½œä¸ºæœ¬æ¬¡ alarm()å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼ï¼Œä¹‹å‰è®¾ç½®çš„é—¹é’Ÿåˆ™è¢«æ–°çš„æ›¿ä»£ï¼›å¦åˆ™è¿”å› 0ã€‚å‚æ•° seconds çš„å€¼æ˜¯äº§ç”Ÿ SIGALRM ä¿¡å·éœ€è¦ç»è¿‡çš„æ—¶é’Ÿç§’æ•°ï¼Œå½“è¿™ä¸€åˆ»åˆ°è¾¾æ—¶ï¼Œç”±å†…æ ¸äº§ç”Ÿè¯¥ä¿¡å·ï¼Œæ¯ä¸ªè¿›ç¨‹åªèƒ½è®¾ç½®ä¸€ä¸ª alarm é—¹é’Ÿï¼›è™½ç„¶ SIGALRM ä¿¡å·çš„ç³»ç»Ÿé»˜è®¤æ“ä½œæ˜¯ç»ˆæ­¢è¿›ç¨‹ï¼Œä½†æ˜¯å¦‚æœç¨‹åºå½“ä¸­è®¾ç½®äº† alarm é—¹é’Ÿï¼Œä½†å¤§å¤šæ•°ä½¿ç”¨é—¹é’Ÿçš„è¿›ç¨‹éƒ½ä¼šæ•è·æ­¤ä¿¡å·ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ alarm é—¹é’Ÿå¹¶ä¸èƒ½å¾ªç¯è§¦å‘ï¼Œåªèƒ½è§¦å‘ä¸€æ¬¡ï¼Œè‹¥æƒ³è¦å®ç°å¾ªç¯è§¦å‘ï¼Œå¯ä»¥åœ¨ SIGALRM ä¿¡å·å¤„ç†å‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ alarm()å‡½æ•°è®¾ç½®å®šæ—¶å™¨ã€‚</p><p>pause()ç³»ç»Ÿè°ƒç”¨å¯ä»¥ä½¿å¾—è¿›ç¨‹æš‚åœè¿è¡Œã€è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è¿›ç¨‹æ•è·åˆ°ä¸€ä¸ªä¿¡å·ä¸ºæ­¢ï¼Œåªæœ‰æ‰§è¡Œäº†ä¿¡<br>å·å¤„ç†å‡½æ•°å¹¶ä»å…¶è¿”å›æ—¶ï¼Œpause()æ‰è¿”å›ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œpause()è¿”å›-1ï¼Œå¹¶ä¸”å°† errno è®¾ç½®ä¸º EINTRã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">sig_handler</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Alarm timeout&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sig</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="type">int</span> second;</span><br><span class="line"> <span class="comment">/* æ£€éªŒä¼ å‚ä¸ªæ•° */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">2</span> &gt; argc)</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="comment">/* ä¸º SIGALRM ä¿¡å·ç»‘å®šå¤„ç†å‡½æ•° */</span></span><br><span class="line"> sig.sa_handler = sig_handler;</span><br><span class="line"> sig.sa_flags = <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == sigaction(SIGALRM, &amp;sig, <span class="literal">NULL</span>)) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;sigaction error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å¯åŠ¨ alarm å®šæ—¶å™¨ */</span></span><br><span class="line"> second = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;å®šæ—¶æ—¶é•¿: %d ç§’\n&quot;</span>, second);</span><br><span class="line"> alarm(second);</span><br><span class="line"> <span class="comment">/* è¿›å…¥ä¼‘çœ çŠ¶æ€ */</span></span><br><span class="line"> pause();</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;ä¼‘çœ ç»“æŸ&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿¡å·é›†"><a href="#ä¿¡å·é›†" class="headerlink" title="ä¿¡å·é›†"></a>ä¿¡å·é›†</h3><p>æœ‰ä¸€ä¸ªèƒ½è¡¨ç¤ºå¤šä¸ªä¿¡å·ï¼ˆä¸€ç»„ä¿¡å·ï¼‰çš„æ•°æ®ç±»å‹â€”ä¿¡å·é›†ï¼ˆsignalsetï¼‰ï¼Œå¾ˆå¤šç³»ç»Ÿè°ƒç”¨éƒ½ä½¿ç”¨åˆ°äº†ä¿¡å·é›†è¿™ç§æ•°æ®ç±»å‹æ¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œè­¬å¦‚ sigaction()å‡½æ•°ã€sigprocmask()å‡½æ•°ã€sigpending()å‡½æ•°ç­‰ã€‚</p><p>ä¿¡å·é›†å…¶å®å°±æ˜¯ sigset_t ç±»å‹æ•°æ®ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _SIGSET_NWORDS (1024 / (8 * sizeof (unsigned long int)))</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> __val[_SIGSET_NWORDS];</span><br><span class="line">&#125; <span class="type">sigset_t</span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“å¯ä»¥è¡¨ç¤ºä¸€ç»„ä¿¡å·ï¼Œå°†å¤šä¸ªä¿¡å·æ·»åŠ åˆ°è¯¥æ•°æ®ç»“æ„ä¸­ï¼Œå½“ç„¶ Linux ç³»ç»Ÿäº†ç”¨äºæ“ä½œsigset_t ä¿¡å·é›†çš„ APIï¼Œè­¬å¦‚ sigemptyset()ã€sigfillset()ã€sigaddset()ã€sigdelset()ã€sigismember()ã€‚</p><h4 id="ä¿¡å·é›†å¤„ç†"><a href="#ä¿¡å·é›†å¤„ç†" class="headerlink" title="ä¿¡å·é›†å¤„ç†"></a>ä¿¡å·é›†å¤„ç†</h4><p><strong>åˆå§‹åŒ–sigemptyset()å’Œ sigfillset()</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigemptyset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigfillset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>setï¼šæŒ‡å‘éœ€è¦è¿›è¡Œåˆå§‹åŒ–çš„ä¿¡å·é›†å˜é‡ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">sigset_t</span> sig_set;</span><br><span class="line">sigemptyset(&amp;sig_set);</span><br><span class="line"><span class="type">sigset_t</span> sig_set;</span><br><span class="line">sigfillset(&amp;sig_set);</span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ å’Œåˆ é™¤ä¿¡å·</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaddset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;<span class="comment">//setæŒ‡å‘ä¿¡å·é›†ï¼Œsignuméœ€è¦æ·»åŠ å’Œåˆ é™¤çš„ä¿¡å·</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigdelset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;<span class="comment">//æˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">sigset_t</span> sig_set;</span><br><span class="line">sigemptyset(&amp;sig_set);</span><br><span class="line">sigaddset(&amp;sig_set, SIGINT);<span class="comment">//ä¿¡å·é›†æ·»åŠ ä¿¡å·</span></span><br><span class="line"></span><br><span class="line"><span class="type">sigset_t</span> sig_set;</span><br><span class="line">sigfillset(&amp;sig_set);</span><br><span class="line">sigdelset(&amp;sig_set, SIGINT);<span class="comment">//ä¿¡å·é›†ç§»é™¤ä¿¡å·</span></span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•ä¿¡å·æ˜¯å¦åœ¨ä¿¡å·é›†</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigismember</span><span class="params">(<span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;</span><br><span class="line"><span class="comment">//setï¼šæŒ‡å®šä¿¡å·é›†ã€‚</span></span><br><span class="line"><span class="comment">//signumï¼šéœ€è¦è¿›è¡Œæµ‹è¯•çš„ä¿¡å·ã€‚</span></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šå¦‚æœä¿¡å· signum åœ¨ä¿¡å·é›† set ä¸­ï¼Œåˆ™è¿”å› 1ï¼›å¦‚æœä¸åœ¨ä¿¡å·é›† set ä¸­ï¼Œåˆ™è¿”å› 0ï¼›å¤±è´¥åˆ™è¿”å›1ï¼Œå¹¶è®¾ç½® errnoã€‚</span></span><br></pre></td></tr></table></figure><p>eg:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">sigset_t</span> sig_set;</span><br><span class="line"><span class="keyword">if</span>(sigismember(&amp;sig_set, SIGINT) == <span class="number">1</span>)</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;ä¿¡å·é›†ä¸­åŒ…å«SIGINTä¿¡å·&quot;</span>);</span><br></pre></td></tr></table></figure><p>åœ¨ Linux ä¸‹ï¼Œæ¯ä¸ªä¿¡å·éƒ½æœ‰ä¸€ä¸²ä¸ä¹‹ç›¸å¯¹åº”çš„å­—ç¬¦ä¸²æè¿°ä¿¡æ¯ï¼Œç”¨äºå¯¹è¯¥ä¿¡å·è¿›è¡Œç›¸åº”çš„æè¿°ã€‚è¿™äº›å­—ç¬¦ä¸²ä½äº sys_siglist æ•°ç»„ä¸­ï¼Œsys_siglist æ•°ç»„æ˜¯ä¸€ä¸ª char *ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ å­˜æ”¾çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªä¿¡å·æè¿°ä¿¡æ¯ã€‚è­¬å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ sys_siglist[SIGINT]æ¥è·å–å¯¹ SIGINT ä¿¡å·çš„æè¿°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;SIGINT æè¿°ä¿¡æ¯: %s\n&quot;</span>, sys_siglist[SIGINT]);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;SIGQUIT æè¿°ä¿¡æ¯: %s\n&quot;</span>, sys_siglist[SIGQUIT]);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;SIGBUS æè¿°ä¿¡æ¯: %s\n&quot;</span>, sys_siglist[SIGBUS]);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>psignal()å¯ä»¥åœ¨æ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰ä¸Šè¾“å‡ºä¿¡å·æè¿°ä¿¡æ¯</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">psignal</span><span class="params">(<span class="type">int</span> sig, <span class="type">const</span> <span class="type">char</span> *s)</span>;</span><br></pre></td></tr></table></figure><p>ä¿¡å·æ©ç ï¼ˆé˜»å¡ä¿¡å·ä¼ é€’ï¼‰</p><p>å†…æ ¸ä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªä¿¡å·æ©ç ï¼ˆå…¶å®å°±æ˜¯ä¸€ä¸ªä¿¡å·é›†ï¼‰ï¼Œå³ä¸€ç»„ä¿¡å·ã€‚å½“è¿›ç¨‹æ¥æ”¶åˆ°ä¸€ä¸ªå±äºä¿¡å·æ©ç ä¸­å®šä¹‰çš„ä¿¡å·æ—¶ï¼Œè¯¥ä¿¡å·å°†ä¼šè¢«é˜»å¡ã€æ— æ³•ä¼ é€’ç»™è¿›ç¨‹è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šå°†å…¶é˜»å¡ï¼Œç›´åˆ°è¯¥ä¿¡å·ä»ä¿¡å·æ©ç ä¸­ç§»é™¤ï¼Œå†…æ ¸æ‰ä¼šæŠŠè¯¥ä¿¡å·ä¼ é€’ç»™è¿›ç¨‹ä»è€Œå¾—åˆ°å¤„ç†ã€‚</p><p>ä¿¡å·æ©ç ä¸­æ·»åŠ ä¿¡å·çš„æ–¹æ³•ï¼š</p><p>â‘ ç¨‹åºè°ƒç”¨signal()æˆ–è€…sigactionå‡½æ•°ä¸ºæŸä¸€ä¸ªä¿¡å·è®¾ç½®å¤„ç†æ–¹å¼æ—¶ï¼Œè¿›ç¨‹ä¼šè‡ªåŠ¨å°†è¯¥ä¿¡å·æ·»åŠ åˆ°ä¿¡å·æ©ç ä¸­ï¼Œè¿™æ ·ä¿è¯äº†å¤„ç†ä¸€ä¸ªç»™å®šä¿¡å·æ—¶å€™ï¼Œå†æ¬¡ç¢°åˆ°è¯¥ä¿¡å·ï¼Œä¼šå°†è¯·å…¶é˜»å¡ã€‚</p><p>â‘¡ä½¿ç”¨sigaction()å‡½æ•°ä¸ºä¿¡å·è®¾ç½®å¤„ç†æ–¹å¼æ—¶ï¼Œå¯ä»¥é¢å¤–æŒ‡å®šä¸€ç»„ä¿¡å·ï¼Œå½“è°ƒç”¨ä¿¡å·å¤„ç†å‡½æ•°æ—¶å°†è¯¥ç»„ä¿¡å·è‡ªåŠ¨æ·»åŠ åˆ°ä¿¡å·æ©ç ä¸­ï¼Œä½†ä¿¡å·å¤„ç†å‡½æ•°ç»“æŸè¿”å›åï¼Œå†å°†è¿™ç»„ä¿¡å·ä»ä¿¡å·æ©ç ä¸­ç§»é™¤</p><p>â‘¢è¿˜å¯ä»¥ä½¿ç”¨sigprocmask()ç³»ç»Ÿè°ƒç”¨ï¼Œéšæ—¶å¯ä»¥æ˜¾å¼åœ°å‘ä¿¡å·æ©ç ä¸­æ·»åŠ &#x2F;ç§»é™¤ä¿¡å·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigprocmask</span><span class="params">(<span class="type">int</span> how, <span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">sigset_t</span> *oldset)</span>;</span><br></pre></td></tr></table></figure><p>howï¼šå‚æ•° how æŒ‡å®šäº†è°ƒç”¨å‡½æ•°æ—¶çš„ä¸€äº›è¡Œä¸ºã€‚<br>setï¼šå°†å‚æ•° set æŒ‡å‘çš„ä¿¡å·é›†å†…çš„æ‰€æœ‰ä¿¡å·æ·»åŠ åˆ°ä¿¡å·æ©ç ä¸­æˆ–è€…ä»ä¿¡å·æ©ç ä¸­ç§»é™¤ï¼›å¦‚æœå‚æ•° set ä¸ºNULLï¼Œåˆ™è¡¨ç¤ºæ— éœ€å¯¹å½“å‰ä¿¡å·æ©ç ä½œå‡ºæ”¹åŠ¨ã€‚<br>oldsetï¼šå¦‚æœå‚æ•° oldset ä¸ä¸º NULLï¼Œåœ¨å‘ä¿¡å·æ©ç ä¸­æ·»åŠ æ–°çš„ä¿¡å·ä¹‹å‰ï¼Œè·å–åˆ°è¿›ç¨‹å½“å‰çš„ä¿¡å·æ©ç ï¼Œå­˜æ”¾åœ¨ oldset æ‰€æŒ‡å®šçš„ä¿¡å·é›†ä¸­ï¼›å¦‚æœä¸º NULL åˆ™è¡¨ç¤ºä¸è·å–å½“å‰çš„ä¿¡å·æ©ç ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚<br>å‚æ•° how å¯ä»¥è®¾ç½®ä¸ºä»¥ä¸‹å®ï¼š<br>âš« <strong>SIG_BLOCK</strong>ï¼šå°†å‚æ•° set æ‰€æŒ‡å‘çš„ä¿¡å·é›†å†…çš„æ‰€æœ‰ä¿¡å·æ·»åŠ åˆ°è¿›ç¨‹çš„ä¿¡å·æ©ç ä¸­ã€‚æ¢è¨€ä¹‹ï¼Œå°†ä¿¡å·æ©ç è®¾ç½®ä¸ºå½“å‰å€¼ä¸ set çš„å¹¶é›†ã€‚<br>âš« <strong>SIG_UNBLOCK</strong>ï¼šå°†å‚æ•° set æŒ‡å‘çš„ä¿¡å·é›†å†…çš„æ‰€æœ‰ä¿¡å·ä»è¿›ç¨‹ä¿¡å·æ©ç ä¸­ç§»é™¤ã€‚<br>âš« <strong>SIG_SETMASK</strong>ï¼šè¿›ç¨‹ä¿¡å·æ©ç ç›´æ¥è®¾ç½®ä¸ºå‚æ•° set æŒ‡å‘çš„ä¿¡å·é›†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">sig_handler</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æ‰§è¡Œä¿¡å·å¤„ç†å‡½æ•°\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sig</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="type">sigset_t</span> sig_set;</span><br><span class="line"> <span class="comment">/* æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•° */</span></span><br><span class="line"> sig.sa_handler = sig_handler;</span><br><span class="line"> sig.sa_flags = <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == sigaction(SIGINT, &amp;sig, <span class="literal">NULL</span>))</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="comment">/* ä¿¡å·é›†åˆå§‹åŒ– */</span></span><br><span class="line"> sigemptyset(&amp;sig_set);</span><br><span class="line"> sigaddset(&amp;sig_set, SIGINT);</span><br><span class="line"> <span class="comment">/* å‘ä¿¡å·æ©ç ä¸­æ·»åŠ ä¿¡å· */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == sigprocmask(SIG_BLOCK, &amp;sig_set, <span class="literal">NULL</span>))</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="comment">/* å‘è‡ªå·±å‘é€ä¿¡å· */</span></span><br><span class="line"> raise(SIGINT);</span><br><span class="line"> <span class="comment">/* ä¼‘çœ  2 ç§’ */</span></span><br><span class="line"> sleep(<span class="number">2</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;ä¼‘çœ ç»“æŸ\n&quot;</span>);</span><br><span class="line"> <span class="comment">/* ä»ä¿¡å·æ©ç ä¸­ç§»é™¤æ·»åŠ çš„ä¿¡å· */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == sigprocmask(SIG_UNBLOCK, &amp;sig_set, <span class="literal">NULL</span>))</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é˜»å¡ç­‰å¾…ä¿¡å·"><a href="#é˜»å¡ç­‰å¾…ä¿¡å·" class="headerlink" title="é˜»å¡ç­‰å¾…ä¿¡å·"></a>é˜»å¡ç­‰å¾…ä¿¡å·</h3><p>å¦‚æœå¸Œæœ›å¯¹ä¸€ä¸ªä¿¡å·è§£é™¤é˜»å¡åï¼Œç„¶åè°ƒç”¨ pause()ä»¥ç­‰å¾…ä¹‹å‰è¢«é˜»å¡çš„ä¿¡å·çš„ä¼ é€’ï¼Œè¿™å°†å¦‚ä½•ï¼Ÿè­¬å¦‚æœ‰å¦‚ä¸‹ä»£ç æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">sigset_t</span> new_set, old_set;</span><br><span class="line"> <span class="comment">/* ä¿¡å·é›†åˆå§‹åŒ– */</span></span><br><span class="line"> sigemptyset(&amp;new_set);</span><br><span class="line"> sigaddset(&amp;new_set, SIGINT);</span><br><span class="line"> <span class="comment">/* å‘ä¿¡å·æ©ç ä¸­æ·»åŠ ä¿¡å· */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == sigprocmask(SIG_BLOCK, &amp;new_set, &amp;old_set))</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> <span class="comment">/* å—ä¿æŠ¤çš„å…³é”®ä»£ç æ®µ */</span></span><br><span class="line"> ......</span><br><span class="line"> <span class="comment">/**********************/</span></span><br><span class="line"> <span class="comment">/* æ¢å¤ä¿¡å·æ©ç  */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == sigprocmask(SIG_SETMASK, &amp;old_set, <span class="literal">NULL</span>))</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> pause();<span class="comment">/* ç­‰å¾…ä¿¡å·å”¤é†’ */</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå—ä¿æŠ¤çš„å…³é”®ä»£ç æ—¶ä¸å¸Œæœ›è¢« SIGINT ä¿¡å·æ‰“æ–­ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œå…³é”®ä»£ç ä¹‹å‰å°† SIGINT ä¿¡å·æ·»åŠ åˆ°è¿›ç¨‹çš„ä¿¡å·æ©ç ä¸­ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åå†æ¢å¤ä¹‹å‰çš„ä¿¡å·æ©ç ã€‚æœ€åè°ƒç”¨äº† pause()é˜»å¡ç­‰å¾…è¢«ä¿¡å·å”¤é†’ï¼Œå¦‚æœæ­¤æ—¶å‘ç”Ÿäº†ä¿¡å·åˆ™ä¼šè¢«å”¤é†’ã€ä» pause è¿”å›ç»§ç»­æ‰§è¡Œï¼›è€ƒè™‘åˆ°è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå¦‚æœä¿¡å·çš„ä¼ é€’æ°å¥½å‘ç”Ÿåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨sigprocmask()ä¹‹åã€pause()ä¹‹å‰ï¼Œå¦‚æœç¡®å®å‘ç”Ÿäº†è¿™ç§æƒ…å†µï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œä¿¡å·ä¼ é€’è¿‡æ¥å°±ä¼šå¯¼è‡´æ‰§è¡Œä¿¡å·çš„å¤„ç†å‡½æ•°ï¼Œè€Œä»å¤„ç†å‡½æ•°è¿”å›ååˆå›åˆ°ä¸»ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œä»è€Œè¿›å…¥åˆ° pause()è¢«é˜»å¡ï¼ŒçŸ¥é“ä¸‹ä¸€æ¬¡ä¿¡å·å‘ç”Ÿæ—¶æ‰ä¼šè¢«å”¤é†’ï¼Œè¿™æœ‰è¿ä»£ç çš„æœ¬æ„ã€‚</p><p>è¦é¿å…è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å°†æ¢å¤ä¿¡å·æ©ç å’Œ pause()æŒ‚èµ·è¿›ç¨‹è¿™ä¸¤ä¸ªåŠ¨ä½œå°è£…æˆä¸€ä¸ªåŸå­æ“ä½œï¼Œè¿™æ­£æ˜¯ sigsuspend()ç³»ç»Ÿè°ƒç”¨çš„ç›®çš„æ‰€åœ¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigsuspend</span><span class="params">(<span class="type">const</span> <span class="type">sigset_t</span> *mask)</span>;</span><br></pre></td></tr></table></figure><p>maskï¼šå‚æ•° mask æŒ‡å‘ä¸€ä¸ªä¿¡å·é›†ã€‚<br>è¿”å›å€¼ï¼šsigsuspend()å§‹ç»ˆè¿”å›-1ï¼Œå¹¶è®¾ç½® errno æ¥æŒ‡ç¤ºé”™è¯¯ï¼ˆé€šå¸¸ä¸º EINTRï¼‰ï¼Œè¡¨ç¤ºè¢«ä¿¡å·æ‰€ä¸­æ–­ï¼Œå¦‚æœè°ƒç”¨å¤±è´¥ï¼Œå°† errno è®¾ç½®ä¸º EFAULTã€‚</p><p>sigsuspend()å‡½æ•°ä¼šå°†å‚æ•° mask æ‰€æŒ‡å‘çš„ä¿¡å·é›†æ¥æ›¿æ¢è¿›ç¨‹çš„ä¿¡å·æ©ç ï¼Œä¹Ÿå°±æ˜¯å°†è¿›ç¨‹çš„ä¿¡å·æ©ç è®¾ç½®ä¸ºå‚æ•° mask æ‰€æŒ‡å‘çš„ä¿¡å·é›†ï¼Œç„¶åæŒ‚èµ·è¿›ç¨‹ï¼Œç›´åˆ°æ•è·åˆ°ä¿¡å·è¢«å”¤é†’ï¼ˆå¦‚æœæ•è·çš„ä¿¡å·æ˜¯ mask ä¿¡å·é›†ä¸­çš„æˆå‘˜ï¼Œå°†ä¸ä¼šå”¤é†’ã€ç»§ç»­æŒ‚èµ·ï¼‰ã€å¹¶ä»ä¿¡å·å¤„ç†å‡½æ•°è¿”å›ï¼Œä¸€æ—¦ä»ä¿¡å·å¤„ç†å‡½æ•°è¿”å›ï¼Œsigsuspend()ä¼šå°†è¿›ç¨‹çš„ä¿¡å·æ©ç æ¢å¤æˆè°ƒç”¨å‰çš„å€¼ã€‚</p><p>è°ƒç”¨ sigsuspend()å‡½æ•°ç›¸å½“äºä»¥ä¸å¯ä¸­æ–­ï¼ˆåŸå­æ“ä½œï¼‰çš„æ–¹å¼æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sigprocmask(SIG_SETMASK, &amp;mask, &amp;old_mask);</span><br><span class="line">pause();</span><br><span class="line">sigprocmask(SIG_SETMASK, &amp;old_mask, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><h3 id="å®æ—¶ä¿¡å·"><a href="#å®æ—¶ä¿¡å·" class="headerlink" title="å®æ—¶ä¿¡å·"></a>å®æ—¶ä¿¡å·</h3><p>ç¡®å®šè¿›ç¨‹ä¸­å¤„äºç­‰å¾…çŠ¶æ€çš„æ˜¯å“ªäº›ä¿¡å·ï¼Œç”¨sigpending()å‡½æ•°è·å–ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigpending</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;</span><br></pre></td></tr></table></figure><p>setï¼šå¤„äºç­‰å¾…çŠ¶æ€çš„ä¿¡å·ä¼šå­˜æ”¾åœ¨å‚æ•° set æ‰€æŒ‡å‘çš„ä¿¡å·é›†ä¸­ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p><u>åˆ¤æ–­ SIGINT ä¿¡å·å½“å‰æ˜¯å¦å¤„äºç­‰å¾…çŠ¶æ€</u></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®šä¹‰ä¿¡å·é›† */</span></span><br><span class="line"><span class="type">sigset_t</span> sig_set;</span><br><span class="line"><span class="comment">/* å°†ä¿¡å·é›†åˆå§‹åŒ–ä¸ºç©º */</span></span><br><span class="line">sigemptyset(&amp;sig_set);</span><br><span class="line"><span class="comment">/* è·å–å½“å‰å¤„äºç­‰å¾…çŠ¶æ€çš„ä¿¡å· */</span></span><br><span class="line">sigpending(&amp;sig_set);</span><br><span class="line"><span class="comment">/* åˆ¤æ–­ SIGINT ä¿¡å·æ˜¯å¦å¤„äºç­‰å¾…çŠ¶æ€ */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">1</span> == sigismember(&amp;sig_set, SIGINT))</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;SIGINT ä¿¡å·å¤„äºç­‰å¾…çŠ¶æ€&quot;</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!sigismember(&amp;sig_set, SIGINT))</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;SIGINT ä¿¡å·æœªå¤„äºç­‰å¾…çŠ¶æ€&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç­‰å¾…ä¿¡å·é›†åªæ˜¯ä¸€ä¸ªæ©ç ï¼Œä»…è¡¨æ˜ä¸€ä¸ªä¿¡å·æ˜¯å¦å‘ç”Ÿï¼Œè€Œä¸èƒ½è¡¨ç¤ºå…¶å‘ç”Ÿçš„æ¬¡æ•°ã€‚æ¢è¨€ä¹‹ï¼Œå¦‚æœä¸€ä¸ªåŒä¸€ä¸ªä¿¡å·åœ¨é˜»å¡çŠ¶æ€ä¸‹äº§ç”Ÿäº†å¤šæ¬¡ï¼Œé‚£ä¹ˆä¼šå°†è¯¥ä¿¡å·è®°å½•åœ¨ç­‰å¾…ä¿¡å·é›†ä¸­ï¼Œå¹¶åœ¨ä¹‹åä»…ä¼ é€’ä¸€æ¬¡ï¼ˆä»…å½“åšå‘ç”Ÿäº†ä¸€æ¬¡ï¼‰ï¼Œè¿™æ˜¯æ ‡å‡†ä¿¡å·çš„ç¼ºç‚¹ä¹‹ä¸€ã€‚</p><p>å®æ—¶ä¿¡å·è¾ƒä¹‹äºæ ‡å‡†ä¿¡å·ï¼Œå…¶ä¼˜åŠ¿å¦‚ä¸‹ï¼š<br>âš« å®æ—¶ä¿¡å·çš„ä¿¡å·èŒƒå›´æœ‰æ‰€æ‰©å¤§ï¼Œå¯åº”ç”¨äºåº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„ç›®çš„ï¼Œè€Œæ ‡å‡†ä¿¡å·ä»…æä¾›äº†ä¸¤ä¸ªä¿¡å·å¯ç”¨äºåº”ç”¨ç¨‹åºè‡ªå®šä¹‰ä½¿ç”¨ï¼šSIGUSR1 å’Œ SIGUSR2ã€‚<br>âš« å†…æ ¸å¯¹äºå®æ—¶ä¿¡å·æ‰€é‡‡å–çš„æ˜¯é˜Ÿåˆ—åŒ–ç®¡ç†ã€‚å¦‚æœå°†æŸä¸€å®æ—¶ä¿¡å·å¤šæ¬¡å‘é€ç»™å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆå°†ä¼šå¤šæ¬¡ä¼ é€’æ­¤ä¿¡å·ã€‚ç›¸åï¼Œå¯¹äºæŸä¸€æ ‡å‡†ä¿¡å·æ­£åœ¨ç­‰å¾…æŸä¸€è¿›ç¨‹ï¼Œè€Œæ­¤æ—¶å³ä½¿å†æ¬¡å‘è¯¥è¿›ç¨‹å‘é€æ­¤ä¿¡å·ï¼Œä¿¡å·ä¹Ÿåªä¼šä¼ é€’ä¸€æ¬¡ã€‚<br>âš« å½“å‘é€ä¸€ä¸ªå®æ—¶ä¿¡å·æ—¶ï¼Œå¯ä¸ºä¿¡å·æŒ‡å®šä¼´éšæ•°æ®ï¼ˆä¸€æ•´å½¢æ•°æ®æˆ–è€…æŒ‡é’ˆå€¼ï¼‰ï¼Œä¾›æ¥æ”¶ä¿¡å·çš„è¿›ç¨‹åœ¨å®ƒçš„ä¿¡å·å¤„ç†å‡½æ•°ä¸­è·å–ã€‚<br>âš« ä¸åŒå®æ—¶ä¿¡å·çš„ä¼ é€’é¡ºåºå¾—åˆ°ä¿éšœã€‚å¦‚æœæœ‰å¤šä¸ªä¸åŒçš„å®æ—¶ä¿¡å·å¤„äºç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆå°†ç‡å…ˆä¼ é€’å…·æœ‰æœ€å°ç¼–å·çš„ä¿¡å·ã€‚æ¢è¨€ä¹‹ï¼Œä¿¡å·çš„ç¼–å·è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå¦‚æœæ˜¯åŒä¸€ç±»å‹çš„å¤šä¸ªä¿¡å·åœ¨æ’é˜Ÿï¼Œé‚£ä¹ˆä¿¡å·ï¼ˆä»¥åŠä¼´éšæ•°æ®ï¼‰çš„ä¼ é€’é¡ºåºä¸ä¿¡å·å‘é€æ¥æ—¶çš„é¡ºåºä¿æŒä¸€è‡´ã€‚</p><p>åº”ç”¨ç¨‹åºå½“ä¸­ä½¿ç”¨å®æ—¶ä¿¡å·ï¼Œéœ€è¦æœ‰ä»¥ä¸‹çš„ä¸¤ç‚¹è¦æ±‚ï¼š<br>âš« å‘é€è¿›ç¨‹ä½¿ç”¨ sigqueue()ç³»ç»Ÿè°ƒç”¨å‘å¦ä¸€ä¸ªè¿›ç¨‹å‘é€å®æ—¶ä¿¡å·ä»¥åŠä¼´éšæ•°æ®ã€‚<br>âš« æ¥æ”¶å®æ—¶ä¿¡å·çš„è¿›ç¨‹è¦ä¸ºè¯¥ä¿¡å·å»ºç«‹ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œä½¿ç”¨sigactionå‡½æ•°ä¸ºä¿¡å·å»ºç«‹å¤„ç†å‡½æ•°ï¼Œå¹¶åŠ å…¥ SA_SIGINFOï¼Œè¿™æ ·ä¿¡å·å¤„ç†å‡½æ•°æ‰èƒ½å¤Ÿæ¥æ”¶åˆ°å®æ—¶ä¿¡å·ä»¥åŠä¼´éšæ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¦ä½¿ç”¨sa_sigaction æŒ‡é’ˆæŒ‡å‘çš„å¤„ç†å‡½æ•°ï¼Œè€Œä¸æ˜¯ sa_handlerï¼Œå½“ç„¶å…è®¸åº”ç”¨ç¨‹åºä½¿ç”¨ sa_handlerï¼Œä½†è¿™æ ·å°±ä¸èƒ½è·å–åˆ°å®æ—¶ä¿¡å·çš„ä¼´éšæ•°æ®äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigqueue</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> sig, <span class="type">const</span> <span class="keyword">union</span> sigval value)</span>;</span><br></pre></td></tr></table></figure><p>pidï¼šæŒ‡å®šæ¥æ”¶ä¿¡å·çš„è¿›ç¨‹å¯¹åº”çš„ pidï¼Œå°†ä¿¡å·å‘é€ç»™è¯¥è¿›ç¨‹ã€‚<br>sigï¼šæŒ‡å®šéœ€è¦å‘é€çš„ä¿¡å·ã€‚ä¸ kill()å‡½æ•°ä¸€æ ·ï¼Œä¹Ÿå¯å°†å‚æ•° sig è®¾ç½®ä¸º 0ï¼Œç”¨äºæ£€æŸ¥å‚æ•° pid æ‰€æŒ‡å®šçš„è¿›ç¨‹æ˜¯å¦å­˜åœ¨ã€‚<br>valueï¼šå‚æ•° value æŒ‡å®šäº†ä¿¡å·çš„ä¼´éšæ•°æ®ï¼Œunion sigval æ•°æ®ç±»å‹ã€‚</p><p>è¿”å›å€¼ï¼šæˆåŠŸå°†è¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">sigval</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">int</span> sival_int;</span><br><span class="line"><span class="type">void</span> *sival_ptr;</span><br><span class="line">&#125; <span class="type">sigval_t</span>;</span><br></pre></td></tr></table></figure><p><strong>å¼‚å¸¸é€€å‡ºå‡½æ•°abort()</strong></p><p>ä½¿ç”¨ abort()ç»ˆæ­¢è¿›ç¨‹è¿è¡Œï¼Œä¼šç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œå¯ç”¨äºåˆ¤æ–­ç¨‹åºè°ƒç”¨ abort()æ—¶çš„ç¨‹åºçŠ¶æ€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">abort</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p><u>å‡½æ•° abort()é€šå¸¸äº§ç”Ÿ SIGABRT ä¿¡å·æ¥ç»ˆæ­¢è°ƒç”¨è¯¥å‡½æ•°çš„è¿›ç¨‹ï¼ŒSIGABRT ä¿¡å·çš„ç³»ç»Ÿé»˜è®¤æ“ä½œæ˜¯ç»ˆæ­¢è¿›ç¨‹è¿è¡Œã€å¹¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼›å½“è°ƒç”¨ abort()å‡½æ•°ä¹‹åï¼Œå†…æ ¸ä¼šå‘è¿›ç¨‹å‘é€ SIGABRT ä¿¡å·ã€‚</u></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ“ä½œç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿä¿¡æ¯ä¸ç³»ç»Ÿèµ„æº</title>
      <link href="/2022/12/13/2022-12-13-Linux%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF%E4%B8%8E%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90/"/>
      <url>/2022/12/13/2022-12-13-Linux%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF%E4%B8%8E%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90/</url>
      
        <content type="html"><![CDATA[<h2 id="ç³»ç»Ÿä¿¡æ¯ä¸ç³»ç»Ÿèµ„æº"><a href="#ç³»ç»Ÿä¿¡æ¯ä¸ç³»ç»Ÿèµ„æº" class="headerlink" title="ç³»ç»Ÿä¿¡æ¯ä¸ç³»ç»Ÿèµ„æº"></a>ç³»ç»Ÿä¿¡æ¯ä¸ç³»ç»Ÿèµ„æº</h2><h3 id="ç³»ç»Ÿä¿¡æ¯"><a href="#ç³»ç»Ÿä¿¡æ¯" class="headerlink" title="ç³»ç»Ÿä¿¡æ¯"></a>ç³»ç»Ÿä¿¡æ¯</h3><h4 id="ç³»ç»Ÿæ ‡è¯†uname"><a href="#ç³»ç»Ÿæ ‡è¯†uname" class="headerlink" title="ç³»ç»Ÿæ ‡è¯†uname"></a>ç³»ç»Ÿæ ‡è¯†uname</h4><p>ç³»ç»Ÿè°ƒç”¨uname()ç”¨äºè·å–æœ‰å…³å½“å‰æ“ä½œç³»ç»Ÿå†…æ ¸çš„åç§°å’Œä¿¡æ¯ï¼ŒåŸå‹å¯ä»¥é€šè¿‡man 2 unameæŸ¥çœ‹</p><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>bufï¼šstruct utsname ç»“æ„ä½“ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª struct utsname ç»“æ„ä½“ç±»å‹å¯¹è±¡ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p>uname()å‡½æ•°ç”¨æ³•éå¸¸ç®€å•ï¼Œå…ˆå®šä¹‰ä¸€ä¸ª struct utsname ç»“æ„ä½“å˜é‡ï¼Œè°ƒç”¨ uname()å‡½æ•°æ—¶ä¼ å…¥å˜é‡çš„åœ°<br>å€å³å¯ï¼Œstruct utsname ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">utsname</span> &#123;</span></span><br><span class="line"> <span class="type">char</span> sysname[]; <span class="comment">/* å½“å‰æ“ä½œç³»ç»Ÿçš„åç§° */</span></span><br><span class="line"> <span class="type">char</span> nodename[]; <span class="comment">/* ç½‘ç»œä¸Šçš„åç§°ï¼ˆä¸»æœºåï¼‰ */</span></span><br><span class="line"> <span class="type">char</span> release[]; <span class="comment">/* æ“ä½œç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ */</span></span><br><span class="line"> <span class="type">char</span> version[]; <span class="comment">/* æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆæœ¬ */</span></span><br><span class="line"> <span class="type">char</span> machine[]; <span class="comment">/* ç¡¬ä»¶æ¶æ„ç±»å‹ */</span></span><br><span class="line"> <span class="meta">#<span class="keyword">ifdef</span> _GNU_SOURCE</span></span><br><span class="line"> <span class="type">char</span> domainname[];<span class="comment">/* å½“å‰åŸŸå */</span></span><br><span class="line"> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="sysinfoå‡½æ•°"><a href="#sysinfoå‡½æ•°" class="headerlink" title="sysinfoå‡½æ•°"></a>sysinfoå‡½æ•°</h4><p>sysinfo ç³»ç»Ÿè°ƒç”¨å¯ç”¨äºè·å–ä¸€äº›ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sysinfo.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sysinfo</span><span class="params">(<span class="keyword">struct</span> sysinfo *info)</span>;</span><br></pre></td></tr></table></figure><p>infoï¼šstruct sysinfo ç»“æ„ä½“ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª struct sysinfo ç»“æ„ä½“ç±»å‹å¯¹è±¡ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> &#123;</span></span><br><span class="line"> <span class="type">long</span> uptime; <span class="comment">/* è‡ªç³»ç»Ÿå¯åŠ¨ä¹‹åæ‰€ç»è¿‡çš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> loads[<span class="number">3</span>]; <span class="comment">/* 1, 5, and 15 minute load averages */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> totalram; <span class="comment">/* æ€»çš„å¯ç”¨å†…å­˜å¤§å° */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> freeram; <span class="comment">/* è¿˜æœªè¢«ä½¿ç”¨çš„å†…å­˜å¤§å° */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> sharedram; <span class="comment">/* Amount of shared memory */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> bufferram; <span class="comment">/* Memory used by buffers */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> totalswap; <span class="comment">/* Total swap space size */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> freeswap; <span class="comment">/* swap space still available */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">short</span> procs; <span class="comment">/* ç³»ç»Ÿå½“å‰è¿›ç¨‹æ•°é‡ */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> totalhigh; <span class="comment">/* Total high memory size */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> freehigh; <span class="comment">/* Available high memory size */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">int</span> mem_unit; <span class="comment">/* å†…å­˜å•å…ƒå¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ */</span></span><br><span class="line"> <span class="type">char</span> _f[<span class="number">20</span><span class="number">-2</span>*<span class="keyword">sizeof</span>(<span class="type">long</span>)-<span class="keyword">sizeof</span>(<span class="type">int</span>)]; <span class="comment">/* Padding to 64 bytes */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="gethostnameå‡½æ•°"><a href="#gethostnameå‡½æ•°" class="headerlink" title="gethostnameå‡½æ•°"></a>gethostnameå‡½æ•°</h4><p>æ­¤å‡½æ•°å¯ç”¨äºå•ç‹¬è·å– Linux ç³»ç»Ÿä¸»æœºåï¼Œä¸ struct utsname æ•°æ®ç»“æ„ä½“ä¸­çš„ nodename å˜é‡ä¸€æ ·ï¼ŒåŸå‹é€šè¿‡å‘½ä»¤man 2 gethostnameæŸ¥çœ‹ã€‚</p><p>nameï¼šæŒ‡å‘ç”¨äºå­˜æ”¾ä¸»æœºåå­—ç¬¦ä¸²çš„ç¼“å†²åŒºã€‚<br>lenï¼šç¼“å†²åŒºé•¿åº¦ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0,ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¼šè®¾ç½® errnoã€‚</p><h4 id="sysconfå‡½æ•°"><a href="#sysconfå‡½æ•°" class="headerlink" title="sysconfå‡½æ•°"></a>sysconfå‡½æ•°</h4><p>sysconf()å‡½æ•°æ˜¯ä¸€ä¸ªåº“å‡½æ•°ï¼Œå¯åœ¨è¿è¡Œæ—¶è·å–ç³»ç»Ÿçš„ä¸€äº›é…ç½®ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">long</span> <span class="title function_">sysconf</span><span class="params">(<span class="type">int</span> name)</span>;</span><br></pre></td></tr></table></figure><p>âš« _SC_ARG_MAXï¼šexec æ—å‡½æ•°çš„å‚æ•°çš„æœ€å¤§é•¿åº¦ï¼Œexec æ—å‡½æ•°åé¢ä¼šä»‹ç»ï¼Œè¿™é‡Œå…ˆä¸ç®¡ï¼<br>âš« _SC_CHILD_MAXï¼šæ¯ä¸ªç”¨æˆ·çš„æœ€å¤§å¹¶å‘è¿›ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯åŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶è¿è¡Œçš„æœ€å¤§è¿›ç¨‹æ•°ã€‚<br>âš« _SC_HOST_NAME_MAXï¼šä¸»æœºåçš„æœ€å¤§é•¿åº¦ã€‚<br>âš« _SC_LOGIN_NAME_MAXï¼šç™»å½•åçš„æœ€å¤§é•¿åº¦ã€‚<br>âš« _SC_CLK_TCKï¼šæ¯ç§’æ—¶é’Ÿæ»´ç­”æ•°ï¼Œä¹Ÿå°±æ˜¯ç³»ç»ŸèŠ‚æ‹ç‡ã€‚<br>âš« _SC_OPEN_MAXï¼šä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°ã€‚<br>âš« _SC_PAGESIZEï¼šç³»ç»Ÿé¡µå¤§å°ï¼ˆpage sizeï¼‰ã€‚<br>âš« _SC_TTY_NAME_MAXï¼šç»ˆç«¯è®¾å¤‡åç§°çš„æœ€å¤§é•¿åº¦ã€‚</p><p>æ›´å¤šè¯·ç”¨manæŒ‡ä»¤æŸ¥è¯¢ã€‚</p><h3 id="æ—¶é—´ã€æ—¥æœŸ"><a href="#æ—¶é—´ã€æ—¥æœŸ" class="headerlink" title="æ—¶é—´ã€æ—¥æœŸ"></a>æ—¶é—´ã€æ—¥æœŸ</h3><h4 id="timeå‡½æ•°"><a href="#timeå‡½æ•°" class="headerlink" title="timeå‡½æ•°"></a>timeå‡½æ•°</h4><p>ç³»ç»Ÿè°ƒç”¨time()ç”¨äºè·å–å½“å‰æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œè¿”å›å€¼æ˜¯è‡ª 1970-01-01 00:00:00 +0000 (UTC)ä»¥æ¥çš„ç§’æ•°ï¼ŒåŸå‹å¯é€šè¿‡man2 timeæŸ¥çœ‹</p><p>tlocï¼šå¦‚æœ tloc å‚æ•°ä¸æ˜¯ NULLï¼Œåˆ™è¿”å›å€¼ä¹Ÿå­˜å‚¨åœ¨ tloc æŒ‡å‘çš„å†…å­˜ä¸­ã€‚</p><p>è¿”å›å€¼ï¼šæˆåŠŸåˆ™è¿”å›è‡ª 1970-01-01 00:00:00 +0000 (UTC)ä»¥æ¥çš„æ—¶é—´å€¼ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼›å¤±è´¥åˆ™è¿”å›-1ï¼Œ<br>å¹¶ä¼šè®¾ç½® errnoã€‚</p><p>time å‡½æ•°è·å–å¾—åˆ°çš„æ˜¯ä¸€ä¸ªæ—¶é—´æ®µï¼Œä¹Ÿå°±æ˜¯ä» 1970-01-01 00:00:00 +0000 (UTC)åˆ°ç°åœ¨è¿™æ®µæ—¶é—´æ‰€ç»è¿‡çš„ç§’æ•°ï¼ŒæŠŠè¿™ä¸ªç§°ä¹‹ä¸ºæ—¥å†æ—¶é—´æˆ– time_t æ—¶é—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">time_t</span> t;</span><br><span class="line"> t = time(<span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == t) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;time error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ—¶é—´å€¼: %ld\n&quot;</span>, t);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="gettimeofdayå‡½æ•°"><a href="#gettimeofdayå‡½æ•°" class="headerlink" title="gettimeofdayå‡½æ•°"></a>gettimeofdayå‡½æ•°</h4><p>gettimeofday()å‡½æ•°æä¾›å¾®ç§’çº§æ—¶é—´ç²¾åº¦ã€‚åŸå‹å¯é€šè¿‡man 2 gettimeofdayæŸ¥çœ‹</p><p>tvï¼šå‚æ•° tv æ˜¯ä¸€ä¸ª struct timeval ç»“æ„ä½“æŒ‡é’ˆå˜é‡ï¼Œstruct timeval ç»“æ„ä½“åœ¨å‰é¢ç« èŠ‚å†…å®¹ä¸­å·²ç»ç»™å¤§å®¶ä»‹ç»è¿‡ï¼Œå…·ä½“å‚è€ƒç¤ºä¾‹ä»£ç  5.6.3ã€‚<br>tzï¼šå‚æ•° tz æ˜¯ä¸ªå†å²äº§ç‰©ï¼Œæ—©æœŸå®ç°ç”¨å…¶æ¥è·å–ç³»ç»Ÿçš„æ—¶åŒºä¿¡æ¯ï¼Œç›®å‰å·²é­åºŸå¼ƒï¼Œåœ¨è°ƒç”¨ gettimeofday()å‡½æ•°æ—¶åº”å°†å‚æ•° tz è®¾ç½®ä¸º NULLã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tval</span>;</span></span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> ret = gettimeofday(&amp;tval, <span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;gettimeofday error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ—¶é—´å€¼: %ld ç§’+%ld å¾®ç§’\n&quot;</span>, tval.tv_sec, tval.tv_usec);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ—¶é—´è½¬æ¢å‡½æ•°"><a href="#æ—¶é—´è½¬æ¢å‡½æ•°" class="headerlink" title="æ—¶é—´è½¬æ¢å‡½æ•°"></a>æ—¶é—´è½¬æ¢å‡½æ•°</h4><p><strong>ctimeå‡½æ•°</strong></p><p>ctimeå¯ä»¥å°†æ—¥å†æ—¶é—´è½¬æ¢ä¸ºå¯æ‰“å°è¾“å‡ºçš„å­—ç¬¦ä¸²å½¢å¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">ctime</span><span class="params">(<span class="type">const</span> <span class="type">time_t</span> *timep)</span>;</span><br><span class="line"><span class="type">char</span> *<span class="title function_">ctime_r</span><span class="params">(<span class="type">const</span> <span class="type">time_t</span> *timep, <span class="type">char</span> *buf)</span>;</span><br></pre></td></tr></table></figure><p>timepï¼štime_t æ—¶é—´å˜é‡æŒ‡é’ˆã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸå°†è¿”å›ä¸€ä¸ª char *ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘è½¬æ¢åå¾—åˆ°çš„å­—ç¬¦ä¸²ï¼›å¤±è´¥å°†è¿”å› NULLã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> tm_str[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="type">time_t</span> tm;</span><br><span class="line"> <span class="comment">/* è·å–æ—¶é—´ */</span></span><br><span class="line"> tm = time(<span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == tm) </span><br><span class="line">    &#123;</span><br><span class="line"> perror(<span class="string">&quot;time error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å°†æ—¶é—´è½¬æ¢ä¸ºå­—ç¬¦ä¸²å½¢å¼ */</span></span><br><span class="line"> ctime_r(&amp;tm, tm_str);</span><br><span class="line"><span class="comment">/* æ‰“å°è¾“å‡º */</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;å½“å‰æ—¶é—´: %s&quot;</span>, tm_str);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>localtimeå‡½æ•°</strong></p><p>localtime()å‡½æ•°å¯ä»¥æŠŠ time()æˆ– gettimeofday()å¾—åˆ°çš„ç§’æ•°ï¼ˆtime_t æ—¶é—´æˆ–æ—¥å†æ—¶é—´ï¼‰å˜æˆä¸€ä¸ª struct tm<br>ç»“æ„ä½“æ‰€è¡¨ç¤ºçš„æ—¶é—´ï¼Œè¯¥æ—¶é—´å¯¹åº”çš„æ˜¯æœ¬åœ°æ—¶é—´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span> tm *<span class="title function_">localtime</span><span class="params">(<span class="type">const</span> <span class="type">time_t</span> *timep)</span>;</span><br><span class="line"><span class="keyword">struct</span> tm *<span class="title function_">localtime_r</span><span class="params">(<span class="type">const</span> <span class="type">time_t</span> *timep, <span class="keyword">struct</span> tm *result)</span>;</span><br></pre></td></tr></table></figure><p>timepï¼šéœ€è¦è¿›è¡Œè½¬æ¢çš„ time_t æ—¶é—´å˜é‡å¯¹åº”çš„æŒ‡é’ˆï¼Œå¯é€šè¿‡ time()æˆ– gettimeofday()è·å–å¾—åˆ°ã€‚<br>resultï¼šæ˜¯ä¸€ä¸ª struct tm ç»“æ„ä½“ç±»å‹æŒ‡é’ˆï¼Œç¨åç»™å¤§å®¶ä»‹ç» struct tm ç»“æ„ä½“ï¼Œå‚æ•° result æ˜¯å¯é‡å…¥å‡½æ•°<br>localtime_r()éœ€è¦é¢å¤–æä¾›çš„å‚æ•°ã€‚<br>è¿”å›å€¼ï¼šå¯¹äºä¸å¯é‡å…¥ç‰ˆæœ¬ localtime()æ¥è¯´ï¼ŒæˆåŠŸåˆ™è¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„ struct tm ç»“æ„ä½“æŒ‡é’ˆï¼Œè€Œå¯¹äºå¯é‡å…¥ç‰ˆæœ¬ localtime_r()æ¥è¯´ï¼ŒæˆåŠŸæ‰§è¡Œæƒ…å†µä¸‹ï¼Œè¿”å›å€¼å°†ä¼šç­‰äºå‚æ•°resultï¼›å¤±è´¥åˆ™è¿”å› NULLã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tm</span> &#123;</span></span><br><span class="line"> <span class="type">int</span> tm_sec; <span class="comment">/* ç§’(0-60) */</span></span><br><span class="line"> <span class="type">int</span> tm_min; <span class="comment">/* åˆ†(0-59) */</span></span><br><span class="line"> <span class="type">int</span> tm_hour; <span class="comment">/* æ—¶(0-23) */</span></span><br><span class="line"> <span class="type">int</span> tm_mday; <span class="comment">/* æ—¥(1-31) */</span></span><br><span class="line"> <span class="type">int</span> tm_mon; <span class="comment">/* æœˆ(0-11) */</span></span><br><span class="line"> <span class="type">int</span> tm_year; <span class="comment">/* å¹´(è¿™ä¸ªå€¼è¡¨ç¤ºçš„æ˜¯è‡ª 1900 å¹´åˆ°ç°åœ¨ç»è¿‡çš„å¹´æ•°) */</span></span><br><span class="line"> <span class="type">int</span> tm_wday; <span class="comment">/* æ˜ŸæœŸ(0-6, æ˜ŸæœŸæ—¥ Sunday = 0ã€æ˜ŸæœŸä¸€=1â€¦) */</span></span><br><span class="line"> <span class="type">int</span> tm_yday; <span class="comment">/* ä¸€å¹´é‡Œçš„ç¬¬å‡ å¤©(0-365, 1 Jan = 0) */</span></span><br><span class="line"> <span class="type">int</span> tm_isdst; <span class="comment">/* å¤ä»¤æ—¶ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> <span class="title">t</span>;</span></span><br><span class="line"> <span class="type">time_t</span> sec;</span><br><span class="line"> <span class="comment">/* è·å–æ—¶é—´ */</span></span><br><span class="line"> sec = time(<span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == sec) &#123;</span><br><span class="line"> perror(<span class="string">&quot;time error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* è½¬æ¢å¾—åˆ°æœ¬åœ°æ—¶é—´ */</span></span><br><span class="line"> localtime_r(&amp;sec, &amp;t);</span><br><span class="line"> <span class="comment">/* æ‰“å°è¾“å‡º */</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;å½“å‰æ—¶é—´: %d å¹´%d æœˆ%d æ—¥ %d:%d:%d\n&quot;</span>,</span><br><span class="line"> t.tm_year + <span class="number">1900</span>, t.tm_mon, t.tm_mday,</span><br><span class="line"> t.tm_hour, t.tm_min, t.tm_sec);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>gmtime()å‡½æ•°</strong>æŠŠtime_tæ—¶é—´å˜ä¸ºstruct tmç»“æ„ä½“æ‰€è¡¨ç¤ºçš„æ—¶é—´ï¼Œå¾—åˆ°çš„æ˜¯UTCå›½é™…æ ‡å‡†æ—¶é—´ï¼Œä¸æ˜¯æœ¬åœ°æ—¶é—´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> </span></span><br><span class="line"><span class="keyword">struct</span> tm *<span class="title function_">gmtime</span><span class="params">(<span class="type">const</span> <span class="type">time_t</span> *timep)</span>;</span><br><span class="line"><span class="keyword">struct</span> tm *<span class="title function_">gmtime_r</span><span class="params">(<span class="type">const</span> <span class="type">time_t</span> *timep, <span class="keyword">struct</span> tm *result)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> <span class="title">local_t</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> <span class="title">utc_t</span>;</span></span><br><span class="line"> <span class="type">time_t</span> sec;</span><br><span class="line"> <span class="comment">/* è·å–æ—¶é—´ */</span></span><br><span class="line"> sec = time(<span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == sec) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;time error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* è½¬æ¢å¾—åˆ°æœ¬åœ°æ—¶é—´ */</span></span><br><span class="line"> localtime_r(&amp;sec, &amp;<span class="type">local_t</span>);</span><br><span class="line"> <span class="comment">/* è½¬æ¢å¾—åˆ°å›½é™…æ ‡å‡†æ—¶é—´ */</span></span><br><span class="line"> gmtime_r(&amp;sec, &amp;<span class="type">utc_t</span>);</span><br><span class="line"> <span class="comment">/* æ‰“å°è¾“å‡º */</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æœ¬åœ°æ—¶é—´: %d å¹´%d æœˆ%d æ—¥ %d:%d:%d\n&quot;</span>,</span><br><span class="line"> <span class="type">local_t</span>.tm_year + <span class="number">1900</span>, <span class="type">local_t</span>.tm_mon, <span class="type">local_t</span>.tm_mday,</span><br><span class="line"> <span class="type">local_t</span>.tm_hour, <span class="type">local_t</span>.tm_min, <span class="type">local_t</span>.tm_sec);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;UTC æ—¶é—´: %d å¹´%d æœˆ%d æ—¥ %d:%d:%d\n&quot;</span>,</span><br><span class="line"> <span class="type">utc_t</span>.tm_year + <span class="number">1900</span>, <span class="type">utc_t</span>.tm_mon, <span class="type">utc_t</span>.tm_mday,</span><br><span class="line"> <span class="type">utc_t</span>.tm_hour, <span class="type">utc_t</span>.tm_min, <span class="type">utc_t</span>.tm_sec);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>mktimeå‡½æ•°</strong>å¯ä»¥å°†ä½¿ç”¨ struct tm ç»“æ„ä½“è¡¨ç¤ºçš„åˆ†è§£æ—¶é—´è½¬æ¢ä¸º time_tæ—¶é—´ï¼ˆæ—¥å†æ—¶é—´ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">time_t</span> <span class="title function_">mktime</span><span class="params">(<span class="keyword">struct</span> tm *tm)</span>;</span><br></pre></td></tr></table></figure><p>tmï¼šéœ€è¦è¿›è¡Œè½¬æ¢çš„ struct tm ç»“æ„ä½“å˜é‡å¯¹åº”çš„æŒ‡é’ˆã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›è½¬æ¢å¾—åˆ° time_t æ—¶é—´å€¼ï¼›å¤±è´¥è¿”å›-1ã€‚</p><p><strong>asctimeå‡½æ•°</strong>ä¸ ctime()å‡½æ•°çš„ä½œç”¨ä¸€æ ·ï¼Œä¹Ÿå¯å°†æ—¶é—´è½¬æ¢ä¸ºå¯æ‰“å°è¾“å‡ºçš„å­—ç¬¦ä¸²å½¢å¼ï¼Œä¸ ctime()å‡½æ•°<br>çš„åŒºåˆ«åœ¨äºï¼Œctime()æ˜¯å°† time_t æ—¶é—´è½¬æ¢ä¸ºå›ºå®šæ ¼å¼å­—ç¬¦ä¸²ã€è€Œ asctime()åˆ™æ˜¯å°† struct tm è¡¨ç¤ºçš„åˆ†è§£æ—¶é—´è½¬æ¢ä¸ºå›ºå®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">asctime</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> tm *tm)</span>;</span><br><span class="line"><span class="type">char</span> *<span class="title function_">asctime_r</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> tm *tm, <span class="type">char</span> *buf)</span>;</span><br></pre></td></tr></table></figure><p>tmï¼šéœ€è¦è¿›è¡Œè½¬æ¢çš„ struct tm è¡¨ç¤ºçš„æ—¶é—´ã€‚<br>bufï¼šå¯é‡å…¥ç‰ˆæœ¬å‡½æ•° asctime_r éœ€è¦é¢å¤–æä¾›çš„å‚æ•° bufï¼ŒæŒ‡å‘ä¸€ä¸ªç¼“å†²åŒºï¼Œç”¨äºå­˜æ”¾è½¬æ¢å¾—åˆ°çš„å­—ç¬¦ä¸²ã€‚<br>è¿”å›å€¼ï¼šè½¬æ¢å¤±è´¥å°†è¿”å› NULLï¼›æˆåŠŸå°†è¿”å›ä¸€ä¸ª char *ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘è½¬æ¢åå¾—åˆ°çš„æ—¶é—´å­—ç¬¦ä¸²ï¼Œå¯¹asctime_r å‡½æ•°æ¥è¯´ï¼Œè¿”å›å€¼å°±ç­‰äºå‚æ•° bufã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> <span class="title">local_t</span>;</span></span><br><span class="line"> <span class="type">char</span> tm_str[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="type">time_t</span> sec;</span><br><span class="line"> <span class="comment">/* è·å–æ—¶é—´ */</span></span><br><span class="line"> sec = time(<span class="literal">NULL</span>);</span><br><span class="line"> <span class="keyword">if</span> (sec == <span class="number">-1</span>) </span><br><span class="line"> &#123;</span><br><span class="line">perror(<span class="string">&quot;time error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> localtime_r(&amp;sec, &amp;<span class="type">local_t</span>);</span><br><span class="line"> asctime_r(&amp;<span class="type">local_t</span>, tm_str);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æœ¬åœ°æ—¶é—´: %s&quot;</span>, tm_str);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>strftime å‡½æ•°</strong>å¯ä»¥è‡ªå®šä¹‰æ—¶é—´æ˜¾ç¤ºæ ¼å¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">strftime</span><span class="params">(<span class="type">char</span> *s, <span class="type">size_t</span> max, <span class="type">const</span> <span class="type">char</span> *format, <span class="type">const</span> <span class="keyword">struct</span> tm *tm)</span>;</span><br></pre></td></tr></table></figure><p>sï¼šæŒ‡å‘ä¸€ä¸ªç¼“å­˜åŒºçš„æŒ‡é’ˆï¼Œè¯¥ç¼“å†²åŒºç”¨äºå­˜æ”¾ç”Ÿæˆçš„å­—ç¬¦ä¸²ã€‚<br>maxï¼šå­—ç¬¦ä¸²çš„æœ€å¤§å­—èŠ‚æ•°ã€‚<br>formatï¼šè¿™æ˜¯ä¸€ä¸ªç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„å­—æ®µï¼ŒåŒ…å«äº†æ™®é€šå­—ç¬¦å’Œç‰¹æ®Šæ ¼å¼è¯´æ˜ç¬¦ï¼Œå¯ä»¥æ˜¯è¿™ä¸¤ç§å­—ç¬¦çš„ä»»æ„<br>ç»„åˆã€‚ç‰¹æ®Šæ ¼å¼è¯´æ˜ç¬¦å°†ä¼šè¢«æ›¿æ¢ä¸º struct tm ç»“æ„ä½“å¯¹è±¡æ‰€æŒ‡æ—¶é—´çš„ç›¸åº”å€¼ã€‚</p><p>ç‰¹æ®Šæ ¼å¼å¯ç”¨å‘½ä»¤man strftimeæŸ¥è¯¢ã€‚</p><p><strong>è®¾ç½®æ—¶é—´ settimeofday</strong></p><p>ä½¿ç”¨ settimeofday()å‡½æ•°å¯ä»¥è®¾ç½®æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®ç³»ç»Ÿçš„æœ¬åœ°æ—¶é—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">settimeofday</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> timeval *tv, <span class="type">const</span> <span class="keyword">struct</span> timezone *tz)</span>;</span><br></pre></td></tr></table></figure><p>tvï¼šå‚æ•° tv æ˜¯ä¸€ä¸ª struct timeval ç»“æ„ä½“æŒ‡é’ˆå˜é‡ï¼Œstruct timeval ç»“æ„ä½“åœ¨å‰é¢ç« èŠ‚å†…å®¹ä¸­å·²ç»ç»™å¤§å®¶ä»‹ç»äº†ï¼Œéœ€è¦è®¾ç½®çš„æ—¶é—´ä¾¿é€šè¿‡å‚æ•° tv æŒ‡å‘çš„ struct timeval ç»“æ„ä½“å˜é‡ä¼ é€’è¿›å»ã€‚<br>tzï¼šå‚æ•° tz æ˜¯ä¸ªå†å²äº§ç‰©ï¼Œæ—©æœŸå®ç°ç”¨å…¶æ¥è®¾ç½®ç³»ç»Ÿçš„æ—¶åŒºä¿¡æ¯ï¼Œç›®å‰å·²é­åºŸå¼ƒï¼Œåœ¨è°ƒç”¨ settimeofday()å‡½æ•°æ—¶åº”å°†å‚æ•° tz è®¾ç½®ä¸º NULLã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p>ä½¿ç”¨ settimeofday è®¾ç½®ç³»ç»Ÿæ—¶é—´æ—¶å†…æ ¸ä¼šè¿›è¡Œæƒé™æ£€æŸ¥ï¼Œåªæœ‰è¶…çº§ç”¨æˆ·ï¼ˆrootï¼‰æ‰å¯ä»¥è®¾ç½®ç³»ç»Ÿæ—¶é—´ï¼Œæ™®é€šç”¨æˆ·å°†æ— æ“ä½œæƒé™ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20221211_135113.png"></p><h3 id="è¿›ç¨‹æ—¶é—´"><a href="#è¿›ç¨‹æ—¶é—´" class="headerlink" title="è¿›ç¨‹æ—¶é—´"></a>è¿›ç¨‹æ—¶é—´</h3><p>è¿›ç¨‹æ—¶é—´æŒ‡çš„æ˜¯è¿›ç¨‹ä»åˆ›å»ºåï¼ˆä¹Ÿå°±æ˜¯ç¨‹åºè¿è¡Œåï¼‰åˆ°ç›®å‰ä¸ºæ­¢è¿™æ®µæ—¶é—´å†…ä½¿ç”¨ CPU èµ„æºçš„æ—¶é—´æ€»æ•°ï¼Œå‡ºäºè®°å½•çš„ç›®çš„ï¼Œå†…æ ¸æŠŠ CPU æ—¶é—´ï¼ˆè¿›ç¨‹æ—¶é—´ï¼‰åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ï¼š<br>âš« ç”¨æˆ· CPU æ—¶é—´ï¼šè¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´ï¼ˆç”¨æˆ·æ€ï¼‰ä¸‹è¿è¡Œæ‰€èŠ±è´¹çš„ CPU æ—¶é—´ã€‚æœ‰æ—¶ä¹Ÿæˆä¸ºè™šæ‹Ÿæ—¶é—´ï¼ˆvirtual timeï¼‰ã€‚<br>âš« ç³»ç»Ÿ CPU æ—¶é—´ï¼šè¿›ç¨‹åœ¨å†…æ ¸ç©ºé—´ï¼ˆå†…æ ¸æ€ï¼‰ä¸‹è¿è¡Œæ‰€èŠ±è´¹çš„ CPU æ—¶é—´ã€‚è¿™æ˜¯å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–ä»£è¡¨è¿›ç¨‹æ‰§è¡Œçš„å…¶å®ƒä»»åŠ¡ï¼ˆè­¬å¦‚ï¼ŒæœåŠ¡é¡µé”™è¯¯ï¼‰æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚<br>ä¸€èˆ¬æ¥è¯´ï¼Œè¿›ç¨‹æ—¶é—´æŒ‡çš„æ˜¯ç”¨æˆ· CPU æ—¶é—´å’Œç³»ç»Ÿ CPU æ—¶é—´çš„æ€»å’Œï¼Œä¹Ÿå°±æ˜¯æ€»çš„ CPU æ—¶é—´ã€‚</p><h4 id="timeså‡½æ•°"><a href="#timeså‡½æ•°" class="headerlink" title="timeså‡½æ•°"></a>timeså‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/times.h&gt;</span></span></span><br><span class="line"><span class="type">clock_t</span> <span class="title function_">times</span><span class="params">(<span class="keyword">struct</span> tms *buf)</span>;</span><br></pre></td></tr></table></figure><p>bufï¼štimes()ä¼šå°†å½“å‰è¿›ç¨‹æ—¶é—´ä¿¡æ¯å­˜åœ¨ä¸€ä¸ª struct tms ç»“æ„ä½“æ•°æ®ä¸­</p><p>è¿”å›å€¼ï¼šè¿”å›å€¼ç±»å‹ä¸º clock_tï¼ˆå®è´¨æ˜¯ long ç±»å‹ï¼‰ï¼Œè°ƒç”¨æˆåŠŸæƒ…å†µä¸‹ï¼Œå°†è¿”å›ä»è¿‡å»ä»»æ„çš„ä¸€ä¸ªæ—¶é—´ç‚¹ï¼ˆè­¬å¦‚ç³»ç»Ÿå¯åŠ¨æ—¶é—´ï¼‰æ‰€ç»è¿‡çš„æ—¶é’Ÿæ»´ç­”æ•°ï¼ˆå…¶å®å°±æ˜¯ç³»ç»ŸèŠ‚æ‹æ•°ï¼‰ï¼Œå°†(èŠ‚æ‹æ•° &#x2F; èŠ‚æ‹ç‡)ä¾¿å¯å¾—åˆ°ç§’æ•°ï¼Œè¿”å›å€¼å¯èƒ½ä¼šè¶…è¿‡ clock_t æ‰€èƒ½è¡¨ç¤ºçš„èŒƒå›´ï¼ˆæº¢å‡ºï¼‰ï¼›è°ƒç”¨å¤±è´¥è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tms</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="type">clock_t</span> tms_utime; <span class="comment">/* user time, è¿›ç¨‹çš„ç”¨æˆ· CPU æ—¶é—´, tms_utime ä¸ªç³»ç»ŸèŠ‚æ‹æ•° */</span></span><br><span class="line"> <span class="type">clock_t</span> tms_stime; <span class="comment">/* system time, è¿›ç¨‹çš„ç³»ç»Ÿ CPU æ—¶é—´, tms_stime ä¸ªç³»ç»ŸèŠ‚æ‹æ•° */</span></span><br><span class="line"> <span class="type">clock_t</span> tms_cutime; <span class="comment">/* user time of children, å·²æ­»æ‰å­è¿›ç¨‹çš„ tms_utime + tms_cutime æ—¶é—´æ€»å’Œ */</span></span><br><span class="line"> <span class="type">clock_t</span> tms_cstime; <span class="comment">/* system time of children, å·²æ­»æ‰å­è¿›ç¨‹çš„ tms_stime + tms_cstime æ—¶é—´æ€»å’Œ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="clockå‡½æ•°"><a href="#clockå‡½æ•°" class="headerlink" title="clockå‡½æ•°"></a>clockå‡½æ•°</h4><p>åº“å‡½æ•° clock()æä¾›äº†ä¸€ä¸ªæ›´ä¸ºç®€å•çš„æ–¹å¼ç”¨äºè¿›ç¨‹æ—¶é—´ï¼Œå®ƒçš„è¿”å›å€¼æè¿°äº†è¿›ç¨‹ä½¿ç”¨çš„æ€»çš„ CPU æ—¶é—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">clock_t</span> <span class="title function_">clock</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>æ— å‚æ•°ã€‚<br>è¿”å›å€¼ï¼šè¿”å›å€¼æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ç¨‹åºçš„è¿›ç¨‹æ—¶é—´ï¼Œä¸º clock_t ç±»å‹ï¼Œæ³¨æ„ clock()çš„è¿”å›å€¼å¹¶ä¸æ˜¯ç³»ç»ŸèŠ‚æ‹æ•°ï¼Œå¦‚æœæƒ³è¦è·å¾—ç§’æ•°ï¼Œè¯·é™¤ä»¥ CLOCKS_PER_SECï¼ˆè¿™æ˜¯ä¸€ä¸ªå®ï¼‰ã€‚å¦‚æœè¿”å›çš„è¿›ç¨‹æ—¶é—´ä¸å¯ç”¨æˆ–å…¶å€¼æ— æ³•è¡¨ç¤ºï¼Œåˆ™è¯¥è¿”å›å€¼æ˜¯-1ã€‚<br>clock()å‡½æ•°è™½ç„¶å¯ä»¥å¾ˆæ–¹ä¾¿çš„è·å–æ€»çš„è¿›ç¨‹æ—¶é—´ï¼Œä½†å¹¶ä¸èƒ½è·å–åˆ°å•ç‹¬çš„ç”¨æˆ· CPU æ—¶é—´å’Œç³»ç»Ÿ CPU æ—¶é—´ï¼Œåœ¨å®é™…ç¼–ç¨‹å½“ä¸­ï¼Œæ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©ã€‚</p><h4 id="äº§ç”Ÿéšæœºæ•°"><a href="#äº§ç”Ÿéšæœºæ•°" class="headerlink" title="äº§ç”Ÿéšæœºæ•°"></a>äº§ç”Ÿéšæœºæ•°</h4><p>rand()å‡½æ•°ç”¨äºè·å–éšæœºæ•°ã€‚ï¼ˆæ˜¯ä¸€ç§ä¼ªéšæœºæ•°ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">rand</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªä»‹äº 0 åˆ° RAND_MAXï¼ˆåŒ…å«ï¼‰ä¹‹é—´çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ•°å­¦ä¸Šçš„[0, RAND_MAX]ã€‚ç¨‹åº¦å½“ä¸­è°ƒç”¨ rand()å¯ä»¥å¾—åˆ°[0, RAND_MAX]ä¹‹é—´çš„ä¼ªéšæœºæ•°ï¼Œå¤šæ¬¡è°ƒç”¨ rand()ä¾¿å¯ä»¥ç”Ÿæˆä¸€ç»„ä¼ªéšæœºæ ‘åºåˆ—ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ¯ä¸€æ¬¡è¿è¡Œç¨‹åºæ‰€å¾—åˆ°çš„éšæœºæ•°åºåˆ—éƒ½æ˜¯ç›¸åŒçš„ï¼Œé‚£å¦‚ä½•ä½¿å¾—æ¯ä¸€æ¬¡å¯åŠ¨åº”ç”¨ç¨‹åºæ‰€å¾—åˆ°çš„éšæœºæ•°åºåˆ—æ˜¯ä¸ä¸€æ ·çš„å‘¢ï¼Ÿé‚£å°±é€šè¿‡è®¾ç½®ä¸åŒçš„éšæœºæ•°ç§å­ï¼Œå¯é€šè¿‡ srand()è®¾ç½®éšæœºæ•°ç§å­ã€‚<br>å¦‚æœæ²¡æœ‰è°ƒç”¨ srand()è®¾ç½®éšæœºæ•°ç§å­çš„æƒ…å†µä¸‹ï¼Œrand()ä¼šå°† 1 ä½œä¸ºéšæœºæ•°ç§å­ï¼Œå¦‚æœéšæœºæ•°ç§å­ç›¸åŒï¼Œé‚£ä¹ˆæ¯ä¸€æ¬¡å¯åŠ¨åº”ç”¨ç¨‹åºæ‰€å¾—åˆ°çš„éšæœºæ•°åºåˆ—å°±æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æ¯æ¬¡å¯åŠ¨åº”ç”¨ç¨‹åºéœ€è¦è®¾ç½®ä¸åŒçš„éšæœºæ•°ç§å­ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿å¾—ç¨‹åºæ¯æ¬¡è¿è¡Œæ‰€å¾—åˆ°éšæœºæ•°åºåˆ—ä¸åŒã€‚</p><p><strong>srand å‡½æ•°</strong></p><p>ä½¿ç”¨ srand()å‡½æ•°ä¸º rand()è®¾ç½®éšæœºæ•°ç§å­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">srand</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> seed)</span>;</span><br></pre></td></tr></table></figure><p>seedï¼šæŒ‡å®šä¸€ä¸ªéšæœºæ•°ä¸­ï¼Œint ç±»å‹çš„æ•°æ®ï¼Œä¸€èˆ¬å°å°å°†å½“å‰æ—¶é—´ä½œä¸ºéšæœºæ•°ç§å­èµ‹å€¼ç»™å‚æ•° seedï¼Œè­¬å¦‚ time(NULL)ï¼Œå› ä¸ºæ¯æ¬¡å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶é—´ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å°±èƒ½å¤Ÿä½¿å¾—ç¨‹åºä¸­è®¾ç½®çš„éšæœºæ•°ç§å­åœ¨æ¯æ¬¡å¯åŠ¨ç¨‹åºæ—¶æ˜¯ä¸ä¸€æ ·çš„ã€‚<br>è¿”å›å€¼ï¼švoid<br>å¸¸ç”¨çš„ç”¨æ³• srand(time(NULL))</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> random_number_arr[<span class="number">8</span>];</span><br><span class="line"> <span class="type">int</span> count;</span><br><span class="line"> <span class="comment">/* è®¾ç½®éšæœºæ•°ç§å­ */</span></span><br><span class="line"> srand(time(<span class="literal">NULL</span>));</span><br><span class="line"> <span class="comment">/* ç”Ÿæˆä¼ªéšæœºæ•° */</span></span><br><span class="line"> <span class="keyword">for</span> (count = <span class="number">0</span>; count &lt; <span class="number">8</span>; count++)</span><br><span class="line"> random_number_arr[count] = rand() % <span class="number">100</span>;</span><br><span class="line"> <span class="comment">/* æ‰“å°éšæœºæ•°æ•°ç»„ */</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;[&quot;</span>);</span><br><span class="line"> <span class="keyword">for</span> (count = <span class="number">0</span>; count &lt; <span class="number">8</span>; count++) </span><br><span class="line">    &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, random_number_arr[count]);</span><br><span class="line"> <span class="keyword">if</span> (count != <span class="number">8</span> - <span class="number">1</span>)</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;]\n&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¼‘çœ "><a href="#ä¼‘çœ " class="headerlink" title="ä¼‘çœ "></a>ä¼‘çœ </h3><p>æœ‰æ—¶éœ€è¦å°†è¿›ç¨‹æš‚åœæˆ–ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œè¿›å…¥ä¼‘çœ çŠ¶æ€ä¹‹åï¼Œç¨‹åºå°†æš‚åœè¿è¡Œï¼Œç›´åˆ°ä¼‘çœ ç»“æŸã€‚å¸¸ç”¨çš„ç³»ç»Ÿè°ƒç”¨å’Œ C åº“å‡½æ•°æœ‰ sleep()ã€usleep()ä»¥åŠ nanosleep()ï¼Œè¿™äº›å‡½æ•°åœ¨åº”ç”¨ç¨‹åºå½“ä¸­é€šå¸¸ä½œä¸ºå»¶æ—¶ä½¿ç”¨ã€‚</p><p><strong>ç§’çº§ä¼‘çœ sleep</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">sleep</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> seconds)</span>;</span><br></pre></td></tr></table></figure><p>secondsï¼šä¼‘çœ æ—¶é•¿ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚<br>è¿”å›å€¼ï¼šå¦‚æœä¼‘çœ æ—¶é•¿ä¸ºå‚æ•° seconds æ‰€æŒ‡å®šçš„ç§’æ•°ï¼Œåˆ™è¿”å› 0ï¼›è‹¥è¢«ä¿¡å·ä¸­æ–­åˆ™è¿”å›å‰©ä½™çš„ç§’æ•°ã€‚<br>sleep()æ˜¯ä¸€ä¸ªç§’çº§åˆ«ä¼‘çœ å‡½æ•°ï¼Œç¨‹åºåœ¨ä¼‘çœ è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¯ä»¥è¢«å…¶å®ƒä¿¡å·æ‰€æ‰“æ–­çš„ã€‚</p><p>å¾®ç§’ä¼‘çœ usleep</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">usleep</span><span class="params">(<span class="type">useconds_t</span> usec)</span>;</span><br></pre></td></tr></table></figure><p>é«˜ç²¾åº¦ä¼‘çœ nanosleep</p><p>nanosleep()ä¸ sleep()ä»¥åŠ usleep()ç±»ä¼¼ï¼Œéƒ½ç”¨äºç¨‹åºä¼‘çœ ï¼Œä½† nanosleep()å…·æœ‰æ›´é«˜ç²¾åº¦æ¥è®¾ç½®ä¼‘çœ æ—¶é—´é•¿åº¦ï¼Œæ”¯æŒçº³ç§’çº§æ—¶é•¿è®¾ç½®ã€‚ä¸ sleep()ã€usleep()ä¸åŒçš„æ˜¯ï¼Œnanosleep()æ˜¯ä¸€ä¸ª Linux ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>reqï¼šä¸€ä¸ª struct timespec ç»“æ„ä½“æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª struct timespec å˜é‡ï¼Œç”¨äºè®¾ç½®ä¼‘çœ æ—¶é—´é•¿åº¦ï¼Œå¯ç²¾ç¡®åˆ°çº³ç§’çº§åˆ«ã€‚<br>remï¼šä¹Ÿæ˜¯ä¸€ä¸ª struct timespec ç»“æ„ä½“æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª struct timespec å˜é‡ï¼Œä¹Ÿå¯è®¾ç½® NULLã€‚<br>è¿”å›å€¼ï¼šåœ¨æˆåŠŸä¼‘çœ è¾¾åˆ°è¯·æ±‚çš„æ—¶é—´é—´éš”åï¼Œnanosleep()è¿”å› 0ï¼›å¦‚æœä¸­é€”è¢«ä¿¡å·ä¸­æ–­æˆ–é‡åˆ°é”™è¯¯ï¼Œåˆ™è¿”å›-1ï¼Œå¹¶å°†å‰©ä½™æ—¶é—´è®°å½•åœ¨å‚æ•° rem æŒ‡å‘çš„ struct timespec ç»“æ„ä½“å˜é‡ä¸­ï¼ˆå‚æ•° rem ä¸ä¸º NULL çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸º NULL è¡¨ç¤ºä¸æ¥æ”¶å‰©ä½™æ—¶é—´ï¼‰ï¼Œè¿˜ä¼šè®¾ç½® errno æ ‡è¯†é”™è¯¯ç±»å‹ã€‚</p><h3 id="ç”³è¯·å †å†…å­˜"><a href="#ç”³è¯·å †å†…å­˜" class="headerlink" title="ç”³è¯·å †å†…å­˜"></a>ç”³è¯·å †å†…å­˜</h3><p>åœ¨æ“ä½œç³»ç»Ÿä¸‹ï¼Œå†…å­˜èµ„æºæ˜¯ç”±æ“ä½œç³»ç»Ÿè¿›è¡Œç®¡ç†ã€åˆ†é…çš„ï¼Œå½“åº”ç”¨ç¨‹åºæƒ³è¦å†…å­˜æ—¶ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯å †å†…å­˜ï¼‰ï¼Œå¯ä»¥å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶åä½¿ç”¨å†…å­˜ï¼›å½“ä¸å†éœ€è¦æ—¶ï¼Œå°†ç”³è¯·çš„å†…å­˜é‡Šæ”¾ã€å½’è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</p><h4 id="å †ä¸Šåˆ†é…å†…å­˜ï¼šmallocå’Œfree"><a href="#å †ä¸Šåˆ†é…å†…å­˜ï¼šmallocå’Œfree" class="headerlink" title="å †ä¸Šåˆ†é…å†…å­˜ï¼šmallocå’Œfree"></a>å †ä¸Šåˆ†é…å†…å­˜ï¼šmallocå’Œfree</h4><p><strong>malloc</strong>ä¸ºç¨‹åºåˆ†é…ä¸€æ®µå †å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">malloc</span><span class="params">(<span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><p>sizeï¼šéœ€è¦åˆ†é…çš„å†…å­˜å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</p><p>è¿”å›å€¼ï¼šè¿”å›å€¼ä¸º void *ç±»å‹ï¼Œå¦‚æœç”³è¯·åˆ†é…å†…å­˜æˆåŠŸï¼Œå°†è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥æ®µå†…å­˜çš„æŒ‡é’ˆï¼Œvoid *å¹¶ä¸æ˜¯è¯´æ²¡æœ‰è¿”å›å€¼æˆ–è€…è¿”å›ç©ºæŒ‡é’ˆï¼Œè€Œæ˜¯è¿”å›çš„æŒ‡é’ˆç±»å‹æœªçŸ¥,æ‰€ä»¥åœ¨è°ƒç”¨ malloc()æ—¶é€šå¸¸éœ€è¦è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå°† void *æŒ‡é’ˆç±»å‹è½¬æ¢æˆæˆ‘ä»¬å¸Œæœ›çš„ç±»å‹ï¼›å¦‚æœåˆ†é…å†…å­˜å¤±è´¥ï¼ˆè­¬å¦‚ç³»ç»Ÿå †å†…å­˜ä¸è¶³ï¼‰å°†è¿”å› NULLï¼Œå¦‚æœå‚æ•° size ä¸º 0ï¼Œè¿”å›å€¼ä¹Ÿæ˜¯ NULLã€‚</p><p>malloc()åœ¨å †åŒºåˆ†é…ä¸€å—æŒ‡å®šå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾æ•°æ®ã€‚è¿™å—å†…å­˜ç©ºé—´åœ¨å‡½æ•°æ‰§è¡Œå®Œæˆåä¸ä¼šè¢«åˆå§‹åŒ–ï¼Œå®ƒä»¬çš„å€¼æ˜¯æœªçŸ¥çš„ï¼Œæ‰€ä»¥é€šå¸¸éœ€è¦ç¨‹åºå‘˜å¯¹ malloc()åˆ†é…çš„å †å†…å­˜è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><p><strong>free</strong>é‡Šæ”¾å †å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free</span><span class="params">(<span class="type">void</span> *ptr)</span>;</span><br></pre></td></tr></table></figure><p>ptrï¼šæŒ‡å‘éœ€è¦è¢«é‡Šæ”¾çš„å †å†…å­˜å¯¹åº”çš„æŒ‡é’ˆã€‚<br>è¿”å›å€¼ï¼šæ— è¿”å›å€¼ã€‚</p><p><strong>ç”¨ calloc()åˆ†é…å†…å­˜</strong><br>calloc()å‡½æ•°ç”¨æ¥åŠ¨æ€åœ°åˆ†é…å†…å­˜ç©ºé—´å¹¶åˆå§‹åŒ–ä¸º 0ï¼Œå…¶å‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> </span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">calloc</span><span class="params">(<span class="type">size_t</span> nmemb, <span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¯¥å‡½æ•°åŒæ ·ä¹Ÿéœ€è¦åŒ…å«å¤´æ–‡ä»¶ã€‚<br>calloc()åœ¨å †ä¸­åŠ¨æ€åœ°åˆ†é… nmemb ä¸ªé•¿åº¦ä¸º size çš„è¿ç»­ç©ºé—´ï¼Œå¹¶å°†æ¯ä¸€ä¸ªå­—èŠ‚éƒ½åˆå§‹åŒ–ä¸º 0ã€‚æ‰€ä»¥å®ƒçš„ç»“æœæ˜¯åˆ†é…äº† nmemb * size ä¸ªå­—èŠ‚é•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”æ¯ä¸ªå­—èŠ‚çš„å€¼éƒ½æ˜¯ 0ã€‚<br>è¿”å›å€¼ï¼šåˆ†é…æˆåŠŸè¿”å›æŒ‡å‘è¯¥å†…å­˜çš„åœ°å€ï¼Œå¤±è´¥åˆ™è¿”å› NULLã€‚<br>calloc()ä¸ malloc()çš„ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ï¼šcalloc()åœ¨åŠ¨æ€åˆ†é…å®Œå†…å­˜åï¼Œè‡ªåŠ¨åˆå§‹åŒ–è¯¥å†…å­˜ç©ºé—´ä¸ºé›¶ï¼Œè€Œmalloc()ä¸åˆå§‹åŒ–ï¼Œé‡Œè¾¹æ•°æ®æ˜¯æœªçŸ¥çš„åƒåœ¾æ•°æ®ã€‚ä¸‹é¢çš„ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calloc()åˆ†é…å†…å­˜ç©ºé—´å¹¶åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">char</span> *buf1 = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// malloc()åˆ†é…å†…å­˜ç©ºé—´å¹¶ç”¨ memset()åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">char</span> *buf2 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">10</span> * <span class="number">2</span>);</span><br><span class="line"><span class="built_in">memset</span>(buf2, <span class="number">0</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure><h4 id="åˆ†é…å¯¹é½å†…å­˜"><a href="#åˆ†é…å¯¹é½å†…å­˜" class="headerlink" title="åˆ†é…å¯¹é½å†…å­˜"></a>åˆ†é…å¯¹é½å†…å­˜</h4><p><a href="https://xie.infoq.cn/article/e071632f617563002552a7232">ä¸€æ–‡è½»æ¾ç†è§£å†…å­˜å¯¹é½_</a></p><p>C å‡½æ•°åº“ä¸­è¿˜æä¾›äº†ä¸€ç³»åˆ—åœ¨å †ä¸Šåˆ†é…å¯¹é½å†…å­˜çš„å‡½æ•°ï¼Œå¯¹é½å†…å­˜åœ¨æŸäº›åº”ç”¨åœºåˆéå¸¸æœ‰å¿…è¦ï¼Œå¸¸ç”¨äºåˆ†é…å¯¹å…¶å†…å­˜çš„åº“å‡½æ•°æœ‰ï¼šposix_memalign()ã€aligned_alloc()ã€memalign()ã€valloc()ã€pvalloc()ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">posix_memalign</span><span class="params">(<span class="type">void</span> **memptr, <span class="type">size_t</span> alignment, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">aligned_alloc</span><span class="params">(<span class="type">size_t</span> alignment, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">valloc</span><span class="params">(<span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">memalign</span><span class="params">(<span class="type">size_t</span> alignment, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">pvalloc</span><span class="params">(<span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><p>posix_memalign()å‡½æ•°<br>posix_memalign()å‡½æ•°ç”¨äºåœ¨å †ä¸Šåˆ†é… size ä¸ªå­—èŠ‚å¤§å°çš„å¯¹é½å†…å­˜ç©ºé—´ï¼Œå°†*memptr æŒ‡å‘åˆ†é…çš„ç©ºé—´ï¼Œåˆ†é…çš„å†…å­˜åœ°å€å°†æ˜¯å‚æ•° alignment çš„æ•´æ•°å€ã€‚å‚æ•° alignment è¡¨ç¤ºå¯¹é½å­—èŠ‚æ•°ï¼Œalignment å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹ï¼ˆè­¬å¦‚ 2^4ã€2^5ã€2^8 ç­‰ï¼‰ï¼ŒåŒæ—¶ä¹Ÿè¦æ˜¯ sizeof(void *)çš„æ•´æ•°å€ï¼Œå¯¹äº 32 ä½ç³»ç»Ÿæ¥è¯´sizeof(void *)ç­‰äº4ï¼Œå¦‚æœæ˜¯ 64 ä½ç³»ç»Ÿ sizeof(void *)ç­‰äº 8ã€‚<br>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>memptrï¼švoid *<em>ç±»å‹çš„æŒ‡é’ˆï¼Œå†…å­˜ç”³è¯·æˆåŠŸåä¼šå°†åˆ†é…çš„å†…å­˜åœ°å€å­˜æ”¾åœ¨</em>memptr ä¸­ã€‚<br>alignmentï¼šè®¾ç½®å†…å­˜å¯¹å…¶çš„å­—èŠ‚æ•°ï¼Œalignment å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹ï¼ˆè­¬å¦‚ 2^4ã€2^5ã€2^8 ç­‰ï¼‰ï¼ŒåŒæ—¶ä¹Ÿè¦æ˜¯ sizeof(void <em>)çš„æ•´æ•°å€ã€‚<br>sizeï¼šè®¾ç½®åˆ†é…çš„å†…å­˜å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œå¦‚æœå‚æ•° size ç­‰äº 0ï¼Œé‚£ä¹ˆ</em>memptr ä¸­çš„å€¼æ˜¯ NULLã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸå°†è¿”å› 0ï¼›å¤±è´¥è¿”å›é 0 å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> *base = <span class="literal">NULL</span>;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="comment">/* ç”³è¯·å†…å­˜: 256 å­—èŠ‚å¯¹é½ */</span></span><br><span class="line"> ret = posix_memalign((<span class="type">void</span> **)&amp;base, <span class="number">256</span>, <span class="number">1024</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> != ret) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;posix_memalign error\n&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">/* ä½¿ç”¨å†…å­˜ */</span></span><br><span class="line"> <span class="comment">// base[0] = 0;</span></span><br><span class="line"> <span class="comment">// base[1] = 1;</span></span><br><span class="line"> <span class="comment">// base[2] = 2;</span></span><br><span class="line"> <span class="comment">// base[3] = 3;</span></span><br><span class="line"> <span class="comment">/* é‡Šæ”¾å†…å­˜ */</span></span><br><span class="line"> <span class="built_in">free</span>(base);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="procæ–‡ä»¶ç³»ç»Ÿ"><a href="#procæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="procæ–‡ä»¶ç³»ç»Ÿ"></a>procæ–‡ä»¶ç³»ç»Ÿ</h3><p>(1)procæ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œè™šæ‹Ÿçš„æ„æ€å°±æ˜¯procæ–‡ä»¶ç³»ç»Ÿé‡Œçš„æ–‡ä»¶ä¸å¯¹åº”ç¡¬ç›˜ä¸Šä»»ä½•æ–‡ä»¶ï¼Œæˆ‘ä»¬ç”¨å»æŸ¥çœ‹procç›®å½•ä¸‹çš„æ–‡ä»¶å¤§å°éƒ½æ˜¯é›¶ï¼›<br>(2)procæ–‡ä»¶ç³»ç»Ÿæ˜¯å¼€æ”¾ç»™ä¸Šå±‚äº†è§£å†…æ ¸è¿è¡ŒçŠ¶æ€çš„çª—å£ï¼Œé€šè¿‡è¯»å–procç³»ç»Ÿé‡Œçš„æ–‡ä»¶ï¼Œå¯ä»¥çŸ¥é“å†…æ ¸ä¸­ä¸€äº›é‡è¦æ•°æ®ç»“æ„çš„æ•°å€¼ï¼Œä»è€ŒçŸ¥é“å†…æ ¸çš„è¿è¡Œæƒ…å†µï¼Œä¹Ÿå¯ä»¥æ–¹ä¾¿è°ƒè¯•å†…æ ¸å’Œåº”ç”¨ç¨‹åºï¼›<br>(3)procæ–‡ä»¶ç³»ç»Ÿçš„æ€è·¯ï¼šåœ¨å†…æ ¸ä¸­æ„å»ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ&#x2F;procï¼Œå†…æ ¸è¿è¡Œæ—¶å°†å†…æ ¸ä¸­ä¸€äº›å…³é”®çš„æ•°æ®ç»“æ„ä»¥æ–‡ä»¶çš„æ–¹å¼å‘ˆç°åœ¨&#x2F;procç›®å½•ä¸­çš„ä¸€äº›ç‰¹å®šæ–‡ä»¶ä¸­ï¼Œè¿™æ ·ç›¸å½“äºå°†ä¸å¯è§çš„å†…æ ¸ä¸­çš„æ•°æ®ç»“æ„ä»¥å¯è§†åŒ–çš„æ–¹å¼å‘ˆç°ç»™å†…æ ¸çš„å¼€å‘è€…</p><table><thead><tr><th align="center">æ–‡ä»¶å</th><th align="center">ä½œç”¨</th></tr></thead><tbody><tr><td align="center">&#x2F;proc&#x2F;cmdline</td><td align="center">æŸ¥çœ‹å†…æ ¸çš„å¯åŠ¨å‚æ•°</td></tr><tr><td align="center">&#x2F;proc&#x2F;cpuinfo</td><td align="center">æŸ¥çœ‹CPUçš„ä¿¡æ¯</td></tr><tr><td align="center">&#x2F;proc&#x2F;devices</td><td align="center">æŸ¥çœ‹å†…æ ¸ä¸­å·²ç»æ³¨å†Œçš„è®¾å¤‡</td></tr><tr><td align="center">&#x2F;proc&#x2F;filesystems</td><td align="center">å†…æ ¸å½“å‰æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹</td></tr><tr><td align="center">&#x2F;proc&#x2F;interrupts</td><td align="center">ä¸­æ–­çš„ä½¿ç”¨åŠè§¦å‘æ¬¡æ•°ï¼Œè°ƒè¯•ä¸­æ–­æ—¶å¾ˆæœ‰ç”¨</td></tr><tr><td align="center">&#x2F;proc&#x2F;misc</td><td align="center">å†…æ ¸ä¸­æ³¨å†Œçš„miscç±»è®¾å¤‡</td></tr><tr><td align="center">&#x2F;proc&#x2F;modules</td><td align="center">å·²ç»åŠ è½½çš„æ¨¡å—åˆ—è¡¨ï¼Œå¯¹åº”lsmodå‘½ä»¤</td></tr><tr><td align="center">&#x2F;proc&#x2F;partitions</td><td align="center">ç³»ç»Ÿçš„åˆ†åŒºè¡¨</td></tr><tr><td align="center">&#x2F;proc&#x2F;version</td><td align="center">ç³»ç»Ÿçš„ç‰ˆæœ¬</td></tr><tr><td align="center">æ•°å­—</td><td align="center">æ•°å­—çš„æ–‡ä»¶å¤¹éƒ½æ˜¯ç›¸åº”çš„è¿›ç¨‹</td></tr><tr><td align="center">&#x2F;proc&#x2F;mounts</td><td align="center">å·²åŠ è½½çš„æ–‡ä»¶ç³»ç»Ÿçš„åˆ—è¡¨ï¼Œå¯¹åº”mountå‘½ä»¤</td></tr><tr><td align="center">&#x2F;proc&#x2F;meminfo</td><td align="center">å†…æ ¸çš„å†…å­˜ä¿¡æ¯</td></tr><tr><td align="center">&#x2F;proc&#x2F;fb</td><td align="center">å†…æ ¸ä¸­æ³¨å†Œçš„æ˜¾ç¤ºè®¾å¤‡</td></tr></tbody></table><p><strong><u>proc æ–‡ä»¶ç³»ç»Ÿçš„ä½¿ç”¨å°±æ˜¯å»è¯»å–&#x2F;proc ç›®å½•ä¸‹çš„è¿™äº›æ–‡ä»¶ï¼Œè·å–æ–‡ä»¶ä¸­è®°å½•çš„ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ cat å‘½ä»¤è¯»å–ï¼Œä¹Ÿå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­è°ƒç”¨ open()æ‰“å¼€ã€ç„¶åå†ä½¿ç”¨ read()å‡½æ•°è¯»å–ã€‚</u></strong></p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxè°ƒè¯•å·¥å…·gdb</title>
      <link href="/2022/12/12/2022-12-12-Linux%E7%A2%B0%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2022/12/12/2022-12-12-Linux%E7%A2%B0%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h3 id="linuxä¸­ä½¿ç”¨C-x2F-C-çš„è°ƒè¯•å·¥å…·gdb"><a href="#linuxä¸­ä½¿ç”¨C-x2F-C-çš„è°ƒè¯•å·¥å…·gdb" class="headerlink" title="linuxä¸­ä½¿ç”¨C&#x2F;C++çš„è°ƒè¯•å·¥å…·gdb"></a>linuxä¸­ä½¿ç”¨C&#x2F;C++çš„è°ƒè¯•å·¥å…·gdb</h3><p>gdbæ˜¯GNUå¼€æºç»„ç»‡å‘å¸ƒçš„ä¸€ä¸ªå¼ºå¤§çš„Linuxä¸‹çš„ç¨‹åºè°ƒè¯•å·¥å…·ã€‚</p><p>â€‚ä¸€èˆ¬æ¥è¯´ï¼ŒGDBä¸»è¦å¸®åŠ©ä½ å®Œæˆä¸‹é¢å››ä¸ªæ–¹é¢çš„åŠŸèƒ½ï¼š</p><p>1ã€å¯åŠ¨ä½ çš„ç¨‹åºï¼Œå¯ä»¥æŒ‰ç…§ä½ çš„è‡ªå®šä¹‰çš„è¦æ±‚éšå¿ƒæ‰€æ¬²çš„è¿è¡Œç¨‹åºã€‚</p><p>2ã€å¯è®©è¢«è°ƒè¯•çš„ç¨‹åºåœ¨ä½ æ‰€æŒ‡å®šçš„è°ƒç½®çš„æ–­ç‚¹å¤„åœä½ã€‚ï¼ˆæ–­ç‚¹å¯ä»¥æ˜¯æ¡ä»¶è¡¨è¾¾å¼ï¼‰</p><p>3ã€å½“ç¨‹åºè¢«åœä½æ—¶ï¼Œå¯ä»¥æ£€æŸ¥æ­¤æ—¶ä½ çš„ç¨‹åºä¸­æ‰€å‘ç”Ÿçš„äº‹ã€‚</p><p>4ã€ä½ å¯ä»¥æ”¹å˜ä½ çš„ç¨‹åºï¼Œå°†ä¸€ä¸ªBUGäº§ç”Ÿçš„å½±å“ä¿®æ­£ä»è€Œæµ‹è¯•å…¶ä»–BUGã€‚<br>é¦–å…ˆè¦ç”¨gccè¿›è¡Œç¼–è¯‘</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -g æºæ–‡ä»¶ -o ç›®æ ‡æ–‡ä»¶</span><br></pre></td></tr></table></figure><p><strong><u>gdbçš„å‘½ä»¤</u></strong></p><p>ï¼ˆgdbï¼‰helpï¼šæŸ¥çœ‹å‘½ä»¤å¸®åŠ©ï¼Œå…·ä½“å‘½ä»¤æŸ¥è¯¢åœ¨gdbä¸­è¾“å…¥help + å‘½ä»¤,ç®€å†™h</p><p>ï¼ˆgdbï¼‰runï¼šé‡æ–°å¼€å§‹è¿è¡Œæ–‡ä»¶ï¼ˆrun-textï¼šåŠ è½½æ–‡æœ¬æ–‡ä»¶ï¼Œrun-binï¼šåŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰,ç®€å†™r</p><p>ï¼ˆgdbï¼‰startï¼šå•æ­¥æ‰§è¡Œï¼Œè¿è¡Œç¨‹åºï¼Œåœåœ¨ç¬¬ä¸€æ‰§è¡Œè¯­å¥</p><p>ï¼ˆgdbï¼‰listï¼šæŸ¥çœ‹åŸä»£ç ï¼ˆlist-n,ä»ç¬¬nè¡Œå¼€å§‹æŸ¥çœ‹ä»£ç ã€‚list+ å‡½æ•°åï¼šæŸ¥çœ‹å…·ä½“å‡½æ•°ï¼‰,ç®€å†™l</p><p>ï¼ˆgdbï¼‰setï¼šè®¾ç½®å˜é‡çš„å€¼</p><p>ï¼ˆgdbï¼‰nextï¼šå•æ­¥è°ƒè¯•ï¼ˆé€è¿‡ç¨‹ï¼Œå‡½æ•°ç›´æ¥æ‰§è¡Œï¼‰,ç®€å†™n</p><p>ï¼ˆgdbï¼‰stepï¼šå•æ­¥è°ƒè¯•ï¼ˆé€è¯­å¥ï¼šè·³å…¥è‡ªå®šä¹‰å‡½æ•°å†…éƒ¨æ‰§è¡Œï¼‰,ç®€å†™s</p><p>ï¼ˆgdbï¼‰backtraceï¼šæŸ¥çœ‹å‡½æ•°çš„è°ƒç”¨çš„æ ˆå¸§å’Œå±‚çº§å…³ç³»,ç®€å†™bt</p><p>ï¼ˆgdbï¼‰frameï¼šåˆ‡æ¢å‡½æ•°çš„æ ˆå¸§,ç®€å†™f</p><p>ï¼ˆgdbï¼‰infoï¼šæŸ¥çœ‹å‡½æ•°å†…éƒ¨å±€éƒ¨å˜é‡çš„æ•°å€¼,ç®€å†™i</p><p>ï¼ˆgdbï¼‰finishï¼šç»“æŸå½“å‰å‡½æ•°ï¼Œè¿”å›åˆ°å‡½æ•°è°ƒç”¨ç‚¹</p><p>ï¼ˆgdbï¼‰continueï¼šç»§ç»­è¿è¡Œ,ç®€å†™c</p><p>ï¼ˆgdbï¼‰printï¼šæ‰“å°å€¼åŠåœ°å€,ç®€å†™p</p><p>ï¼ˆgdbï¼‰quitï¼šé€€å‡ºgdb,ç®€å†™q</p><p>ï¼ˆgdbï¼‰break+numï¼šåœ¨ç¬¬numè¡Œè®¾ç½®æ–­ç‚¹,ç®€å†™b</p><p>ï¼ˆgdbï¼‰info breakpointsï¼šæŸ¥çœ‹å½“å‰è®¾ç½®çš„æ‰€æœ‰æ–­ç‚¹</p><p>ï¼ˆgdbï¼‰delete breakpoints numï¼šåˆ é™¤ç¬¬numä¸ªæ–­ç‚¹,ç®€å†™d</p><p>ï¼ˆgdbï¼‰displayï¼šè¿½è¸ªæŸ¥çœ‹å…·ä½“å˜é‡å€¼</p><p>ï¼ˆgdbï¼‰undisplayï¼šå–æ¶ˆè¿½è¸ªè§‚å¯Ÿå˜é‡</p><p>ï¼ˆgdbï¼‰watchï¼šè¢«è®¾ç½®è§‚å¯Ÿç‚¹çš„å˜é‡å‘ç”Ÿä¿®æ”¹æ—¶ï¼Œæ‰“å°æ˜¾ç¤º</p><p>ï¼ˆgdbï¼‰i watchï¼šæ˜¾ç¤ºè§‚å¯Ÿç‚¹</p><p>ï¼ˆgdbï¼‰enable breakpointsï¼šå¯ç”¨æ–­ç‚¹</p><p>ï¼ˆgdbï¼‰disable breakpointsï¼šç¦ç”¨æ–­ç‚¹</p><p>ï¼ˆgdbï¼‰xï¼šæŸ¥çœ‹å†…å­˜x&#x2F;20xw æ˜¾ç¤º20ä¸ªå•å…ƒï¼Œ16è¿›åˆ¶ï¼Œ4å­—èŠ‚æ¯å•å…ƒ</p><p>ï¼ˆgdbï¼‰run argv[1] argv[2]ï¼šè°ƒè¯•æ—¶å‘½ä»¤è¡Œä¼ å‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="type">int</span> sum=<span class="number">0</span>,i;</span><br><span class="line">     <span class="keyword">for</span>(i=<span class="number">1</span>; ilt;=<span class="number">100</span>; i++)</span><br><span class="line">     &#123;</span><br><span class="line">           sum+=i;</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">long</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;=<span class="number">100</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">          result += i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;result[1-100] = %d&quot;</span>, result );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;result[1-250] = %d&quot;</span>, func(<span class="number">250</span>) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒè¯•ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">root&lt;span style=<span class="string">&quot;&quot;</span>&gt;@&lt;/span&gt;linux: /home/benben /test<span class="meta"># gdb tst &lt;---------- å¯åŠ¨GDB</span></span><br><span class="line">GNU gdb <span class="number">5.1</span><span class="number">.1</span></span><br><span class="line">Copyright <span class="number">2002</span> Free Software Foundation, Inc.</span><br><span class="line">GDB is <span class="built_in">free</span> software, covered by the GNU General Public License, and you are</span><br><span class="line">welcome to change it and/or distribute copies of it under certain conditions.</span><br><span class="line">Type <span class="string">&quot;show copying&quot;</span> to see the conditions.</span><br><span class="line">There is absolutely no warranty <span class="keyword">for</span> GDB. Type <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;i386-suse-linux&quot;</span>...</span><br><span class="line">(gdb) l &lt;-------------------- lå‘½ä»¤ç›¸å½“äº<span class="built_in">list</span>ï¼Œä»ç¬¬ä¸€è¡Œå¼€å§‹ä¾‹å‡ºåŸç ã€‚</span><br><span class="line"><span class="number">1</span> <span class="meta">#<span class="keyword">include</span></span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span> <span class="type">int</span> func(<span class="type">int</span> n)</span><br><span class="line"><span class="number">4</span> &#123;</span><br><span class="line"><span class="number">5</span> <span class="type">int</span> sum=<span class="number">0</span>,i;</span><br><span class="line"><span class="number">6</span> <span class="keyword">for</span>(i=<span class="number">0</span>; i</span><br><span class="line"><span class="number">7</span> &#123;</span><br><span class="line"><span class="number">8</span> sum+=i;</span><br><span class="line"><span class="number">9</span> &#125;</span><br><span class="line"><span class="number">10</span> <span class="keyword">return</span> sum;</span><br><span class="line">(gdb) &lt;-------------------- ç›´æ¥å›è½¦è¡¨ç¤ºï¼Œé‡å¤ä¸Šä¸€æ¬¡å‘½ä»¤</span><br><span class="line"><span class="number">11</span> &#125;</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span> main()</span><br><span class="line"><span class="number">15</span> &#123;</span><br><span class="line"><span class="number">16</span> <span class="type">int</span> i;</span><br><span class="line"><span class="number">17</span> <span class="type">long</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="number">18</span> <span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;=<span class="number">100</span>; i++)</span><br><span class="line"><span class="number">19</span> &#123;</span><br><span class="line"><span class="number">20</span> result += i;</span><br><span class="line">(gdb) <span class="keyword">break</span> <span class="number">16</span> &lt;-------------------- è®¾ç½®æ–­ç‚¹ï¼Œåœ¨æºç¨‹åºç¬¬<span class="number">16</span>è¡Œå¤„ã€‚</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x8048496</span>: file tst.c, line <span class="number">16.</span></span><br><span class="line">(gdb) <span class="keyword">break</span> func &lt;-------------------- è®¾ç½®æ–­ç‚¹ï¼Œåœ¨å‡½æ•°func()å…¥å£å¤„ã€‚</span><br><span class="line">Breakpoint <span class="number">2</span> at <span class="number">0x8048456</span>: file tst.c, line <span class="number">5.</span></span><br><span class="line">(gdb) info <span class="keyword">break</span> &lt;-------------------- æŸ¥çœ‹æ–­ç‚¹ä¿¡æ¯ã€‚</span><br><span class="line">Num Type Disp Enb Address What</span><br><span class="line"><span class="number">1</span> breakpoint keep y <span class="number">0x08048496</span> in main at tst.c:<span class="number">16</span></span><br><span class="line"><span class="number">2</span> breakpoint keep y <span class="number">0x08048456</span> in func at tst.c:<span class="number">5</span></span><br><span class="line">(gdb) r &lt;--------------------- è¿è¡Œç¨‹åºï¼Œrunå‘½ä»¤ç®€å†™</span><br><span class="line">Starting program: /home/benben /test/tst</span><br><span class="line"> </span><br><span class="line">Breakpoint <span class="number">1</span>, main () at tst.c:<span class="number">17</span> &lt;---------- åœ¨æ–­ç‚¹å¤„åœä½ã€‚</span><br><span class="line"><span class="number">17</span> <span class="type">long</span> result = <span class="number">0</span>;</span><br><span class="line">(gdb) n &lt;--------------------- å•æ¡è¯­å¥æ‰§è¡Œï¼Œnextå‘½ä»¤ç®€å†™ã€‚</span><br><span class="line"><span class="number">18</span> <span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;=<span class="number">100</span>; i++)</span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">20</span> result += i;</span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">18</span> <span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;=<span class="number">100</span>; i++)</span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">20</span> result += i;</span><br><span class="line">(gdb) c &lt;--------------------- ç»§ç»­è¿è¡Œç¨‹åºï¼Œ<span class="keyword">continue</span>å‘½ä»¤ç®€å†™ã€‚</span><br><span class="line">Continuing.</span><br><span class="line">result[<span class="number">1</span><span class="number">-100</span>] = <span class="number">5050</span> &lt;----------ç¨‹åºè¾“å‡ºã€‚</span><br><span class="line"> </span><br><span class="line">Breakpoint <span class="number">2</span>, func (n=<span class="number">250</span>) at tst.c:<span class="number">5</span></span><br><span class="line"><span class="number">5</span> <span class="type">int</span> sum=<span class="number">0</span>,i;</span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">6</span> <span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;=n; i++)</span><br><span class="line">(gdb) p i &lt;--------------------- æ‰“å°å˜é‡içš„å€¼ï¼Œprintå‘½ä»¤ç®€å†™ã€‚</span><br><span class="line">$<span class="number">1</span> = <span class="number">134513808</span></span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">8</span> sum+=i;</span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">6</span> <span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;=n; i++)</span><br><span class="line">(gdb) p sum</span><br><span class="line">$<span class="number">2</span> = <span class="number">1</span></span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">8</span> sum+=i;</span><br><span class="line">(gdb) p i</span><br><span class="line">$<span class="number">3</span> = <span class="number">2</span></span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">6</span> <span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;=n; i++)</span><br><span class="line">(gdb) p sum</span><br><span class="line">$<span class="number">4</span> = <span class="number">3</span></span><br><span class="line">(gdb) bt &lt;--------------------- æŸ¥çœ‹å‡½æ•°å †æ ˆã€‚</span><br><span class="line">#<span class="number">0</span> func (n=<span class="number">250</span>) at tst.c:<span class="number">5</span></span><br><span class="line"> </span><br><span class="line">#<span class="number">1</span> <span class="number">0x080484e4</span> in main () at tst.c:<span class="number">24</span></span><br><span class="line"> </span><br><span class="line">#<span class="number">2</span> <span class="number">0x400409ed</span> in __libc_start_main () from /lib/libc.so<span class="number">.6</span></span><br><span class="line">(gdb) finish &lt;--------------------- é€€å‡ºå‡½æ•°ã€‚</span><br><span class="line">Run till <span class="built_in">exit</span> from #<span class="number">0</span> func (n=<span class="number">250</span>) at tst.c:<span class="number">5</span></span><br><span class="line"> </span><br><span class="line"><span class="number">0x080484e4</span> in main () at tst.c:<span class="number">24</span></span><br><span class="line"><span class="number">24</span> <span class="built_in">printf</span>(<span class="string">&quot;result[1-250] = %d&quot;</span>, func(<span class="number">250</span>) );</span><br><span class="line">Value returned is $<span class="number">6</span> = <span class="number">31375</span></span><br><span class="line">(gdb) c &lt;--------------------- ç»§ç»­è¿è¡Œã€‚</span><br><span class="line">Continuing.</span><br><span class="line">result[<span class="number">1</span><span class="number">-250</span>] = <span class="number">31375</span> &lt;----------ç¨‹åºè¾“å‡ºã€‚</span><br><span class="line"> </span><br><span class="line">Program exited with code <span class="number">027.</span> &lt;--------ç¨‹åºé€€å‡ºï¼Œè°ƒè¯•ç»“æŸã€‚</span><br><span class="line">(gdb) q &lt;--------------------- é€€å‡ºgdbã€‚</span><br><span class="line">root@linux:/home/benben/test#</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/lvdongjie/p/8994092.html">ã€Linuxã€‘GDBç”¨æ³•è¯¦è§£(5å°æ—¶å¿«é€Ÿæ•™ç¨‹)</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ ä¸€ä¸ªé˜¶æ®µçš„æ„Ÿå—</title>
      <link href="/2022/12/04/2022-12-4-%E6%94%BE%E5%81%87/"/>
      <url>/2022/12/04/2022-12-4-%E6%94%BE%E5%81%87/</url>
      
        <content type="html"><![CDATA[<p>â€‹å› ä¸ºç–«æƒ…åŸå› æå‰æ”¾å‡å›å®¶ï¼Œå¤§éƒ¨åˆ†è€ƒè¯•è¿˜ä¸çŸ¥é“æ€ä¹ˆè€ƒï¼Œç°åœ¨è¦å‡†å¤‡å¥½ææ–™ï¼Œåˆ·ç½‘è¯¾å’Œå¼„é€‰ä¿®è®ºæ–‡ï¼Œæ‰“ç®—12æœˆä»½å­¦å®ŒCè¯­è¨€å‰©ä½™ä¸¤ç« ï¼Œä¹‹åæ¯å¤©å†™ä¸ªè”ç³»ä»£ç ï¼Œlinuxæ–¹é¢ç»§ç»­åº”ç”¨å±‚çš„ç¼–å†™å­¦ä¹ ï¼Œçœ‹çœ‹å¼„å®Œåï¼Œå¯èƒ½è¦è¿›å…¥åˆ°C++ï¼Œè¿™æ ·æ‰èƒ½å­¦ä¹ QTåº”ç”¨ç¼–ç¨‹ï¼Œä¸œè¥¿è¿˜æ˜¯ä¸å°‘çš„ï¼Œå…ˆå®Œæˆæ€»çš„ç™¾åˆ†ä¹‹40å§ã€‚</p><p>â€‹å¾…ç»­ã€‚ã€‚ã€‚</p><p>â€‹ç°åœ¨è¿›å…¥å‡æœŸäº†ï¼Œä¸ºäº†æ›´å¥½çš„ä½¿ç”¨linuxçš„å¼€å‘æ¿ï¼Œå¼€å§‹å­¦ä¹ è£¸æœºå¼€å‘ï¼Œubootå’Œç³»ç»Ÿç§»æ¤ï¼Œé©±åŠ¨å¼€å‘ç›¸å…³çŸ¥è¯†ã€‚</p><p>â€‹çœ‹çœ‹ä¹‹åå­¦ä¹ C++ï¼Œè¿›å…¥qtæ¥æ›´å¥½çš„åˆ¶ä½œä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> éšç¬” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C issue1</title>
      <link href="/2022/11/25/2022-11-25-C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2022/11/25/2022-11-25-C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h3 id="scanfè¾“å…¥é—®é¢˜-è¾“å…¥ç¼“å†²åŒº"><a href="#scanfè¾“å…¥é—®é¢˜-è¾“å…¥ç¼“å†²åŒº" class="headerlink" title="scanfè¾“å…¥é—®é¢˜-è¾“å…¥ç¼“å†²åŒº"></a>scanfè¾“å…¥é—®é¢˜-è¾“å…¥ç¼“å†²åŒº</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> ch;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> b;</span><br><span class="line"></span><br><span class="line">b=<span class="built_in">scanf</span>(<span class="string">&quot;%c&quot;</span>,&amp;ch);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(b == <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,i++);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;?&quot;</span>);</span><br><span class="line"></span><br><span class="line">b=<span class="built_in">scanf</span>(<span class="string">&quot;%c&quot;</span>,&amp;ch);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä¼šå¾—åˆ°</span><br><span class="line"></span><br><span class="line">â€‹```c</span><br><span class="line">a<span class="comment">//è¾“å…¥a</span></span><br><span class="line"><span class="number">0</span>?a1?</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯å› ä¸ºscanf()å‡½æ•°ä¼šæŠŠå›è½¦ã€ç©ºæ ¼ã€Tabæˆ–ä¸€äº›ä¸åˆç†è¾“å…¥çš„å­—ç¬¦å½“ä½œæ­¤æ¬¡è¾“å…¥çš„ç»“æŸæ ‡å¿—ï¼Œå®ƒä¸ä¼šæŠŠè¿™äº›å­—ç¬¦è¾“å…¥åˆ°æƒ³è¦ä¿å­˜æ­¤æ¬¡è¾“å…¥æ•°æ®çš„å˜é‡ä¸­ï¼Œè€Œæ˜¯æŠŠè¿™äº›å­—ç¬¦é—ç•™åœ¨äº†è¾“å…¥ç¼“å†²åŒºï¼Œé‚£ä¹ˆï¼Œå½“ä¸‹ä¸€æ¬¡æƒ³è¦ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ä¸€ä¸ªå­—ç¬¦æ—¶ï¼Œè¿™ä¸ªé—ç•™çš„å­—ç¬¦å°±æ­£å¥½å……å½“äº†æ­¤æ¬¡çš„è¾“å…¥å­—ç¬¦ã€‚</p><p>ç¨‹åºåœ¨è¾“å…¥aåè¾“å…¥äº†å›è½¦æ¥ç»“æŸæ­¤æ¬¡è¾“å…¥ï¼Œé‚£ä¹ˆå›è½¦å°±é—ç•™åœ¨äº†è¾“å…¥ç¼“å†²åŒºï¼Œå½“éœ€è¦ç»™cè¾“å…¥å­—ç¬¦æ—¶ï¼Œå®ƒè‡ªåŠ¨çš„å……å½“äº†è¾“å…¥çš„å­—ç¬¦ï¼Œå› æ­¤ï¼Œç¨‹åºæ²¡æœ‰ç»™æˆ‘ä»¬è¾“å…¥cçš„å­—ç¬¦çš„æœºä¼šã€‚</p><p>Cè¯­è¨€ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§å¾ˆæ–¹ä¾¿çš„æ¸…ç©ºè¾“å…¥ç¼“å†²åŒºçš„æ–¹å¼â€”-&gt;&gt;fflush()å‡½æ•°ï¼Œfflush(stdin)å®ƒä¼šæŠŠæ®‹ç•™åœ¨è¾“å…¥ç¼“å†²åŒºé‡Œçš„æ‰€æœ‰æ•°æ®æ¸…ç©ºã€‚å¤´æ–‡ä»¶ä¸ºstdio.h</p><p>æˆ–è€…ä½¿ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((ch = getchar()) != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">continue</span>;<span class="comment">//è·³è¿‡è¯¥è¡Œå‰©ä¸‹çš„å†…å®¹ã€‚</span></span><br></pre></td></tr></table></figure><p><strong>C primer plusæä¾›çš„è¾“å…¥ç¨‹åº</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">s_gets</span><span class="params">(<span class="type">char</span> *st, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> * ret_val;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ret_val = fgets( st, n, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret_val)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(st[i]!= <span class="string">&#x27;\n&#x27;</span> &amp;&amp;st[i]!= <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">            i++;</span><br><span class="line">    <span class="keyword">if</span>(st[i] == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            st[i] == <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">while</span>(getchar()!=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret_val;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é”™é¢˜ï¼šä½è¿ç®—"><a href="#é”™é¢˜ï¼šä½è¿ç®—" class="headerlink" title="é”™é¢˜ï¼šä½è¿ç®—"></a>é”™é¢˜ï¼šä½è¿ç®—</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fun</span><span class="params">(<span class="type">int</span> i)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,fun(<span class="number">2017</span>));</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fun</span><span class="params">(<span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(i)</span><br><span class="line">&#123;</span><br><span class="line">cnt++;</span><br><span class="line">i = i&amp;(i<span class="number">-1</span>);<span class="comment">//i = i &amp; (i-1)ï¼Œç»Ÿè®¡iäºŒè¿›åˆ¶ä¸­æœ‰å¤šå°‘ä¸ª1</span></span><br><span class="line">&#125;               <span class="comment">//i = i | (i+1)ï¼Œç»Ÿè®¡iäºŒè¿›åˆ¶ä¸­æœ‰å¤šå°‘ä¸ª0</span></span><br><span class="line"><span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æŒ‡é’ˆæ•°ç»„"><a href="#æŒ‡é’ˆæ•°ç»„" class="headerlink" title="æŒ‡é’ˆæ•°ç»„"></a>æŒ‡é’ˆæ•°ç»„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *str[<span class="number">3</span>] =&#123;<span class="string">&quot;stra&quot;</span>, <span class="string">&quot;strb&quot;</span>, <span class="string">&quot;strc&quot;</span>&#125;;</span><br><span class="line">    <span class="type">char</span> *p =str[<span class="number">0</span>];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s &quot;</span>,p++);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>char<a href="https://so.csdn.net/so/search?q=%E6%8C%87%E9%92%88%E6%95%B0%E7%BB%84&spm=1001.2101.3001.7020">æŒ‡é’ˆæ•°ç»„</a>å¯ä»¥æŒ‡å‘å¤šä¸ªå­—ç¬¦ï¼Œç›´åˆ°é‡åˆ°ç©ºä¸ºæ­¢ã€‚pæœ¬æ¥æŒ‡å‘ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯å› ä¸ºæ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥è¦é‡åˆ°ç©ºä¸ºæ­¢æ‰ç®—è¯»å®Œç¬¬ä¸€ä¸ªâ€˜å­—ç¬¦â€™ï¼Œåé¢p+1æŒ‡å‘ç¬¬äºŒä¸ªå­—ç¬¦ï¼ŒåŒæ ·ä¹Ÿæ˜¯é‡åˆ°ç©ºä¸ºæ­¢ï¼ŒåŒç†p+2 æ‰€ä»¥è¾“å‡ºä¸ºstraï¼Œtraï¼Œraã€‚æ³¨æ„å¾ªç¯é‡Œé¢æ˜¯p++æ‰€ä»¥ä»p0å¼€å§‹æ‰“å°å•¦ã€‚</p><h3 id="æŒ‡é’ˆå’Œè‡ªå¢è‡ªå‡çš„ä¼˜å…ˆçº§"><a href="#æŒ‡é’ˆå’Œè‡ªå¢è‡ªå‡çš„ä¼˜å…ˆçº§" class="headerlink" title="æŒ‡é’ˆå’Œè‡ªå¢è‡ªå‡çš„ä¼˜å…ˆçº§"></a>æŒ‡é’ˆå’Œè‡ªå¢è‡ªå‡çš„ä¼˜å…ˆçº§</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> arr[] = &#123; <span class="number">1</span>, <span class="number">3668</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *p++ );<span class="comment">//æ‹¿åˆ°arr[0]çš„å€¼1</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *p++ ); <span class="comment">//ä¸Šæ¡è¯­å¥ç»“æŸåæŒ‡é’ˆå¾€åç§»åŠ¨äº†ä¸€ä¸‹ï¼Œ</span></span><br><span class="line"><span class="comment">//æŒ‡åˆ°åˆ°arr[1]ï¼Œç„¶ååˆ++ï¼Œå› ä¸ºæ˜¯å++ï¼Œ</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥è§£å¾—æ˜¯arr[1]çš„å€¼3668</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, (*p)++ );<span class="comment">//æ‹¿åˆ°ä¸Šä¸ª++æŒ‡å‘äº†arr[2],</span></span><br><span class="line"><span class="comment">//å› ä¸ºåŠ äº†æ‹¬å·ï¼Œæ‰€ä»¥å…ˆè§£å€¼ä¸º5ï¼Œç„¶å++ï¼Œ</span></span><br><span class="line"><span class="comment">//æŠŠç»“æœä¸¢ç»™äº†ä¸‹è¯­å¥ã€‚</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, (*p)++ );<span class="comment">//æ‹¬å·ä¼˜å…ˆçº§é«˜ï¼Œå…ˆè§£å€¼ï¼ŒæŒ‡é’ˆæœªç§»åŠ¨ï¼Œ</span></span><br><span class="line"><span class="comment">//è¿˜æŒ‡å‘ç€arr[2],æ‹¿åˆ°ä¸Šä¸ªprintfä¸¢ä¸‹æ¥çš„å€¼5+1=6ï¼Œ</span></span><br><span class="line"><span class="comment">//æ•…è§£å€¼ä¸º6ï¼Œç„¶6++,è¯­å¥æ‰§è¡Œç»“æŸæŠŠ6++ç»“æœä¸¢ç»™ä¸‹ä¸€æ¡è¯­å¥ã€‚</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="externå…³é”®å­—"><a href="#externå…³é”®å­—" class="headerlink" title="externå…³é”®å­—"></a>externå…³é”®å­—</h3><p>åœ¨Cè¯­è¨€ä¸­ï¼Œä¿®é¥°ç¬¦externç”¨åœ¨å˜é‡æˆ–è€…å‡½æ•°çš„å£°æ˜å‰ï¼Œç”¨æ¥è¯´æ˜â€œæ­¤å˜é‡&#x2F;å‡½æ•°æ˜¯åœ¨åˆ«å¤„å®šä¹‰çš„ï¼Œè¦åœ¨æ­¤å¤„å¼•ç”¨â€ã€‚externå£°æ˜ä¸æ˜¯å®šä¹‰ï¼Œå³ä¸åˆ†é…å­˜å‚¨ç©ºé—´ã€‚</p><h3 id="externâ€Câ€-ä½œç”¨"><a href="#externâ€Câ€-ä½œç”¨" class="headerlink" title="externâ€Câ€ ä½œç”¨"></a>externâ€Câ€ ä½œç”¨</h3><p>C++è¯­è¨€åœ¨ç¼–è¯‘çš„æ—¶å€™ä¸ºäº†è§£å†³å‡½æ•°çš„å¤šæ€é—®é¢˜ï¼Œä¼šå°†å‡½æ•°åå’Œå‚æ•°è”åˆèµ·æ¥ç”Ÿæˆä¸€ä¸ªä¸­é—´çš„å‡½æ•°åç§°ï¼Œè€ŒCè¯­è¨€åˆ™ä¸ä¼šï¼Œå› æ­¤ä¼šé€ æˆé“¾æ¥æ—¶æ— æ³•æ‰¾åˆ°å¯¹åº”å‡½æ•°çš„æƒ…å†µï¼Œæ­¤æ—¶Cå‡½æ•°å°±éœ€è¦ç”¨extern â€œCâ€è¿›è¡Œé“¾æ¥æŒ‡å®šï¼Œè¿™å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¯·ä¿æŒæˆ‘çš„åç§°ï¼Œä¸è¦ç»™æˆ‘ç”Ÿæˆç”¨äºé“¾æ¥çš„ä¸­é—´å‡½æ•°åã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus  </span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">//æŠŠæ‰€æœ‰å‡½æ•°å£°æ˜æ”¾åœ¨è¿™ã€‚</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus  </span></span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="ifâ€¦-endifçš„ä½œç”¨"><a href="#ifâ€¦-endifçš„ä½œç”¨" class="headerlink" title="#ifâ€¦#endifçš„ä½œç”¨"></a>#ifâ€¦#endifçš„ä½œç”¨</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">code æ‰§è¡Œä»£ç </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">code å±è”½ä»£ç </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>åŒæ ·å¯ä»¥â€œå±è”½â€ä¸€æ®µä»£ç ï¼Œä½ æƒ³æŠŠè¯´æ˜æ–‡å­—å†™åœ¨é‡Œé¢ä¹Ÿå¯ä»¥ï¼Œè¿™äº›å’Œâ€œ&#x2F;* *&#x2F;â€éƒ½ä¸€æ ·ï¼Œä½†ä¸ä¸€æ ·çš„æ˜¯ï¼šç¬¬ä¸€å®ƒå…è®¸åµŒå¥—ï¼ˆå±‚æ•°ä¸Šé™ç”±é¢„å¤„ç†å™¨å†³å®šï¼‰ã€ç¬¬äºŒä½ éšæ—¶å¯ä»¥æŠŠâ€œ#if 0â€æ”¹æˆâ€œ#if 1â€æ¥å–æ¶ˆå¯¹æŸæ®µä»£ç çš„â€œå±è”½ã€‚</p><h3 id="ç»“æ„ä½“å¤§å°"><a href="#ç»“æ„ä½“å¤§å°" class="headerlink" title="ç»“æ„ä½“å¤§å°"></a>ç»“æ„ä½“å¤§å°</h3><p>ç»“æ„ä½“è®¡ç®—éµå¾ªå¯¹é½åŸåˆ™ï¼š</p><p>1ï¼‰ç»“æ„ä½“å˜é‡é¦–åœ°å€èƒ½å¤ŸèƒŒå…¶æœ€å®½åŸºæœ¬ç±»å‹æˆå‘˜çš„å¤§å°æ‰€æ•´é™¤ï¼›</p><p>2ï¼‰ç»“æ„ä½“<u>æ¯ä¸ªæˆå‘˜ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„åç§»é‡éƒ½æ˜¯æˆå‘˜å¤§å°çš„æ•´æ•°å€</u>ï¼Œå¦‚æœ‰æ¯”é‚£ä¸€èµ·ä¼šåœ¨æˆå‘˜ä¹‹é—´åŠ ä¸Šå¡«å……å­—èŠ‚ï¼›</p><p>3ï¼‰ç»“æ„ä½“çš„<u>æ€»å¤§å°ä¸ºç»“æ„ä½“æœ€å®½åŸºæœ¬ç±»å‹æˆå‘˜çš„å¤§å°çš„æ•´æ•°å€</u>ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æœ€æœ«ä¸€ä¸ªæˆå‘˜ä¹‹ååŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</p><p><strong>åç§»é‡æŒ‡çš„æ˜¯ç»“æ„ä½“å˜é‡ä¸­æˆå‘˜çš„åœ°å€å’Œç»“æ„ä½“å˜é‡åœ°å€çš„å·®ã€‚ç»“æ„ä½“å¤§å°ç­‰äºæœ€åä¸€ä¸ªæˆå‘˜çš„åç§»é‡åŠ ä¸Šæœ€åä¸€ä¸ªæˆå‘˜çš„å¤§å°ã€‚</strong></p><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">person</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> fname;<span class="comment">//ç¬¬ä¸€ä¸ªæˆå‘˜åç§»é‡ä¸º0</span></span><br><span class="line">    <span class="type">int</span> age;<span class="comment">//ç¬¬äºŒä¸ªæˆå‘˜åç§»é‡ç­‰äº0+ç¬¬ä¸€ä¸ªçš„å¤§å°1=1ä½†æ˜¯å¾—æ˜¯ç¬¬äºŒä¸ªæˆå‘˜å¤§å°çš„æ•´æ•°å€æ‰€ä»¥æ˜¯4</span></span><br><span class="line">    <span class="type">double</span> time;<span class="comment">//ç¬¬ä¸‰ä¸ªæˆå‘˜åç§»é‡ç­‰äº4+ç¬¬äºŒä¸ªçš„å¤§å°4=8ä½†æ˜¯å¾—æ˜¯ç¬¬ä¸‰ä¸ªæˆå‘˜å¤§å°çš„æ•´æ•°å€æ‰€ä»¥æ˜¯8</span></span><br><span class="line">    <span class="type">float</span> old;<span class="comment">//ç¬¬å››ä¸ªæˆå‘˜åç§»é‡ç­‰äº8+ç¬¬ä¸‰ä¸ªçš„å¤§å°8=16ä½†æ˜¯å¾—æ˜¯ç¬¬å››ä¸ªæˆå‘˜å¤§å°çš„æ•´æ•°å€æ‰€ä»¥æ˜¯16</span></span><br><span class="line">&#125;;<span class="comment">//16+4=20ä½†æ˜¯å¾—æ˜¯æ‰€æœ‰çš„æ•´æ•°å€æ‰€ä»¥æ˜¯24ï¼›</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">person</span> <span class="title">student</span>;</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%ld&quot;</span>, <span class="keyword">sizeof</span>(student));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…å­˜å¯¹é½æ˜¯ä»€ä¹ˆ</p><p><a href="https://xie.infoq.cn/article/e071632f617563002552a7232">ä¸€æ–‡è½»æ¾ç†è§£å†…å­˜å¯¹é½_ç¨‹åºå‘˜_Cè¯­è¨€ä¸CPPç¼–ç¨‹</a></p><h3 id="ä¸ºä»€ä¹ˆè¦ç”¨mallocä½•æ—¶ç”¨"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨mallocä½•æ—¶ç”¨" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨mallocä½•æ—¶ç”¨"></a>ä¸ºä»€ä¹ˆè¦ç”¨mallocä½•æ—¶ç”¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void *malloc(unsigned int num_bytes);//åˆ†é…num_byteså­—èŠ‚çš„å†…å­˜å—</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼æ˜¯voidæŒ‡é’ˆï¼Œvoid* è¡¨ç¤ºæœªç¡®å®šç±»å‹çš„æŒ‡é’ˆï¼Œvoid *å¯ä»¥æŒ‡å‘ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œæ›´æ˜ç¡®çš„è¯´æ˜¯æŒ‡ç”³è¯·å†…å­˜ç©ºé—´æ—¶è¿˜ä¸çŸ¥é“ç”¨æˆ·æ˜¯ç”¨è¿™æ®µç©ºé—´æ¥å­˜å‚¨ä»€ä¹ˆç±»å‹çš„æ•°æ®ï¼ˆæ¯”å¦‚æ˜¯charè¿˜æ˜¯intæˆ–è€…å…¶ä»–æ•°æ®ç±»å‹ï¼‰ï¼Œå¯ä»¥é€šè¿‡ç±»å‹å¼ºåˆ¶è½¬åŒ–è½¬åŒ–ä¸ºå…¶ä»–ä»»æ„ç±»å‹æŒ‡é’ˆã€‚å¦‚æœåˆ†é…æˆåŠŸåˆ™è¿”å›æŒ‡å‘è¢«åˆ†é…å†…å­˜çš„æŒ‡é’ˆ(æ­¤å­˜å‚¨åŒºä¸­çš„åˆå§‹å€¼ä¸ç¡®å®š)ï¼Œå¦åˆ™è¿”å›ç©ºæŒ‡é’ˆNULLã€‚</p><p>mallocï¼ˆï¼‰æ˜¯åŠ¨æ€å†…å­˜åˆ†é…å‡½æ•°ï¼Œç”¨æ¥å‘ç³»ç»Ÿè¯·æ±‚åˆ†é…å†…å­˜ç©ºé—´ã€‚å½“æ— æ³•çŸ¥é“å†…å­˜å…·ä½“çš„ä½ç½®æ—¶ï¼Œæƒ³è¦ç»‘å®šçœŸæ­£çš„å†…å­˜ç©ºé—´ï¼Œå°±è¦ç”¨åˆ°mallocï¼ˆï¼‰å‡½æ•°ã€‚å› ä¸ºmallocåªç®¡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸èƒ½å¯¹åˆ†é…çš„ç©ºé—´è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥ç”³è¯·åˆ°çš„å†…å­˜ä¸­çš„å€¼æ˜¯éšæœºçš„ï¼Œç»å¸¸ä¼šä½¿ç”¨memset()è¿›è¡Œç½®0æ“ä½œåå†ä½¿ç”¨ã€‚</p><p>ä¸å…¶é…å¥—çš„æ˜¯freeï¼ˆï¼‰ï¼Œå½“ç”³è¯·åˆ°çš„ç©ºé—´ä¸å†ä½¿ç”¨æ—¶ï¼Œè¦ç”¨freeï¼ˆï¼‰å‡½æ•°å°†å†…å­˜ç©ºé—´é‡Šæ”¾æ‰ï¼Œè¿™æ ·å¯ä»¥æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œæœ€é‡è¦çš„æ˜¯â€”-å°±æ˜¯å› ä¸ºå®ƒå¯ä»¥ç”³è¯·å†…å­˜ç©ºé—´ï¼Œç„¶åæ ¹æ®éœ€è¦è¿›è¡Œé‡Šæ”¾ï¼Œæ‰è¢«ç§°ä¸ºâ€œåŠ¨æ€å†…å­˜åˆ†é…â€ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> *p;</span><br><span class="line">ã€€ã€€p = (<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">int</span>) * <span class="number">128</span>);</span><br><span class="line">ã€€ã€€ã€€ã€€<span class="comment">//åˆ†é…128ä¸ªæ•´å‹å­˜å‚¨å•å…ƒï¼Œå¹¶å°†è¿™128ä¸ªè¿ç»­çš„æ•´å‹å­˜å‚¨å•å…ƒçš„é¦–åœ°å€å­˜å‚¨åˆ°æŒ‡é’ˆå˜é‡pä¸­</span></span><br><span class="line">ã€€ã€€<span class="type">double</span> *pd = (<span class="type">double</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">double</span>) * <span class="number">12</span>);ã€€ã€€</span><br><span class="line">ã€€ã€€ã€€ã€€<span class="comment">//åˆ†é…12ä¸ªdoubleå‹å­˜å‚¨å•å…ƒï¼Œå¹¶å°†é¦–åœ°å€å­˜å‚¨åˆ°æŒ‡é’ˆå˜é‡pdä¸­</span></span><br><span class="line">ã€€ã€€<span class="built_in">free</span>(p);</span><br><span class="line">ã€€ã€€<span class="built_in">free</span>(pd);</span><br><span class="line">ã€€ã€€p = <span class="literal">NULL</span>;</span><br><span class="line">ã€€ã€€pd = <span class="literal">NULL</span>;ã€€ã€€</span><br><span class="line">ã€€ã€€æŒ‡é’ˆç”¨å®Œèµ‹å€¼<span class="literal">NULL</span>æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¹ æƒ¯ã€‚</span><br></pre></td></tr></table></figure><p>Cè¯­è¨€ä¸­çš„è”åˆ</p><p>è”åˆæ˜¯åœ¨åŒä¸€ä¸ªå†…å­˜ç©ºé—´ä¸­å­˜å‚¨ä¸åŒçš„æ•°æ®ç±»å‹ï¼ˆä¸èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ªç±»å‹ï¼‰ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">hold</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">int</span> digit;</span><br><span class="line"><span class="type">double</span> bigf1;</span><br><span class="line"><span class="type">char</span> letter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå£°æ˜çš„ç»“æ„åªèƒ½å­˜å‚¨æ•´å‹æˆ–æµ®ç‚¹å‹æˆ–è€…å­—ç¬¦å‹çš„å˜é‡ï¼Œä¸èƒ½åŒæ—¶å­˜åœ¨ã€‚</p><p><u>åˆå§‹åŒ–è”åˆ</u></p><p>æœ‰ä¸‰ç§æ–¹æ³•åˆå§‹åŒ–è”åˆï¼š<br>1ã€æŠŠä¸€ä¸ªè”åˆåˆå§‹åŒ–ä¸ºå¦ä¸€ä¸ªåŒç±»å‹çš„è”åˆ</p><p>2ã€åˆå§‹åŒ–è”åˆçš„ç¬¬ä¸€ä¸ªæˆå‘˜</p><p>3ã€ä½¿ç”¨æŒ‡å®šåˆå§‹åŒ–å™¨ï¼ˆC99æ ‡å‡†ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">car</span> <span class="title">first_car</span>;</span></span><br><span class="line">first_car.car_name=<span class="string">&#x27;A&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">car</span> <span class="title">sec_car</span>=</span>first_car; <span class="comment">//æŠŠä¸€ä¸ªè”åˆåˆå§‹åŒ–ä¸ºå¦ä¸€ä¸ªåŒç±»å‹çš„è”åˆ</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">car</span> <span class="title">car_a</span>=</span>&#123;<span class="string">&#x27;B&#x27;</span>&#125;;ã€€ã€€ã€€ã€€ã€€<span class="comment">//åˆå§‹åŒ–è”åˆçš„ç¬¬ä¸€ä¸ªæˆå‘˜</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">car</span> <span class="title">car_b</span>=</span>&#123;.car_num=<span class="number">2</span>&#125;;ã€€<span class="comment">//ä½¿ç”¨æŒ‡å®šåˆå§‹åŒ–å™¨æ¥åˆå§‹åŒ–è”åˆcar_b</span></span><br></pre></td></tr></table></figure><p>ç”¨æŒ‡é’ˆè®¿é—®è”åˆæ—¶å€™ä¹Ÿæ˜¯ç”¨-&gt;è¿ç®—ç¬¦ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pu = &amp;fit;</span><br><span class="line">x = pu -&gt;digit;</span><br></pre></td></tr></table></figure><h3 id="ä¼ é€’ç»“æ„ä½“æ•°ç»„åœ°å€"><a href="#ä¼ é€’ç»“æ„ä½“æ•°ç»„åœ°å€" class="headerlink" title="ä¼ é€’ç»“æ„ä½“æ•°ç»„åœ°å€"></a>ä¼ é€’ç»“æ„ä½“æ•°ç»„åœ°å€</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> * <span class="title function_">s_gets</span><span class="params">(<span class="type">char</span> * st, <span class="type">int</span> n)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIM 20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE 81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXTITL  40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXAUTL  40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXBKS  100</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">char</span> title [MAXTITL];</span><br><span class="line"><span class="type">char</span> author[MAXAUTL];</span><br><span class="line"><span class="type">float</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">srt</span><span class="params">( <span class="keyword">struct</span> book prt[], <span class="type">int</span> n)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">change</span><span class="params">(<span class="keyword">struct</span> book pt[], <span class="type">int</span> m)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span> <span class="title">library</span>[<span class="title">MAXBKS</span>];</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span> *<span class="title">pst</span>;</span></span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="type">int</span> t;</span><br><span class="line">pst = &amp;library[<span class="number">0</span>];</span><br><span class="line">menu();</span><br><span class="line"><span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; MAXBKS; i++ )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(s_gets(library[i].title, MAXTITL) == <span class="literal">NULL</span> || library[i].title[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;è¾“å…¥ä½œè€…\n&quot;</span>);</span><br><span class="line">s_gets(library[i].author, MAXAUTL);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;è¾“å…¥ä»·æ ¼\n&quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%f&quot;</span>, &amp;library[i].value);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;è¾“å…¥ä¹¦å\n&quot;</span>);</span><br><span class="line"><span class="keyword">while</span>(getchar() != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">srt(library, i);</span><br><span class="line"><span class="keyword">for</span>(t = <span class="number">0</span>; t &lt; i; t++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ä¹¦å%sä½œè€…%sä»·æ ¼%.2f\n&quot;</span>, library[t].title, library[t].author, library[t].value);</span><br><span class="line">&#125;</span><br><span class="line">change(library, i);</span><br><span class="line"><span class="keyword">for</span>(t = <span class="number">0</span>; t &lt; i; t++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ä¹¦å%sä½œè€…%sä»·æ ¼%.2f\n&quot;</span>, library[t].title, library[t].author, library[t].value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span> * <span class="title function_">s_gets</span><span class="params">(<span class="type">char</span> * st, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> * ret_val;</span><br><span class="line"><span class="type">char</span> * find;</span><br><span class="line"></span><br><span class="line">ret_val = fgets(st, n, <span class="built_in">stdin</span>);</span><br><span class="line"><span class="keyword">if</span>(ret_val)</span><br><span class="line">&#123;</span><br><span class="line">find = <span class="built_in">strchr</span>(st, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(find)</span><br><span class="line">* find = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">while</span>(getchar() != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret_val;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*************************************************************\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;please enter the book title and author and value \n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*************************************************************\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;è¾“å…¥ä¹¦å\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">srt</span><span class="params">( <span class="keyword">struct</span> book prt[], <span class="type">int</span> n)</span><span class="comment">//ä»·æ ¼æ’åº</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span> <span class="title">quantity</span>;</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n<span class="number">-1</span>; i++)<span class="comment">//å†’æ³¡æ’åº</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; n<span class="number">-1</span>-i; j++ )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(prt[j].value &gt; prt[j+<span class="number">1</span>].value)</span><br><span class="line">&#123;</span><br><span class="line">quantity = prt[j];</span><br><span class="line">prt[j] = prt[j+<span class="number">1</span>];</span><br><span class="line">prt[j+<span class="number">1</span>] = quantity;</span><br><span class="line">flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(flag == <span class="number">1</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">change</span><span class="params">(<span class="keyword">struct</span> book pt[], <span class="type">int</span> m)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span> <span class="title">letter</span>;</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; m<span class="number">-1</span>; i++)                <span class="comment">//å†’æ³¡æ’åº</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; m<span class="number">-1</span>-i; j++ )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>((<span class="type">int</span>)pt[j].title[<span class="number">0</span>]&gt;(<span class="type">int</span>)pt[j+<span class="number">1</span>].title[<span class="number">0</span>])</span><br><span class="line">&#123;</span><br><span class="line">letter = pt[j];</span><br><span class="line">pt[j] = pt[j+<span class="number">1</span>];</span><br><span class="line">pt[j+<span class="number">1</span>] = letter;</span><br><span class="line">flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">if</span>(flag == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxâ€”â€”å­—ç¬¦ä¸²å¤„ç†</title>
      <link href="/2022/11/23/2022-11-23-Linux%E2%80%94%E2%80%94%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86/"/>
      <url>/2022/11/23/2022-11-23-Linux%E2%80%94%E2%80%94%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="å­—ç¬¦ä¸²å¤„ç†"><a href="#å­—ç¬¦ä¸²å¤„ç†" class="headerlink" title="å­—ç¬¦ä¸²å¤„ç†"></a>å­—ç¬¦ä¸²å¤„ç†</h2><h3 id="å­—ç¬¦ä¸²è¾“å…¥è¾“å‡º"><a href="#å­—ç¬¦ä¸²è¾“å…¥è¾“å‡º" class="headerlink" title="å­—ç¬¦ä¸²è¾“å…¥è¾“å‡º"></a>å­—ç¬¦ä¸²è¾“å…¥è¾“å‡º</h3><p>è®¾å¤‡è¾“å‡ºstdoutã€è®¾å¤‡é”®ç›˜è¾“å…¥stdinã€è®¾å¤‡é”™è¯¯æ˜¾ç¤ºstderrã€‚</p><p>å¸¸ç”¨çš„å­—ç¬¦ä¸²è¾“å…¥å‡½æ•°æœ‰putchar()ã€puts()ã€fputc()ã€fputs()åªèƒ½è¾“å‡ºå­—ç¬¦ä¸²å‡½æ•°ï¼Œä¸åƒprintfå¯ä»¥æ ¼å¼åŒ–è¾“å‡ºï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨printfã€‚</p><p><strong>puts</strong>å‡½æ•°åŸå‹å¯é€šè¿‡man 3 putsæŸ¥çœ‹ã€‚</p><p>ä½¿ç”¨ puts()å‡½æ•°è¿æ¢è¡Œç¬¦â€™ \n â€˜éƒ½çœäº†ï¼Œå‡½æ•°å†…éƒ¨ä¼šè‡ªåŠ¨åœ¨å…¶åæ·»åŠ ä¸€ä¸ªæ¢è¡Œç¬¦ã€‚</p><p><strong>putchar</strong>å‡½æ•°åŸå‹å¯é€šè¿‡man 3 putcharæŸ¥çœ‹ã€‚</p><p>putchar()å‡½æ•°å¯ä»¥æŠŠå‚æ•° c æŒ‡å®šçš„å­—ç¬¦ï¼ˆä¸€ä¸ªæ— ç¬¦å·å­—ç¬¦ï¼‰è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼Œå…¶è¾“å‡ºå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ï¼Œå¯ä»¥æ˜¯ä»‹äº 0~127 ä¹‹é—´çš„ä¸€ä¸ªåè¿›åˆ¶æ•´å‹æ•°ï¼ˆåŒ…å« 0 å’Œ 127ï¼Œè¾“å‡ºå…¶å¯¹åº”çš„ ASCII ç å­—ç¬¦ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨ char ç±»å‹å®šä¹‰å¥½çš„ä¸€ä¸ªå­—ç¬¦å‹å˜é‡ã€‚</p><p><strong>fputc</strong>å‡½æ•°åŸå‹å¯é€šè¿‡man 3 fputcæŸ¥çœ‹</p><p>fputc()ä¸ putchar()ç±»ä¼¼ï¼Œä¹Ÿç”¨äºè¾“å‡ºå‚æ•° c æŒ‡å®šçš„å­—ç¬¦ï¼ˆä¸€ä¸ªæ— ç¬¦å·å­—ç¬¦ï¼‰ï¼Œä¸ putchar()åŒºåˆ«åœ¨äºï¼Œputchar()åªèƒ½è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼Œè€Œ fputc()å¯æŠŠå­—ç¬¦è¾“å‡ºåˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­ï¼Œæ—¢å¯ä»¥æ˜¯æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ã€‚</p><p><strong>fputs</strong></p><p>fputs()ä¸ puts()ç±»ä¼¼ï¼Œä¹Ÿç”¨äºè¾“å‡ºä¸€æ¡å­—ç¬¦ä¸²ï¼Œä¸ puts()åŒºåˆ«åœ¨äºï¼Œputs()åªèƒ½è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºè®¾å¤‡ï¼Œè€Œ fputs()å¯æŠŠå­—ç¬¦ä¸²è¾“å‡ºåˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­ï¼Œæ—¢å¯ä»¥æ˜¯æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ã€‚</p><h3 id="å†…å­˜å¡«å……"><a href="#å†…å­˜å¡«å……" class="headerlink" title="å†…å­˜å¡«å……"></a>å†…å­˜å¡«å……</h3><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œç»å¸¸éœ€è¦å°†æŸä¸€å—å†…å­˜ä¸­çš„æ•°æ®å…¨éƒ¨è®¾ç½®ä¸ºæŒ‡å®šçš„å€¼ï¼Œè­¬å¦‚åœ¨å®šä¹‰æ•°ç»„ã€ç»“æ„ä½“è¿™ç§ç±»å‹å˜é‡æ—¶ï¼Œé€šå¸¸éœ€è¦å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œè€Œåˆå§‹åŒ–æ“ä½œä¸€èˆ¬éƒ½æ˜¯å°†å…¶å ç”¨çš„å†…å­˜ç©ºé—´å…¨éƒ¨å¡«å……ä¸º 0ã€‚</p><p><strong>memsetå‡½æ•°</strong>ç”¨äºå°†æŸä¸€å—å†…å­˜çš„æ•°æ®å…¨éƒ¨è®¾ç½®ä¸ºæŒ‡å®šçš„å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">memset</span><span class="params">(<span class="type">void</span> *s, <span class="type">int</span> c, <span class="type">size_t</span> n)</span>;</span><br></pre></td></tr></table></figure><p>sï¼šéœ€è¦è¿›è¡Œæ•°æ®å¡«å……çš„å†…å­˜ç©ºé—´èµ·å§‹åœ°å€ã€‚<br>cï¼šè¦è¢«è®¾ç½®çš„å€¼ï¼Œè¯¥å€¼ä»¥ int ç±»å‹ä¼ é€’ã€‚ä½†åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æ˜¯ä»¥æ— ç¬¦å·å­—ç¬¦å½¢å¼<br>nï¼šå¡«å……çš„å­—èŠ‚æ•°ã€‚</p><p><strong>bzeroå‡½æ•°</strong>ç”¨äºå°†ä¸€å—å†…å­˜çš„æ•°æ®éƒ½è®¾ç½®ä¸º0</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strings.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bzero</span><span class="params">(<span class="type">void</span> *s, <span class="type">size_t</span> n)</span>;</span><br></pre></td></tr></table></figure><p>sï¼šå†…å­˜ç©ºé—´çš„èµ·å§‹åœ°å€ã€‚<br>nï¼šå¡«å……çš„å­—èŠ‚æ•°ã€‚<br>è¿”å›å€¼ï¼šæ— è¿”å›å€¼ã€‚</p><h3 id="Linuxæ­£åˆ™è¡¨è¾¾å¼"><a href="#Linuxæ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="Linuxæ­£åˆ™è¡¨è¾¾å¼"></a>Linuxæ­£åˆ™è¡¨è¾¾å¼</h3><p>æ­£åˆ™è¡¨è¾¾å¼ï¼Œåˆç§°ä¸ºè§„åˆ™è¡¨è¾¾å¼ï¼ˆè‹±è¯­: Regular Expressionï¼‰ï¼Œæ­£åˆ™è¡¨è¾¾å¼é€šå¸¸è¢«ç”¨æ¥æ£€ç´¢ã€æ›¿æ¢é‚£äº›ç¬¦åˆæŸä¸ªæ¨¡å¼ï¼ˆè§„åˆ™ï¼‰çš„å­—ç¬¦ä¸²ï¼Œæ­£åˆ™è¡¨è¾¾å¼æè¿°äº†ä¸€ç§å­—ç¬¦ä¸²çš„åŒ¹é…æ¨¡å¼ï¼ˆpatternï¼‰ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥ä¸€ä¸ªç»™å®šçš„å­—ç¬¦ä¸²ä¸­æ˜¯å¦å«æœ‰æŸç§å­å­—ç¬¦ä¸²ã€å°†åŒ¹é…çš„å­—ç¬¦ä¸²æ›¿æ¢æˆ–è€…ä»æŸä¸ªå­—ç¬¦ä¸²ä¸­å–å‡ºç¬¦åˆæŸä¸ªæ¡ä»¶çš„å­å­—ç¬¦ä¸²ã€‚</p><p>æ­£åˆ™è¡¨è¾¾å¼å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²ç”±æ™®é€šå­—ç¬¦ï¼ˆè­¬å¦‚ï¼Œæ•°å­— 0~9ã€å¤§å°å†™å­—æ¯ä»¥åŠå…¶å®ƒå­—ç¬¦ï¼‰å’Œç‰¹æ®Šå­—ç¬¦ï¼ˆç§°ä¸ºâ€œå…ƒå­—ç¬¦â€ï¼‰æ‰€ç»„æˆï¼Œç”±è¿™äº›å­—ç¬¦ç»„æˆä¸€ä¸ªâ€œè§„åˆ™å­—ç¬¦ä¸²â€ï¼Œè¿™ä¸ªâ€œè§„åˆ™å­—ç¬¦ä¸²â€ç”¨æ¥è¡¨è¾¾å¯¹ç»™å®šå­—ç¬¦ä¸²çš„ä¸€ç§æŸ¥æ‰¾ã€åŒ¹é…é€»è¾‘ã€‚</p><p><a href="https://www.runoob.com/regexp/regexp-intro.html">æ­£åˆ™è¡¨è¾¾å¼ èœé¸Ÿæ•™ç¨‹</a></p><p>Cè¯­è¨€ä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä¸€èˆ¬åˆ†ä¸ºä¸‰æ­¥ï¼š</p><p>1.ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼regcomp()</p><p>2åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼regexec()</p><p>3é‡Šæ”¾æ­£åˆ™è¡¨è¾¾å¼regfree()</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;regex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">regmatch_t</span> pmatch = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> <span class="type">regex_t</span> reg;</span><br><span class="line"> <span class="type">char</span> errbuf[<span class="number">64</span>];</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="type">char</span> *sptr;</span><br><span class="line"> <span class="type">int</span> length;</span><br><span class="line"> <span class="type">int</span> nmatch; <span class="comment">//æœ€å¤šåŒ¹é…å‡ºçš„ç»“æœ</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">4</span> != argc) </span><br><span class="line">    &#123;</span><br><span class="line"> <span class="comment">/**********************************</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œç¨‹åºæ—¶éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°:</span></span><br><span class="line"><span class="comment"> * arg1: æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment"> * arg2: å¾…æµ‹è¯•çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment"> * arg3: æœ€å¤šåŒ¹é…å‡ºå¤šå°‘ä¸ªç»“æœ</span></span><br><span class="line"><span class="comment"> **********************************/</span></span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;usage: %s &lt;regex&gt; &lt;string&gt; &lt;nmatch&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span>(ret = regcomp(&amp;reg, argv[<span class="number">1</span>], REG_EXTENDED)) </span><br><span class="line">    &#123;</span><br><span class="line"> regerror(ret, &amp;reg, errbuf, <span class="keyword">sizeof</span>(errbuf));</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;regcomp error: %s\n&quot;</span>, errbuf);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* èµ‹å€¼æ“ä½œ */</span></span><br><span class="line"> sptr = argv[<span class="number">2</span>]; <span class="comment">//å¾…æµ‹è¯•çš„å­—ç¬¦ä¸²</span></span><br><span class="line"> length = <span class="built_in">strlen</span>(argv[<span class="number">2</span>]);<span class="comment">//è·å–å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line"> nmatch = atoi(argv[<span class="number">3</span>]); <span class="comment">//è·å–æœ€å¤§åŒ¹é…æ•°</span></span><br><span class="line"> <span class="comment">/* åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ */</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; nmatch; j++) </span><br><span class="line">    &#123;</span><br><span class="line"> <span class="type">char</span> temp_str[<span class="number">100</span>];</span><br><span class="line"> <span class="comment">/* è°ƒç”¨ regexec åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ */</span></span><br><span class="line"> <span class="keyword">if</span>(ret = regexec(&amp;reg, sptr, <span class="number">1</span>, &amp;pmatch, <span class="number">0</span>)) </span><br><span class="line">    &#123;</span><br><span class="line"> regerror(ret, &amp;reg, errbuf, <span class="keyword">sizeof</span>(errbuf));</span><br><span class="line"> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;regexec error: %s\n&quot;</span>, errbuf);</span><br><span class="line"> <span class="keyword">goto</span> out;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span>(<span class="number">-1</span> != pmatch.rm_so) </span><br><span class="line">    &#123;</span><br><span class="line"> <span class="keyword">if</span> (pmatch.rm_so == pmatch.rm_eo) </span><br><span class="line">        &#123;<span class="comment">//ç©ºå­—ç¬¦ä¸²</span></span><br><span class="line"> sptr += <span class="number">1</span>;</span><br><span class="line"> length -= <span class="number">1</span>;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>); <span class="comment">//æ‰“å°å‡ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt;= length)<span class="comment">//å¦‚æœå·²ç»ç§»åŠ¨åˆ°å­—ç¬¦ä¸²æœ«å°¾ã€åˆ™é€€å‡º</span></span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> <span class="keyword">continue</span>; <span class="comment">//ä» for å¾ªç¯å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">memset</span>(temp_str, <span class="number">0x00</span>, <span class="keyword">sizeof</span>(temp_str));<span class="comment">//æ¸…é›¶ç¼“å†²åŒº</span></span><br><span class="line"> <span class="built_in">memcpy</span>(temp_str, sptr + pmatch.rm_so,</span><br><span class="line"> pmatch.rm_eo - pmatch.rm_so);<span class="comment">//å°†åŒ¹é…å‡ºæ¥çš„å­å­—ç¬¦ä¸²æ‹·è´åˆ°ç¼“å†²åŒº</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, temp_str); <span class="comment">//æ‰“å°å­—ç¬¦ä¸²</span></span><br><span class="line">sptr += pmatch.rm_eo;</span><br><span class="line"> length -= pmatch.rm_eo;</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt;= length)</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* é‡Šæ”¾æ­£åˆ™è¡¨è¾¾å¼ */</span></span><br><span class="line">out:</span><br><span class="line"> regfree(&amp;reg);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ ä¸€ä¸ªé˜¶æ®µçš„æ„Ÿå—</title>
      <link href="/2022/11/18/2022-11-18-%E9%9A%8F%E7%AC%94/"/>
      <url>/2022/11/18/2022-11-18-%E9%9A%8F%E7%AC%94/</url>
      
        <content type="html"><![CDATA[<p>â€‹ç›®å‰åœ¨linuxä¸Šå­¦ä¹ äº†ä¸€ä¸ªæµ…æ˜¾çš„é˜¶æ®µï¼Œå­¦ä¼šäº†å‘½ä»¤è¡Œçš„ä¸€äº›å¸¸è§„çš„æ“ä½œï¼Œä¹Ÿå¯¹Linuxçš„å†…æ ¸æœ‰äº†å°‘éƒ¨åˆ†çš„äº†è§£ï¼Œç›®å‰åœ¨Cè¯­è¨€ä¸Šçš„ç³»ç»Ÿå­¦ä¹ è¿›å…¥äº†å°¾å£°ï¼Œä¹‹ååº”è¯¥å°±è¦æ—¶å¸¸å¤ä¹ Cè¯­è¨€çš„ç¼–ç¨‹ï¼Œä¹‹å‰æ²¡æœ‰ç¼–å†™è¿‡åº•å±‚ï¼Œç°åœ¨æ„Ÿè§‰Cè¯­è¨€çš„åº”ç”¨ç¼–å†™ç¡®å®å¤æ‚ï¼Œä¸»è¦æ˜¯ä¸œè¥¿æœ‰ç‚¹å¤šï¼Œè®°ä¸ä¸‹æ¥ï¼Œæ‰“ç®—è¶ç€å†™é€‰ä¿®è®ºæ–‡çš„æ—¶å€™ï¼Œç”¨å¹³æ—¶ç¬”è®°å¤ä¹ å¤ä¹ ï¼Œå†åŠ å¼ºä¸€ä¸‹Cè¯­è¨€å‰äº›ç« èŠ‚çš„ç¼–å†™èƒ½åŠ›ï¼Œè·¨è¿‡è¿™ä¸€é˜¶æ®µï¼Œå†æ€è€ƒä¸‹ä¸€é˜¶æ®µç§‘æŠ€æ ‘ç‚¹å“ªçš„é—®é¢˜å§ï¼Œç§‘æŠ€æ ‘å¯çœŸå¤šå‘€ï¼Œåªèƒ½è¯´è¿˜å¥½ç°åœ¨è¯¾ä¸šä¸æ˜¯å¾ˆé‡ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> éšç¬” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxæ–‡ä»¶å±æ€§</title>
      <link href="/2022/11/18/2022-11-18-Linux%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E5%92%8C%E7%9B%AE%E5%BD%95/"/>
      <url>/2022/11/18/2022-11-18-Linux%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E5%92%8C%E7%9B%AE%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h3 id="æ–‡ä»¶ç±»å‹"><a href="#æ–‡ä»¶ç±»å‹" class="headerlink" title="æ–‡ä»¶ç±»å‹"></a>æ–‡ä»¶ç±»å‹</h3><p>æ­£æ‰€è°“Linuxä¸‹çš†æ–‡ä»¶ï¼Œç³»ç»Ÿä¸‹ä¸€å…±åˆ†ä¸º7ç§æ–‡ä»¶ï¼š</p><p><strong>â‘ æ™®é€šæ–‡ä»¶</strong></p><p>æ™®é€šæ–‡ä»¶ï¼ˆregular fileï¼‰åœ¨ Linux ç³»ç»Ÿä¸‹æ˜¯æœ€å¸¸è§çš„ï¼Œè­¬å¦‚æ–‡æœ¬æ–‡ä»¶ã€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬ç¼–å†™çš„æºä»£ç æ–‡ä»¶è¿™äº›éƒ½æ˜¯æ™®é€šæ–‡ä»¶ã€‚</p><p>æ™®é€šæ–‡ä»¶åˆ†ä¸ºæ–‡æœ¬æ–‡ä»¶å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><p>æ–‡æœ¬æ–‡ä»¶ï¼šæ–‡ä»¶ä¸­çš„å†…å®¹æ˜¯ç”±æ–‡æœ¬æ„æˆçš„ï¼Œæ‰€è°“æ–‡æœ¬æŒ‡çš„æ˜¯ ASCII ç å­—ç¬¦ã€‚æ–‡ä»¶ä¸­çš„å†…å®¹å…¶æœ¬è´¨ä¸Šéƒ½æ˜¯æ•°å­—ã€‚</p><p>äºŒè¿›åˆ¶æ–‡ä»¶ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ä¸­å­˜å‚¨çš„æœ¬è´¨ä¸Šä¹Ÿæ˜¯æ•°å­—ï¼Œåªä¸è¿‡å¯¹äºäºŒè¿›åˆ¶æ–‡ä»¶æ¥è¯´ï¼Œè¿™äº›æ•°å­—å¹¶ä¸æ˜¯æ–‡æœ¬å­—ç¬¦ç¼–ç ï¼Œè€Œæ˜¯çœŸæ­£çš„æ•°å­—ã€‚è­¬å¦‚ Linux ç³»ç»Ÿä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€C ä»£ç ç¼–è¯‘ä¹‹åå¾—åˆ°çš„.o æ–‡ä»¶ã€.bin æ–‡ä»¶ç­‰éƒ½æ˜¯äºŒè¿›åˆ¶ä»¶ã€‚</p><p><strong>â‘¡ç›®å½•æ–‡ä»¶</strong></p><p>ç›®å½•ï¼ˆdirectoryï¼‰å°±æ˜¯æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹åœ¨ Linux ç³»ç»Ÿä¸­ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šæ–‡ä»¶ã€‚</p><p><strong>â‘¢å­—ç¬¦è®¾å¤‡æ–‡ä»¶å’Œå—è®¾å¤‡æ–‡ä»¶</strong></p><p>Linux ç³»ç»Ÿä¸‹ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œä¹ŸåŒ…æ‹¬å„ç§ç¡¬ä»¶è®¾å¤‡ã€‚è®¾å¤‡æ–‡ä»¶ï¼ˆå­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€å—è®¾å¤‡æ–‡ä»¶ï¼‰å¯¹åº”çš„æ˜¯ç¡¬ä»¶è®¾å¤‡ï¼Œåœ¨ Linux ç³»ç»Ÿä¸­ï¼Œç¡¬ä»¶è®¾å¤‡ä¼šå¯¹åº”åˆ°ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡å¯¹è®¾å¤‡æ–‡ä»¶çš„è¯»å†™æ¥æ“æ§ã€ä½¿ç”¨ç¡¬ä»¶è®¾å¤‡ã€‚</p><p>Linux ç³»ç»Ÿä¸­ï¼Œå¯å°†ç¡¬ä»¶è®¾å¤‡åˆ†ä¸ºå­—ç¬¦è®¾å¤‡å’Œå—è®¾å¤‡ï¼Œæ‰€ä»¥å°±æœ‰äº†å­—ç¬¦è®¾å¤‡æ–‡ä»¶å’Œå—è®¾å¤‡æ–‡ä»¶ä¸¤ç§æ–‡ä»¶ç±»å‹ã€‚è™½ç„¶æœ‰è®¾å¤‡æ–‡ä»¶ï¼Œä½†æ˜¯è®¾å¤‡æ–‡ä»¶å¹¶ä¸å¯¹åº”ç£ç›˜ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´è®¾å¤‡æ–‡ä»¶å¹¶ä¸å­˜åœ¨äºç£ç›˜ä¸­ï¼Œè€Œæ˜¯ç”±æ–‡ä»¶ç³»ç»Ÿè™šæ‹Ÿå‡ºæ¥çš„ï¼Œä¸€èˆ¬æ˜¯ç”±å†…å­˜æ¥ç»´æŠ¤ï¼Œå½“ç³»ç»Ÿå…³æœºæ—¶ï¼Œè®¾å¤‡æ–‡ä»¶éƒ½ä¼šæ¶ˆå¤±ï¼›å­—ç¬¦è®¾å¤‡æ–‡ä»¶ä¸€èˆ¬å­˜æ”¾åœ¨ Linux ç³»ç»Ÿ&#x2F;dev&#x2F;ç›®å½•ä¸‹ã€‚</p><p><strong>â‘£ç¬¦å·é“¾æ¥æ–‡ä»¶</strong></p><p>ç¬¦å·é“¾æ¥æ–‡ä»¶ï¼ˆlinkï¼‰ç±»ä¼¼äº Windows ç³»ç»Ÿä¸­çš„å¿«æ·æ–¹å¼æ–‡ä»¶ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šæ–‡ä»¶ï¼Œå®ƒçš„å†…å®¹æŒ‡å‘çš„æ˜¯å¦ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œå½“å¯¹ç¬¦å·é“¾æ¥æ–‡ä»¶è¿›è¡Œæ“ä½œæ—¶ï¼Œç³»ç»Ÿæ ¹æ®æƒ…å†µä¼šå¯¹è¿™ä¸ªæ“ä½œè½¬ç§»åˆ°å®ƒæŒ‡å‘çš„æ–‡ä»¶ä¸Šå»ï¼Œè€Œä¸æ˜¯å¯¹å®ƒæœ¬èº«è¿›è¡Œæ“ä½œã€‚</p><p><strong>â‘¤ç®¡é“æ–‡ä»¶</strong></p><p>ç®¡é“æ–‡ä»¶ï¼ˆpipeï¼‰ä¸»è¦ç”¨äºè¿›ç¨‹é—´é€šä¿¡ã€‚</p><p><strong>â‘¥å¥—æ¥å­—æ–‡ä»¶</strong></p><p>å¥—æ¥å­—æ–‡ä»¶ï¼ˆsocketï¼‰ä¹Ÿæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œä¸ç®¡é“æ–‡ä»¶ä¸åŒçš„æ˜¯ï¼Œå®ƒä»¬å¯ä»¥åœ¨ä¸åŒä¸»æœºä¸Šçš„è¿›ç¨‹é—´é€šä¿¡ï¼Œå®é™…ä¸Šå°±æ˜¯ç½‘ç»œé€šä¿¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">stat</span> test_file<span class="comment">##å¯ä»¥æŸ¥çœ‹æ–‡ä»¶å±æ€§</span></span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤å†…éƒ¨å°±æ˜¯é€šè¿‡è°ƒç”¨ stat()å‡½æ•°æ¥è·å–æ–‡ä»¶å±æ€§çš„ï¼Œstat å‡½æ•°æ˜¯ Linux ä¸­çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºè·å–æ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">stat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="keyword">struct</span> stat *buf)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°åŠè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>pathnameï¼šç”¨äºæŒ‡å®šä¸€ä¸ªéœ€è¦æŸ¥çœ‹å±æ€§çš„æ–‡ä»¶è·¯å¾„ã€‚<br>bufï¼šstruct stat ç±»å‹æŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘ä¸€ä¸ª struct stat ç»“æ„ä½“å˜é‡ã€‚è°ƒç”¨ stat å‡½æ•°çš„æ—¶å€™éœ€è¦ä¼ å…¥ä¸€ä¸ª struct<br>stat å˜é‡çš„æŒ‡é’ˆï¼Œè·å–åˆ°çš„æ–‡ä»¶å±æ€§ä¿¡æ¯å°±è®°å½•åœ¨ struct stat ç»“æ„ä½“ä¸­ï¼Œç¨åç»™å¤§å®¶ä»‹ç» struct stat ç»“æ„ä½“ä¸­æœ‰è®°å½•äº†å“ªäº›ä¿¡æ¯ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥è¿”å›-1ï¼Œå¹¶è®¾ç½® errorã€‚</p><h4 id="struct-stat-ç»“æ„ä½“"><a href="#struct-stat-ç»“æ„ä½“" class="headerlink" title="struct stat ç»“æ„ä½“"></a>struct stat ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="type">dev_t</span> st_dev; <span class="comment">/* æ–‡ä»¶æ‰€åœ¨è®¾å¤‡çš„ ID */</span></span><br><span class="line"> <span class="type">ino_t</span> st_ino; <span class="comment">/* æ–‡ä»¶å¯¹åº” inode èŠ‚ç‚¹ç¼–å· */</span></span><br><span class="line"> <span class="type">mode_t</span> st_mode; <span class="comment">/* æ–‡ä»¶å¯¹åº”çš„æ¨¡å¼ */</span></span><br><span class="line"> <span class="type">nlink_t</span> st_nlink; <span class="comment">/* æ–‡ä»¶çš„é“¾æ¥æ•° */</span></span><br><span class="line"> <span class="type">uid_t</span> st_uid; <span class="comment">/* æ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ· ID */</span></span><br><span class="line"> <span class="type">gid_t</span> st_gid; <span class="comment">/* æ–‡ä»¶æ‰€æœ‰è€…çš„ç»„ ID */</span></span><br><span class="line"> <span class="type">dev_t</span> st_rdev; <span class="comment">/* è®¾å¤‡å·ï¼ˆæŒ‡é’ˆå¯¹è®¾å¤‡æ–‡ä»¶ï¼‰ */</span></span><br><span class="line"> <span class="type">off_t</span> st_size; <span class="comment">/* æ–‡ä»¶å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ */</span></span><br><span class="line"> <span class="type">blksize_t</span> st_blksize; <span class="comment">/* æ–‡ä»¶å†…å®¹å­˜å‚¨çš„å—å¤§å° */</span></span><br><span class="line"> <span class="type">blkcnt_t</span> st_blocks; <span class="comment">/* æ–‡ä»¶å†…å®¹æ‰€å å—æ•° */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_atim</span>;</span> <span class="comment">/* æ–‡ä»¶æœ€åè¢«è®¿é—®çš„æ—¶é—´ */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_mtim</span>;</span> <span class="comment">/* æ–‡ä»¶å†…å®¹æœ€åè¢«ä¿®æ”¹çš„æ—¶é—´ */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_ctim</span>;</span> <span class="comment">/* æ–‡ä»¶çŠ¶æ€æœ€åè¢«æ”¹å˜çš„æ—¶é—´ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="st-modeå˜é‡"><a href="#st-modeå˜é‡" class="headerlink" title="st_modeå˜é‡"></a>st_modeå˜é‡</h4><p>st_mode æ˜¯ structstat ç»“æ„ä½“ä¸­çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œæ˜¯ä¸€ä¸ª 32 ä½æ— ç¬¦å·æ•´å½¢æ•°æ®ï¼Œè¯¥å˜é‡è®°å½•äº†æ–‡ä»¶çš„ç±»å‹ã€æ–‡ä»¶çš„æƒé™è¿™äº›ä¿¡æ¯ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/st_mode.png"></p><p>è¿™äº› bit ä½è¡¨è¾¾å†…å®¹ä¸ open å‡½æ•°çš„ mode å‚æ•°ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸å†é‡è¿°ã€‚åŒæ ·ï¼Œåœ¨ mode å‚æ•°ä¸­è¡¨ç¤ºæƒé™çš„å®å®šä¹‰ï¼Œåœ¨è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œè¿™äº›å®å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">S_IRWXU 00700 owner has read, write, and execute permission</span><br><span class="line">S_IRUSR 00400 owner has read permission</span><br><span class="line">S_IWUSR 00200 owner has write permission</span><br><span class="line">S_IXUSR 00100 owner has execute permission</span><br><span class="line">S_IRWXG 00070 group has read, write, and execute permission</span><br><span class="line">S_IRGRP 00040 group has read permission</span><br><span class="line">S_IWGRP 00020 group has write permission</span><br><span class="line">S_IXGRP 00010 group has execute permission</span><br><span class="line">S_IRWXO 00007 others (not in group) have read, write, and execute permission</span><br><span class="line">S_IROTH 00004 others have read permission</span><br><span class="line">S_IWOTH 00002 others have write permission</span><br><span class="line">S_IXOTH 00001 others have execute permission</span><br><span class="line"></span><br><span class="line">S_IFSOCK 0140000 socketï¼ˆå¥—æ¥å­—æ–‡ä»¶ï¼‰</span><br><span class="line">S_IFLNK 0120000 symbolic linkï¼ˆé“¾æ¥æ–‡ä»¶ï¼‰</span><br><span class="line">S_IFREG 0100000 regular fileï¼ˆæ™®é€šæ–‡ä»¶ï¼‰</span><br><span class="line">S_IFBLK 0060000 block deviceï¼ˆå—è®¾å¤‡æ–‡ä»¶ï¼‰</span><br><span class="line">S_IFDIR 0040000 directoryï¼ˆç›®å½•ï¼‰</span><br><span class="line">S_IFCHR 0020000 character deviceï¼ˆå­—ç¬¦è®¾å¤‡æ–‡ä»¶ï¼‰</span><br><span class="line">S_IFIFO 0010000 FIFOï¼ˆç®¡é“æ–‡ä»¶ï¼‰</span><br><span class="line"></span><br><span class="line">S_ISREG(m) #åˆ¤æ–­æ˜¯ä¸æ˜¯æ™®é€šæ–‡ä»¶ï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span><br><span class="line">S_ISDIR(m) #åˆ¤æ–­æ˜¯ä¸æ˜¯ç›®å½•ï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span><br><span class="line">S_ISCHR(m) #åˆ¤æ–­æ˜¯ä¸æ˜¯å­—ç¬¦è®¾å¤‡æ–‡ä»¶ï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span><br><span class="line">S_ISBLK(m) #åˆ¤æ–­æ˜¯ä¸æ˜¯å—è®¾å¤‡æ–‡ä»¶ï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span><br><span class="line">S_ISFIFO(m) #åˆ¤æ–­æ˜¯ä¸æ˜¯ç®¡é“æ–‡ä»¶ï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span><br><span class="line">S_ISLNK(m) #åˆ¤æ–­æ˜¯ä¸æ˜¯é“¾æ¥æ–‡ä»¶ï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span><br><span class="line">S_ISSOCK(m) #åˆ¤æ–­æ˜¯ä¸æ˜¯å¥—æ¥å­—æ–‡ä»¶ï¼Œå¦‚æœæ˜¯è¿”å› trueï¼Œå¦åˆ™è¿”å› false</span><br></pre></td></tr></table></figure><h4 id="struct-timespecç»“æ„ä½“"><a href="#struct-timespecç»“æ„ä½“" class="headerlink" title="struct timespecç»“æ„ä½“"></a>struct timespecç»“æ„ä½“</h4><p>è¯¥ç»“æ„ä½“å®šä¹‰åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œæ˜¯ Linux ç³»ç»Ÿä¸­æ—¶é—´ç›¸å…³çš„ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="type">time_t</span> tv_sec; <span class="comment">/* ç§’ */</span></span><br><span class="line"> <span class="type">syscall_slong_t</span> tv_nsec; <span class="comment">/* çº³ç§’ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="fstatå’Œlstatå‡½æ•°"><a href="#fstatå’Œlstatå‡½æ•°" class="headerlink" title="fstatå’Œlstatå‡½æ•°"></a>fstatå’Œlstatå‡½æ•°</h4><p><strong>fstatå‡½æ•°</strong></p><p>fstat ä¸ stat åŒºåˆ«åœ¨äºï¼Œstat æ˜¯ä»æ–‡ä»¶åå‡ºå‘å¾—åˆ°æ–‡ä»¶å±æ€§ä¿¡æ¯ï¼Œä¸éœ€è¦å…ˆæ‰“å¼€æ–‡ä»¶ï¼›è€Œ fstat å‡½æ•°åˆ™æ˜¯ä»æ–‡ä»¶æè¿°ç¬¦å‡ºå‘å¾—åˆ°æ–‡ä»¶å±æ€§ä¿¡æ¯ï¼Œæ‰€ä»¥ä½¿ç”¨ fstat å‡½æ•°ä¹‹å‰éœ€è¦å…ˆæ‰“å¼€æ–‡ä»¶å¾—åˆ°æ–‡ä»¶æè¿°ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fstat</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> stat *buf)</span>;</span><br></pre></td></tr></table></figure><p><strong>lstat å‡½æ•°</strong></p><p>lstat()ä¸ statã€fstat çš„åŒºåˆ«åœ¨äºï¼Œå¯¹äºç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œstatã€fstat æŸ¥é˜…çš„æ˜¯ç¬¦å·é“¾æ¥æ–‡ä»¶æ‰€æŒ‡å‘çš„æ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶å±æ€§ä¿¡æ¯ï¼Œè€Œ lstat æŸ¥é˜…çš„æ˜¯ç¬¦å·é“¾æ¥æ–‡ä»¶æœ¬èº«çš„å±æ€§ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">lstat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="keyword">struct</span> stat *buf)</span>;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶å±ä¸»"><a href="#æ–‡ä»¶å±ä¸»" class="headerlink" title="æ–‡ä»¶å±ä¸»"></a>æ–‡ä»¶å±ä¸»</h3><p>Linux æ˜¯ä¸€ä¸ªå¤šç”¨æˆ·æ“ä½œç³»ç»Ÿï¼Œç³»ç»Ÿä¸­ä¸€èˆ¬å­˜åœ¨ç€å¥½å‡ ä¸ªä¸åŒçš„ç”¨æˆ·ï¼Œè€Œ Linux ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³è”çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œé€šè¿‡è¿™ä¸ªä¿¡æ¯å¯ä»¥åˆ¤æ–­æ–‡ä»¶çš„æ‰€æœ‰è€…å’Œæ‰€å±ç»„ã€‚</p><p>æ–‡ä»¶æ‰€æœ‰è€…è¡¨ç¤ºè¯¥æ–‡ä»¶å±äºâ€œè°â€ï¼Œä¹Ÿå°±æ˜¯å±äºå“ªä¸ªç”¨æˆ·ã€‚ä¸€èˆ¬æ¥è¯´æ–‡ä»¶åœ¨åˆ›å»ºæ—¶ï¼Œå…¶æ‰€æœ‰è€…å°±æ˜¯åˆ›å»ºè¯¥æ–‡ä»¶çš„é‚£ä¸ªç”¨æˆ·ã€‚æ–‡ä»¶æ‰€å±ç»„åˆ™è¡¨ç¤ºè¯¥æ–‡ä»¶å±äºå“ªä¸€ä¸ªç”¨æˆ·ç»„ã€‚åœ¨ Linux ä¸­ï¼Œç³»ç»Ÿå¹¶ä¸æ˜¯é€šè¿‡ç”¨æˆ·åæˆ–ç”¨æˆ·ç»„åæ¥è¯†åˆ«ä¸åŒçš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œè€Œæ˜¯é€šè¿‡ IDã€‚ID å°±æ˜¯ä¸€ä¸ªç¼–å·ï¼ŒLinux ç³»ç»Ÿä¼šä¸ºæ¯ä¸€ä¸ªç”¨æˆ·æˆ–ç”¨æˆ·ç»„åˆ†é…ä¸€ä¸ª IDï¼Œå°†ç”¨æˆ·åæˆ–ç”¨æˆ·ç»„åä¸å¯¹åº”çš„ ID å…³è”èµ·æ¥ï¼Œæ‰€ä»¥ç³»ç»Ÿé€šè¿‡ç”¨æˆ· IDï¼ˆUIDï¼‰æˆ–ç»„ IDï¼ˆGIDï¼‰å°±å¯ä»¥è¯†åˆ«å‡ºä¸åŒçš„ç”¨æˆ·å’Œç”¨ç»„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/ID.png"></p><h4 id="æœ‰æ•ˆç”¨æˆ·-ID-å’Œæœ‰æ•ˆç»„-ID"><a href="#æœ‰æ•ˆç”¨æˆ·-ID-å’Œæœ‰æ•ˆç»„-ID" class="headerlink" title="æœ‰æ•ˆç”¨æˆ· ID å’Œæœ‰æ•ˆç»„ ID"></a>æœ‰æ•ˆç”¨æˆ· ID å’Œæœ‰æ•ˆç»„ ID</h4><p>è¿™æ˜¯è¿›ç¨‹æ‰€æŒæœ‰çš„æ¦‚å¿µï¼Œå¯¹äºæ–‡ä»¶æ¥è¯´ï¼Œå¹¶æ— æ­¤å±æ€§ï¼æœ‰æ•ˆç”¨æˆ· ID å’Œæœ‰æ•ˆç»„ ID æ˜¯ç«™åœ¨æ“ä½œç³»ç»Ÿçš„è§’åº¦ï¼Œç”¨äºç»™æ“ä½œç³»ç»Ÿåˆ¤æ–­å½“å‰æ‰§è¡Œè¯¥è¿›ç¨‹çš„ç”¨æˆ·åœ¨å½“å‰ç¯å¢ƒä¸‹å¯¹æŸä¸ªæ–‡ä»¶æ˜¯å¦æ‹¥æœ‰ç›¸åº”çš„æƒé™ã€‚</p><p>å½“è¿›è¡Œæƒé™æ£€æŸ¥æ—¶ï¼Œå¹¶ä¸æ˜¯é€šè¿‡è¿›ç¨‹çš„å®é™…ç”¨æˆ·å’Œå®é™…ç»„æ¥å‚ä¸æƒé™æ£€æŸ¥çš„ï¼Œè€Œæ˜¯é€šè¿‡æœ‰æ•ˆç”¨æˆ·å’Œæœ‰æ•ˆç»„æ¥å‚ä¸æ–‡ä»¶æƒé™æ£€æŸ¥ã€‚</p><p><strong>chownå‡½æ•°</strong></p><p>chown æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨å¯ç”¨äºæ”¹å˜æ–‡ä»¶çš„æ‰€æœ‰è€…ï¼ˆç”¨æˆ· IDï¼‰å’Œæ‰€å±ç»„ï¼ˆç»„ IDï¼‰ã€‚å…¶å®åœ¨Linux ç³»ç»Ÿä¸‹ä¹Ÿæœ‰ä¸€ä¸ª chown å‘½ä»¤ï¼Œè¯¥å‘½ä»¤çš„ä½œç”¨ä¹Ÿæ˜¯ç”¨äºæ”¹å˜æ–‡ä»¶çš„æ‰€æœ‰è€…å’Œæ‰€å±ç»„ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">chown</span> root:root testApp.c<span class="comment">##è¯¥å‘½ä»¤çš„ä½œç”¨ä¹Ÿæ˜¯ç”¨äºæ”¹å˜æ–‡ä»¶çš„æ‰€æœ‰è€…å’Œæ‰€å±ç»„</span></span></span><br></pre></td></tr></table></figure><h4 id="chownå‡½æ•°åŸå‹"><a href="#chownå‡½æ•°åŸå‹" class="headerlink" title="chownå‡½æ•°åŸå‹"></a>chownå‡½æ•°åŸå‹</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">chown</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">uid_t</span> owner, <span class="type">gid_t</span> group)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š<br>pathnameï¼šç”¨äºæŒ‡å®šä¸€ä¸ªéœ€è¦ä¿®æ”¹æ‰€æœ‰è€…å’Œæ‰€å±ç»„çš„æ–‡ä»¶è·¯å¾„ã€‚<br>ownerï¼šå°†æ–‡ä»¶çš„æ‰€æœ‰è€…ä¿®æ”¹ä¸ºè¯¥å‚æ•°æŒ‡å®šçš„ç”¨æˆ·ï¼ˆä»¥ç”¨æˆ· ID çš„å½¢å¼æè¿°ï¼‰ï¼›<br>groupï¼šå°†æ–‡ä»¶çš„æ‰€å±ç»„ä¿®æ”¹ä¸ºè¯¥å‚æ•°æŒ‡å®šçš„ç”¨æˆ·ç»„ï¼ˆä»¥ç”¨æˆ·ç»„ ID çš„å½¢å¼æè¿°ï¼‰ï¼›<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå…µå¹¶ä¸”ä¼šè®¾ç½® errnoã€‚</p><p>æœ‰ä»¥ä¸‹ä¸¤ä¸ªé™åˆ¶æ¡ä»¶ï¼š</p><p>âš« åªæœ‰è¶…çº§ç”¨æˆ·è¿›ç¨‹èƒ½æ›´æ”¹æ–‡ä»¶çš„ç”¨æˆ· IDï¼›<br>âš« æ™®é€šç”¨æˆ·è¿›ç¨‹å¯ä»¥å°†æ–‡ä»¶çš„ç»„ ID ä¿®æ”¹ä¸ºå…¶æ‰€ä»å±çš„ä»»æ„é™„å±ç»„ IDï¼Œå‰ææ¡ä»¶æ˜¯è¯¥è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID ç­‰äºæ–‡ä»¶çš„ç”¨æˆ· IDï¼›è€Œè¶…çº§ç”¨æˆ·è¿›ç¨‹å¯ä»¥å°†æ–‡ä»¶çš„ç»„ ID ä¿®æ”¹ä¸ºä»»æ„å€¼ã€‚</p><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == chown(<span class="string">&quot;./test_file&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)) &#123;</span><br><span class="line"> perror(<span class="string">&quot;chown error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Linux ç³»ç»Ÿä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ getuid å’Œ getgid ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åˆ†åˆ«ç”¨äºè·å–å½“å‰è¿›ç¨‹çš„ç”¨æˆ· ID å’Œç”¨æˆ·ç»„IDï¼Œè¿™é‡Œè¯´çš„è¿›ç¨‹çš„ç”¨æˆ· ID å’Œç”¨æˆ·ç»„ ID æŒ‡çš„å°±æ˜¯è¿›ç¨‹çš„å®é™…ç”¨æˆ· ID å’Œå®é™…ç»„ IDã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">getuid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">gid_t</span> <span class="title function_">getgid</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;uid: %d\n&quot;</span>, getuid());</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == chown(<span class="string">&quot;./test_file&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)) &#123;</span><br><span class="line"> perror(<span class="string">&quot;chown error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶è®¿é—®æƒé™"><a href="#æ–‡ä»¶è®¿é—®æƒé™" class="headerlink" title="æ–‡ä»¶è®¿é—®æƒé™"></a>æ–‡ä»¶è®¿é—®æƒé™</h3><p>struct stat ç»“æ„ä½“ä¸­çš„ st_mode å­—æ®µè®°å½•äº†æ–‡ä»¶çš„è®¿é—®æƒé™ä½ã€‚å½“æåŠåˆ°æ–‡ä»¶æ—¶ï¼Œå¹¶ä¸ä»…ä»…æŒ‡çš„æ˜¯æ™®é€šæ–‡ä»¶ï¼›æ‰€æœ‰æ–‡ä»¶ç±»å‹ï¼ˆç›®å½•ã€è®¾å¤‡æ–‡ä»¶ï¼‰éƒ½æœ‰è®¿é—®æƒé™ï¼ˆaccess permissionï¼‰ã€‚</p><p>æ–‡ä»¶çš„æƒé™å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼Œåˆ†åˆ«æ˜¯<u>æ™®é€šæƒé™å’Œç‰¹æ®Šæƒé™</u>ï¼ˆä¹Ÿå¯ç§°ä¸ºé™„åŠ æƒé™ï¼‰ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls-l##æŸ¥çœ‹è®¿é—®æƒé™</span><br></pre></td></tr></table></figure><p><strong><u>-rwxrwxr-x</u></strong></p><p>-è¡¨ç¤ºæ–‡ä»¶ç±»å‹ï¼Œå‰ä¸‰ä½rwxä¸ºæ‰€æœ‰è€…æƒé™ï¼Œä¸­é—´ä¸‰ä½ä¸ºåŒç»„ç”¨æˆ·æƒé™ï¼Œåä¸‰ä½ä¸ºå…¶å®ƒç”¨æˆ·æƒé™ã€‚</p><p>rè¡¨ç¤ºå…·æœ‰è¯»æƒé™ï¼›wè¡¨ç¤ºå…·æœ‰å†™æƒé™ï¼›xè¡¨ç¤ºå…·æœ‰æ‰§è¡Œæƒé™ï¼›-è¡¨ç¤ºæ²¡æœ‰æƒé™</p><p><em><strong>å½“è¿›ç¨‹æ¯æ¬¡å¯¹æ–‡ä»¶è¿›è¡Œè¯»ã€å†™ã€æ‰§è¡Œç­‰æ“ä½œæ—¶ï¼Œå†…æ ¸å°±ä¼šå¯¹æ–‡ä»¶è¿›è¡Œè®¿é—®æƒé™æ£€æŸ¥ï¼Œä»¥ç¡®å®šè¯¥è¿›ç¨‹å¯¹æ–‡ä»¶æ˜¯å¦æ‹¥æœ‰ç›¸åº”çš„æƒé™ã€‚</strong></em>è€Œå¯¹äºè¿›ç¨‹æ¥è¯´ï¼Œå‚ä¸æ–‡ä»¶æƒé™æ£€æŸ¥çš„æ˜¯è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ·ã€æœ‰æ•ˆç”¨æˆ·ç»„ä»¥åŠè¿›ç¨‹çš„é™„å±ç»„ç”¨æˆ·ã€‚</p><p>å¦‚ä½•åˆ¤æ–­æƒé™ï¼Œé¦–å…ˆè¦ææ¸…æ¥šè¯¥è¿›ç¨‹å¯¹äºéœ€è¦è¿›è¡Œæ“ä½œçš„æ–‡ä»¶æ¥è¯´æ˜¯å±äºå“ªä¸€ç±»â€œè§’è‰²â€ï¼š<br>âš« å¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID ç­‰äºæ–‡ä»¶æ‰€æœ‰è€… IDï¼ˆst_uidï¼‰ï¼Œæ„å‘³ç€è¯¥è¿›ç¨‹ä»¥æ–‡ä»¶æ‰€æœ‰è€…çš„è§’è‰²å­˜åœ¨ï¼›<br>âš« å¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID å¹¶ä¸ç­‰äºæ–‡ä»¶æ‰€æœ‰è€… IDï¼Œæ„å‘³ç€è¯¥è¿›ç¨‹å¹¶ä¸æ˜¯æ–‡ä»¶æ‰€æœ‰è€…èº«ä»½ï¼›ä½†æ˜¯è¿›ç¨‹<br>çš„æœ‰æ•ˆç”¨æˆ·ç»„ ID æˆ–è¿›ç¨‹çš„é™„å±ç»„ ID ä¹‹ä¸€ç­‰äºæ–‡ä»¶çš„ç»„ IDï¼ˆst_gidï¼‰ï¼Œé‚£ä¹ˆæ„å‘³ç€è¯¥è¿›ç¨‹ä»¥æ–‡ä»¶æ‰€<br>å±ç»„æˆå‘˜çš„è§’è‰²å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶æ‰€å±ç»„çš„åŒç»„ç”¨æˆ·æˆå‘˜ã€‚<br>âš« å¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID ä¸ç­‰äºæ–‡ä»¶æ‰€æœ‰è€… IDã€å¹¶ä¸”è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ·ç»„ ID æˆ–è¿›ç¨‹çš„æ‰€æœ‰é™„å±ç»„ ID<br>å‡ä¸ç­‰äºæ–‡ä»¶çš„ç»„ IDï¼ˆst_gidï¼‰ï¼Œé‚£ä¹ˆæ„å‘³ç€è¯¥è¿›ç¨‹ä»¥å…¶å®ƒç”¨æˆ·çš„è§’è‰²å­˜åœ¨ã€‚<br>âš« å¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID ç­‰äº 0ï¼ˆroot ç”¨æˆ·ï¼‰ï¼Œåˆ™æ— éœ€è¿›è¡Œæƒé™æ£€æŸ¥ï¼Œç›´æ¥å¯¹è¯¥æ–‡ä»¶æ‹¥æœ‰æœ€é«˜æƒé™ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/%E7%89%B9%E6%AE%8A%E6%9D%83%E9%99%90.png"></p><p>å®å®šä¹‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">S_ISUID 04000 set-user-ID bit</span><br><span class="line">S_ISGID 02000 set-group-ID bit (see below)</span><br><span class="line">S_ISVTX 01000 sticky bit (see below)</span><br></pre></td></tr></table></figure><p>è­¬å¦‚é€šè¿‡ st_mode å˜é‡åˆ¤æ–­æ–‡ä»¶æ˜¯å¦è®¾ç½®äº† set-user-ID ä½æƒé™ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (st.st_mode &amp; S_ISUID) &#123;</span><br><span class="line"><span class="comment">//è®¾ç½®äº† set-user-ID ä½æƒé™</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//æ²¡æœ‰è®¾ç½® set-user-ID ä½æƒé™</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‰ç§æƒé™ä½çš„å…·ä½“ä½œç”¨ï¼š</p><p>âš« å½“è¿›ç¨‹å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œçš„æ—¶å€™ã€å°†è¿›è¡Œæƒé™æ£€æŸ¥ï¼Œå¦‚æœæ–‡ä»¶çš„ set-user-ID ä½æƒé™è¢«è®¾ç½®ï¼Œå†…æ ¸ä¼šå°†è¿›ç¨‹çš„æœ‰æ•ˆ ID è®¾ç½®ä¸ºè¯¥æ–‡ä»¶çš„ç”¨æˆ· IDï¼ˆæ–‡ä»¶æ‰€æœ‰è€… IDï¼‰ï¼Œæ„å‘³ç€è¯¥è¿›ç¨‹ç›´æ¥è·å–äº†æ–‡ä»¶æ‰€æœ‰çš„æƒé™ã€ä»¥æ–‡ä»¶æ‰€æœ‰è€…çš„èº«ä»½æ“ä½œè¯¥æ–‡ä»¶ã€‚<br>âš« å½“è¿›ç¨‹å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œçš„æ—¶å€™ã€å°†è¿›è¡Œæƒé™æ£€æŸ¥ï¼Œå¦‚æœæ–‡ä»¶çš„ set-group-ID ä½æƒé™è¢«è®¾ç½®ï¼Œå†…æ ¸ä¼šå°†è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ·ç»„ ID è®¾ç½®ä¸ºè¯¥æ–‡ä»¶çš„ç”¨æˆ·ç»„ IDï¼ˆæ–‡ä»¶æ‰€å±ç»„ IDï¼‰ï¼Œæ„å‘³ç€è¯¥è¿›ç¨‹ç›´æ¥è·å–äº†æ–‡ä»¶æ‰€å±ç»„æˆå‘˜çš„æƒé™ã€ä»¥æ–‡ä»¶æ‰€å±ç»„æˆå‘˜çš„èº«ä»½æ“ä½œè¯¥æ–‡ä»¶ã€‚</p><h4 id="ç›®å½•æƒé™"><a href="#ç›®å½•æƒé™" class="headerlink" title="ç›®å½•æƒé™"></a>ç›®å½•æƒé™</h4><p>âš« ç›®å½•çš„è¯»æƒé™ï¼šå¯åˆ—å‡ºï¼ˆè­¬å¦‚ï¼šé€šè¿‡ ls å‘½ä»¤ï¼‰ç›®å½•ä¹‹ä¸‹çš„å†…å®¹ï¼ˆå³ç›®å½•ä¸‹æœ‰å“ªäº›æ–‡ä»¶ï¼‰ã€‚<br>âš« ç›®å½•çš„å†™æƒé™ï¼šå¯ä»¥åœ¨ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ã€‚<br>âš« ç›®å½•çš„æ‰§è¡Œæƒé™ï¼šå¯è®¿é—®ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œè­¬å¦‚å¯¹ç›®å½•ä¸‹çš„æ–‡ä»¶è¿›è¡Œè¯»ã€å†™ã€æ‰§è¡Œç­‰æ“ä½œã€‚</p><p>è¦æƒ³è®¿é—®ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œè­¬å¦‚æŸ¥çœ‹æ–‡ä»¶çš„ inode èŠ‚ç‚¹ã€å¤§å°ã€æƒé™ç­‰ä¿¡æ¯ï¼Œè¿˜éœ€è¦å¯¹ç›®å½•æ‹¥æœ‰æ‰§è¡Œæƒé™ã€‚åä¹‹ï¼Œè‹¥æ‹¥æœ‰å¯¹ç›®å½•çš„æ‰§è¡Œæƒé™ã€è€Œæ— è¯»æƒé™ï¼Œåªè¦çŸ¥é“ç›®å½•å†…æ–‡ä»¶çš„åç§°ï¼Œä»å¯å¯¹å…¶è¿›è¡Œè®¿é—®ï¼Œä½†ä¸èƒ½åˆ—å‡ºç›®å½•ä¸‹çš„å†…å®¹ï¼ˆå³ç›®å½•ä¸‹åŒ…å«çš„å…¶å®ƒæ–‡ä»¶çš„åç§°ï¼‰ã€‚è¦æƒ³åœ¨ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶æˆ–åˆ é™¤åŸæœ‰æ–‡ä»¶ï¼Œéœ€è¦åŒæ—¶æ‹¥æœ‰å¯¹è¯¥ç›®å½•çš„æ‰§è¡Œå’Œå†™æƒé™ã€‚</p><h4 id="æ£€æŸ¥æ–‡ä»¶æƒé™"><a href="#æ£€æŸ¥æ–‡ä»¶æƒé™" class="headerlink" title="æ£€æŸ¥æ–‡ä»¶æƒé™"></a>æ£€æŸ¥æ–‡ä»¶æƒé™</h4><p>æ–‡ä»¶çš„æƒé™æ£€æŸ¥ä¸åªå…³äºæ–‡ä»¶æœ¬èº«çš„æƒé™ï¼Œè¿˜éœ€è¦æ¶‰åŠåˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„æƒé™ï¼Œåªæœ‰åŒæ—¶éƒ½æ»¡è¶³äº†ï¼Œæ‰èƒ½é€šè¿‡æ“ä½œç³»ç»Ÿçš„æƒé™æ£€æŸ¥ï¼Œè¿›è€Œæ‰å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œç›¸å…³æ“ä½œã€‚å¯ä»¥é€šè¿‡accessæ¥æ£€æŸ¥æ‰§è¡Œè¿›ç¨‹çš„ç”¨æˆ·æ˜¯å¦å¯¹è¯¥æ–‡ä»¶æ‹¥æœ‰åº”çš„æƒé™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">access</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> mode)</span>;</span><br></pre></td></tr></table></figure><p>pathnameï¼šéœ€è¦è¿›è¡Œæƒé™æ£€æŸ¥çš„æ–‡ä»¶è·¯å¾„ã€‚<br>modeï¼šè¯¥å‚æ•°å¯ä»¥å–ä»¥ä¸‹å€¼ï¼š<br>pathnameï¼šéœ€è¦è¿›è¡Œæƒé™æ£€æŸ¥çš„æ–‡ä»¶è·¯å¾„ã€‚<br>modeï¼šè¯¥å‚æ•°å¯ä»¥å–ä»¥ä¸‹å€¼ï¼š<br>âš« F_OKï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>âš« R_OKï¼šæ£€æŸ¥æ˜¯å¦æ‹¥æœ‰è¯»æƒé™<br>âš« W_OKï¼šæ£€æŸ¥æ˜¯å¦æ‹¥æœ‰å†™æƒé™<br>âš« X_OKï¼šæ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æ‰§è¡Œæƒé™</p><p>è¿”å›å€¼ï¼šæ£€æŸ¥é¡¹é€šè¿‡åˆ™è¿”å› 0ï¼Œè¡¨ç¤ºæ‹¥æœ‰ç›¸åº”çš„æƒé™å¹¶ä¸”æ–‡ä»¶å­˜åœ¨ï¼›å¦åˆ™è¿”å›-1ï¼Œå¦‚æœå¤šä¸ªæ£€æŸ¥é¡¹ç»„åˆåœ¨ä¸€èµ·ï¼Œåªè¦å…¶ä¸­ä»»ä½•ä¸€é¡¹ä¸é€šè¿‡éƒ½ä¼šè¿”å›-1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_FILE <span class="string">&quot;./test_file&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="comment">/* æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ */</span></span><br><span class="line"> ret = access(MY_FILE, F_OK);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) </span><br><span class="line">    &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;%: file does not exist.\n&quot;</span>, MY_FILE);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* æ£€æŸ¥æƒé™ */</span></span><br><span class="line"> ret = access(MY_FILE, R_OK);</span><br><span class="line"> <span class="keyword">if</span> (!ret)</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Read permission: Yes\n&quot;</span>);</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Read permission: NO\n&quot;</span>);</span><br><span class="line"> ret = access(MY_FILE, W_OK);</span><br><span class="line"> <span class="keyword">if</span> (!ret)</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Write permission: Yes\n&quot;</span>);</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Write permission: NO\n&quot;</span>);</span><br><span class="line"> ret = access(MY_FILE, X_OK);</span><br><span class="line"> <span class="keyword">if</span> (!ret)</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Execution permission: Yes\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Execution permission: NO\n&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹æ–‡ä»¶æƒé™"><a href="#ä¿®æ”¹æ–‡ä»¶æƒé™" class="headerlink" title="ä¿®æ”¹æ–‡ä»¶æƒé™"></a>ä¿®æ”¹æ–‡ä»¶æƒé™</h4><p>åœ¨ Linux ç³»ç»Ÿä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ chmod å‘½ä»¤ä¿®æ”¹æ–‡ä»¶æƒé™ï¼Œè¯¥å‘½ä»¤å†…éƒ¨å®ç°æ–¹æ³•å…¶å®æ˜¯è°ƒç”¨äº† chmod å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">chmod</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">mode_t</span> mode)</span>;</span><br></pre></td></tr></table></figure><p>pathnameï¼šéœ€è¦è¿›è¡Œæƒé™ä¿®æ”¹çš„æ–‡ä»¶è·¯å¾„ï¼Œè‹¥è¯¥å‚æ•°æ‰€æŒ‡ä¸ºç¬¦å·é“¾æ¥ï¼Œå®é™…æ”¹å˜æƒé™çš„æ–‡ä»¶æ˜¯ç¬¦å·é“¾æ¥æ‰€æŒ‡å‘çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç¬¦å·é“¾æ¥æ–‡ä»¶æœ¬èº«ã€‚<br>modeï¼šè¯¥å‚æ•°ç”¨äºæè¿°æ–‡ä»¶æƒé™ï¼Œä¸ open å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¸€æ ·ï¼Œè¿™é‡Œä¸å†é‡è¿°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å…«è¿›åˆ¶æ•°æ®æ¥æè¿°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸åº”çš„æƒé™å®ï¼ˆå•ä¸ªæˆ–é€šè¿‡ä½æˆ–è¿ç®—ç¬¦â€ | â€œç»„åˆï¼‰ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p>fchmod()ä¸ chmod()çš„åŒºåˆ«åœ¨äºä½¿ç”¨äº†æ–‡ä»¶æè¿°ç¬¦æ¥ä»£æ›¿æ–‡ä»¶è·¯å¾„ï¼Œå°±åƒæ˜¯ fstat ä¸ stat çš„åŒºåˆ«ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fchmod</span><span class="params">(<span class="type">int</span> fd, <span class="type">mode_t</span> mode)</span>;</span><br></pre></td></tr></table></figure><h4 id="umaskå‡½æ•°"><a href="#umaskå‡½æ•°" class="headerlink" title="umaskå‡½æ•°"></a>umaskå‡½æ•°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ umask##æŸ¥çœ‹/è®¾ç½®æƒé™æ©ç </span><br></pre></td></tr></table></figure><p>æƒé™æ©ç ä¸»è¦ç”¨äºå¯¹æ–°å»ºæ–‡ä»¶çš„æƒé™è¿›è¡Œå±è”½ã€‚æƒé™æ©ç çš„è¡¨ç¤ºæ–¹å¼ä¸æ–‡ä»¶æƒé™çš„è¡¨ç¤ºæ–¹å¼ç›¸åŒï¼Œä½†æ˜¯éœ€è¦å»é™¤ç‰¹æ®Šæƒé™ä½ï¼Œumask ä¸èƒ½å¯¹ç‰¹æ®Šæƒé™ä½è¿›è¡Œå±è”½ã€‚</p><p>umask æƒé™æ©ç æ˜¯è¿›ç¨‹çš„ä¸€ç§å±æ€§ï¼Œç”¨äºæŒ‡æ˜è¯¥è¿›ç¨‹æ–°å»ºæ–‡ä»¶æˆ–ç›®å½•æ—¶ï¼Œåº”å±è”½å“ªäº›æƒé™ä½ã€‚è¿›ç¨‹çš„umask é€šå¸¸ç»§æ‰¿è‡³å…¶çˆ¶è¿›ç¨‹ï¼Œè­¬å¦‚åœ¨ Ubuntu shellç»ˆç«¯ä¸‹æ‰§è¡Œçš„åº”ç”¨ç¨‹åºï¼Œå®ƒçš„ umask ç»§æ‰¿è‡³è¯¥ shell è¿›ç¨‹ã€‚</p><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">mode_t</span> <span class="title function_">umask</span><span class="params">(<span class="type">mode_t</span> mask)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>maskï¼šéœ€è¦è®¾ç½®çš„æƒé™æ©ç å€¼ï¼Œå¯ä»¥å‘ç° make å‚æ•°çš„ç±»å‹ä¸ open å‡½æ•°ã€chmod å‡½æ•°ä¸­çš„ mode å‚æ•°å¯¹åº”çš„ç±»å‹ä¸€æ ·ï¼Œæ‰€ä»¥å…¶è¡¨ç¤ºæ–¹å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå‰é¢ä¹Ÿç»™å¤§å®¶ä»‹ç»äº†ï¼Œæ—¢å¯ä»¥ä½¿ç”¨æ•°å­—è¡¨ç¤ºï¼ˆè­¬å¦‚å…«è¿›åˆ¶æ•°ï¼‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å®ï¼ˆS_IRUSRã€S_IWUSR ç­‰ï¼‰ã€‚<br>è¿”å›å€¼ï¼šè¿”å›è®¾ç½®ä¹‹å‰çš„ umask å€¼ï¼Œä¹Ÿå°±æ˜¯æ—§çš„ umaskã€‚</p><h3 id="æ–‡ä»¶çš„æ—¶é—´å±æ€§"><a href="#æ–‡ä»¶çš„æ—¶é—´å±æ€§" class="headerlink" title="æ–‡ä»¶çš„æ—¶é—´å±æ€§"></a>æ–‡ä»¶çš„æ—¶é—´å±æ€§</h3><p>æ–‡ä»¶æœ€åè¢«è®¿é—®çš„æ—¶é—´ã€æ–‡ä»¶å†…å®¹æœ€åè¢«ä¿®æ”¹çš„æ—¶é—´ä»¥åŠæ–‡ä»¶çŠ¶æ€æœ€åè¢«æ”¹å˜çš„æ—¶é—´ï¼Œåˆ†åˆ«è®°å½•åœ¨ struct stat ç»“æ„ä½“çš„ st_atimã€st_mtim ä»¥åŠ st_ctim å˜é‡ä¸­ã€‚</p><table><thead><tr><th align="center">å­—æ®µ</th><th align="center">è¯´æ˜</th></tr></thead><tbody><tr><td align="center">st_atim</td><td align="center">æ–‡ä»¶æœ€åè¢«è®¿é—®çš„æ—¶é—´</td></tr><tr><td align="center">st_mtim</td><td align="center">æ–‡ä»¶å†…å®¹æœ€åè¢«ä¿®æ”¹çš„æ—¶é—´</td></tr><tr><td align="center">st_ctim</td><td align="center">æ–‡ä»¶çŠ¶æ€æœ€åè¢«æ”¹å˜çš„æ—¶é—´</td></tr></tbody></table><p>âš« æ–‡ä»¶æœ€åè¢«è®¿é—®çš„æ—¶é—´ï¼šè®¿é—®æŒ‡çš„æ˜¯è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ–‡ä»¶å†…å®¹æœ€åä¸€æ¬¡è¢«è¯»å–çš„æ—¶é—´ï¼Œè­¬å¦‚ä½¿ç”¨read()å‡½æ•°è¯»å–æ–‡ä»¶å†…å®¹ä¾¿ä¼šæ”¹å˜è¯¥æ—¶é—´å±æ€§ï¼›<br>âš« æ–‡ä»¶å†…å®¹æœ€åè¢«ä¿®æ”¹çš„æ—¶é—´ï¼šæ–‡ä»¶å†…å®¹å‘ç”Ÿæ”¹å˜ï¼Œè­¬å¦‚ä½¿ç”¨ write()å‡½æ•°å†™å…¥æ•°æ®åˆ°æ–‡ä»¶ä¸­ä¾¿ä¼šæ”¹å˜è¯¥æ—¶é—´å±æ€§ï¼›<br>âš« æ–‡ä»¶çŠ¶æ€æœ€åè¢«æ”¹å˜çš„æ—¶é—´ï¼šçŠ¶æ€æ›´æ”¹æŒ‡çš„æ˜¯è¯¥æ–‡ä»¶çš„ inode èŠ‚ç‚¹æœ€åä¸€æ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´ï¼Œè­¬å¦‚æ›´æ”¹æ–‡ä»¶çš„è®¿é—®æƒé™ã€æ›´æ”¹æ–‡ä»¶çš„ç”¨æˆ· IDã€ç”¨æˆ·ç»„ IDã€æ›´æ”¹é“¾æ¥æ•°ç­‰ï¼Œä½†å®ƒä»¬å¹¶æ²¡æœ‰æ›´æ”¹æ–‡ä»¶çš„å®é™…å†…å®¹ï¼Œä¹Ÿæ²¡æœ‰è®¿é—®ï¼ˆè¯»å–ï¼‰æ–‡ä»¶å†…å®¹ã€‚inode ä¸­åŒ…å«äº†å¾ˆå¤šæ–‡ä»¶ä¿¡æ¯ï¼Œè­¬å¦‚ï¼šæ–‡ä»¶å­—èŠ‚å¤§å°ã€æ–‡ä»¶æ‰€æœ‰è€…ã€æ–‡ä»¶å¯¹åº”çš„è¯»&#x2F;å†™&#x2F;æ‰§è¡Œæƒé™ã€æ–‡ä»¶æ—¶é—´æˆ³ï¼ˆæ—¶é—´å±æ€§ï¼‰ã€æ–‡ä»¶æ•°æ®å­˜å‚¨çš„ blockï¼ˆå—ï¼‰ç­‰ï¼Œæ‰€ä»¥ç”±æ­¤å¯çŸ¥ï¼ŒçŠ¶æ€çš„æ›´æ”¹æŒ‡çš„å°±æ˜¯ inode èŠ‚ç‚¹å†…å®¹çš„æ›´æ”¹ã€‚è­¬å¦‚ chmod()ã€chown()ç­‰<br>è¿™äº›å‡½æ•°éƒ½èƒ½æ”¹å˜è¯¥æ—¶é—´å±æ€§ã€‚</p><p>åˆ—å‡ºäº†ä¸€äº›ç³»ç»Ÿè°ƒç”¨æˆ– C åº“å‡½æ•°å¯¹æ–‡ä»¶æ—¶é—´å±æ€§çš„å½±å“ï¼Œæœ‰äº›æ“ä½œå¹¶ä¸ä»…ä»…åªä¼šå½±å“æ–‡ä»¶æœ¬èº«çš„æ—¶é—´å±æ€§ï¼Œè¿˜ä¼šå½±å“åˆ°å…¶çˆ¶ç›®å½•çš„ç›¸å…³æ—¶é—´å±æ€§ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/time.png"></p><h4 id="utime-ã€utimes-ä¿®æ”¹æ—¶é—´å±æ€§"><a href="#utime-ã€utimes-ä¿®æ”¹æ—¶é—´å±æ€§" class="headerlink" title="utime()ã€utimes()ä¿®æ”¹æ—¶é—´å±æ€§"></a>utime()ã€utimes()ä¿®æ”¹æ—¶é—´å±æ€§</h4><p>utime()å‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utime.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">utime</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="keyword">struct</span> utimbuf *times)</span>;</span><br></pre></td></tr></table></figure><p>filenameï¼šéœ€è¦ä¿®æ”¹æ—¶é—´å±æ€§çš„æ–‡ä»¶è·¯å¾„ã€‚<br>timesï¼šå°†æ—¶é—´å±æ€§ä¿®æ”¹ä¸ºè¯¥å‚æ•°æ‰€æŒ‡å®šçš„æ—¶é—´å€¼ï¼Œtimes æ˜¯ä¸€ä¸ª struct utimbuf ç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œå¦‚æœtimes å‚æ•°è®¾ç½®ä¸º NULLï¼Œåˆ™ä¼šå°†æ–‡ä»¶çš„è®¿é—®æ—¶é—´å’Œä¿®æ”¹æ—¶é—´è®¾ç½®ä¸ºç³»ç»Ÿå½“å‰æ—¶é—´ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›å€¼ 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¼šè®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">utimbuf</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">time_t</span> actime; <span class="comment">/* è®¿é—®æ—¶é—´ */</span></span><br><span class="line"><span class="type">time_t</span> modtime; <span class="comment">/* å†…å®¹ä¿®æ”¹æ—¶é—´ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“ä¸­åŒ…å«äº†ä¸¤ä¸ª time_t ç±»å‹çš„æˆå‘˜ï¼Œåˆ†åˆ«ç”¨äºè¡¨ç¤ºè®¿é—®æ—¶é—´å’Œå†…å®¹ä¿®æ”¹æ—¶é—´ï¼Œtime_t ç±»å‹å…¶å®å°±æ˜¯ long int ç±»å‹ã€‚</p><p>åŒæ ·å¯¹äºæ–‡ä»¶æ¥è¯´ï¼Œæ—¶é—´å±æ€§ä¹Ÿæ˜¯æ–‡ä»¶éå¸¸é‡è¦çš„å±æ€§ä¹‹ä¸€ï¼Œå¯¹æ–‡ä»¶æ—¶é—´å±æ€§çš„ä¿®æ”¹ä¹Ÿä¸æ˜¯ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥éšä¾¿ä¿®æ”¹çš„ï¼Œåªæœ‰ä»¥ä¸‹ä¸¤ç§è¿›ç¨‹å¯å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼š<br>âš« è¶…çº§ç”¨æˆ·è¿›ç¨‹ï¼ˆä»¥ root èº«ä»½è¿è¡Œçš„è¿›ç¨‹ï¼‰ã€‚<br>âš« æœ‰æ•ˆç”¨æˆ· ID ä¸è¯¥æ–‡ä»¶ç”¨æˆ· IDï¼ˆæ–‡ä»¶æ‰€æœ‰è€…ï¼‰ç›¸åŒ¹é…çš„è¿›ç¨‹ã€‚<br>âš« åœ¨å‚æ•° times ç­‰äº NULL çš„æƒ…å†µä¸‹ï¼Œå¯¹æ–‡ä»¶æ‹¥æœ‰å†™æƒé™çš„è¿›ç¨‹ã€‚<br>é™¤ä»¥ä¸Šä¸‰ç§æƒ…å†µä¹‹å¤–çš„ç”¨æˆ·è¿›ç¨‹å°†æ— æ³•å¯¹æ–‡ä»¶æ—¶é—´æˆ³è¿›è¡Œä¿®æ”¹ã€‚</p><p>utimeså‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">utimes</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="keyword">struct</span> timeval times[<span class="number">2</span>])</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>filenameï¼šéœ€è¦ä¿®æ”¹æ—¶é—´å±æ€§çš„æ–‡ä»¶è·¯å¾„ã€‚<br>timesï¼šå°†æ—¶é—´å±æ€§ä¿®æ”¹ä¸ºè¯¥å‚æ•°æ‰€æŒ‡å®šçš„æ—¶é—´å€¼ï¼Œtimes æ˜¯ä¸€ä¸ª struct timeval ç»“æ„ä½“ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„å…±æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ç”¨äºæŒ‡å®šè®¿é—®æ—¶é—´ï¼Œç¬¬äºŒä¸ªå…ƒç´ ç”¨äºæŒ‡å®šå†…å®¹ä¿®æ”¹æ—¶é—´ï¼Œç¨åç»™å¤§å®¶ä»‹ç»ï¼Œå¦‚æœtimes å‚æ•°ä¸º NULLï¼Œåˆ™ä¼šå°†æ–‡ä»¶çš„è®¿é—®æ—¶é—´å’Œä¿®æ”¹æ—¶é—´è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥è¿”å›-1ï¼Œå¹¶ä¸”ä¼šè®¾ç½® errnoã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">long</span> tv_sec; <span class="comment">/* ç§’ */</span></span><br><span class="line"><span class="type">long</span> tv_usec; <span class="comment">/* å¾®ç§’ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="futimens-ã€utimensat-ä¿®æ”¹æ—¶é—´å±æ€§"><a href="#futimens-ã€utimensat-ä¿®æ”¹æ—¶é—´å±æ€§" class="headerlink" title="futimens()ã€utimensat()ä¿®æ”¹æ—¶é—´å±æ€§"></a>futimens()ã€utimensat()ä¿®æ”¹æ—¶é—´å±æ€§</h4><p>futimens()ã€utimensat()å‡½æ•°æ˜¯ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ç”±äºæ˜¾ç¤ºä¿®æ”¹æ–‡ä»¶æ—¶é—´ã€‚</p><p>è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ç›¸å¯¹äº utime å’Œ utimes å‡½æ•°æœ‰ä»¥ä¸‹ä¸‰ä¸ªä¼˜ç‚¹ï¼š<br>âš« å¯æŒ‰çº³ç§’çº§ç²¾åº¦è®¾ç½®æ—¶é—´æˆ³ã€‚ç›¸å¯¹äºæä¾›å¾®ç§’çº§ç²¾åº¦çš„ utimes()ï¼Œè¿™æ˜¯é‡å¤§æ”¹è¿›ï¼<br>âš« å¯å•ç‹¬è®¾ç½®æŸä¸€æ—¶é—´æˆ³ã€‚è­¬å¦‚ï¼Œåªè®¾ç½®è®¿é—®æ—¶é—´ã€è€Œä¿®æ”¹æ—¶é—´ä¿æŒä¸å˜ï¼Œå¦‚æœè¦ä½¿ç”¨ utime()æˆ– utimes()æ¥å®ç°æ­¤åŠŸèƒ½ï¼Œåˆ™éœ€è¦é¦–å…ˆä½¿ç”¨ stat()è·å–å¦ä¸€ä¸ªæ—¶é—´æˆ³çš„å€¼ï¼Œç„¶åå†å°†è·å–å€¼ä¸æ‰“ç®—å˜æ›´çš„æ—¶é—´æˆ³ä¸€åŒæŒ‡å®šã€‚<br>âš« å¯ç‹¬ç«‹å°†ä»»ä¸€æ—¶é—´æˆ³è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚ä½¿ç”¨ utime()æˆ– utimes()å‡½æ•°è™½ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å°† times å‚æ•°è®¾ç½®ä¸ºNULL æ¥è¾¾åˆ°å°†æ—¶é—´æˆ³è®¾ç½®ä¸ºå½“å‰æ—¶é—´çš„æ•ˆæœï¼Œä½†æ˜¯ä¸èƒ½å•ç‹¬æŒ‡å®šæŸä¸€ä¸ªæ—¶é—´æˆ³ï¼Œå¿…é¡»å…¨éƒ¨è®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼ˆä¸è€ƒè™‘ä½¿ç”¨é¢å¤–å‡½æ•°è·å–å½“å‰æ—¶é—´çš„æ–¹å¼ï¼Œè­¬å¦‚ time()ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span> <span class="comment">/* Definition of AT_* constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">futimens</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> timespec times[<span class="number">2</span>])</span>;</span><br></pre></td></tr></table></figure><p>fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚<br>timesï¼šå°†æ—¶é—´å±æ€§ä¿®æ”¹ä¸ºè¯¥å‚æ•°æ‰€æŒ‡å®šçš„æ—¶é—´å€¼ï¼Œtimes æŒ‡å‘æ‹¥æœ‰ 2 ä¸ª struct timespec ç»“æ„ä½“ç±»å‹å˜é‡çš„æ•°ç»„ï¼Œæ•°ç»„å…±æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ç”¨äºæŒ‡å®šè®¿é—®æ—¶é—´ï¼Œç¬¬äºŒä¸ªå…ƒç´ ç”¨äºæŒ‡å®šå†…å®¹ä¿®æ”¹æ—¶é—´ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p>è¯¥å‡½æ•°çš„æ—¶é—´æˆ³å¯ä»¥æŒ‰ä¸‹åˆ— 4 ç§æ–¹å¼ä¹‹ä¸€è¿›è¡ŒæŒ‡å®šï¼š<br>âš« å¦‚æœ times å‚æ•°æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ NULLï¼Œåˆ™è¡¨ç¤ºå°†è®¿é—®æ—¶é—´å’Œä¿®æ”¹æ—¶é—´éƒ½è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚<br>âš« å¦‚æœ times å‚æ•°æŒ‡å‘ä¸¤ä¸ª struct timespec ç»“æ„ä½“ç±»å‹å˜é‡çš„æ•°ç»„ï¼Œä»»ä¸€æ•°ç»„å…ƒç´ çš„ tv_nsec å­—æ®µçš„å€¼è®¾ç½®ä¸º UTIME_NOWï¼Œåˆ™è¡¨ç¤ºç›¸åº”çš„æ—¶é—´æˆ³è®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼Œæ­¤æ—¶å¿½ç•¥ç›¸åº”çš„ tv_sec å­—æ®µã€‚<br>âš« å¦‚æœ times å‚æ•°æŒ‡å‘ä¸¤ä¸ª struct timespec ç»“æ„ä½“ç±»å‹å˜é‡çš„æ•°ç»„ï¼Œä»»ä¸€æ•°ç»„å…ƒç´ çš„ tv_nsec å­—æ®µçš„å€¼è®¾ç½®ä¸º UTIME_OMITï¼Œåˆ™è¡¨ç¤ºç›¸åº”çš„æ—¶é—´æˆ³ä¿æŒä¸å˜ï¼Œæ­¤æ—¶å¿½ç•¥ tv_sec å­—æ®µã€‚<br>âš« å¦‚æœ times å‚æ•°æŒ‡å‘ä¸¤ä¸ª struct timespec ç»“æ„ä½“ç±»å‹å˜é‡çš„æ•°ç»„ï¼Œä¸” tv_nsec å­—æ®µçš„å€¼æ—¢ä¸æ˜¯UTIME_NOW ä¹Ÿä¸æ˜¯ UTIME_OMITï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›¸åº”çš„æ—¶é—´æˆ³è®¾ç½®ä¸ºç›¸åº”çš„ tv_sec å’Œ tv_nsecå­—æ®µæŒ‡å®šçš„å€¼ã€‚</p><p>ä½¿ç”¨ <u>futimens()å‡½æ•°åªæœ‰ä»¥ä¸‹è¿›ç¨‹ï¼Œå¯å¯¹æ–‡ä»¶æ—¶é—´æˆ³è¿›è¡Œä¿®æ”¹ï¼š</u><br>âš« è¶…çº§ç”¨æˆ·è¿›ç¨‹ã€‚<br>âš« åœ¨å‚æ•° times ç­‰äº NULL çš„æƒ…å†µä¸‹ï¼Œå¯¹æ–‡ä»¶æ‹¥æœ‰å†™æƒé™çš„è¿›ç¨‹ã€‚<br>âš« æœ‰æ•ˆç”¨æˆ· ID ä¸è¯¥æ–‡ä»¶ç”¨æˆ· IDï¼ˆæ–‡ä»¶æ‰€æœ‰è€…ï¼‰ç›¸åŒ¹é…çš„è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_FILE <span class="string">&quot;./test_file&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">tmsp_arr</span>[2];</span></span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="type">int</span> fd;</span><br><span class="line"> <span class="comment">/* æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ */</span></span><br><span class="line"> ret = access(MY_FILE, F_OK);</span><br><span class="line"> <span class="keyword">if</span> (ret == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Error: %s file does not exist!\n&quot;</span>, MY_FILE);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€æ–‡ä»¶ */</span></span><br><span class="line"> fd = open(MY_FILE, O_RDONLY);</span><br><span class="line"> <span class="keyword">if</span> (fd == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* ä¿®æ”¹æ–‡ä»¶æ—¶é—´æˆ³ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line"> ret = futimens(fd, <span class="literal">NULL</span>); <span class="comment">//åŒæ—¶è®¾ç½®ä¸ºå½“å‰æ—¶é—´</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line"> tmsp_arr[<span class="number">0</span>].tv_nsec = UTIME_OMIT;<span class="comment">//è®¿é—®æ—¶é—´ä¿æŒä¸å˜</span></span><br><span class="line"> tmsp_arr[<span class="number">1</span>].tv_nsec = UTIME_NOW;<span class="comment">//å†…å®¹ä¿®æ”¹æ—¶é—´è®¾ç½®ä¸ºå½“æœŸæ—¶é—´</span></span><br><span class="line"> ret = futimens(fd, tmsp_arr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line"> tmsp_arr[<span class="number">0</span>].tv_nsec = UTIME_NOW;<span class="comment">//è®¿é—®æ—¶é—´è®¾ç½®ä¸ºå½“å‰æ—¶é—´</span></span><br><span class="line"> tmsp_arr[<span class="number">1</span>].tv_nsec = UTIME_OMIT;<span class="comment">//å†…å®¹ä¿®æ”¹æ—¶é—´ä¿æŒä¸å˜</span></span><br><span class="line"> ret = futimens(fd, tmsp_arr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> <span class="keyword">if</span> (ret == <span class="number">-1</span>) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;futimens error&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> err;</span><br><span class="line"> &#125;</span><br><span class="line">err:</span><br><span class="line"> close(fd);</span><br><span class="line"> <span class="built_in">exit</span>(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>utimensat()å‡½æ•°åŠŸèƒ½ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå…·ä½“å¯ä»¥ä½¿ç”¨man 2  utimensatæŸ¥è¯¢ç”¨æ³•</p><h3 id="ç¬¦å·é“¾æ¥ä¸ç¡¬é“¾æ¥"><a href="#ç¬¦å·é“¾æ¥ä¸ç¡¬é“¾æ¥" class="headerlink" title="ç¬¦å·é“¾æ¥ä¸ç¡¬é“¾æ¥"></a>ç¬¦å·é“¾æ¥ä¸ç¡¬é“¾æ¥</h3><p>åœ¨ Linux ç³»ç»Ÿä¸­æœ‰ä¸¤ç§é“¾æ¥æ–‡ä»¶ï¼Œåˆ†ä¸ºè½¯é“¾æ¥ï¼ˆä¹Ÿå«ç¬¦å·é“¾æ¥ï¼‰æ–‡ä»¶å’Œç¡¬é“¾æ¥æ–‡ä»¶ï¼Œè½¯é“¾æ¥æ–‡ä»¶ä¹Ÿå°±æ˜¯å‰é¢ç»™å¤§å®¶çš„ Linux ç³»ç»Ÿä¸‹çš„ä¸ƒç§æ–‡ä»¶ç±»å‹ä¹‹ä¸€ï¼Œå…¶ä½œç”¨ç±»ä¼¼äº Windows ä¸‹çš„å¿«æ·æ–¹å¼ã€‚ç¡¬é“¾æ¥ä¸¤ä¸ªæ–‡ä»¶ç›¸äº’å½±å“ã€‚</p><p>å¤ä¹ ä¸€ä¸‹shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="built_in">ln</span> æºæ–‡ä»¶ é“¾æ¥æ–‡ä»¶<span class="comment">##ç¡¬é“¾æ¥</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ln-s æºæ–‡ä»¶ é“¾æ¥æ–‡ä»¶<span class="comment">##è½¯é“¾æ¥</span></span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ ln å‘½ä»¤åˆ›å»ºçš„ä¸¤ä¸ªç¡¬é“¾æ¥æ–‡ä»¶ä¸æºæ–‡ä»¶ test_file éƒ½æ‹¥æœ‰ç›¸åŒçš„ inode å·ï¼Œæ—¢ç„¶inode ç›¸åŒï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒä»¬æŒ‡å‘äº†ç‰©ç†ç¡¬ç›˜çš„åŒä¸€ä¸ªåŒºå—ï¼Œä»…ä»…åªæ˜¯æ–‡ä»¶åå­—ä¸åŒè€Œå·²ï¼Œåˆ›å»ºå‡ºæ¥çš„ç¡¬é“¾æ¥æ–‡ä»¶ä¸æºæ–‡ä»¶å¯¹æ–‡ä»¶ç³»ç»Ÿæ¥è¯´æ˜¯å®Œå…¨å¹³ç­‰çš„å…³ç³»ã€‚</p><p>å½“ä¸ºæ–‡ä»¶æ¯åˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥ï¼Œinode èŠ‚ç‚¹ä¸Šçš„é“¾æ¥æ•°å°±ä¼šåŠ ä¸€ï¼Œæ¯åˆ é™¤ä¸€ä¸ªç¡¬é“¾æ¥ï¼Œinode èŠ‚ç‚¹ä¸Šçš„é“¾æ¥æ•°å°±ä¼šå‡ä¸€ï¼Œç›´åˆ°ä¸º 0ï¼Œinode èŠ‚ç‚¹å’Œå¯¹åº”çš„æ•°æ®å—æ‰ä¼šè¢«æ–‡ä»¶ç³»ç»Ÿæ‰€å›æ”¶ï¼Œä¹Ÿå°±æ„å‘³ç€æ–‡ä»¶å·²ç»ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¢«åˆ é™¤äº†ã€‚</p><p>è½¯é“¾æ¥æ–‡ä»¶ä¸æºæ–‡ä»¶æœ‰ç€ä¸åŒçš„ inode å·ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯æ„å‘³ç€å®ƒä»¬ä¹‹é—´æœ‰ç€ä¸åŒçš„æ•°æ®å—ï¼Œä½†æ˜¯è½¯é“¾æ¥æ–‡ä»¶çš„æ•°æ®å—ä¸­å­˜å‚¨çš„æ˜¯æºæ–‡ä»¶çš„è·¯å¾„åï¼Œé“¾æ¥æ–‡ä»¶å¯ä»¥é€šè¿‡è¿™ä¸ªè·¯å¾„æ‰¾åˆ°è¢«é“¾æ¥çš„æºæ–‡ä»¶ï¼Œå®ƒä»¬ä¹‹é—´ç±»ä¼¼äºä¸€ç§â€œä¸»ä»â€å…³ç³»ï¼Œå½“æºæ–‡ä»¶è¢«åˆ é™¤ä¹‹åï¼Œè½¯é“¾æ¥æ–‡ä»¶ä¾ç„¶å­˜åœ¨ï¼Œä½†æ­¤æ—¶å®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ— æ•ˆçš„æ–‡ä»¶è·¯å¾„ï¼Œè¿™ç§é“¾æ¥æ–‡ä»¶è¢«ç§°ä¸ºæ‚¬ç©ºé“¾æ¥ã€‚</p><p>âš« ä¸èƒ½å¯¹ç›®å½•åˆ›å»ºç¡¬é“¾æ¥ï¼ˆè¶…çº§ç”¨æˆ·å¯ä»¥åˆ›å»ºï¼Œä½†å¿…é¡»åœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„æƒ…å†µä¸‹ï¼‰ã€‚<br>âš« ç¡¬é“¾æ¥é€šå¸¸è¦æ±‚é“¾æ¥æ–‡ä»¶å’Œæºæ–‡ä»¶ä½äºåŒä¸€æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚<br>è€Œè½¯é“¾æ¥æ–‡ä»¶çš„ä½¿ç”¨å¹¶æ²¡æœ‰ä¸Šè¿°é™åˆ¶æ¡ä»¶ï¼Œä¼˜ç‚¹å¦‚ä¸‹æ‰€ç¤ºï¼š<br>âš« å¯ä»¥å¯¹ç›®å½•åˆ›å»ºè½¯é“¾æ¥ï¼›<br>âš« å¯ä»¥è·¨è¶Šä¸åŒæ–‡ä»¶ç³»ç»Ÿï¼›<br>âš« å¯ä»¥å¯¹ä¸å­˜åœ¨çš„æ–‡ä»¶åˆ›å»ºè½¯é“¾æ¥ã€‚</p><h4 id="åˆ›å»ºç¡¬é“¾æ¥link"><a href="#åˆ›å»ºç¡¬é“¾æ¥link" class="headerlink" title="åˆ›å»ºç¡¬é“¾æ¥link"></a>åˆ›å»ºç¡¬é“¾æ¥link</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">link</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *oldpath, <span class="type">const</span> <span class="type">char</span> *newpath)</span>;</span><br></pre></td></tr></table></figure><p>oldpathï¼šç”¨äºæŒ‡å®šè¢«é“¾æ¥çš„æºæ–‡ä»¶è·¯å¾„ï¼Œåº”é¿å… oldpath å‚æ•°æŒ‡å®šä¸ºè½¯é“¾æ¥æ–‡ä»¶ï¼Œä¸ºè½¯é“¾æ¥æ–‡ä»¶åˆ›å»ºç¡¬é“¾æ¥æ²¡æœ‰æ„ä¹‰ï¼Œè™½ç„¶å¹¶ä¸ä¼šæŠ¥é”™ã€‚<br>newpathï¼šç”¨äºæŒ‡å®šç¡¬é“¾æ¥æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœ newpath æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„å·²å­˜åœ¨ï¼Œåˆ™ä¼šäº§ç”Ÿé”™è¯¯ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¸”ä¼šè®¾ç½® errnoã€‚</p><h4 id="åˆ›å»ºè½¯é“¾æ¥symlink"><a href="#åˆ›å»ºè½¯é“¾æ¥symlink" class="headerlink" title="åˆ›å»ºè½¯é“¾æ¥symlink"></a>åˆ›å»ºè½¯é“¾æ¥symlink</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">symlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *target, <span class="type">const</span> <span class="type">char</span> *linkpath)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>targetï¼šç”¨äºæŒ‡å®šè¢«é“¾æ¥çš„æºæ–‡ä»¶è·¯å¾„ï¼Œtarget å‚æ•°æŒ‡å®šçš„ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè½¯é“¾æ¥æ–‡ä»¶ã€‚<br>linkpathï¼šç”¨äºæŒ‡å®šç¡¬é“¾æ¥æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœ newpath æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„å·²å­˜åœ¨ï¼Œåˆ™ä¼šäº§ç”Ÿé”™è¯¯ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¼šè®¾ç½® errnoã€‚<br>åˆ›å»ºè½¯é“¾æ¥æ—¶ï¼Œå¹¶ä¸è¦æ±‚ target å‚æ•°æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„å·²ç»å­˜åœ¨ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»ºçš„è½¯é“¾æ¥å°†æˆä¸ºâ€œæ‚¬ç©ºé“¾æ¥â€ã€‚</p><h4 id="è¯»å–è½¯é“¾æ¥æ–‡ä»¶"><a href="#è¯»å–è½¯é“¾æ¥æ–‡ä»¶" class="headerlink" title="è¯»å–è½¯é“¾æ¥æ–‡ä»¶"></a>è¯»å–è½¯é“¾æ¥æ–‡ä»¶</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">readlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *buf, <span class="type">size_t</span> bufsiz)</span>;</span><br></pre></td></tr></table></figure><p>pathnameï¼šéœ€è¦è¯»å–çš„è½¯é“¾æ¥æ–‡ä»¶è·¯å¾„ã€‚åªèƒ½æ˜¯è½¯é“¾æ¥æ–‡ä»¶è·¯å¾„ï¼Œä¸èƒ½æ˜¯å…¶å®ƒç±»å‹æ–‡ä»¶ï¼Œå¦åˆ™è°ƒç”¨å‡½<br>æ•°å°†æŠ¥é”™ã€‚<br>bufï¼šç”¨äºå­˜æ”¾è·¯å¾„ä¿¡æ¯çš„ç¼“å†²åŒºã€‚<br>bufsizï¼šè¯»å–å¤§å°ï¼Œä¸€èˆ¬è¯»å–çš„å¤§å°éœ€è¦å¤§äºé“¾æ¥æ–‡ä»¶æ•°æ®å—ä¸­å­˜å‚¨çš„æ–‡ä»¶è·¯å¾„ä¿¡æ¯å­—èŠ‚å¤§å°ã€‚<br>è¿”å›å€¼ï¼šå¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¼šè®¾ç½® errnoï¼›æˆåŠŸå°†è¿”å›è¯»å–åˆ°çš„å­—èŠ‚æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">readlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *buf, <span class="type">size_t</span> bufsiz)</span>;</span><br></pre></td></tr></table></figure><p>pathnameï¼šéœ€è¦è¯»å–çš„è½¯é“¾æ¥æ–‡ä»¶è·¯å¾„ã€‚åªèƒ½æ˜¯è½¯é“¾æ¥æ–‡ä»¶è·¯å¾„ï¼Œä¸èƒ½æ˜¯å…¶å®ƒç±»å‹æ–‡ä»¶ï¼Œå¦åˆ™è°ƒç”¨å‡½æ•°å°†æŠ¥é”™ã€‚<br>bufï¼šç”¨äºå­˜æ”¾è·¯å¾„ä¿¡æ¯çš„ç¼“å†²åŒºã€‚<br>bufsizï¼šè¯»å–å¤§å°ï¼Œä¸€èˆ¬è¯»å–çš„å¤§å°éœ€è¦å¤§äºé“¾æ¥æ–‡ä»¶æ•°æ®å—ä¸­å­˜å‚¨çš„æ–‡ä»¶è·¯å¾„ä¿¡æ¯å­—èŠ‚å¤§å°ã€‚<br>è¿”å›å€¼ï¼šå¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¼šè®¾ç½® errnoï¼›æˆåŠŸå°†è¿”å›è¯»å–åˆ°çš„å­—èŠ‚æ•°ã€‚</p><h3 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h3><h4 id="ç›®å½•å­˜å‚¨å½¢å¼"><a href="#ç›®å½•å­˜å‚¨å½¢å¼" class="headerlink" title="ç›®å½•å­˜å‚¨å½¢å¼"></a>ç›®å½•å­˜å‚¨å½¢å¼</h4><p>ç›®å½•è¿™ç§ç‰¹æ®Šæ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨å½¢å¼ï¼Œå…¶å®ç›®å½•åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨æ–¹å¼ä¸å¸¸è§„æ–‡ä»¶ç±»ä¼¼ï¼Œå¸¸è§„æ–‡ä»¶åŒ…æ‹¬äº† inode èŠ‚ç‚¹ä»¥åŠæ–‡ä»¶å†…å®¹æ•°æ®å­˜å‚¨å—ï¼ˆblockï¼‰ï¼Œä½†å¯¹äºç›®å½•æ¥è¯´ï¼Œå…¶å­˜å‚¨å½¢å¼åˆ™æ˜¯ç”± inode èŠ‚ç‚¹å’Œç›®å½•å—æ‰€æ„æˆï¼Œç›®å½•å—å½“ä¸­è®°å½•äº†æœ‰å“ªäº›æ–‡ä»¶ç»„ç»‡åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œè®°å½•å®ƒä»¬çš„æ–‡ä»¶åä»¥åŠå¯¹åº”çš„ inode ç¼–å·ã€‚</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/guazai.jpg"></p><p>ç›®å½•å—å½“ä¸­æœ‰å¤šä¸ªç›®å½•é¡¹ï¼ˆæˆ–å«ç›®å½•æ¡ç›®ï¼‰ï¼Œæ¯ä¸€ä¸ªç›®å½•é¡¹ï¼ˆæˆ–ç›®å½•æ¡ç›®ï¼‰éƒ½ä¼šå¯¹åº”åˆ°è¯¥ç›®å½•ä¸‹çš„æŸä¸€ä¸ªæ–‡ä»¶ï¼Œç›®å½•é¡¹å½“ä¸­è®°å½•äº†è¯¥æ–‡ä»¶çš„æ–‡ä»¶åä»¥åŠå®ƒçš„ inode èŠ‚ç‚¹ç¼–å·ï¼Œæ‰€ä»¥é€šè¿‡ç›®å½•çš„ç›®å½•å—ä¾¿å¯ä»¥éå†æ‰¾åˆ°è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä»¥åŠæ‰€å¯¹åº”çš„ inode èŠ‚ç‚¹ã€‚<br>æ‰€ä»¥å¯¹æ­¤æ€»ç»“å¦‚ä¸‹ï¼š<br>âš« æ™®é€šæ–‡ä»¶ç”± inode èŠ‚ç‚¹å’Œæ•°æ®å—æ„æˆ<br>âš« ç›®å½•ç”± inode èŠ‚ç‚¹å’Œç›®å½•å—æ„æˆ</p><h4 id="åˆ›å»ºåˆ é™¤ç›®å½•"><a href="#åˆ›å»ºåˆ é™¤ç›®å½•" class="headerlink" title="åˆ›å»ºåˆ é™¤ç›®å½•"></a>åˆ›å»ºåˆ é™¤ç›®å½•</h4><p><strong>mkdirå‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mkdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">mode_t</span> mode)</span>;</span><br></pre></td></tr></table></figure><p>pathnameï¼šéœ€è¦åˆ›å»ºçš„ç›®å½•è·¯å¾„ã€‚<br>modeï¼šæ–°å»ºç›®å½•çš„æƒé™è®¾ç½®ï¼Œè®¾ç½®æ–¹å¼ä¸ open å‡½æ•°çš„ mode å‚æ•°ä¸€æ ·ï¼Œæœ€ç»ˆæƒé™ä¸ºï¼ˆmode &amp; ~umaskï¼‰ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¼šè®¾ç½® errnoã€‚<br>pathname å‚æ•°æŒ‡å®šçš„æ–°å»ºç›®å½•çš„è·¯å¾„ï¼Œè¯¥è·¯å¾„åå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œè‹¥æŒ‡å®šçš„è·¯å¾„åå·²ç»å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ mkdir()å°†ä¼šå¤±è´¥ã€‚<br>mode å‚æ•°æŒ‡å®šäº†æ–°ç›®å½•çš„æƒé™ï¼Œç›®å½•æ‹¥æœ‰ä¸æ™®é€šæ–‡ä»¶ç›¸åŒçš„æƒé™ä½ï¼Œä½†æ˜¯å…¶è¡¨ç¤ºçš„å«ä¹‰ä¸æ™®é€šæ–‡ä»¶å´æœ‰ä¸åŒã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> ret = mkdir(<span class="string">&quot;./new_dir&quot;</span>, S_IRWXU |</span><br><span class="line"> S_IRGRP | S_IXGRP |</span><br><span class="line">S_IROTH | S_IXOTH);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) </span><br><span class="line">    &#123;</span><br><span class="line"> perror(<span class="string">&quot;mkdir error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åˆ é™¤ç›®å½•rmdir</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">rmdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname)</span>;</span><br></pre></td></tr></table></figure><p>pathnameï¼šéœ€è¦åˆ é™¤çš„ç›®å½•å¯¹åº”çš„è·¯å¾„åï¼Œå¹¶ä¸”è¯¥ç›®å½•å¿…é¡»æ˜¯ä¸€ä¸ªç©ºç›®å½•ï¼Œä¹Ÿå°±æ˜¯è¯¥ç›®å½•ä¸‹åªæœ‰.å’Œ..è¿™ä¸¤ä¸ªç›®å½•é¡¹ï¼›pathname æŒ‡å®šçš„è·¯å¾„åä¸èƒ½æ˜¯è½¯é“¾æ¥æ–‡ä»¶ï¼Œå³ä½¿è¯¥é“¾æ¥æ–‡ä»¶æŒ‡å‘äº†ä¸€ä¸ªç©ºç›®å½•ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¼šè®¾ç½® errnoã€‚</p><p><strong>æ‰“å¼€ã€è¯»å–ä»¥åŠå…³é—­ç›®å½•</strong></p><p><strong>opendir()å‡½æ•°</strong>ç”¨äºæ‰“å¼€ä¸€ä¸ªç›®å½•ï¼Œå¹¶è¿”å›æŒ‡å‘è¯¥ç›®å½•çš„å¥æŸ„ï¼Œä¾›åç»­æ“ä½œä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line">DIR *<span class="title function_">opendir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure><p>nameï¼šæŒ‡å®šéœ€è¦æ‰“å¼€çš„ç›®å½•è·¯å¾„åï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸå°†è¿”å›æŒ‡å‘è¯¥ç›®å½•çš„å¥æŸ„ï¼Œä¸€ä¸ª DIR æŒ‡é’ˆï¼ˆå…¶å®è´¨æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼‰ï¼Œå…¶ä½œç”¨ç±»ä¼¼äº<br>openå‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦fdï¼Œåç»­å¯¹è¯¥ç›®å½•çš„æ“ä½œéœ€è¦ä½¿ç”¨è¯¥DIRæŒ‡é’ˆå˜é‡ï¼›è‹¥è°ƒç”¨å¤±è´¥ï¼Œåˆ™è¿”å›NULLã€‚</p><p>**readdir()**ç”¨äºè¯»å–ç›®å½•ï¼Œè·å–ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„åç§°ä»¥åŠå¯¹åº” inode å·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span> dirent *<span class="title function_">readdir</span><span class="params">(DIR *dirp)</span>;</span><br></pre></td></tr></table></figure><p>dirpï¼šç›®å½•å¥æŸ„ DIR æŒ‡é’ˆã€‚<br>è¿”å›å€¼ï¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ struct dirent ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„ä½“è¡¨ç¤º dirp æŒ‡å‘çš„ç›®å½•æµä¸­çš„ä¸‹ä¸€ä¸ªç›®å½•æ¡ç›®ã€‚åœ¨åˆ°è¾¾ç›®å½•æµçš„æœ«å°¾æˆ–å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå®ƒè¿”å› NULLã€‚</p><p><u>â€œæµâ€è¿™ä¸ªæ¦‚å¿µæ˜¯åŠ¨æ€çš„ï¼Œè€Œä¸æ˜¯é™æ€çš„ã€‚ç¼–ç¨‹å½“ä¸­æåˆ°è¿™ä¸ªæ¦‚å¿µï¼Œä¸€èˆ¬éƒ½æ˜¯ä¸ I&#x2F;O ç›¸å…³ï¼Œæ‰€ä»¥ä¹Ÿç»å¸¸å«åš I&#x2F;O æµï¼›ä½†å¯¹äºç›®å½•è¿™ç§ç‰¹æ®Šæ–‡ä»¶æ¥è¯´ï¼Œè¿™é‡Œå°†ç›®å½•å—ä¸­å­˜å‚¨çš„æ•°æ®ç§°ä¸ºç›®å½•æµï¼Œå­˜å‚¨äº†ä¸€ä¸ªä¸€ä¸ªçš„ç›®å½•é¡¹ï¼ˆç›®å½•æ¡ç›®ï¼‰ã€‚</u></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="type">ino_t</span> d_ino; <span class="comment">/* inode ç¼–å· */</span></span><br><span class="line"> <span class="type">off_t</span> d_off; <span class="comment">/* not an offset; see NOTES */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">short</span> d_reclen; <span class="comment">/* length of this record */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">char</span> d_type; <span class="comment">/* type of file; not supported by all filesystem types */</span></span><br><span class="line"> <span class="type">char</span> d_name[<span class="number">256</span>]; <span class="comment">/* æ–‡ä»¶å */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¯è°ƒç”¨ä¸€æ¬¡ readdir()ï¼Œå°±ä¼šä» drip æ‰€æŒ‡å‘çš„ç›®å½•æµä¸­è¯»å–ä¸‹ä¸€æ¡ç›®å½•é¡¹ï¼ˆç›®å½•æ¡ç›®ï¼‰ï¼Œå¹¶è¿”å› struct direntç»“æ„ä½“æŒ‡é’ˆï¼ŒæŒ‡å‘ç»é™æ€åˆ†é…è€Œå¾—çš„ struct dirent ç±»å‹ç»“æ„ï¼Œæ¯æ¬¡è°ƒç”¨ readdir()éƒ½ä¼šè¦†ç›–è¯¥ç»“æ„ã€‚ä¸€æ—¦é‡åˆ°ç›®å½•ç»“å°¾æˆ–æ˜¯å‡ºé”™ï¼Œreaddir()å°†è¿”å› NULLï¼Œé’ˆå¯¹åä¸€ç§æƒ…å†µï¼Œè¿˜ä¼šè®¾ç½® errno ä»¥ç¤ºå…·ä½“é”™è¯¯ã€‚</p><p>é‚£å¦‚ä½•åŒºåˆ«ç©¶ç«Ÿæ˜¯åˆ°äº†ç›®å½•æœ«å°¾è¿˜æ˜¯å‡ºé”™äº†å‘¢ï¼Œå¯é€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œåˆ¤æ–­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">error = <span class="number">0</span>;</span><br><span class="line">direntp = readdir(dirp);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> == direntp) </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> != error) </span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* å‡ºç°äº†é”™è¯¯ */</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* å·²ç»åˆ°äº†ç›®å½•æœ«å°¾ */</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>rewinddir()</strong><u>å¯å°†ç›®å½•æµé‡ç½®ä¸ºç›®å½•èµ·ç‚¹ã€‚</u></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">rewinddir</span><span class="params">(DIR *dirp)</span>;</span><br></pre></td></tr></table></figure><p>dirpï¼šç›®å½•å¥æŸ„ã€‚<br>è¿”å›å€¼ï¼šæ— è¿”å›å€¼ã€‚</p><p>å…³é—­ç›®å½•close()å‡½æ•°ç”¨äºå…³é—­å¤„äºæ‰“å¼€çŠ¶æ€çš„ç›®å½•ï¼ŒåŒæ—¶é‡Šæ”¾ä»–æ‰€ç”¨çš„èµ„æºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">closedir</span><span class="params">(DIR *dirp)</span>;</span><br></pre></td></tr></table></figure><p>dirpï¼šç›®å½•å¥æŸ„ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p><strong>è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•</strong></p><p>Linux ä¸‹çš„æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å½“å‰å·¥ä½œç›®å½•ï¼ˆcurrent working directoryï¼‰ï¼Œå½“å‰å·¥ä½œç›®å½•æ˜¯è¯¥è¿›ç¨‹è§£æã€æœç´¢ç›¸å¯¹è·¯å¾„åçš„èµ·ç‚¹ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿è¡Œä¸€ä¸ªè¿›ç¨‹æ—¶ã€å…¶çˆ¶è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•å°†è¢«è¯¥è¿›ç¨‹æ‰€ç»§æ‰¿ï¼Œæˆä¸ºè¯¥è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ã€‚å¯é€šè¿‡ getcwd å‡½æ•°æ¥è·å–è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">getcwd</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><p>bufï¼šgetcwd()å°†å†…å«å½“å‰å·¥ä½œç›®å½•ç»å¯¹è·¯å¾„çš„å­—ç¬¦ä¸²å­˜æ”¾åœ¨ buf ç¼“å†²åŒºä¸­ã€‚<br>sizeï¼šç¼“å†²åŒºçš„å¤§å°ï¼Œåˆ†é…çš„ç¼“å†²åŒºå¤§å°å¿…é¡»è¦å¤§äºå­—ç¬¦ä¸²é•¿åº¦ï¼Œå¦åˆ™è°ƒç”¨å°†ä¼šå¤±è´¥ã€‚<br>è¿”å›å€¼ï¼šå¦‚æœè°ƒç”¨æˆåŠŸå°†è¿”å›æŒ‡å‘ buf çš„æŒ‡é’ˆï¼Œå¤±è´¥å°†è¿”å› NULLï¼Œå¹¶è®¾ç½® errnoã€‚</p><p><strong>æ”¹å˜å½“å‰å·¥ä½œç›®å½•</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">chdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fchdir</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure><p>pathï¼šå°†è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•æ›´æ”¹ä¸º path å‚æ•°æŒ‡å®šçš„ç›®å½•ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ã€ä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒæŒ‡å®šçš„ç›®å½•å¿…é¡»è¦å­˜åœ¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚<br>fdï¼šå°†è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•æ›´æ”¹ä¸º fd æ–‡ä»¶æè¿°ç¬¦æ‰€æŒ‡å®šçš„ç›®å½•ï¼ˆè­¬å¦‚ä½¿ç”¨ open å‡½æ•°æ‰“å¼€ä¸€ä¸ªç›®å½•ï¼‰ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸå‡è¿”å› 0ï¼›å¤±è´¥å‡è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><h3 id="åˆ é™¤æ–‡ä»¶"><a href="#åˆ é™¤æ–‡ä»¶" class="headerlink" title="åˆ é™¤æ–‡ä»¶"></a>åˆ é™¤æ–‡ä»¶</h3><p><strong>ä½¿ç”¨unlinkå‡½æ•°åˆ é™¤ä¸€ä¸ªæ–‡ä»¶</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname)</span>;</span><br></pre></td></tr></table></figure><p>pathnameï¼šéœ€è¦åˆ é™¤çš„æ–‡ä»¶è·¯å¾„ï¼Œå¯ä½¿ç”¨ç›¸å¯¹è·¯å¾„ã€ä¹Ÿå¯ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œå¦‚æœ pathname å‚æ•°æŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ unlink()å¤±è´¥ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p>unlink()ç³»ç»Ÿè°ƒç”¨å®è´¨ä¸Šæ˜¯ç§»é™¤ pathname å‚æ•°æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„å¯¹åº”çš„ç›®å½•é¡¹ï¼ˆä»å…¶çˆ¶çº§ç›®å½•ä¸­ç§»é™¤è¯¥ç›®å½•é¡¹ï¼‰ï¼Œå¹¶å°†æ–‡ä»¶çš„ inode é“¾æ¥è®¡æ•°å°† 1ï¼Œå¦‚æœè¯¥æ–‡ä»¶è¿˜æœ‰å…¶å®ƒç¡¬é“¾æ¥ï¼Œåˆ™ä»»å¯é€šè¿‡å…¶å®ƒé“¾æ¥è®¿é—®è¯¥æ–‡ä»¶çš„æ•°æ®ï¼›åªæœ‰å½“é“¾æ¥è®¡æ•°å˜ä¸º 0 æ—¶ï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹æ‰å¯è¢«åˆ é™¤ã€‚å¦ä¸€ä¸ªæ¡ä»¶ä¹Ÿä¼šé˜»æ­¢åˆ é™¤æ–‡ä»¶çš„å†…å®¹â€”åªè¦æœ‰è¿›ç¨‹æ‰“å¼€äº†è¯¥æ–‡ä»¶ï¼Œå…¶å†…å®¹ä¹Ÿä¸èƒ½è¢«åˆ é™¤ã€‚å…³é—­ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥æ‰“å¼€è¯¥æ–‡ä»¶çš„è¿›ç¨‹ä¸ªæ•°ï¼Œå¦‚æœè¿™ä¸ªè®¡æ•°è¾¾åˆ° 0ï¼Œå†…æ ¸å†å»æ£€æŸ¥å…¶é“¾æ¥è®¡æ•°ï¼Œå¦‚æœé“¾æ¥è®¡æ•°ä¹Ÿæ˜¯ 0ï¼Œé‚£ä¹ˆå°±åˆ é™¤è¯¥æ–‡ä»¶å¯¹åº”çš„å†…å®¹ï¼ˆä¹Ÿå°±æ˜¯æ–‡ä»¶å¯¹åº”çš„ inode ä»¥åŠæ•°æ®å—è¢«å›æ”¶ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶å­˜åœ¨å¤šä¸ªç¡¬é“¾æ¥ï¼Œåˆ é™¤å…¶ä¸­ä»»ä½•ä¸€ä¸ªç¡¬é“¾æ¥ï¼Œå…¶inode å’Œæ•°æ®å—å¹¶æ²¡æœ‰è¢«å›æ”¶ï¼Œè¿˜å¯é€šè¿‡å…¶å®ƒç¡¬é“¾æ¥è®¿é—®æ–‡ä»¶çš„æ•°æ®ï¼‰ã€‚</p><p><strong>ä½¿ç”¨ remove å‡½æ•°åˆ é™¤æ–‡ä»¶</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">remove</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname)</span>;</span><br></pre></td></tr></table></figure><p>pathnameï¼šéœ€è¦åˆ é™¤çš„æ–‡ä»¶æˆ–ç›®å½•è·¯å¾„ï¼Œå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ã€ä¹Ÿå¯æ˜¯å†³å®šè·¯å¾„ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚<br>pathname å‚æ•°æŒ‡å®šçš„æ˜¯ä¸€ä¸ªéç›®å½•æ–‡ä»¶ï¼Œé‚£ä¹ˆ remove()å»è°ƒç”¨ unlink()ï¼Œå¦‚æœ pathname å‚æ•°æŒ‡å®šçš„æ˜¯ä¸€ä¸ªç›®å½•ï¼Œé‚£ä¹ˆ remove()å»è°ƒç”¨ rmdir()ã€‚</p><h3 id="æ–‡ä»¶é‡å‘½å"><a href="#æ–‡ä»¶é‡å‘½å" class="headerlink" title="æ–‡ä»¶é‡å‘½å"></a>æ–‡ä»¶é‡å‘½å</h3><p>æœ¬å°èŠ‚ç»™å¤§å®¶ä»‹ç» rename()ç³»ç»Ÿè°ƒç”¨ï¼Œå€ŸåŠ©äº rename()æ—¢å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œé‡å‘½åï¼Œåˆå¯ä»¥å°†æ–‡ä»¶ç§»è‡³åŒä¸€æ–‡ä»¶ç³»ç»Ÿä¸­çš„å¦ä¸€ä¸ªç›®å½•ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">rename</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *oldpath, <span class="type">const</span> <span class="type">char</span> *newpath)</span>;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶è®¾ç½® errnoã€‚</p><p>æ ¹æ® oldpathã€newpath çš„ä¸åŒï¼Œæœ‰ä»¥ä¸‹ä¸åŒçš„æƒ…å†µéœ€è¦è¿›è¡Œè¯´æ˜ï¼š<br>âš« è‹¥ newpath å‚æ•°æŒ‡å®šçš„æ–‡ä»¶æˆ–ç›®å½•å·²ç»å­˜åœ¨ï¼Œåˆ™å°†å…¶è¦†ç›–ï¼›<br>âš« è‹¥ newpath å’Œ oldpath æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ™ä¸å‘ç”Ÿå˜åŒ–ï¼ˆä¸”è°ƒç”¨æˆåŠŸï¼‰ã€‚<br>âš« rename()ç³»ç»Ÿè°ƒç”¨å¯¹å…¶ä¸¤ä¸ªå‚æ•°ä¸­çš„è½¯é“¾æ¥å‡ä¸è¿›è¡Œè§£å¼•ç”¨ã€‚å¦‚æœ oldpath æ˜¯ä¸€ä¸ªè½¯é“¾æ¥ï¼Œé‚£ä¹ˆå°†é‡å‘½åè¯¥è½¯é“¾æ¥ï¼›å¦‚æœ newpath æ˜¯ä¸€ä¸ªè½¯é“¾æ¥ï¼Œåˆ™ä¼šå°†å…¶ç§»é™¤ã€è¢«è¦†ç›–ã€‚<br>âš« å¦‚æœ oldpath æŒ‡ä»£æ–‡ä»¶ï¼Œè€Œéç›®å½•ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å°† newpath æŒ‡å®šä¸ºä¸€ä¸ªç›®å½•çš„è·¯å¾„åã€‚è¦æƒ³é‡å‘½å<br>ä¸€ä¸ªæ–‡ä»¶åˆ°æŸä¸€ä¸ªç›®å½•ä¸‹ï¼Œnewpath å¿…é¡»åŒ…å«æ–°çš„æ–‡ä»¶åã€‚<br>âš« å¦‚æœ oldpath æŒ‡ä»£ä¸ºä¸€ä¸ªç›®å½•ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œnewpath è¦ä¹ˆä¸å­˜åœ¨ï¼Œè¦ä¹ˆå¿…é¡»æŒ‡å®šä¸ºä¸€ä¸ªç©ºç›®å½•ã€‚<br>âš« oldpath å’Œ newpath æ‰€æŒ‡ä»£çš„æ–‡ä»¶å¿…é¡»ä½äºåŒä¸€æ–‡ä»¶ç³»ç»Ÿã€‚ç”±å‰é¢çš„ä»‹ç»ï¼Œå¯ä»¥å¾—å‡ºæ­¤ç»“è®ºï¼<br>âš« ä¸èƒ½å¯¹.ï¼ˆå½“å‰ç›®å½•ï¼‰å’Œ..ï¼ˆä¸Šä¸€çº§ç›®å½•ï¼‰è¿›è¡Œé‡å‘½åã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxæ ‡å‡†IOåº“</title>
      <link href="/2022/11/12/2022-11-12-Linux%E6%A0%87%E5%87%86IO%E5%BA%93/"/>
      <url>/2022/11/12/2022-11-12-Linux%E6%A0%87%E5%87%86IO%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h2 id="æ ‡å‡†IOåº“"><a href="#æ ‡å‡†IOåº“" class="headerlink" title="æ ‡å‡†IOåº“"></a>æ ‡å‡†IOåº“</h2><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>æ‰€è°“æ ‡å‡† I&#x2F;O åº“åˆ™æ˜¯æ ‡å‡† C åº“ä¸­ç”¨äºæ–‡ä»¶ I&#x2F;O æ“ä½œï¼ˆè­¬å¦‚è¯»æ–‡ä»¶ã€å†™æ–‡ä»¶ç­‰ï¼‰ç›¸å…³çš„ä¸€ç³»åˆ—åº“å‡½æ•°çš„é›†åˆï¼Œé€šå¸¸æ ‡å‡† I&#x2F;O åº“å‡½æ•°ç›¸å…³çš„å‡½æ•°å®šä¹‰éƒ½åœ¨å¤´æ–‡ä»¶ä¸­ã€‚</p><p><u>è®¾è®¡åº“å‡½æ•°æ˜¯ä¸ºäº†æä¾›æ¯”åº•å±‚ç³»ç»Ÿè°ƒç”¨æ›´ä¸ºæ–¹ä¾¿ã€å¥½ç”¨çš„è°ƒç”¨æ¥å£ï¼Œè™½ç„¶æ ‡å‡† I&#x2F;O æ„å»ºäºæ–‡ä»¶ I&#x2F;O ä¹‹ä¸Šï¼Œä½†æ ‡å‡† I&#x2F;O å´æœ‰å®ƒè‡ªå·±çš„ä¼˜åŠ¿ã€‚</u></p><p>æ ‡å‡† I&#x2F;O å’Œæ–‡ä»¶ I&#x2F;O çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><p>âš« è™½ç„¶æ ‡å‡† I&#x2F;O å’Œæ–‡ä»¶ I&#x2F;O éƒ½æ˜¯ C è¯­è¨€å‡½æ•°ï¼Œä½†æ˜¯æ ‡å‡† I&#x2F;O æ˜¯æ ‡å‡† C åº“å‡½æ•°ï¼Œè€Œæ–‡ä»¶ I&#x2F;O åˆ™æ˜¯ Linux<br>ç³»ç»Ÿè°ƒç”¨ï¼›<br>âš« æ ‡å‡† I&#x2F;O æ˜¯ç”±æ–‡ä»¶ I&#x2F;O å°è£…è€Œæ¥ï¼Œæ ‡å‡† I&#x2F;O å†…éƒ¨å®é™…ä¸Šæ˜¯è°ƒç”¨æ–‡ä»¶ I&#x2F;O æ¥å®Œæˆå®é™…æ“ä½œçš„ï¼›<br>âš« å¯ç§»æ¤æ€§ï¼šæ ‡å‡† I&#x2F;O ç›¸æ¯”äºæ–‡ä»¶ I&#x2F;O å…·æœ‰æ›´å¥½çš„å¯ç§»æ¤æ€§ã€‚</p><p>âš« æ€§èƒ½ã€æ•ˆç‡ï¼šæ ‡å‡† I&#x2F;O åº“åœ¨ç”¨æˆ·ç©ºé—´ç»´æŠ¤äº†è‡ªå·±çš„ stdio ç¼“å†²åŒºï¼Œæ‰€ä»¥æ ‡å‡† I&#x2F;O æ˜¯å¸¦æœ‰ç¼“å­˜çš„ï¼Œè€Œ<br>æ–‡ä»¶ I&#x2F;O åœ¨ç”¨æˆ·ç©ºé—´æ˜¯ä¸å¸¦æœ‰ç¼“å­˜çš„ï¼Œæ‰€ä»¥åœ¨<em>æ€§èƒ½ã€æ•ˆç‡ä¸Šï¼Œæ ‡å‡† I&#x2F;O è¦ä¼˜äºæ–‡ä»¶ I&#x2F;O</em>ã€‚</p><h3 id="FILE-æŒ‡é’ˆ"><a href="#FILE-æŒ‡é’ˆ" class="headerlink" title="FILE æŒ‡é’ˆ"></a>FILE æŒ‡é’ˆ</h3><p>è€Œå¯¹äºæ ‡å‡† I&#x2F;O åº“å‡½æ•°æ¥è¯´ï¼Œå®ƒä»¬çš„æ“ä½œæ˜¯å›´ç»• FILE æŒ‡é’ˆè¿›è¡Œçš„ï¼Œå½“ä½¿ç”¨æ ‡å‡† I&#x2F;O åº“å‡½æ•°æ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ª<br>æ–‡ä»¶æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ FILE ç±»å‹å¯¹è±¡çš„æŒ‡é’ˆï¼ˆFILE *ï¼‰ï¼Œä½¿ç”¨è¯¥ FILE æŒ‡é’ˆä¸è¢«æ‰“å¼€æˆ–åˆ›å»ºçš„æ–‡ä»¶ç›¸å…³<br>è”ï¼Œç„¶åè¯¥ FILE æŒ‡é’ˆå°±ç”¨äºåç»­çš„æ ‡å‡† I&#x2F;O æ“ä½œï¼ˆä½¿ç”¨æ ‡å‡† I&#x2F;O åº“å‡½æ•°è¿›è¡Œ I&#x2F;O æ“ä½œï¼‰ï¼Œæ‰€ä»¥ç”±æ­¤å¯çŸ¥ï¼Œ<br>FILE æŒ‡é’ˆçš„ä½œç”¨ç›¸å½“äºæ–‡ä»¶æè¿°ç¬¦ï¼Œåªä¸è¿‡ FILE æŒ‡é’ˆç”¨äºæ ‡å‡† I&#x2F;O åº“å‡½æ•°ä¸­ã€è€Œæ–‡ä»¶æè¿°ç¬¦åˆ™ç”¨äºæ–‡ä»¶<br>I&#x2F;O ç³»ç»Ÿè°ƒç”¨ä¸­ã€‚</p><p>FILE æ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°æ®ç±»å‹ï¼Œå®ƒåŒ…å«äº†æ ‡å‡† I&#x2F;O åº“å‡½æ•°ä¸ºç®¡ç†æ–‡ä»¶æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨äºå®é™…<br>I&#x2F;O çš„æ–‡ä»¶æè¿°ç¬¦ã€æŒ‡å‘æ–‡ä»¶ç¼“å†²åŒºçš„æŒ‡é’ˆã€ç¼“å†²åŒºçš„é•¿åº¦ã€å½“å‰ç¼“å†²åŒºä¸­çš„å­—èŠ‚æ•°ä»¥åŠå‡ºé”™æ ‡å¿—ç­‰ã€‚FILE<br>æ•°æ®ç»“æ„å®šä¹‰åœ¨æ ‡å‡† I&#x2F;O åº“å‡½æ•°å¤´æ–‡ä»¶ stdio.h ä¸­ã€‚</p><h3 id="æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯"><a href="#æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯" class="headerlink" title="æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯"></a>æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯</h3><p>æ‰€è°“æ ‡å‡†è¾“å…¥è®¾å¤‡æŒ‡çš„å°±æ˜¯è®¡ç®—æœºç³»ç»Ÿçš„æ ‡å‡†çš„è¾“å…¥è®¾å¤‡ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è®¡ç®—æœºæ‰€è¿æ¥çš„é”®ç›˜ï¼›è€Œæ ‡å‡†è¾“å‡ºè®¾å¤‡æŒ‡çš„æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸­ç”¨äºè¾“å‡ºæ ‡å‡†ä¿¡æ¯çš„è®¾å¤‡ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è®¡ç®—æœºæ‰€è¿æ¥çš„æ˜¾ç¤ºå™¨ï¼›æ ‡å‡†é”™è¯¯è®¾å¤‡åˆ™æŒ‡çš„æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸­ç”¨äºæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯çš„è®¾å¤‡ï¼Œé€šå¸¸ä¹ŸæŒ‡çš„æ˜¯æ˜¾ç¤ºå™¨è®¾å¤‡ã€‚</p><p>ç”¨æˆ·é€šè¿‡æ ‡å‡†è¾“å…¥è®¾å¤‡ä¸ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œè¿›ç¨‹å°†ä»æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰æ–‡ä»¶ä¸­å¾—åˆ°è¾“å…¥æ•°æ®ï¼Œå°†æ­£å¸¸è¾“å‡º<br>æ•°æ®ï¼ˆè­¬å¦‚ç¨‹åºä¸­ printf æ‰“å°è¾“å‡ºçš„å­—ç¬¦ä¸²ï¼‰è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰æ–‡ä»¶ï¼Œè€Œå°†é”™è¯¯ä¿¡æ¯ï¼ˆè­¬å¦‚å‡½æ•°è°ƒç”¨æŠ¥é”™æ‰“å°çš„ä¿¡æ¯ï¼‰è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰æ–‡ä»¶ã€‚</p><h3 id="æ‰“å¼€æ–‡ä»¶fopen"><a href="#æ‰“å¼€æ–‡ä»¶fopen" class="headerlink" title="æ‰“å¼€æ–‡ä»¶fopen()"></a>æ‰“å¼€æ–‡ä»¶fopen()</h3><p>åœ¨æ ‡å‡† I&#x2F;O ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åº“å‡½æ•°fopen()æ‰“å¼€æˆ–åˆ›å»ºæ–‡ä»¶.å‡½æ•°åŸå‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *mode)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>pathï¼šå‚æ•° path æŒ‡å‘æ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ã€ä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ã€‚<br>modeï¼šå‚æ•° mode æŒ‡å®šäº†å¯¹è¯¥æ–‡ä»¶çš„è¯»å†™æƒé™ï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚<br>è¿”å›å€¼ï¼šè°ƒç”¨æˆåŠŸè¿”å›ä¸€ä¸ªæŒ‡å‘ FILE ç±»å‹å¯¹è±¡çš„æŒ‡é’ˆï¼ˆFILE *ï¼‰ï¼Œè¯¥æŒ‡é’ˆä¸æ‰“å¼€æˆ–åˆ›å»ºçš„æ–‡ä»¶ç›¸å…³è”ï¼Œ<br>åç»­çš„æ ‡å‡† I&#x2F;O æ“ä½œå°†å›´ç»• FILE æŒ‡é’ˆè¿›è¡Œã€‚å¦‚æœå¤±è´¥åˆ™è¿”å› NULLï¼Œå¹¶è®¾ç½® errno ä»¥æŒ‡ç¤ºé”™è¯¯åŸå› ã€‚</p><table><thead><tr><th>mode</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>r</td><td>ä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶</td></tr><tr><td>r+</td><td>ä»¥å¯è¯»ã€å¯å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶</td></tr><tr><td>w</td><td>ä»¥åªå†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœå‚æ•°pathæŒ‡å®šçš„æ–‡ä»¶å­˜åœ¨ï¼Œå°†æ–‡ä»¶é•¿åº¦æˆªæ–­ä¸º0ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºè¯¥æ–‡ä»¶</td></tr><tr><td>w+</td><td>ä»¥å¯è¯»ã€å¯å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœå‚æ•° path æŒ‡å®šçš„æ–‡ä»¶å­˜åœ¨ï¼Œå°†æ–‡ä»¶é•¿åº¦æˆªæ–­ä¸º 0ï¼›å¦‚æœæŒ‡å®šæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºè¯¥æ–‡ä»¶ã€‚</td></tr><tr><td>a</td><td>ä»¥åªå†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œæ‰“å¼€ä»¥è¿›è¡Œè¿½åŠ å†…å®¹ï¼ˆåœ¨æ–‡ä»¶æœ«å°¾å†™å…¥ï¼‰ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºè¯¥æ–‡ä»¶ã€‚</td></tr><tr><td>a+</td><td>ä»¥å¯è¯»ã€å¯å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œä»¥è¿½åŠ æ–¹å¼å†™å…¥ï¼ˆåœ¨æ–‡ä»¶æœ«å°¾å†™å…¥ï¼‰ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºè¯¥æ–‡ä»¶ã€‚</td></tr></tbody></table><p>è™½ç„¶è°ƒç”¨ fopen()å‡½æ•°æ–°å»ºæ–‡ä»¶æ—¶æ— æ³•æ‰‹åŠ¨æŒ‡å®šæ–‡ä»¶çš„æƒé™ï¼Œä½†å´æœ‰ä¸€ä¸ªé»˜è®¤å€¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH (0666)</span><br></pre></td></tr></table></figure><h3 id="fclose-å…³é—­æ–‡ä»¶"><a href="#fclose-å…³é—­æ–‡ä»¶" class="headerlink" title="fclose()å…³é—­æ–‡ä»¶"></a>fclose()å…³é—­æ–‡ä»¶</h3><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fclose</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•° stream ä¸º FILE ç±»å‹æŒ‡é’ˆï¼Œè°ƒç”¨æˆåŠŸè¿”å› 0ï¼›å¤±è´¥å°†è¿”å› EOFï¼ˆä¹Ÿå°±æ˜¯-1ï¼‰ï¼Œå¹¶ä¸”ä¼šè®¾ç½® errno æ¥<br>æŒ‡ç¤ºé”™è¯¯åŸå› ã€‚</p><h3 id="è¯»æ–‡ä»¶å’Œå†™æ–‡ä»¶"><a href="#è¯»æ–‡ä»¶å’Œå†™æ–‡ä»¶" class="headerlink" title="è¯»æ–‡ä»¶å’Œå†™æ–‡ä»¶"></a>è¯»æ–‡ä»¶å’Œå†™æ–‡ä»¶</h3><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">fread</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, FILE *stream)</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">fwrite</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *ptr, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, FILE *stream)</span>;</span><br></pre></td></tr></table></figure><p>åº“å‡½æ•° fread()ç”¨äºè¯»å–æ–‡ä»¶æ•°æ®ï¼Œå…¶å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š</p><p>ptrï¼šfread()å°†è¯»å–åˆ°çš„æ•°æ®å­˜æ”¾åœ¨å‚æ•° ptr æŒ‡å‘çš„ç¼“å†²åŒºä¸­ï¼›<br>sizeï¼šfread()ä»æ–‡ä»¶è¯»å– nmemb ä¸ªæ•°æ®é¡¹ï¼Œæ¯ä¸€ä¸ªæ•°æ®é¡¹çš„å¤§å°ä¸º size ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æ€»å…±è¯»å–çš„æ•°æ®å¤§<br>å°ä¸º nmemb * size ä¸ªå­—èŠ‚ã€‚<br>nmembï¼šå‚æ•° nmemb æŒ‡å®šäº†è¯»å–æ•°æ®é¡¹çš„ä¸ªæ•°ã€‚<br>streamï¼šFILE æŒ‡é’ˆã€‚<br>è¿”å›å€¼ï¼šè°ƒç”¨æˆåŠŸæ—¶è¿”å›è¯»å–åˆ°çš„æ•°æ®é¡¹çš„æ•°ç›®ï¼ˆæ•°æ®é¡¹æ•°ç›®å¹¶ä¸ç­‰äºå®é™…è¯»å–çš„å­—èŠ‚æ•°ï¼Œé™¤éå‚æ•°<br>size ç­‰äº 1ï¼‰ï¼›å¦‚æœå‘ç”Ÿé”™è¯¯æˆ–åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼Œåˆ™ fread()è¿”å›çš„å€¼å°†å°äºå‚æ•° nmembï¼Œé‚£ä¹ˆåˆ°åº•å‘ç”Ÿäº†é”™è¯¯è¿˜æ˜¯åˆ°è¾¾äº†æ–‡ä»¶æœ«å°¾ï¼Œfread()ä¸èƒ½åŒºåˆ†æ–‡ä»¶ç»“å°¾å’Œé”™è¯¯ï¼Œç©¶ç«Ÿæ˜¯å“ªä¸€ç§æƒ…å†µï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ ferror()æˆ– feof()å‡½æ•°æ¥åˆ¤æ–­ã€‚</p><p>åº“å‡½æ•° fwrite()ç”¨äºå°†æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå…¶å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>ptrï¼šå°†å‚æ•° ptr æŒ‡å‘çš„ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚<br>sizeï¼šå‚æ•° size æŒ‡å®šäº†æ¯ä¸ªæ•°æ®é¡¹çš„å­—èŠ‚å¤§å°ï¼Œä¸ fread()å‡½æ•°çš„ size å‚æ•°æ„ä¹‰ç›¸åŒã€‚<br>nmembï¼šå‚æ•° nmemb æŒ‡å®šäº†å†™å…¥çš„æ•°æ®é¡¹ä¸ªæ•°ï¼Œä¸ fread()å‡½æ•°çš„ nmemb å‚æ•°æ„ä¹‰ç›¸åŒã€‚<br>streamï¼šFILE æŒ‡é’ˆã€‚<br>è¿”å›å€¼ï¼šè°ƒç”¨æˆåŠŸæ—¶è¿”å›å†™å…¥çš„æ•°æ®é¡¹çš„æ•°ç›®ï¼ˆæ•°æ®é¡¹æ•°ç›®å¹¶ä¸ç­‰äºå®é™…å†™å…¥çš„å­—èŠ‚æ•°ï¼Œé™¤éå‚æ•° size<br>ç­‰äº 1ï¼‰ï¼›å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™ fwrite()è¿”å›çš„å€¼å°†å°äºå‚æ•° nmembï¼ˆæˆ–è€…ç­‰äº 0ï¼‰ã€‚<br>ç”±æ­¤å¯çŸ¥ï¼Œåº“å‡½æ•° fread()ã€fwrite()ä¸­æŒ‡å®šè¯»å–æˆ–å†™å…¥æ•°æ®å¤§å°çš„æ–¹å¼ä¸ç³»ç»Ÿè°ƒç”¨ read()ã€write()ä¸åŒï¼Œ<br>å‰è€…é€šè¿‡ nmembï¼ˆæ•°æ®é¡¹ä¸ªæ•°ï¼‰*sizeï¼ˆæ¯ä¸ªæ•°æ®é¡¹çš„å¤§å°ï¼‰çš„æ–¹å¼æ¥æŒ‡å®šæ•°æ®å¤§å°ï¼Œè€Œåè€…åˆ™ç›´æ¥é€šè¿‡ä¸€ä¸ª size å‚æ•°æŒ‡å®šæ•°æ®å¤§å°ã€‚</p><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">char</span> buf[] = <span class="string">&quot;Hello World!\n&quot;</span>;</span><br><span class="line"> FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€æ–‡ä»¶ */</span></span><br><span class="line"> <span class="keyword">if</span> ((fp = fopen(<span class="string">&quot;./test_file&quot;</span>, <span class="string">&quot;w&quot;</span>)) == <span class="literal">NULL</span>) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;fopen error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶æ‰“å¼€æˆåŠŸ!\n&quot;</span>);</span><br><span class="line"> <span class="comment">/* å†™å…¥æ•°æ® */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">sizeof</span>(buf) &gt; fwrite(buf, <span class="number">1</span>, <span class="keyword">sizeof</span>(buf), fp)) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;fwrite error\n&quot;</span>);</span><br><span class="line"> fclose(fp);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ•°æ®å†™å…¥æˆåŠŸ!\n&quot;</span>);</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line"> fclose(fp);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">char</span> buf[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line"> <span class="type">int</span> size;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€æ–‡ä»¶ */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="literal">NULL</span> == (fp = fopen(<span class="string">&quot;./test_file&quot;</span>, <span class="string">&quot;r&quot;</span>))) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;fopen error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æ–‡ä»¶æ‰“å¼€æˆåŠŸ!\n&quot;</span>);</span><br><span class="line"> <span class="comment">/* è¯»å–æ•°æ® */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">12</span> &gt; (size = fread(buf, <span class="number">1</span>, <span class="number">12</span>, fp))) &#123;</span><br><span class="line"> <span class="keyword">if</span> (ferror(fp)) &#123; <span class="comment">//ä½¿ç”¨ ferror åˆ¤æ–­æ˜¯å¦æ˜¯å‘ç”Ÿé”™è¯¯</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;fread error\n&quot;</span>);</span><br><span class="line"> fclose(fp);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å¦‚æœæœªå‘ç”Ÿé”™è¯¯åˆ™æ„å‘³ç€å·²ç»åˆ°è¾¾äº†æ–‡ä»¶æœ«å°¾ */</span></span><br><span class="line">&#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;æˆåŠŸè¯»å–%d ä¸ªå­—èŠ‚æ•°æ®: %s\n&quot;</span>, size, buf);</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line"> fclose(fp);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fseekå®šä½"><a href="#fseekå®šä½" class="headerlink" title="fseekå®šä½"></a>fseekå®šä½</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fseek</span><span class="params">(FILE *stream, <span class="type">long</span> offset, <span class="type">int</span> whence)</span>;</span><br></pre></td></tr></table></figure><p>streamï¼šFILE æŒ‡é’ˆã€‚<br>offsetï¼šä¸ lseek()å‡½æ•°çš„ offset å‚æ•°æ„ä¹‰ç›¸åŒã€‚<br>whenceï¼šä¸ lseek()å‡½æ•°çš„ whence å‚æ•°æ„ä¹‰ç›¸åŒã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼›å‘ç”Ÿé”™è¯¯å°†è¿”å›-1ï¼Œå¹¶ä¸”ä¼šè®¾ç½® errno ä»¥æŒ‡ç¤ºé”™è¯¯åŸå› ï¼›ä¸ lseek()å‡½æ•°çš„è¿”å›å€¼<br>æ„ä¹‰ä¸åŒï¼Œè¿™é‡Œè¦æ³¨æ„ï¼<br>è°ƒç”¨åº“å‡½æ•° fread()ã€fwrite()è¯»å†™æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶çš„è¯»å†™ä½ç½®åç§»é‡ä¼šè‡ªåŠ¨é€’å¢ï¼Œä½¿ç”¨ fseek()å¯æ‰‹åŠ¨è®¾ç½®<br>æ–‡ä»¶å½“å‰çš„è¯»å†™ä½ç½®åç§»é‡ã€‚</p><p><u>å°†ä¸€ä¸ªæ–‡ä»¶çš„æ‰“å¼€å†™å…¥æ–‡ä»¶æ•°æ®ï¼Œå¹¶è¿›è¡Œè¯»å–è¦ä½¿ç”¨fseekæ¥å°†è¯»å†™ä½ç½®ç§»åŠ¨åˆ°å¤´éƒ¨æ‰èƒ½è¯»å–ï¼Œå¦åˆ™fead</u></p><p><u>è¯»å–åé¢çš„ç©ºç™½ä¿¡æ¯ï¼Œæ²¡æœ‰å†…å®¹ã€‚</u></p><h3 id="ftell-å‡½æ•°"><a href="#ftell-å‡½æ•°" class="headerlink" title="ftell()å‡½æ•°"></a>ftell()å‡½æ•°</h3><p>ç”¨äºè·å–æ–‡ä»¶å½“å‰çš„è¯»å†™ä½ç½®åç§»é‡ï¼Œå‡½æ•°åŸå‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">long</span> <span class="title function_">ftell</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•° stream æŒ‡å‘å¯¹åº”çš„æ–‡ä»¶ï¼Œå‡½æ•°è°ƒç”¨æˆåŠŸå°†è¿”å›å½“å‰è¯»å†™ä½ç½®åç§»é‡ï¼›è°ƒç”¨å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¼šè®¾ç½®<br>errno ä»¥æŒ‡ç¤ºé”™è¯¯åŸå› ã€‚</p><h3 id="feofå‡½æ•°"><a href="#feofå‡½æ•°" class="headerlink" title="feofå‡½æ•°"></a>feofå‡½æ•°</h3><p>åº“å‡½æ•° feof()ç”¨äºæµ‹è¯•å‚æ•° stream æ‰€æŒ‡æ–‡ä»¶çš„ end-of-file æ ‡å¿—ï¼Œå¦‚æœ end-of-file æ ‡å¿—è¢«è®¾ç½®äº†ï¼Œåˆ™è°ƒç”¨<br>feof()å‡½æ•°å°†è¿”å›ä¸€ä¸ªéé›¶å€¼ï¼Œå¦‚æœ end-of-file æ ‡å¿—æ²¡æœ‰è¢«è®¾ç½®ï¼Œåˆ™è¿”å› 0</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">feof</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure><h3 id="ferror-å‡½æ•°"><a href="#ferror-å‡½æ•°" class="headerlink" title="ferror()å‡½æ•°"></a>ferror()å‡½æ•°</h3><p>åº“å‡½æ•° ferror()ç”¨äºæµ‹è¯•å‚æ•° stream æ‰€æŒ‡æ–‡ä»¶çš„é”™è¯¯æ ‡å¿—ï¼Œå¦‚æœé”™è¯¯æ ‡å¿—è¢«è®¾ç½®äº†ï¼Œåˆ™è°ƒç”¨ ferror()å‡½æ•°<br>å°†è¿”å›ä¸€ä¸ªéé›¶å€¼ï¼Œå¦‚æœé”™è¯¯æ ‡å¿—æ²¡æœ‰è¢«è®¾ç½®ï¼Œåˆ™è¿”å› 0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ferror</span><span class="params">(FILE *stream)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="clearerrå‡½æ•°"><a href="#clearerrå‡½æ•°" class="headerlink" title="clearerrå‡½æ•°"></a>clearerrå‡½æ•°</h3><p>åº“å‡½æ•° clearerr()ç”¨äºæ¸…é™¤ end-of-file æ ‡å¿—å’Œé”™è¯¯æ ‡å¿—ï¼Œå½“è°ƒç”¨ feof()æˆ– ferror()æ ¡éªŒè¿™äº›æ ‡å¿—åï¼Œé€šå¸¸éœ€<br>è¦æ¸…é™¤è¿™äº›æ ‡å¿—ï¼Œé¿å…ä¸‹æ¬¡æ ¡éªŒæ—¶ä½¿ç”¨åˆ°çš„æ˜¯ä¸Šä¸€æ¬¡è®¾ç½®çš„å€¼ï¼Œæ­¤æ—¶å¯ä»¥æ‰‹åŠ¨è°ƒç”¨ clearerr()å‡½æ•°æ¸…é™¤æ ‡å¿—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">clearerr</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure><h3 id="IOç¼“å†²"><a href="#IOç¼“å†²" class="headerlink" title="IOç¼“å†²"></a>IOç¼“å†²</h3><p>è°ƒç”¨ write()åä»…ä»…åªæ˜¯å°†è¿™ 5 ä¸ªå­—èŠ‚æ•°æ®æ‹·è´åˆ°äº†å†…æ ¸ç©ºé—´çš„ç¼“å†²åŒºä¸­ï¼Œæ‹·è´å®Œæˆä¹‹åå‡½æ•°å°±è¿”å›äº†ï¼Œåœ¨åé¢çš„æŸä¸ªæ—¶åˆ»ï¼Œå†…æ ¸ä¼šå°†å…¶ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥ï¼ˆåˆ·æ–°ï¼‰åˆ°ç£ç›˜è®¾å¤‡ä¸­ï¼Œæ‰€ä»¥ç”±æ­¤å¯çŸ¥ï¼Œç³»ç»Ÿè°ƒç”¨ write()ä¸ç£ç›˜æ“ä½œå¹¶ä¸æ˜¯åŒæ­¥çš„ï¼Œwrite()å‡½æ•°å¹¶ä¸ä¼šç­‰å¾…æ•°æ®çœŸæ­£å†™å…¥åˆ°ç£ç›˜ä¹‹åå†è¿”å›ã€‚å¦‚æœåœ¨æ­¤æœŸé—´ï¼Œå…¶å®ƒè¿›ç¨‹è°ƒç”¨ read()å‡½æ•°è¯»å–è¯¥æ–‡ä»¶çš„è¿™å‡ ä¸ªå­—èŠ‚æ•°æ®ï¼Œé‚£ä¹ˆå†…æ ¸å°†è‡ªåŠ¨ä»ç¼“å†²åŒºä¸­è¯»å–è¿™å‡ ä¸ªå­—èŠ‚æ•°æ®è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚</p><p>è¿™ä¸ªå†…æ ¸ç¼“å†²åŒºå°±ç§°ä¸ºæ–‡ä»¶ I&#x2F;O çš„å†…æ ¸ç¼“å†²ã€‚è¿™æ ·çš„è®¾è®¡ï¼Œç›®çš„æ˜¯ä¸ºäº†æé«˜æ–‡ä»¶ I&#x2F;O çš„é€Ÿåº¦å’Œæ•ˆç‡ï¼Œä½¿å¾—ç³»ç»Ÿè°ƒç”¨ read()ã€write()çš„æ“ä½œæ›´ä¸ºå¿«é€Ÿï¼Œä¸éœ€è¦ç­‰å¾…ç£ç›˜æ“ä½œï¼ˆå°†æ•°æ®å†™å…¥åˆ°ç£ç›˜æˆ–ä»ç£ç›˜è¯»å–å‡ºæ•°æ®ï¼‰ï¼Œç£ç›˜æ“ä½œé€šå¸¸æ˜¯æ¯”è¾ƒç¼“æ…¢çš„ã€‚åŒæ—¶è¿™ä¸€è®¾è®¡ä¹Ÿæ›´ä¸ºé«˜æ•ˆï¼Œå‡å°‘äº†å†…æ ¸æ“ä½œç£ç›˜çš„æ¬¡æ•°ï¼Œè­¬å¦‚çº¿ç¨‹1 è°ƒç”¨ write()å‘æ–‡ä»¶å†™å…¥æ•°æ®â€abcdâ€ï¼Œçº¿ç¨‹ 2 ä¹Ÿè°ƒç”¨ write()å‘æ–‡ä»¶å†™å…¥æ•°æ®â€1234â€ï¼Œè¿™æ ·çš„è¯ï¼Œæ•°æ®â€abcdâ€å’Œâ€1234â€éƒ½è¢«ç¼“å­˜åœ¨äº†å†…æ ¸çš„ç¼“å†²åŒºä¸­ï¼Œåœ¨ç¨åå†…æ ¸ä¼šå°†å®ƒä»¬ä¸€èµ·å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œåªå‘èµ·ä¸€æ¬¡ç£ç›˜æ“ä½œè¯·æ±‚ï¼›åŠ å…¥æ²¡æœ‰å†…æ ¸ç¼“å†²åŒºï¼Œé‚£ä¹ˆæ¯ä¸€æ¬¡è°ƒç”¨ write()ï¼Œå†…æ ¸å°±ä¼šæ‰§è¡Œä¸€æ¬¡ç£ç›˜æ“ä½œã€‚</p><h4 id="åˆ·æ–°æ–‡ä»¶-I-x2F-O-çš„å†…æ ¸ç¼“å†²åŒº"><a href="#åˆ·æ–°æ–‡ä»¶-I-x2F-O-çš„å†…æ ¸ç¼“å†²åŒº" class="headerlink" title="åˆ·æ–°æ–‡ä»¶ I&#x2F;O çš„å†…æ ¸ç¼“å†²åŒº"></a>åˆ·æ–°æ–‡ä»¶ I&#x2F;O çš„å†…æ ¸ç¼“å†²åŒº</h4><p>å½“æˆ‘ä»¬åœ¨ Ubuntu ç³»ç»Ÿä¸‹æ‹·è´æ–‡ä»¶åˆ° U ç›˜æ—¶ï¼Œæ–‡ä»¶æ‹·è´å®Œæˆä¹‹åï¼Œé€šå¸¸åœ¨æ‹”æ‰ U ç›˜ä¹‹å‰ï¼Œéœ€è¦æ‰§è¡Œ sync å‘½ä»¤è¿›è¡ŒåŒæ­¥æ“ä½œï¼Œè¿™ä¸ªåŒæ­¥æ“ä½œå…¶å®å°±æ˜¯å°†æ–‡ä»¶ I&#x2F;O å†…æ ¸ç¼“å†²åŒºä¸­çš„æ•°æ®æ›´æ–°åˆ° U ç›˜ç¡¬ä»¶è®¾å¤‡ï¼Œæ‰€ä»¥å¦‚æœåœ¨æ²¡æœ‰æ‰§è¡Œ sync å‘½ä»¤æ—¶æ‹”æ‰ U ç›˜ï¼Œå¾ˆå¯èƒ½å°±ä¼šå¯¼è‡´æ‹·è´åˆ° U ç›˜ä¸­çš„æ–‡ä»¶é­åˆ°ç ´åï¼</p><h4 id="fsync-å‡½æ•°"><a href="#fsync-å‡½æ•°" class="headerlink" title="fsync()å‡½æ•°"></a>fsync()å‡½æ•°</h4><p>ç³»ç»Ÿè°ƒç”¨ fsync()å°†å‚æ•° fd æ‰€æŒ‡æ–‡ä»¶çš„å†…å®¹æ•°æ®å’Œå…ƒæ•°æ®å†™å…¥ç£ç›˜ï¼Œåªæœ‰åœ¨å¯¹ç£ç›˜è®¾å¤‡çš„å†™å…¥æ“ä½œå®Œæˆä¹‹åï¼Œfsync()å‡½æ•°æ‰ä¼šè¿”å›ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsync</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•° fd è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ï¼Œå‡½æ•°è°ƒç”¨æˆåŠŸå°†è¿”å› 0ï¼Œå¤±è´¥è¿”å›-1 å¹¶è®¾ç½® errno ä»¥æŒ‡ç¤ºé”™è¯¯åŸå› ã€‚</p><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_FILE <span class="string">&quot;./rfile&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_FILE <span class="string">&quot;./wfile&quot;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> buf[BUF_SIZE];</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> rfd, wfd;</span><br><span class="line"> <span class="type">size_t</span> size;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€æºæ–‡ä»¶ */</span></span><br><span class="line"> rfd = open(READ_FILE, O_RDONLY);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; rfd) </span><br><span class="line"> &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€ç›®æ ‡æ–‡ä»¶ */</span></span><br><span class="line"> wfd = open(WRITE_FILE, O_WRONLY | O_CREAT | O_TRUNC, <span class="number">0664</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; wfd) </span><br><span class="line">    &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* æ‹·è´æ•°æ® */</span></span><br><span class="line"> <span class="keyword">while</span>(<span class="number">0</span> &lt; (size = read(rfd, buf, BUF_SIZE)))</span><br><span class="line"> write(wfd, buf, size);</span><br><span class="line"> <span class="comment">/* å¯¹ç›®æ ‡æ–‡ä»¶æ‰§è¡Œ fsync åŒæ­¥ */</span></span><br><span class="line"> fsync(wfd);</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶é€€å‡ºç¨‹åº */</span></span><br><span class="line"> close(rfd);</span><br><span class="line">  close(wfd);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="fdatasync-å‡½æ•°"><a href="#fdatasync-å‡½æ•°" class="headerlink" title="fdatasync()å‡½æ•°"></a>fdatasync()å‡½æ•°</h4><p>ç³»ç»Ÿè°ƒç”¨ fdatasync()ä¸ fsync()ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äº fdatasync()ä»…å°†å‚æ•° fd æ‰€æŒ‡æ–‡ä»¶çš„å†…å®¹æ•°æ®å†™å…¥ç£<br>ç›˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fdatasync</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure><h4 id="sync-å‡½æ•°"><a href="#sync-å‡½æ•°" class="headerlink" title="sync()å‡½æ•°"></a>sync()å‡½æ•°</h4><p>ç³»ç»Ÿè°ƒç”¨ sync()ä¼šå°†æ‰€æœ‰æ–‡ä»¶ I&#x2F;O å†…æ ¸ç¼“å†²åŒºä¸­çš„æ–‡ä»¶å†…å®¹æ•°æ®å’Œå…ƒæ•°æ®å…¨éƒ¨æ›´æ–°åˆ°ç£ç›˜è®¾å¤‡ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sync</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><h4 id="O-DSYNC-æ ‡å¿—"><a href="#O-DSYNC-æ ‡å¿—" class="headerlink" title="O_DSYNC æ ‡å¿—"></a>O_DSYNC æ ‡å¿—</h4><p>åœ¨è°ƒç”¨ open()å‡½æ•°æ—¶ï¼ŒæŒ‡å®š O_DSYNC æ ‡å¿—ï¼Œå…¶æ•ˆæœç±»ä¼¼äºåœ¨æ¯ä¸ª write()è°ƒç”¨ä¹‹åè°ƒç”¨ fdatasync()å‡½æ•°<br>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><h4 id="O-SYNC-æ ‡å¿—"><a href="#O-SYNC-æ ‡å¿—" class="headerlink" title="O_SYNC æ ‡å¿—"></a>O_SYNC æ ‡å¿—</h4><p>åœ¨è°ƒç”¨ open()å‡½æ•°æ—¶ï¼ŒæŒ‡å®š O_SYNC æ ‡å¿—ï¼Œä½¿å¾—æ¯ä¸ª write()è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨å°†æ–‡ä»¶å†…å®¹æ•°æ®å’Œå…ƒæ•°æ®åˆ·<br>æ–°åˆ°ç£ç›˜è®¾å¤‡ä¸­ï¼Œå…¶æ•ˆæœç±»ä¼¼äºåœ¨æ¯ä¸ª write()è°ƒç”¨ä¹‹åè°ƒç”¨ fsync()å‡½æ•°è¿›è¡Œæ•°æ®åŒæ­¥</p><h4 id="ç›´æ¥IO"><a href="#ç›´æ¥IO" class="headerlink" title="ç›´æ¥IO"></a>ç›´æ¥IO</h4><p>Linux å…è®¸åº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œæ–‡ä»¶ I&#x2F;O æ“ä½œæ—¶ç»•è¿‡å†…æ ¸ç¼“å†²åŒºï¼Œä»ç”¨æˆ·ç©ºé—´ç›´æ¥å°†æ•°æ®ä¼ é€’åˆ°æ–‡ä»¶æˆ–ç£ç›˜è®¾å¤‡ï¼ŒæŠŠè¿™ç§æ“ä½œä¹Ÿç§°ä¸ºç›´æ¥ I&#x2F;Oï¼ˆdirect I&#x2F;Oï¼‰æˆ–è£¸ I&#x2F;Oï¼ˆraw I&#x2F;Oï¼‰ã€‚</p><p>å› ä¸ºç›´æ¥ I&#x2F;O æ¶‰åŠåˆ°å¯¹ç£ç›˜è®¾å¤‡çš„ç›´æ¥è®¿é—®ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œç›´æ¥ I&#x2F;O æ—¶ï¼Œå¿…é¡»è¦éµå®ˆä»¥ä¸‹ä¸‰ä¸ªå¯¹é½é™åˆ¶è¦æ±‚ï¼š<br>âš« åº”ç”¨ç¨‹åºä¸­ç”¨äºå­˜æ”¾æ•°æ®çš„ç¼“å†²åŒºï¼Œå…¶å†…å­˜èµ·å§‹åœ°å€å¿…é¡»ä»¥å—å¤§å°çš„æ•´æ•°å€è¿›è¡Œå¯¹é½ï¼›<br>âš« å†™æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶çš„ä½ç½®åç§»é‡å¿…é¡»æ˜¯å—å¤§å°çš„æ•´æ•°å€ï¼›<br>âš« å†™å…¥åˆ°æ–‡ä»¶çš„æ•°æ®å¤§å°å¿…é¡»æ˜¯å—å¤§å°çš„æ•´æ•°å€ã€‚</p><h4 id="stdioç¼“å†²"><a href="#stdioç¼“å†²" class="headerlink" title="stdioç¼“å†²"></a>stdioç¼“å†²</h4><p>æ ‡å‡† I&#x2F;Oï¼ˆfopenã€freadã€fwriteã€fcloseã€fseek ç­‰ï¼‰æ˜¯ C è¯­è¨€æ ‡å‡†åº“å‡½æ•°ï¼Œè€Œæ–‡ä»¶ I&#x2F;Oï¼ˆopenã€readã€writeã€closeã€lseek ç­‰ï¼‰æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè™½ç„¶æ ‡å‡† I&#x2F;O æ˜¯åœ¨æ–‡ä»¶ I&#x2F;O åŸºç¡€ä¸Šè¿›è¡Œå°è£…è€Œå®ç°ï¼ˆè­¬å¦‚ fopen å†…éƒ¨å®é™…ä¸Šè°ƒç”¨äº† openã€fread å†…éƒ¨è°ƒç”¨äº† read ç­‰ï¼‰ï¼Œä½†åœ¨æ•ˆç‡ã€æ€§èƒ½ä¸Šæ ‡å‡† I&#x2F;O è¦ä¼˜äºæ–‡ä»¶ I&#x2F;Oï¼Œå…¶åŸå› åœ¨äºæ ‡å‡† I&#x2F;O å®ç°ç»´æŠ¤äº†è‡ªå·±çš„ç¼“å†²åŒºï¼ŒæŠŠè¿™ä¸ªç¼“å†²åŒºç§°ä¸º stdio ç¼“å†²åŒºã€‚ä¸ºäº†å‡å°‘è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œæ ‡å‡† I&#x2F;O å‡½æ•°ä¼šå°†ç”¨æˆ·å†™å…¥æˆ–è¯»å–æ–‡ä»¶çš„æ•°æ®ç¼“å­˜åœ¨ stdio ç¼“å†²åŒºï¼Œç„¶åå†ä¸€æ¬¡æ€§å°† stdio ç¼“å†²åŒºä¸­ç¼“å­˜çš„æ•°æ®é€šè¿‡è°ƒç”¨ç³»ç»Ÿè°ƒç”¨I&#x2F;Oï¼ˆæ–‡ä»¶ I&#x2F;Oï¼‰å†™å…¥åˆ°æ–‡ä»¶ I&#x2F;O å†…æ ¸ç¼“å†²åŒºæˆ–è€…æ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„ buf ä¸­ã€‚</p><h5 id="stdioç¼“å†²åŒºçš„å‡½æ•°"><a href="#stdioç¼“å†²åŒºçš„å‡½æ•°" class="headerlink" title="stdioç¼“å†²åŒºçš„å‡½æ•°"></a>stdioç¼“å†²åŒºçš„å‡½æ•°</h5><h5 id="setvbuf-å‡½æ•°"><a href="#setvbuf-å‡½æ•°" class="headerlink" title="setvbuf()å‡½æ•°"></a>setvbuf()å‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">setvbuf</span><span class="params">(FILE *stream, <span class="type">char</span> *buf, <span class="type">int</span> mode, <span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><p>streamï¼šFILE æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šå¯¹åº”çš„æ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶éƒ½å¯ä»¥è®¾ç½®å®ƒå¯¹åº”çš„ stdio ç¼“å†²åŒºã€‚<br>bufï¼šå¦‚æœå‚æ•° buf ä¸ä¸º NULLï¼Œé‚£ä¹ˆ buf æŒ‡å‘ size å¤§å°çš„å†…å­˜åŒºåŸŸå°†ä½œä¸ºè¯¥æ–‡ä»¶çš„ stdio ç¼“å†²åŒºï¼Œå› ä¸ºstdio åº“ä¼šä½¿ç”¨ buf æŒ‡å‘çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥åº”è¯¥ä»¥åŠ¨æ€ï¼ˆåˆ†é…åœ¨å †å†…å­˜ï¼‰æˆ–é™æ€çš„æ–¹å¼åœ¨å †ä¸­ä¸ºè¯¥ç¼“å†²åŒºåˆ†é…ä¸€å—ç©ºé—´ï¼Œè€Œä¸æ˜¯åˆ†é…åœ¨æ ˆä¸Šçš„å‡½æ•°å†…çš„è‡ªåŠ¨å˜é‡ï¼ˆå±€éƒ¨å˜é‡ï¼‰ã€‚å¦‚æœ buf ç­‰äº NULLï¼Œé‚£ä¹ˆ stdio åº“ä¼šè‡ªåŠ¨åˆ†é…ä¸€å—ç©ºé—´ä½œä¸ºè¯¥æ–‡ä»¶çš„ stdio ç¼“å†²åŒºï¼ˆé™¤éå‚æ•° mode é…ç½®ä¸ºéç¼“å†²æ¨¡å¼ï¼‰ã€‚<br>modeï¼šå‚æ•° mode ç”¨äºæŒ‡å®šç¼“å†²åŒºçš„ç¼“å†²ç±»å‹ï¼Œå¯å–å€¼å¦‚ä¸‹ï¼š<br>âš« _IONBFï¼šä¸å¯¹ I&#x2F;O è¿›è¡Œç¼“å†²ï¼ˆæ— ç¼“å†²ï¼‰ã€‚æ„å‘³ç€æ¯ä¸ªæ ‡å‡† I&#x2F;O å‡½æ•°å°†ç«‹å³è°ƒç”¨ write()æˆ–è€… read()ï¼Œå¹¶ä¸”å¿½ç•¥ buf å’Œ size å‚æ•°ï¼Œå¯ä»¥åˆ†åˆ«æŒ‡å®šä¸¤ä¸ªå‚æ•°ä¸º NULL å’Œ 0ã€‚æ ‡å‡†é”™è¯¯ stderr é»˜è®¤å±äºè¿™ä¸€ç§ç±»å‹ï¼Œä»è€Œä¿è¯é”™è¯¯ä¿¡æ¯èƒ½å¤Ÿç«‹å³è¾“å‡ºã€‚<br>âš« _IOLBFï¼šé‡‡ç”¨è¡Œç¼“å†² I&#x2F;Oã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“åœ¨è¾“å…¥æˆ–è¾“å‡ºä¸­é‡åˆ°æ¢è¡Œç¬¦â€\nâ€æ—¶ï¼Œæ ‡å‡† I&#x2F;O æ‰ä¼šæ‰§è¡Œæ–‡ä»¶ I&#x2F;O æ“ä½œã€‚å¯¹äºè¾“å‡ºæµï¼Œåœ¨è¾“å‡ºä¸€ä¸ªæ¢è¡Œç¬¦å‰å°†æ•°æ®ç¼“å­˜ï¼ˆé™¤éç¼“å†²åŒºå·²ç»è¢«å¡«æ»¡ï¼‰ï¼Œå½“è¾“å‡ºæ¢è¡Œç¬¦æ—¶ï¼Œå†å°†è¿™ä¸€è¡Œæ•°æ®é€šè¿‡æ–‡ä»¶ I&#x2F;O write()å‡½æ•°åˆ·å…¥åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼›å¯¹äºè¾“å…¥æµï¼Œæ¯æ¬¡è¯»å–ä¸€è¡Œæ•°æ®ã€‚å¯¹äºç»ˆç«¯è®¾å¤‡é»˜è®¤é‡‡ç”¨çš„å°±æ˜¯è¡Œç¼“å†²æ¨¡å¼ï¼Œè­¬å¦‚æ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡ºã€‚<br>âš« _IOFBFï¼šé‡‡ç”¨å…¨ç¼“å†² I&#x2F;Oã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨å¡«æ»¡ stdio ç¼“å†²åŒºåæ‰è¿›è¡Œæ–‡ä»¶ I&#x2F;O æ“ä½œï¼ˆreadã€writeï¼‰ã€‚å¯¹äºè¾“å‡ºæµï¼Œå½“ fwrite å†™å…¥æ–‡ä»¶çš„æ•°æ®å¡«æ»¡ç¼“å†²åŒºæ—¶ï¼Œæ‰è°ƒç”¨ write()å°† stdio ç¼“å†²åŒºä¸­çš„æ•°æ®åˆ·å…¥å†…æ ¸ç¼“å†²åŒºï¼›å¯¹äºè¾“å…¥æµï¼Œæ¯æ¬¡è¯»å– stdio ç¼“å†²åŒºå¤§å°ä¸ªå­—èŠ‚æ•°æ®ã€‚é»˜è®¤æ™®é€šç£ç›˜ä¸Šçš„å¸¸è§„æ–‡ä»¶é»˜è®¤å¸¸ç”¨è¿™ç§ç¼“å†²æ¨¡å¼ã€‚<br>sizeï¼šæŒ‡å®šç¼“å†²åŒºçš„å¤§å°ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥å°†è¿”å›ä¸€ä¸ªé 0 å€¼ï¼Œå¹¶ä¸”ä¼šè®¾ç½® errno æ¥æŒ‡ç¤ºé”™è¯¯åŸå› ã€‚</p><h5 id="setbuffer-å‡½æ•°"><a href="#setbuffer-å‡½æ•°" class="headerlink" title="setbuffer()å‡½æ•°"></a>setbuffer()å‡½æ•°</h5><p>setbufferå‡½æ•°ç±»ä¼¼setbufï¼ˆï¼‰ä½†æ˜¯å…è®¸è°ƒç”¨è€…æŒ‡å®šbufç¼“å†²åŒºçš„å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setbuffer</span><span class="params">(FILE *stream, <span class="type">char</span> *buf, <span class="type">size_t</span> size)</span>;</span><br></pre></td></tr></table></figure><h5 id="åˆ·æ–°-stdio-ç¼“å†²åŒº"><a href="#åˆ·æ–°-stdio-ç¼“å†²åŒº" class="headerlink" title="åˆ·æ–° stdio ç¼“å†²åŒº"></a>åˆ·æ–° stdio ç¼“å†²åŒº</h5><p>æ— è®ºæˆ‘ä»¬é‡‡å–ä½•ç§ç¼“å†²æ¨¡å¼ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥ä½¿ç”¨åº“å‡½æ•° fflush()æ¥å¼ºåˆ¶åˆ·æ–°ï¼ˆå°†è¾“å‡ºåˆ° stdio ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œé€šè¿‡ write()å‡½æ•°ï¼‰stdio ç¼“å†²åŒºï¼Œè¯¥å‡½æ•°ä¼šåˆ·æ–°æŒ‡å®šæ–‡ä»¶çš„ stdio è¾“å‡ºç¼“å†²åŒºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fflush</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line"> fflush(<span class="built_in">stdout</span>); <span class="comment">//åˆ·æ–°æ ‡å‡†è¾“å‡º stdio ç¼“å†²åŒº</span></span><br><span class="line"> <span class="keyword">for</span> ( ; ; )</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸€äº›å…¶å®ƒçš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨åˆ·æ–° stdio ç¼“å†²åŒºï¼Œè­¬å¦‚å½“æ–‡ä»¶å…³é—­æ—¶ã€ç¨‹åºé€€å‡ºæ—¶ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/set.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxæ·±å…¥æ–‡ä»¶IO</title>
      <link href="/2022/11/10/2022-11-10-Linux%E6%B7%B1%E5%85%A5%E6%96%87%E4%BB%B6IO/"/>
      <url>/2022/11/10/2022-11-10-Linux%E6%B7%B1%E5%85%A5%E6%96%87%E4%BB%B6IO/</url>
      
        <content type="html"><![CDATA[<h3 id="Linuxç®¡ç†æ–‡ä»¶"><a href="#Linuxç®¡ç†æ–‡ä»¶" class="headerlink" title="Linuxç®¡ç†æ–‡ä»¶"></a>Linuxç®¡ç†æ–‡ä»¶</h3><h4 id="é™æ€æ–‡ä»¶ä¸inode"><a href="#é™æ€æ–‡ä»¶ä¸inode" class="headerlink" title="é™æ€æ–‡ä»¶ä¸inode"></a>é™æ€æ–‡ä»¶ä¸inode</h4><p>æ–‡ä»¶å­˜æ”¾åœ¨ç£ç›˜æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¹¶ä¸”ä»¥ä¸€ç§å›ºå®šçš„å½¢å¼è¿›è¡Œå­˜æ”¾ï¼Œç§°ä¸ºé™æ€æ–‡ä»¶ã€‚è°ƒç”¨ open å‡½æ•°çš„æ—¶å€™ï¼Œä¼šå°†æ–‡ä»¶æ•°æ®ï¼ˆæ–‡ä»¶å†…å®¹ï¼‰ä»ç£ç›˜ç­‰å—è®¾å¤‡è¯»å–åˆ°å†…å­˜ä¸­ï¼Œå°†æ–‡ä»¶æ•°æ®åœ¨å†…å­˜ä¸­è¿›è¡Œç»´æŠ¤ï¼Œå†…å­˜ä¸­çš„è¿™ä»½æ–‡ä»¶æ•°æ®æˆ‘ä»¬å°±æŠŠå®ƒç§°ä¸ºåŠ¨æ€æ–‡ä»¶ã€‚</p><p>ç¡¬ç›˜çš„æœ€å°å­˜å‚¨å•ä½å«åšâ€œæ‰‡åŒºâ€ï¼ˆSectorï¼‰ï¼Œæ¯ä¸ªæ‰‡åŒºå‚¨å­˜ 512 å­—èŠ‚ï¼ˆç›¸å½“äº 0.5KBï¼‰ï¼Œæ“ä½œç³»ç»Ÿè¯»å–ç¡¬ç›˜çš„æ—¶å€™ï¼Œä¸ä¼šä¸€ä¸ªä¸ªæ‰‡åŒºåœ°è¯»å–ï¼Œè¿™æ ·æ•ˆç‡å¤ªä½ï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§è¿ç»­è¯»å–å¤šä¸ªæ‰‡åŒºï¼Œå³ä¸€æ¬¡æ€§è¯»å–ä¸€ä¸ªâ€œå—â€ï¼ˆblockï¼‰ã€‚è¿™ç§ç”±å¤šä¸ªæ‰‡åŒºç»„æˆçš„â€œå—â€ï¼Œæ˜¯æ–‡ä»¶å­˜å–çš„æœ€å°å•ä½ã€‚â€œå—â€çš„å¤§å°ï¼Œæœ€å¸¸è§çš„4KBï¼Œå³è¿ç»­å…«ä¸ª sector ç»„æˆä¸€ä¸ª blockã€‚</p><p>ç£ç›˜åœ¨è¿›è¡Œåˆ†åŒºã€æ ¼å¼åŒ–çš„æ—¶å€™ä¼šå°†å…¶åˆ†ä¸ºä¸¤ä¸ªåŒºåŸŸï¼Œä¸€ä¸ªæ˜¯æ•°æ®åŒºï¼Œç”¨äºå­˜å‚¨æ–‡ä»¶ä¸­çš„æ•°æ®ï¼›<br>å¦ä¸€ä¸ªæ˜¯ inode åŒºï¼Œç”¨äºå­˜æ”¾ inode tableï¼ˆinode è¡¨ï¼‰ï¼Œinode table ä¸­å­˜æ”¾çš„æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ inodeï¼ˆä¹Ÿæˆä¸º inodeèŠ‚ç‚¹ï¼‰ï¼Œä¸åŒçš„ inode å°±å¯ä»¥è¡¨ç¤ºä¸åŒçš„æ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶éƒ½å¿…é¡»å¯¹åº”ä¸€ä¸ª inodeã€‚</p><p><a href="https://postimg.cc/JD4mjgVd"><img src="https://i.postimg.cc/DZ1Z3kCF/2022-11-10-142428.png" alt="2022-11-10-142428.png"></a></p><p>æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œç³»ç»Ÿå†…éƒ¨ä¼šå°†è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ol><li>ç³»ç»Ÿæ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶åæ‰€å¯¹åº”çš„ inode ç¼–å·ï¼›</li><li>é€šè¿‡ inode ç¼–å·ä» inode table ä¸­æ‰¾åˆ°å¯¹åº”çš„ inode ç»“æ„ä½“ï¼›</li><li>æ ¹æ® inode ç»“æ„ä½“ä¸­è®°å½•çš„ä¿¡æ¯ï¼Œç¡®å®šæ–‡ä»¶æ•°æ®æ‰€åœ¨çš„ blockï¼Œå¹¶è¯»å‡ºæ•°æ®ã€‚</li></ol><p>è°ƒç”¨ open å‡½æ•°å»æ‰“å¼€æ–‡ä»¶çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šç”³è¯·ä¸€æ®µå†…å­˜ï¼ˆä¸€æ®µç¼“å†²åŒºï¼‰ï¼Œå¹¶ä¸”å°†é™æ€æ–‡ä»¶çš„æ•°æ®å†…å®¹ä»ç£ç›˜è¿™äº›å­˜å‚¨è®¾å¤‡ä¸­è¯»å–åˆ°å†…å­˜ä¸­è¿›è¡Œç®¡ç†ã€ç¼“å­˜ï¼ˆä¹ŸæŠŠå†…å­˜ä¸­çš„è¿™ä»½æ–‡ä»¶æ•°æ®å«åšåŠ¨æ€æ–‡ä»¶ã€å†…æ ¸ç¼“å†²åŒºï¼‰ã€‚æ‰“å¼€æ–‡ä»¶åï¼Œä»¥åå¯¹è¿™ä¸ªæ–‡ä»¶çš„è¯»å†™æ“ä½œï¼Œéƒ½æ˜¯é’ˆå¯¹å†…å­˜ä¸­è¿™ä¸€ä»½åŠ¨æ€æ–‡ä»¶è¿›è¡Œç›¸å…³çš„æ“ä½œï¼Œè€Œå¹¶ä¸æ˜¯é’ˆå¯¹ç£ç›˜ä¸­å­˜æ”¾çš„é™æ€æ–‡ä»¶ã€‚</p><p>å› ä¸ºç£ç›˜ã€ç¡¬ç›˜ã€U ç›˜ç­‰å­˜å‚¨è®¾å¤‡åŸºæœ¬éƒ½æ˜¯ Flash å—è®¾å¤‡ï¼Œå› ä¸ºå—è®¾å¤‡ç¡¬ä»¶æœ¬èº«æœ‰è¯»å†™é™åˆ¶ç­‰ç‰¹å¾ï¼Œå—è®¾å¤‡æ˜¯ä»¥ä¸€å—ä¸€å—ä¸ºå•ä½è¿›è¡Œè¯»å†™çš„ï¼ˆä¸€ä¸ªå—åŒ…å«å¤šä¸ªæ‰‡åŒºï¼Œè€Œä¸€ä¸ªæ‰‡åŒºåŒ…å«å¤šä¸ªå­—èŠ‚ï¼‰ï¼Œä¸€ä¸ªå­—èŠ‚çš„æ”¹åŠ¨ä¹Ÿéœ€è¦å°†è¯¥å­—èŠ‚æ‰€åœ¨çš„ block å…¨éƒ¨è¯»å–å‡ºæ¥è¿›è¡Œä¿®æ”¹ï¼Œä¿®æ”¹å®Œæˆä¹‹åå†å†™å…¥å—è®¾å¤‡ä¸­ï¼Œæ‰€ä»¥å¯¼è‡´å¯¹å—è®¾å¤‡çš„è¯»å†™æ“ä½œéå¸¸ä¸çµæ´»ï¼›è€Œå†…å­˜å¯ä»¥æŒ‰å­—èŠ‚ä¸ºå•ä½æ¥æ“ä½œï¼Œè€Œä¸”å¯ä»¥éšæœºæ“ä½œä»»æ„åœ°å€æ•°æ®ï¼Œéå¸¸åœ°å¾ˆçµæ´»ã€‚</p><p>å†…æ ¸ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹è®¾ç½®ä¸€ä¸ªä¸“é—¨çš„æ•°æ®ç»“æ„ç”¨äºç®¡ç†è¯¥è¿›ç¨‹ï¼Œè­¬å¦‚ç”¨äºè®°å½•è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€è¿è¡Œç‰¹å¾ç­‰ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªç§°ä¸ºè¿›ç¨‹æ§åˆ¶å—ï¼ˆProcess control blockï¼Œç¼©å†™PCBï¼‰ã€‚<br>PCB æ•°æ®ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼ˆFile descriptorsï¼‰ï¼Œæ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ç´¢å¼•åˆ°å¯¹åº”çš„æ–‡ä»¶è¡¨ï¼ˆFile tableï¼‰ï¼Œæ–‡ä»¶è¡¨ä¹Ÿæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ä½“ã€‚</p><h4 id="è¿”å›é”™è¯¯å¤„ç†ä¸errno"><a href="#è¿”å›é”™è¯¯å¤„ç†ä¸errno" class="headerlink" title="è¿”å›é”™è¯¯å¤„ç†ä¸errno"></a>è¿”å›é”™è¯¯å¤„ç†ä¸errno</h4><p>åœ¨ Linux ç³»ç»Ÿä¸‹å¯¹å¸¸è§çš„é”™è¯¯åšäº†ä¸€ä¸ªç¼–å·ï¼Œæ¯ä¸€ä¸ªç¼–å·éƒ½ä»£è¡¨ç€æ¯ä¸€ç§ä¸åŒçš„é”™è¯¯ç±»å‹ï¼Œå½“å‡½æ•°æ‰§è¡Œå‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†è¿™ä¸ªé”™è¯¯æ‰€å¯¹åº”çš„ç¼–å·èµ‹å€¼ç»™ errno å˜é‡ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹ï¼ˆç¨‹åºï¼‰éƒ½ç»´æŠ¤äº†è‡ªå·±çš„ errno å˜é‡ï¼Œå®ƒæ˜¯ç¨‹åºä¸­çš„å…¨å±€å˜é‡ï¼Œè¯¥å˜é‡ç”¨äºå­˜å‚¨å°±è¿‘å‘ç”Ÿçš„å‡½æ•°æ‰§è¡Œé”™è¯¯ç¼–å·ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸‹ä¸€æ¬¡çš„é”™è¯¯ç ä¼šè¦†ç›–ä¸Šä¸€æ¬¡çš„é”™è¯¯ç ã€‚</p><p>errno æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª int ç±»å‹çš„å˜é‡ï¼Œç”¨äºå­˜å‚¨é”™è¯¯ç¼–å·ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰§è¡Œæ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨æˆ– C åº“å‡½æ•°å‡ºé”™æ—¶ï¼Œæ“ä½œç³»ç»Ÿéƒ½ä¼šè®¾ç½® errnoã€‚</p><h5 id="å¸¸ç”¨çš„å‡½æ•°perrorå‡½æ•°"><a href="#å¸¸ç”¨çš„å‡½æ•°perrorå‡½æ•°" class="headerlink" title="å¸¸ç”¨çš„å‡½æ•°perrorå‡½æ•°"></a>å¸¸ç”¨çš„å‡½æ•°perrorå‡½æ•°</h5><p>ä¸€èˆ¬ç”¨çš„æœ€å¤šçš„è¿˜æ˜¯è¿™ä¸ªå‡½æ•°ï¼Œè°ƒç”¨æ­¤å‡½æ•°ä¸éœ€è¦ä¼ å…¥ errnoï¼Œå‡½æ•°å†…éƒ¨ä¼šè‡ªå·±å»è·å– errno å˜é‡çš„å€¼ï¼Œè°ƒç”¨æ­¤å‡½æ•°ä¼šç›´æ¥å°†é”™è¯¯æç¤ºå­—ç¬¦ä¸²æ‰“å°å‡ºæ¥ï¼Œè€Œä¸æ˜¯è¿”å›å­—ç¬¦ä¸²ã€‚</p><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">perror</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>sï¼šåœ¨é”™è¯¯æç¤ºå­—ç¬¦ä¸²ä¿¡æ¯ä¹‹å‰ï¼Œå¯åŠ å…¥è‡ªå·±çš„æ‰“å°ä¿¡æ¯ï¼Œä¹Ÿå¯ä¸åŠ ï¼Œä¸åŠ åˆ™ä¼ å…¥ç©ºå­—ç¬¦ä¸²å³å¯ã€‚<br>è¿”å›å€¼ï¼švoid æ— è¿”å›å€¼ã€‚</p><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="comment">/* æ‰“å¼€æ–‡ä»¶ */</span></span><br><span class="line">fd = open(<span class="string">&quot;./test_file&quot;</span>, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span> (<span class="number">-1</span> == fd) &#123;</span><br><span class="line">perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">close(fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="exitã€-exitã€-Exit"><a href="#exitã€-exitã€-Exit" class="headerlink" title="exitã€__exitã€_Exit"></a>exitã€__exitã€_Exit</h4><p>åœ¨ Linux ç³»ç»Ÿä¸‹ï¼Œè¿›ç¨‹ï¼ˆç¨‹åºï¼‰é€€å‡ºå¯ä»¥åˆ†ä¸ºæ­£å¸¸é€€å‡ºå’Œå¼‚å¸¸é€€å‡ºï¼Œæ³¨æ„è¿™é‡Œè¯´çš„å¼‚å¸¸å¹¶ä¸æ˜¯æ‰§è¡Œå‡½æ•°å‡ºç°äº†é”™è¯¯è¿™ç§æƒ…å†µï¼Œå¼‚å¸¸å¾€å¾€æ›´å¤šçš„æ˜¯ä¸€ç§ä¸å¯é¢„æ–™çš„ç³»ç»Ÿå¼‚å¸¸ï¼Œå¯èƒ½æ˜¯æ‰§è¡Œäº†æŸä¸ªå‡½æ•°æ—¶å‘ç”Ÿçš„ã€ä¹Ÿæœ‰å¯èƒ½æ˜¯æ”¶åˆ°äº†æŸç§ä¿¡å·ç­‰.</p><p>main å‡½æ•°ä¸­ä½¿ç”¨ return åè¿”å›ï¼Œreturn æ‰§è¡ŒåæŠŠæ§åˆ¶æƒäº¤ç»™è°ƒç”¨å‡½æ•°ï¼Œç»“æŸè¯¥è¿›ç¨‹ã€‚è°ƒç”¨_exit()å‡½æ•°ä¼šæ¸…é™¤å…¶ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¹¶é”€æ¯å…¶åœ¨å†…æ ¸ä¸­çš„å„ç§æ•°æ®ç»“æ„ï¼Œå…³é—­è¿›ç¨‹çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ç»“æŸè¿›ç¨‹ã€å°†æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿã€‚exit()æ˜¯ä¸€ä¸ªæ ‡å‡† C åº“å‡½æ•°ï¼Œè€Œ_exit()å’Œ_Exit()æ˜¯ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>__exit()å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> _exit(<span class="type">int</span> status);</span><br></pre></td></tr></table></figure><p>_Exit()å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> _Exit(<span class="type">int</span> status);</span><br></pre></td></tr></table></figure><p>exit()å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">exit</span><span class="params">(<span class="type">int</span> status)</span>;</span><br></pre></td></tr></table></figure><h4 id="ç©ºæ´æ–‡ä»¶"><a href="#ç©ºæ´æ–‡ä»¶" class="headerlink" title="ç©ºæ´æ–‡ä»¶"></a>ç©ºæ´æ–‡ä»¶</h4><p>ä½¿ç”¨ write()å‡½æ•°å¯¹æ–‡ä»¶è¿›è¡Œå†™å…¥æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶å°†æ˜¯ä»åç§»æ–‡ä»¶å¤´éƒ¨ 6000 ä¸ªå­—èŠ‚å¤„å¼€å§‹å†™å…¥æ•°æ®ï¼Œä¹Ÿå°±æ„å‘³ç€ 4096~6000 å­—èŠ‚ä¹‹é—´å‡ºç°äº†ä¸€ä¸ªç©ºæ´ï¼Œå› ä¸ºè¿™éƒ¨åˆ†ç©ºé—´å¹¶æ²¡æœ‰å†™å…¥ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥å½¢æˆäº†ç©ºæ´ï¼Œè¿™éƒ¨åˆ†åŒºåŸŸå°±è¢«ç§°ä¸ºæ–‡ä»¶ç©ºæ´ï¼Œé‚£ä¹ˆç›¸åº”çš„è¯¥æ–‡ä»¶ä¹Ÿè¢«ç§°ä¸ºç©ºæ´æ–‡ä»¶ã€‚<br>æ–‡ä»¶ç©ºæ´éƒ¨åˆ†å®é™…ä¸Šå¹¶ä¸ä¼šå ç”¨ä»»ä½•ç‰©ç†ç©ºé—´ï¼Œç›´åˆ°åœ¨æŸä¸ªæ—¶åˆ»å¯¹ç©ºæ´éƒ¨åˆ†è¿›è¡Œå†™å…¥æ•°æ®æ—¶æ‰ä¼šä¸ºå®ƒ<br>åˆ†é…å¯¹åº”çš„ç©ºé—´ï¼Œä½†æ˜¯ç©ºæ´æ–‡ä»¶å½¢æˆæ—¶ï¼Œé€»è¾‘ä¸Šè¯¥æ–‡ä»¶çš„å¤§å°æ˜¯åŒ…å«äº†ç©ºæ´éƒ¨åˆ†çš„å¤§å°çš„</p><p><u>ç©ºæ´æ–‡ä»¶å¯¹å¤šçº¿ç¨‹å…±åŒæ“ä½œæ–‡ä»¶æ˜¯åŠå…¶æœ‰ç”¨çš„</u>ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶ï¼Œå¦‚æœå•ä¸ªçº¿ç¨‹ä»å¤´å¼€å§‹ä¾æ¬¡æ„å»ºè¯¥æ–‡ä»¶éœ€è¦å¾ˆé•¿çš„æ—¶é—´ï¼Œæœ‰ä¸€ç§æ€è·¯å°±æ˜¯å°†æ–‡ä»¶åˆ†ä¸ºå¤šæ®µï¼Œç„¶åä½¿ç”¨å¤šçº¿ç¨‹æ¥æ“ä½œï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£å…¶ä¸­ä¸€æ®µæ•°æ®çš„å†™å…¥ã€‚</p><p>egï¼šæ–°å»ºä¸€ä¸ªç©ºæ´æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> fd;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line"> <span class="type">int</span> i;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€æ–‡ä»¶ */</span></span><br><span class="line"> fd = open(<span class="string">&quot;./hole_file&quot;</span>, O_WRONLY | O_CREAT | O_EXCL,</span><br><span class="line"> S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == fd) &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å°†æ–‡ä»¶è¯»å†™ä½ç½®ç§»åŠ¨åˆ°åç§»æ–‡ä»¶å¤´ 4096 ä¸ªå­—èŠ‚(4K)å¤„ */</span></span><br><span class="line"> ret = lseek(fd, <span class="number">4096</span>, SEEK_SET);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;lseek error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* åˆå§‹åŒ– buffer ä¸º 0xFF */</span></span><br><span class="line"> <span class="built_in">memset</span>(buffer, <span class="number">0xFF</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line"> <span class="comment">/* å¾ªç¯å†™å…¥ 4 æ¬¡ï¼Œæ¯æ¬¡å†™å…¥ 1K */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line"> ret = write(fd, buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line"> close(fd);</span><br><span class="line"> <span class="built_in">exit</span>(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ä»£ç ä¸­ï¼Œä½¿ç”¨ open å‡½æ•°æ–°å»ºäº†ä¸€ä¸ªæ–‡ä»¶ hole_fileï¼Œåœ¨ Linux ç³»ç»Ÿä¸­ï¼Œæ–°å»ºæ–‡ä»¶å¤§å°æ˜¯ 0ï¼Œä¹Ÿå°±<br>æ˜¯æ²¡æœ‰ä»»ä½•æ•°æ®å†™å…¥ï¼Œæ­¤æ—¶ä½¿ç”¨lseekå‡½æ•°å°†è¯»å†™åç§»é‡ç§»åŠ¨åˆ°4Kå­—èŠ‚å¤„ï¼Œå†ä½¿ç”¨writeå‡½æ•°å†™å…¥æ•°æ®0xFFï¼Œæ¯æ¬¡å†™å…¥ 1Kï¼Œä¸€å…±å†™å…¥ 4 æ¬¡ï¼Œä¹Ÿå°±æ˜¯å†™å…¥äº† 4K æ•°æ®ï¼Œä¹Ÿå°±æ„å‘³ç€è¯¥æ–‡ä»¶å‰ 4K æ˜¯æ–‡ä»¶ç©ºæ´éƒ¨åˆ†ï¼Œè€Œå 4Kæ•°æ®æ‰æ˜¯çœŸæ­£å†™å…¥çš„æ•°æ®ã€‚</p><h4 id="O-APPEND-å’Œ-O-TRUNC-æ ‡å¿—"><a href="#O-APPEND-å’Œ-O-TRUNC-æ ‡å¿—" class="headerlink" title="O_APPEND å’Œ O_TRUNC æ ‡å¿—"></a>O_APPEND å’Œ O_TRUNC æ ‡å¿—</h4><p>O_TRUNC è¿™ä¸ªæ ‡å¿—çš„ä½œç”¨æ˜¯è°ƒç”¨ open å‡½æ•°æ‰“å¼€æ–‡ä»¶çš„æ—¶å€™ä¼šå°†æ–‡ä»¶åŸæœ¬çš„å†…å®¹å…¨éƒ¨ä¸¢å¼ƒï¼Œæ–‡ä»¶å¤§å°å˜ä¸º 0ã€‚</p><p><u><strong>O_APPEND</strong></u>æ ‡å¿—ä½œç”¨openå‡½æ•°æºå¸¦äº†O_APPENDï¼Œè°ƒç”¨ open å‡½æ•°æ‰“å¼€æ–‡ä»¶ï¼Œå½“æ¯æ¬¡ä½¿ç”¨ write()å‡½æ•°å¯¹æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠæ–‡ä»¶å½“å‰ä½ç½®åç§»é‡ç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾ï¼Œä»æ–‡ä»¶æœ«å°¾å¼€å§‹å†™å…¥æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ„å‘³ç€æ¯æ¬¡å†™å…¥æ•°æ®éƒ½æ˜¯ä»æ–‡ä»¶æœ«å°¾å¼€å§‹ã€‚</p><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">char</span> buffer[<span class="number">16</span>];</span><br><span class="line"> <span class="type">int</span> fd;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€æ–‡ä»¶ */</span></span><br><span class="line"> fd = open(<span class="string">&quot;./test_file&quot;</span>, O_RDWR | O_APPEND);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == fd) &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* åˆå§‹åŒ– buffer ä¸­çš„æ•°æ® */</span></span><br><span class="line"> <span class="built_in">memset</span>(buffer, <span class="number">0x55</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line"> <span class="comment">/* å†™å…¥æ•°æ®: å†™å…¥ 4 ä¸ªå­—èŠ‚æ•°æ® */</span></span><br><span class="line"> ret = write(fd, buffer, <span class="number">4</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å°† buffer ç¼“å†²åŒºä¸­çš„æ•°æ®å…¨éƒ¨æ¸… 0 */</span></span><br><span class="line"> <span class="built_in">memset</span>(buffer, <span class="number">0x00</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line"> <span class="comment">/* å°†ä½ç½®åç§»é‡ç§»åŠ¨åˆ°è·ç¦»æ–‡ä»¶æœ«å°¾ 4 ä¸ªå­—èŠ‚å¤„ */</span></span><br><span class="line"> ret = lseek(fd, <span class="number">-4</span>, SEEK_END);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;lseek error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* è¯»å–æ•°æ® */</span></span><br><span class="line">    ret = read(fd, buffer, <span class="number">4</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;0x%x 0x%x 0x%x 0x%x\n&quot;</span>, buffer[<span class="number">0</span>], buffer[<span class="number">1</span>],</span><br><span class="line"> buffer[<span class="number">2</span>], buffer[<span class="number">3</span>]);</span><br><span class="line"> ret = <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line"> close(fd);</span><br><span class="line"> <span class="built_in">exit</span>(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨O_APPENDå¤šæ¬¡æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶æµ‹è¯•ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">unsigned</span> <span class="type">char</span> buffer1[<span class="number">4</span>], buffer2[<span class="number">4</span>];</span><br><span class="line"> <span class="type">int</span> fd1, fd2;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="type">int</span> i;</span><br><span class="line"> <span class="comment">/* åˆ›å»ºæ–°æ–‡ä»¶ test_file å¹¶æ‰“å¼€ */</span></span><br><span class="line"> fd1 = open(<span class="string">&quot;./test_file&quot;</span>, O_RDWR | O_CREAT | O_EXCL | O_APPEND,</span><br><span class="line">S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == fd1) &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å†æ¬¡æ‰“å¼€ test_file æ–‡ä»¶ */</span></span><br><span class="line"> fd2 = open(<span class="string">&quot;./test_file&quot;</span>, O_RDWR | O_APPEND);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == fd2) &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> ret = <span class="number">-1</span>;</span><br><span class="line"> <span class="keyword">goto</span> err1;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* buffer æ•°æ®åˆå§‹åŒ– */</span></span><br><span class="line"> buffer1[<span class="number">0</span>] = <span class="number">0x11</span>;</span><br><span class="line"> buffer1[<span class="number">1</span>] = <span class="number">0x22</span>;</span><br><span class="line"> buffer1[<span class="number">2</span>] = <span class="number">0x33</span>;</span><br><span class="line"> buffer1[<span class="number">3</span>] = <span class="number">0x44</span>;</span><br><span class="line"> buffer2[<span class="number">0</span>] = <span class="number">0xAA</span>;</span><br><span class="line"> buffer2[<span class="number">1</span>] = <span class="number">0xBB</span>;</span><br><span class="line"> buffer2[<span class="number">2</span>] = <span class="number">0xCC</span>;</span><br><span class="line"> buffer2[<span class="number">3</span>] = <span class="number">0xDD</span>;</span><br><span class="line"> <span class="comment">/* å¾ªç¯å†™å…¥æ•°æ® */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line"> ret = write(fd1, buffer1, <span class="keyword">sizeof</span>(buffer1));</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err2;</span><br><span class="line"> &#125;</span><br><span class="line"> ret = write(fd2, buffer2, <span class="keyword">sizeof</span>(buffer2));</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err2;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å°†è¯»å†™ä½ç½®åç§»é‡ç§»åŠ¨åˆ°æ–‡ä»¶å¤´ */</span></span><br><span class="line"> ret = lseek(fd1, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;lseek error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err2;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* è¯»å–æ•°æ® */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line"> ret = read(fd1, buffer1, <span class="keyword">sizeof</span>(buffer1));</span><br><span class="line"> <span class="keyword">if</span> (<span class="number">-1</span> == ret) &#123;</span><br><span class="line"> perror(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err2;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;%x%x%x%x&quot;</span>, buffer1[<span class="number">0</span>], buffer1[<span class="number">1</span>],</span><br><span class="line"> buffer1[<span class="number">2</span>], buffer1[<span class="number">3</span>]);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"> ret = <span class="number">0</span>;</span><br><span class="line">err2:</span><br><span class="line"> close(fd2);</span><br><span class="line">err1:</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line"> close(fd1);</span><br><span class="line"> <span class="built_in">exit</span>(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦"><a href="#å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦"></a>å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</h4><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œopen è¿”å›å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦ fd å¯ä»¥è¿›è¡Œå¤åˆ¶ï¼Œå¤åˆ¶æˆåŠŸä¹‹åå¯ä»¥å¾—åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿ç”¨æ–°çš„æ–‡ä»¶æè¿°ç¬¦å’Œæ—§çš„æ–‡ä»¶æè¿°ç¬¦éƒ½å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œ IO æ“ä½œï¼Œå¤åˆ¶å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦å’Œæ—§çš„æ–‡ä»¶æè¿°ç¬¦æ‹¥æœ‰ç›¸åŒçš„æƒé™ï¼Œè­¬å¦‚ä½¿ç”¨æ—§çš„æ–‡ä»¶æè¿°ç¬¦å¯¹æ–‡ä»¶æœ‰è¯»å†™æƒé™ï¼Œé‚£ä¹ˆæ–°çš„æ–‡ä»¶æè¿°ç¬¦åŒæ ·ä¹Ÿå…·æœ‰è¯»å†™æƒé™ã€‚</p><p>dupå‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> oldfd)</span>;</span><br></pre></td></tr></table></figure><p>oldfdï¼šéœ€è¦è¢«å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸæ—¶å°†è¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç”±æ“ä½œç³»ç»Ÿåˆ†é…ï¼Œåˆ†é…ç½®åŸåˆ™éµå¾ªæ–‡ä»¶æè¿°ç¬¦åˆ†é…åŸåˆ™ï¼›<br>å¦‚æœå¤åˆ¶å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¸”ä¼šè®¾ç½® errno å€¼</p><p>egï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">unsigned</span> <span class="type">char</span> buffer1[<span class="number">4</span>], buffer2[<span class="number">4</span>];</span><br><span class="line"> <span class="type">int</span> fd1, fd2;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="type">int</span> i;</span><br><span class="line"> <span class="comment">/* åˆ›å»ºæ–°æ–‡ä»¶ test_file å¹¶æ‰“å¼€ */</span></span><br><span class="line"> fd1 = open(<span class="string">&quot;./test_file&quot;</span>, O_RDWR | O_CREAT | O_EXCL,</span><br><span class="line"> S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);</span><br><span class="line"> <span class="keyword">if</span> (fd1 == <span class="number">-1</span>) &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ */</span></span><br><span class="line"> fd2 = dup(fd1);</span><br><span class="line"> <span class="keyword">if</span> (fd2 == <span class="number">-1</span>) &#123;</span><br><span class="line"> perror(<span class="string">&quot;dup error&quot;</span>);</span><br><span class="line"> ret = <span class="number">-1</span>;</span><br><span class="line"> <span class="keyword">goto</span> err1;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;fd1: %d\nfd2: %d\n&quot;</span>, fd1, fd2);</span><br><span class="line"> <span class="comment">/* buffer æ•°æ®åˆå§‹åŒ– */</span></span><br><span class="line"> buffer1[<span class="number">0</span>] = <span class="number">0x11</span>;</span><br><span class="line"> buffer1[<span class="number">1</span>] = <span class="number">0x22</span>;</span><br><span class="line"> buffer1[<span class="number">2</span>] = <span class="number">0x33</span>;</span><br><span class="line"> buffer1[<span class="number">3</span>] = <span class="number">0x44</span>;</span><br><span class="line"> buffer2[<span class="number">0</span>] = <span class="number">0xAA</span>;</span><br><span class="line"> buffer2[<span class="number">1</span>] = <span class="number">0xBB</span>;</span><br><span class="line"> buffer2[<span class="number">2</span>] = <span class="number">0xCC</span>;</span><br><span class="line"> buffer2[<span class="number">3</span>] = <span class="number">0xDD</span>;</span><br><span class="line"> <span class="comment">/* å¾ªç¯å†™å…¥æ•°æ® */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line"> ret = write(fd1, buffer1, <span class="keyword">sizeof</span>(buffer1));</span><br><span class="line"> <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line"> perror(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err2;</span><br><span class="line"> &#125;</span><br><span class="line"> ret = write(fd2, buffer2, <span class="keyword">sizeof</span>(buffer2));</span><br><span class="line"> <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line"> perror(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err2;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å°†è¯»å†™ä½ç½®åç§»é‡ç§»åŠ¨åˆ°æ–‡ä»¶å¤´ */</span></span><br><span class="line"> ret = lseek(fd1, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"> <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line"> perror(<span class="string">&quot;lseek error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err2;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* è¯»å–æ•°æ® */</span></span><br><span class="line"> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line"> ret = read(fd1, buffer1, <span class="keyword">sizeof</span>(buffer1));</span><br><span class="line"> <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line"> perror(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line"> <span class="keyword">goto</span> err2;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;%x%x%x%x&quot;</span>, buffer1[<span class="number">0</span>], buffer1[<span class="number">1</span>],</span><br><span class="line"> buffer1[<span class="number">2</span>], buffer1[<span class="number">3</span>]);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"> ret = <span class="number">0</span>;</span><br><span class="line">err2:</span><br><span class="line"> close(fd2);</span><br><span class="line">err1:</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line"> close(fd1);</span><br><span class="line"> <span class="built_in">exit</span>(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dup ç³»ç»Ÿè°ƒç”¨åˆ†é…çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯ç”±ç³»ç»Ÿåˆ†é…çš„ï¼Œéµå¾ªæ–‡ä»¶æè¿°ç¬¦åˆ†é…åŸåˆ™ï¼Œå¹¶ä¸èƒ½è‡ªå·±æŒ‡å®šä¸€ä¸ªæ–‡ä»¶<br>æè¿°ç¬¦ï¼Œè¿™æ˜¯ dup ç³»ç»Ÿè°ƒç”¨çš„ä¸€ä¸ªç¼ºé™·ï¼›è€Œ dup2 ç³»ç»Ÿè°ƒç”¨ä¿®å¤äº†è¿™ä¸ªç¼ºé™·ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œä¸éœ€è¦éµå¾ªæ–‡ä»¶æè¿°ç¬¦åˆ†é…åŸåˆ™ã€‚dup2å‡½æ•°åŸå‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup2</span><span class="params">(<span class="type">int</span> oldfd, <span class="type">int</span> newfd)</span>;</span><br></pre></td></tr></table></figure><p>oldfdï¼šéœ€è¦è¢«å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚<br>newfdï¼šæŒ‡å®šä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆéœ€è¦æŒ‡å®šä¸€ä¸ªå½“å‰è¿›ç¨‹æ²¡æœ‰ä½¿ç”¨åˆ°çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸæ—¶å°†è¿”å›ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯æ‰‹åŠ¨æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦ newfdï¼›å¦‚æœå¤åˆ¶å¤±è´¥å°†è¿”å›-1ï¼Œå¹¶ä¸”ä¼šè®¾ç½® errno å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> fd1, fd2;</span><br><span class="line"> <span class="type">int</span> ret;</span><br><span class="line"> <span class="comment">/* åˆ›å»ºæ–°æ–‡ä»¶ test_file å¹¶æ‰“å¼€ */</span></span><br><span class="line"> fd1 = open(<span class="string">&quot;./test_file&quot;</span>, O_RDWR | O_CREAT | O_EXCL,</span><br><span class="line"> S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);</span><br><span class="line"> <span class="keyword">if</span> (fd1 == <span class="number">-1</span>) &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ */</span></span><br><span class="line"> fd2 = dup2(fd1, <span class="number">100</span>);</span><br><span class="line"> <span class="keyword">if</span> (fd2 == <span class="number">-1</span>) &#123;</span><br><span class="line"> perror(<span class="string">&quot;dup error&quot;</span>);</span><br><span class="line"> ret = <span class="number">-1</span>;</span><br><span class="line"> <span class="keyword">goto</span> err1;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;fd1: %d\nfd2: %d\n&quot;</span>, fd1, fd2);</span><br><span class="line"> ret = <span class="number">0</span>;</span><br><span class="line"> close(fd2);</span><br><span class="line">err1:</span><br><span class="line"> <span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line"> close(fd1);</span><br><span class="line"> <span class="built_in">exit</span>(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ–‡ä»¶å…±äº«"><a href="#æ–‡ä»¶å…±äº«" class="headerlink" title="æ–‡ä»¶å…±äº«"></a>æ–‡ä»¶å…±äº«</h4><p>æ–‡ä»¶å…±äº«æŒ‡çš„æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ï¼ˆè­¬å¦‚ç£ç›˜ä¸Šçš„åŒä¸€ä¸ªæ–‡ä»¶ï¼Œå¯¹åº”åŒä¸€ä¸ª inodeï¼‰è¢«å¤šä¸ªç‹¬ç«‹çš„è¯»å†™ä½“åŒæ—¶è¿›è¡Œ IO æ“ä½œã€‚åŒæ—¶è¿›è¡Œ IO æ“ä½œæŒ‡çš„æ˜¯ä¸€ä¸ªè¯»å†™ä½“æ“ä½œæ–‡ä»¶å°šæœªè°ƒç”¨ close å…³é—­çš„æƒ…å†µä¸‹ï¼Œå¦ä¸€ä¸ªè¯»å†™ä½“å»æ“ä½œæ–‡ä»¶ã€‚</p><p>æ–‡ä»¶å…±äº«çš„æ„ä¹‰æœ‰å¾ˆå¤šï¼Œå¤šç”¨äºå¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ç¼–ç¨‹ç¯å¢ƒä¸­ï¼Œè­¬å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ–‡ä»¶å…±äº«çš„æ–¹å¼æ¥å®ç°<br>å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œä»¥å‡å°‘æ–‡ä»¶è¯»å†™æ—¶é—´ã€æå‡æ•ˆç‡ã€‚<br><strong><u>æ–‡ä»¶å…±äº«çš„æ ¸å¿ƒ</strong></u>æ˜¯ï¼šå¦‚ä½•åˆ¶é€ å‡ºå¤šä¸ªä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦æ¥æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ã€‚å…¶å®æ–¹æ³•åœ¨ä¸Šé¢çš„å†…å®¹ä¸­éƒ½å·²ç»ç»™å¤§å®¶ä»‹ç»è¿‡äº†ï¼Œè­¬å¦‚å¤šæ¬¡è°ƒç”¨ open å‡½æ•°é‡å¤æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶å¾—åˆ°å¤šä¸ªä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ã€ä½¿ç”¨ dup()æˆ– dup2()å‡½æ•°å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œå¤åˆ¶ä»¥å¾—åˆ°å¤šä¸ªä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><strong>å¸¸è§ä¸‰ç§æ–‡ä»¶å…±äº«å®ç°æ–¹å¼</strong></p><p>(1)åŒä¸€ä¸ªè¿›ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨ open å‡½æ•°æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶</p><p>(2)ä¸åŒè¿›ç¨‹ä¸­åˆ†åˆ«ä½¿ç”¨ open å‡½æ•°æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶</p><p>(3)åŒä¸€ä¸ªè¿›ç¨‹ä¸­é€šè¿‡ dupï¼ˆdup2ï¼‰å‡½æ•°å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œå¤åˆ¶</p><h4 id="åŸå­æ“ä½œå’Œç«äº‰å†’é™©"><a href="#åŸå­æ“ä½œå’Œç«äº‰å†’é™©" class="headerlink" title="åŸå­æ“ä½œå’Œç«äº‰å†’é™©"></a>åŸå­æ“ä½œå’Œç«äº‰å†’é™©</h4><p>[åŸå­æ“ä½œå’Œç«äº‰å†’é™©]: <a href="https://copyfuture.com/blogs-details/202208241006207606">https://copyfuture.com/blogs-details/202208241006207606</a>â€œç«äº‰å†’é™©â€</p><h4 id="æˆªæ–­æ–‡ä»¶"><a href="#æˆªæ–­æ–‡ä»¶" class="headerlink" title="æˆªæ–­æ–‡ä»¶"></a>æˆªæ–­æ–‡ä»¶</h4><p>truncate()æˆ–ftruncate()å¯å°†æ™®é€šæ–‡ä»¶æˆªæ–­ä¸ºæŒ‡å®šå­—èŠ‚é•¿åº¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">truncate</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">off_t</span> length)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">ftruncate</span><span class="params">(<span class="type">int</span> fd, <span class="type">off_t</span> length)</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œæˆªæ–­æ“ä½œï¼Œå°†æ–‡ä»¶æˆªæ–­ä¸ºå‚æ•° length æŒ‡å®šçš„å­—èŠ‚é•¿åº¦ï¼Œä»€ä¹ˆæ˜¯æˆªæ–­ï¼Ÿå¦‚<br>æœæ–‡ä»¶ç›®å‰çš„å¤§å°å¤§äºå‚æ•° length æ‰€æŒ‡å®šçš„å¤§å°ï¼Œåˆ™å¤šä½™çš„æ•°æ®å°†è¢«ä¸¢å¤±ï¼Œç±»ä¼¼äºå¤šä½™çš„éƒ¨åˆ†è¢«â€œç â€æ‰<br>äº†ï¼›å¦‚æœæ–‡ä»¶ç›®å‰çš„å¤§å°å°äºå‚æ•° length æ‰€æŒ‡å®šçš„å¤§å°ï¼Œåˆ™å°†å…¶è¿›è¡Œæ‰©å±•ï¼Œå¯¹æ‰©å±•éƒ¨åˆ†è¿›è¡Œè¯»å–å°†å¾—åˆ°ç©ºå­—èŠ‚â€\0â€ã€‚</p><p>ä½¿ç”¨ ftruncate()å‡½æ•°è¿›è¡Œæ–‡ä»¶æˆªæ–­æ“ä½œä¹‹å‰ï¼Œå¿…é¡»è°ƒç”¨ open()å‡½æ•°æ‰“å¼€è¯¥æ–‡ä»¶å¾—åˆ°æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”å¿…<br>é¡»è¦å…·æœ‰å¯å†™æƒé™ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ open()æ‰“å¼€æ–‡ä»¶æ—¶éœ€è¦æŒ‡å®š O_WRONLY æˆ– O_RDWRã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> fd;</span><br><span class="line"> <span class="comment">/* æ‰“å¼€ file1 æ–‡ä»¶ */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; (fd = open(<span class="string">&quot;./file1&quot;</span>, O_RDWR))) &#123;</span><br><span class="line"> perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* ä½¿ç”¨ ftruncate å°† file1 æ–‡ä»¶æˆªæ–­ä¸ºé•¿åº¦ 0 å­—èŠ‚ */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; ftruncate(fd, <span class="number">0</span>)) &#123;</span><br><span class="line"> perror(<span class="string">&quot;ftruncate error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* ä½¿ç”¨ truncate å°† file2 æ–‡ä»¶æˆªæ–­ä¸ºé•¿åº¦ 1024 å­—èŠ‚ */</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="number">0</span> &gt; truncate(<span class="string">&quot;./file2&quot;</span>, <span class="number">1024</span>)) &#123;</span><br><span class="line"> perror(<span class="string">&quot;truncate error&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/* å…³é—­ file1 é€€å‡ºç¨‹åº */</span></span><br><span class="line"> close(fd);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxâ€”â€”æ–‡ä»¶IOæ“ä½œ</title>
      <link href="/2022/11/08/2022-11-8-Linux%E2%80%94%E2%80%94%E6%96%87%E4%BB%B6IO%E6%93%8D%E4%BD%9C/"/>
      <url>/2022/11/08/2022-11-8-Linux%E2%80%94%E2%80%94%E6%96%87%E4%BB%B6IO%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h3 id="æ–‡ä»¶IOåŸºç¡€"><a href="#æ–‡ä»¶IOåŸºç¡€" class="headerlink" title="æ–‡ä»¶IOåŸºç¡€"></a>æ–‡ä»¶IOåŸºç¡€</h3><p>æ–‡ä»¶IOæ˜¯æŒ‡å¯¹æ–‡ä»¶çš„è¾“å…¥è¾“å‡ºæ“ä½œã€‚</p><h4 id="æ–‡ä»¶æè¿°ç¬¦"><a href="#æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦"></a>æ–‡ä»¶æè¿°ç¬¦</h4><p>è°ƒç”¨å‡½æ•°ä¼šæœ‰è¿”å›å€¼ï¼Œè¯¥è¿”å›å€¼ä¸ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¹äºLinuxå†…æ ¸è€Œè¨€ï¼Œæ‰€æœ‰æ‰“å¼€æ–‡ä»¶éƒ½ä¼šé€šè¿‡æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œç´¢å¼•ã€‚</p><p>å½“è°ƒç”¨openå‡½æ•°æ‰“å¼€æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå†…æ ¸ä¼šå‘è¿›ç¨‹è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºæŒ‡å¸¦è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ‰€æœ‰æ‰§è¡Œ IO æ“ä½œçš„ç³»ç»Ÿè°ƒç”¨éƒ½æ˜¯é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥ç´¢å¼•åˆ°å¯¹åº”çš„æ–‡ä»¶ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‰“å¼€å¤šä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æ–‡ä»¶æ•°æ˜¯æœ‰é™åˆ¶ï¼Œå¹¶ä¸æ˜¯å¯ä»¥æ— é™åˆ¶æ‰“å¼€å¾ˆå¤šçš„æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ulimit</span> -n<span class="comment">##æŸ¥çœ‹è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„æœ€å¤§æ•°é‡</span></span></span><br><span class="line">1024</span><br></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªè¢«æ‰“å¼€çš„æ–‡ä»¶åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸ä¼šé‡å¤ï¼Œå¦‚æœæ–‡ä»¶è¢«å…³é—­åï¼Œå®ƒå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å°†ä¼šè¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å°†å¯ä»¥å†æ¬¡åˆ†é…ç»™å…¶å®ƒæ‰“å¼€çš„æ–‡ä»¶ã€ä¸å¯¹åº”çš„æ–‡ä»¶ç»‘å®šèµ·æ¥ã€‚</p><p>æ¯æ¬¡ç»™æ‰“å¼€çš„æ–‡ä»¶åˆ†é…æ–‡ä»¶æè¿°ç¬¦éƒ½æ˜¯ä»æœ€å°çš„æ²¡æœ‰è¢«ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆ0~1023ï¼‰å¼€å§‹ï¼Œå½“ä¹‹å‰æ‰“å¼€çš„æ–‡ä»¶è¢«å…³é—­ä¹‹åï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ä¼šè¢«é‡Šæ”¾ï¼Œé‡Šæ”¾ä¹‹åä¹Ÿå°±æˆä¸ºäº†ä¸€ä¸ªæ²¡æœ‰è¢«ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦äº†ã€‚</p><p>ä½†æ˜¯ 0ã€1ã€2 è¿™ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦å·²ç»é»˜è®¤è¢«ç³»ç»Ÿå ç”¨äº†ï¼Œåˆ†åˆ«åˆ†é…ç»™äº†ç³»ç»Ÿæ ‡å‡†è¾“å…¥ï¼ˆ0ï¼‰ã€æ ‡å‡†è¾“å‡ºï¼ˆ1ï¼‰ä»¥åŠæ ‡å‡†é”™è¯¯ï¼ˆ2ï¼‰ã€‚</p><h4 id="openæ‰“å¼€æ–‡ä»¶"><a href="#openæ‰“å¼€æ–‡ä»¶" class="headerlink" title="openæ‰“å¼€æ–‡ä»¶"></a>openæ‰“å¼€æ–‡ä»¶</h4><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags, <span class="type">mode_t</span> mode)</span>;</span><br></pre></td></tr></table></figure><p>open å‡½æ•°ç”¨äºæ‰“å¼€æ–‡ä»¶ï¼Œå½“ç„¶é™¤äº†æ‰“å¼€å·²ç»å­˜åœ¨çš„æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚</p><p>åœ¨åº”ç”¨ç¨‹åºä¸­è°ƒç”¨ open å‡½æ•°å³å¯ä¼ å…¥ 2 ä¸ªå‚æ•°ï¼ˆpathnameã€flagsï¼‰ã€ä¹Ÿå¯ä¼ å…¥ 3 ä¸ªå‚æ•°ï¼ˆpathnameã€flagsã€modeï¼‰ï¼Œä½†æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•° mode éœ€è¦åœ¨ç¬¬äºŒä¸ªå‚æ•° flags æ»¡è¶³æ¡ä»¶æ—¶æ‰ä¼šæœ‰æ•ˆï¼Œç¨åå°†å¯¹æ­¤è¿›è¡Œè¯´æ˜ï¼›ä»å›¾ 2.3.1 å¯çŸ¥ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ open å‡½æ•°æ—¶ï¼Œéœ€è¦åŒ…å« 3 ä¸ªå¤´æ–‡ä»¶â€œ#include<br>â€ã€â€œ#include â€ã€â€œ#include â€ã€‚</p><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å®šä¹‰</p><p>pathnameï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºæ ‡è¯†éœ€è¦æ‰“å¼€æˆ–åˆ›å»ºçš„æ–‡ä»¶ï¼Œå¯ä»¥åŒ…å«è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„æˆ–è€…ç›¸å¯¹è·¯å¾„ï¼‰ä¿¡æ¯ã€‚</p><p>flagsï¼šè°ƒç”¨openå‡½æ•°æ—¶éœ€è¦æä¾›çš„æ ‡å¿—ï¼ŒåŒ…æ‹¬æ–‡ä»¶è®¿é—®æ¨¡å¼æ ‡å¿—ä»¥åŠå…¶å®ƒæ–‡ä»¶ç›¸å…³æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—ä½¿ç”¨å®å®šä¹‰è¿›è¡Œæè¿°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;./app.c&quot;</span>, O_RDWR)<span class="comment">//æ‰“å¼€ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶ï¼Œä½¿ç”¨å¯è¯»å¯å†™çš„æ–¹å¼æ‰“å¼€</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">-1</span> == fd)</span><br><span class="line"><span class="keyword">return</span> fd;</span><br></pre></td></tr></table></figure><h4 id="writeå†™æ–‡ä»¶"><a href="#writeå†™æ–‡ä»¶" class="headerlink" title="writeå†™æ–‡ä»¶"></a>writeå†™æ–‡ä»¶</h4><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°è¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š</p><p>fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚å°†è¿›è¡Œå†™æ“ä½œçš„æ–‡ä»¶æ‰€å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™ write å‡½æ•°ã€‚<br>bufï¼šæŒ‡å®šå†™å…¥æ•°æ®å¯¹åº”çš„ç¼“å†²åŒºã€‚<br>countï¼šæŒ‡å®šå†™å…¥çš„å­—èŠ‚æ•°ã€‚<br>è¿”å›å€¼ï¼šå¦‚æœæˆåŠŸå°†è¿”å›å†™å…¥çš„å­—èŠ‚æ•°ï¼ˆ0 è¡¨ç¤ºæœªå†™å…¥ä»»ä½•å­—èŠ‚ï¼‰ï¼Œå¦‚æœæ­¤æ•°å­—å°äº count å‚æ•°ï¼Œè¿™ä¸æ˜¯é”™è¯¯ï¼Œè­¬å¦‚ç£ç›˜ç©ºé—´å·²æ»¡ï¼Œå¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼›å¦‚æœå†™å…¥å‡ºé”™ï¼Œåˆ™è¿”å›-1ã€‚</p><h4 id="readè¯»æ–‡ä»¶"><a href="#readè¯»æ–‡ä»¶" class="headerlink" title="readè¯»æ–‡ä»¶"></a>readè¯»æ–‡ä»¶</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚ä¸ write å‡½æ•°çš„ fd å‚æ•°æ„ä¹‰ç›¸åŒã€‚</p><p>bufï¼šæŒ‡å®šç”¨äºå­˜å‚¨è¯»å–æ•°æ®çš„ç¼“å†²åŒºã€‚</p><p>countï¼šæŒ‡å®šéœ€è¦è¯»å–çš„å­—èŠ‚æ•°ã€‚</p><p>è¿”å›å€¼ï¼šå¦‚æœè¯»å–æˆåŠŸå°†è¿”å›è¯»å–åˆ°çš„å­—èŠ‚æ•°ï¼Œå®é™…è¯»å–åˆ°çš„å­—èŠ‚æ•°å¯èƒ½ä¼šå°äº count å‚æ•°æŒ‡å®šçš„å­—èŠ‚<br>æ•°ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šä¸º 0ï¼Œè­¬å¦‚è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œå½“å‰æ–‡ä»¶ä½ç½®åç§»é‡å·²ç»åˆ°äº†æ–‡ä»¶æœ«å°¾ã€‚å®é™…è¯»å–åˆ°çš„å­—èŠ‚æ•°å°‘<br>äºè¦æ±‚è¯»å–çš„å­—èŠ‚æ•°ï¼Œè­¬å¦‚åœ¨åˆ°è¾¾æ–‡ä»¶æœ«å°¾ä¹‹å‰æœ‰ 30 ä¸ªå­—èŠ‚æ•°æ®ï¼Œè€Œè¦æ±‚è¯»å– 100 ä¸ªå­—èŠ‚ï¼Œåˆ™ read è¯»å–æˆ<br>åŠŸåªèƒ½è¿”å› 30ï¼›è€Œä¸‹ä¸€æ¬¡å†è°ƒç”¨ read è¯»ï¼Œå®ƒå°†è¿”å› 0ï¼ˆæ–‡ä»¶æœ«å°¾ï¼‰ã€‚</p><h4 id="closeå…³é—­æ–‡ä»¶"><a href="#closeå…³é—­æ–‡ä»¶" class="headerlink" title="closeå…³é—­æ–‡ä»¶"></a>closeå…³é—­æ–‡ä»¶</h4><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure><p>fdï¼šæ–‡ä»¶æè¿°ç¬¦ï¼Œéœ€è¦å…³é—­çš„æ–‡ä»¶æ‰€å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚<br>è¿”å›å€¼ï¼šå¦‚æœæˆåŠŸè¿”å› 0ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›-1ã€‚</p><h4 id="lseek"><a href="#lseek" class="headerlink" title="lseek"></a>lseek</h4><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">off_t</span> <span class="title function_">lseek</span><span class="params">(<span class="type">int</span> fd, <span class="type">off_t</span> offset, <span class="type">int</span> whence)</span>;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œç³»ç»Ÿéƒ½ä¼šè®°å½•å®ƒçš„è¯»å†™ä½ç½®åç§»é‡ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªè¯»å†™ä½ç½®åç§»é‡ç§°ä¸ºè¯»å†™åç§»<br>é‡ï¼Œè®°å½•äº†æ–‡ä»¶å½“å‰çš„è¯»å†™ä½ç½®ï¼Œå½“è°ƒç”¨ read()æˆ– write()å‡½æ•°å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå°±ä¼šä»å½“å‰è¯»å†™ä½ç½®<br>åç§»é‡å¼€å§‹è¿›è¡Œæ•°æ®è¯»å†™ã€‚</p><p>è¯»å†™åç§»é‡ç”¨äºæŒ‡ç¤º read()æˆ– write()å‡½æ•°æ“ä½œæ—¶æ–‡ä»¶çš„èµ·å§‹ä½ç½®ï¼Œä¼šä»¥ç›¸å¯¹äºæ–‡ä»¶å¤´éƒ¨çš„ä½ç½®åç§»é‡æ¥<br>è¡¨ç¤ºï¼Œæ–‡ä»¶ç¬¬ä¸€ä¸ªå­—èŠ‚æ•°æ®çš„ä½ç½®åç§»é‡ä¸º 0ã€‚</p><p>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å«ä¹‰å¦‚ä¸‹ï¼š<br>fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚<br>offsetï¼šåç§»é‡ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚<br>whenceï¼šç”¨äºå®šä¹‰å‚æ•° offset åç§»é‡å¯¹åº”çš„å‚è€ƒå€¼ï¼Œè¯¥å‚æ•°ä¸ºä¸‹åˆ—å…¶ä¸­ä¸€ç§ï¼ˆå®å®šä¹‰ï¼‰ï¼š</p><p>SEEK_SETï¼šè¯»å†™åç§»é‡å°†æŒ‡å‘ offset å­—èŠ‚ä½ç½®å¤„ï¼ˆä»æ–‡ä»¶å¤´éƒ¨å¼€å§‹ç®—ï¼‰</p><p>SEEK_CURï¼šè¯»å†™åç§»é‡å°†æŒ‡å‘å½“å‰ä½ç½®åç§»é‡ + offset å­—èŠ‚ä½ç½®å¤„ï¼Œoffset å¯ä»¥ä¸ºæ­£ã€ä¹Ÿå¯ä»¥ä¸ºè´Ÿï¼Œå¦‚æœæ˜¯æ­£æ•°è¡¨ç¤ºå¾€ååç§»ï¼Œå¦‚æœæ˜¯è´Ÿæ•°åˆ™è¡¨ç¤ºå¾€å‰åç§»ï¼›</p><p>SEEK_ENDï¼šè¯»å†™åç§»é‡å°†æŒ‡å‘æ–‡ä»¶æœ«å°¾ + offset å­—èŠ‚ä½ç½®å¤„ï¼ŒåŒæ · offset å¯ä»¥ä¸ºæ­£ã€ä¹Ÿå¯ä»¥ä¸ºè´Ÿï¼Œå¦‚æœæ˜¯æ­£æ•°è¡¨ç¤ºå¾€ååç§»ã€å¦‚æœæ˜¯è´Ÿæ•°åˆ™è¡¨ç¤ºå¾€å‰åç§»ã€‚</p><p>egï¼š<br>(1)å°†è¯»å†™ä½ç½®ç§»åŠ¨åˆ°æ–‡ä»¶å¼€å¤´å¤„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">off_t</span> off = lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"><span class="keyword">if</span> (off == <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure><p>(2)å°†è¯»å†™ä½ç½®ç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">off_t</span> off = lseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line"><span class="keyword">if</span> (off == <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure><p>(3)å°†è¯»å†™ä½ç½®ç§»åŠ¨åˆ°åç§»æ–‡ä»¶å¼€å¤´ 100 ä¸ªå­—èŠ‚å¤„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">off_t</span> off = lseek(fd, <span class="number">100</span>, SEEK_SET);</span><br><span class="line"><span class="keyword">if</span> (off == <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure><p>(4)è·å–å½“å‰è¯»å†™ä½ç½®åç§»é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">off_t</span> off = lseek(fd, <span class="number">0</span>, SEEK_CUR);</span><br><span class="line"><span class="keyword">if</span> (off == <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•°æ‰§è¡ŒæˆåŠŸå°†è¿”å›æ–‡ä»¶å½“å‰è¯»å†™ä½ç½®ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxâ€”â€”Shellè„šæœ¬å­¦ä¹ </title>
      <link href="/2022/10/23/2022-10-23-Linux%E2%80%94%E2%80%94Shell%E8%84%9A%E6%9C%AC%E5%AD%A6%E4%B9%A0/"/>
      <url>/2022/10/23/2022-10-23-Linux%E2%80%94%E2%80%94Shell%E8%84%9A%E6%9C%AC%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h3 id="shellä»‹ç»"><a href="#shellä»‹ç»" class="headerlink" title="shellä»‹ç»"></a>shellä»‹ç»</h3><p>Shellé€šå¸¸æŒ‡çš„æ˜¯å‘½ä»¤è¡Œç•Œé¢çš„è§£æå™¨,ä¹Ÿç”¨äºæ³›æŒ‡æ‰€æœ‰ä¸ºç”¨æˆ·æä¾›æ“ä½œç•Œé¢çš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯ç¨‹åºå’Œç”¨æˆ·<a href="https://zh.wikipedia.org/w/index.php?title=%E4%BA%A4%E4%BA%92&action=edit&redlink=1">äº¤äº’</a>çš„å±‚é¢ã€‚</p><p>Shell æ‰§è¡Œshellç¨‹åºï¼Œè¿™äº›ç¨‹åºå«è„šæœ¬ã€‚</p><p>åˆ›å»ºè„šæœ¬ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ¥åˆ›å»ºåŒ…å«æŒ‡ä»¤çš„æ–‡ä»¶ï¼Œè¿™é‡Œä½¿ç”¨vim</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim bash.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash<span class="comment">##åˆ›å»ºè„šæœ¬æ–‡ä»¶æ—¶å€™å¿…é¡»åœ¨æ–‡ä»¶ç¬¬ä¸€è¡ŒæŒ‡æ˜è¦ç”¨åˆ°çš„shell</span></span></span><br><span class="line">for file in *#ä»¥#å¼€å¤´çš„è¡Œä¸ä¼šè¢«shellå¤„ç†</span><br><span class="line">do </span><br><span class="line">  if grep -q POSIX $file</span><br><span class="line">  then</span><br><span class="line">    echo $file</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure><p>æŠŠè„šæœ¬è®¾ç½®ä¸ºå¯æ‰§è¡Œï¼Œ</p><p>1ã€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/bin/bash bash.sh</span></span><br></pre></td></tr></table></figure><ol start="2"><li></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x bash.sh<span class="comment">##æ”¹å˜æ–‡ä»¶æƒé™ï¼Œä½¿è¿™ä¸ªæ–‡ä»¶å¯ä»¥è¢«æ‰€æœ‰ç”¨æˆ·æ‰§è¡Œ</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./bash.sh</span></span><br></pre></td></tr></table></figure><h3 id="Shell-è¯­æ³•"><a href="#Shell-è¯­æ³•" class="headerlink" title="Shell è¯­æ³•"></a>Shell è¯­æ³•</h3><h4 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h4><p>æ‰€æœ‰å˜é‡éƒ½è¢«çœ‹ä½œå­—ç¬¦ä¸²å¹¶ä»¥å­—ç¬¦ä¸²æ¥å­˜å‚¨.</p><p> æ³¨æ„ï¼Œå˜é‡åå’Œç­‰å·ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œè¿™å¯èƒ½å’Œä½ ç†Ÿæ‚‰çš„æ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½ä¸ä¸€æ ·ã€‚åŒæ—¶ï¼Œå˜é‡åçš„å‘½åé¡»éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼šï¼ˆå˜é‡åç§°ä½¿ç”¨å°å†™è‹±æ–‡å‘½åï¼Œå› ä¸ºç³»ç»Ÿä¸­çš„å…¨å±€å˜é‡æ˜¯å¤§å†™å‘½åçš„ï¼Œä¸ºé˜²æ­¢é‡å¤å®šä¹‰å°±ç”¨å°å†™ï¼‰</p><p>å‘½ååªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯ï¼Œæ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé¦–ä¸ªå­—ç¬¦ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ã€‚<br>ä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿ _ã€‚<br>ä¸èƒ½ä½¿ç”¨æ ‡ç‚¹ç¬¦å·ã€‚<br>ä¸èƒ½ä½¿ç”¨bashé‡Œçš„å…³é”®å­—ï¼ˆå¯ç”¨helpå‘½ä»¤æŸ¥çœ‹ä¿ç•™å…³é”®å­—ï¼‰ã€‚</p><p>åœ¨shellä¸­ï¼Œå¯ä»¥é€šè¿‡åœ¨å˜é‡åå‰åŠ ä¸Š$ç¬¦å·æ¥è®¿é—®å®ƒçš„å†…å®¹ï¼Œ ä¸€ç§æ£€æŸ¥å˜é‡å†…å®¹çš„ç®€å•æ–¹å¼å°±æ˜¯å˜é‡å‰åŠ ä¸Š$å†ç”¨echoå‘½ä»¤å°†å®ƒçš„å†…å®¹è¾“å‡ºåˆ°ç»ˆç«¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> salutation=Hello</span><br><span class="line"> echo $salutation</span><br><span class="line"> echo salutation</span><br><span class="line">Hello</span><br><span class="line">salutation</span><br></pre></td></tr></table></figure><p>readå¯ä»¥ç»™å˜é‡å¤åˆ¶ç›¸å½“äºCè¯­è¨€çš„input</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> read salutation</span><br><span class="line"> echo $ salutation</span><br><span class="line">sa</span><br><span class="line">sa</span><br></pre></td></tr></table></figure><p>è¦æƒ³è¾“å‡ºç©ºæ ¼éœ€è¦ç”¨åŒå¼•å·ç»™å¼•ç”¨å‡ºæ¥ï¼Œè¦æƒ³æ˜¾ç¤ºåŒå¼•å·å¯ï¼Œä»¥ç”¨å•å¼•å·æ¥æ˜¾ç¤ºå‡ºæ¥ï¼Œåœ¨æ˜¾ç¤ºä¿¡æ¯ä¸­æƒ³è¦æœ‰ç¾å…ƒç¬¦å·ï¼Œå¿…é¡»åœ¨å‰é¢åŠ ä¸Š\</p><p>å˜é‡æ¯æ¬¡è¢«å¼•ç”¨æ—¶ï¼Œéƒ½ä¼šè¾“å‡ºå½“å‰èµ‹ç»™å®ƒçš„å€¼ã€‚é‡è¦çš„æ˜¯è¦è®°ä½ï¼Œå¼•ç”¨ä¸€ä¸ªå˜é‡å€¼æ—¶éœ€è¦ä½¿ç”¨ç¾å…ƒç¬¦ï¼Œè€Œå¼•ç”¨å˜é‡æ¥å¯¹å…¶è¿›è¡Œèµ‹å€¼æ—¶åˆ™ä¸è¦ä½¿ç”¨ç¾å…ƒç¬¦ã€‚</p><p>å¯ä»¥é€šè¿‡&#96;åå¼•å·æ¥å°†å‘½ä»¤è¾“å‡ºèµ‹å€¼ç»™å˜é‡æˆ–è€…$()</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">testing = `<span class="built_in">date</span>`</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">testing = $(<span class="built_in">date</span>)</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ unset å‘½ä»¤å¯ä»¥åˆ é™¤å˜é‡ã€‚</p><h4 id="å˜é‡ç±»å‹"><a href="#å˜é‡ç±»å‹" class="headerlink" title="å˜é‡ç±»å‹"></a>å˜é‡ç±»å‹</h4><p>è¿è¡Œshellæ—¶ï¼Œä¼šåŒæ—¶å­˜åœ¨ä¸‰ç§å˜é‡ï¼š</p><ul><li><strong>1) å±€éƒ¨å˜é‡</strong> å±€éƒ¨å˜é‡åœ¨è„šæœ¬æˆ–å‘½ä»¤ä¸­å®šä¹‰ï¼Œä»…åœ¨å½“å‰shellå®ä¾‹ä¸­æœ‰æ•ˆï¼Œå…¶ä»–shellå¯åŠ¨çš„ç¨‹åºä¸èƒ½è®¿é—®å±€éƒ¨å˜é‡ã€‚</li><li><strong>2) ç¯å¢ƒå˜é‡</strong> æ‰€æœ‰çš„ç¨‹åºï¼ŒåŒ…æ‹¬shellå¯åŠ¨çš„ç¨‹åºï¼Œéƒ½èƒ½è®¿é—®ç¯å¢ƒå˜é‡ï¼Œæœ‰äº›ç¨‹åºéœ€è¦ç¯å¢ƒå˜é‡æ¥ä¿è¯å…¶æ­£å¸¸è¿è¡Œã€‚å¿…è¦çš„æ—¶å€™shellè„šæœ¬ä¹Ÿå¯ä»¥å®šä¹‰ç¯å¢ƒå˜é‡ã€‚</li><li><strong>3) shellå˜é‡</strong> shellå˜é‡æ˜¯ç”±shellç¨‹åºè®¾ç½®çš„ç‰¹æ®Šå˜é‡ã€‚shellå˜é‡ä¸­æœ‰ä¸€éƒ¨åˆ†æ˜¯ç¯å¢ƒå˜é‡ï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯å±€éƒ¨å˜é‡ï¼Œè¿™äº›å˜é‡ä¿è¯äº†shellçš„æ­£å¸¸è¿è¡Œ</li></ul><h4 id="Shellæ•°ç»„"><a href="#Shellæ•°ç»„" class="headerlink" title="Shellæ•°ç»„"></a>Shellæ•°ç»„</h4><p>bashæ”¯æŒä¸€ç»´æ•°ç»„ï¼Œå¹¶ä¸”æ²¡æœ‰é™åˆ¶å¤§å°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ•°ç»„å=(å€¼1 å€¼2 ... å€¼n)#ä¾‹å¦‚è¿™æ ·array_name=(value0 value1 value2 value3)</span><br></pre></td></tr></table></figure><h5 id="è¯»å–æ•°ç»„"><a href="#è¯»å–æ•°ç»„" class="headerlink" title="è¯»å–æ•°ç»„"></a>è¯»å–æ•°ç»„</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;æ•°ç»„å[ä¸‹æ ‡]&#125;<span class="comment">#ä¾‹å¦‚echo $&#123;array_name[@]&#125;</span></span></span><br></pre></td></tr></table></figure><h5 id="è·å–æ•°ç»„é•¿åº¦"><a href="#è·å–æ•°ç»„é•¿åº¦" class="headerlink" title="è·å–æ•°ç»„é•¿åº¦"></a>è·å–æ•°ç»„é•¿åº¦</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å–å¾—æ•°ç»„å…ƒç´ çš„ä¸ªæ•°</span></span><br><span class="line">length=$&#123;#array_name[@]&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æˆ–è€…</span></span><br><span class="line">length=$&#123;#array_name[*]&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å–å¾—æ•°ç»„å•ä¸ªå…ƒç´ çš„é•¿åº¦</span></span><br><span class="line">lengthn=$&#123;#array_name[n]&#125;</span><br></pre></td></tr></table></figure><p>bash shellè„šæœ¬ä¸æ”¯æŒæµ®ç‚¹å‹è¿ç®—ï¼Œåªæ”¯æŒæ•´æ•°è¿ç®—ï¼Œå¦‚æœæƒ³è¦è®¡ç®—å¯ç”¨bashçš„è®¡ç®—å™¨bc</p><h3 id="æµç¨‹æ§åˆ¶"><a href="#æµç¨‹æ§åˆ¶" class="headerlink" title="æµç¨‹æ§åˆ¶"></a>æµç¨‹æ§åˆ¶</h3><h4 id="if"><a href="#if" class="headerlink" title="if"></a>if</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if condition</span><br><span class="line">then</span><br><span class="line">    command1 </span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN </span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="if-else"><a href="#if-else" class="headerlink" title="if -else"></a>if -else</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if condition</span><br><span class="line">then</span><br><span class="line">    command1 </span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN</span><br><span class="line">else</span><br><span class="line">    command</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="if-else-if-else"><a href="#if-else-if-else" class="headerlink" title="if else-if else"></a>if else-if else</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if condition1</span><br><span class="line">then</span><br><span class="line">    command1</span><br><span class="line">elif condition2 </span><br><span class="line">then </span><br><span class="line">    command2</span><br><span class="line">else</span><br><span class="line">    commandN</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p><strong>å¦‚æœä½¿ç”¨ ((â€¦)) ä½œä¸ºåˆ¤æ–­è¯­å¥ï¼Œå¤§äºå’Œå°äºå¯ä»¥ç›´æ¥ä½¿ç”¨ &gt; å’Œ &lt;</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">a=10</span><br><span class="line">b=20</span><br><span class="line">if (( $a == $b ))</span><br><span class="line">then</span><br><span class="line">   echo &quot;a ç­‰äº b&quot;</span><br><span class="line">elif (( $a &gt; $b ))</span><br><span class="line">then</span><br><span class="line">   echo &quot;a å¤§äº b&quot;</span><br><span class="line">elif (( $a &lt; $b ))</span><br><span class="line">then</span><br><span class="line">   echo &quot;a å°äº b&quot;</span><br><span class="line">else</span><br><span class="line">   echo &quot;æ²¡æœ‰ç¬¦åˆçš„æ¡ä»¶&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="forå¾ªç¯"><a href="#forå¾ªç¯" class="headerlink" title="forå¾ªç¯"></a>forå¾ªç¯</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for var in item1 item2 ... itemN</span><br><span class="line">do</span><br><span class="line">    command1</span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>å½“å˜é‡å€¼åœ¨åˆ—è¡¨é‡Œï¼Œfor å¾ªç¯å³æ‰§è¡Œä¸€æ¬¡æ‰€æœ‰å‘½ä»¤ï¼Œä½¿ç”¨å˜é‡åè·å–åˆ—è¡¨ä¸­çš„å½“å‰å–å€¼ã€‚å‘½ä»¤å¯ä¸ºä»»ä½•æœ‰æ•ˆçš„ shell å‘½ä»¤å’Œè¯­å¥ã€‚in åˆ—è¡¨å¯ä»¥åŒ…å«æ›¿æ¢ã€å­—ç¬¦ä¸²å’Œæ–‡ä»¶åã€‚inåˆ—è¡¨æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸ç”¨å®ƒï¼Œforå¾ªç¯ä½¿ç”¨å‘½ä»¤è¡Œçš„ä½ç½®å‚æ•°ã€‚</p><p>é¡ºåºè¾“å‡ºå½“å‰åˆ—è¡¨ä¸­çš„æ•°å­—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for loop in 1 2 3 4 5</span><br><span class="line">do</span><br><span class="line">    echo &quot;The value is: $loop&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h4 id="whileå¾ªç¯"><a href="#whileå¾ªç¯" class="headerlink" title="whileå¾ªç¯"></a>whileå¾ªç¯</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while condition</span><br><span class="line">do</span><br><span class="line">    command</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h4 id="until-å¾ªç¯"><a href="#until-å¾ªç¯" class="headerlink" title="until å¾ªç¯"></a>until å¾ªç¯</h4><p>until å¾ªç¯æ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ç›´è‡³æ¡ä»¶ä¸º true æ—¶åœæ­¢ã€‚condition ä¸€èˆ¬ä¸ºæ¡ä»¶è¡¨è¾¾å¼ï¼Œå¦‚æœè¿”å›å€¼ä¸º falseï¼Œåˆ™ç»§ç»­æ‰§è¡Œå¾ªç¯ä½“å†…çš„è¯­å¥ï¼Œå¦åˆ™è·³å‡ºå¾ªç¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">until condition</span><br><span class="line">do</span><br><span class="line">    command</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h4 id="caseâ€¦-esac"><a href="#caseâ€¦-esac" class="headerlink" title="caseâ€¦ esac"></a>caseâ€¦ esac</h4><p>case â€¦ esac ä¸ºå¤šé€‰æ‹©è¯­å¥ï¼Œä¸å…¶ä»–è¯­è¨€ä¸­çš„ switch â€¦ case è¯­å¥ç±»ä¼¼ï¼Œæ˜¯ä¸€ç§å¤šåˆ†æ”¯é€‰æ‹©ç»“æ„ï¼Œæ¯ä¸ª case åˆ†æ”¯ç”¨å³åœ†æ‹¬å·å¼€å§‹ï¼Œç”¨ä¸¤ä¸ªåˆ†å· <strong>;;</strong> è¡¨ç¤º breakï¼Œå³æ‰§è¡Œç»“æŸï¼Œè·³å‡ºæ•´ä¸ª case â€¦ esac è¯­å¥ï¼Œesacï¼ˆå°±æ˜¯ case åè¿‡æ¥ï¼‰ä½œä¸ºç»“æŸæ ‡è®°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;è¾“å…¥ 1 åˆ° 4 ä¹‹é—´çš„æ•°å­—:&#x27;</span><br><span class="line">echo &#x27;ä½ è¾“å…¥çš„æ•°å­—ä¸º:&#x27;</span><br><span class="line">read aNum</span><br><span class="line">case $aNum in</span><br><span class="line">    1)  echo &#x27;ä½ é€‰æ‹©äº† 1&#x27;</span><br><span class="line">    ;;</span><br><span class="line">    2)  echo &#x27;ä½ é€‰æ‹©äº† 2&#x27;</span><br><span class="line">    ;;</span><br><span class="line">    3)  echo &#x27;ä½ é€‰æ‹©äº† 3&#x27;</span><br><span class="line">    ;;</span><br><span class="line">    4)  echo &#x27;ä½ é€‰æ‹©äº† 4&#x27;</span><br><span class="line">    ;;</span><br><span class="line">    *)  echo &#x27;ä½ æ²¡æœ‰è¾“å…¥ 1 åˆ° 4 ä¹‹é—´çš„æ•°å­—&#x27;</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><p><u><strong>å’ŒCè¯­è¨€ä¸€æ ·breakç”¨æ¥è·³å‡ºæ‰€æœ‰å¾ªç¯ï¼Œcontinueæ˜¯ç”¨æ¥è·³å‡ºå½“å‰å¾ªç¯ã€‚</strong></u></p><h3 id="testå‘½ä»¤"><a href="#testå‘½ä»¤" class="headerlink" title="testå‘½ä»¤"></a>testå‘½ä»¤</h3><p>Shellä¸­çš„ test å‘½ä»¤ç”¨äºæ£€æŸ¥æŸä¸ªæ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œå®ƒå¯ä»¥è¿›è¡Œæ•°å€¼ã€å­—ç¬¦å’Œæ–‡ä»¶ä¸‰ä¸ªæ–¹é¢çš„æµ‹è¯•ã€‚</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>-eq</td><td>ç­‰äºåˆ™ä¸ºçœŸ</td></tr><tr><td>-ne</td><td>ä¸ç­‰äºåˆ™ä¸ºçœŸ</td></tr><tr><td>-gt</td><td>å¤§äºç­‰äºåˆ™ä¸ºçœŸ</td></tr><tr><td>-ge</td><td>å°äºç­‰äºåˆ™ä¸ºçœŸ</td></tr><tr><td>-lt</td><td>å°äºåˆ™ä¸ºçœŸ</td></tr><tr><td>-le</td><td>å°äºç­‰äºåˆ™ä¸ºçœŸ</td></tr></tbody></table><p>egï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">num1=100</span><br><span class="line">num2=100</span><br><span class="line">if test $[num1] -eq $[num2]</span><br><span class="line">then</span><br><span class="line">    echo &#x27;ä¸¤ä¸ªæ•°ç›¸ç­‰ï¼&#x27;</span><br><span class="line">else</span><br><span class="line">    echo &#x27;ä¸¤ä¸ªæ•°ä¸ç›¸ç­‰ï¼&#x27;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="æ–‡ä»¶æµ‹è¯•"><a href="#æ–‡ä»¶æµ‹è¯•" class="headerlink" title="æ–‡ä»¶æµ‹è¯•"></a>æ–‡ä»¶æµ‹è¯•</h4><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>-eæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨åˆ™ä¸ºçœŸ</td></tr><tr><td>-fæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å¯è¯»åˆ™ä¸ºçœŸ</td></tr><tr><td>-wæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å¯å†™åˆ™ä¸ºçœŸ</td></tr><tr><td>-xæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”å¯æ‰§è¡Œåˆ™ä¸ºçœŸ</td></tr><tr><td>-sæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå­—ç¬¦åˆ™ä¸ºçœŸ</td></tr><tr><td>-dæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”ä¸ºç›®å½•åˆ™ä¸ºçœŸ</td></tr><tr><td>-fæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”ä¸ºæ™®é€šæ–‡ä»¶åˆ™ä¸ºçœŸ</td></tr><tr><td>-cæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”ä¸ºå­—ç¬¦å‹ç‰¹æ®Šæ–‡ä»¶åˆ™ä¸ºçœŸ</td></tr><tr><td>-bæ–‡ä»¶å</td><td>å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”ä¸ºå—ç‰¹æ®Šæ–‡ä»¶åˆ™ä¸ºçœŸ</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /bin</span><br><span class="line">if test -e ./bash</span><br><span class="line">then</span><br><span class="line">    echo &#x27;æ–‡ä»¶å·²å­˜åœ¨!&#x27;</span><br><span class="line">else</span><br><span class="line">    echo &#x27;æ–‡ä»¶ä¸å­˜åœ¨!&#x27;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="shellå‡½æ•°"><a href="#shellå‡½æ•°" class="headerlink" title="shellå‡½æ•°"></a>shellå‡½æ•°</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[ function ] funname [()]</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    action;</span><br><span class="line"></span><br><span class="line">    [return int;]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>1ã€å¯ä»¥å¸¦function fun() å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥fun() å®šä¹‰,ä¸å¸¦ä»»ä½•å‚æ•°ã€‚</li><li>2ã€å‚æ•°è¿”å›ï¼Œå¯ä»¥æ˜¾ç¤ºåŠ ï¼šreturn è¿”å›ï¼Œå¦‚æœä¸åŠ ï¼Œå°†ä»¥æœ€åä¸€æ¡å‘½ä»¤è¿è¡Œç»“æœï¼Œä½œä¸ºè¿”å›å€¼ã€‚ returnåè·Ÿæ•°å€¼n(0-255</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">funWithReturn()&#123;</span><br><span class="line">    echo &quot;è¿™ä¸ªå‡½æ•°ä¼šå¯¹è¾“å…¥çš„ä¸¤ä¸ªæ•°å­—è¿›è¡Œç›¸åŠ è¿ç®—...&quot;</span><br><span class="line">    echo &quot;è¾“å…¥ç¬¬ä¸€ä¸ªæ•°å­—: &quot;</span><br><span class="line">    read aNum</span><br><span class="line">    echo &quot;è¾“å…¥ç¬¬äºŒä¸ªæ•°å­—: &quot;</span><br><span class="line">    read anotherNum</span><br><span class="line">    echo &quot;ä¸¤ä¸ªæ•°å­—åˆ†åˆ«ä¸º $aNum å’Œ $anotherNum !&quot;</span><br><span class="line">    return $(($aNum+$anotherNum))</span><br><span class="line">&#125;</span><br><span class="line">funWithReturn</span><br><span class="line">echo &quot;è¾“å…¥çš„ä¸¤ä¸ªæ•°å­—ä¹‹å’Œä¸º $? !&quot;</span><br></pre></td></tr></table></figure><p>ä¼ å‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">funWithParam()&#123;</span><br><span class="line">    echo &quot;ç¬¬ä¸€ä¸ªå‚æ•°ä¸º $1 !&quot;</span><br><span class="line">    echo &quot;ç¬¬äºŒä¸ªå‚æ•°ä¸º $2 !&quot;</span><br><span class="line">    echo &quot;ç¬¬åä¸ªå‚æ•°ä¸º $10 !&quot;</span><br><span class="line">    echo &quot;ç¬¬åä¸ªå‚æ•°ä¸º $&#123;10&#125; !&quot;</span><br><span class="line">    echo &quot;ç¬¬åä¸€ä¸ªå‚æ•°ä¸º $&#123;11&#125; !&quot;</span><br><span class="line">    echo &quot;å‚æ•°æ€»æ•°æœ‰ $# ä¸ª!&quot;</span><br><span class="line">    echo &quot;ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¾“å‡ºæ‰€æœ‰å‚æ•° $* !&quot;</span><br><span class="line">&#125;</span><br><span class="line">funWithParam 1 2 3 4 5 6 7 8 9 34 73</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">å‚æ•°å¤„ç†</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td align="left">$#</td><td>ä¼ é€’åˆ°è„šæœ¬æˆ–å‡½æ•°çš„å‚æ•°ä¸ªæ•°</td></tr><tr><td align="left">$*</td><td>ä»¥ä¸€ä¸ªå•å­—ç¬¦ä¸²æ˜¾ç¤ºæ‰€æœ‰å‘è„šæœ¬ä¼ é€’çš„å‚æ•°</td></tr><tr><td align="left">$$</td><td>è„šæœ¬è¿è¡Œçš„å½“å‰è¿›ç¨‹IDå·</td></tr><tr><td align="left">$!</td><td>åå°è¿è¡Œçš„æœ€åä¸€ä¸ªè¿›ç¨‹çš„IDå·</td></tr><tr><td align="left">$?</td><td>æ˜¾ç¤ºæœ€åå‘½ä»¤çš„é€€å‡ºçŠ¶æ€ã€‚0è¡¨ç¤ºæ²¡æœ‰é”™è¯¯ï¼Œå…¶ä»–ä»»ä½•å€¼è¡¨æ˜æœ‰é”™è¯¯ã€‚</td></tr><tr><td align="left">@</td><td>ä¸$*ç›¸åŒï¼Œä½†æ˜¯ä½¿ç”¨æ—¶åŠ å¼•å·ï¼Œå¹¶åœ¨å¼•å·ä¸­è¿”å›æ¯ä¸ªå‚æ•°ã€‚</td></tr><tr><td align="left">$-</td><td>æ˜¾ç¤ºShellä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸setå‘½ä»¤åŠŸèƒ½ç›¸åŒã€‚</td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç®¡ç†ç¯‡â€”â€”è¿›ç¨‹ç®¡ç†</title>
      <link href="/2022/10/20/2022-10-19-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"/>
      <url>/2022/10/20/2022-10-19-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<p>è¿›ç¨‹</p><p><u>è¿›ç¨‹æ˜¯ç”¨æ¥è¡¨ç¤ºæ­£åœ¨è¿›è¡Œçš„ç¨‹åºã€‚</u></p><p>å†…æ ¸ä¸­ä¸€äº›é‡è¦çš„è¿›ç¨‹ä¿¡æ¯å¦‚ä¸‹ï¼š</p><p>è¿›ç¨‹çš„å†…å­˜åœ°å€ï¼›</p><p>è¿›ç¨‹å½“å‰çš„çŠ¶æ€ï¼›</p><p>è¿›ç¨‹æ­£åœ¨ä½¿ç”¨çš„èµ„æºï¼›</p><p>è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼›</p><p>è¿›ç¨‹çš„å±ç»„ï¼›</p><p><strong>PID</strong>ï¼šè¿›ç¨‹çš„IDå·</p><p><strong>PPID</strong>ï¼šçˆ¶è¿›ç¨‹çš„PID</p><p>æ‰€æœ‰çš„è¿›ç¨‹éƒ½å¿…é¡»ç”±å¦ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºâ€”â€”é™¤äº†ç³»ç»Ÿåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶ï¼Œç”±å†…æ ¸è‡ªä¸»åˆ›å»ºå¹¶å®‰è£…çš„è¿›ç¨‹ã€‚å½“ä¸€ä¸ªè¿›ç¨‹è¢«åˆ›å»ºæ—¶ï¼Œåˆ›å»ºä»–çš„é‚£ä¸ªè¿›ç¨‹ç§°ä¸ºçˆ¶è¿›ç¨‹ã€‚è¿™ä¸ªè¿›ç¨‹å«åšå­è¿›ç¨‹ï¼›PPIDå°±æ˜¯çˆ¶è¿›ç¨‹çš„PIDã€‚</p><p>åªæœ‰è¿›ç¨‹çš„åˆ›å»ºè€…å’Œrootç”¨æˆ·æ‰æœ‰æƒå¯¹è¯¥è¿›ç¨‹è¿›è¡Œæ“ä½œï¼Œè®°å½•è¿›ç¨‹çš„åˆ›å»ºè€…ï¼ˆå±ç»„ï¼‰å°±å¿…è¦äº†ï¼Œè¿›ç¨‹çš„<strong>UID</strong>å°±æ˜¯åˆ›å»ºè€…çš„IDã€‚</p><p>Linuxä¸ºè¿›ç¨‹ä¿å­˜äº†æœ‰æ•ˆç”¨æˆ·IDå·å«<strong>EUID</strong>ï¼Œç”¨æ¥ç¡®å®šè¿›ç¨‹å¯¹æŸäº›èµ„æºå’Œæ–‡ä»¶çš„è®¿é—®æƒé™ã€‚ç»å¤§éƒ¨åˆ†æƒ…å†µï¼ŒUIDå’ŒEUIDä¸€æ ·ï¼Œé™¤äº†seruidç¨‹åºã€‚</p><p>è¿›ç¨‹çš„<strong>GID</strong>æ˜¯åˆ›å»ºè€…æ‰€å±ç»„çš„IDå·ï¼Œè¿›ç¨‹åŒæ ·æœ‰ä¸€ä¸ª<strong>EGID</strong>å·ï¼Œå½“è¿›ç¨‹éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶æ—¶å€™ï¼Œè¿™ä¸ªæ–‡ä»¶å°†é‡‡ç”¨è¯¥è¿›ç¨‹çš„GIDã€‚</p><h4 id="ç›‘è§†è¿›ç¨‹ï¼šPSå‘½ä»¤"><a href="#ç›‘è§†è¿›ç¨‹ï¼šPSå‘½ä»¤" class="headerlink" title="ç›‘è§†è¿›ç¨‹ï¼šPSå‘½ä»¤"></a>ç›‘è§†è¿›ç¨‹ï¼šPSå‘½ä»¤</h4><p><a href="https://cdn2.pandaimg.com/2022/10/20/6350d0ada7c0d.png"><img src="https://cdn2.pandaimg.com/2022/10/20/6350d0ada7c0d.png" alt="å±å¹•æˆªå›¾ 2022-10-20 123723.png"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ps aux</span><br><span class="line">$ ps lax##å¯ä»¥æä¾›çˆ¶è¿›ç¨‹IDï¼ˆPPIDï¼‰å’Œè°¦è®©åº¦ï¼ˆINï¼‰</span><br></pre></td></tr></table></figure><h4 id="å³æ—¶è·Ÿè¸ªè¿›ç¨‹ä¿¡æ¯"><a href="#å³æ—¶è·Ÿè¸ªè¿›ç¨‹ä¿¡æ¯" class="headerlink" title="å³æ—¶è·Ÿè¸ªè¿›ç¨‹ä¿¡æ¯"></a>å³æ—¶è·Ÿè¸ªè¿›ç¨‹ä¿¡æ¯</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ top##å®æ—¶æ£€æµ‹10æ›´æ–°ä¸€å›qé€€å‡º</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹å ç”¨æ–‡ä»¶çš„è¿›ç¨‹"><a href="#æŸ¥çœ‹å ç”¨æ–‡ä»¶çš„è¿›ç¨‹" class="headerlink" title="æŸ¥çœ‹å ç”¨æ–‡ä»¶çš„è¿›ç¨‹"></a>æŸ¥çœ‹å ç”¨æ–‡ä»¶çš„è¿›ç¨‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lsof database.doc##æŸ¥æ‰¾æ–‡ä»¶çš„è¿›ç¨‹</span><br></pre></td></tr></table></figure><h4 id="å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼škill"><a href="#å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼škill" class="headerlink" title="å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼škill"></a>å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼škill</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill [-signal] pid</span><br></pre></td></tr></table></figure><p><a href="https://cdn2.pandaimg.com/2022/10/20/6350d50bb4963.png"><img src="https://cdn2.pandaimg.com/2022/10/20/6350d50bb4963.png" alt="å±å¹•æˆªå›¾ 2022-10-20 125610.png"></a></p><h4 id="è°ƒæ•´è¿›ç¨‹çš„è°¦è®©åº¦ï¼ˆä¼˜å…ˆçº§çš„åä¹‰ï¼‰niceå’Œrenice"><a href="#è°ƒæ•´è¿›ç¨‹çš„è°¦è®©åº¦ï¼ˆä¼˜å…ˆçº§çš„åä¹‰ï¼‰niceå’Œrenice" class="headerlink" title="è°ƒæ•´è¿›ç¨‹çš„è°¦è®©åº¦ï¼ˆä¼˜å…ˆçº§çš„åä¹‰ï¼‰niceå’Œrenice"></a>è°ƒæ•´è¿›ç¨‹çš„è°¦è®©åº¦ï¼ˆä¼˜å…ˆçº§çš„åä¹‰ï¼‰niceå’Œrenice</h4><p><a href="https://cdn2.pandaimg.com/2022/10/20/6350d9a16f49d.png"><img src="https://cdn2.pandaimg.com/2022/10/20/6350d9a16f49d.png" alt="å±å¹•æˆªå›¾ 2022-10-20 131600.png"></a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Linuxç³»ç»Ÿç®¡ç†ç¯‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cè¯­è¨€ç®—æ³•é¡¹</title>
      <link href="/2022/10/20/2022-10-20-C%E8%AF%AD%E8%A8%80%E7%AE%97%E6%B3%95%E9%A1%B9/"/>
      <url>/2022/10/20/2022-10-20-C%E8%AF%AD%E8%A8%80%E7%AE%97%E6%B3%95%E9%A1%B9/</url>
      
        <content type="html"><![CDATA[<h3 id="æ­£ä¸‰è§’-åä¸‰è§’"><a href="#æ­£ä¸‰è§’-åä¸‰è§’" class="headerlink" title="æ­£ä¸‰è§’(åä¸‰è§’)"></a>æ­£ä¸‰è§’(åä¸‰è§’)</h3><p>ä½¿ç”¨ä¸ºä¸¤ä¸ªforå¾ªç¯è¿›è¡ŒåµŒå¥—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> a,b,c;</span><br><span class="line"><span class="keyword">for</span>(a=<span class="number">0</span>;a&lt;<span class="number">6</span>;a++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span>(b=<span class="number">0</span>;b&lt;a;b++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;$&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é‡‘å­—å¡”"><a href="#é‡‘å­—å¡”" class="headerlink" title="é‡‘å­—å¡”"></a>é‡‘å­—å¡”</h3><p>ä½¿ç”¨ä¸ºå››ä¸ªforè¿›è¡Œå¾ªç¯æ€æƒ³æ ¸å¿ƒä¸ºä¸­é—´æ•°é‡ä¸ºè¡Œæ•°nçš„ä¸¤å€å‡å»1ï¼Œå¤–å±‚å¾ªç¯æ§åˆ¶æ¢è¡Œï¼Œå†…å±‚ä¸‰ä¸ªæ§åˆ¶ç©ºæ ¼ä»¥åŠä»–çš„æ‰“å°æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rows,i,j,space,star;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp; rows);</span><br><span class="line">     <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=rows;++i)</span><br><span class="line">    &#123;</span><br><span class="line">         star = <span class="number">2</span>*i <span class="number">-1</span> ;     <span class="comment">//æ˜Ÿå·ä¸ªæ•°</span></span><br><span class="line">         space = rows - i;   <span class="comment">//ç©ºæ ¼ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;space;++j)<span class="comment">//å·¦è¾¹ç©ºæ ¼</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;star;++j)       <span class="comment">//ä¸­é—´ *</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;space;++j)<span class="comment">//å³è¾¹ç©ºæ ¼æœ‰æ²¡æœ‰éƒ½å¯ä»¥</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);<span class="comment">//æ¢è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i, space, rows, k=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Enter number of rows: &quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;rows);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">1</span>; i&lt;=rows; ++i, k=<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(space=<span class="number">1</span>; space&lt;=rows-i; ++space)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(k != <span class="number">2</span>*i<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;* &quot;</span>);</span><br><span class="line">        ++k;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ä¸€ä¸ªæ•°å­—æ˜¯å¦ç´ æ•°</p><p>åˆ¤æ–­ä¸€ä¸ªæ•°å­—æ˜¯å¦èƒ½è¢«æ¯”ä»–å°çš„æ•°æ•´é™¤</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i,x;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;x);</span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">2</span>) <span class="built_in">puts</span>(<span class="string">&quot;yes!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(x&gt;<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">2</span>;i&lt;x;i++)</span><br><span class="line">            <span class="keyword">if</span>(x%i==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;no!&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">//ä¸€æ—¦åˆ¤æ–­ä¸æ˜¯ï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span>(i==x) <span class="built_in">puts</span>(<span class="string">&quot;yes!&quot;</span>);<span class="comment">//å¦‚æœæ˜¯çš„è¯ï¼Œforå¾ªç¯ä¸€å®šæ‰§è¡Œåˆ°äº†i=x</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">puts</span>(<span class="string">&quot;no!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>ï¼›</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Cè¯­è¨€äºŒåˆ†æŸ¥æ‰¾"><a href="#Cè¯­è¨€äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="Cè¯­è¨€äºŒåˆ†æŸ¥æ‰¾"></a>Cè¯­è¨€äºŒåˆ†æŸ¥æ‰¾</h3><p>æ‰¾åˆ°æœ€å·¦è¾¹å…ƒç´ ï¼ˆlowï¼‰å’Œæœ€å³è¾¹å…ƒç´ ï¼ˆhighï¼‰ï¼Œç¡®å®šä¸­é—´å…ƒç´ ï¼ˆmidï¼‰ï¼Œæ¯”è¾ƒä¸­é—´å…ƒç´ ï¼ˆmidï¼‰å’Œç›®æ ‡å…ƒç´ ï¼ˆkï¼‰çš„å¤§å°ï¼Œè°ƒæ•´lowå’Œhighï¼Œå†ç¡®å®šæ–°çš„midâ€¦.æˆ‘ä»¬è¦ä¸æ–­ç¡®å®šmidç›´åˆ°æ‰¾åˆ°kï¼Œè‡ªç„¶éœ€è¦ç”¨åˆ°å¾ªç¯ï¼Œæˆ‘ä»¬æœ‰æ˜ç¡®çš„ç›®æ ‡ï¼šæ‰¾åˆ°kã€‚å› æ­¤é€‰æ‹©whileå¾ªç¯ï¼Œæ‰¾åˆ°kåå¾ªç¯ä¸å†è¿›è¡Œï¼Œè€Œå½“lowå’Œhighä¹‹é—´è¿˜æœ‰å…ƒç´ ï¼Œå³lowåœ¨highçš„å·¦è¾¹æˆ–ä¸ä¹‹é‡åˆï¼Œkå°±ä¾ç„¶å¯èƒ½å­˜åœ¨ï¼Œæ‰€ä»¥å¾ªç¯æ¡ä»¶ä¸ºlow&lt;&#x3D;highï¼Œæ¥ä¸‹æ¥çš„é—®é¢˜åœ¨äºæ€æ ·è°ƒæ•´lowå’Œhighçš„å€¼ï¼Œmidå’Œkæ¯”è¾ƒæ— éå°±ä¸‰ç§æƒ…å†µï¼šmid&lt;kï¼Œmid&gt;k,mid&#x3D;kã€‚ç¬¬ä¸€ç§æƒ…å†µï¼Œkåœ¨midçš„å³è¾¹ï¼Œæˆ‘ä»¬å°†lowè°ƒæ•´ä¸ºmid+1ï¼Œhighä¸ç”¨è°ƒæ•´ï¼›ç¬¬äºŒç§æƒ…å†µï¼Œkåœ¨midçš„å·¦è¾¹ï¼Œæˆ‘ä»¬å°†highè°ƒæ•´ä¸ºmid-1ï¼Œlowä¸ç”¨è°ƒæ•´ã€‚æœ€åä¸€ç§æƒ…å†µæœ€ç®€å•ï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†kï¼Œç›´æ¥å°†midæ‰“å°å‡ºæ¥å°±è¡Œäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">Bin_Search</span><span class="params">(<span class="type">int</span> *num,<span class="type">int</span> cnt,<span class="type">int</span> target)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> first = <span class="number">0</span>,last = cnt<span class="number">-1</span>,mid;</span><br><span class="line"><span class="type">int</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(first &lt;= last)</span><br><span class="line">&#123;</span><br><span class="line">counter ++;</span><br><span class="line">mid = (first + last) / <span class="number">2</span>;<span class="comment">//ç¡®å®šä¸­é—´å…ƒç´ </span></span><br><span class="line"><span class="keyword">if</span>(num[mid] &gt; target)</span><br><span class="line">&#123;</span><br><span class="line">last = mid<span class="number">-1</span>; <span class="comment">//midå·²ç»äº¤æ¢è¿‡äº†,lastå¾€å‰ç§»ä¸€ä½</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(num[mid] &lt; target)</span><br><span class="line">&#123;</span><br><span class="line">first = mid+<span class="number">1</span>;<span class="comment">//midå·²ç»äº¤æ¢è¿‡äº†,firstå¾€åç§»ä¸€ä½</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="comment">//åˆ¤æ–­æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;æŸ¥æ‰¾æ¬¡æ•°:%d\n&quot;</span>,counter);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;æŸ¥æ‰¾æ¬¡æ•°:%d\n&quot;</span>,counter);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> flag = <span class="number">0</span>,target;</span><br><span class="line"><span class="type">int</span> num[<span class="number">10</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">10</span>&#125;;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;è¯·è¾“å…¥æ‚¨è¦æŸ¥æ‰¾çš„æ•°å­—:\n&quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;target);</span><br><span class="line">flag = Bin_Search(num,<span class="number">10</span>,target);</span><br><span class="line"><span class="keyword">if</span>(flag) <span class="built_in">printf</span>(<span class="string">&quot;å·²ç»æ‰¾åˆ°è¯¥æ•°å­—!!\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;æ— è¯¥æ•°å­—!!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æŸ¥æ‰¾æ•°ç»„æœ€å¤§å€¼"><a href="#æŸ¥æ‰¾æ•°ç»„æœ€å¤§å€¼" class="headerlink" title="æŸ¥æ‰¾æ•°ç»„æœ€å¤§å€¼"></a>æŸ¥æ‰¾æ•°ç»„æœ€å¤§å€¼</h3><h4 id="å¾ªç¯å¯¹æ¯”"><a href="#å¾ªç¯å¯¹æ¯”" class="headerlink" title="å¾ªç¯å¯¹æ¯”"></a>å¾ªç¯å¯¹æ¯”</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">findMaxValue(arr) &#123;</span><br><span class="line">        <span class="type">int</span> max = <span class="number">0</span>; <span class="comment">// æœ€å¤§å€¼</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;arr.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[i] &gt; max) &#123; <span class="comment">// å½“å‰å€¼å¤§äºæœ€å¤§å€¼ï¼Œèµ‹å€¼ä¸ºæœ€å¤§å€¼</span></span><br><span class="line">                max = arr[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å­—ç¬¦ä¸²æ’åˆ—é¡ºåº"><a href="#å­—ç¬¦ä¸²æ’åˆ—é¡ºåº" class="headerlink" title="å­—ç¬¦ä¸²æ’åˆ—é¡ºåº"></a>å­—ç¬¦ä¸²æ’åˆ—é¡ºåº</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIM 20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE 81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HALT <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">stsrt</span><span class="params">(<span class="type">char</span> *strings [], <span class="type">int</span> num)</span>;</span><br><span class="line"><span class="type">char</span> * <span class="title function_">s_gets</span><span class="params">(<span class="type">char</span> * st, <span class="type">int</span> n)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> input[LIM][SIZE];</span><br><span class="line"><span class="type">char</span> *ptstr[LIM];</span><br><span class="line"><span class="type">int</span> ct = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> k;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Input up to %d lines, and I will sort them.\n&quot;</span>, LIM);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;To stop ,press the Enter key at a line&#x27;s start.\n&quot;</span>);</span><br><span class="line"><span class="keyword">while</span>(ct &lt; LIM &amp;&amp; s_gets(input[ct], SIZE) != <span class="literal">NULL</span> &amp;&amp; input[ct][<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">ptstr[ct] = input[ct];</span><br><span class="line">ct ++;</span><br><span class="line">&#125;</span><br><span class="line">stsrt(ptstr, ct);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\nHere&#x27;s the sorted list:\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>( k = <span class="number">0</span>; k &lt; ct; k++)</span><br><span class="line"><span class="built_in">puts</span>(ptstr[k]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">stsrt</span><span class="params">(<span class="type">char</span> * strings[], <span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> * temp;</span><br><span class="line"><span class="type">int</span> top, seek;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(top = <span class="number">0</span>; top &lt; num - <span class="number">1</span>; top++)</span><br><span class="line"><span class="keyword">for</span>(seek = top + <span class="number">1</span>; seek &lt; num; seek++)</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(strings[top], strings[seek]) &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">temp = strings[top];</span><br><span class="line">strings[top] = strings[seek];</span><br><span class="line">strings[seek] = temp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> * <span class="title function_">s_gets</span><span class="params">(<span class="type">char</span> * st, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> * ret_val;</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">ret_val = fgets(st , n , <span class="built_in">stdin</span>);</span><br><span class="line"><span class="keyword">if</span>(ret_val)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span>(st[i] != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; st[i] != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">i++;</span><br><span class="line"><span class="keyword">if</span>(st[i] == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">st[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">while</span>(getchar() != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å†’æ³¡æ’åº"><a href="#å†’æ³¡æ’åº" class="headerlink" title="å†’æ³¡æ’åº"></a>å†’æ³¡æ’åº</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">bubble_sort</span><span class="params">(<span class="type">int</span>* p, <span class="type">int</span> len)</span><span class="comment">//å‡½æ•°å®ç°</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len - <span class="number">1</span>; i++)<span class="comment">//éœ€è¦è¿›è¡Œlen-1è¶Ÿ</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> flag = <span class="number">1</span>;<span class="comment">//flag=1ï¼Œè¯´æ˜å·²ç»æ’å¥½åº</span></span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; len - <span class="number">1</span> - i;j++)<span class="comment">//æ¯è¶Ÿä¸¤ä¸¤æ¯”è¾ƒè¾ƒæœªæ’å¥½åºå…ƒç´ ä¸ªæ•°-1æ¬¡ã€‚</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (p[j] &gt; p[j+<span class="number">1</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> tmp = p[j];</span><br><span class="line">p[j] = p[j + <span class="number">1</span>];</span><br><span class="line">p[j + <span class="number">1</span>] = tmp;</span><br><span class="line">flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (flag==<span class="number">1</span>)<span class="comment">//åˆ¤æ–­æ˜¯å¦æ’å¥½åº</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> arr[] = &#123; <span class="number">1</span>,<span class="number">5</span>,<span class="number">9</span>,<span class="number">11</span>,<span class="number">46</span>,<span class="number">79</span>,<span class="number">12</span> &#125;;</span><br><span class="line"><span class="type">int</span> sz = <span class="keyword">sizeof</span> arr / <span class="keyword">sizeof</span> arr[<span class="number">0</span>];</span><br><span class="line">bubble_sort(arr,sz);</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sz; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå·¥å…·vim</title>
      <link href="/2022/10/20/2022-10-20-Linux%E5%B7%A5%E5%85%B7vim/"/>
      <url>/2022/10/20/2022-10-20-Linux%E5%B7%A5%E5%85%B7vim/</url>
      
        <content type="html"><![CDATA[<p>viç¼–è¾‘å™¨æ˜¯æ‰€æœ‰UnixåŠ<a href="http://www.2cto.com/os/linux/">Linux</a>ç³»ç»Ÿä¸‹æ ‡å‡†çš„ç¼–è¾‘å™¨ï¼Œä»–å°±ç›¸å½“äº<a href="http://www.2cto.com/os/windows/">windows</a>ç³»ç»Ÿä¸­çš„è®°äº‹æœ¬ä¸€æ ·ï¼Œå®ƒçš„å¼ºå¤§ä¸é€Šè‰²äºä»»ä½•æœ€æ–°çš„æ–‡æœ¬ç¼–è¾‘å™¨ã€‚ä»–æ˜¯æˆ‘ä»¬ä½¿ç”¨Linuxç³»ç»Ÿä¸èƒ½ç¼ºå°‘çš„å·¥å…·ã€‚<a href="https://so.csdn.net/so/search?q=vim&spm=1001.2101.3001.7020">vim</a> å…·æœ‰ç¨‹åºç¼–è¾‘çš„èƒ½åŠ›ï¼Œå¯ä»¥ä»¥å­—ä½“é¢œè‰²è¾¨åˆ«è¯­æ³•çš„æ­£ç¡®æ€§ã€‚</p><p>viå¯ä»¥åˆ†ä¸ºä¸‰ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ä¸€èˆ¬æ¨¡å¼ã€ç¼–è¾‘æ¨¡å¼å’Œå‘½ä»¤è¡Œæ¨¡å¼</p><p>ä¸€èˆ¬æ¨¡å¼ï¼š<br>ä»¥viæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å°±ç›´æ¥è¿›å…¥ä¸€èˆ¬æ¨¡å¼äº†(è¿™æ˜¯é»˜è®¤çš„æ¨¡å¼)ã€‚åœ¨è¿™ä¸ªæ¨¡å¼ä¸­ï¼Œ ä½ å¯ä»¥ä½¿ç”¨ä¸Šä¸‹å·¦å³æŒ‰é”®æ¥ç§»åŠ¨å…‰æ ‡ï¼Œä½ å¯ä»¥ä½¿ç”¨åˆ é™¤å­—ç¬¦æˆ–åˆ é™¤æ•´è¡Œæ¥å¤„ç†æ–‡ä»¶å†…å®¹ï¼Œ ä¹Ÿå¯ä»¥ä½¿ç”¨å¤åˆ¶ã€ç²˜è´´æ¥å¤„ç†ä½ çš„æ–‡ä»¶æ•°æ®ã€‚</p><p>ç¼–è¾‘æ¨¡å¼ï¼š<br>åœ¨ä¸€èˆ¬æ¨¡å¼ä¸­å¯ä»¥è¿›è¡Œåˆ é™¤ã€å¤åˆ¶ã€ç²˜è´´ç­‰çš„æ“ä½œï¼Œä½†æ˜¯å´æ— æ³•ç¼–è¾‘æ–‡ä»¶çš„å†…å®¹ï¼Œåªæœ‰å½“ä½ æŒ‰ä¸‹ã€i, I, o, O, a, A, r, Rã€‘ç­‰ä»»ä½•ä¸€ä¸ªå­—æ¯ä¹‹åæ‰ä¼šè¿›å…¥ç¼–è¾‘æ¨¡å¼ã€‚è¿™æ—¶å€™å±å¹•çš„å·¦ä¸‹æ–¹ä¼šå‡ºç°ã€INSERTæˆ– REPLACEã€‘çš„å­—æ ·ï¼Œæ­¤æ—¶æ‰å¯ä»¥è¿›è¡Œç¼–è¾‘ã€‚è€Œå¦‚æœè¦å›åˆ°ä¸€èˆ¬æ¨¡å¼æ—¶ï¼Œ åˆ™å¿…é¡»è¦æŒ‰ä¸‹ã€Escã€‘å³å¯é€€å‡ºç¼–è¾‘æ¨¡å¼ã€‚</p><p>å‘½ä»¤è¡Œæ¨¡å¼ï¼š<br>è¾“å…¥ã€ : &#x2F; ? ã€‘ä¸‰ä¸ªä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œå°±å¯ä»¥å°†å…‰æ ‡ç§»åŠ¨åˆ°æœ€åº•ä¸‹é‚£ä¸€è¡Œã€‚åœ¨è¿™ä¸ªæ¨¡å¼ä¸­ï¼Œ å¯ä»¥æä¾›æŸ¥æ‰¾ã€è¯»å–ã€å­˜ç›˜ã€æ›¿æ¢å­—ç¬¦ã€ç¦»å¼€viã€æ˜¾ç¤ºè¡Œå·ç­‰çš„åŠ¨ä½œåˆ™æ˜¯åœ¨æ­¤æ¨¡å¼ä¸­å®Œæˆçš„ï¼</p><p>é’ˆå¯¹ç¨‹åºå‘˜é…ç½®</p><p>æ‰“å¼€é«˜äº®åŠŸèƒ½ï¼Œvimä¼šé€šè¿‡æ–‡ä»¶çš„æ‰©å±•åè‡ªåŠ¨å†³å®šå“ªäº›æ˜¯å…³é”®å­—ã€‚</p><p>ï¼šsyntax on</p><p>è‡ªåŠ¨ç¼©è¿›</p><p>ï¼šset autoindent</p><p>è®¾ç½®tabé”®çš„ç©ºæ ¼æ•°</p><p>ï¼šset shiftwidth&#x3D;4</p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/vimopen.png"></p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/vimParenthesis.png"></p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/sn.png"></p><p><img src="https://cdn.jsdelivr.net/gh/hanfengdyh/image@main/bloglmg/close.png"></p><p>å¦‚ä½•åœ¨vimä¸­è¿›è¡Œæœç´¢</p><p>æƒ³è¦åœ¨ Vim ä¸­è¿›è¡Œæœç´¢ï¼Œå¿…é¡»å¤„äº normal æ¨¡å¼ã€‚å½“ä½ å¯åŠ¨ Vim ç¼–è¾‘å™¨çš„æ—¶å€™ï¼Œä½ å°±åœ¨è¿™ä¸ªæ¨¡å¼ã€‚ æƒ³è¦ä»å…¶ä»–ä»»ä½•æ¨¡å¼å›åˆ°æ­£å¸¸æ¨¡å¼ï¼Œä»…ä»…éœ€è¦æŒ‰ ESC æŒ‰é”®ã€‚</p><p>Vim å…è®¸ä½ ä½¿ç”¨<code>/</code>å’Œ<code>?</code>å¿«é€Ÿæœç´¢æ–‡æœ¬ã€‚</p><p>æƒ³è¦å‘å‰æœç´¢æŒ‰<code>/</code>ï¼Œæƒ³è¦å‘åæœç´¢æŒ‰<code>?</code>ï¼Œè¾“å…¥æœç´¢æ ·å¼ï¼Œå¹¶ä¸”æŒ‰<code>Enter</code>è¿›è¡Œæœç´¢ï¼š</p><p>Vim æœç´¢çš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p><p>01.æŒ‰<code>/</code></p><p>02.è¾“å…¥æœç´¢æ ·å¼</p><p>03.æŒ‰<code>Enter</code>è¿›è¡Œæœç´¢</p><p>04.æŒ‰<code>n</code>æœç´¢ä¸‹ä¸€ä¸ªåŒ¹é…ç»“æœï¼Œæˆ–è€…<code>N</code>æŸ¥æ‰¾å‰é¢ä¸€ä¸ªåŒ¹é…ç»“æœã€‚</p><p>ä¾‹å¦‚æœç´¢gnuè¾“å…¥&#x2F;\&lt;gnu\&gt;</p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç®¡ç†ç¯‡â€”â€”ç”¨æˆ·ç®¡ç†</title>
      <link href="/2022/10/19/2022-10-19-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/"/>
      <url>/2022/10/19/2022-10-19-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h4 id="æ·»åŠ æ–°ç”¨æˆ·å¹¶å»ºç«‹ä¸»ç›®å½•"><a href="#æ·»åŠ æ–°ç”¨æˆ·å¹¶å»ºç«‹ä¸»ç›®å½•" class="headerlink" title="æ·»åŠ æ–°ç”¨æˆ·å¹¶å»ºç«‹ä¸»ç›®å½•"></a>æ·»åŠ æ–°ç”¨æˆ·å¹¶å»ºç«‹ä¸»ç›®å½•</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo uesradd -m john##æ·»åŠ ç”¨æˆ·å«johnå¹¶å»ºç«‹ä¸»ç›®å½•</span><br><span class="line">$ sudo passwd john##æ›´æ”¹johnçš„å¯†ç </span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ ç”¨æˆ·å‘½ä»¤è¡Œå·¥å…·"><a href="#æ·»åŠ ç”¨æˆ·å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="æ·»åŠ ç”¨æˆ·å‘½ä»¤è¡Œå·¥å…·"></a>æ·»åŠ ç”¨æˆ·å‘½ä»¤è¡Œå·¥å…·</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ useradd john##æ·»åŠ ç”¨æˆ·john</span><br><span class="line">$ passwd john##johnè®¾ç½®å¯†ç </span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo useradd -g users john##åˆ›ç«‹johnå¹¶æŒ‡å®šå±äºusersç»„</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo useradd -s /bin/bash mike##å»ºç«‹mikeç”¨æˆ·å¹¶æŒ‡å®šç™»é™†åä½¿ç”¨bashä½œä¸ºShell</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo groupadd newgroup##åœ¨ç³»ç»Ÿä¸­å¤ªå†…ç–šnewgroupçš„ç»„</span><br></pre></td></tr></table></figure><h4 id="è®°å½•ç”¨æˆ·æ“ä½œ"><a href="#è®°å½•ç”¨æˆ·æ“ä½œ" class="headerlink" title="è®°å½•ç”¨æˆ·æ“ä½œ"></a>è®°å½•ç”¨æˆ·æ“ä½œ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ history</span><br><span class="line">$ history 10##è®°å½•äº†æœ€è¿‘ç”¨çš„10æ¡æŒ‡ä»¤</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤ç”¨æˆ·"><a href="#åˆ é™¤ç”¨æˆ·" class="headerlink" title="åˆ é™¤ç”¨æˆ·"></a>åˆ é™¤ç”¨æˆ·</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo uesrdel mike##åˆ é™¤ç”¨æˆ·mike</span><br><span class="line">$ sudo userdel -r john##åˆ é™¤johnåˆ é™¤å…¶ä¸»ç›®å½•</span><br></pre></td></tr></table></figure><h4 id="ç®¡ç†ç”¨æˆ·è´¦å·"><a href="#ç®¡ç†ç”¨æˆ·è´¦å·" class="headerlink" title="ç®¡ç†ç”¨æˆ·è´¦å·"></a>ç®¡ç†ç”¨æˆ·è´¦å·</h4><p><a href="https://cdn2.pandaimg.com/2022/10/19/634ff773348ce.png"><img src="https://cdn2.pandaimg.com/2022/10/19/634ff773348ce.png" alt="å±å¹•æˆªå›¾ 2022-10-19 211029.png"></a></p><h4 id="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯"><a href="#æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯"></a>æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ id hanfeng##æŸ¥çœ‹ç”¨æˆ·çš„UIDã€GIDåŠæ‰€å±ç»„çš„ä¿¡æ¯</span><br></pre></td></tr></table></figure><h4 id="ç”¨æˆ·è½¬æ¢"><a href="#ç”¨æˆ·è½¬æ¢" class="headerlink" title="ç”¨æˆ·è½¬æ¢"></a>ç”¨æˆ·è½¬æ¢</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ su john##è¿›å…¥johnç”¨æˆ·</span><br><span class="line">$ exit##å›åˆ°ä¹‹å‰çš„ç”¨æˆ·</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Linuxç³»ç»Ÿç®¡ç†ç¯‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç®¡ç†ç¯‡-å‹ç¼©ä¸è§£å‹ç¼©</title>
      <link href="/2022/10/18/2022-10-18-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87-%E5%8E%8B%E7%BC%A9%E4%B8%8E%E8%A7%A3%E5%8E%8B%E7%BC%A9/"/>
      <url>/2022/10/18/2022-10-18-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87-%E5%8E%8B%E7%BC%A9%E4%B8%8E%E8%A7%A3%E5%8E%8B%E7%BC%A9/</url>
      
        <content type="html"><![CDATA[<h4 id="gzipå‹ç¼©å·¥å…·"><a href="#gzipå‹ç¼©å·¥å…·" class="headerlink" title="gzipå‹ç¼©å·¥å…·"></a>gzipå‹ç¼©å·¥å…·</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gzip gztest##å‹ç¼©gztest</span><br><span class="line">$ gzip -d gztest##è§£å‹ç¼©gztest</span><br><span class="line">$ gzip -r gztest##å¯¹æ–‡ä»¶å¤¹å‹ç¼©</span><br><span class="line">$ gzip -rd gztest.gz##å¯¹æ–‡ä»¶å¤¹è§£å‹ç¼©</span><br></pre></td></tr></table></figure><p>gzip è™½ç„¶å¯¹æ–‡ä»¶å¤¹è¿›è¡Œå‹ç¼©ï¼Œä½†æ˜¯ä¸èƒ½æä¾›æ‰“åŒ…æœåŠ¡ï¼Œåªå¯¹æ–‡ä»¶å¤¹<strong>å†…éƒ¨çš„æ–‡ä»¶è¿›è¡Œå•ç‹¬å‹ç¼©ã€‚</strong></p><h4 id="bzip2å‹ç¼©å·¥å…·"><a href="#bzip2å‹ç¼©å·¥å…·" class="headerlink" title="bzip2å‹ç¼©å·¥å…·"></a>bzip2å‹ç¼©å·¥å…·</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bzip2 -z a.c##å‹ç¼©</span><br><span class="line">$ bzip2 -d a.c.bz2##è§£å‹ç¼©</span><br></pre></td></tr></table></figure><h4 id="taræ‰“åŒ…å·¥å…·"><a href="#taræ‰“åŒ…å·¥å…·" class="headerlink" title="taræ‰“åŒ…å·¥å…·"></a>taræ‰“åŒ…å·¥å…·</h4><p>tarå·¥å…·æä¾›æ‰“åŒ…æœåŠ¡ï¼Œå°±æ˜¯å°†å¤šä¸ªæ–‡ä»¶æ‰“åŒ…ã€‚å¸¸ç”¨å‚æ•°-få½’æ¡£ ,-cåˆ›å»ºæ–°å½’æ¡£åˆ›å»ºå‹ç¼©æ–‡ä»¶ï¼Œ-xï¼šä»æ–‡æ¡£ä¸­è§£å‹ç¼©</p><p>-jï¼šä½¿ç”¨bzip2å‹ç¼©æ ¼å¼ï¼Œ-z ä½¿ç”¨gzipå‹ç¼©æ ¼å¼ -v æ‰“å°å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tar -vxjf xxx.tar.bz2##è§£å‹ç¼©</span><br><span class="line">$ tar -vcjf xxx.tar.bz2 xxx ##å‹ç¼©</span><br><span class="line">$ tar -vxzfxxx.tar.gz##è§£å‹ç¼©</span><br><span class="line">$ tar -vczf xxx.tar.gz xxx ##å‹ç¼©</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Linuxç³»ç»Ÿç®¡ç†ç¯‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç®¡ç†ç¯‡-è½¯ä»¶åŒ…ç®¡ç†</title>
      <link href="/2022/10/16/2022-10-16-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/"/>
      <url>/2022/10/16/2022-10-16-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h4 id="ç®¡ç†-debè½¯ä»¶åŒ…"><a href="#ç®¡ç†-debè½¯ä»¶åŒ…" class="headerlink" title="ç®¡ç†.debè½¯ä»¶åŒ…"></a>ç®¡ç†.debè½¯ä»¶åŒ…</h4><h6 id="æŸ¥çœ‹å·²å®‰è£…çš„è½¯ä»¶åŒ…"><a href="#æŸ¥çœ‹å·²å®‰è£…çš„è½¯ä»¶åŒ…" class="headerlink" title="æŸ¥çœ‹å·²å®‰è£…çš„è½¯ä»¶åŒ…"></a>æŸ¥çœ‹å·²å®‰è£…çš„è½¯ä»¶åŒ…</h6><p> OpenSSH æ˜¯ SSH ï¼ˆSecure SHellï¼‰ åè®®çš„å…è´¹å¼€æºå®ç°ã€‚SSHåè®®æ—å¯ä»¥ç”¨æ¥è¿›è¡Œè¿œç¨‹æ§åˆ¶ï¼Œ æˆ–åœ¨è®¡ç®—æœºä¹‹é—´ä¼ é€æ–‡ä»¶ã€‚è€Œå®ç°æ­¤åŠŸèƒ½çš„ä¼ ç»Ÿæ–¹å¼ï¼Œå¦‚telnet(ç»ˆç«¯ä»¿çœŸåè®®)ã€ rcp ftpã€ rloginã€rshéƒ½æ˜¯æä¸ºä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”ä¼šä½¿ç”¨æ˜æ–‡ä¼ é€å¯†ç ã€‚OpenSSHæä¾›äº†æœåŠ¡ç«¯åå°ç¨‹åºå’Œå®¢æˆ·ç«¯å·¥å…·ï¼Œç”¨æ¥åŠ å¯†è¿œç¨‹æ§ä»¶å’Œæ–‡ä»¶ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®ï¼Œå¹¶ç”±æ­¤æ¥ä»£æ›¿åŸæ¥çš„ç±»ä¼¼æœåŠ¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg -l | grep openssh##æŸ¥æ‰¾opensshçš„ç‰ˆæœ¬ä¿¡æ¯</span><br><span class="line">$ dekg -s openssh##æŸ¥çœ‹å“ªäº›æ–‡ä»¶æ˜¯opensshå¸¦æ¥çš„</span><br></pre></td></tr></table></figure><h6 id="å®‰è£…å¸è½½è½¯ä»¶åŒ…"><a href="#å®‰è£…å¸è½½è½¯ä»¶åŒ…" class="headerlink" title="å®‰è£…å¸è½½è½¯ä»¶åŒ…"></a>å®‰è£…å¸è½½è½¯ä»¶åŒ…</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sudo dpkg -i xxx.deb##å®‰è£…xxx</span><br><span class="line"></span><br><span class="line">$sudo dpkg --remove opera##åˆ é™¤operaæµè§ˆå™¨</span><br></pre></td></tr></table></figure><h4 id="ç®¡ç†RPMè½¯ä»¶åŒ…"><a href="#ç®¡ç†RPMè½¯ä»¶åŒ…" class="headerlink" title="ç®¡ç†RPMè½¯ä»¶åŒ…"></a>ç®¡ç†RPMè½¯ä»¶åŒ…</h4><h6 id="å®‰è£…è½¯ä»¶åŒ…"><a href="#å®‰è£…è½¯ä»¶åŒ…" class="headerlink" title="å®‰è£…è½¯ä»¶åŒ…"></a>å®‰è£…è½¯ä»¶åŒ…</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rpm -i -v -h dump-0.4b41-1.src.rpm##-iæ˜¯å®‰è£…å‘½ä»¤-væ˜¾ç¤ºæ­£åœ¨æ‰§è¡Œå·¥ä½œ-hæ‰“å°æé†’è¿›åº¦</span><br></pre></td></tr></table></figure><p>å‡çº§å®‰è£…åŒ…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rpm -Uvh dump-0.4b41-1.src.rpm</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å·²ç»å®‰è£…çš„è½¯ä»¶åŒ…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -q check##rpm -qå‘½ä»¤å¯ä»¥æŸ¥è¯¢å·²ç»å®‰è£…çš„è½¯ä»¶åŒ…æ˜¯å®‰è£…åŒ…æ–‡ä»¶çš„åå­—ï¼Œä¸æ˜¯æ–‡ä»¶çš„åå­—</span><br></pre></td></tr></table></figure><p><a href="https://cdn2.pandaimg.com/2022/10/16/634ba96fd0a8e.png"><img src="https://cdn2.pandaimg.com/2022/10/16/634ba96fd0a8e.png" alt="å±å¹•æˆªå›¾ 2022-10-16 144841.png"></a></p><h6 id="å¸è½½è½¯ä»¶åŒ…"><a href="#å¸è½½è½¯ä»¶åŒ…" class="headerlink" title="å¸è½½è½¯ä»¶åŒ…"></a>å¸è½½è½¯ä»¶åŒ…</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rpm -e tcpdump##å¸è½½tcpdumpè½¯ä»¶åŒ…</span><br></pre></td></tr></table></figure><h4 id="é«˜çº§è½¯ä»¶åŒ…å·¥å…·APT"><a href="#é«˜çº§è½¯ä»¶åŒ…å·¥å…·APT" class="headerlink" title="é«˜çº§è½¯ä»¶åŒ…å·¥å…·APT"></a>é«˜çº§è½¯ä»¶åŒ…å·¥å…·APT</h4><h6 id="ä¸‹è½½å’Œå®‰è£…è½¯ä»¶åŒ…"><a href="#ä¸‹è½½å’Œå®‰è£…è½¯ä»¶åŒ…" class="headerlink" title="ä¸‹è½½å’Œå®‰è£…è½¯ä»¶åŒ…"></a>ä¸‹è½½å’Œå®‰è£…è½¯ä»¶åŒ…</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update##æ›´æ–°è½¯ä»¶åŒ…</span><br><span class="line">$ sduo apt-get install wesnoth##ä¸‹è½½å®‰è£…wesnoth</span><br></pre></td></tr></table></figure><p><a href="https://cdn2.pandaimg.com/2022/10/16/634baf70f406c.png"><img src="https://cdn2.pandaimg.com/2022/10/16/634baf70f406c.png" alt="å±å¹•æˆªå›¾ 2022-10-16 151437.png"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get -h##å¯ä»¥åˆ—å‡ºapt-getçš„å®Œæ•´ç”¨æ³•</span><br></pre></td></tr></table></figure><h6 id="æŸ¥è¯¢è½¯ä»¶åŒ…"><a href="#æŸ¥è¯¢è½¯ä»¶åŒ…" class="headerlink" title="æŸ¥è¯¢è½¯ä»¶åŒ…"></a>æŸ¥è¯¢è½¯ä»¶åŒ…</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ apt-cache search flight##æœç´¢å¸¦æœ‰flightçš„è½¯ä»¶åŒ…</span><br><span class="line">$ apt-cache depends flightgear##æŸ¥è¯¢flightgearçš„ä¾èµ–å…³ç³»</span><br></pre></td></tr></table></figure><p>apt-getæ˜¯å®‰è£…æºæ”¾åœ¨&#x2F;etc&#x2F;apt&#x2F;source.listä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ã€‚</p><h6 id="æºç æ–‡ä»¶å®‰è£…"><a href="#æºç æ–‡ä»¶å®‰è£…" class="headerlink" title="æºç æ–‡ä»¶å®‰è£…"></a>æºç æ–‡ä»¶å®‰è£…</h6><p>makeå…ˆç¼–è¯‘</p><p>ä¹‹åä½¿ç”¨make installå…·ä½“æ–¹æ³•çœ‹è½¯ä»¶å®‰è£…è¦æ±‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> Linuxç³»ç»Ÿç®¡ç†ç¯‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç®¡ç†ç¯‡â€”â€”ç£ç›˜ç®¡ç†</title>
      <link href="/2022/10/16/2022-10-19-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/"/>
      <url>/2022/10/16/2022-10-19-Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%AF%87%E2%80%94%E2%80%94%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h4 id="ç£ç›˜ç®¡ç†ä¸‰ä¸ªå¸¸ç”¨çš„å‘½ä»¤fdiskã€duã€df"><a href="#ç£ç›˜ç®¡ç†ä¸‰ä¸ªå¸¸ç”¨çš„å‘½ä»¤fdiskã€duã€df" class="headerlink" title="ç£ç›˜ç®¡ç†ä¸‰ä¸ªå¸¸ç”¨çš„å‘½ä»¤fdiskã€duã€df"></a>ç£ç›˜ç®¡ç†ä¸‰ä¸ªå¸¸ç”¨çš„å‘½ä»¤fdiskã€duã€df</h4><p>dfï¼šæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿçš„æ•´ä½“ç£ç›˜ä½¿ç”¨é‡</p><p>duï¼šæ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨é‡</p><p>fdiskï¼šç”¨äºç£ç›˜çš„åˆ†åŒº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ df [-ahikHTm][ç›®å½•æˆ–æ–‡ä»¶å]##å…·ä½“å‚æ•°å¯ä»¥æŸ¥çœ‹ df --help</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ du [-ahskm] æ–‡ä»¶æˆ–ç›®å½•åç§°    ##å…·ä½“å‚æ•°å¯ä»¥æŸ¥çœ‹ du --help</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fdisk [-l] è£…ç½®åç§°##fdiskæ˜¯Linuxçš„ç£ç›˜åˆ†åŒºè¡¨æ“ä½œå·¥å…·</span><br></pre></td></tr></table></figure><p>è‹¥ä»…æœ‰ fdisk -l æ—¶ï¼Œ åˆ™ç³»ç»Ÿå°†ä¼šæŠŠæ•´ä¸ªç³»ç»Ÿå†…èƒ½å¤Ÿæœå¯»åˆ°çš„è£…ç½®çš„åˆ†åŒºå‡åˆ—å‡ºæ¥ã€‚</p><p>linuxæ“ä½œç³»ç»Ÿå°†æ‰€æœ‰çš„è®¾å¤‡éƒ½çœ‹ä½œæ–‡ä»¶ï¼Œå®ƒå°†æ•´ä¸ªè®¡ç®—æœºçš„èµ„æºéƒ½æ•´åˆæˆä¸€ä¸ªå¤§çš„æ–‡ä»¶ç›®å½•ã€‚æˆ‘ä»¬è¦è®¿é—®å­˜å‚¨è®¾å¤‡ä¸­çš„æ–‡ä»¶ï¼Œå¿…é¡»å°†æ–‡ä»¶æ‰€åœ¨çš„åˆ†åŒºæŒ‚è½½åˆ°ä¸€ä¸ªå·²å­˜åœ¨çš„ç›®å½•ä¸Šï¼Œç„¶åé€šè¿‡è®¿é—®è¿™ä¸ªç›®å½•æ¥è®¿é—®å­˜å‚¨è®¾å¤‡ã€‚æŒ‚è½½å°±æ˜¯æŠŠè®¾å¤‡æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œè®©ç³»ç»ŸçŸ¥é“æ€ä¹ˆç®¡ç†è¿™ä¸ªè®¾å¤‡é‡Œçš„æ–‡ä»¶ï¼Œäº†è§£è¿™ä¸ªå­˜å‚¨è®¾å¤‡çš„å¯è¯»å†™ç‰¹æ€§ä¹‹ç±»çš„è¿‡ç¨‹ã€‚fsckï¼ˆfile system checkï¼‰ç”¨æ¥æ£€æŸ¥å’Œç»´æŠ¤ä¸ä¸€è‡´çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>è‹¥ç³»ç»Ÿæ‰ç”µæˆ–ç£ç›˜å‘ç”Ÿé—®é¢˜ï¼Œå¯åˆ©ç”¨fsckå‘½ä»¤å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ£€æŸ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fsck [-t æ–‡ä»¶ç³»ç»Ÿ] [-ACay] è£…ç½®åç§°</span><br></pre></td></tr></table></figure><p>ç£ç›˜æŒ‚è½½ä½¿ç”¨mountå¸è½½ä½¿ç”¨umountå‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount [-t æ–‡ä»¶ç³»ç»Ÿ] [-L Labelå] [-o é¢å¤–é€‰é¡¹] [-n]  è£…ç½®æ–‡ä»¶å  æŒ‚è½½ç‚¹</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount [-fn] è£…ç½®æ–‡ä»¶åæˆ–æŒ‚è½½ç‚¹</span><br></pre></td></tr></table></figure><p>å…³äºå…·ä½“æ“ä½œäº‹ä¾‹å¯ä»¥çœ‹<a href="https://zhuanlan.zhihu.com/p/296777898">ä¸€ç¯‡çœ‹æ‡‚ï¼Linuxç£ç›˜çš„ç®¡ç†ï¼ˆåˆ†åŒºã€æ ¼å¼åŒ–ã€æŒ‚è½½ï¼‰ï¼ŒLVMé€»è¾‘å·ï¼ŒRAIDç£ç›˜é˜µåˆ— - çŸ¥ä¹ (zhihu.com)</a></p><h4 id="åˆ›å»ºå¹¶ä½¿ç”¨ä¸€ä¸ªåˆ†åŒºçš„æ­¥éª¤"><a href="#åˆ›å»ºå¹¶ä½¿ç”¨ä¸€ä¸ªåˆ†åŒºçš„æ­¥éª¤" class="headerlink" title="åˆ›å»ºå¹¶ä½¿ç”¨ä¸€ä¸ªåˆ†åŒºçš„æ­¥éª¤"></a>åˆ›å»ºå¹¶ä½¿ç”¨ä¸€ä¸ªåˆ†åŒºçš„æ­¥éª¤</h4><p>â‘ åˆ›å»ºåˆ†åŒºå¹¶åˆ†é…ç©ºé—´</p><p>â‘¡ç£ç›˜æ ¼å¼åŒ–</p><p>â‘¢å°†æ ¼å¼åŒ–åçš„ç£ç›˜è¿›è¡ŒæŒ‚è½½</p>]]></content>
      
      
      
        <tags>
            
            <tag> Linuxç³»ç»Ÿç®¡ç†ç¯‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç®¡ç†ç¯‡â€”â€”æ–‡ä»¶ç›®å½•ç®¡ç†æŒ‡ä»¤</title>
      <link href="/2022/10/13/2022-10-13-Linux%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%AE%A1%E7%90%86%E6%8C%87%E4%BB%A4/"/>
      <url>/2022/10/13/2022-10-13-Linux%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%AE%A1%E7%90%86%E6%8C%87%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<p>linuxç³»ç»Ÿä¸å­˜åœ¨ç›˜è¿™ä¸ªæ¦‚å¿µï¼Œç”¨æˆ·é€šè¿‡æ“ä½œç›®å½•æ¥å®ç°ç£ç›˜è¯»å†™ï¼ŒLinuxéœ€è¦é¦–å…ˆå»ºç«‹ä¸€ä¸ªæ ¹â€˜â€œ&#x2F;â€æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åœ¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­å»ºç«‹ä¸€ç³»åˆ—ç©ºç›®å½•ï¼Œç„¶åå°†å…¶ä»–ç¡¬ç›˜åˆ†åŒºä¸­çš„ æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°è¿™äº›ç›®å½•ä¸­ã€‚</p><p><a href="https://cdn2.pandaimg.com/2022/10/13/6347abc1a4403.png"><img src="https://cdn2.pandaimg.com/2022/10/13/6347abc1a4403.png" alt="å±å¹•æˆªå›¾ 2022-10-13 140836.png"></a></p><h6 id="ç”¨æˆ·é—´å…±äº«æ–‡ä»¶"><a href="#ç”¨æˆ·é—´å…±äº«æ–‡ä»¶" class="headerlink" title="ç”¨æˆ·é—´å…±äº«æ–‡ä»¶"></a>ç”¨æˆ·é—´å…±äº«æ–‡ä»¶</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">##æ–°å»ºä¸€ä¸ªåä¸ºworkgroupçš„ç”¨æˆ·ç»„</span><br><span class="line">$ sudo groupadd workgroup</span><br><span class="line">##æ–°å»ºç”¨æˆ·ï¼Œå¹¶å½’å…¥workgroupç»„</span><br><span class="line">$sudo useradd -G workgroup lucy</span><br><span class="line">$sudo passwd lucy##ä¸ºç”¨æˆ·lewisè®¾ç½®ç™»å½•å¯†ç </span><br><span class="line">$sudo useradd -G workgroup lewis</span><br><span class="line">$sudo passwd lewis##ä¸ºç”¨æˆ·peterè®¾ç½®ç™»å½•å¯†ç </span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="å»ºç«‹æ–‡ä»¶å’Œç›®å½•"><a href="#å»ºç«‹æ–‡ä»¶å’Œç›®å½•" class="headerlink" title="å»ºç«‹æ–‡ä»¶å’Œç›®å½•"></a>å»ºç«‹æ–‡ä»¶å’Œç›®å½•</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~##è¿›å…¥ç”¨æˆ·ä¸»ç›®å½•</span><br><span class="line">$ mkdir document picture##æ–°å»ºä¸¤ä¸ªç›®å½•</span><br><span class="line">$ mkdir ~/picture/temp##åœ¨ä¸»ç›®å½•ä¸‹æ–°å»ºåä¸ºtempçš„ç›®å½•</span><br><span class="line">##å¦‚æœæ²¡æœ‰ä¸­é—´çš„ç›®å½•ä¹Ÿå°±æ— æ³•åœ¨ä¸‹é¢åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æˆ–ç›®å½•ä¸ºæ­¤ï¼Œä½¿ç”¨-pé€‰é¡¹</span><br><span class="line">$ mkdir -p ~/tempx/job##åˆ›å»ºä¸€ä¸ªtempxæ–‡ä»¶å¤¹åœ¨ä¸‹é¢åˆ›å»ºä¸€ä¸ªjobæ–‡ä»¶å¤¹</span><br></pre></td></tr></table></figure><h6 id="å»ºç«‹ä¸€ä¸ªç©ºæ–‡ä»¶"><a href="#å»ºç«‹ä¸€ä¸ªç©ºæ–‡ä»¶" class="headerlink" title="å»ºç«‹ä¸€ä¸ªç©ºæ–‡ä»¶"></a>å»ºç«‹ä¸€ä¸ªç©ºæ–‡ä»¶</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ touch hello##æ–°å»ºä¸€ä¸ªhelloçš„æ–‡ä»¶</span><br><span class="line">$ touch hello##å·²ç»æœ‰helloçš„æ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥æ›´æ–°helloæ–‡ä»¶çš„åˆ›å»ºæ—¥æœŸ</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="ç§»åŠ¨å’Œé‡å‘½å"><a href="#ç§»åŠ¨å’Œé‡å‘½å" class="headerlink" title="ç§»åŠ¨å’Œé‡å‘½å"></a>ç§»åŠ¨å’Œé‡å‘½å</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mv hello bin/##ç§»åŠ¨helloåˆ°bin/ä¸­</span><br><span class="line">$ mv photos/æ¡Œé¢/   ##ç§»åŠ¨photosç›®å½•åˆ°æ¡Œé¢</span><br><span class="line">$ mv -i hello test/##ä½¿ç”¨é˜²æ­¢æ›¿æ¢åŒåæ–‡ä»¶å¹¶åŠ ä»¥æç¤º.</span><br><span class="line">$ mv -b hello test/##åœ¨ç›®æ ‡ç›®å½•çš„åŒåæ–‡ä»¶åé¢åŠ ä¸Š~ï¼Œç›¸å½“äºé‡å‘½å</span><br></pre></td></tr></table></figure><h6 id="å¤åˆ¶æ–‡ä»¶å’Œç›®å½•"><a href="#å¤åˆ¶æ–‡ä»¶å’Œç›®å½•" class="headerlink" title="å¤åˆ¶æ–‡ä»¶å’Œç›®å½•"></a>å¤åˆ¶æ–‡ä»¶å’Œç›®å½•</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cp test.php test/##å°†test.php æ”¾å…¥åˆ°testä¸‹</span><br><span class="line">$ cp -i test.php test/##æç¤ºæ˜¯å¦è¦†ç›–åŒåæ–‡ä»¶</span><br><span class="line">$ cp -r test/ æ¡Œé¢/   ##è¿å­ç›®å½•å¸¦æ–‡ä»¶ä¸€èµ·å¤åˆ¶åˆ°ä¸‹é¢</span><br></pre></td></tr></table></figure><h6 id="åˆ é™¤ç›®å½•å’Œæ–‡ä»¶"><a href="#åˆ é™¤ç›®å½•å’Œæ–‡ä»¶" class="headerlink" title="åˆ é™¤ç›®å½•å’Œæ–‡ä»¶"></a>åˆ é™¤ç›®å½•å’Œæ–‡ä»¶</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rmdir remove##åˆ é™¤ç›®å½•</span><br><span class="line">$ rmdir text/*.php##åˆ é™¤testç›®å½•ä¸‹çš„æ‰€æœ‰phpæ–‡ä»¶</span><br><span class="line">$ rmdir -r test##åˆ é™¤å‰æœ‰æç¤º</span><br><span class="line">$ rmdir -f##é¿å…äº¤äº’ç›´æ¥å›ç­”y</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="æ”¹å˜æ–‡ä»¶æ‰€æœ‰æƒ"><a href="#æ”¹å˜æ–‡ä»¶æ‰€æœ‰æƒ" class="headerlink" title="æ”¹å˜æ–‡ä»¶æ‰€æœ‰æƒ"></a>æ”¹å˜æ–‡ä»¶æ‰€æœ‰æƒ</h6><p>chownè¯­æ³•å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown [OPTION]... [OWNEr][:[GROUP]] FILE..</span><br></pre></td></tr></table></figure><p><a href="https://cdn2.pandaimg.com/2022/10/13/6347f350c425d.png"><img src="https://cdn2.pandaimg.com/2022/10/13/6347f350c425d.png" alt="å±å¹•æˆªå›¾ 2022-10-13 191232.png"></a></p><p>sudo æä¾›-Ré€‰é¡¹ç”¨äºæ”¹å˜ä¸€ä¸ªç›®å½•åŠå…¶ä¸‹æ‰€æœ‰æ–‡ä»¶çš„æ‰€æœ‰æƒè®¾ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown -R lewis iso/##å°†iso/å’Œä¸‹é¢æ‰€æœ‰æ–‡ä»¶äº¤ç»™lewis</span><br></pre></td></tr></table></figure><h6 id="æ”¹å˜ç›®æ ‡æ–‡ä»¶æƒé™"><a href="#æ”¹å˜ç›®æ ‡æ–‡ä»¶æƒé™" class="headerlink" title="æ”¹å˜ç›®æ ‡æ–‡ä»¶æƒé™"></a>æ”¹å˜ç›®æ ‡æ–‡ä»¶æƒé™</h6><p>chmodç”¨äºæ”¹å˜ä¸€ä¸ªæ–‡ä»¶çš„æƒé™ã€‚ä½¿ç”¨ç”¨æˆ·ç»„+&#x2F;-æƒé™çš„è¡¨è¾¾æ–¹å¼ï¼Œæ¥å¢åŠ &#x2F;åˆ é™¤æƒé™ã€‚ç”¨æˆ·ç»„åŒ…æ‹¬æ–‡ä»¶å±ä¸»ï¼ˆuï¼‰ã€æ–‡ä»¶æ•°ç»„ï¼ˆgï¼‰ã€å…¶ä»–äººï¼ˆoï¼‰å’Œæ‰€æœ‰äººï¼ˆaï¼‰ï¼Œæƒé™åŒ…æ‹¬è¯»å–ï¼ˆrï¼‰ã€å†™å…¥ï¼ˆwï¼‰å’Œæ‰§è¡Œï¼ˆxï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ chmod u+x days##å¢åŠ å±ä¸»å¯¹æ–‡ä»¶çš„æ‰§è¡Œæƒé™</span><br><span class="line">$ chmod a-x days##åˆ é™¤æ‰€æœ‰äººå¯¹daysçš„æ‰§è¡Œæƒé™</span><br><span class="line">$ chmod o=u days##å°†å…¶ä»–äººçš„æƒé™å’Œå±ä¸»ä¸€è‡´</span><br></pre></td></tr></table></figure><h6 id="æ–‡ä»¶ç±»å‹"><a href="#æ–‡ä»¶ç±»å‹" class="headerlink" title="æ–‡ä»¶ç±»å‹"></a>æ–‡ä»¶ç±»å‹</h6><p><a href="https://cdn2.pandaimg.com/2022/10/13/6347f9e831a3c.png"><img src="https://cdn2.pandaimg.com/2022/10/13/6347f9e831a3c.png" alt="å±å¹•æˆªå›¾ 2022-10-13 194308.png"></a></p><p>Linuxæœ‰ä¸¤ç±»è®¾å¤‡æ–‡ä»¶ï¼šå­—ç¬¦è®¾å¤‡å’Œå—è®¾å¤‡æ–‡ä»¶ã€‚å­—ç¬¦è®¾å¤‡æŒ‡çš„æ˜¯èƒ½å¤Ÿä»ä»–é‚£é‡Œè¯»å–æˆå­—ç¬¦åºåˆ—çš„è®¾å¤‡ï¼Œå¦‚ç£å¸¦å’Œä¸²è¡Œçº¿è·¯ï¼Œå—è®¾å¤‡æŒ‡çš„æ˜¯ç”¨æ¥å­˜å‚¨æ•°æ®å¹¶å¯¹å…¶å„éƒ¨åˆ†å†…å®¹æä¾›åŒç­‰è®¿é—®æƒçš„è®¾å¤‡ã€‚å¦‚ç£ç›˜ã€‚</p><h6 id="å»ºç«‹é“¾æ¥"><a href="#å»ºç«‹é“¾æ¥" class="headerlink" title="å»ºç«‹é“¾æ¥"></a>å»ºç«‹é“¾æ¥</h6><p>ç¬¦å·é“¾æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ln -s days my_days##å»ºç«‹ä¸€ä¸ªmy_daysçš„ç¬¦å·é“¾æ¥æŒ‡å‘æ–‡æœ¬æ–‡ä»¶days</span><br></pre></td></tr></table></figure><p>è®¿é—®my_dayså°±ç›¸å½“äºè®¿é—®daysäº†ã€‚å¯ä»¥çœ‹ä½œå¿«æ·æ–¹å¼åˆ é™¤å¹¶ä¸ä¼šå¯¹æºæ–‡ä»¶æœ‰å½±å“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ln -s /usr/local/share/ local_share##å»ºç«‹ä¸€ä¸ªæŒ‡å‘/usr/local/shareçš„ç¬¦å·é“¾æ¥local_share</span><br></pre></td></tr></table></figure><p>ç¡¬é“¾æ¥ï¼šå°†ä¸¤ä¸ªç‹¬ç«‹çš„æ–‡ä»¶è”ç³»åœ¨ä¸€èµ·ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ln days hard_days##å»ºç«‹ä¸€ä¸ªé“¾æ¥åˆ°daysçš„æ–°æ–‡ä»¶hard_days</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ–‡ä»¶çš„æ”¹åŠ¨ä¼šç›¸äº’å½±å“ã€‚</p><h6 id="è¾“å…¥è¾“å‡ºé‡å®šå‘å’Œç®¡é“"><a href="#è¾“å…¥è¾“å‡ºé‡å®šå‘å’Œç®¡é“" class="headerlink" title="è¾“å…¥è¾“å‡ºé‡å®šå‘å’Œç®¡é“"></a>è¾“å…¥è¾“å‡ºé‡å®šå‘å’Œç®¡é“</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls &gt; ~/ls_out##å°†lsçš„è¾“å‡ºé‡å®šå‘åˆ°lsoutæ–‡ä»¶ä¸­ï¼Œlsçš„è¾“å‡ºä¸æ˜¾ç¤ºåœ¨å±å¹•ä¸Š</span><br></pre></td></tr></table></figure><p>å¦‚æœls_outä¸å­˜åœ¨é‚£ä¹ˆä¼šå°è¯•å»ºç«‹è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœå·²ç»å­˜åœ¨ä¼šæ›¿æ¢åŸæ¥çš„æ–‡ä»¶å†…å®¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt; days##è®©ç¨‹åºä»ä¸€ä¸ªæ–‡ä»¶ä¸­è·å–è¾“å…¥</span><br></pre></td></tr></table></figure><p><a href="https://cdn2.pandaimg.com/2022/10/13/634808e94fcc6.png"><img src="https://cdn2.pandaimg.com/2022/10/13/634808e94fcc6.png" alt="å±å¹•æˆªå›¾ 2022-10-13 204659.png"></a></p><h6 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h6><p><a href="https://cdn2.pandaimg.com/2022/10/13/6348095b998d1.png"><img src="https://cdn2.pandaimg.com/2022/10/13/6348095b998d1.png" alt="å±å¹•æˆªå›¾ 2022-10-13 204909.png"></a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Linuxç³»ç»Ÿç®¡ç†ç¯‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç®¡ç†ç¯‡â€”â€”åŸºæœ¬æŒ‡ä»¤</title>
      <link href="/2022/10/12/2022-10-12-Linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/"/>
      <url>/2022/10/12/2022-10-12-Linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h2><h6 id="æµè§ˆæ–‡ä»¶ç¡¬ç›˜"><a href="#æµè§ˆæ–‡ä»¶ç¡¬ç›˜" class="headerlink" title="æµè§ˆæ–‡ä»¶ç¡¬ç›˜"></a>æµè§ˆæ–‡ä»¶ç¡¬ç›˜</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd /         ##è¿›å…¥æ ¹ç›®å½•</span><br><span class="line">$ ls           ##åˆ—å‡ºæ–‡ä»¶å’Œç›®å½•</span><br><span class="line">$ cat animal.c ##æŸ¥çœ‹animal.c</span><br></pre></td></tr></table></figure><p>åœ¨è¾“å…¥æ–‡ä»¶åæ—¶å€™ï¼Œåªç”¨è¾“å…¥å‰é¢å‡ ä¸ªå­—ç¬¦æŒ‰ä¸‹TABï¼ŒShellä¼šè‡ªåŠ¨è¡¥å…¨ã€‚å¦‚æœä¸æ­¢ä¸€ä¸ªï¼Œshellä¼šä»¥åˆ—è¡¨å½¢å¼å…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚</p><h6 id="æŸ¥çœ‹ç›®å½•å’Œæ–‡ä»¶"><a href="#æŸ¥çœ‹ç›®å½•å’Œæ–‡ä»¶" class="headerlink" title="æŸ¥çœ‹ç›®å½•å’Œæ–‡ä»¶"></a>æŸ¥çœ‹ç›®å½•å’Œæ–‡ä»¶</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pwd                     ##æ˜¾ç¤ºå½“å‰ç›®å½•</span><br></pre></td></tr></table></figure><h6 id="æ”¹å˜ç›®å½•"><a href="#æ”¹å˜ç›®å½•" class="headerlink" title="æ”¹å˜ç›®å½•"></a>æ”¹å˜ç›®å½•</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd ..##è¿›å…¥/usrå­ç›®å½•</span><br><span class="line">$ cd ../..##è¿›å…¥æ ¹ç›®å½•å³/ç›®å½•</span><br><span class="line">$ cd ##å›åˆ°ç”¨æˆ·ä¸»ç›®å½•</span><br></pre></td></tr></table></figure><h6 id="åˆ—å‡ºç›®å½•"><a href="#åˆ—å‡ºç›®å½•" class="headerlink" title="åˆ—å‡ºç›®å½•"></a>åˆ—å‡ºç›®å½•</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls -a##æŸ¥çœ‹ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŒ…å«éšè—æ–‡ä»¶</span><br><span class="line">$ ls -1##æŸ¥çœ‹æ–‡ä»¶çš„å„ç§å±æ€§</span><br><span class="line">$ ls -F##åŒºåˆ†ç›®å½•ä¸‹æ–‡ä»¶ç±»å‹</span><br></pre></td></tr></table></figure><h6 id="åˆ—å‡ºç›®å½•-1"><a href="#åˆ—å‡ºç›®å½•-1" class="headerlink" title="åˆ—å‡ºç›®å½•"></a>åˆ—å‡ºç›®å½•</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dir##å’Œlsä¸€æ ·</span><br><span class="line">$ vdir##ç›¸å½“äºls-1</span><br></pre></td></tr></table></figure><h6 id="æŸ¥çœ‹æ–‡æœ¬æ–‡ä»¶"><a href="#æŸ¥çœ‹æ–‡æœ¬æ–‡ä»¶" class="headerlink" title="æŸ¥çœ‹æ–‡æœ¬æ–‡ä»¶"></a>æŸ¥çœ‹æ–‡æœ¬æ–‡ä»¶</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat boolã€‚c##æŸ¥çœ‹bool.cæ–‡ä»¶çš„å†…å®¹</span><br><span class="line">$ cat bool.c data.c##æŸ¥çœ‹bool.c data.c æ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥æŸ¥çœ‹ä¸åªä¸€ä¸ªæ–‡ä»¶å†…å®¹</span><br><span class="line">$ cat -n bool.c##å¯ä»¥é—®å†…å®¹å‰æ˜¾ç¤ºè¡Œæ•°</span><br></pre></td></tr></table></figure><h6 id="é˜…è¯»çš„æ–‡ä»¶å¼€å¤´å’Œç»“å°¾"><a href="#é˜…è¯»çš„æ–‡ä»¶å¼€å¤´å’Œç»“å°¾" class="headerlink" title="é˜…è¯»çš„æ–‡ä»¶å¼€å¤´å’Œç»“å°¾"></a>é˜…è¯»çš„æ–‡ä»¶å¼€å¤´å’Œç»“å°¾</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ head data.c##æ˜¾ç¤ºdataã€‚cçš„å¼€å¤´</span><br><span class="line">$ head -n 2 data.c##æ˜¾ç¤ºdata.cæ–‡ä»¶çš„å‰ä¸¤è¡Œ</span><br></pre></td></tr></table></figure><h6 id="æ–‡æœ¬é˜…è¯»less"><a href="#æ–‡æœ¬é˜…è¯»less" class="headerlink" title="æ–‡æœ¬é˜…è¯»less"></a>æ–‡æœ¬é˜…è¯»less</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ less /c/data.c##æ‰“å¼€Cä¸‹çš„data.cæ–‡ä»¶</span><br><span class="line">ä¹‹åå‘ä¸‹ç¿»é¡µæŒ‰ç©ºæ ¼å‘ä¸Šç¿»é¡µæŒ‰Bä½¿ç”¨/å†…å®¹ï¼Œå¯ä»¥æŸ¥è¯¢é«˜äº®æ˜¾ç¤ºæŸ¥è¯¢ä¸‹ä¸€ä¸ªå†è¾“å…¥/</span><br><span class="line">æŒ‰ä¸‹qå¯é€€å‡º</span><br></pre></td></tr></table></figure><h6 id="æŸ¥æ‰¾æ–‡ä»¶å†…å®¹"><a href="#æŸ¥æ‰¾æ–‡ä»¶å†…å®¹" class="headerlink" title="æŸ¥æ‰¾æ–‡ä»¶å†…å®¹"></a>æŸ¥æ‰¾æ–‡ä»¶å†…å®¹</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grep main data.c##æŸ¥æ‰¾data.cä¸­åŒ…å«mainçš„è¡Œ</span><br><span class="line">$ grep main data.c animal.c     ##å¯ä»¥åœ¨å¤šä¸ªæ–‡ä»¶ä¸­æŸ¥æ‰¾ï¼ŒæŸ¥å…³é”®è¯æ—¶å€™è¦åŠ ä¸Šâ€˜â€™å•å¼•å·</span><br></pre></td></tr></table></figure><h6 id="findå‘½ä»¤"><a href="#findå‘½ä»¤" class="headerlink" title="findå‘½ä»¤"></a>findå‘½ä»¤</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find [OPTION] [path..] [expression]</span><br><span class="line">$ find c/d/2.c##c/d/2.c</span><br><span class="line">$ find c/d -name 2.c##c/d2.c</span><br><span class="line">$ find c/d -name 2.c -printf ok ##ok</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find c/d -type f -mtime -7 ##7å¤©å†…ä¿®æ”¹è¿‡çš„æ–‡ä»¶</span><br></pre></td></tr></table></figure><h6 id="å¿«é€Ÿå®šä½æ–‡ä»¶"><a href="#å¿«é€Ÿå®šä½æ–‡ä»¶" class="headerlink" title="å¿«é€Ÿå®šä½æ–‡ä»¶"></a>å¿«é€Ÿå®šä½æ–‡ä»¶</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ locate *.c</span><br></pre></td></tr></table></figure><h6 id="æŸ¥æ‰¾ç‰¹å®šç¨‹åº"><a href="#æŸ¥æ‰¾ç‰¹å®šç¨‹åº" class="headerlink" title="æŸ¥æ‰¾ç‰¹å®šç¨‹åº"></a>æŸ¥æ‰¾ç‰¹å®šç¨‹åº</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ whereis find##æŸ¥æ‰¾find</span><br><span class="line">$ whereis -b find##æŸ¥æ‰¾è¿™ä¸ªç¨‹åºçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶</span><br></pre></td></tr></table></figure><h6 id="ç”¨æˆ·ç‰ˆæœ¬ä¿¡æ¯æŸ¥çœ‹"><a href="#ç”¨æˆ·ç‰ˆæœ¬ä¿¡æ¯æŸ¥çœ‹" class="headerlink" title="ç”¨æˆ·ç‰ˆæœ¬ä¿¡æ¯æŸ¥çœ‹"></a>ç”¨æˆ·ç‰ˆæœ¬ä¿¡æ¯æŸ¥çœ‹</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ who##çœ‹æœ‰å“ªäº›äººç™»å½•</span><br><span class="line">$ whoami##æˆ‘æ˜¯è°</span><br></pre></td></tr></table></figure><h6 id="ç³»ç»Ÿä¿¡æ¯"><a href="#ç³»ç»Ÿä¿¡æ¯" class="headerlink" title="ç³»ç»Ÿä¿¡æ¯"></a>ç³»ç»Ÿä¿¡æ¯</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a##æ˜¾ç¤ºç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯</span><br><span class="line">$ uname -r##æ˜¾ç¤ºå†…æ ¸ç‰ˆæœ¬ä¿¡æ¯</span><br></pre></td></tr></table></figure><h6 id="å¯»æ±‚å¸®åŠ©æŒ‡ä»¤"><a href="#å¯»æ±‚å¸®åŠ©æŒ‡ä»¤" class="headerlink" title="å¯»æ±‚å¸®åŠ©æŒ‡ä»¤"></a>å¯»æ±‚å¸®åŠ©æŒ‡ä»¤</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ man find##è·å–findæŒ‡ä»¤çš„ä¿¡æ¯</span><br></pre></td></tr></table></figure><h6 id="è·å–å‘½ä»¤ç®€ä»‹"><a href="#è·å–å‘½ä»¤ç®€ä»‹" class="headerlink" title="è·å–å‘½ä»¤ç®€ä»‹"></a>è·å–å‘½ä»¤ç®€ä»‹</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ whatis uame##-printf system information</span><br></pre></td></tr></table></figure><h6 id="ldd"><a href="#ldd" class="headerlink" title="ldd"></a>ldd</h6><p>lddå¯ä»¥åˆ—å‡ºä¸€ä¸ªç¨‹åºæ‰€éœ€è¦çš„å…±äº«åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ldd animal##æŸ¥è¯¢animalæ–‡ä»¶éœ€è¦çš„animalæ–‡ä»¶</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Linuxç³»ç»Ÿç®¡ç†ç¯‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>stm32å®æˆ˜ç¯‡</title>
      <link href="/2022/10/09/2022-10-9-stm32%E5%AE%9E%E6%88%98%E7%AF%87/"/>
      <url>/2022/10/09/2022-10-9-stm32%E5%AE%9E%E6%88%98%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="å®æˆ˜ç¬¬ä¸€ç¯‡è·‘é©¬ç¯"><a href="#å®æˆ˜ç¬¬ä¸€ç¯‡è·‘é©¬ç¯" class="headerlink" title="å®æˆ˜ç¬¬ä¸€ç¯‡è·‘é©¬ç¯"></a>å®æˆ˜ç¬¬ä¸€ç¯‡è·‘é©¬ç¯</h2><p>ç¬¬ä¸€ç¯‡æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œæ²¡ä»€ä¹ˆæ–°é²œçš„ä¸œè¥¿ï¼Œå°±æ˜¯ä½¿ç”¨cubemxè¿›è¡Œå»ºç«‹å·¥ç¨‹ï¼Œæ–°å»ºled.cå’Œled.hæ–‡ä»¶ï¼Œå¯¹å¼•è„šè¿›è¡Œèµ‹äºˆé«˜ä½ç”µå¹³ï¼Œæ­¤æ¬¡ä¸ä¸€æ ·çš„æ˜¯åœ¨led.hæ–‡ä»¶ä¸­å¯¹ç›¸åº”çš„IOå£ç”¨è‹±æ–‡åšäº†å®å®šä¹‰ï¼Œé˜²æ­¢ä»¥åè¿›è¡Œé‡å¤æ··ä¹±è°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __LED_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED1_PIN         GPIO_PIN_8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED1_GPIO_PORT   GPIOA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED2_PIN         GPIO_PIN_2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED2_GPIO_PORT   GPIOD</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_RED_ON</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_RED_OFF</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_GRE_ON</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_GRE_OFF</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h2 id="å®æˆ˜ç¬¬äºŒç¯‡æŒ‰é”®æ£€æµ‹"><a href="#å®æˆ˜ç¬¬äºŒç¯‡æŒ‰é”®æ£€æµ‹" class="headerlink" title="å®æˆ˜ç¬¬äºŒç¯‡æŒ‰é”®æ£€æµ‹"></a>å®æˆ˜ç¬¬äºŒç¯‡æŒ‰é”®æ£€æµ‹</h2><h4 id="ç¡¬ä»¶æ¶ˆæŠ–"><a href="#ç¡¬ä»¶æ¶ˆæŠ–" class="headerlink" title="ç¡¬ä»¶æ¶ˆæŠ–"></a>ç¡¬ä»¶æ¶ˆæŠ–</h4><p>é¦–å…ˆæ˜¯ç¡¬ä»¶çš„è®¾è®¡ï¼ŒæŒ‰ä¸‹æŒ‰é”®ä¸ä¼šç«‹å³å“åº”ï¼Œæœ‰æ³¢çº¹ä¿¡å·ï¼Œä¸æ–¹ä¾¿æ£€æµ‹éœ€è¦è¿›è¡Œæ»¤æ³¢æ¶ˆæŠ–ã€‚å¯ä»¥åˆ©ç”¨ç”µå®¹çš„æ”¾ç”µå»¶è¿Ÿè¾¾åˆ°æ¶ˆé™¤æŠ–åŠ¨çš„ç›®çš„ï¼Œè¿™æ ·åªéœ€è¦æ£€æµ‹å¼•è„šçš„ç”µå¹³ã€‚</p><p><a href="https://postimg.cc/62dPcFkc"><img src="https://i.postimg.cc/hjwqDBMk/2022-09-27-181925.png" alt="2022-09-27-181925.png"></a></p><h4 id="è½¯ä»¶æ¶ˆæŠ–"><a href="#è½¯ä»¶æ¶ˆæŠ–" class="headerlink" title="è½¯ä»¶æ¶ˆæŠ–"></a>è½¯ä»¶æ¶ˆæŠ–</h4><p>å½“æ£€æµ‹åˆ°æŒ‰é”®çŠ¶æ€å˜åŒ–åï¼Œå…ˆç­‰å¾…ä¸€ä¸ª10mså·¦å³çš„å»¶æ—¶æ—¶é—´ï¼Œè®©æŠ–åŠ¨æ¶ˆå¤±åå†è¿›è¡Œä¸€æ¬¡æŒ‰é”®çŠ¶æ€æ£€æµ‹ï¼Œå¦‚æœä¸åˆšæ‰çš„çŠ¶æ€ç›¸åŒï¼Œå°±æ˜¯ç¨³å®šäº†ï¼Œä½†æ˜¯æœ‰å±€é™æ€§ã€‚</p><p>æŸ¥è¯¢ç›¸å…³IOå£åœ¨cubemxä¸­è¿›è¡Œè®¾ç½®ä¸ºè¾“å…¥çŠ¶æ€ã€‚ç”±äºå¼•è„šçš„é»˜è®¤ç”µå¹³å—æŒ‰é”®ç”µè·¯å½±å“ï¼Œæ‰€ä»¥è®¾ç½®æˆâ€œæµ®ç©º&#x2F;ä¸Šæ‹‰&#x2F;ä¸‹æ‹‰â€æ¨¡å¼å‡æ²¡æœ‰åŒºåˆ«ã€‚</p><p>armæ±‡ç¼–æŒ‡ä»¤é›†</p><p><a href="https://postimg.cc/v413R6K1"><img src="https://i.postimg.cc/zG7MgCSk/2022-09-27-202146.png" alt="2022-09-27-202146.png"></a></p><p>æ ˆçš„ä½œç”¨æ˜¯ç”¨äºå±€éƒ¨å˜é‡ï¼Œå‡½æ•°è°ƒç”¨ï¼Œå‡½æ•°å½¢å‚ç­‰çš„å¼€é”€ï¼Œæ ˆçš„å¤§å°ä¸èƒ½è¶…è¿‡å†…éƒ¨ SRAM çš„å¤§<br>å°ã€‚å¦‚æœç¼–å†™çš„ç¨‹åºæ¯”è¾ƒå¤§ï¼Œå®šä¹‰çš„å±€éƒ¨å˜é‡å¾ˆå¤šï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹æ ˆçš„å¤§å°ã€‚å¦‚æœæŸä¸€å¤©ï¼Œä½ <br>å†™çš„ç¨‹åºå‡ºç°äº†è«åå¥‡æ€ªçš„é”™è¯¯ï¼Œå¹¶è¿›å…¥äº†ç¡¬ fault çš„æ—¶å€™ï¼Œè¿™æ—¶ä½ å°±è¦è€ƒè™‘ä¸‹æ˜¯ä¸æ˜¯æ ˆä¸å¤Ÿå¤§ï¼Œ<br>æº¢å‡ºäº†ã€‚å †ä¸»è¦ç”¨æ¥åŠ¨æ€å†…å­˜çš„åˆ†é…</p><h2 id="RCCæ—¶é’Ÿæ ‘"><a href="#RCCæ—¶é’Ÿæ ‘" class="headerlink" title="RCCæ—¶é’Ÿæ ‘"></a>RCCæ—¶é’Ÿæ ‘</h2><p>è®¾ç½®ç³»ç»Ÿæ—¶é’Ÿ SYSCLKã€è®¾ç½® AHB åˆ†é¢‘å› å­ï¼ˆå†³å®š HCLK ç­‰äºå¤šå°‘ï¼‰ã€è®¾ç½® APB2 åˆ†é¢‘å› å­ï¼ˆå†³<br>å®š PCLK2 ç­‰äºå¤šå°‘ï¼‰ã€è®¾ç½® APB1 åˆ†é¢‘å› å­ï¼ˆå†³å®š PCLK1 ç­‰äºå¤šå°‘ï¼‰ã€è®¾ç½®å„ä¸ªå¤–è®¾çš„åˆ†é¢‘å› å­ï¼›<br>æ§åˆ¶ AHBã€APB2 å’Œ APB1 è¿™ä¸‰æ¡æ€»çº¿æ—¶é’Ÿçš„å¼€å¯ã€æ§åˆ¶æ¯ä¸ªå¤–è®¾çš„æ—¶é’Ÿçš„å¼€å¯ã€‚</p><p>ä¸€èˆ¬æ˜¯ï¼šPCLK2 &#x3D; HCLK &#x3D; SYSCLK&#x3D;PLLCLK &#x3D; 72Mï¼Œ<br>               PCLK1&#x3D;HCLK&#x2F;2 &#x3D; 36M</p><p>HSE æ˜¯é«˜é€Ÿçš„å¤–éƒ¨æ—¶é’Ÿä¿¡å·ï¼Œå¯ä»¥ç”±æœ‰æºæ™¶æŒ¯æˆ–è€…æ— æºæ™¶æŒ¯æä¾›ï¼Œé¢‘ç‡ä» 4-16MHZ ä¸ç­‰ã€‚å½“<br>ä½¿ç”¨æœ‰æºæ™¶æŒ¯æ—¶ï¼Œæ—¶é’Ÿä» OSC_IN å¼•è„šè¿›å…¥ï¼ŒOSC_OUT å¼•è„šæ‚¬ç©ºï¼Œå½“é€‰ç”¨æ— æºæ™¶æŒ¯æ—¶ï¼Œæ—¶é’Ÿä»<br>OSC_IN å’Œ OSC_OUT è¿›å…¥ï¼Œå¹¶ä¸”è¦é…è°æŒ¯ç”µå®¹ã€‚</p><p>ç³»ç»Ÿæ—¶é’Ÿ SYSCLK ç»è¿‡ AHB é¢„åˆ†é¢‘å™¨åˆ†é¢‘ä¹‹åå¾—åˆ°æ—¶é’Ÿå« APB æ€»çº¿æ—¶é’Ÿï¼Œå³ HCLKã€‚</p><p>APB2 æ€»çº¿æ—¶é’Ÿ PCLK2 ç”± HCLK ç»è¿‡é«˜é€Ÿ APB2 é¢„åˆ†é¢‘å™¨å¾—åˆ°ï¼ŒHCLK2 å±äºé«˜é€Ÿçš„æ€»çº¿æ—¶é’Ÿï¼Œç‰‡ä¸Š<br>é«˜é€Ÿçš„å¤–è®¾å°±æŒ‚è½½åˆ°è¿™æ¡æ€»çº¿ä¸Šã€‚APB1 æ€»çº¿æ—¶é’Ÿ PCLK1 ç”± HCLK ç»è¿‡ä½é€Ÿ APB é¢„åˆ†é¢‘å™¨å¾—åˆ°ï¼ŒPCLK1 å±äºä½é€Ÿçš„æ€»çº¿æ—¶é’Ÿï¼Œæœ€é«˜ä¸º 36Mï¼Œç‰‡ä¸Šä½é€Ÿçš„å¤–è®¾å°±æŒ‚è½½åˆ°è¿™æ¡æ€»çº¿ä¸Šï¼Œæ¯”å¦‚ USART2&#x2F;3&#x2F;4&#x2F;5ã€SPI2&#x2F;3ï¼ŒI2C1&#x2F;2 ç­‰ã€‚</p><p>USB æ—¶é’Ÿæ˜¯ç”± PLLCLK ç»è¿‡ USB é¢„åˆ†é¢‘å™¨å¾—åˆ°ï¼ŒUSB å¯¹æ—¶é’Ÿè¦æ±‚æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥ PLLCLK åªèƒ½æ˜¯ç”± HSE å€é¢‘å¾—åˆ°ï¼Œä¸èƒ½ä½¿ç”¨ HSI å€é¢‘ã€‚</p><p>ADC æ—¶é’Ÿç”± PCLK2 ç»è¿‡ ADC é¢„åˆ†é¢‘å™¨å¾—åˆ°ã€‚</p><p>RTC æ—¶é’Ÿå¯ç”± HSE&#x2F;128 åˆ†é¢‘å¾—åˆ°ï¼Œä¹Ÿå¯ç”±ä½é€Ÿå¤–éƒ¨æ—¶é’Ÿä¿¡å· LSE æä¾›ï¼Œé¢‘ç‡ä¸º 32.768KHZï¼Œä¹Ÿå¯ç”±<br>ä½é€Ÿå†…éƒ¨æ—¶é’Ÿä¿¡å·LSIæä¾›ã€‚ç‹¬ç«‹çœ‹é—¨ç‹—çš„æ—¶é’Ÿç”± LSI æä¾›ï¼Œä¸”åªèƒ½æ˜¯ç”± LSI æä¾›ï¼ŒLSI æ˜¯ä½é€Ÿçš„å†…éƒ¨æ—¶é’Ÿä¿¡å·ï¼Œé¢‘ç‡ä¸º 30~60KHZ ç›´æ¥ä¸ç­‰ï¼Œä¸€èˆ¬å– 40KHZã€‚</p><h2 id="ä¸­æ–­åº”ç”¨"><a href="#ä¸­æ–­åº”ç”¨" class="headerlink" title="ä¸­æ–­åº”ç”¨"></a>ä¸­æ–­åº”ç”¨</h2><p>åœ¨ NVIC æœ‰ä¸€ä¸ªä¸“é—¨çš„å¯„å­˜å™¨ï¼šä¸­æ–­ä¼˜å…ˆçº§å¯„å­˜å™¨ NVIC_IPRxï¼Œç”¨æ¥é…ç½®å¤–éƒ¨ä¸­æ–­çš„ä¼˜å…ˆçº§ï¼ŒIPRå®½åº¦ä¸º 8bitï¼ŒåŸåˆ™ä¸Šæ¯ä¸ªå¤–éƒ¨ä¸­æ–­å¯é…ç½®çš„ä¼˜å…ˆçº§ä¸º 0~255ï¼Œæ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚å¦‚æœæœ‰å¤šä¸ªä¸­æ–­åŒæ—¶å“åº”ï¼ŒæŠ¢å ä¼˜å…ˆçº§é«˜çš„å°±ä¼šæŠ¢å æŠ¢å ä¼˜å…ˆçº§ä½çš„ä¼˜å…ˆå¾—åˆ°æ‰§è¡Œï¼Œå¦‚æœæŠ¢å ä¼˜å…ˆçº§ç›¸åŒï¼Œå°±æ¯”è¾ƒå­ä¼˜å…ˆçº§ã€‚å¦‚æœæŠ¢å ä¼˜å…ˆçº§å’Œå­ä¼˜å…ˆçº§éƒ½ç›¸åŒçš„è¯ï¼Œå°±æ¯”è¾ƒä»–ä»¬çš„ç¡¬ä»¶ä¸­æ–­ç¼–å·ï¼Œç¼–å·è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚</p><p>IRQnï¼šç”¨æ¥è®¾ç½®ä¸­æ–­æº</p><p>PreemptionPriorityï¼šæŠ¢å ä¼˜å…ˆçº§</p><p>SubPriorityï¼šå­ä¼˜å…ˆçº§</p><h5 id="å¤–éƒ¨ä¸­æ–­"><a href="#å¤–éƒ¨ä¸­æ–­" class="headerlink" title="å¤–éƒ¨ä¸­æ–­"></a>å¤–éƒ¨ä¸­æ–­</h5><p>EXTIï¼ˆExternal interrupt&#x2F;event controllerï¼‰â€”å¤–éƒ¨ä¸­æ–­&#x2F;äº‹ä»¶æ§åˆ¶å™¨ï¼Œç®¡ç†äº†æ§åˆ¶å™¨çš„ 20 ä¸ªä¸­æ–­&#x2F;äº‹ä»¶çº¿ã€‚æ¯ä¸ªä¸­æ–­&#x2F;äº‹ä»¶çº¿éƒ½å¯¹åº”æœ‰ä¸€ä¸ªè¾¹æ²¿æ£€æµ‹å™¨ï¼Œå¯ä»¥å®ç°è¾“å…¥ä¿¡å·çš„ä¸Šå‡æ²¿æ£€æµ‹å’Œä¸‹é™æ²¿çš„æ£€æµ‹ã€‚</p><p>äº§ç”Ÿä¸­æ–­çº¿è·¯ç›®çš„æ˜¯æŠŠè¾“å…¥ä¿¡å·è¾“å…¥åˆ° NVICï¼Œè¿›ä¸€æ­¥ä¼šè¿è¡Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œå®ç°åŠŸèƒ½ï¼Œè¿™æ ·æ˜¯è½¯ä»¶çº§çš„ã€‚è€Œäº§ç”Ÿäº‹ä»¶çº¿è·¯ç›®çš„å°±æ˜¯ä¼ è¾“ä¸€ä¸ªè„‰å†²ä¿¡å·ç»™å…¶ä»–å¤–è®¾ä½¿ç”¨ï¼Œå¹¶ä¸”æ˜¯ç”µè·¯çº§åˆ«çš„ä¿¡å·ä¼ è¾“ï¼Œå±äºç¡¬ä»¶çº§çš„ã€‚</p><p>cubemxè¿›è¡Œå¼•è„šé…ç½®ï¼Œå¯¹ç›¸åº”çš„IOå¼•è„šé€‰æ‹©GPIO_EXITx,xiè¡¨ç¤ºæŒ‚è½½åœ¨ä¸­æ–­çº¿å‡ ï¼Œå¦‚GPIO_EXTI0å°±æ˜¯æŒ‚åœ¨ä¸­æ–­çº¿0ä¸Šã€‚</p><p>å¼€å¯ä¸‹é™æ²¿è§¦å‘ä¸­æ–­ï¼šå³åœ¨ <strong>æŒ‰ä¸‹æŒ‰é”®æ—¶</strong> ç”µå¹³ç”±é«˜å˜ä¸ºä½æ—¶è§¦å‘ï¼Œåˆ™åœ¨ <code>GPIO mode</code> ä¸­é€‰æ‹© <code>External Interrupt Mode with Falling edge trigger detection</code> </p><p>å¼€å¯ä¸Šå‡æ²¿è§¦å‘ä¸­æ–­ï¼šå³åœ¨ <strong>æŒ‰ä¸‹æŒ‰é”®åæ¾å¼€æ—¶</strong> ç”µå¹³ç”±ä½å˜ä¸ºé«˜æ—¶è§¦å‘ï¼Œåˆ™åœ¨ <code>GPIO mode</code> ä¸­é€‰æ‹© <code>External Interrupt Mode with Rising edge trigger detection</code> </p><p>å¼€å¯ä¸‹é™æ²¿ä¸Šå‡æ²¿éƒ½è§¦å‘ä¸­æ–­ï¼šå³åœ¨ <strong>æŒ‰ä¸‹æ—¶è§¦å‘ï¼Œæ¾å¼€æ—¶å†æ¬¡è§¦å‘</strong>ï¼Œåˆ™åœ¨ <code>GPIO mode</code> ä¸­é€‰æ‹© <code>External Interrupt Mode with Rising/Falling edge trigger detection</code></p><p>å¦‚æœç¡¬ä»¶ä¸Šå·²å¤–éƒ¨ä¸Šæ‹‰æˆ–ä¸‹æ‹‰ï¼Œåˆ™åœ¨<code>GPIO Pull-up/Pull-down</code> ä¸­é€‰æ‹© <code>No pull-up and no pull-down</code> æ—¢ä¸ä¸Šæ‹‰ä¹Ÿä¸ä¸‹æ‹‰ã€‚</p><p>å¦‚æœç¡¬ä»¶å¤–éƒ¨æ²¡æœ‰ä¸Šæ‹‰ï¼Œåˆ™åœ¨<code>GPIO Pull-up/Pull-down</code> ä¸­é€‰æ‹© <code>Pull-up</code> å†…éƒ¨ä¸Šæ‹‰ç”µé˜»ã€‚</p><p>å¦‚æœä¸å¸Œæœ›ç”µå¹³è·³å˜äº‹ä»¶è§¦å‘ä¸­æ–­ï¼Œå°±é…ç½®ä¸ºäº‹ä»¶æ¨¡å¼ï¼Œåä¹‹ï¼Œé…ç½®ä¸ºä¸­æ–­æ¨¡å¼ã€‚</p><p>ä¸­æ–­æ‰§è¡Œæµç¨‹ä¸ºå…ˆä¸­æ–­åˆå§‹åŒ–ï¼Œä½¿ç”¨ä¸­æ–­å¯ä»¥é¿å…ä½¿ç”¨è®ºè¯¢æ¥æ£€æµ‹ï¼Œå‘ç”Ÿç”µå¹³å˜åŒ–è§¦å‘å¤–éƒ¨ä¸­æ–­ï¼Œè¿›å…¥ä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ä¼šè°ƒç”¨ä¸­æ–­å¤„ç†å…¬ç”¨å‡½æ•°ï¼ˆä½¿ç”¨cubemxä¼šåœ¨stm32f1xx_it.cä¸­è‡ªåŠ¨ç”Ÿæˆï¼‰ï¼Œä¸­æ–­å¤„ç†å…¬ç”¨å‡½æ•°ä¸­ä¼šæ£€æµ‹æ ‡å¿—ä½ï¼Œå¹¶æ¸…é›¶æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œç»ˆç«¯ä¸­è¦æ‰§è¡Œçš„äº‹æƒ…å°±æ”¾å…¥ä¸­æ–­å›è°ƒå‡½æ•°ä¸­ã€‚</p><p>å¯ä»¥åœ¨stm32f1xx_it.cä¸­çœ‹åˆ°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">EXTI4_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* USER CODE BEGIN EXTI4_IRQn 0 */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* USER CODE END EXTI4_IRQn 0 */</span></span><br><span class="line">  HAL_GPIO_EXTI_IRQHandler(GPIO_PIN_4);</span><br><span class="line">  <span class="comment">/* USER CODE BEGIN EXTI4_IRQn 1 */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* USER CODE END EXTI4_IRQn 1 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>go to Defnition of HAL_GPIO_EXTI_IRQHandler</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_IRQHandler</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* EXTI line interrupt detected */</span></span><br><span class="line">  <span class="keyword">if</span> (__HAL_GPIO_EXTI_GET_IT(GPIO_Pin) != <span class="number">0x00</span>u)</span><br><span class="line">  &#123;</span><br><span class="line">    __HAL_GPIO_EXTI_CLEAR_IT(GPIO_Pin);</span><br><span class="line">    HAL_GPIO_EXTI_Callback(GPIO_Pin);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­å¹¶æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ï¼Œç„¶åè°ƒç”¨HAL_GPIO_EXTI_Callback(GPIO_Pin);å¤„ç†ä¸­æ–­ï¼ŒåŒæ ·çš„æ–¹å¼æ‰¾åˆ°HAL_GPIO_EXTI_Callbackçš„å®šä¹‰ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°çš„å£°æ˜å‰é¢æœ‰ä¸€ä¸ª__weakå£°æ˜ï¼Œè¿™ä¸ªå£°æ˜è¡¨ç¤ºè¿™ä¸ªå‡½æ•°ä¸€æ—¦è¢«é‡æ–°å£°æ˜ï¼Œè¿™é‡Œçš„å‡½æ•°å°±è‡ªåŠ¨å¤±æ•ˆï¼Œå…¶ä»–å‡½æ•°è°ƒç”¨çš„æ—¶å€™å°±ä¼šæ‰¾åˆ°ä½ æ–°å®šä¹‰çš„åŒåå‡½æ•°ã€‚</p><h2 id="ä¸²å£é€šè®¯"><a href="#ä¸²å£é€šè®¯" class="headerlink" title="ä¸²å£é€šè®¯"></a>ä¸²å£é€šè®¯</h2><p>é€šè®¯åè®®ï¼Œæˆ‘ä»¬ä¹Ÿä»¥åˆ†å±‚çš„æ–¹å¼æ¥ç†è§£ï¼Œæœ€åŸºæœ¬çš„æ˜¯æŠŠå®ƒåˆ†ä¸ºç‰©ç†å±‚å’Œåè®®å±‚ã€‚ç‰©ç†å±‚è§„å®šé€šè®¯ç³»ç»Ÿä¸­å…·æœ‰æœºæ¢°ã€ç”µå­åŠŸèƒ½éƒ¨åˆ†çš„ç‰¹æ€§ï¼Œç¡®ä¿åŸå§‹æ•°æ®åœ¨ç‰©ç†åª’ä½“çš„ä¼ è¾“ã€‚åè®®å±‚ä¸»è¦è§„å®šé€šè®¯é€»è¾‘ï¼Œç»Ÿä¸€æ”¶å‘åŒæ–¹çš„æ•°æ®æ‰“åŒ…ã€è§£åŒ…æ ‡å‡†ã€‚ä¸²å£é€šè®¯æœ‰å¾ˆå¤šæ ‡å‡†ï¼Œä»¥ä¸‹æ˜¯RS-232æ ‡å‡†</p><p><a href="https://postimg.cc/zHmFByDH"><img src="https://i.postimg.cc/d33H5Cz6/2022-09-30-200343.png" alt="2022-09-30-200343.png"></a></p><p>ç”±äº RS-232 ç”µå¹³æ ‡å‡†çš„ä¿¡å·ä¸èƒ½ç›´æ¥è¢«æ§åˆ¶å™¨ç›´æ¥è¯†åˆ«ï¼Œæ‰€ä»¥è¿™äº›ä¿¡å·ä¼šç»è¿‡ä¸€ä¸ªâ€œç”µå¹³è½¬æ¢èŠ¯ç‰‡â€è½¬æ¢æˆæ§åˆ¶å™¨èƒ½è¯†åˆ«çš„â€œTTL æ ‡å‡†â€çš„ç”µå¹³ä¿¡å·ï¼Œæ‰èƒ½å®ç°é€šè®¯ã€‚ç”µå¹³æ ‡å‡†ä¸åŒåˆ†ä¸ºTTLæ ‡å‡†å’ŒRS232ç”µå¹³æ ‡å‡†</p><p><a href="https://postimg.cc/LhHzyFYp"><img src="https://i.postimg.cc/2jW2SzCV/2022-09-30-201456.png" alt="2022-09-30-201456.png"></a></p><p><a href="https://postimg.cc/MXCz6q7k"><img src="https://i.postimg.cc/zXBvkf3f/2022-09-30-201723.png" alt="2022-09-30-201723.png"></a></p><p>é€šç”¨åŒæ­¥å¼‚æ­¥æ”¶å‘å™¨ (Universal Synchronous Asynchronous Receiver and Transmitter) æ˜¯ä¸€ä¸ªä¸²è¡Œé€šä¿¡è®¾å¤‡ï¼Œå¯ä»¥çµæ´»åœ°ä¸å¤–éƒ¨è®¾å¤‡è¿›è¡Œå…¨åŒå·¥æ•°æ®äº¤æ¢ã€‚æœ‰åˆ«äº USART è¿˜æœ‰ä¸€ä¸ª UART(UniversalAsynchronous Receiver and Transmitter)ï¼Œå®ƒæ˜¯åœ¨ USART åŸºç¡€ä¸Šè£å‰ªæ‰äº†åŒæ­¥é€šä¿¡åŠŸèƒ½ï¼Œåªæœ‰å¼‚æ­¥é€šä¿¡ã€‚ç®€å•åŒºåˆ†åŒæ­¥å’Œå¼‚æ­¥å°±æ˜¯çœ‹é€šä¿¡æ—¶éœ€ä¸éœ€è¦å¯¹å¤–æä¾›æ—¶é’Ÿè¾“å‡ºï¼Œæˆ‘ä»¬å¹³æ—¶ç”¨çš„ä¸²å£é€šä¿¡åŸºæœ¬éƒ½æ˜¯ UARTã€‚</p><p>ä¸²å£é€šä¿¡æœ‰ä¸‰ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºè®ºè¯¢æ–¹å¼ã€ä¸­æ–­æ–¹å¼ã€DMAæ–¹å¼ã€‚ä¸²å£çš„é€šè®¯åè®®ç”±å¼€å§‹ä½ï¼Œæ•°æ®ä½ï¼Œæ ¡éªŒä½ï¼Œç»“æŸä½æ„æˆã€‚ä¸€èˆ¬ä»¥ä¸€ä¸ªä½ç”µå¹³ä½œä¸ºä¸€å¸§æ•°æ®çš„èµ·å§‹ï¼Œæ¥ç€è·Ÿéš 8 ä½æˆ–è€… 9 ä½æ•°æ®ä½ï¼Œä¹‹åä¸ºæ ¡éªŒä½ï¼Œåˆ†ä¸ºå¥‡æ ¡éªŒï¼Œå¶æ ¡éªŒå’Œæ— æ ¡éªŒï¼Œæœ€åä»¥ä¸€ä¸ªå…ˆé«˜åä½çš„è„‰å†²è¡¨ç¤ºç»“æŸä½ï¼Œé•¿åº¦å¯ä»¥è®¾ç½®ä¸º 0.5ï¼Œ1ï¼Œ1.5 æˆ– 2 ä½é•¿åº¦ã€‚</p><p>å½“ä½¿ç”¨æ ¡éªŒä½æ—¶ï¼Œä¸²å£ä¼ è¾“çš„é•¿åº¦å°†æ˜¯ 8 ä½çš„æ•°æ®å¸§åŠ ä¸Š 1 ä½çš„æ ¡éªŒä½æ€»å…± 9 ä½ï¼Œæ­¤æ—¶ USART_CR1 å¯„å­˜å™¨çš„ M ä½éœ€è¦è®¾ç½®ä¸º 1ï¼Œå³ 9 æ•°æ®ä½ã€‚å°† USART_CR1 å¯„å­˜å™¨çš„ PCE ä½ç½® 1 å°±å¯ä»¥å¯åŠ¨å¥‡å¶æ ¡éªŒæ§åˆ¶ï¼Œå¥‡å¶æ ¡éªŒç”±ç¡¬ä»¶è‡ªåŠ¨å®Œæˆã€‚å¯åŠ¨äº†å¥‡å¶æ ¡éªŒæ§åˆ¶ä¹‹åï¼Œåœ¨å‘é€æ•°æ®å¸§æ—¶ä¼šè‡ªåŠ¨æ·»åŠ æ ¡éªŒä½ï¼Œæ¥æ”¶æ•°æ®æ—¶è‡ªåŠ¨éªŒè¯æ ¡éªŒä½ã€‚æ¥æ”¶<br>æ•°æ®æ—¶å¦‚æœå‡ºç°å¥‡å¶æ ¡éªŒä½éªŒè¯å¤±è´¥ï¼Œä¼šè§ USART_SR å¯„å­˜å™¨çš„ PE ä½ç½® 1ï¼Œå¹¶å¯ä»¥äº§ç”Ÿå¥‡å¶æ ¡éªŒä¸­æ–­ã€‚ä½¿èƒ½äº†å¥‡å¶æ ¡éªŒæ§åˆ¶åï¼Œæ¯ä¸ªå­—ç¬¦å¸§çš„æ ¼å¼å°†å˜æˆï¼šèµ·å§‹ä½ + æ•°æ®å¸§ + æ ¡éªŒä½ + åœæ­¢ä½</p><p>â€‹      ä»€ä¹ˆæ˜¯ç¡¬ä»¶æµæ§å‘¢ï¼Ÿæµæ§çš„æ¦‚å¿µæºäº RS232 è¿™ä¸ªæ ‡å‡†ï¼Œåœ¨ RS232 æ ‡å‡†é‡Œé¢åŒ…å«äº†ä¸²å£ã€æµæ§çš„å®šä¹‰ã€‚å¤§å®¶ä¸€å®šäº†è§£ï¼ŒRS232 ä¸­çš„â€œRSâ€æ˜¯Recommend Standard çš„ç¼©å†™ï¼Œå³â€æ¨èæ ‡å‡†â€œä¹‹æ„ï¼Œå®ƒå¹¶ä¸åƒ IEEE-1284ã€IEEE-1394 ç­‰æ ‡å‡†ï¼Œæ˜¯ç”±â€œå§”å‘˜ä¼šå®šåˆ¶â€ã€‚å› è€Œï¼Œä¸åŒçš„å‚å•†åœ¨åš RS232 æ—¶ï¼Œå¤šå°‘ä¼šæœ‰ä¸åŒï¼Œæµæ§ä¹Ÿéƒ½ä¼šå­˜åœ¨å·®å¼‚ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦æµæ§?</p><p>ã€€ã€€æ•°æ®åœ¨ä¸¤ä¸ªä¸²å£ä¹‹é—´è¿›è¡Œé€šè®¯çš„æ—¶å€™å¸¸å¸¸ä¼šå‡ºç°ä¸¢å¤±æ•°æ®çš„ç°è±¡ï¼Œæ¯”å¦‚ä¸¤å°è®¡ç®—æœºæˆ–è€…æ˜¯ä¸€å°è®¡ç®—æœºå’Œä¸€ä¸ªå•ç‰‡æœºä¹‹é—´è¿›è¡Œé€šè®¯ï¼Œå½“æ¥æ”¶ç«¯çš„æ•°æ®ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¿˜æœ‰æ•°æ®å‘é€è¿‡æ¥ï¼Œå› ä¸ºæ¥æ”¶ç«¯æ²¡æœ‰æ—¶é—´è¿›è¡Œå¤„ç†ï¼Œé‚£è¿™æ ·çš„æ•°æ®å°±æœ‰å¯èƒ½ä¼šä¸¢å¤±ã€‚åœ¨å·¥ä¸šç°åœºæˆ–è€…å…¶ä»–é¢†åŸŸï¼Œç»å¸¸ä¼šé‡åˆ°è¿™ç§é—®é¢˜ï¼Œæœ¬è´¨åŸå› æ˜¯é€Ÿåº¦ä¸åŒ¹é…ã€å¤„ç†èƒ½åŠ›ä¸åŒ¹é…ã€‚æ¯”å¦‚å•ç‰‡æœºçš„ä¸»é¢‘åªæœ‰20Mæˆ–30Mï¼ŒARMçš„å¤„ç†èƒ½åŠ›å¯èƒ½æ˜¯200Mï¼ŒPCæœºçš„å¤„ç†èƒ½åŠ›æ˜¯å‡ ä¸ªGï¼Œè¿™ç§å¤„ç†èƒ½åŠ›çš„ä¸åŒ¹é…é€ æˆäº†ä¼ è¾“çš„æ—¶å€™æ•°æ®å®¹æ˜“ä¸¢å¤±ã€‚</p><p>ã€€ã€€ç¡¬ä»¶æµæ§å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé€Ÿåº¦åŒ¹é…çš„é—®é¢˜ã€‚å®ƒçš„åŸºæœ¬å«ä¹‰éå¸¸ç®€å•ï¼Œå½“æ¥æ”¶ç«¯æ¥æ”¶åˆ°çš„æ•°æ®å¤„ç†ä¸è¿‡æ¥æ—¶ï¼Œå°±å‘å‘é€ç«¯å‘é€ä¸å†æ¥æ”¶çš„ä¿¡å·ï¼Œå‘é€ç«¯æ¥æ”¶åˆ°è¿™ä¸ªä¿¡å·ä¹‹åå°±ä¼šåœæ­¢å‘é€ï¼Œç›´åˆ°æ”¶åˆ°å¯ä»¥ç»§ç»­å‘é€çš„ä¿¡å·å†ç»§ç»­å‘é€ã€‚å› æ­¤æµæ§æœ¬èº«æ˜¯å¯ä»¥æ§åˆ¶æ•°æ®ä¼ è¾“çš„è¿›åº¦ï¼Œè¿›è€Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚</p><p>ã€€ã€€ä¸€èˆ¬å¸¸ç”¨çš„æµæ§æ–¹å¼æœ‰ä¸¤ç§ï¼šç¡¬ä»¶æµæ§å’Œè½¯ä»¶æµæ§ã€‚</p><p>â€‹ç¡¬ä»¶æµæ§å’Œè½¯ä»¶æµæ§çš„åŒºåˆ«</p><p>ã€€ã€€è½¯ä»¶æµæ§æ˜¯ä»¥ç‰¹æ®Šçš„å­—ç¬¦æ¥ä»£è¡¨ä»æœºå·²ç»ä¸èƒ½å†æ¥æ”¶æ–°çš„æ•°æ®äº†ï¼ŒåŸºæœ¬çš„æµç¨‹å°±æ˜¯ä»æœºåœ¨æ¥æ”¶æ•°æ®å¾ˆå¤šçš„æ—¶å€™æˆ–ä¸»åŠ¨ç»™å‘é€ç«¯å‘é€ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œå½“å‘é€ç«¯æ¥æ”¶åˆ°è¿™ä¸ªç‰¹æ®Šå­—ç¬¦åå°±ä¸èƒ½å†å‘é€æ•°æ®äº†ã€‚</p><p>ã€€ã€€è½¯ä»¶æµæ§å¾ˆæ–¹ä¾¿ï¼Œä¸éœ€è¦å¢åŠ æ–°çš„ç¡¬ä»¶ï¼Œè¿˜æ˜¯ä»¥å‰çš„TXã€RXï¼Œä½†æ˜¯ä½¿ç”¨äº†è½¯ä»¶æµæ§ï¼Œå®ƒæœ¬èº«çš„å­—ç¬¦ä¹Ÿæ˜¯æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®åªä¸è¿‡æ˜¯è¯´åœ¨è½¯ä»¶é‡ŒæŠŠå®ƒè®¾ç½®äº†ä¸€ä¸ªç‰¹æ®Šçš„å«ä¹‰ã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªå…¨åŒå·¥çš„é€šè®¯ï¼Œåœ¨ç»™å¦ä¸€ä¸ªä¸²å£å‘é€æ•°æ®çš„æ—¶å€™å¦‚æœä¹ŸåŒ…å«äº†è¿™æ ·ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œå¯¹æ–¹å°±ä¼šè¯¯ä»¥ä¸ºæˆ‘è®©å®ƒä¸è¦å†å‘é€æ•°æ®äº†ï¼Œä¼šæœ‰ä¸€å®šçš„æ¦‚ç‡å‡ºç°é”™è¯¯ï¼Œè€Œç¡¬ä»¶æµæ§å°±ä¸éœ€è¦è€ƒè™‘è¿™æ–¹é¢ï¼Œåªéœ€è¦ä½¿ç”¨ CTS å’Œ RTSï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ç”±ç¡¬ä»¶æ¥æ“ä½œçš„ã€‚å…·ä½“å¯ä»¥çœ‹<img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_20230227_210206.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>ã€</span><br><span class="line">HAL_UART_Transmit();ä¸²å£è½®è¯¢æ¨¡å¼å‘é€ï¼Œä½¿ç”¨è¶…æ—¶ç®¡ç†æœºåˆ¶</span><br><span class="line">HAL_UART_Receive();ä¸²å£è½®è¯¢æ¨¡å¼æ¥æ”¶ï¼Œä½¿ç”¨è¶…æ—¶ç®¡ç†æœºåˆ¶</span><br><span class="line">HAL_UART_Transmit_IT();ä¸²å£ä¸­æ–­æ¨¡å¼å‘é€</span><br><span class="line">HAL_UART_Receive_IT();ä¸²å£ä¸­æ–­æ¨¡å¼æ¥æ”¶</span><br><span class="line">HAL_UART_Transmit_DMA();ä¸²å£DMAæ¨¡å¼å‘é€</span><br><span class="line">HAL_UART_Transmit_DMA();ä¸²å£DMAæ¨¡å¼æ¥æ”¶</span><br><span class="line"><span class="number">2</span>ã€é˜»å¡ä¼ è¾“æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°å¹¶åœ¨ç­‰å¾…æ—¶é—´å†…ä¸€ç›´ç­‰å¾…æ“ä½œå®Œæˆã€‚</span><br><span class="line">HAL_UART_Transmit</span><br><span class="line">HAL_UART_Receive</span><br><span class="line">æŸ¥è¯¢çš„æ–¹å¼ä¸€èˆ¬å°‘ç”¨ï¼Œè¿™é‡Œä¸åšè¿‡å¤šä»‹ç»ã€‚</span><br><span class="line"><span class="number">3</span>ã€ä¸²å£ä¸­æ–­</span><br><span class="line">ä¸²å£ä¸­æ–­å‡½æ•°</span><br><span class="line">HAL_UART_TxHalfCpltCallback();ä¸€åŠæ•°æ®å‘é€å®Œæˆæ—¶è°ƒç”¨</span><br><span class="line">HAL_UART_TxCpltCallback();æ•°æ®å®Œå…¨å‘é€å®Œæˆåè°ƒç”¨</span><br><span class="line">HAL_UART_RxHalfCpltCallback();ä¸€åŠæ•°æ®æ¥æ”¶å®Œæˆæ—¶è°ƒç”¨</span><br><span class="line">HAL_UART_RxCpltCallback();æ•°æ®å®Œå…¨æ¥å—å®Œæˆåè°ƒç”¨</span><br><span class="line">HAL_UART_ErrorCallback();ä¼ è¾“å‡ºç°é”™è¯¯æ—¶è°ƒç”¨</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/Qxiaofei_/article/details/119029425">(å…·ä½“é…ç½®) ã€STM32ã€‘HALåº“â€”â€”ä¸²å£ä¸­æ–­é€šä¿¡(äºŒ)_Qå¤§å¸…çš„åšå®¢-CSDNåšå®¢_hal ä¸²å£ä¸­æ–­</a></p><p>å½“printfæ‰“å°ä¸å¥½ä½¿æ—¶æ˜¯å› ä¸ºå·¥ç¨‹ä¸­æ²¡æœ‰é€‰Micro USB</p><p><a href="https://postimg.cc/Z9kXMvXH"><img src="https://i.postimg.cc/XvX3Xw8R/2022-10-04-193120.png" alt="2022-10-04-193120.png"></a></p><p><a href="https://blog.csdn.net/zxt510001/article/details/125892562">() STM32 HALåº“ä¸²å£ä¸²å£é€šä¿¡åŸºç¡€çŸ¥è¯†+HALåº“ä»£ç ç†è§£</a></p><h2 id="DMA-ç›´æ¥å­˜å‚¨è®¿é—®"><a href="#DMA-ç›´æ¥å­˜å‚¨è®¿é—®" class="headerlink" title="DMA-ç›´æ¥å­˜å‚¨è®¿é—®"></a>DMA-ç›´æ¥å­˜å‚¨è®¿é—®</h2><p>DMAæ˜¯å•ç‰‡æœºå¤–è®¾ï¼Œä¸å ç”¨CPUï¼Œä¼ è¾“æ•°æ®æ—¶å€™CPUå¯ä»¥åšåˆ«çš„ã€‚å¦‚æœå¤–è®¾è¦æƒ³é€šè¿‡ DMA æ¥ä¼ è¾“æ•°æ®ï¼Œå¿…é¡»å…ˆç»™ DMA æ§åˆ¶å™¨å‘é€ DMA è¯·æ±‚ï¼ŒDMA æ”¶åˆ°è¯·æ±‚ä¿¡å·ä¹‹åï¼Œæ§åˆ¶å™¨ä¼šç»™å¤–è®¾ä¸€ä¸ªåº”ç­”ä¿¡å·ï¼Œå½“å¤–è®¾åº”ç­”åä¸” DMA æ§åˆ¶å™¨æ”¶åˆ°åº”ç­”ä¿¡å·ä¹‹åï¼Œå°±ä¼šå¯åŠ¨ DMA çš„ä¼ è¾“ï¼Œç›´åˆ°ä¼ è¾“å®Œæ¯•ã€‚DMAæœ‰12ä¸ªå¯ç‹¬ç«‹ç¼–ç¨‹é€šé“ï¼Œæ¯ä¸ªé€šé“å¯¹åº”ä¸åŒçš„å¤–è®¾DMAè¯·æ±‚ï¼Œå¯ä»¥æ¥å—å¤šä¸ªè¯·æ±‚ï¼Œä½†åŒæ—¶åªèƒ½æ¥å—ä¸€ä¸ªã€‚ä»²è£å™¨ï¼Œå¤„ç†å“åº”é¡ºåºçš„é—®é¢˜ï¼Œåˆ†ä¸ºè½¯ä»¶é˜¶æ®µå’Œç¡¬ä»¶é˜¶æ®µï¼Œå¯ä»¥åœ¨ DMA_CCRx å¯„å­˜å™¨ä¸­è®¾ç½®ï¼Œæœ‰ 4 ä¸ªç­‰çº§ï¼šéå¸¸é«˜ã€é«˜ã€ä¸­å’Œä½å››ä¸ªä¼˜å…ˆçº§ï¼Œå¦‚æœä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„ DMA é€šé“è¯·æ±‚è®¾ç½®çš„ä¼˜å…ˆçº§ä¸€æ ·ï¼Œåˆ™ä»–ä»¬ä¼˜å…ˆçº§å–å†³äºé€šé“ç¼–å·ï¼Œç¼–å·è¶Šä½ä¼˜å…ˆæƒè¶Šé«˜ã€‚</p><p>MA ä¼ è¾“æ•°æ®çš„æ–¹å‘æœ‰ä¸‰ä¸ªï¼šä»å¤–è®¾åˆ°å­˜å‚¨å™¨ï¼Œä»å­˜å‚¨å™¨åˆ°å¤–è®¾ï¼Œä»å­˜å‚¨å™¨åˆ°å­˜å‚¨å™¨ã€‚å…·ä½“çš„æ–¹å‘ DMA_CCR ä½ 4 DIR é…ç½®ï¼š0 è¡¨ç¤ºä»å¤–è®¾åˆ°å­˜å‚¨å™¨ï¼Œ1 è¡¨ç¤ºä»å­˜å‚¨å™¨åˆ°å¤–è®¾ã€‚</p><p>æ›´å¤šåŸç†å¯å‚çœ‹<a href="https://blog.csdn.net/as480133937/article/details/104927922"> DMAåŸç†</a></p><p>åœ¨cubemxçš„é…ç½®åªéœ€è¦åŠ ä¸Šç›¸åº”è®¾å¤‡çš„DMAæ¨¡å¼ä¾¿å¯ä»¥ç”Ÿæˆä»£ç è¿›è¡Œä½¿ç”¨ã€‚</p><p>I2Cåè®®</p><p>é¦–å…ˆåˆ†ä¸ºç‰©ç†å±‚å’Œåè®®å±‚ï¼Œä¸¤æ–¹é¢æ¥çœ‹ã€‚</p><h4 id="ç‰©ç†å±‚ï¼š"><a href="#ç‰©ç†å±‚ï¼š" class="headerlink" title="ç‰©ç†å±‚ï¼š"></a>ç‰©ç†å±‚ï¼š</h4><p>å®ƒæ˜¯ä¸€ä¸ªæ”¯æŒè®¾å¤‡çš„æ€»çº¿ã€‚â€œæ€»çº¿â€æŒ‡å¤šä¸ªè®¾å¤‡å…±ç”¨çš„ä¿¡å·çº¿ã€‚åœ¨ä¸€ä¸ª I2C é€šè®¯æ€»çº¿ä¸­ï¼Œå¯è¿æ¥å¤šä¸ª I2C é€šè®¯è®¾å¤‡ï¼Œæ”¯æŒå¤šä¸ªé€šè®¯ä¸»æœºåŠå¤šä¸ªé€šè®¯ä»æœºã€‚</p><p>ä¸€ä¸ª I2C æ€»çº¿åªä½¿ç”¨ä¸¤æ¡æ€»çº¿çº¿è·¯ï¼Œä¸€æ¡åŒå‘ä¸²è¡Œæ•°æ®çº¿ (SDA) ï¼Œä¸€æ¡ä¸²è¡Œæ—¶é’Ÿçº¿ (SCL)ã€‚æ•°æ®çº¿å³ç”¨æ¥è¡¨ç¤ºæ•°æ®ï¼Œæ—¶é’Ÿçº¿ç”¨äºæ•°æ®æ”¶å‘åŒæ­¥ã€‚</p><p> æ¯ä¸ªè¿æ¥åˆ°æ€»çº¿çš„è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„åœ°å€ï¼Œä¸»æœºå¯ä»¥åˆ©ç”¨è¿™ä¸ªåœ°å€è¿›è¡Œä¸åŒè®¾å¤‡ä¹‹é—´çš„è®¿é—®ã€‚</p><p>æ€»çº¿é€šè¿‡ä¸Šæ‹‰ç”µé˜»æ¥åˆ°ç”µæºã€‚å½“ I2C è®¾å¤‡ç©ºé—²æ—¶ï¼Œä¼šè¾“å‡ºé«˜é˜»æ€ï¼Œè€Œå½“æ‰€æœ‰è®¾å¤‡éƒ½ç©ºé—²ï¼Œéƒ½è¾“å‡ºé«˜é˜»æ€æ—¶ï¼Œç”±ä¸Šæ‹‰ç”µé˜»æŠŠæ€»çº¿æ‹‰æˆé«˜ç”µå¹³ã€‚</p><p>å¤šä¸ªä¸»æœºåŒæ—¶ä½¿ç”¨æ€»çº¿æ—¶ï¼Œä¸ºäº†é˜²æ­¢æ•°æ®å†²çªï¼Œä¼šåˆ©ç”¨ä»²è£æ–¹å¼å†³å®šç”±å“ªä¸ªè®¾å¤‡å ç”¨æ€»çº¿ã€‚</p><p>å…·æœ‰ä¸‰ç§ä¼ è¾“æ¨¡å¼ï¼šæ ‡å‡†æ¨¡å¼ä¼ è¾“é€Ÿç‡ä¸º 100kbit&#x2F;s ï¼Œå¿«é€Ÿæ¨¡å¼ä¸º 400kbit&#x2F;s ï¼Œé«˜é€Ÿæ¨¡å¼ä¸‹å¯è¾¾ 3.4Mbit&#x2F;sï¼Œä½†ç›®å‰å¤§å¤š I2C è®¾å¤‡å°šä¸æ”¯æŒé«˜é€Ÿæ¨¡å¼</p><h4 id="åè®®å±‚ï¼š"><a href="#åè®®å±‚ï¼š" class="headerlink" title="åè®®å±‚ï¼š"></a>åè®®å±‚ï¼š</h4><p>I2C çš„åè®®å®šä¹‰äº†é€šè®¯çš„èµ·å§‹å’Œåœæ­¢ä¿¡å·ã€æ•°æ®æœ‰æ•ˆæ€§ã€å“åº”ã€ä»²è£ã€æ—¶é’ŸåŒæ­¥å’Œåœ°å€å¹¿æ’­ç­‰ç¯èŠ‚ã€‚</p><p>S è¡¨ç¤ºç”±ä¸»æœºçš„ I2C æ¥å£äº§ç”Ÿçš„ä¼ è¾“èµ·å§‹ä¿¡å· (S)ï¼Œè¿™æ—¶è¿æ¥åˆ° I2C æ€»çº¿ä¸Šçš„æ‰€æœ‰ä»æœºéƒ½ä¼šæ¥æ”¶åˆ°è¿™ä¸ªä¿¡å·ã€‚<br>èµ·å§‹ä¿¡å·äº§ç”Ÿåï¼Œæ‰€æœ‰ä»æœºå°±å¼€å§‹ç­‰å¾…ä¸»æœºç´§æ¥ä¸‹æ¥å¹¿æ’­çš„ä»æœºåœ°å€ä¿¡å· (SLAVE_ADDRESS)ã€‚åœ¨I2C æ€»çº¿ä¸Šï¼Œæ¯ä¸ªè®¾å¤‡çš„åœ°å€éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå½“ä¸»æœºå¹¿æ’­çš„åœ°å€ä¸æŸä¸ªè®¾å¤‡åœ°å€ç›¸åŒæ—¶ï¼Œè¿™ä¸ªè®¾å¤‡å°±è¢«é€‰ä¸­äº†ï¼Œæ²¡è¢«é€‰ä¸­çš„è®¾å¤‡å°†ä¼šå¿½ç•¥ä¹‹åçš„æ•°æ®ä¿¡å·ã€‚æ ¹æ® I2C åè®®ï¼Œè¿™ä¸ªä»æœºåœ°å€å¯ä»¥æ˜¯ 7ä½æˆ– 10 ä½ã€‚åœ¨åœ°å€ä½ä¹‹åï¼Œæ˜¯ä¼ è¾“æ–¹å‘çš„é€‰æ‹©ä½ï¼Œè¯¥ä½ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºåé¢çš„æ•°æ®ä¼ è¾“æ–¹å‘æ˜¯ç”±ä¸»æœºä¼ è¾“è‡³ä»æœºï¼Œå³ä¸»æœºå‘ä»æœºå†™æ•°æ®ã€‚è¯¥ä½ä¸º 1 æ—¶ï¼Œåˆ™ç›¸åï¼Œå³ä¸»æœºç”±ä»æœºè¯»æ•°æ®ã€‚ä»æœºæ¥æ”¶åˆ°åŒ¹é…çš„åœ°å€åï¼Œä¸»æœºæˆ–ä»æœºä¼šè¿”å›ä¸€ä¸ªåº”ç­” (ACK) æˆ–éåº”ç­” (NACK) ä¿¡å·ï¼Œåªæœ‰æ¥æ”¶<br>åˆ°åº”ç­”ä¿¡å·åï¼Œä¸»æœºæ‰èƒ½ç»§ç»­å‘é€æˆ–æ¥æ”¶æ•°æ®ã€‚</p><p>è‹¥æ˜¯ä¼ è¾“ä¸ºå†™æ•°æ®æ–¹å‘ï¼Œæ¥æ”¶åˆ°åº”ç­”ä¿¡å·åï¼Œä¸»æœºå¼€å§‹æ­£å¼å‘ä»æœºä¼ è¾“æ•°æ® (DATA)ï¼Œæ•°æ®åŒ…çš„å¤§å°ä¸º 8 ä½é‚£ä¹ˆä¸»æœºæ¯å‘é€å®Œä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼Œéƒ½è¦ç­‰å¾…ä»æœºçš„åº”ç­”ä¿¡å· (ACK)ã€‚</p><p>è‹¥é…ç½®çš„æ–¹å‘ä¼ è¾“ä½ä¸ºâ€œè¯»æ•°æ®â€æ–¹å‘ï¼Œæ¥æ”¶åˆ°åº”ç­”ä¿¡å·åï¼Œä»æœºå¼€å§‹å‘ä¸»æœºè¿”å›æ•°æ® (DATA)ï¼Œæ•°æ®åŒ…å¤§å°ä¹Ÿä¸º 8 ä½ï¼Œä»æœºæ¯å‘é€å®Œä¸€ä¸ªæ•°æ®ï¼Œéƒ½ä¼šç­‰å¾…ä¸»æœºçš„åº”ç­”ä¿¡å· (ACK)ã€‚</p><p><a href="https://cdn2.pandaimg.com/2022/10/11/634564df3130c.png"><img src="https://cdn2.pandaimg.com/2022/10/11/634564df3130c.png" alt="SDA.png"></a></p><h5 id="SCLå¤„äº1æ—¶-SDAç”±é«˜å˜ä½â†“â€”-gt-Start"><a href="#SCLå¤„äº1æ—¶-SDAç”±é«˜å˜ä½â†“â€”-gt-Start" class="headerlink" title="SCLå¤„äº1æ—¶, SDAç”±é«˜å˜ä½â†“â€”&gt;Start"></a>SCLå¤„äº1æ—¶, SDAç”±é«˜å˜ä½â†“â€”&gt;Start</h5><h5 id="å›¾ä¸­æœ«å°¾Pä¸ºç»“æŸä¿¡å·-SCL-x3D-1-SDA-ç”±ä½å˜é«˜"><a href="#å›¾ä¸­æœ«å°¾Pä¸ºç»“æŸä¿¡å·-SCL-x3D-1-SDA-ç”±ä½å˜é«˜" class="headerlink" title="å›¾ä¸­æœ«å°¾Pä¸ºç»“æŸä¿¡å·: SCL&#x3D;1, SDA ç”±ä½å˜é«˜"></a>å›¾ä¸­æœ«å°¾Pä¸ºç»“æŸä¿¡å·: SCL&#x3D;1, SDA ç”±ä½å˜é«˜</h5><h5 id="æ•°æ®ä¼ é€-æ¯æ¬¡æ•°æ®ä¼ é€éƒ½æ˜¯8ä¸ªå­—èŠ‚-SCL-x3D-1æ—¶-SDAçš„æ•°æ®ä¸å¯ä»¥å˜åŒ–-åªæœ‰SCLä¸ºä½ç”µå¹³-æ•°æ®çº¿çš„æ•°æ®æ‰å¯ä»¥å˜åŒ–"><a href="#æ•°æ®ä¼ é€-æ¯æ¬¡æ•°æ®ä¼ é€éƒ½æ˜¯8ä¸ªå­—èŠ‚-SCL-x3D-1æ—¶-SDAçš„æ•°æ®ä¸å¯ä»¥å˜åŒ–-åªæœ‰SCLä¸ºä½ç”µå¹³-æ•°æ®çº¿çš„æ•°æ®æ‰å¯ä»¥å˜åŒ–" class="headerlink" title="æ•°æ®ä¼ é€: æ¯æ¬¡æ•°æ®ä¼ é€éƒ½æ˜¯8ä¸ªå­—èŠ‚; SCL&#x3D;1æ—¶, SDAçš„æ•°æ®ä¸å¯ä»¥å˜åŒ–, åªæœ‰SCLä¸ºä½ç”µå¹³, æ•°æ®çº¿çš„æ•°æ®æ‰å¯ä»¥å˜åŒ–;"></a>æ•°æ®ä¼ é€: æ¯æ¬¡æ•°æ®ä¼ é€éƒ½æ˜¯8ä¸ªå­—èŠ‚; SCL&#x3D;1æ—¶, SDAçš„æ•°æ®ä¸å¯ä»¥å˜åŒ–, åªæœ‰SCLä¸ºä½ç”µå¹³, æ•°æ®çº¿çš„æ•°æ®æ‰å¯ä»¥å˜åŒ–;</h5><p><a href="%5B(88%E6%9D%A1%E6%B6%88%E6%81%AF"> IIchalç›¸å…³å‡½æ•°åˆ†æ</a> <a href="https://blog.csdn.net/kouxi1/article/details/123834448?ops_request_misc=&request_id=&biz_id=102&utm_term=stm32hal%E5%BA%93iic&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-6-123834448.142%5Ev52%5Econtrol,201%5Ev3%5Econtrol&spm=1018.2226.3001.4187">015] [STM32] IICåè®®è¯¦è§£ä¸HALåº“ç›¸å…³å‡½æ•°åˆ†æ_æŸ¯è¥¿çš„å½·å¾¨çš„åšå®¢-CSDNåšå®¢</a>)</p><h2 id="SPIåè®®"><a href="#SPIåè®®" class="headerlink" title="SPIåè®®"></a>SPIåè®®</h2><p>SPIæ˜¯ä¸€ç§é«˜é€Ÿå…¨åŒå·¥çš„é€šä¿¡æ€»çº¿</p><h4 id="ç‰©ç†å±‚"><a href="#ç‰©ç†å±‚" class="headerlink" title="ç‰©ç†å±‚"></a>ç‰©ç†å±‚</h4><p>SPI é€šè®¯ä½¿ç”¨ 3 æ¡æ€»çº¿åŠç‰‡é€‰çº¿ï¼Œ3 æ¡æ€»çº¿åˆ†åˆ«ä¸º SCKã€MOSIã€MISOï¼Œç‰‡é€‰çº¿</p><p>ä»è®¾å¤‡é€‰æ‹©ä¿¡å·çº¿ï¼Œå¸¸ç§°ä¸ºç‰‡é€‰ä¿¡å·çº¿ï¼Œä¹Ÿç§°ä¸º NSSã€CSè®¾å¤‡çš„å…¶å®ƒä¿¡å·çº¿ SCKã€MOSI åŠ MIS O åŒæ—¶å¹¶è”åˆ°ç›¸åŒçš„ SPI æ€»çº¿ä¸Šï¼Œå³æ— è®ºæœ‰å¤šå°‘ä¸ªä»è®¾å¤‡ï¼Œéƒ½å…±åŒåªä½¿ç”¨è¿™ 3 æ¡æ€»çº¿ï¼›è€Œæ¯ä¸ªä»è®¾å¤‡éƒ½æœ‰ç‹¬ç«‹çš„è¿™ä¸€æ¡ NSS ä¿¡å·çº¿ï¼Œæœ¬ä¿¡å·çº¿ç‹¬å ä¸»æœºçš„ä¸€ä¸ªå¼•è„šï¼Œå³æœ‰å¤šå°‘ä¸ªä»è®¾å¤‡ï¼Œå°±æœ‰å¤šå°‘æ¡ç‰‡é€‰ä¿¡å·çº¿ã€‚è€Œ SPI åè®®ä¸­æ²¡æœ‰è®¾å¤‡åœ°å€ï¼Œå®ƒä½¿ç”¨ NSS ä¿¡å·çº¿æ¥å¯»å€ï¼Œå½“ä¸»æœºè¦é€‰æ‹©ä»è®¾å¤‡æ—¶ï¼ŒæŠŠè¯¥ä»è®¾å¤‡çš„ NSS ä¿¡å·çº¿è®¾ç½®ä¸ºä½ç”µå¹³ï¼Œè¯¥ä»è®¾å¤‡å³è¢«é€‰ä¸­ï¼Œå³ç‰‡é€‰æœ‰æ•ˆï¼Œæ¥ç€ä¸»æœºå¼€å§‹ä¸è¢«é€‰ä¸­çš„ä»è®¾å¤‡è¿›è¡Œ SPI é€šè®¯ã€‚æ‰€ä»¥ SPI é€šè®¯ä»¥ NSS çº¿ç½®ä½ç”µå¹³ä¸ºå¼€å§‹ä¿¡å·ï¼Œä»¥ NSS çº¿è¢«æ‹‰é«˜ä½œä¸ºç»“æŸä¿¡å·ã€‚</p><p>SCK ï¼šæ—¶é’Ÿä¿¡å·çº¿ï¼Œç”¨äºé€šè®¯æ•°æ®åŒæ­¥ã€‚å®ƒç”±é€šè®¯ä¸»æœºäº§ç”Ÿï¼Œå†³å®šäº†é€šè®¯çš„é€Ÿç‡ï¼Œä¸åŒçš„è®¾å¤‡æ”¯æŒçš„æœ€é«˜æ—¶é’Ÿé¢‘ç‡ä¸ä¸€æ ·ã€‚<br> MOSI ï¼šä¸»è®¾å¤‡è¾“å‡º&#x2F;ä»è®¾å¤‡è¾“å…¥å¼•è„šã€‚ä¸»æœºçš„æ•°æ®ä»è¿™æ¡ä¿¡å·çº¿è¾“å‡ºï¼Œä»æœºç”±è¿™æ¡ä¿¡å·çº¿è¯»å…¥ä¸»æœºå‘é€çš„æ•°æ®ï¼Œå³è¿™æ¡çº¿ä¸Šæ•°æ®çš„æ–¹å‘ä¸ºä¸»æœºåˆ°ä»æœºã€‚<br>MISO(Master Input,ï¼ŒSlave Output)ï¼šä¸»è®¾å¤‡è¾“å…¥&#x2F;ä»è®¾å¤‡è¾“å‡ºå¼•è„šã€‚ä¸»æœºä»è¿™æ¡ä¿¡çº¿è¯»å…¥æ•°æ®ï¼Œä»æœºçš„æ•°æ®ç”±è¿™æ¡ä¿¡å·çº¿è¾“å‡ºåˆ°ä¸»æœºï¼Œå³åœ¨è¿™æ¡çº¿ä¸Šæ•°æ®çš„æ–¹å‘ä¸ºä»æœºåˆ°ä¸»æœºã€‚</p><p><a href="https://cdn2.pandaimg.com/2022/10/11/63457405a869b.png"><img src="https://cdn2.pandaimg.com/2022/10/11/63457405a869b.png" alt="å±å¹•æˆªå›¾ 2022-10-11 214647.png"></a></p><p>NSS ä¿¡å·çº¿ç”±é«˜å˜ä½ï¼Œæ˜¯ SPI é€šè®¯çš„èµ·å§‹ä¿¡å·ã€‚NSS æ˜¯æ¯ä¸ªä»æœºå„è‡ªç‹¬å çš„ä¿¡å·çº¿ï¼Œå½“ä»æœºåœ¨è‡ªå·±çš„ NSS çº¿æ£€æµ‹åˆ°èµ·å§‹ä¿¡å·åï¼Œå°±çŸ¥é“è‡ªå·±è¢«ä¸»æœºé€‰ä¸­äº†ï¼Œå¼€å§‹å‡†å¤‡ä¸ä¸»æœºé€šè®¯ã€‚åœ¨å›¾ä¸­çš„æ ‡å·å¤„ï¼ŒNSS ä¿¡å·ç”±ä½å˜é«˜ï¼Œæ˜¯ SPI é€šè®¯çš„åœæ­¢ä¿¡å·ï¼Œè¡¨ç¤ºæœ¬æ¬¡é€šè®¯ç»“æŸï¼Œä»æœºçš„é€‰ä¸­çŠ¶æ€è¢«å–æ¶ˆã€‚</p><p>è§‚å¯Ÿå›¾ä¸­çš„æ ‡å·å¤„ï¼ŒMOSI åŠ MISO çš„æ•°æ®åœ¨ SCK çš„ä¸Šå‡æ²¿æœŸé—´å˜åŒ–è¾“å‡ºï¼Œåœ¨ SCK çš„ä¸‹é™æ²¿æ—¶è¢«é‡‡æ ·ã€‚å³åœ¨ SCK çš„ä¸‹é™æ²¿æ—¶åˆ»ï¼ŒMOSI åŠ MISO çš„æ•°æ®æœ‰æ•ˆï¼Œé«˜ç”µå¹³æ—¶è¡¨ç¤ºæ•°æ®â€œ1â€ï¼Œä¸ºä½ç”µå¹³æ—¶è¡¨ç¤ºæ•°æ®â€œ0â€ã€‚åœ¨å…¶å®ƒæ—¶åˆ»ï¼Œæ•°æ®æ— æ•ˆï¼ŒMOSI åŠ MISO ä¸ºä¸‹ä¸€æ¬¡è¡¨ç¤ºæ•°æ®åšå‡†å¤‡ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> å®æˆ˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>stm32ç³»ç»Ÿå­¦ä¹ </title>
      <link href="/2022/09/24/2022-12-17-stm32%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/"/>
      <url>/2022/09/24/2022-12-17-stm32%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p><strong>stm32ä¸»ç³»ç»Ÿç”±å››ä¸ªå»é©±åŠ¨å•å…ƒå’Œå››ä¸ªè¢«åŠ¨å•å…ƒæ„æˆã€‚</strong></p><p>å››ä¸ªé©±åŠ¨æ˜¯å†…æ ¸DCodeæ€»çº¿ï¼›ç³»ç»Ÿæ€»çº¿ï¼›é€šç”¨DMA1ï¼›é€šç”¨DMA2</p><p>å››è¢«åŠ¨å•å…ƒæ˜¯AHBåˆ°APBçš„æ¡¥ï¼šè¿æ¥æ‰€æœ‰APBçš„è®¾å¤‡ï¼›å†…å­˜FLASHï¼›å†…éƒ¨SRAMï¼›FSMC</p><p>â‘  ICode æ€»çº¿ï¼šè¯¥æ€»çº¿å°† M3 å†…æ ¸æŒ‡ä»¤æ€»çº¿å’Œé—ªå­˜æŒ‡ä»¤æ¥å£ç›¸è¿ï¼ŒæŒ‡ä»¤çš„é¢„å–åœ¨è¯¥æ€»çº¿ä¸Š<br>é¢å®Œæˆã€‚<br>â‘¡ DCode æ€»çº¿ï¼šè¯¥æ€»çº¿å°† M3 å†…æ ¸çš„ DCode æ€»çº¿ä¸é—ªå­˜å­˜å‚¨å™¨çš„æ•°æ®æ¥å£ç›¸è¿æ¥ï¼Œå¸¸é‡<br>åŠ è½½å’Œè°ƒè¯•è®¿é—®åœ¨è¯¥æ€»çº¿ä¸Šé¢å®Œæˆã€‚<br>â‘¢ ç³»ç»Ÿæ€»çº¿ï¼šè¯¥æ€»çº¿è¿æ¥ M3 å†…æ ¸çš„ç³»ç»Ÿæ€»çº¿åˆ°æ€»çº¿çŸ©é˜µï¼Œæ€»çº¿çŸ©é˜µåè°ƒå†…æ ¸å’Œ DMA é—´<br>è®¿é—®ã€‚<br>â‘£ DMA æ€»çº¿ï¼šè¯¥æ€»çº¿å°† DMA çš„ AHB ä¸»æ§æ¥å£ä¸æ€»çº¿çŸ©é˜µç›¸è¿ï¼Œæ€»çº¿çŸ©é˜µåè°ƒ CPU çš„<br>DCode å’Œ DMA åˆ° SRAM,é—ªå­˜å’Œå¤–è®¾çš„è®¿é—®ã€‚<br>â‘¤ æ€»çº¿çŸ©é˜µï¼šæ€»çº¿çŸ©é˜µåè°ƒå†…æ ¸ç³»ç»Ÿæ€»çº¿å’Œ DMA ä¸»æ§æ€»çº¿ä¹‹é—´çš„è®¿é—®ä»²è£ï¼Œä»²è£åˆ©ç”¨<br>è½®æ¢ç®—æ³•ã€‚<br>â‘¥ AHB&#x2F;APB æ¡¥:è¿™ä¸¤ä¸ªæ¡¥åœ¨ AHB å’Œ 2 ä¸ª APB æ€»çº¿é—´æä¾›åŒæ­¥è¿æ¥ï¼ŒAPB1 æ“ä½œé€Ÿåº¦é™äº<br>36MHz,APB2 æ“ä½œé€Ÿåº¦å…¨é€Ÿã€‚</p><p><strong>stm32çš„5ä¸ªæ—¶é’Ÿæº</strong></p><p>ç”¨æ¥é…ç½®æ—¶é’Ÿæ ‘</p><p>â‘ HSI æ˜¯é«˜é€Ÿå†…éƒ¨æ—¶é’Ÿï¼ŒRC æŒ¯è¡å™¨ï¼Œé¢‘ç‡ä¸º 8MHzã€‚<br>â‘¡HSE æ˜¯é«˜é€Ÿå¤–éƒ¨æ—¶é’Ÿï¼Œå¯æ¥çŸ³è‹±&#x2F;é™¶ç“·è°æŒ¯å™¨ï¼Œæˆ–è€…æ¥å¤–éƒ¨æ—¶é’Ÿæºï¼Œé¢‘ç‡èŒƒå›´ä¸º 4MHzåˆ°16MHzã€‚<br>â‘¢LSI æ˜¯ä½é€Ÿå†…éƒ¨æ—¶é’Ÿï¼ŒRC æŒ¯è¡å™¨ï¼Œé¢‘ç‡ä¸º 40kHzã€‚ç‹¬ç«‹çœ‹é—¨ç‹—çš„æ—¶é’Ÿæºåªèƒ½æ˜¯ LSIï¼ŒåŒ<br>æ—¶ LSI è¿˜å¯ä»¥ä½œä¸º RTC çš„æ—¶é’Ÿæºã€‚<br>â‘£LSE æ˜¯ä½é€Ÿå¤–éƒ¨æ—¶é’Ÿï¼Œä½¿ç”¨é¢‘ç‡ä¸º 32.768kHz çš„çŸ³è‹±æ™¶ä½“ã€‚è¿™ä¸ªä¸»è¦æ˜¯ RTC çš„æ—¶é’Ÿæºã€‚<br>â‘¤PLL ä¸ºé”ç›¸ç¯å€é¢‘è¾“å‡ºï¼Œå…¶æ—¶é’Ÿè¾“å…¥æºå¯é€‰æ‹©ä¸º HSI&#x2F;2ã€HSE æˆ–è€… HSE&#x2F;2ã€‚å€é¢‘å¯é€‰æ‹©ä¸º2åˆ°16 å€ï¼Œä½†æ˜¯å…¶è¾“å‡ºé¢‘ç‡æœ€å¤§ä¸å¾—è¶…è¿‡ 72MHzã€‚</p><p>ç¨‹åºæ‰§è¡Œé¡ºåº</p><p><a href="https://postimg.cc/68vJqYZh"><img src="https://i.postimg.cc/2SHzHt8g/liucheng.png" alt="liucheng.png"></a></p>]]></content>
      
      
      
        <tags>
            
            <tag> å®æˆ˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>stm32æœ€å°ç³»ç»Ÿæ¿åˆ¶ä½œ</title>
      <link href="/2022/09/21/2022-09-21-stm32%E6%9C%80%E5%B0%8F%E7%B3%BB%E7%BB%9F%E6%9D%BF%E5%88%B6%E4%BD%9C/"/>
      <url>/2022/09/21/2022-09-21-stm32%E6%9C%80%E5%B0%8F%E7%B3%BB%E7%BB%9F%E6%9D%BF%E5%88%B6%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<p>æ­¤æ¬¡åˆ¶ä½œä½¿ç”¨çš„ä¸ºç«‹åˆ›EDAï¼Œä¸»è¦æ˜¯å¿«é€Ÿä¸Šæ‰‹åˆ¶æ¿ï¼Œæ²¡æœ‰é€‰æ‹©ADã€‚</p><p>é¦–å…ˆäº†è§£<strong>stm32æœ€å°ç³»ç»Ÿç”µè·¯</strong>æ„æˆå¦‚ä¸‹ï¼š</p><p>å¤ä½ç”µè·¯ã€ç”µæºç”µè·¯ã€SWD&#x2F;JTAGä¸‹è½½æ¥å£ã€æ™¶æŒ¯ç”µè·¯ï¼ˆæ—¶é’Ÿç”µè·¯ï¼‰ã€å¯åŠ¨é€‰æ‹©ç”µè·¯ã€stm32æ„æˆã€‚</p><p>å…³äºå¯åŠ¨é€‰æ‹©ç”µè·¯å¯ä»¥æŸ¥çœ‹ä»¥ä¸‹é“¾æ¥æ¥äº†è§£ã€‚</p><p><a href="%5B(82%E6%9D%A1%E6%B6%88%E6%81%AF">Bootæ¨¡å¼é€‰æ‹©</a> STM32ä¸­BOOTæ¨¡å¼é…ç½®çš„ä½œç”¨_qq_22010549çš„åšå®¢-CSDNåšå®¢_stm32f103bootè®¾ç½®](<a href="https://blog.csdn.net/qq_22010549/article/details/123425814">https://blog.csdn.net/qq_22010549/article/details/123425814</a>))</p><p>å¯ä»¥å°†boot0å’Œboot1çš„ä¸¤ä¸ªåˆ†åˆ«è®¾è®¡å•åˆ€åŒåˆ¶å¼€å…³æ¥3.3Vå’ŒGND</p><p>ä¸»é—ªå­˜æ¨¡å¼æ˜¯ç”¨<strong>flash</strong>ï¼Œä½¿ç”¨ä¸²å£ä¸‹è½½ï¼Œæˆ–è€…å¯ä»¥é€‰æ‹©ä½¿ç”¨SWDï¼Œæˆ–è€…å°†ä¸²å£æ¥ä¸€ä¸ªæ¿è½½USBç”µè·¯ï¼Œä½¿ç”¨usbæ¥å£æ¥è¿›è¡Œä¸‹è½½ã€‚</p><p>æœ¬æ¬¾è®¾è®¡èŠ¯ç‰‡é€‰æ‹©stm32f103RCTï¼–èŠ¯ç‰‡ã€‚</p><p>æ™¶æŒ¯ç”µè·¯åˆ†åˆ«ä½¿ç”¨ä¸¤ç§æ™¶æŒ¯ï¼˜Mï¼¨ï½šæ™¶æŒ¯æä¾›å¤–éƒ¨æ—¶é’Ÿå’Œï¼“ï¼’ï¼ï¼—ï¼–ï¼˜ï¼«ï¼¨ï½šå†…éƒ¨æ™¶æŒ¯ä¸ºRTCæä¾›æ—¶é’Ÿä¿¡å·ã€‚</p><p>å¤ä½ç”µè·¯ç”±ç”µå®¹ã€ç”µé˜»ã€å¼€å…³ç»„æˆï¼Œç”µè·¯é‡‡ç”¨æ‰‹åŠ¨å¤ä½çš„æ–¹å¼ï¼Œå½“å¼€å…³é—­åˆæ—¶ç”µè·¯å¯¼é€šï¼ŒRSETä¸ºèŠ¯ç‰‡çš„å¤ä½å¼•è„šä¿¡å·ï¼Œæ­¤æ—¶èŠ¯ç‰‡å¤ä½å¼•è„šæ¥é€šGNDï¼ŒèŠ¯ç‰‡å°†ä¼šå¤ä½é‡å¯ã€‚å…¶ä¸­çš„ç”µå®¹çš„åŠŸèƒ½åˆ™æ˜¯å‚¨èƒ½ï¼Œå½“å¼€å‘æ¿ä¸Šç”µç¬é—´ï¼Œç”µå®¹å¼€å§‹å……ç”µï¼Œå¤ä½å¼•è„šä¸ºä½ç”µå¹³ï¼Œæ‰€ä»¥ä¸Šç”µç¬é—´å¼€å‘æ¿ä¹Ÿä¼šå¤ä½é‡å¯ï¼Œä½†éšç€ç”µå®¹å……ç”µå®Œæˆï¼Œå¼•è„šå˜ä¸ºé«˜ç”µå¹³ï¼Œåˆ™ä¸ä¼šå†è¿›è¡Œå¤ä½é‡å¯ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä¸‹è½½ç¨‹åºè®¾è®¡JTAGç”µè·¯</p><p>ç”µæºç”µè·¯æŠŠç”µæºç”µå‹ç¨³å‹åœ¨3.3Vç»™å•ç‰‡æœºä¾›ç”µã€‚</p><p><a href="%5B(82%E6%9D%A1%E6%B6%88%E6%81%AF">ç¨³å‹ç”µè·¯é€‰æ‹©</a> 5Vé™å‹è½¬3.3Vï¼Œ5Vè½¬3Vç”µè·¯å›¾èŠ¯ç‰‡_usb typeçš„åšå®¢-CSDNåšå®¢_5vè½¬3.3vç¨³å‹èŠ¯ç‰‡](<a href="https://blog.csdn.net/quke1/article/details/114530112?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166381207416800182735752%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166381207416800182735752&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-114530112-null-null.142%5Ev49%5Econtrol,201%5Ev3%5Econtrol_2&amp;utm_term=5v%E8%BD%AC3.3v%E7%94%B5%E8%B7%AF&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/quke1/article/details/114530112?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166381207416800182735752%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166381207416800182735752&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-114530112-null-null.142^v49^control,201^v3^control_2&amp;utm_term=5v%E8%BD%AC3.3v%E7%94%B5%E8%B7%AF&amp;spm=1018.2226.3001.4187</a>))</p><p>å¤§å¤šæ•°é€‰æ‹©ä¸ºLDOç”µè·¯ï¼Œä½¿ç”¨çš„ä¸€èˆ¬ä¸ºLM1117æˆ–è€…AMS117èŠ¯ç‰‡ã€‚</p><p>stm32çš„MCUæ¥å£VDDæ¥æ­£æ3.3Vï¼ŒVSSæ¥åœ°ï¼ŒVBATä½¿ç”¨ç”µæ± æˆ–è€…å…¶ä»–ç”µæºï¼Œ</p>]]></content>
      
      
      
        <tags>
            
            <tag> å®æˆ˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>stm32æœ€å°ç³»ç»Ÿæ¿åˆ¶ä½œ</title>
      <link href="/2022/09/21/2022-9-21-stm32%E6%9C%80%E5%B0%8F%E7%B3%BB%E7%BB%9F%E6%9D%BF%E5%88%B6%E4%BD%9C/"/>
      <url>/2022/09/21/2022-9-21-stm32%E6%9C%80%E5%B0%8F%E7%B3%BB%E7%BB%9F%E6%9D%BF%E5%88%B6%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<p>æ­¤æ¬¡åˆ¶ä½œä½¿ç”¨çš„ä¸ºç«‹åˆ›EDAï¼Œä¸»è¦æ˜¯å¿«é€Ÿä¸Šæ‰‹åˆ¶æ¿ï¼Œæ²¡æœ‰é€‰æ‹©ADã€‚</p><p>é¦–å…ˆäº†è§£<strong>stm32æœ€å°ç³»ç»Ÿç”µè·¯</strong>æ„æˆå¦‚ä¸‹ï¼š</p><p>å¤ä½ç”µè·¯ã€ç”µæºç”µè·¯ã€SWD&#x2F;JTAGä¸‹è½½æ¥å£ã€æ™¶æŒ¯ç”µè·¯ï¼ˆæ—¶é’Ÿç”µè·¯ï¼‰ã€å¯åŠ¨é€‰æ‹©ç”µè·¯ã€stm32æ„æˆã€‚</p><p>å…³äºå¯åŠ¨é€‰æ‹©ç”µè·¯å¯ä»¥æŸ¥çœ‹ä»¥ä¸‹é“¾æ¥æ¥äº†è§£ã€‚</p><p><a href="%5B(82%E6%9D%A1%E6%B6%88%E6%81%AF">Bootæ¨¡å¼é€‰æ‹©</a> STM32ä¸­BOOTæ¨¡å¼é…ç½®çš„ä½œç”¨_qq_22010549çš„åšå®¢-CSDNåšå®¢_stm32f103bootè®¾ç½®](<a href="https://blog.csdn.net/qq_22010549/article/details/123425814">https://blog.csdn.net/qq_22010549/article/details/123425814</a>))</p><p>å¯ä»¥å°†boot0å’Œboot1çš„ä¸¤ä¸ªåˆ†åˆ«è®¾è®¡å•åˆ€åŒåˆ¶å¼€å…³æ¥3.3Vå’ŒGND</p><p>ä¸»é—ªå­˜æ¨¡å¼æ˜¯ç”¨ï½†ï½Œï½ï½“ï½ˆï¼Œä½¿ç”¨ä¸²å£ä¸‹è½½ï¼Œæˆ–è€…å¯ä»¥é€‰æ‹©ä½¿ç”¨SWD</p><p>æœ¬æ¬¾è®¾è®¡èŠ¯ç‰‡é€‰æ‹©stm32f103RCTï¼–èŠ¯ç‰‡ã€‚</p><p>æ™¶æŒ¯ç”µè·¯åˆ†åˆ«ä½¿ç”¨ä¸¤ç§æ™¶æŒ¯ï¼˜Mï¼¨ï½šæ™¶æŒ¯æä¾›å¤–éƒ¨æ—¶é’Ÿå’Œï¼“ï¼’ï¼ï¼—ï¼–ï¼˜ï¼«ï¼¨ï½šå†…éƒ¨æ™¶æŒ¯ä¸ºRTCæä¾›æ—¶é’Ÿä¿¡å·ã€‚</p><p>å¤ä½ç”µè·¯ç”±ç”µå®¹ã€ç”µé˜»ã€å¼€å…³ç»„æˆï¼Œç”µè·¯é‡‡ç”¨æ‰‹åŠ¨å¤ä½çš„æ–¹å¼ï¼Œå½“å¼€å…³é—­åˆæ—¶ç”µè·¯å¯¼é€šï¼ŒRSETä¸ºèŠ¯ç‰‡çš„å¤ä½å¼•è„šä¿¡å·ï¼Œæ­¤æ—¶èŠ¯ç‰‡å¤ä½å¼•è„šæ¥é€šGNDï¼ŒèŠ¯ç‰‡å°†ä¼šå¤ä½é‡å¯ã€‚å…¶ä¸­çš„ç”µå®¹çš„åŠŸèƒ½åˆ™æ˜¯å‚¨èƒ½ï¼Œå½“å¼€å‘æ¿ä¸Šç”µç¬é—´ï¼Œç”µå®¹å¼€å§‹å……ç”µï¼Œå¤ä½å¼•è„šä¸ºä½ç”µå¹³ï¼Œæ‰€ä»¥ä¸Šç”µç¬é—´å¼€å‘æ¿ä¹Ÿä¼šå¤ä½é‡å¯ï¼Œä½†éšç€ç”µå®¹å……ç”µå®Œæˆï¼Œå¼•è„šå˜ä¸ºé«˜ç”µå¹³ï¼Œåˆ™ä¸ä¼šå†è¿›è¡Œå¤ä½é‡å¯ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä¸‹è½½ç¨‹åºè®¾è®¡JTAGç”µè·¯</p><p>ç”µæºç”µè·¯æŠŠç”µæºç”µå‹ç¨³å‹åœ¨3.3Vç»™å•ç‰‡æœºä¾›ç”µã€‚</p><p><a href="%5B(82%E6%9D%A1%E6%B6%88%E6%81%AF">ç¨³å‹ç”µè·¯é€‰æ‹©</a> 5Vé™å‹è½¬3.3Vï¼Œ5Vè½¬3Vç”µè·¯å›¾èŠ¯ç‰‡_usb typeçš„åšå®¢-CSDNåšå®¢_5vè½¬3.3vç¨³å‹èŠ¯ç‰‡](<a href="https://blog.csdn.net/quke1/article/details/114530112?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166381207416800182735752%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166381207416800182735752&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-114530112-null-null.142%5Ev49%5Econtrol,201%5Ev3%5Econtrol_2&amp;utm_term=5v%E8%BD%AC3.3v%E7%94%B5%E8%B7%AF&amp;spm=1018.2226.3001.4187">https://blog.csdn.net/quke1/article/details/114530112?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166381207416800182735752%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166381207416800182735752&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-114530112-null-null.142^v49^control,201^v3^control_2&amp;utm_term=5v%E8%BD%AC3.3v%E7%94%B5%E8%B7%AF&amp;spm=1018.2226.3001.4187</a>))</p><p>å¤§å¤šæ•°é€‰æ‹©ä¸ºLDOç”µè·¯ï¼Œä½¿ç”¨çš„ä¸€èˆ¬ä¸ºLM1117æˆ–è€…AMS117èŠ¯ç‰‡ã€‚</p><p>stm32çš„MCUæ¥å£VDDæ¥æ­£æ3.3Vï¼ŒVSSæ¥åœ°ï¼ŒVBATä½¿ç”¨ç”µæ± æˆ–è€…å…¶ä»–ç”µæºï¼Œ</p>]]></content>
      
      
      
        <tags>
            
            <tag> å®æˆ˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>arm-linux -ldã€-objcopyå’Œobdump</title>
      <link href="/2022/07/08/2022-7-8-arm-linux-ld%E5%92%8Carm-linux-objcopy/"/>
      <url>/2022/07/08/2022-7-8-arm-linux-ld%E5%92%8Carm-linux-objcopy/</url>
      
        <content type="html"><![CDATA[<p><strong>arm-linux-ldç”¨äºå°†å¤šä¸ªç›®æ ‡æ–‡ä»¶ã€åº“æ–‡ä»¶è¿æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</strong></p><p>-T ç›´æ¥æŒ‡å®šä»£ç æ®µã€æ•°æ®æ®µã€bssæ®µçš„èµ·å§‹åœ°å€,åªç”¨äºè¿æ¥Bootloaderã€å†…æ ¸ç­‰æ²¡æœ‰åº•å±‚è½¯ä»¶æ”¯æŒçš„è½¯ä»¶</p><p>è¿æ¥æ“ä½œç³»ç»Ÿåº”ç”¨ç¨‹åºæ—¶å€™ï¼Œæ— éœ€-Tï¼Œé»˜è®¤è¿æ¥ã€‚</p><p>1.ç›´æ¥æŒ‡å®šä»£ç æ®µã€æ•°æ®æ®µã€bssæ®µçš„èµ·å§‹åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Ttext startaddr</span><br><span class="line">-Tdata startaddr</span><br><span class="line">-Tbss startaddr</span><br></pre></td></tr></table></figure><p>startaddråˆ†åˆ«ä»£è¡¨ä»£ç æ®µã€æ•°æ®æ®µã€bssæ®µçš„èµ·å§‹åœ°å€</p><p>egï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-ld -Ttext 0x000000 -g led_on.o -o led_on_elf</span><br></pre></td></tr></table></figure><p>ä»£è¡¨ä»£ç æ®µè¿è¡Œåœ°å€ä¸º0x000000ï¼Œæ²¡æœ‰å®šä¹‰æ•°æ®æ®µã€bssæ®µèµ·å§‹åœ°å€æ‰€ä»¥è¢«æ”¾å…¥ä»£ç æ®µçš„åé¢</p><p>2.ä½¿ç”¨è¿æ¥è„šæœ¬è®¾ç½®åœ°å€</p><p><strong>arm-linux-objcopyè¢«ç”¨æ¥å¤åˆ¶ä¸€ä¸ªç›®æ ‡æ–‡ä»¶çš„å†…å®¹åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå¯ç”¨ä¸åŒäºæºæ–‡ä»¶çš„æ ¼å¼æ¥è¾“å‡ºç›®çš„æ–‡ä»¶ï¼Œå³å¯ä»¥è¿›è¡Œæ ¼å¼è½¬æ¢ã€‚</strong></p><p>1ã€input-fileã€outfileåˆ†åˆ«æ˜¯è¾“å…¥ç›®æ ‡æ–‡ä»¶å’Œè¾“å‡ºç›®æ ‡æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šoutfileï¼Œå°†åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶æ¥å­˜æ”¾ç»“æœï¼Œç”¨input-fileçš„åå­—æ¥å‘½åã€‚</p><p>2ã€ -l bfnameæˆ–â€“input-target&#x3D;bfdname</p><p>ç”¨æ¥æŒ‡æ˜æºæ–‡ä»¶çš„æ ¼å¼ï¼Œbfdnameæ˜¯BFDåº“æè¿°çš„æ ‡å‡†æ ¼å¼åï¼Œå¦‚æœä¸æŒ‡æ˜æ ¼å¼ï¼Œä¼šè‡ªå·±åˆ†ææºæ–‡ä»¶æ ¼å¼ï¼Œå»å’ŒBFDä¸­æè¿°çš„å„ç§æ ¼å¼æ¯”è¾ƒï¼Œä»è€Œå¾—çŸ¥æºæ–‡ä»¶çš„ç›®æ ‡æ ¼å¼åã€‚</p><p>3ã€-O bfdnameæˆ–â€“output-target&#x3D;bfdname</p><p>ä½¿ç”¨æŒ‡å®šæ ¼å¼æ¥è¾“å‡ºæ–‡ä»¶ï¼Œbdfnameæ˜¯BFDåº“ä¸­çš„æ ‡å‡†æ ¼å¼åã€‚</p><p><strong>arm-linux-objdumpç”¨äºæ˜¾ç¤ºäºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯</strong></p><p>æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>stm32halåº“</title>
      <link href="/2022/07/01/2022-7-1-stm32hal%E5%BA%93/"/>
      <url>/2022/07/01/2022-7-1-stm32hal%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p>ä¸ºæ–¹ä¾¿ä½¿ç”¨ï¼Œç”¨typedefæ¥ç»™å˜é‡èµ·åå°†ä»¥ä¸‹æ”¾å…¥main.hä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">int32_t</span>  s32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int16_t</span> s16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int8_t</span>  s8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="type">int32_t</span> sc32;  </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="type">int16_t</span> sc16;  </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="type">int8_t</span> sc8;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> __IO <span class="type">int32_t</span>  vs32;</span><br><span class="line"><span class="keyword">typedef</span> __IO <span class="type">int16_t</span>  vs16;</span><br><span class="line"><span class="keyword">typedef</span> __IO <span class="type">int8_t</span>   vs8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> __I <span class="type">int32_t</span> vsc32;  </span><br><span class="line"><span class="keyword">typedef</span> __I <span class="type">int16_t</span> vsc16; </span><br><span class="line"><span class="keyword">typedef</span> __I <span class="type">int8_t</span> vsc8;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span>  u32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint16_t</span> u16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint8_t</span>  u8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="type">uint32_t</span> uc32;  </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="type">uint16_t</span> uc16;  </span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> <span class="type">uint8_t</span> uc8; </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> __IO <span class="type">uint32_t</span>  vu32;</span><br><span class="line"><span class="keyword">typedef</span> __IO <span class="type">uint16_t</span> vu16;</span><br><span class="line"><span class="keyword">typedef</span> __IO <span class="type">uint8_t</span>  vu8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> __I <span class="type">uint32_t</span> vuc32;  </span><br><span class="line"><span class="keyword">typedef</span> __I <span class="type">uint16_t</span> vuc16; </span><br><span class="line"><span class="keyword">typedef</span> __I <span class="type">uint8_t</span> vuc8;  </span><br></pre></td></tr></table></figure><p>ç‚¹äº®led</p><p>GPIOç”¨IOå£çš„è¾“å‡ºæ¨¡å¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HAL_GPIO_WritePin(GPIOF,GPIO_PIN_9,GPIO_PIN_SET);<span class="comment">//æ§åˆ¶ç”µå¹³</span></span><br><span class="line">HAL_GPIO_TogglePin(GPIOB, GPIO_PIN_5);<span class="comment">//ç¿»è½¬ç”µå¹³</span></span><br><span class="line">HAL_GPIO_ReadPin(GPIOA, GPIO_Pin_8);<span class="comment">//è¯»å–ç”µå¹³</span></span><br></pre></td></tr></table></figure><p>ç‚¹äº®ledå°±éœ€è¦æŒ‰é”®äº†ï¼ŒæŒ‰é”®é¦–å…ˆè¦çœ‹æŒ‰é”®çš„å¼•è„šè®¾ç½®IOå£ä¸ºè¾“å…¥æ¨¡å¼ï¼Œå†™ä¸€ä¸ªæ¡ˆä»¶å¤„ç†å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">u8 <span class="title function_">KEY_Scan</span><span class="params">(u8 mode)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">static</span> u8 key_up=<span class="number">1</span>; <span class="comment">//æŒ‰é”®æ¾å¼€æ ‡å¿—</span></span><br><span class="line"> <span class="keyword">if</span>(mode==<span class="number">1</span>)key_up=<span class="number">1</span>; <span class="comment">//æ”¯æŒè¿æŒ‰</span></span><br><span class="line"> <span class="keyword">if</span>(key_up&amp;&amp;(KEY0==<span class="number">0</span>||KEY1==<span class="number">0</span>||WK_UP==<span class="number">1</span>))</span><br><span class="line"> &#123;</span><br><span class="line"> delay_ms(<span class="number">10</span>);</span><br><span class="line"> key_up=<span class="number">0</span>;</span><br><span class="line"> <span class="keyword">if</span>(KEY0==<span class="number">0</span>) <span class="keyword">return</span> KEY0_PRES;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span>(KEY1==<span class="number">0</span>) <span class="keyword">return</span> KEY1_PRES;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span>(WK_UP==<span class="number">1</span>) <span class="keyword">return</span> WKUP_PRES; </span><br><span class="line">ALIENTEK MiniSTM32 V3<span class="number">.0</span> å¼€å‘æ¿æ•™ç¨‹</span><br><span class="line"><span class="number">137</span></span><br><span class="line">STM32 ä¸å®Œå…¨æ‰‹å†Œ(HAL åº“ç‰ˆ)</span><br><span class="line"> &#125;<span class="keyword">else</span> <span class="keyword">if</span>(KEY0==<span class="number">1</span>&amp;&amp;KEY1==<span class="number">1</span>&amp;&amp;WK_UP==<span class="number">0</span>)key_up=<span class="number">1</span>;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//æ— æŒ‰é”®æŒ‰ä¸‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¤´æ–‡ä»¶ä¸­è¿›è¡Œæ·»åŠ å®å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __KEY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __KEY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0 HAL_GPIO_ReadPin(GPIOC,GPIO_PIN_5) <span class="comment">//KEY0 æŒ‰é”® PC5</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1 HAL_GPIO_ReadPin(GPIOA,GPIO_PIN_15) <span class="comment">//KEY1 æŒ‰é”® PA15</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WK_UP HAL_GPIO_ReadPin(GPIOA,GPIO_PIN_0) <span class="comment">//WKUP æŒ‰é”® PA0</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_PRES 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY1_PRES 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WKUP_PRES 3</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">KEY_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">u8 <span class="title function_">KEY_Scan</span><span class="params">(u8 mode)</span>; </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>ä¸²å£é€šä¿¡</p><p>usartå’ŒuartåŒºåˆ«ä¸º usartæ¯”uartå¤šäº†åŒæ­¥æ—¶é’Ÿé¢‘ç‡é€šä¿¡ï¼Œéƒ½æœ‰å¼‚æ­¥æ—¶é’Ÿé€šä¿¡ã€‚</p><p>ä¸²å£è®¾ç½®çš„ä¸€èˆ¬æ­¥éª¤å¯ä»¥æ€»ç»“ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>ä¸²å£æ—¶é’Ÿä½¿èƒ½ï¼ŒGPIO æ—¶é’Ÿä½¿èƒ½ã€‚</li><li>è®¾ç½®å¼•è„šå¤ç”¨å™¨æ˜ å°„ï¼šè°ƒç”¨ GPIO_PinAFConfig å‡½æ•°ã€‚</li><li>GPIO åˆå§‹åŒ–è®¾ç½®ï¼šè¦è®¾ç½®æ¨¡å¼ä¸ºå¤ç”¨åŠŸèƒ½ã€‚</li><li>ä¸²å£å‚æ•°åˆå§‹åŒ–ï¼šè®¾ç½®æ³¢ç‰¹ç‡ï¼Œå­—é•¿ï¼Œå¥‡å¶æ ¡éªŒç­‰å‚æ•°ã€‚</li><li>å¼€å¯ä¸­æ–­å¹¶ä¸”åˆå§‹åŒ– NVICï¼Œä½¿èƒ½ä¸­æ–­ï¼ˆå¦‚æœéœ€è¦å¼€å¯ä¸­æ–­æ‰éœ€è¦è¿™ä¸ªæ­¥éª¤ï¼‰ã€‚</li><li>ä½¿èƒ½ä¸²å£ã€‚</li><li>ç¼–å†™ä¸­æ–­å¤„ç†å‡½æ•°ï¼šå‡½æ•°åæ ¼å¼ä¸º USARTxIRQHandler(x å¯¹åº”ä¸²å£å·)ã€‚</li></ol><p>ä¸²å£é€šä¿¡çš„ç»“æ„ä½“å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line"> uint32_t BaudRate; //æ³¢ç‰¹ç‡</span><br><span class="line"> uint32_t WordLength; //å­—é•¿</span><br><span class="line"> uint32_t StopBits; //åœæ­¢ä½</span><br><span class="line"> uint32_t Parity; //å¥‡å¶æ ¡éªŒ</span><br><span class="line"> uint32_t Mode; //æ”¶/å‘æ¨¡å¼è®¾ç½®</span><br><span class="line"> uint32_t HwFlowCtl; //ç¡¬ä»¶æµè®¾ç½®</span><br><span class="line"> uint32_t OverSampling; //è¿‡é‡‡æ ·è®¾ç½®</span><br><span class="line">&#125;UART_InitTypeDef</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> å®æˆ˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>makefileçš„å­¦ä¹ </title>
      <link href="/2022/06/30/2022-6-30-makefile/"/>
      <url>/2022/06/30/2022-6-30-makefile/</url>
      
        <content type="html"><![CDATA[<p><a href="https://tieba.baidu.com/p/591519800">Makefileè¯¦è§£ï¼ˆè¶…çº§å¥½ï¼‰ã€mingwå§ã€‘_ç™¾åº¦è´´å§ (baidu.com)</a></p><p>ä¸Šé¢æŒ‚ä¸€ä¸ªè¾ƒå¥½çš„makefileçš„æ•™ç¨‹ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> makefile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxåˆå­¦</title>
      <link href="/2022/06/28/2022-06-28-linux%E5%88%9D%E5%AD%A6/"/>
      <url>/2022/06/28/2022-06-28-linux%E5%88%9D%E5%AD%A6/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ä¸ªC&#x2F;C++æ–‡ä»¶è¦ç»è¿‡é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–ã€è¿æ¥ç­‰å››æ­¥æ‰èƒ½å˜ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>é¢„å¤„ç†å°±æ˜¯è¦å°†åŒ…å«ï¼ˆincludeï¼‰çš„æ–‡ä»¶æ’å…¥åˆ°åŸæ–‡ä»¶ä¸­ã€å®å®šä¹‰å±•å¼€ã€æ ¹æ®æ¡ä»¶ç¼–è¯‘å‘½ä»¤é€‰æ‹©è¦ä½¿ç”¨çš„ä»£ç ã€‚</p><p>ç¼–è¯‘æ˜¯æŠŠC&#x2F;C++ä»£ç ç¿»è¯‘æˆæ±‡ç¼–ä»£ç ã€‚</p><p>æ±‡ç¼–æ˜¯å°†è¾“å‡ºçš„æ±‡ç¼–ä»£ç ç¿»è¯‘æˆä¸€å®šæ ¼å¼çš„æœºå™¨ä»£ç ã€‚</p><p>è¿æ¥æ˜¯å°†ä¸Šéƒ¨ç”Ÿæˆçš„OBJå’Œç³»ç»Ÿåº“çš„OBJæ–‡ä»¶ã€åº“æ–‡ä»¶è¿æ¥èµ·æ¥ï¼Œæœ€ç»ˆç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>é¦–å…ˆè®°å½•ä¸€äº›å¸¸ç”¨çš„linuxæŒ‡ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ cd ç›®æ ‡æ–‡ä»¶å¤¹åç§°                 å¯¼å‘ç›®æ ‡æ–‡ä»¶å¤¹æ‰€åœ¨ç»ˆç«¯</span><br><span class="line"></span><br><span class="line">~$ touch hel                               åˆ›å»ºä¸€ä¸ªå«helçš„æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">~$ gedit hel.c                             åˆ›å»ºä¸€ä¸ªå«hel.cçš„æ–‡ä»¶å¹¶ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€</span><br><span class="line"></span><br><span class="line">~$ gcc hel.c -o test                    ç¼–è¯‘hel.cä¸ºtestå¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line"></span><br><span class="line">~$ ./test                                     æ‰§è¡Œtestå¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¤šä¸ª.cæ–‡ä»¶ä½¿ç”¨å‘½ä»¤å°†å¤šä¸ªæ–‡ä»¶è¿æ¥åˆ°ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä¹‹åæ‰§è¡Œã€‚</p><p>åœ¨Cè¯­è¨€æ–‡ä»¶ä¸­è°ƒç”¨math.håº“æŠ¥é”™åªéœ€è¦gccå°†ä»£ç ä¸é“¾æ¥åº“è¿æ¥èµ·æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc two.c -lm -o two</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘Cè¯­è¨€æ–‡ä»¶ä¼šæœ‰è­¦å‘Šä»¥åŠæŠ¥é”™ï¼Œä½†æ˜¯è­¦å‘Šæ˜¯ä¸æ˜¾ç¤ºçš„ï¼Œéœ€è¦ç”¨æŒ‡ä»¤è¿›è¡Œæ˜¾ç¤ºã€‚</p><p>æ¯”å¦‚æ˜¾ç¤ºhello.cæ–‡ä»¶çš„è­¦å‘Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ gcc -Wll -c hello.c</span><br></pre></td></tr></table></figure><p>å¦‚æœæ–‡ä»¶é‡Œæœ‰æ²¡å®šä¹‰çš„å˜é‡å°±ä¼šå‡ºç°å¦‚ä¸‹ç°è±¡</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-15%20145045.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linuxåˆå­¦</title>
      <link href="/2022/06/28/2022-6-28-linux%E5%88%9D%E5%AD%A6/"/>
      <url>/2022/06/28/2022-6-28-linux%E5%88%9D%E5%AD%A6/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ä¸ªC&#x2F;C++æ–‡ä»¶è¦ç»è¿‡é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–ã€è¿æ¥ç­‰å››æ­¥æ‰èƒ½å˜ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>é¢„å¤„ç†å°±æ˜¯è¦å°†åŒ…å«ï¼ˆincludeï¼‰çš„æ–‡ä»¶æ’å…¥åˆ°åŸæ–‡ä»¶ä¸­ã€å®å®šä¹‰å±•å¼€ã€æ ¹æ®æ¡ä»¶ç¼–è¯‘å‘½ä»¤é€‰æ‹©è¦ä½¿ç”¨çš„ä»£ç ã€‚</p><p>ç¼–è¯‘æ˜¯æŠŠC&#x2F;C++ä»£ç ç¿»è¯‘æˆæ±‡ç¼–ä»£ç ã€‚</p><p>æ±‡ç¼–æ˜¯å°†è¾“å‡ºçš„æ±‡ç¼–ä»£ç ç¿»è¯‘æˆä¸€å®šæ ¼å¼çš„æœºå™¨ä»£ç ã€‚</p><p>è¿æ¥æ˜¯å°†ä¸Šéƒ¨ç”Ÿæˆçš„OBJå’Œç³»ç»Ÿåº“çš„OBJæ–‡ä»¶ã€åº“æ–‡ä»¶è¿æ¥èµ·æ¥ï¼Œæœ€ç»ˆç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>é¦–å…ˆè®°å½•ä¸€äº›å¸¸ç”¨çš„linuxæŒ‡ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">~$ </span><span class="language-bash"><span class="built_in">cd</span> ç›®æ ‡æ–‡ä»¶å¤¹åç§°                 å¯¼å‘ç›®æ ‡æ–‡ä»¶å¤¹æ‰€åœ¨ç»ˆç«¯</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">~$ </span><span class="language-bash"><span class="built_in">touch</span> hel                               åˆ›å»ºä¸€ä¸ªå«helçš„æ–‡ä»¶</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">~$ </span><span class="language-bash">gedit hel.c                             åˆ›å»ºä¸€ä¸ªå«hel.cçš„æ–‡ä»¶å¹¶ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">~$ </span><span class="language-bash">gcc hel.c -o <span class="built_in">test</span>                    ç¼–è¯‘hel.cä¸º<span class="built_in">test</span>å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">~$ </span><span class="language-bash">./test                                     æ‰§è¡Œ<span class="built_in">test</span>å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¤šä¸ª.cæ–‡ä»¶ä½¿ç”¨å‘½ä»¤å°†å¤šä¸ªæ–‡ä»¶è¿æ¥åˆ°ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä¹‹åæ‰§è¡Œã€‚</p><p>åœ¨Cè¯­è¨€æ–‡ä»¶ä¸­è°ƒç”¨math.håº“æŠ¥é”™åªéœ€è¦gccå°†ä»£ç ä¸é“¾æ¥åº“è¿æ¥èµ·æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gcc two.c -lm -o two</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘Cè¯­è¨€æ–‡ä»¶ä¼šæœ‰è­¦å‘Šä»¥åŠæŠ¥é”™ï¼Œä½†æ˜¯è­¦å‘Šæ˜¯ä¸æ˜¾ç¤ºçš„ï¼Œéœ€è¦ç”¨æŒ‡ä»¤è¿›è¡Œæ˜¾ç¤ºã€‚</p><p>æ¯”å¦‚æ˜¾ç¤ºhello.cæ–‡ä»¶çš„è­¦å‘Š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">~$ </span><span class="language-bash">gcc -Wll -c hello.c</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ–‡ä»¶é‡Œæœ‰æ²¡å®šä¹‰çš„å˜é‡å°±ä¼šå‡ºç°å¦‚ä¸‹ç°è±¡</p><p><img src="https://gitee.com/hanfengdyh/image/raw/master/bloglmg/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-03-15%20145045.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/05/03/hello-world/"/>
      <url>/2022/05/03/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
